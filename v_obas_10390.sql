--pålogging
  'HOT'
    sqlplus sys/Ora12c1601@192.168.1.3:1521/pdbobas                     as sysdba       conn ola/ola@192.168.1.3:1521/pdbobas                  
    sqlplus sys/Ora12c1601@192.168.1.3:1521/pdbkoas                     as sysdba       conn apex_koas/apex_koas 1@192.168.1.3:1521/pdbkoas       
    sqlplus sys/Cdbobas19c:2002@192.168.1.7/pdbobas.bildeler.net        as sysdba
    sqlplus sys/Ora12c1803@192.168.1.5:1521/pdbobas.bildeler.net        as sysdba

  'DEPRICATED'


----------------------------------------------------------- backup -----------------------------------------------------------------------------------------------------------------------------------
    create table enhet_2018_08_12 as select * from enhet;
    --2018_08_13 rebuild
        drop table t;
        create table t as select * from enhet_2018_08_14;
        --editer it MSQ
            sletter alle records med dato_inn lik 2018-08-14        
            fjerner dato ut på lik 2018-08-14
            create table enhet_2018_08_13 as select * from t;

    --pdbobas                                               pdbbildeler.bildeler.net
    create table enhet_2018_08_14 as select * from enhet;
    create table enhet_2018_10_14 as select * from enhet;
    create table enhet_2018_10_27 as select * from enhet;
    create table enhet_2018_11_03 as select * from enhet;   create table enhet_2018_11_03 as select * from enhet@obas;
    create table enhet_2018_11_10 as select * from enhet;   create table enhet_2018_11_03 as select * from enhet@obas;
    create table enhet_2018_11_11 as select * from enhet;
    create table enhet_2018_11_12 as select * from enhet;
    create table enhet_2018_11_18 as select * from enhet;

----------------------------------------------------------- v_uni_t_vareln2        user ekstern > ola ------------------------------------------------------------------------------------------
        obas5_19c_ola> create table v_uni_t_vareln2 as select * from v_uni_t_vareln2@obas_obas4_ekstern;

    --create or replace view v_uni_t_vareln2 as 
          /*Laget etter det viste seg at resending av bilder og bruk av samme merkelapper medf�rte at nye deler som hadde samme merkelapp
            som var brukt tidligere i 2016 (det �ret Uni ble startet opp) ble slettet dersom de alts� var solgt tidliger i l�pet av 2016
            Fredag 13 mai startet eksport av bilder for resending
            Onsdag 18 mai startet man � bruke gamle lapper
            OBAS--> UNI enhet_seq_no legges inni ERSTATNVAREID  
                        og hentes tilbake i enhet_seq_no i uni_t_vareln
            NB krever OLA@obas>grant all on serie to public
                      OLA@obas>grant all on enhet to public
                      OLA@obas>grant all on vare_gruppe to public
          */
          select
              vareln_t_seq_no,
              obas_enhet_seq_no.enhet_seq_no,
              obas_enhet_seq_no.serie_seq_no as serie_seq_no_ut,  --fases ut 
              obas_enhet_seq_no.location_seq_no,
              obas_enhet_seq_no.serie_no,
              obas_enhet_seq_no.vare_gruppe_id,
              --maa med slik at ny inlegging av varer funker
              --bytte om p� serie_seq_no slik at virkelig brukt UNI serie_seq_no brukes og ikke det som faktisk ligger p� delen (etter den er lagt inn igjen)
              --NB kan ikke legge p� serie_seq_no hvis del er ute av lager-->m� bruke location 
              case when obas_enhet_seq_no.location_seq_no is not null then
                obas_serie_no.serie_seq_no
              else null
              end  as serie_seq_no,  --_join_varenr            
              obas_serie_no.serie_no        as serie_no_join_varenr,
              obas_serie_no.vare_gruppe_id  as vare_gruppe_id_join_varenr,
              sysdate as force_update,
              uni.type,
              --ID      Beskrivelse           Kategori  ShortStatus Beskrivelse 
              --110399  Slettet tilbud        1103      99          Tilbud - status
              --110301  Overf�rt til ordre    1103      1           Tilbud - status
              --110302  Overf�rt til faktura  1103      2           Tilbud - status
              --110299  Slettet ordre         1102      99          Ordre - status
              --110204  Fakturert             1102      4           Ordre - status
              --110499  Slettet               1104      99          Ordrelinje - status
              case when type ='TILBUD'   then (select statuskategori||' '||id||' '||beskrivelse from ekstern.uni_statuser where id=tilbudsnr_status )
                   when type ='ORDRE'    then (select statuskategori||' '||id||' '||beskrivelse from ekstern.uni_statuser where id=ordrenr_status   )
                   when type ='FAKTURA'  then (select statuskategori||' '||id||' '||beskrivelse from ekstern.uni_statuser where id=fakturanr_status )
                   else 'hmmm...'
              end as status,
              --
              --
              uni.tilbudsnr                  ,
              uni.tilbudsnr_vaar_ref         ,
              uni.tilbudsnr_dato             ,
              uni.tilbudsnr_dato_gyldig_til  ,
              uni.tilbudsnr_status           ,
              --
              uni.ordrenr                    ,
              uni.ordrenr_vaar_ref           ,
              uni.ordrenr_last_edit          ,
              uni.ordrenr_status             ,
               --
              uni.fakturanr                  ,
              uni.fakturanr_vaar_ref         ,
              uni.fakturanr_leverings_dato   ,
              uni.fakturanr_status           ,
              --
              uni.innkjopnr                  ,
              uni.innkjopnr_vaar_ref         ,
              uni.innkjopnr_dato             ,
              uni.innkjopnr_status           ,
              --
              uni.varenr                     ,
              uni.varetekst                  ,
              uni.pris                       ,
              uni.rabatt                     ,
              uni.netto                      ,
              uni.mva                        ,                        
              uni.salgs_pris                      
            from (select enhet.enhet_seq_no, serie.serie_seq_no, enhet.location_seq_no, 
                    vare_gruppe_id,
                    decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no as serie_no, 
                    sysdate as force_update                                
                  from ola.enhet,
                       ola.serie,
                       ola.vare_gruppe
                  where 1=1
                  and enhet.serie_seq_no       =serie.serie_seq_no
                  and enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no 
                 ) obas_enhet_seq_no,
                 (select enhet.enhet_seq_no, serie.serie_seq_no, enhet.location_seq_no, 
                    vare_gruppe.vare_gruppe_id,
                    decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no as serie_no, 
                    sysdate as force_update                                
                  from ola.enhet,
                       ola.serie,
                       ola.vare_gruppe
                  where 1=1
                  and enhet.serie_seq_no       =serie.serie_seq_no
                  and enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no 
                 ) obas_serie_no,
                ekstern.uni_t_vareln  uni
            where 1=1
            and     uni.enhet_seq_no = obas_enhet_seq_no.enhet_seq_no (+)
            and     uni.varenr       = obas_serie_no.serie_no         (+)   
            --synk med java uttrekk
            --and     nvl(tilbudsnr_status,-66) not in(110399,110301,110302)        --ID      Beskrivelse           Kategori  ShortStatus Beskrivelse 
            --and     nvl(ordrenr_status  ,-66) not in(110299,110204,110499)        --110399  Slettet tilbud        1103      99          Tilbud - status
                                                                                    --110301  Overf�rt til ordre    1103      1           Tilbud - status
                                                                                    --110302  Overf�rt til faktura  1103      2           Tilbud - status
                                                                                    --110299  Slettet ordre         1102      99          Ordre - status
                                                                                    --110204  Fakturert             1102      4           Ordre - status
                                                                                    --110499  Slettet               1104      99          Ordrelinje - status
            order by type desc , status
    /
        grant all on v_uni_t_vareln2 to public;

      select * 
        from  ekstern.v_uni_t_vareln2
      where nvl(tilbudsnr_status,-1) not in ( 110399)
      and   nvl(ordrenr_status  ,-1) not in ( 110299,110204)
      and   nvl(fakturanr_status  ,-1) not in ( 0,110111)
      and   substr(varetekst,1,12) =substr(vare_gruppe_id,1,12)
      and   v_uni_t_vareln2.serie_seq_no is null
      and   v_uni_t_vareln2.varenr  = t_enhet2.serie_no
      
      Type      Status
      TILBUD    Faktura - status  0       Registrert
      TILBUD    Tilbud - status   110300  Registrert
      TILBUD    Tilbud - status   110301  Overf�rt til ordre
      TILBUD    Tilbud - status   110302  Overf�rt til faktura
      TILBUD    Tilbud - status   110399  Slettet tilbud
      ---------
      ORDRE     Faktura - status  0       Registrert
      ORDRE     Ordre - status    110200  Registrert
      ORDRE     Ordre - status    110202  Levert
      ORDRE     Ordre - status    110203  Del-fakturert
      ORDRE     Ordre - status    110204  Fakturert
      ORDRE     Ordre - status    110299  Slettet ordre
      -----
      FAKTURA   Faktura - status  0       Registrert
      FAKTURA   Faktura - status  110110  Delbetalt
      FAKTURA   Faktura - status  110111  Betalt
      FAKTURA   Faktura - status  110113  Ferdigbehandlet
----------------------------------------------------------- v_uni_t_vareln korrupt user ekstern > ola ------------------------------------------------------------------------------------------
    obas5_19c_ola> create table v_uni_t_vareln as select * from v_uni_t_vareln@obas_obas4_ekstern;

    --create or replace view v_uni_t_vareln as 
          select
              vareln_t_seq_no,
              enhet_seq_no,
              serie_seq_no,
              location_seq_no,
              serie_no,
              force_update,
              --
              type,
              --
              tilbudsnr                  ,
              tilbudsnr_vaar_ref         ,
              tilbudsnr_dato             ,
              tilbudsnr_dato_gyldig_til  ,
              tilbudsnr_status           ,
              --
              ordrenr                    ,
              ordrenr_vaar_ref           ,
              ordrenr_last_edit          ,
              ordrenr_status             ,
               --
              fakturanr                  ,
              fakturanr_vaar_ref         ,
              fakturanr_leverings_dato   ,
              fakturanr_status           ,
              --
              innkjopnr                  ,
              innkjopnr_vaar_ref         ,
              innkjopnr_dato             ,
              innkjopnr_status           ,
              --
              varenr                     ,
              varetekst                  ,
              pris                       ,
              rabatt                     ,
              netto                      ,
              mva                        ,                        
              salgs_pris                      
           from ekstern.uni_t_vareln  uni,
                (select enhet.enhet_seq_no, serie.serie_seq_no, enhet.location_seq_no, decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no as serie_no, force_update                                
                 from ola.enhet enhet, 
                      ola.serie serie,
                      ola.enhet_uni enhet_uni   
                 where enhet.serie_seq_no=serie.serie_seq_no
                 and   enhet.enhet_seq_no= enhet_uni.enhet_seq_no(+)) obas
            where 1=1
            and   uni.varenr = obas.serie_no
            order by type desc , tilbudsnr, ordrenr, fakturanr
    /
        grant all on v_uni_t_vareln to public;



----------------------------------------------------------- v_lbk_xbnavn           user ekstern > ola -----------------------------------------------------------------------------------------
    create or replace view v_lbk_xbnavn as
            /*   
            Dato	  	  Endring
            ===       	=======        
            2012_03_01  lager
            */
        select 
            --distinct ikke n�dvendig siden pk i hovedtabell er xxxkod,hist_date og vi krever hist_date= null lengre nede i where kriteriet
            -------------------------------------------------------------------------------------------------------------------------------
            sbrnr,
            lbknr,
            merke,
            type,
            fra,
            til,
            ver
        from lbk_xbnavn
            where date_hist is null
            --m� vekk for � hindre table scan i v_enhet2
            --order by merke,type,fra,til
    / 
            grant all on v_lbk_xbnavn  to public;

            truncate table plan_table;
            explain plan set statement_id='732' into plan_table for 
            select * from ekstern.v_lbk_xdnavn;
            commit;

----------------------------------------------------------- v_lbk_xdnavn           user ekstern > ola ------------------------------------------------------------------------------------------
    create or replace view v_lbk_xdnavn as
            /*   
            Dato	  	  Endring
            ===       	=======        
            2012_02_23	laget  krever grant all on ola.xdnavn  to public
            2012_03_01  byttet navn   fra v_lbk_d_navn til v_lbk_xdnavn
                             tabell fra ola.xdnavn   til ekstern.lbk_xdnavn
            2012_03_15  legger inn lbk nr -1 slik at vi kan mappe oss fra vare_gruppe til map_del og trevver i xdnavn 
                        map_del har harkodet inn mapping p� -1 her legger vi inn virtuell row p� -1 s� slipper vi klur n�r xdnavn oppdateres
            */
        select 
            --distinct ikke n�dvendig siden pk i hovedtabell er xxxkod,hist_date og vi krever hist_date= null lengre nede i where kriteriet
            -------------------------------------------------------------------------------------------------------------------------------
            sbrnr,
            lbknr,
            d_navn,
            d_lager,
            filt_ut
        from lbk_xdnavn
            where date_hist is null
            --m� vekk for � hindre table scan i v_enhet2
            --order by d_navn
        union
        select null,'-1','DYN_MAP_LBK_vrak',null,'0' from dual
    / 
    
    grant all on v_lbk_xdnavn  to public;


----------------------------------------------------------- v_lbk_priser2          user ekstern > ola  ------------------------------------------------------------------------------------------
    create or replace view v_lbk_apex as
            /*
              Brukes i APEX bilde 205 s�k p� del/vrak.....
              2014_05_31 laget som kopi av v_bildeler_apex  
            */
        select 
              0                                         as  c002_enhet_seq_no,            --brukes APEX                                      
              0                                         as  c003_prev_enhet_seq_no,                                                          
              0                                         as  c004_vare_gruppe_seq_no,      --brukes APEX                                      
              vare_gruppe_id                            as  c005_vare_gruppe_id,                              --1  vises i bilde 205 APEX    
              ' '                                       as  c006_prev_vare_gruppe_id,                                                        
              0                                         as  c007_serie_seq_no,                                                               
              serie_no                                  as  c008_serie_no,                                    --3  vises i bilde 205 APEX    
              ' '                                       as  c009_prev_serie_no,                                                              
              ' '                                       as  c010_old_serie_no,                                                               
              0                                         as  c011_location_seq_no,                                                            
              loc_id                                    as  c012_loc_id,                                      --4  vises i bilde 205 APEX    
              kval_id                                   as  c013_kval_id,                                                                    
              enhet_besk                                as  c014_enhet_besk,                                  --5  vises i bilde 205 APEX    
              ' '                                       as  c015_temp,                                        --6  vises i bilde 205 APEX    
              sysdate                                   as  c016_temp_dato,                                                                  
              sysdate                                   as  c017_dato_inn,                                                                   
              sysdate                                   as  c018_dato_ut,                                                                    
              ' '                                       as  c019_paa_bil,                                                                    
              ' '                                       as  c020_hold_on,                                                                    
              pris_inkl_mva                             as  c021_pris_inkl_mva,                               --7  vises i bilde 205 APEX    
              ' '                                       as  c022_miljo_klarert_id,                                                           
              0                                         as  c023_pris_solgt_inkl_mva,                                                        
              0                                         as  c024_salg_via,                                                                   
              0                                         as  c025_salg_funnet,                                                                
              0                                         as  c026_org_pris_inkl_mva,                                                          
              sysdate                                   as  c027_org_dato_inn,                                                               
              0                                         as  c028_takst_seq_no,                                                               
              0                                         as  c029_fab_seq_no,
              0                                         as  c030_type_seq_no,
              v0_var_bil_scope_seq_no                   as  c031_var_bil_scope_seq_no,
              ' '                                       as  c032_reg_no,
              -------------------  
              ' ' c033,' ' c034,' ' c035,' ' c036,' ' c037,' ' c038,' ' c039,
              -------------------
              nvl2(nr_oem             ,                                                                                    nr_oem             , null              ) ||
              nvl2(nr_bytte_nr_vendor ,nvl2(nr_oem                                                           , ', ',null)||nr_bytte_nr_vendor , nr_bytte_nr_vendor) ||
              nvl2(nr_bytte_nr        ,nvl2(nr_oem||nr_bytte_nr_vendor                                       , ', ',null)||nr_bytte_nr        , nr_bytte_nr       )      
                                                         as c040_nr,
              -------------------------------------------                                                                            
              nvl2(motor_type_besk    ,                                                                                    motor_type_besk    , null              ) ||
              nvl2(motor_vol_id       ,nvl2(motor_type_besk                                                  , '  ' ,null)||motor_vol_id      , motor_vol_id      ) ||
              nvl2(motor_hk           ,nvl2(motor_type_besk||motor_vol_id                                    , '  ' ,null)||motor_hk          , motor_hk          ) ||
              nvl2(motor_kode         ,nvl2(motor_type_besk||motor_vol_id||motor_hk                          , '  ' ,null)||motor_kode        , motor_kode        ) ||
              nvl2(motor_test         ,nvl2(motor_type_besk||motor_vol_id||motor_hk||motor_kode              , '  ' ,null)||motor_test        , motor_test        )     
                                                         as c041_motor,
              -------------------------------------------                                                                            
              nvl2(gear_type          ,                                                                                    gear_type          , null              ) ||
              nvl2(gear_kode          ,nvl2(gear_type                                                        , '  ',null)||gear_kode          , gear_kode         ) ||
              nvl2(gear_test          ,nvl2(gear_type||gear_kode                                             , '  ',null)||gear_test          , gear_test         )     
                                                         as c042_gear,
              -------------------------------------------                                                                              
              v0_var_bil_seq_no                          as c043_v0_var_bil_seq_no,
              nvl2(v0_type_klasse     ,                                                                                     v0_type_klasse    , null              ) ||
              nvl2(v0_fab_navn        ,nvl2(v0_type_klasse                                                   , '  ' ,null)||v0_fab_navn       , v0_fab_navn       ) ||
              nvl2(v0_type_id         ,nvl2(v0_type_klasse||v0_fab_navn                                      , '  ' ,null)||v0_type_id        , v0_type_id        ) ||
              nvl2(v0_betegnelse      ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id                          , '  ' ,null)||v0_betegnelse     , v0_betegnelse     ) ||
              nvl2(v0_scope           ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id||v0_betegnelse           , '  ' ,null)||v0_scope          , v0_scope          ) ||
              nvl2(v0_aar             ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id||v0_betegnelse||v0_scope , '  ' ,null)||v0_aar            , v0_aar            )     
                                                         as c044_v0_info,
              ------------------------------------------   
              nvl2(prev_serie_no   ,                                                                                                                                            prev_serie_no  , null            ) ||
              nvl2(v1_reg_no       ,nvl2(prev_serie_no                                                                                                           , '  ' ,null)||v1_reg_no      , v1_reg_no       ) ||
              nvl2(v1_brukt_imp_yn ,nvl2(prev_serie_no||v1_reg_no                                                                                                , '  ' ,null)||v1_brukt_imp_yn, v1_brukt_imp_yn ) ||
              nvl2(v1_chassis_no   ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn                                                                               , '  ' ,null)||v1_chassis_no  , v1_chassis_no   ) ||
              nvl2(v1_tecdoc_id    ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no                                                                , '  ' ,null)||v1_tecdoc_id   , v1_tecdoc_id    ) ||
              nvl2(v1_tecdoc_besk  ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id                                                  , '  ' ,null)||v1_tecdoc_besk , v1_tecdoc_besk  ) ||
              nvl2(v1_km           ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk                                  , '  ' ,null)||v1_km          , v1_km           ) ||
              nvl2(v1_k_grp_id     ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km                           , '  ' ,null)||v1_km          , v1_km           ) ||
              nvl2(v1_dorer_id     ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km||v1_k_grp_id              , '  ' ,null)||v1_dorer_id    , v1_dorer_id     ) ||
              nvl2(v1_farge        ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km||v1_k_grp_id||v1_dorer_id , '  ' ,null)||v1_farge       , v1_farge        )     
                                                        as c045_v1_info,  
              ------------------------------------------                                                                            
              nvl2(v2_abs               ,                                                                                                                          v2_abs               , null                 ) ||
              nvl2(v2_servo             ,nvl2(v2_abs                                                                                                , '  ' ,null)||v2_servo             , v2_servo             ) ||
              nvl2(v2_sentral_laas      ,nvl2(v2_abs||v2_servo                                                                                      , '  ' ,null)||v2_sentral_laas      , v2_sentral_laas      ) ||
              nvl2(v2_farge_int         ,nvl2(v2_abs||v2_servo||v2_sentral_laas                                                                     , '  ' ,null)||v2_farge_int         , v2_farge_int         ) ||
              nvl2(v2_skinn_yn          ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int                                                       , '  ' ,null)||v2_skinn_yn          , v2_skinn_yn          ) ||
              nvl2(v2_setevarmere_yn    ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn                                          , '  ' ,null)||v2_setevarmere_yn    , v2_setevarmere_yn    ) ||
              nvl2(v2_tilhengerfeste_yn ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn||v2_setevarmere_yn                       , '  ' ,null)||v2_tilhengerfeste_yn , v2_tilhengerfeste_yn ) ||
              nvl2(v2_metallic_yn       ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn||v2_setevarmere_yn||v2_tilhengerfeste_yn , '  ' ,null)||v2_metallic_yn       , v2_metallic_yn       )     
                                                          as c046_v2_info_a,
              --------------------------------------------                                                                            
              nvl2(v2_xenon_yn          ,                                                                                                                          v2_xenon_yn          , null                 ) ||
              nvl2(v2_lys               ,nvl2(v2_xenon_yn                                                                                           , '  ' ,null)||v2_lys               , v2_lys               ) ||
              nvl2(v2_org_audio_yn      ,nvl2(v2_xenon_yn||v2_lys                                                                                   , '  ' ,null)||v2_org_audio_yn      , v2_org_audio_yn      ) ||
              nvl2(v2_el_speil_yn       ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn                                                                  , '  ' ,null)||v2_el_speil_yn       , v2_el_speil_yn       ) ||
              nvl2(v2_cruise_cont_yn    ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn                                                  , '  ' ,null)||v2_cruise_cont_yn    , v2_cruise_cont_yn    ) ||
              nvl2(v2_kjore_comp_yn     ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn                               , '  ' ,null)||v2_kjore_comp_yn     , v2_kjore_comp_yn     ) ||
              nvl2(v2_esp               ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn||v2_kjore_comp_yn             , '  ' ,null)||v2_esp               , v2_esp               ) ||
              nvl2(v2_aircon            ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn||v2_kjore_comp_yn||v2_esp     , '  ' ,null)||v2_aircon            , v2_aircon            )     
                                                         as c047_v2_info_b,
              -------------------------------------------                                                                            
              nvl2(v2_soltak            ,                                                                                                                          v2_soltak            , null                 ) ||
              nvl2(v2_el_heis_yn        ,nvl2(v2_soltak                                                                                             , '  ' ,null)||v2_el_heis_yn        , v2_el_heis_yn        ) ||
              nvl2(v2_drift             ,nvl2(v2_soltak||v2_el_heis_yn                                                                              , '  ' ,null)||v2_drift             , v2_drift             ) ||
              nvl2(v2_airbag_ant        ,nvl2(v2_soltak||v2_el_heis_yn||v2_drift                                                                    , '  ' ,null)||v2_airbag_ant        , v2_airbag_ant        ) ||
              nvl2(v2_airbag_def        ,nvl2(v2_soltak||v2_el_heis_yn||v2_drift||v2_airbag_ant                                                     , '  ' ,null)||v2_airbag_def        , v2_airbag_def        )    
                                                            as c048_v2_info_c,
              ' '                                           as c049,
              ' '                                           as c050
        from v_bildeler
    /  

----------------------------------------------------------- v_lbk_priser2          user ekstern > ola ------------------------------------------------------------------------------------------
    create or replace view v_lbk_priser2 as
        select 
            /*      
            Dato	  	Endring
            ===       	=======        
            2014_02_18	laget som kopi av v_nbf_priser2
            */   
            	fdata.bilkod				as bilkod,
            	fdata.delkod				as delkod,
            	count(*)					  as lbk_ant,	
            	max(to_number(replace (pris,'.0','')) )	as lbk_max,
            	min(to_number(min_pris.min_pris))       as lbk_min
        from 	ekstern.lbk_t_fdata fdata,
                 (select  bilkod,delkod, min(to_number(replace (pris,'.0','')) ) min_pris
                  from ekstern.lbk_t_fdata fdata
                  where  1=1 
                  and to_number(to_number(replace (pris,'.0','')))  >0
                  group by bilkod,delkod) min_pris
        where 1=1
            --and fdata.date_hist is null
            and fdata.bilkod=min_pris.bilkod(+)
            and fdata.delkod=min_pris.delkod(+)
            group by fdata.bilkod,fdata.delkod
    /
            grant all on v_lbk_priser2 to public;

            select count(*) from v_lbk_priser2;
            	161437		2014_02_14
            	164765		2014_02_15

            select distinct to_number(pris) from ekstern.lbk_t_fdata;
            select distinct pris from ekstern.lbk_t_fdata order by 1;
            select distinct pris,to_number(replace (pris,'.0','')) from ekstern.lbk_t_fdata order by 2;
            -1200.0	-1200
            -960.0	-960
            -800.0	-800
            0.0	    0
            1.0	    1
            2.0	    2



            select to_number('96.0') from dual;
            select to_number(replace ('96.0','.0','')) from dual;


            select to_number(decode(TRIM(translate ('1.99207e+007', '0123456789+.',' ')),'e',null,'1.99207e+007')) as e_tall,
                   to_number(decode(TRIM(translate ('1234'        , '0123456789+.',' ')),'e',null,'1234'))         as vanlig_tall
            from dual;
                E_TALL VANLIG_TALL
            ---------- -----------
                              1234

----------------------------------------------------------- v_nbf_bilkod           user ekstern > ola -----------------------------------------------------------------------------------------
    create or replace view v_nbf_bilkod as
            /*   
            Dato	  	Endring
            ===       	=======        
            2012_02_09	laget
            2015_03_07  lagt inn tecdoc Valldal
            */   
        select 
            --distinct ikke n�dvendig siden pk i hovedtabell er xxxkod,hist_date og vi krever hist_date= null lengre nede i where kriteriet
            -------------------------------------------------------------------------------------------------------------------------------
            nbf_bilkod_seq_no,
            date_in,
            date_upd,
            date_hist,
            bilkod,
            fabrkod,
            modkod,
            bilkodnamn,
            bilkodnamnnorge,
            bilkodnamnengland,
            bilkodnamntyskland,
            bilkodnamnny,
            bilnr,
            modellnr,
            bilmarke,
            bilmarkenamn,
            bilmarkenamnnorge,
            bilmarkenamnengland,
            bilmarkenamntyskland,
            modellnamn,
            modellgrupp,
            startar,
            slutar,
            chassinrlangd,
            chassinrkod,
            chassinrpos,
            skapaddatum,
            andraddatum,
            vanligtmarke,
            aktiv,
            startarno,
            slutarno,
            f_scope ('NBF_START',startar,slutar)    nbf_start,
            f_scope ('NBF_SLUTT',startar,slutar)    nbf_slutt,
            (select count(*) 
              from nbf_tecdok_bilkod
              where nbf_tecdok_bilkod.date_hist is null
              and   nbf_tecdok_bilkod.bilkod =nbf_bilkod.bilkod
              and   nbf_bilkod.date_hist is null
              and   nbf_bilkod.aktiv=1)                                as ant_tecdocnr
        from nbf_bilkod
        where date_hist is null
        and aktiv=1
    / 
            grant all on v_nbf_bilkod to public;

            select count(*) from v_nbf_bilkod;

            select count(*) from nbf_bilkod where date_hist is null and		aktiv=1;
            #1881   2015_03_06
            #2312   2020-11-01

----------------------------------------------------------- v_nbf_tecdok_bilkod    user ekstern > ola ------------------------------------------------------------------------------------------
    create or replace view v_nbf_tecdok_bilkod as
            /*   
            Dato	  	Endring
            ===       	=======        
            2015_03_07  laget Valldal
            --
            --FORUTSETTER at nbf_tecdok_bilkod er bygget opp av riktige data i nbf_tecdok og bbf_t_tecdok
            */   
        select 
              nbf_tecdok_bilkod.bilkod                  as bilkod,
              nbf_bilkod.bilkodnamnnorge                as bilkodnamnnorge,
              nbf_tecdok_bilkod.tecdocnr                as tecdocnr,
              nbf_tecdok.marke                          as marke,
              nbf_tecdok.modell                         as modell,
              nbf_tecdok.arsintervall                   as arsintervall,  --mm.yy-mm.yy (men litt feil p� Subaru
              substr(nbf_tecdok.arsintervall,4,2)       as fra_yy,
              substr(nbf_tecdok.arsintervall,1,2)       as fra_mm,
              substr(nbf_tecdok.arsintervall,10,2)      as til_yy,
              substr(nbf_tecdok.arsintervall,7,2)       as til_mm, 
              decode(nbf_tecdok.hk,null,null,
              to_char(nbf_tecdok.hk)||' hk')            as hk,
              decode(nbf_tecdok.drivmedel ,null,null, 
              'D', 'diesel','B','bensin',
              nbf_tecdok.drivmedel)                     as drivmedel,   --select distinct drivmedel from nbf_tecdok
              decode(nbf_tecdok.motorfamilj,null,null,  
              ''||nbf_tecdok.motorfamilj)         as motorfamilj,
              decode(nbf_tecdok.kaross ,null,null,  
              ''||nbf_tecdok.kaross)          as kaross
        from nbf_tecdok_bilkod,
                 nbf_tecdok,
                 nbf_bilkod
        where nbf_tecdok_bilkod.tecdocnr = nbf_tecdok.tecdocnr
            and   nbf_tecdok_bilkod.bilkod   = nbf_bilkod.bilkod (+) 
            and   nbf_tecdok_bilkod.date_hist is null
            and   nbf_tecdok.date_hist is null
            and   nbf_bilkod.date_hist(+) is null
            and     nbf_bilkod.aktiv(+)=1     
            order by nbf_tecdok.marke, nbf_tecdok.modell,substr(nbf_tecdok.arsintervall,4,2)
    /

            --APEX p509 map_bil 
            -------------------
            select tecdocnr,
            modell,arsintervall,hk,drivmedel,motorfamilj,kaross 
             from ola.v_nbf_tecdok_bilkod
            --where rownum <7
            where bilkod =:P210_SBRNR

            --APEX p210 reg del
            -------------------
            --Controlling Hide/Show Apex Regions Using Javascript
            --https://community.oracle.com/thread/3599613?start=0&tstart=0

            select bilkodnamnnorge,tecdocnr,
            marke, modell,arsintervall,hk,drivmedel,motorfamilj,kaross 
             from ekstern.v_nbf_tecdok_bilkod v_nbf_tecdok_bilkod,
                  ola.var_bil                 var_bil
            where v_nbf_tecdok_bilkod.bilkod = var_bil.sbrnr
            --and  rownum <7
            and var_bil_seq_no =:P210_V0_VAR_BIL_SEQ_NO




----------------------------------------------------------- v_nbf_delkod           user ekstern > ola ------------------------------------------------------------------------------------------
    create or replace view v_nbf_delkod as
            /*   
            Dato	  	Endring
            ===       	=======        
            2012_02_09	laget
            */   
        select 
            --distinct ikke n�dvendig siden pk i hovedtabell er xxxkod,hist_date og vi krever hist_date= null lengre nede i where kriteriet
            -------------------------------------------------------------------------------------------------------------------------------
            nbf_delkod_seq_no,
            date_in,
            date_upd,
            date_hist,
            delkod,
            fordtyp,
            delkodnamn,
            delkodnamnnorge,
            delkodnamnengland,
            delkodnamntyskland,
            aktiv
        from nbf_delkod
            where date_hist is null
            --ikke i bruk her
            --and		aktiv=1
            --m� vekk for � hindre table scan i v_enhet2
            --order by delkodnamnnorge
        / 
        
        grant all on v_nbf_delkod to public;

----------------------------------------------------------- v_nbf_priser2          user ekstern > ola -----------------------------------------------------------------V_MAP_OBAS_LBK_IMG-------------------------
    create or replace view v_nbf_priser2 as
        select 
            /*      
                 truncate table t_nbf_priser
                 insert into t_nbf_priser select * from ekstern.v_nbf_priser
                 commit
            Dato	  	Endring
            ===       	=======        
            2011_02_15	laget i ola
            2012_03_01  duplikat view i ola (ikke med dependencies) slettet
            2013_06_23  fikset to_number p� beg_pris siden jeg pumper den inn som varchar2 for � ung� problemer
            2014_02_12  v_nbf_priser ---> v_nbf_priser2 brukes i materialized view ola.mv_scope_bil_vare_nbf_pris
            2014_02_18  lagt in sjekk p� ant date_hist is null
            */   
            	laga.bilkod				as bilkod,
            	laga.delkod				as delkod,
            	count(*)					as nbf_ant,	
            	max(to_number(decode(TRIM(translate (begpris, '0123456789+.',' ')),'e',null,begpris)) )	as nbf_max,
            	min(to_number(min_pris.min_pris))                                                       as nbf_min
        from 	ekstern.nbf_lagabasen laga,
                 (select  bilkod,delkod, min(to_number(decode(TRIM(translate (begpris, '0123456789+.',' ')),'e',null,begpris)) ) min_pris
                  from ekstern.nbf_lagabasen laga
                  where  1=1 
                  and date_hist is null
                  and to_number(decode(TRIM(translate (begpris, '0123456789+.',' ')),'e',null,begpris))  >0
                  --having min(to_number(decode(TRIM(translate (begpris, '0123456789+.',' ')),'e',null,begpris)) ) >0
                  group by bilkod,delkod) min_pris
        where 1=1
            and laga.date_hist is null
            and laga.bilkod=min_pris.bilkod(+)
            and laga.delkod=min_pris.delkod(+)
            group by laga.bilkod,laga.delkod
    /
            grant all on v_nbf_priser2 to public;

            --fjerner alle tall med + i
            1.99207e+007
            2.0001e+007
            2.0001e+007
            2.01108e+007
            1.25e+007
            select to_number(decode(TRIM(translate ('1.99207e+007', '0123456789+.',' ')),'e',null,'1.99207e+007')) as e_tall,
                   to_number(decode(TRIM(translate ('1234'        , '0123456789+.',' ')),'e',null,'1234'))         as vanlig_tall
            from dual;
                E_TALL VANLIG_TALL
            ---------- -----------
                              1234

            select to_number(1.99207e+007) from dual;
            select to_number(2.0001e+007) from dual;
            select to_number(2.01108e+007) from dual;
            select to_number(1.25e+007) from dual;

              select * from  v_nbf_priser2;	
            	select count(*) from  v_nbf_priser2;	
            	--# 116 146 
            	--#  30 060   2012_02_29
            	--# 128 248   2013_06_23
            	--# 126 357   2014_02_18


----------------------------------------------------------- v_nbf_medlem_status    user ekstern > ola ------------------------------------------------------------------------------------------
    create or replace view v_nbf_medlem_status as
        select 
            /*      Brukes APEX 
            Dato	  	Endring
            ===       	=======        
            2011_02_13	laget
            */   
            	driver.medlemsnr		as medlemsnr,
            	driver.medlemsnamn		as medlemsnamn,
            	oppdatert.oppdatert		as oppdatert,
            	deler.ant_deler			as ant_deler,
            	biler.ant_biler			as ant_biler,
            	bilder_bil.ant_bilder_bil	as ant_bilder_bil,
            	bilder_del.ant_bilder_del	as ant_bilder_del,
            	priser.ant_priser		as ant_priser
        from   (select distinct
            	medlemsnr,
            	medlemsnamn
            	from  ekstern.nbf_medlem
            	where aktiv=1
            	and   land='Norge') 				driver,
            	(select medlemsnr	as medlemsnr,
            		count(*)		as ant_deler
            	 from ekstern.nbf_lagabasen
            	 where nvl(delkod,0) >1
            	 group by medlemsnr) 				deler,	
            	(select medlemsnr	as medlemsnr,
            		count(*)		as ant_biler
            	 from ekstern.nbf_lagabasen
            	 where nvl(delkod,0) =1
            	 group by medlemsnr) 				biler,	
            	(select medlemsnr	as medlemsnr,
            		count(*)	as ant_bilder_bil
            	 from ekstern.nbf_lagabasen
            	 where nvl(bildbil,0) >0
            	 group by medlemsnr) 				bilder_bil,	
            	(select medlemsnr	as medlemsnr,
            		count(*)	as ant_bilder_del
            	 from ekstern.nbf_lagabasen
            	 where nvl(bilddel,0) >0
            	 group by medlemsnr) 				bilder_del,	
            	(select medlemsnr	as medlemsnr,
            		count(*)	as ant_priser
            	 from ekstern.nbf_lagabasen
            	 where nvl(begpris,0) >0
            	 group by medlemsnr) 				priser,	
            	(select medlemsnr		as medlemsnr,
            		max(lagringsdatum)	as oppdatert
            	 from ekstern.nbf_lagabasen
            	  group by medlemsnr) 				oppdatert	
        where 	driver.medlemsnr	=      deler.medlemsnr (+)
            and	driver.medlemsnr	=      biler.medlemsnr (+)
            and	driver.medlemsnr	= bilder_bil.medlemsnr (+)
            and	driver.medlemsnr	= bilder_del.medlemsnr (+)
            and	driver.medlemsnr	=     priser.medlemsnr (+)
            and	driver.medlemsnr	=  oppdatert.medlemsnr (+)
        /
            grant all on v_nbf_medlem_status to public;

----------------------------------------------------------- v_aws_xxx -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_aws_lookup_location as
        with tot_count as ( select count(*) as cnt  from location )
            ,source    as ( select *                from location order by loc_id )
        select 
             rownum as q_no
            ,cnt    as q_cnt 
            ,location_seq_no
            ,loc_id
            ,loc_besk
            ,export_yn
        from 
             tot_count
            ,source
    /

    create or replace view v_aws_lookup_prosess as
        with tot_count as ( select count(*) as cnt  from v_kpi )
            ,source    as ( select *                from v_kpi order by prosess )
        select 
             rownum as q_no
            ,cnt    as q_cnt 
            ,prosess
            ,prosess_desc
        from 
             tot_count
            ,source
    /

    create or replace view v_aws_lookup_kpi as
        with tot_count as ( select count(*) as cnt  from v_kpi )
            ,source    as ( select *                from v_kpi order by prosess )
        select 
             rownum as q_no
            ,cnt    as q_cnt 
            ,prosess
            ,prosess_desc
            ,yyyy_mm_dd
            ,yyyy_ww
            ,yyyy_mm
            ,yyyy            
        from 
             tot_count
            ,source
    /

----------------------------------------------------------- v_kpi -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_kpi as
        --create or replace view ttt as
        with hittil as ( 
                --          select                         prosess,                               prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from t_enhet3 group by prosess, prosess_desc, to_char(stamp,'yyyy-mm-dd HH24:MI:SS')
                        select  flow_d1     as prosess, flow_d1_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_d1 is not null group by flow_d1, flow_d1_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_d2     as prosess, flow_d2_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_d2 is not null group by flow_d2, flow_d2_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_d3     as prosess, flow_d3_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_d3 is not null group by flow_d3, flow_d3_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_d4     as prosess, flow_d4_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_d4 is not null group by flow_d4, flow_d4_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v1     as prosess, flow_v1_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v1 is not null group by flow_v1, flow_v1_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v2     as prosess, flow_v2_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v2 is not null group by flow_v2, flow_v2_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v3     as prosess, flow_v3_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v3 is not null group by flow_v3, flow_v3_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v4     as prosess, flow_v4_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v4 is not null group by flow_v4, flow_v4_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v5     as prosess, flow_v5_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v5 is not null group by flow_v5, flow_v5_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select  flow_v6     as prosess, flow_v6_desc                        as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from v_enhet2 where flow_v6 is not null group by flow_v6, flow_v6_desc, to_char(sysdate,'yyyy-mm-dd HH24:MI:SS') 
                union   select 'X1'         as prosess, 'Vrak med chassis no.'              as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from enhet    where stamp_chassis_no       is not null and to_char(stamp_chassis_no        ,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd' ) 
                union   select 'X1'         as prosess, 'Vrak med chassis no.'              as prosess_desc,  'yyyy-iw'    as scope,    count(*) as cnt from enhet    where stamp_chassis_no       is not null and to_char(stamp_chassis_no        ,'yyyy-iw'   )=to_char(sysdate,'yyyy-iw'    )
                union   select 'X1'         as prosess, 'Vrak med chassis no.'              as prosess_desc,  'yyyy-mm'    as scope,    count(*) as cnt from enhet    where stamp_chassis_no       is not null and to_char(stamp_chassis_no        ,'yyyy-mm'   )=to_char(sysdate,'yyyy-mm'    )
                union   select 'X1'         as prosess, 'Vrak med chassis no.'              as prosess_desc,  'yyyy'       as scope,    count(*) as cnt from enhet    where stamp_chassis_no       is not null and to_char(stamp_chassis_no        ,'yyyy'      )=to_char(sysdate,'yyyy'       )
                union   select 'X2'         as prosess, 'Vrak milj'||f_utf('oe')||'klaert'  as prosess_desc,  'yyyy-mm-dd' as scope,    count(*) as cnt from enhet    where stamp_miljo_klarert_id is not null and to_char(stamp_miljo_klarert_id  ,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd' ) 
                union   select 'X2'         as prosess, 'Vrak milj'||f_utf('oe')||'klaert'  as prosess_desc,  'yyyy-iw'    as scope,    count(*) as cnt from enhet    where stamp_miljo_klarert_id is not null and to_char(stamp_miljo_klarert_id  ,'yyyy-iw'   )=to_char(sysdate,'yyyy-iw'    )
                union   select 'X2'         as prosess, 'Vrak milj'||f_utf('oe')||'klaert'  as prosess_desc,  'yyyy-mm'    as scope,    count(*) as cnt from enhet    where stamp_miljo_klarert_id is not null and to_char(stamp_miljo_klarert_id  ,'yyyy-mm'   )=to_char(sysdate,'yyyy-mm'    )
                union   select 'X2'         as prosess, 'Vrak milj'||f_utf('oe')||'klaert'  as prosess_desc,  'yyyy'       as scope,    count(*) as cnt from enhet    where stamp_miljo_klarert_id is not null and to_char(stamp_miljo_klarert_id  ,'yyyy'      )=to_char(sysdate,'yyyy'       )
            )  
            ,hittil_x as (           
                select * from  (select                 prosess,                               prosess_desc,                  scope,                cnt from hittil )
                         pivot (sum(cnt)   for scope in ('yyyy-mm-dd', 'yyyy-iw', 'yyyy-mm', 'yyyy') )
                order by 1
            )
        select 
             trim(prosess       )            as prosess
            ,trim(prosess_desc  )            as prosess_desc
            ,to_number( "'yyyy-mm-dd'" )     as yyyy_mm_dd
            ,to_number( "'yyyy-iw'"    )     as yyyy_ww
            ,to_number( "'yyyy-mm'"    )     as yyyy_mm
            ,to_number( "'yyyy'"       )     as yyyy
        from hittil_x
        --order by 1 for å speede opp
    /

    --scheduler   
        oppdatering av t_enhet3,kpi og priser skjer i scheduleren se:   --\\192.168.1.100\util\dbms\Scheduler\sch_xx.sql
                                                                            "Scheduler startes   med: execute dbms_scheduler.run_job('ola_oppdatere_ebay');"
                                                                            "Prossedyren startes med: execute pr_obas_scheduler(1); "

    --test
        select to_char(sysdate,'yyyy-ww'    ), count(*) as cnt from enhet    where stamp_miljo_klarert_id is not null and to_char(stamp_miljo_klarert_id  ,'yyyy-ww'   )=to_char(sysdate,'yyyy-ww'    ) group by to_char(sysdate,'yyyy-ww'    )

        select count(*) from v_kpi;
        select count(*) from ttt;
        select count(*) from tt;

            --truncate table plan_table;
            --ordered  all_rows  RASKT...
            delete from plan_table where statement_id='v_kpi';  
            delete from plan_table where statement_id='ttt';    
            delete from plan_table where statement_id='tt';    
            explain plan set statement_id='v_kpi' into plan_table for select * from v_kpi;  
            explain plan set statement_id='ttt'   into plan_table for select * from ttt;    
            explain plan set statement_id='tt'    into plan_table for select * from tt;    
            commit;	

            delete from plan_table where statement_id='v_enhet2';  
            delete from plan_table where statement_id='v_enhet3';    
            explain plan set statement_id='v_enhet2' into plan_table for select * from v_enhet2;  
            explain plan set statement_id='v_enhet3' into plan_table for select * from v_enhet3;  
            commit;

    --APEX
        select 
             prosess
            ,prosess_desc
            ,yyyy_mm_dd     as yyyy_mm_dd_p
            ,yyyy_ww        as yyyy_ww_p
            ,yyyy_mm        as yyyy_mm_p
            ,yyyy           as yyyy_p
            ,case when prosess = 'D1'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D2'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D3'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D4'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V1'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V2'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V3'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V4'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V5'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V6'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'X1'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_MM_DD'||':,'||to_char(sysdate,'yyyy-mm-dd')||'"> '  ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'X2'    and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_MM_DD'||':,'||to_char(sysdate,'yyyy-mm-dd')||'"> '  ||yyyy_mm_dd      ||'</a>'  end as yyyy_mm_dd
            ,case when prosess = 'X1'    and yyyy_ww    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_WW'   ||':,'||to_char(sysdate,'yyyy-ww')   ||'"> '  ||yyyy_ww         ||'</a>'  
                  when prosess = 'X2'    and yyyy_ww    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_WW'   ||':,'||to_char(sysdate,'yyyy-ww')   ||'"> '  ||yyyy_ww         ||'</a>'  end as yyyy_ww
            ,case when prosess = 'X1'    and yyyy_mm    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_MM'   ||':,'||to_char(sysdate,'yyyy-mm')   ||'"> '  ||yyyy_mm         ||'</a>'  
                  when prosess = 'X2'    and yyyy_mm    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_MM'   ||':,'||to_char(sysdate,'yyyy-mm')   ||'"> '  ||yyyy_mm         ||'</a>'  end as yyyy_mm
            ,case when prosess = 'X1'    and yyyy       is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY'      ||':,'||to_char(sysdate,'yyyy'   )   ||'"> '  ||yyyy            ||'</a>'  
                  when prosess = 'X2'    and yyyy       is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY'      ||':,'||to_char(sysdate,'yyyy'   )   ||'"> '  ||yyyy            ||'</a>'  end as yyyy
        from v_kpi


----------------------------------------------------------- S_kpi -----------------------------------------------------------------------------------------------------------------------------------

    --create table  s_stat_flow_hist as 
    insert into s_stat_flow_hist 
    select * from v_stat_flow;
    commit;


    insert into s_stat_flow_hist 
    select prosess, prosess_desc, to_char(stamp,'DD-MON-YYYY HH24:MI:SS') as stamp , count(*) from t group by prosess, prosess_desc, to_char(stamp,'DD-MON-YYYY HH24:MI:SS') order by 1









----------------------------------------------------------- mySQL TecDoc -----------------------------------------------------------------------------
    --V_DES_TEXTGS------------  må få vekk text formatet
        --drop table v_des_texts;
        CREATE TABLE v_des_texts (
            TEX_ID INT(11),
            TEX_TEXT NVARCHAR(1500)
        );

        INSERT INTO v_des_texts(tex_id, tex_text)
        SELECT tex_id, CAST(tex_text AS CHAR(1500)) FROM des_texts;
        -- 1308167  


        describe des_texts;
        describe v_des_texts;


    --V_DES_ID------------  Ledetekster (liste alle ledeteksten --> join på des_id)
		--drop view v_des_id;
        create view v_des_id as
        	select lng_id, 
					'NORSK' language,
        	       des_id,
        	       tex_id,
        	       tex_text
        	from    languages,
        	        designations,
        	        des_texts            
        	where lng_id = 12
        	and   lng_id     = des_lng_id 
        	/*and   lng_des_id = des_id   */
        	and   des_tex_id = tex_id;


		select count(*) from v_des_id;
		--30 647

    --V_TECDOC
		--drop view v_tecdoc_inner;
		    create view v_tecdoc_inner as
   	        	select  typ_id  as tecdoc_id,
            	        mfa_id, mfa_brand,
            	        mod_id, mod_cds_id, cds_1.cds_tex_id    as mod_cds_tex_id,
                                            des_1.tex_text      as mod_cds_text,
                                            cds_2.cds_tex_id    as typ_mmt_cds_tex_id,
                                            des_2.tex_text      as typ_mmt_cds_text,
                                            mod_pcon_start, mod_pcon_end,
            	                            typ_pcon_start, typ_pcon_end,
            	        typ_id,                                             typ_kw_from,                typ_kw_upto,
            	                                                            typ_hp_from,                typ_hp_upto,    typ_ccm   ,  typ_ccm_tax,
            	                                                            typ_litres,                 typ_cylinders,  typ_valves,  typ_doors,     typ_tank,
                                                                            /*Outer */
                                                                            typ_kv_body_des_id,         typ_kv_drive_des_id,
            	        eng_id,         eng_pcon_start, eng_pcon_end,       eng_description,            eng_code,
            	                                                            eng_kw_from,                eng_kw_upto,
            	                                                            eng_hp_from,                eng_hp_upto,
            	                                                            eng_litres_from,            eng_litres_upto,
            	                                                            eng_cylinders,              eng_crankshaft,
                                                                            /*Outer */         		
                                                                            eng_kv_engine_des_id,       eng_kv_fuel_type_des_id,  eng_kv_fuel_supply_des_id
            	from    tecdoc.types  
            	        ,tecdoc.models
            	        ,tecdoc.manufacturers
                        /*  select count(*) from types  where typ_mmt_cds_id is null
                            select count(*) from models where mod_cds_id     is null
                            --0  */
                        ,tecdoc.country_designations cds_1
                        ,tecdoc.country_designations cds_2
                        ,tecdoc.des_texts            des_1
                        ,tecdoc.des_texts            des_2
            	        ,tecdoc.link_typ_eng
            	        ,tecdoc.engines
                        /*Outer */
                where 1=1
            	and typ_mod_id     = mod_id
                and typ_mmt_cds_id = cds_2.cds_id
                and                  cds_2.cds_lng_id = 12
                and                  cds_2.cds_tex_id = des_2.tex_id
            	and mod_mfa_id     = mfa_id
                and mod_cds_id     = cds_1.cds_id
                and                  cds_1.cds_lng_id = 12
                and                  cds_1.cds_tex_id = des_1.tex_id
            	and typ_id         =  lte_typ_id
            	and lte_eng_id     =      eng_id 
		    ;

		--drop view v_tecdoc_outer;
		    create view v_tecdoc_outer as
   	        	select  typ_id tecdoc_id,
            	        mfa_id, mfa_brand,
            	        mod_id, mod_cds_id, mod_cds_tex_id,
                                            mod_cds_text,
                                            typ_mmt_cds_tex_id,
                                            typ_mmt_cds_text,
                                            mod_pcon_start, mod_pcon_end,
            	                            typ_pcon_start, typ_pcon_end,
            	        typ_id,                                             typ_kw_from,                typ_kw_upto,
            	                                                            typ_hp_from,                typ_hp_upto,    typ_ccm   ,  typ_ccm_tax,
            	                                                            typ_litres,                 typ_cylinders,  typ_valves,  typ_doors,     typ_tank,
                                                                            typ_kv_body_des_id,         typ_kv_drive_des_id,
                                                                            /*Outer */ 
                                                                            typ_body.tex_text       as  typ_body, 
                                                                            typ_drive.tex_text      as  typ_drive, 
            	        eng_id,         eng_pcon_start, eng_pcon_end,       eng_description,            eng_code,
            	                                                            eng_kw_from,                eng_kw_upto,
            	                                                            eng_hp_from,                eng_hp_upto,
            	                                                            eng_litres_from,            eng_litres_upto,
            	                                                            eng_cylinders,              eng_crankshaft,
                                                                            /*Outer */ 
                                                                            eng_type.tex_text        as eng_type,               		
                                                                            eng_fuel_type.tex_text   as eng_fuel_type,               		
                                                                            eng_fuel_supply.tex_text as eng_fuel_supply 
            	from     tecdoc.v_tecdoc_inner
                /*Outer */ 
            	LEFT JOIN tecdoc.v_des_id typ_body        ON typ_kv_body_des_id         = typ_body.des_id        
            	LEFT JOIN tecdoc.v_des_id typ_drive       ON typ_kv_drive_des_id        = typ_drive.des_id       
            	LEFT JOIN tecdoc.v_des_id eng_type        ON eng_kv_engine_des_id       = eng_type.des_id        
            	LEFT JOIN tecdoc.v_des_id eng_fuel_type   ON eng_kv_fuel_type_des_id    = eng_fuel_type.des_id   
            	LEFT JOIN tecdoc.v_des_id eng_fuel_supply ON eng_kv_fuel_supply_des_id  = eng_fuel_supply.des_id 
                where 1=1
		    ;

		--drop view v_tecdoc;
		    create view v_tecdoc as
                select  /*GENERAL-----------------------------------------------------*/
                            /*concat(
                                mfa_brand   ,' ',
                                mod_cds_text,' ', */
                                typ_mmt_cds_text                               as gen_type
                            ,concat(
                                substr(typ_pcon_start,1,4),'.'  ,
                                substr(typ_pcon_start,5,6),' - ',
                                substr(typ_pcon_end  ,1,4),'.'  ,
                                substr(typ_pcon_end  ,5,6)         )        as gen_constr_interval
                            , tecdoc_id                                     as gen_tecdoc_type_id
                        /*BODY----------------------------------------------------------*/
                            ,typ_body                                       as body_body_type
                            ,typ_drive                                      as body_drive_type
                        /*TECHNICAL DATA------------------------------------------------*/
                            ,typ_kw_from                                    as power_kw
                            ,typ_hp_from                                    as power_hp
                            ,concat (typ_ccm_tax,' ccm')                    as power_cap_tax
                            ,concat (typ_ccm    ,' ccm')                    as power_cap_technical
                            ,concat (typ_litres ,' l'  )                    as power_cap_l
                            ,typ_valves                                     as power_nos_valves
                            ,typ_cylinders                                  as power_nos_cylinders
                            ,eng_type                                       as power_engine_type
                            ,eng_fuel_type                                  as power_fuel_type
                            ,eng_fuel_supply                                as power_fuel_mixture
                        /*ENGINE-----------------------------------------------------*/
                            ,eng_code                                       as engine_engine_code
                from v_tecdoc_outer
                /*where tecdoc_id = 22667 */
            ;

		select count(*) from v_tecdoc_inner;
        select count(*) from v_tecdoc_outer;
        select count(*) from v_tecdoc;
		--53830 bare mfa og mod
        --55917 med lt_type_eng og engines
		

		select gen_tecdoc_type_id, count(*) from v_tecdoc group by gen_tecdoc_type_id having count(*) >1;

		--0
        --9114
		select tecdoc_id, count(*) from v_tecdoc_outer group by tecdoc_id having count(*) >1;


	--tests
        select 
             bra_mfc_code
            ,arl_search_number
        from
            brands 
            ,art_lookup
        where bra_id =arl_bra_id
        and   bra_id in (10558,11288,2)
        limit 10

        and mfa_brand='SAAB' 
        and mod_id = 5598
        and mfa_id = mod_mfa_id

-T--------------------------------------------------------- TECDOC -----------------------------------------------------------------------------------------------------------------------------------
    --log in 
       conn sys/Ora12c1803@192.168.1.7/pdbtecdoc.bildeler.net as sysdba
       conn tecdoc/tecdoc@192.168.1.7/pdbtecdoc.bildeler.net 

    --hente data
        create table tecdoc                     as select * from v_tecdoc@tecdoc;
        create table tecdoc_inner               as select * from v_tecdoc_inner@tecdoc;
        create table tecdoc_outer               as select * from v_tecdoc_outer@tecdoc;
        create table tecdoc_des_id              as select * from v_des_id@tecdoc;

        create table country_designations       as select * from country_designations@tecdoc;  
        --drop table des_texts;      
        create table des_texts                  as select * from v_des_texts@tecdoc;
        create table designations               as select * from designations@tecdoc;
        create table engines                    as select * from engines@tecdoc;                    
        create table languages                  as select * from languages@tecdoc;                   
        create table link_typ_eng               as select * from link_typ_eng@tecdoc;                
        create table manufacturers              as select * from manufacturers@tecdoc;                   
        create table models                     as select * from models@tecdoc;                      
        create table types                      as select * from types@tecdoc;                        
        create table link_typ_mrk               as select * from link_typ_mrk@tecdoc;                        


    --konvertere kolionner (kun nødvendig på view i MySQL som er definert med små bokstaver)
        set out on size 200000
        var ret     varchar2(255);
        execute pr_columns_to_upper ('TECDOC', 'COUNTRY_DESIGNATIONS'         ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'DES_TEXTS'                    ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'DESIGNATIONS'                 ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'ENGINES'                      ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'LANGUAGES'                    ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'LINK_TYP_ENG'                 ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'MANUFACTURERS'                ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'MODELS'                       ,:ret);
        execute pr_columns_to_upper ('TECDOC', 'TYPES'                        ,:ret);

	--v_tecdoc_inner
    	create or replace view v_tecdoc_inner as
   	    	select  typ_id  as tecdoc_id,
        	        mfa_id, mfa_brand,
        	        mod_id, mod_cds_id, cds_1.cds_tex_id    as mod_cds_tex_id,
                                        des_1.tex_text      as mod_cds_text,
                                        cds_2.cds_tex_id    as typ_mmt_cds_tex_id,
                                        des_2.tex_text      as typ_mmt_cds_text,
                                        cds_3.cds_tex_id    as typ_cds_tex_id,
                                        des_3.tex_text      as typ_cds_text,
                                        mod_pcon_start, mod_pcon_end,
        	                            typ_pcon_start, typ_pcon_end,
        	        typ_id,                                             typ_kw_from,                typ_kw_upto,
        	                                                            typ_hp_from,                typ_hp_upto,    typ_ccm   ,  typ_ccm_tax,
        	                                                            typ_litres,                 typ_cylinders,  typ_valves,  typ_doors,     typ_tank,
                                                                        /*Outer */
                                                                        typ_kv_body_des_id,         typ_kv_drive_des_id,
        	        eng_id,         eng_pcon_start, eng_pcon_end,       eng_description,            eng_code,
        	                                                            eng_kw_from,                eng_kw_upto,
        	                                                            eng_hp_from,                eng_hp_upto,
        	                                                            eng_litres_from,            eng_litres_upto,
        	                                                            eng_cylinders,              eng_crankshaft,
                                                                        /*Outer */         		
                                                                        eng_kv_engine_des_id,       eng_kv_fuel_type_des_id,  eng_kv_fuel_supply_des_id
        	from    tecdoc.types  
        	        ,tecdoc.models
        	        ,tecdoc.manufacturers
                    /*  select count(*) from types  where typ_mmt_cds_id is null
                        select count(*) from models where mod_cds_id     is null
                        --0  */
                    ,tecdoc.country_designations cds_1
                    ,tecdoc.country_designations cds_2
                    ,tecdoc.country_designations cds_3
                    ,tecdoc.des_texts            des_1
                    ,tecdoc.des_texts            des_2
                    ,tecdoc.des_texts            des_3
        	        ,tecdoc.link_typ_eng
        	        ,tecdoc.engines
                    /*Outer */
            where 1=1
        	    and typ_mod_id     = mod_id
                and typ_mmt_cds_id = cds_2.cds_id
                and                  cds_2.cds_lng_id = 12
                and                  cds_2.cds_tex_id = des_2.tex_id
        	    and mod_mfa_id     = mfa_id
                and mod_cds_id     = cds_1.cds_id
                and                  cds_1.cds_lng_id = 12
                and                  cds_1.cds_tex_id = des_1.tex_id
        	    and typ_id         =  lte_typ_id
        	    and lte_eng_id     =      eng_id 
                and typ_cds_id     = cds_3.cds_id
                and                  cds_3.cds_lng_id = 12
                and                  cds_3.cds_tex_id = des_3.tex_id
		/

            select count(*) from v_tecdoc_inner;
            --55917

    --v_desc
        create view v_des_id as
        	select lng_id, 
					'NORSK' language,
        	       des_id,
        	       tex_id,
        	       tex_text
        	from    languages,
        	        designations,
        	        des_texts            
        	where lng_id = 12
        	and   lng_id     = des_lng_id 
        	/*and   lng_des_id = des_id   */
        	and   des_tex_id = tex_id
        /

		    select count(*) from v_des_id;
		    --30 647



    --v_tecdoc_outer
        create or replace view v_tecdoc_outer as
   	        select  typ_id tecdoc_id,
                    mfa_id, mfa_brand,
                    mod_id, mod_cds_id, mod_cds_tex_id,
                                        mod_cds_text,
                                        typ_mmt_cds_tex_id,
                                        typ_mmt_cds_text,
                                        typ_cds_tex_id,
                                        typ_cds_text,
                                        mod_pcon_start, mod_pcon_end,
                                        typ_pcon_start, typ_pcon_end,
                    typ_id,                                             typ_kw_from,                typ_kw_upto,
                                                                        typ_hp_from,                typ_hp_upto,    typ_ccm   ,  typ_ccm_tax,
                                                                        typ_litres,                 typ_cylinders,  typ_valves,  typ_doors,     typ_tank,
                                                                        typ_kv_body_des_id,         typ_kv_drive_des_id,
                                                                        /*Outer */ 
                                                                        typ_body.tex_text       as  typ_body, 
                                                                        typ_drive.tex_text      as  typ_drive, 
                    eng_id,         eng_pcon_start, eng_pcon_end,       eng_description,            eng_code,
                                                                        eng_kw_from,                eng_kw_upto,
                                                                        eng_hp_from,                eng_hp_upto,
                                                                        eng_litres_from,            eng_litres_upto,
                                                                        eng_cylinders,              eng_crankshaft,
                                                                        /*Outer */ 
                                                                        eng_type.tex_text        as eng_type,               		
                                                                        eng_fuel_type.tex_text   as eng_fuel_type,               		
                                                                        eng_fuel_supply.tex_text as eng_fuel_supply 
            from    tecdoc.v_tecdoc_inner
                    ,tecdoc.v_des_id     typ_body       
                    ,tecdoc.v_des_id     typ_drive      
                    ,tecdoc.v_des_id     eng_type       
                    ,tecdoc.v_des_id     eng_fuel_type  
                    ,tecdoc.v_des_id     eng_fuel_supply
            where 1=1
                and typ_kv_body_des_id         = typ_body.des_id            (+)
                and typ_kv_drive_des_id        = typ_drive.des_id           (+)
                and eng_kv_engine_des_id       = eng_type.des_id            (+)
                and eng_kv_fuel_type_des_id    = eng_fuel_type.des_id       (+)
                and eng_kv_fuel_supply_des_id  = eng_fuel_supply.des_id     (+)
 		/
            select count(*) from v_tecdoc_outer;
            --55917

    --v_tecdoc
		create or replace view v_tecdoc as
            select  /*GENERAL-----------------------------------------------------*/
                         tecdoc_id                                      as tecdoc_id
                        ,mfa_brand                                      as merke
                        ,mod_cds_text                                   as modell
                        ,typ_cds_text                                   as type
                        /*concat(
                            mfa_brand   ,' ',
                            mod_cds_text,' ', */
                            ,typ_mmt_cds_text                           as gen_type
                            ,substr(typ_pcon_start,1,4)||'.'  ||
                             substr(typ_pcon_start,5,6)||' - '||
                             substr(typ_pcon_end  ,1,4)||'.'  ||
                             substr(typ_pcon_end  ,5,6)                 as gen_constr_interval
                        , tecdoc_id                                     as gen_tecdoc_type_id
                    /*BODY----------------------------------------------------------*/
                        ,typ_body                                       as body_body_type
                        ,typ_drive                                      as body_drive_type
                    /*TECHNICAL DATA------------------------------------------------*/
                        ,typ_kw_from                                    as power_kw
                        ,typ_hp_from                                    as power_hp
                        ,typ_ccm_tax||' ccm'                            as power_cap_tax
                        ,typ_ccm    ||' ccm'                            as power_cap_technical
                        ,typ_litres ||' l'                              as power_cap_l
                        ,typ_valves                                     as power_nos_valves
                        ,typ_cylinders                                  as power_nos_cylinders
                        ,eng_type                                       as power_engine_type
                        ,eng_fuel_type                                  as power_fuel_type
                        ,eng_fuel_supply                                as power_fuel_mixture
                    /*ENGINE-----------------------------------------------------*/
                        ,eng_code                                       as engine_engine_code
            from v_tecdoc_outer
        /
            /*where tecdoc_id = 22667 */

            select count(*) from v_tecdoc;
            --55917         1018633,1018641,1018651

    --t_tecdoc
    --t_tecdoc
        --drop table t;
        create table t as select * from v_tecdoc;
            select tecdoc_id, count(*) from t group by tecdoc_id having count(*) >1;
            --9114  ,   typisk motor_kode eks I (1018633;1018641;1018651)
            --1401  ,   typisk engine fuel mix 1013158;1013371;1015260
            --      ,   typisk power fuel type 19596;21679
            --2     ,   typisk power engine       9408;1011006

        --drop table t1;
        create table t1 as 
            select
                tecdoc_id
                ,merke
                ,modell
                ,type
                ,gen_type
                ,gen_constr_interval
                ,gen_tecdoc_type_id
                ,body_body_type
                ,body_drive_type
                ,power_kw
                ,power_hp
                ,power_cap_tax
                ,power_cap_technical
                ,power_cap_l
                ,power_nos_valves
                ,power_nos_cylinders
                ,listagg(power_engine_type ,',') within group (order by power_engine_type ) as power_engine_type
                ,listagg(power_fuel_type   ,',') within group (order by power_fuel_type   ) as power_fuel_type
                ,listagg(power_fuel_mixture,',') within group (order by power_fuel_mixture) as power_fuel_mixture
                ,listagg(engine_engine_code,',') within group (order by engine_engine_code) as engine_engine_code
            from t
            group by tecdoc_id
                    ,merke
                    ,modell
                    ,type
                    ,gen_type
                    ,gen_constr_interval
                    ,gen_tecdoc_type_id
                    ,body_body_type
                    ,body_drive_type
                    ,power_kw
                    ,power_hp
                    ,power_cap_tax
                    ,power_cap_technical
                    ,power_cap_l
                    ,power_nos_valves
                    ,power_nos_cylinders
            order by gen_type ,gen_constr_interval
               
        /
            select tecdoc_id, count(*) from t1 group by tecdoc_id having count(*) >1;
            --0


        --drop table t_tecdoc;
        create table t_tecdoc as 
            select
                tecdoc_id
                ,merke
                ,modell
                ,type
                ,gen_type
                ,gen_constr_interval
                ,gen_tecdoc_type_id
                ,body_body_type
                ,body_drive_type
                ,power_kw
                ,power_hp
                ,power_cap_tax
                ,power_cap_technical
                ,power_cap_l
                ,power_nos_valves
                ,power_nos_cylinders
                ,case when power_engine_type like 'Bensin%' and power_engine_type not like '%totak%'    then 'Bensin'
                      when power_engine_type like '%totak%'                                             then 'totakts'
                      when power_engine_type like 'Diesel%'                                             then 'Diesel'
                      when power_engine_type like 'Bensinmotor,elektromotor'                            then 'hybrid'
                      when power_engine_type like 'elektromotor'                                        then 'elektromotor'
                      when power_engine_type like 'hybrid'                                              then 'hybrid'
                      when power_engine_type like 'Wankel'                                              then 'Wankel'
                      else power_engine_type end as power_engine_type
                ,power_fuel_type
                ,power_fuel_mixture
                ,engine_engine_code
            from t1
            order by gen_type ,gen_constr_interval
        /
            select tecdoc_id, count(*) from t_tecdoc group by tecdoc_id having count(*) >1;
            --0

            select count(*) from t_tecdoc;
            --41904


        alter table  t_tecdoc add constraint t_tecdoc_pk primary key (tecdoc_id);
        -- alter table t_enhet3 modify (fri_tekst_1 varchar2(4000), fri_tekst_2 varchar2(4000), fri_tekst_3 varchar2(4000) );
        create index t_tecdoc_i1 on t_tecdoc(gen_constr_interval);
        create index t_tecdoc_i2 on t_tecdoc(engine_engine_code);

    --tecdoc
        select trim(tecdoc_id) from enhet minus select to_char(tecdoc_id) from t_tecdoc@pdbtecdoc;
        --3456 intersect
        --81 minus


----------------------------------------------------------- API    -----------------------------------------------------------------------------------------------------------------------------------
    --views                             <- GUI navn ->      <- https://api.qrv.no/obas/ ->
        --v_api_lov_var_kjore_grp
            create or replace view v_api_lov_var_kjore_grp as   
                select 
                     var_kjore_grp_seq_no                                           as var_kjore_grp_seq_no 
                    ,k_grp_id                                                       as k_grp_id
                from ola.var_kjore_grp
                where k_grp_id is not null
                order by k_grp_id;
            /

        --v_api_var_motor_volum
            create or replace view v_api_var_motor_volum as
                select 
                     var_motor_volum_seq_no                                         as var_motor_volum_seq_no
                    ,motor_vol_id                                                   as motor_vol_id    
                from ola.var_motor_volum
                where motor_vol_id is not null
                order by motor_vol_id;
            /
        --v_api_var_motor_type
            create or replace view v_api_motor_type_id as   
                select
                       motor_type_id                                                as motor_type_id
                      ,var_motor_type_seq_no                                        as var_motor_type_seq_no 
                from ola.var_motor_type
                where motor_type_id is not null
                order by motor_type_id;
            /
        --v_api_lov_actor_id            Dekkmerke
            create or replace view v_api_lov_actor_id as 
                select
                    actor_id_dekk                                                   as actor_id_dekk
                    ,actor_seq_no                                                   as actor_seq_no
                from ola.actor
                where actor_id_dekk is not null
                order by actor_id
            /

        --v_api_lov_bil_obas            Bil
            --pagination size 9999
            create or replace view v_api_lov_bil_obas as 
                select
                    obas                                                            as bil_obas 
                    ,var_bil_seq_no                                                 as var_bil_seq_no
                from   ola.v_var_bil
                where sbrnr is not null
                order by bil_obas
            /
            
        --v_api_lov_dekk_type           Dekktype
            create or replace view v_api_lov_dekk_type as 
                select 
                    dekk_bredde||' '||dekk_hoyde||' '||dekk_dim                     as dekk_type
                    ,dekk_type_seq_no                                               as dekk_type_seq_no
                from ola.dekk_type
                order by dekk_bredde||' '||dekk_hoyde||' '||dekk_dim
            /

        --v_api_lov_enhet               Vraknummer
                /*
                    2020-07-23 Laget Morten,  skal brukes i Apex og iPhone
                */
            create or replace view v_api_lov_enhet as 
                select
                     serie_no||' '||to_char(enhet_dato_inn,'yyyy-mm-dd')            as serie_no
                    ,enhet_seq_no                                                   as enhet_seq_no
                from   ola.v_serie_no
                where vrak_del='VRAK'
                and use is not null
                order by serie_sort_no desc
            /

        --v_api_lov_enhet_nye
            create or replace view v_api_lov_enhet_nye as 
                select
                     serie_no||' '||to_char(enhet_dato_inn,'yyyy-mm-dd')            as serie_no
                    ,enhet_seq_no                                                   as enhet_seq_no                         
                from   ola.v_serie_no
                where vrak_del='VRAK'
                and use is null
                order by serie_sort_no desc
            /

        --v_api_lov_felg_type           Felgtype
            create or replace view v_api_lov_felg_type as 
                -- http://www.dekkdimensjoner.no/?p=felginfo
                select
                     felg_bolt_sirkel||' innpress '||felg_innpress||', navnhull '||felg_navhull   as felg_type
                    ,felg_type_seq_no                                                            as felg_type_seq_no                         
                from   ola.felg_type
                order by felg_type
            /

        --v_api_lov_felg_bolt_sirkel
            create or replace view v_api_lov_felg_bolt_sirkel as
                select
                    felg_type_seq_no
                    ,felg_bolt_sirkel
                    ,felg_innpress
                    ,felg_navhull
                from ola.felg_type
                order by felg_bolt_sirkel
            /

        --v_api_lov_nbf_bilkod
            create or replace view v_api_lov_nbf_bilkod as 
                --create or replace view v_api_1test as 
                /*  https://api.qrv.no/obas/selvplukk_biler
                    */
                select distinct bilkod, upper(bilkodnamnnorge) bilkodnamnnorge 
                from   v_nbf_bilkod	
                where aktiv=1
                and bilkod is not null
                and bilkodnamnnorge is not null
                and upper(bilkodnamnnorge) not like '%AIXAM%'
                and upper(bilkodnamnnorge) not like '%ATV%'
                and upper(bilkodnamnnorge) not like '%BUSS%'
                and upper(bilkodnamnnorge) not like '%BUSS%'
                and upper(bilkodnamnnorge) not like '%CAMPING%'
                and upper(bilkodnamnnorge) not like '%MOPED%'
                and upper(bilkodnamnnorge) not like '%TRAKTOR%'
                and upper(bilkodnamnnorge) not like '%VRIG%' --øvrig
                order by upper(bilkodnamnnorge)
            /

            select bilkodnamnnorge, count(*) from v_api_lov_nbf_bilkod group by bilkodnamnnorge having count(*)>1;
            --9
            
                -------------------------------------------------- ----------
                MB SPRINTER 208-416 1995-07                                 2
                MB CL C215 500-600 2000-07                                  2
                MB G WAGEN W460 1978-93                                     2
                MB SLK R170 1997-04                                         2
                MB GLA H247 2020-                                           2
                MB A 169 140-190 2004-12                                    2
                MB B W177 2019-                                             2
                MB SL R232 2020-                                            2
                MB SL R129 300-600 1990-00                                  2            


        --v_api_lov_pris                Pris inkl MVA
            create or replace view v_api_lov_pris as 
                select  
                    to_char(pris)                                                   as pris
                    ,pris                                                           as pris_inkl_mva
                from   ola.c_tab_priser
                order by nvl(pris_inkl_mva,0)            
            /
            grant all on v_api_lov_pris to public;

        --v_api_lov_serie_no_del
            create or replace view v_api_lov_serie_no_del as 
                select
                     serie_no                                                       as serie_no
                    ,serie_seq_no                                                   as serie_seq_no
                from ola.v_serie_no
            /

        --v_api_lov_serie_no_del_nye    Delenummer
            create or replace view v_api_lov_serie_no_del_nye as 
                select
                     serie_no                                                       as serie_no
                    ,serie_seq_no                                                   as serie_seq_no                 
                from ola.v_serie_no
                where 1=1
                --rownum < 9999
                and vrak_del='DEL'
                and use is null
                and serie_seq_no > 104266
                order by serie_sort_no
            /

        --v_api_lov_serie_no_vrak
            create or replace view v_api_lov_serie_no_vrak as 
                select
                    serie_no||' '||to_char(enhet_dato_inn,'yyyy-mm-dd')             as serie_no
                    ,serie_seq_no                                                   as serie_seq_no
                from ola.v_serie_no
                where 1=1
                and vrak_del='VRAK'
                and use is not null
                order by enhet_dato_inn desc
            /

        --v_api_lov_serie_no_vrak_nye
            create or replace view v_api_lov_serie_no_vrak_nye as 
                select
                     serie_no                                                       as serie_no
                    ,serie_seq_no                                                   as serie_seq_no
                from   ola.v_serie_no
                where vrak_del='VRAK'
                and use is null
            /

        --v_api_lov_lokasjon            Lokasjon
            create or replace view v_api_lov_lokasjon as
                --create or replace view tt as 
                with loc as (    select
                                    case 
                                        when loc_id like '%HOLD%'    then   1
                                        else                                9
                                    end                                 as sort 
                                    ,loc_id                             as loc_id
                                    ,location_seq_no                    as location_seq_no
                                from   ola.location )
                    ,driver as (select 0                               as sort 
                                        ,'-slette del , presse vrak-'   as loc_id
                                        ,-7                             as location_seq_no
                                from dual
                                union
                                select sort, loc_id, location_seq_no from loc
                                order by sort,loc_id)
                select
                        loc_id
                        ,location_seq_no
                from driver
            /



        --v_api_lov_vare_gruppe         Varenavn
            create or replace view v_api_lov_vare_gruppe as 
                select
                     vare_gruppe_id                                                 as vare_gruppe_id
                    ,vare_gruppe_seq_no                                             as vare_gruppe_seq_no
                from   ola.v_vare_gruppe
                where nvl(dummy,'x') not in ('T','Y')
                order by vare_gruppe
            /


        --v_api_lov_vare_gruppe_n2      Varenavn nivå2
            create or replace view v_api_lov_vare_gruppe_n2 as 
                with n1 as (select vare_gruppe_seq_no,vare_gruppe_id 
                            from vare_gruppe
                            where nvl(dummy,'x') in ('Y')
                            and prev_vare_gruppe_seq_no is null )
                select
                     n1.vare_gruppe_id||'> '||n2.vare_gruppe_id                    as vare_gruppe_id
                    ,n2.vare_gruppe_seq_no                                         as vare_gruppe_seq_no
                from   ola.vare_gruppe n2
                       ,n1
                where 1=1
                and n2.prev_vare_gruppe_seq_no = n1.vare_gruppe_seq_no
                and nvl(n2.dummy,'x') in ('Y')
                and n2.prev_vare_gruppe_seq_no is not null
                order by n1.vare_gruppe_id||'> '||n2.vare_gruppe_id
            /
            grant all on v_api_lov_vare_gruppe_n2 to public;


        --v_api_lov_dekk_monster        Dekkmønster 1/2
            create or replace view v_api_lov_dekk_monster as 
                select 3 as antall,  3 as dekk_monster from dual union
                select 4 as antall,  4 as dekk_monster from dual union
                select 5 as antall,  5 as dekk_monster from dual union
                select 6 as antall,  6 as dekk_monster from dual union
                select 7 as antall,  7 as dekk_monster from dual union
                select 8 as antall,  8 as dekk_monster from dual 
            /

        --v_api_lov_dekk_antall         Antall (dekk)
            create or replace view v_api_lov_dekk_antall as 
                select 1 as antall,  1 as dekk_antall from dual union
                select 2 as antall,  2 as dekk_antall from dual union
                select 3 as antall,  3 as dekk_antall from dual union
                select 4 as antall,  4 as dekk_antall from dual union
                select 5 as antall,  5 as dekk_antall from dual union
                select 6 as antall,  6 as dekk_antall from dual union
                select 7 as antall,  7 as dekk_antall from dual union
                select 8 as antall,  8 as dekk_antall from dual 
            /

        --v_api_lov_dekk_aar            År 1/2 (dekk)
            create or replace view v_api_lov_dekk_aar as 
                select 2014 as aar,  2014 as dekk_aar from dual union
                select 2015 as aar,  2015 as dekk_aar from dual union
                select 2016 as aar,  2016 as dekk_aar from dual union
                select 2017 as aar,  2017 as dekk_aar from dual union
                select 2018 as aar,  2018 as dekk_aar from dual union
                select 2019 as aar,  2019 as dekk_aar from dual union
                select 2020 as aar,  2020 as dekk_aar from dual union
                select 2021 as aar,  2021 as dekk_aar from dual 
            /

        --v_api_blob
            create or replace view v_api_blob as 
                --uri  v_api_blob_{blobs_seq_no}
                --kall https://api.qrv.no/obas/v_api_blob_141078
                --kall https://api.qrv.no/obas/v_api_blob_621
                --sql  select content_type, image from ola.v_api_blob where blobs_seq_no = :blobs_seq_no
                select  blobs_seq_no                                    as blobs_seq_no
                        ,nvl(apex_app_files_mime_type, 'image/jpeg')    as content_type
                        ,blobs                                          as image
                from   blobs.blobs     blobs
            /

            grant select on v_api_blob to public;

            --test
                select blobs_seq_no, content_type from v_api_blob where blobs_seq_no in (141078,621);
                    621
                    141078  image/jpeg

        --v_api_blobs
            create or replace view v_api_blobs as 
                --uri  v_api_blobs_{blobs_seq_no}
                --kall https://api.qrv.no/obas/v_api_blobs_300167
                --kall https://api.qrv.no/obas/blobs_list_300167
                --sql  select content_type, image from ola.v_api_blob where blobs_seq_no = :blobs_seq_no
                select  blobs_seq_no                                    as blobs_seq_no
                        ,nvl(apex_app_files_mime_type, 'image/jpeg')    as content_type
                        ,blobs                                          as image
                from   blobs.blobs     blobs
            /

            grant select on v_api_blobs to public;

            --test
                select blobs_seq_no, content_type from v_api_blob where blobs_seq_no in (141078,621);
                    621
                    141078  image/jpeg


        --v_api_dekk
            create or replace view v_api_dekk as 
                --create or replace view v_api_1test as 
                /*  https://api.qrv.no/obas/selvplukk_biler
                    */
                    select 
                         enhet.enhet_seq_no                                                             as enhet_seq_no
                        ,enhet.prev_enhet_seq_no                                                        --  v_api_lov_enhet
                        ,v_serie_no.serie_no||' '||to_char(enhet.dato_inn,'yyyy-mm-dd')                 as serie_no_vrak
                        ,enhet.var_bil_seq_no                                                           --  v_api_lov_bil_obas
                        ,v_var_bil.obas                                                                 as bil_obas
                        ,enhet.serie_seq_no                                                             --  v_api_lov_serie_no_del_nye     
                        ,v_serie_no2.serie_no                                                           as serie_no_del   
                        ,to_char(enhet.dato_inn,'yyyy-mm-dd hh24:mi:ss')                                as dato_inn  
                        ,enhet.location_seq_no                                                          --  v_api_lov_lokasjon
                        ,location.loc_id                                                                as loc_id
                        ,enhet.vare_gruppe_seq_no                                                       --  v_api_lov_vare_gruppe    
                        ,v_vare_gruppe.vare_gruppe_id                                                   as vare_gruppe_id                                  
                        ,enhet.dekk_antall                                                              --  1-7
                        ,enhet.pris_inkl_mva                                                            --  v_api_lov_pris
                        ,enhet.prod_nr                                                                  --  visuelt delenummer
                        ,enhet.enhet_besk                                                               --  xxx                       
                        ,enhet.actor_seq_no                                                             --  v_api_lov_actor_id   
                        ,actor.actor_id_dekk                                                            as actor_id_dekk
                        ,enhet.dekk_type_seq_no                                                         --  v_api_lov_dekk_type 
                        ,decode(enhet.dekk_type_seq_no,null,null,
                            dekk_bredde||' '||dekk_hoyde||' '||dekk_dim  )                              as dekk_type
                        ,enhet.dekk_monster_dybde_1                                                     --  3-8
                        ,enhet.dekk_monster_dybde_2                                                     --  3-8
                        ,enhet.dekk_produsert_aar_1                                                     --  2014-2025
                        ,enhet.dekk_produsert_aar_2                                                     --  2014-2025   
                        ,enhet.dekk_load_index_1                                                        --  xxx         
                        ,enhet.dekk_load_index_2                                                        --  xxx                                
                        ,enhet.felg_type_seq_no                                                         --  v_api_felg_type 
                        ,decode(enhet.felg_type_seq_no ,null,null,
                            felg_bolt_sirkel||' innpress '||felg_innpress||', navnhull '||felg_navhull) as felg_type
                    from enhet 
                        ,v_serie_no
                        ,v_var_bil
                        ,v_serie_no    v_serie_no2
                        ,location
                        ,v_vare_gruppe
                        ,actor
                        ,dekk_type
                        ,felg_type
                    where 1=1 
                        -- and enhet.enhet_seq_no in (353478,353481,353484,353486)
                        -- dekkene                               "ant" 
                            --40061   DEKK HELÅR      dekk        2   4 
                            --40062   DEKK PIGG       dekk        2   4 
                            --40063   DEKK SOMMER     dekk        2   4 
                            --36590   FELG ALUMINIUM  felg        1     
                            --36591   FELG STÅL       felg        1     
                            --101059  FELGSETT ALU    felg        4     
                            --101060  FELGSETT STÅL   felg        4     
                            --101019  RESERVEHJUL     dekk+felg   1     
                            --100699  HJULSETT ALU    dekk+felg   4     
                            --100700  HJULSETT STÅL   dekk+felg   4                             
                        -- and enhet.vare_gruppe_seq_no in (40061,40062,40063,36590,36591,101019,101059,101060,100699,100700)
                        and f_dekk_felg(enhet.vare_gruppe_seq_no) ='DEKK_FELG'
                        and enhet.serie_seq_no is not null
                        and enhet.prev_enhet_seq_no     = v_serie_no.enhet_seq_no           (+)
                        and enhet.var_bil_seq_no        = v_var_bil.var_bil_seq_no          (+)
                        and enhet.serie_seq_no          = v_serie_no2.serie_seq_no          (+)
                        and enhet.location_seq_no       = location.location_seq_no          (+)
                        and enhet.vare_gruppe_seq_no    = v_vare_gruppe.vare_gruppe_seq_no  (+)
                        and enhet.actor_seq_no          = actor.actor_seq_no                (+)
                        and enhet.dekk_type_seq_no      = dekk_type.dekk_type_seq_no        (+)
                        and enhet.felg_type_seq_no      = felg_type.felg_type_seq_no        (+)
                    order by v_serie_no2.serie_sort_no                       
            / 


            select count(*) from v_api_dekk;
            --124

            --script  
                --alter table enhet disable all triggers;
                --delete from enhet where enhet_seq_no in (353490,353489,353486,353484,353481,353478);
                --alter table enhet enable all triggers;

            
        --v_api_plukke_deler            Plukke
            create or replace view v_api_plukke_deler as 
                --https://api.qrv.no/obas/plukke_deler
                --https://api.qrv.no/obas/plukke_deler/?355371
                --https://api.qrv.no/obas/plukke_deler/?352673  "Saab 9-3 V37500"
                --create or replace view tt as                   
                select
                    prev_enhet_seq_no  
                    ,vrak_nr
                    ,enhet_seq_no
                    ,dele_nr
                    ,vare_gruppe_nivaa_1
                    ,vare_gruppe_nivaa_2
                    ,vare_gruppe_nivaa_3
                    ,vare_gruppe_id
                    ,enhet_besk
                    ,temp
                    ,pris_inkl_mva
                    ,part_oem_main
                    ,bil_merke       
                    ,bil_modell      
                    ,bil_type        
                    ,bil_interval    
                    ,bil_aar 
                    ,prosess 
                    ,prosess_detaljer        
                from ola.t_enhet3 enhet
                --where prosess not in ('D2', 'D3', 'D4', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6')
                where prosess in ('D11')
                order by bil_merke, bil_modell,bil_aar,vare_gruppe_nivaa_1,vare_gruppe_nivaa_2,vare_gruppe_id
            /

            select count(*) from v_api_plukke_deler;
            --242
            --248   2020-12-19
            --241   2020-12-19 
            --149   2020-12-31

            --teste
                •	Liste vrak som har deler i plukkeliste, GET
                    https://api.qrv.no/obas/plukke_vrak

                •	Liste deler i plukkliste på vrak, GET
                    https://api.qrv.no/obas/plukke_deler/?352673

                •	Plukke deler fra vraket, POST
                    https://api.qrv.no/obas/plukke_deler
                    setvalues= {'prosess':'PLUKKE_HOLD','l_enhet_seq_no':'357891', 'l_enhet_besk':'linje enhet_besk','l_temp':'linje temp'}


        --v_api_plukke_vrak             Plukke
            create or replace view v_api_plukke_vrak as 
                --https://api.qrv.no/obas/plukke_vrak
                --create or replace viewtt as 
                with ant as (select prev_enhet_seq_no, count(*) ant from ola.t_enhet3 where prosess in ('D11') group by prev_enhet_seq_no )
                select distinct
                    enhet.prev_enhet_seq_no  as enhet_seq
                    ,vrak_nr
                    ,bil_merke       
                    ,bil_modell      
                    ,bil_type        
                    ,bil_interval    
                    ,bil_aar  
                    ,ant.ant    as ant   
                    ,prosess 
                    ,prosess_detaljer        
                from ola.t_enhet3 enhet
                    , ant 
                where prosess in ('D11')
                and enhet.prev_enhet_seq_no = ant.prev_enhet_seq_no
                order by bil_merke, bil_modell,bil_aar
            /

        --v_api_vrak_selvplukk_priser
            create or replace view v_api_vrak_selvplukk_priser as
                select * from bildeler.t_selvplukk order by 2,3,4
            /

        --v_api_vrak_selvplukk
            create or replace view v_api_vrak_selvplukk as 
                --create or replace view v_api_1test as 
                /*  https://api.qrv.no/obas/selvplukk_biler
                    */
                select  enhet.dele_nr||' '||
                        enhet.bil||' '||
                        f_utf('AA')||'r:'||enhet.aar_4||
                        decode(trim(enhet.motor        )  ,null,null,' Motor:'  ||upper(trim(enhet.motor) )                     )   ||
                        decode(trim(enhet.gir          )  ,null,null,' Gir:'    ||upper(trim(enhet.gir  ) )                     )   ||
                        decode(trim(enhet.s_deler_inne )  ,null,null,', '||enhet.s_deler_inne||' deler p'||f_utf('aa')||' lager')                   as bil
                        --NB NB må alltid returnere verdier i hver array eller så klikker det
                        ,'["'||                                                                                 
                            enhet.enhet_seq_no                                                                                      ||'" , "'||     --0
                            nvl(trim(enhet.dele_nr      ) ,null )                                                                   ||'" , "'||     --1
                            nvl(trim(enhet.bil_merke    ) ,null )                                                                   ||'" , "'||     --2  merke
                            nvl(trim(enhet.bil_modell   ) ,null )                                                                   ||'" , "'||     --3  modell
                            nvl(trim(enhet.bil_type     ) ,null )                                                                   ||'" , "'||     --4  type
                            nvl(trim(enhet.bil_interval ) ,null )                                                                   ||'" , "'||     --5  intervall
                            nvl(to_char(enhet.bil_aar   ) ,null )                                                                   ||'" , "'||     --6  aar
                            upper(nvl(trim(REGEXP_REPLACE(enhet.motor, '[^0-9A-Za-z ]', '')) ,null ) )                              ||'" , "'||     --7  motor      full av dritt må røske det vekk
                            upper(nvl(trim(enhet.gir          ) ,null )                              )                              ||'" , "'||     --8  gir
                            nvl(enhet.s_deler_inne        ,0    )                                                                   ||'" , "'||     --9  deler_inne
                            'https://api.qrv.no/obas/v_api_blob_'||blobs.blobs_seq_no                                               ||'" , "'||     --10 deler_inne_link
                            decode (
                                nvl(trunc(
                                    to_date(to_char(sysdate,'yyyy-mm-dd') ,'yyyy-mm-dd')-
                                    to_date(to_char(dato_inn,'yyyy-mm-dd'),'yyyy-mm-dd') ) ,0 ) 
                                ,0,null
                                ,1,'1 dag p'||f_utf('aa')||' lager'
                                ,trunc(
                                    to_date(to_char(sysdate,'yyyy-mm-dd') ,'yyyy-mm-dd')-
                                    to_date(to_char(dato_inn,'yyyy-mm-dd'),'yyyy-mm-dd') )||' dager p'||f_utf('aa')||' lager'  )    ||'" , "'||     --11 dager_inne
                            ' '||'" , "'|| --12
                            ' '||'" , "'|| --13
                            ' '||'" , "'|| --14
                            ' '||'" , "'|| --15
                            ' '||'" , "'|| --16
                            ' '||'" , "'|| --17
                            blobs.blobs_seq_no                                                       ||              --18 cart-image
                         '"]'                                                                                                                       as bil_array                                                            
                        ,enhet.bil_merke                                                                                                            as bil_merke        
                        ,enhet.bil_modell                                                                                                           as bil_modell            
                        ,enhet.bil_type                                                                                                             as bil_type                   
                        ,enhet.bil_interval                                                                                                         as bil_interval                 
                        ,enhet.bil_aar                                                                                                              as bil_aar  
                        ,blobs.blobs_seq_no                                                                                                         as image
                        ,'["'||blobes.blobs_seq_nos||'"]'                                                                                           as images
                        ,nvl(enhet.s_deler_inne,0)                                                                                                  as deler_inne
                        ,trunc(sysdate -dato_inn)                                                                                                   as dager_inne
                        ,trunc(
                                to_date(to_char(sysdate,'yyyy-mm-dd') ,'yyyy-mm-dd')-
                                to_date(to_char(dato_inn,'yyyy-mm-dd'),'yyyy-mm-dd') )                                                              as dato_inne
                from ola.t_enhet3 enhet
                     ,(select enhet_seq_no,  min(blobs_seq_no)                                                                      as blobs_seq_no  from enhet_blobs group by enhet_seq_no) blobs
                    --  ,(select enhet_seq_no, listagg(blobs_seq_no,',') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                     ,(select enhet_seq_no, listagg(blobs_seq_no,'","') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                    --  ,(select enhet_seq_no, listagg(blobs_seq_no,'"} , {blobs_seq_no:"') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                where prosess = 'V3'
                and enhet.enhet_seq_no = blobs.enhet_seq_no     (+)
                and enhet.enhet_seq_no = blobes.enhet_seq_no    (+)
                --and rownum <3
                order by bil_merke, bil_modell,bil_aar
            /

                2020-08-02
                    create or replace view v_api_1test as
                        select enhet_seq_no, listagg(blobs_seq_no,'"},"') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_no 
                        from enhet_blobs
                        --where rownum <8 
                        group by enhet_seq_no
                        order by enhet_seq_no
                    /


                2020-07
                V36730 VW TRANSPORTER / CARAVELLE MK IV BUSS (70XB, 70XC, 7DB, 7DW, 7D 2.4 D 1990.09 - 1998.04 
                År:1995 Motor:AAB 2,4l 78hk Gir: 5 trinn 26 deler på lager https://api.qrv.no/obas/blobs_list_single_1

                select count(*) from v_api_selvplukk_biler;

                json_value(:sok_uri, '$.prosess'               returning varchar2)
                    select (JSON_ARRAYAGG (JSON_VALUE( 'blobs_seq_no' ,   enhet_blobs.blobs_seq_no)  ) ) as tt
                            FROM   ola.enhet_blobs enhet_blobs
                    where rownum <3

                items: [
                    {
                    tt: "[{"blobs_seq_no":284089},{"blobs_seq_no":284090}]"
                    }
                ]

        --v_api_vrak_ex_selvplukk
            create or replace view v_api_vrak_ex_selvplukk as 
                --create or replace view v_api_1test as 
                /*  https://api.qrv.no/obas/deler
                    batch-3 test :  SC78431
                                    TV82737 SUBARU XV 2.0 D AWD 2.0 D AWD 2012 Lukket terrengbil EE20
                                    116065--F Dynamo
                    */
                with deler as (
                    select  enhet.dele_nr||' '||
                            enhet.bil||' '||
                            f_utf('AA')||'r:'||enhet.aar_4||
                            decode(trim(enhet.motor        )  ,null,null,' Motor:'  ||upper(trim(enhet.motor) )                     )   ||
                            decode(trim(enhet.gir          )  ,null,null,' Gir:'    ||upper(trim(enhet.gir  ) )                     )   ||
                            decode(trim(enhet.s_deler_inne )  ,null,null,', '||enhet.s_deler_inne||' deler p'||f_utf('aa')||' lager')                   as bil
                            --NB NB må alltid returnere verdier i hver array eller så klikker det
                            ,'["'||                                                                                 
                                enhet.enhet_seq_no                                                                                      ||'" , "'||     --0
                                nvl(trim(enhet.dele_nr      ) ,'p'||f_utf('aa')||' bil' ) ||
                                  ' '||loc_id||
                                  decode(enhet.pris_inkl_mva,null,null,' '||enhet.pris_inkl_mva||'kr')                                  ||'" , "'||     --1
                                nvl(trim(enhet.bil_merke    ) ,null )                                                                   ||'" , "'||     --2  merke
                                nvl(trim(enhet.bil_modell   ) ,null )                                                                   ||'" , "'||     --3  modell
                                nvl(trim(enhet.bil_type     ) ,null )                                                                   ||'" , "'||     --4  type
                                nvl(trim(enhet.bil_interval ) ,null )                                                                   ||'" , "'||     --5  intervall
                                nvl(to_char(enhet.bil_aar   ) ,null )                                                                   ||'" , "'||     --6  aar
                                upper(nvl(trim(REGEXP_REPLACE(enhet.motor, '[^0-9A-Za-z ]', '')) ,null ) )                              ||'" , "'||     --7  motor      full av dritt må røske det vekk
                                upper(nvl(trim(enhet.gir          ) ,null )                              )                              ||'" , "'||     --8  gir
                                nvl(enhet.s_deler_inne        ,0    )                                                                   ||'" , "'||     --9  deler_inne
                                blobs.blobs_seq_no                                                                                      ||'" , "'||     --10 deler_inne_link
                                enhet.vare_gruppe_id||' ('||enhet.enhet_seq_no||')'                                                     ||'" , "'||     --11 varegruppe
                                upper(nvl(trim(REGEXP_REPLACE(enhet.beskrivelse, '[^0-9A-Za-z ]', ' ')) ,null ) )                       ||'" , "'||     --12 beskrivelse    
                                part_nr_raw                                                                                             ||'" , "'||     --13 partnr
                                trim(rtrim(trim( --for å ta vekk siste ' , '
                                  REGEXP_REPLACE(
                                    trim(decode(replace(vrak_nr    ,' '),null,null,replace(vrak_nr    ,' ')) || decode(replace(vrak_nr    ,' ')  ,null,null,','))||                   
                                    trim(decode(replace(chassis_no ,' '),null,null,replace(chassis_no ,' ')) || decode(replace(chassis_no ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(reg_no     ,' '),null,null,replace(reg_no     ,' ')) || decode(replace(reg_no     ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(km         ,' '),null,null,replace(km||'km'   ,' ')) || decode(replace(km         ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(tecdoc_id  ,' '),null,null,replace(tecdoc_id  ,' ')) || decode(replace(tecdoc_id  ,' ')  ,null,null,','))                     
                                  ,'[^0-9A-Za-z]', ', ')
                                ),','))                                                                                                ||              --14 info_bil
                             '"]'                                                                                                                       as bil_array 
                            --  ,  vrak_nr ||' '||chassis_no||' '||reg_no||' '||tecdoc_id                                      as info_bil                
                            -- ,part_nr                   
                            -- ,part_oem_visual                     
                            -- ,part_oem_main                       
                            -- ,part_oem_secondary                  
                            -- ,part_eqv_main                       
                            -- ,part_eqv_secondary    
                            -- ,beskrivelse   
                            -- ,enhet.enhet_seq_no                                                                                                         as enhet_seq_no
                            -- ,enhet.dele_nr                                                                                                              as dele_nr                                                          
                            -- ,enhet.paa_bil                                                                                                              as paa_bil                                                          
                            -- ,enhet.bil_merke                                                                                                            as bil_merke     
                               ,part_nr                                                                                                                    as part_nr
                               ,tecdoc_ids                                                                                                                 as fab_nr
                            ,case when nvl(upper(substr(bil_merke,1,1)),'-') in ('A','B','C','D','E','F','G','H','I','J','K','L') then 'batch-1'
                                  when nvl(upper(substr(bil_merke,1,1)),'-') in ('M','N','O','P','Q','R'                        ) then 'batch-2'
                                  else                                                                                                 'batch-3'          
                             end                                                                                                                        as batch
                            -- ,enhet.bil_interval                                                                                                         as bil_interval                 
                            -- ,enhet.bil_aar                                                                                                              as bil_aar  
                            ,nvl(blobs.blobs_seq_no, blobs_prev.blobs_seq_no )                                                                          as image
                            ,'["'||
                                decode(blobes.blobs_seq_nos     ,null,null,       blobes.blobs_seq_nos            ) 
                                ||
                                case when blobes.blobs_seq_nos is     null and blobes_prev.blobs_seq_nos is not null then ''
                                     when blobes.blobs_seq_nos is not null and blobes_prev.blobs_seq_nos is not null then '","'
                                     else                                                                                 ''
                                end 
                                ||
                                decode(blobes_prev.blobs_seq_nos,null,null,       blobes_prev.blobs_seq_nos       ) ||
                            '"]'                                                                                                                        as images
                            ,nvl(enhet.s_deler_inne,0)                                                                                                  as deler_inne
                            ,trunc(sysdate -dato_inn)                                                                                                   as dager_inne
                            ,trunc(
                                    to_date(to_char(sysdate,'yyyy-mm-dd') ,'yyyy-mm-dd')-
                                    to_date(to_char(dato_inn,'yyyy-mm-dd'),'yyyy-mm-dd') )                                                              as dato_inne
                    from ola.t_enhet3 enhet
                         ,(select enhet_seq_no,  min(blobs_seq_no)                                                                      as blobs_seq_no  from enhet_blobs group by enhet_seq_no) blobs
                         ,(select enhet_seq_no,  min(blobs_seq_no)                                                                      as blobs_seq_no  from enhet_blobs group by enhet_seq_no) blobs_prev
                        --  ,(select enhet_seq_no, listagg(blobs_seq_no,',') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                         ,(select enhet_seq_no, listagg(blobs_seq_no,'","') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                         ,(select enhet_seq_no, listagg(blobs_seq_no,'","') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes_prev
                        --  ,(select enhet_seq_no, listagg(blobs_seq_no,'"} , {blobs_seq_no:"') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                    where prosess in ('V2','V4')   --Vrak motatt (av Tommy) og Vrak i sirkulasjon inne, ute etc
                    and enhet.enhet_seq_no      = blobs.enhet_seq_no        (+)
                    and enhet.prev_enhet_seq_no = blobs_prev.enhet_seq_no   (+)
                    and enhet.enhet_seq_no      = blobes.enhet_seq_no       (+)
                    and enhet.prev_enhet_seq_no = blobes_prev.enhet_seq_no  (+)
                    order by bil_merke, bil_modell, vare_gruppe_id
                ) 
                select * from deler
                where 1=1
            /


        --v_api_biler_n4_merker_modeller_varegrupper_deler Router / SSR     select * from ola.v_api_biler_n4_merker_modeller_varegrupper_deler  where 1=1 and  lager_status like decode(lower(:lager_status_x10),'x','%DELER/VRAK%','1','DELER/VRAK-FINNES','0','ALLE-DELER/VRAK-AVHENDET','%DELER/VRAK%') and upper(bil_merke_v) like decode(upper(:merke_v),null,'%',upper(:merke_v)) and upper(bil_modell_v) like decode(upper(:modell_v),null,'%',upper(:modell_v)) and upper(varegruppe_v) like decode(upper(:varegruppe_v),null,'%',upper(:varegruppe_v)) and upper(dele_nr) like decode(upper(:dele_nr),null,'%',upper(:dele_nr)) 
            create or replace view v_api_biler_n4_merker_modeller_varegrupper_deler as
                --test
                    --https://api.qrv.no/obas/v_api_biler_n3_merker_modeller_varegrupper_deler?lager_status_x10=1&merke_v=saab
                    --https://api.qrv.no/obas/v_api_biler_n3_merker_modeller_varegrupper_deler?lager_status_x10=1&merke_v=bmw&modell_v=I3-I01&varegruppe_v=ABS-ENHET               
                with full_n3 as (              
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_scope
                                ,to_number(type_seq_no||var_bil_scope_seq_no)   as type_var_bil_scope_seq_no
                                ,bil_interval_obas                              as bil_scope
                                ,vasket_scope                                   as bil_scope_v
                            --n3
                                ,vare_gruppe_id                                 as varegruppe
                                ,vasket_del                                     as varegruppe_v
                                ,vare_gruppe_nivaa_1
                                ,vare_gruppe_nivaa_2
                            --n3 pris
                                ,max(pris_inkl_mva)                             as pris_inkl_mva
                            --n3 antall
                                ,sum(case when prosess like 'D%' or prosess like 'V%' then decode(prosess,'D99', 0, 'V99', 0, 1) else 0 end )         as n3_new  --EDx, EVx, EFx tas vekk
                                ,sum(case when prosess like 'D%' or prosess like 'V%' then decode(prosess,'D99', 1, 'V99', 1, 0) else 0 end )         as n3_old --EDx, EVx, EFx tas vekk
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas, vasket_modell, type_seq_no||var_bil_scope_seq_no ,bil_interval_obas, vasket_scope, vare_gruppe_id , vasket_del, vare_gruppe_nivaa_1, vare_gruppe_nivaa_2
                        --order by                          vasket_merke,                  vasket_modell,                                                       vasket_scope,                              vare_gruppe_nivaa_1, vare_gruppe_nivaa_2, vasket_del
                    )
                ,full_n2_scope as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_scope
                                ,to_number(type_seq_no||var_bil_scope_seq_no)   as type_var_bil_scope_seq_no
                                ,bil_interval_obas                              as bil_scope
                                ,vasket_scope                                   as bil_scope_v
                            --n2_scope antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_scope_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_scope_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_scope_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_scope_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell, type_seq_no||var_bil_scope_seq_no,  bil_interval_obas, vasket_scope
                        --order by                          vasket_merke,                 vasket_modell,                                                        vasket_scope
                    )               
                ,full_n2 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell
                        --order by                          vasket_merke,                 vasket_modell
                    )               
                ,full_n1 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n1_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n1_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n1_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n1_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n1_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke
                        --order by                          vasket_merke
                    )               
                select 
                     full_n1.fab_seq_no 
                    ,full_n1.bil_merke
                    ,full_n1.bil_merke_v
                    ,full_n2.bil_modell
                    ,full_n2.bil_modell_v
                    ,full_n2_scope.type_var_bil_scope_seq_no
                    ,full_n2_scope.bil_scope
                    ,full_n2_scope.bil_scope_v
                    --n3 detaljer
                        ,full_n3.varegruppe
                        ,full_n3.varegruppe_v
                        ,upper(full_n3.vare_gruppe_nivaa_1)     as vare_gruppe_nivaa_1
                        ,upper(full_n3.vare_gruppe_nivaa_2)     as vare_gruppe_nivaa_2
                        --n2 repting values (ikke skop)
                            --Suppressing repeating values in SQL
                            --https://oradbdev.mathiasmagnusson.com/2011/10/11/suppressing-repeating-values-in-sql/
                            --http://kuzminpro.blogspot.com/2012/10/how-to-suppress-output-of-duplicate.html
                            --case facility  	when   lag(facility) 		over (partition by doc_ref  order by doc_ref,f_tag_no,f_circ_sort_nulls_first,f_circ_sort_next,f_circ_sort_last,f_tb,t_tag_no)	then null else doc_ref 		end 	doc_ref,
                            ,decode(lag(full_n3.vare_gruppe_nivaa_1) over (order by full_n1.bil_merke_v,full_n2.bil_modell_v, full_n3.vare_gruppe_nivaa_1,full_n3.vare_gruppe_nivaa_2, full_n3.varegruppe_v), full_n3.vare_gruppe_nivaa_1, null,upper(full_n3.vare_gruppe_nivaa_1) ) 
                                                                    as vare_gruppe_nivaa_1_rep
                            ,upper(full_n3.vare_gruppe_nivaa_2)     as vare_gruppe_nivaa_2_rep
                    --n4
                        ,full_n4.dele_nr
                        ,full_n4.loc_id
                        ,full_n4.enhet_besk
                        ,full_n4.pris_inkl_mva
                    --antall
                        ,decode(n3_new, 0,'ALLE-DELER/VRAK-AVHENDET','DELER/VRAK-FINNES') as lager_status
                        ,n1_new_deler
                        ,n1_old_deler
                        ,n1_new_biler
                        ,n1_old_biler 
                            ,n2_new_deler
                            ,n2_old_deler
                            ,n2_new_biler
                            ,n2_old_biler 
                                ,n2_scope_new_deler
                                ,n2_scope_old_deler
                                ,n2_scope_new_biler
                                ,n2_scope_old_biler 
                                    ,n3_new
                                    ,n3_old
                    -------------------- 
                        ,full_n1.bil_merke      as id           
                        ,full_n1.bil_merke_v    as url  
                        ,null                   as description
                        ,null                   as longdescription     
                        ,full_n1.fab_seq_no     as seqno     
                        ,null                   as iconurl     
                        ,null                   as price     
                        ,null                   as uploadedImageurl     
                        ,null                   as courselisticon     
                        ,null                   as category     
                        ,null                   as lessonscount    
                from  full_n1,
                      full_n2, 
                      full_n2_scope,
                      full_n3, 
                      t_enhet3 full_n4
                where 1=1
                    --n1
                        and  full_n1.fab_seq_no                             = full_n3.fab_seq_no
                    --n2
                        and  full_n2.fab_seq_no                             = full_n3.fab_seq_no
                        and  full_n2.bil_modell_v                           = full_n3.bil_modell_v
                    --n2_scope
                        and  full_n2_scope.fab_seq_no                       = full_n3.fab_seq_no
                        and  full_n2_scope.type_var_bil_scope_seq_no        = full_n3.type_var_bil_scope_seq_no
                    --n3
                        and  full_n3.fab_seq_no                             = full_n4.fab_seq_no
                        and  full_n3.type_var_bil_scope_seq_no              = to_number(full_n4.type_seq_no||full_n4.var_bil_scope_seq_no)
                        and  full_n3.varegruppe                             = full_n4.vare_gruppe_id
                order by full_n1.bil_merke_v, full_n2.bil_modell_v, full_n2_scope.bil_scope_v, full_n3.vare_gruppe_nivaa_1, full_n3.vare_gruppe_nivaa_2, full_n3.varegruppe_v, full_n4.dele_nr
            /

                select count(*) from v_api_biler_n4_merker_modeller_varegrupper_deler;
                    166264   --2021-01-26



        --v_api_biler_n3_merker_modeller_varegrupper       Router / SSR     select * from ola.v_api_biler_n3_merker_modeller_varegrupper        where 1=1 and  lager_status like decode(lower(:lager_status_x10),'x','%DELER/VRAK%','1','DELER/VRAK-FINNES','0','ALLE-DELER/VRAK-AVHENDET','%DELER/VRAK%') and upper(bil_merke_v) like decode(upper(:merke_v),null,'%',upper(:merke_v)) and upper(bil_modell_v) like decode(upper(:modell_v),null,'%',upper(:modell_v)) and upper(varegruppe_v) like decode(upper(:varegruppe_v),null,'%',upper(:varegruppe_v)) 
            create or replace view v_api_biler_n3_merker_modeller_varegrupper as
                --test
                    --https://api.qrv.no/obas/v_api_biler_n3_merker_modeller_varegrupper?lager_status_x10=1&merke_v=saab
                    --https://api.qrv.no/obas/v_api_biler_n3_merker_modeller_varegrupper?lager_status_x10=1&merke_v=bmw&modell_v=I3-I01&varegruppe_v=ABS-ENHET               
                with full_n3 as (              
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_scope
                                ,to_number(type_seq_no||var_bil_scope_seq_no)   as type_var_bil_scope_seq_no
                                ,bil_interval_obas                              as bil_scope
                                ,vasket_scope                                   as bil_scope_v
                            --n3
                                ,vare_gruppe_id                                 as varegruppe
                                ,vasket_del                                     as varegruppe_v
                                ,vare_gruppe_nivaa_1
                                ,vare_gruppe_nivaa_2
                            --n3 pris
                                ,max(pris_inkl_mva)                             as pris_inkl_mva
                            --n3 antall
                                ,sum(case when prosess like 'D%' or prosess like 'V%' then decode(prosess,'D99', 0, 'V99', 0, 1) else 0 end )         as n3_new  --EDx, EVx, EFx tas vekk
                                ,sum(case when prosess like 'D%' or prosess like 'V%' then decode(prosess,'D99', 1, 'V99', 1, 0) else 0 end )         as n3_old --EDx, EVx, EFx tas vekk
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas, vasket_modell, type_seq_no||var_bil_scope_seq_no ,bil_interval_obas, vasket_scope, vare_gruppe_id , vasket_del, vare_gruppe_nivaa_1, vare_gruppe_nivaa_2
                        --order by                          vasket_merke,                  vasket_modell,                                                       vasket_scope,                              vare_gruppe_nivaa_1, vare_gruppe_nivaa_2, vasket_del
                    )
                ,full_n2_scope as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_scope
                                ,to_number(type_seq_no||var_bil_scope_seq_no)   as type_var_bil_scope_seq_no
                                ,bil_interval_obas                              as bil_scope
                                ,vasket_scope                                   as bil_scope_v
                            --n2_scope antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_scope_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_scope_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_scope_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_scope_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell, type_seq_no||var_bil_scope_seq_no,  bil_interval_obas, vasket_scope
                        --order by                          vasket_merke,                 vasket_modell,                                                        vasket_scope
                    )               
                ,full_n2 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell
                        --order by                          vasket_merke,                 vasket_modell
                    )               
                ,full_n1 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n1_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n1_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n1_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n1_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n1_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke
                        --order by                          vasket_merke
                    )               
                select 
                     full_n1.fab_seq_no 
                    ,full_n1.bil_merke
                    ,full_n1.bil_merke_v
                    ,full_n2.bil_modell
                    ,full_n2.bil_modell_v
                    ,full_n2_scope.type_var_bil_scope_seq_no
                    ,full_n2_scope.bil_scope
                    ,full_n2_scope.bil_scope_v
                    --n3 detaljer
                        ,varegruppe
                        ,varegruppe_v
                        ,upper(vare_gruppe_nivaa_1)     as vare_gruppe_nivaa_1
                        ,upper(vare_gruppe_nivaa_2)     as vare_gruppe_nivaa_2
                        --n2 repting values (ikke skop)
                            --Suppressing repeating values in SQL
                            --https://oradbdev.mathiasmagnusson.com/2011/10/11/suppressing-repeating-values-in-sql/
                            --http://kuzminpro.blogspot.com/2012/10/how-to-suppress-output-of-duplicate.html
                            --case facility  	when   lag(facility) 		over (partition by doc_ref  order by doc_ref,f_tag_no,f_circ_sort_nulls_first,f_circ_sort_next,f_circ_sort_last,f_tb,t_tag_no)	then null else doc_ref 		end 	doc_ref,
                            ,decode(lag(vare_gruppe_nivaa_1) over (order by full_n1.bil_merke_v,full_n2.bil_modell_v, vare_gruppe_nivaa_1,vare_gruppe_nivaa_2, varegruppe_v), vare_gruppe_nivaa_1, null,upper(vare_gruppe_nivaa_1) ) 
                                                        as vare_gruppe_nivaa_1_rep
                            ,upper(vare_gruppe_nivaa_2)     as vare_gruppe_nivaa_2_rep
                    --antall
                        ,decode(n3_new, 0,'ALLE-DELER/VRAK-AVHENDET','DELER/VRAK-FINNES') as lager_status
                        ,n1_new_deler
                        ,n1_old_deler
                        ,n1_new_biler
                        ,n1_old_biler 
                            ,n2_new_deler
                            ,n2_old_deler
                            ,n2_new_biler
                            ,n2_old_biler 
                                ,n2_scope_new_deler
                                ,n2_scope_old_deler
                                ,n2_scope_new_biler
                                ,n2_scope_old_biler 
                                    ,n3_new
                                    ,n3_old
                    -------------------- 
                        ,full_n1.bil_merke      as id           
                        ,full_n1.bil_merke_v    as url  
                        ,null                   as description
                        ,null                   as longdescription     
                        ,full_n1.fab_seq_no     as seqno     
                        ,null                   as iconurl     
                        ,null                   as price     
                        ,null                   as uploadedImageurl     
                        ,null                   as courselisticon     
                        ,null                   as category     
                        ,null                   as lessonscount    
                from  full_n1,
                      full_n2, 
                      full_n2_scope,
                      full_n3 
                where 1=1
                    --n1
                        and  full_n1.fab_seq_no                             = full_n3.fab_seq_no
                    --n2
                        and  full_n2.fab_seq_no                             = full_n3.fab_seq_no
                        and  full_n2.bil_modell_v                           = full_n3.bil_modell_v
                    --n2_scope
                        and  full_n2_scope.fab_seq_no                       = full_n3.fab_seq_no
                        and  full_n2_scope.type_var_bil_scope_seq_no        = full_n3.type_var_bil_scope_seq_no
                order by full_n1.bil_merke_v, full_n2.bil_modell_v, full_n2_scope.bil_scope_v, vare_gruppe_nivaa_1,vare_gruppe_nivaa_2, varegruppe_v
            /

                select count(*) from v_api_biler_n3_merker_modeller_varegrupper;
                    54252   --2020-12-13
                    16196   --2020-12-13 kunn xxx_inne
                    54371   --inne og ute
                    54630   --2020-12-31
                    54975   --2021-01-25
                    54976   --2021-01-26

        --v_api_biler_n2_merker_modeller                   Router / SSR     select * from ola.v_api_biler_n2_merker_modeller                    where 1=1 and  lager_status like decode(lower(:lager_status_x10),'x','%DELER/VRAK%','1','DELER/VRAK-FINNES','0','ALLE-DELER/VRAK-AVHENDET','%DELER/VRAK%') and upper(bil_merke_v) like decode(upper(:merke_v),null,'%',upper(:merke_v)) and upper(bil_modell_v) like decode(upper(:modell_v),null,'%',upper(:modell_v)) 
            --test
                    --https://api.qrv.no/obas/v_api_biler_n2_merker_modeller?merke_v=alfa-romeo&lager_status_x10=1&modell_v=BRERA-939 
                    --https://api.qrv.no/obas/v_api_biler_n2_merker_modeller?modell_v=9-3&lager_status_x10=0
            create or replace view v_api_biler_n2_merker_modeller as
                with full_n2_scope as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_scope
                                ,to_number(type_seq_no||var_bil_scope_seq_no)   as type_var_bil_scope_seq_no
                                ,bil_interval_obas                              as bil_scope
                                ,vasket_scope                                   as bil_scope_v
                            --n2_scope antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_scope_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_scope_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_scope_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_scope_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell, type_seq_no||var_bil_scope_seq_no,  bil_interval_obas, vasket_scope
                        --order by                          vasket_merke,                 vasket_modell,                                                        vasket_scope
                    )               
                ,full_n2 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n2
                                ,bil_modell_obas                                as bil_modell
                                ,vasket_modell                                  as bil_modell_v
                            --n2_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n2_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n2_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n2_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n2_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke, bil_modell_obas,vasket_modell
                        --order by                          vasket_merke,                 vasket_modell
                    )               
                ,full_n1 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n1_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n1_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n1_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n1_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n1_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke
                        --order by                          vasket_merke
                    )               
                select 
                     full_n1.fab_seq_no 
                    ,full_n1.bil_merke
                    ,full_n1.bil_merke_v
                    ,full_n2.bil_modell
                    ,full_n2.bil_modell_v
                    ,full_n2_scope.type_var_bil_scope_seq_no
                    ,full_n2_scope.bil_scope
                    ,full_n2_scope.bil_scope_v
                    --antall
                        ,decode(n2_scope_new_deler + n2_scope_new_biler, 0,'ALLE-DELER/VRAK-AVHENDET','DELER/VRAK-FINNES') as lager_status
                        ,n1_new_deler
                        ,n1_old_deler
                        ,n1_new_biler
                        ,n1_old_biler 
                            ,n2_new_deler
                            ,n2_old_deler
                            ,n2_new_biler
                            ,n2_old_biler 
                                ,n2_scope_new_deler
                                ,n2_scope_old_deler
                                ,n2_scope_new_biler
                                ,n2_scope_old_biler 
                    -------------------- 
                        ,full_n1.bil_merke      as id           
                        ,full_n1.bil_merke_v    as url  
                        ,null                   as description
                        ,null                   as longdescription     
                        ,full_n1.fab_seq_no     as seqno     
                        ,null                   as iconurl     
                        ,null                   as price     
                        ,null                   as uploadedImageurl     
                        ,null                   as courselisticon     
                        ,null                   as category     
                        ,null                   as lessonscount    
                from  full_n1,
                      full_n2, 
                      full_n2_scope
                where 1=1
                    --n1
                        and  full_n1.fab_seq_no                             = full_n2_scope.fab_seq_no
                    --n2
                        and  full_n2.fab_seq_no                             = full_n2_scope.fab_seq_no
                        and  full_n2.bil_modell_v                           = full_n2_scope.bil_modell_v
                --trizx KIA [SPORTAGE HE 2004-2010, SPORTAGE J100 1993-2004] sorteres rett
                order by full_n1.bil_merke_v, substr(full_n2_scope.bil_modell_v,1,3), bil_scope_v
            /

                select count(*) from v_api_biler_n2_merker_modeller;
                    1499  2020-12-03
                    1503  2020-12-12  
                    1503  2020-12-13  tatt vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                    1505  2020-12-25
                    1506  2020-01-01

                select bil_merke_v, bil_modell_v, bil_scope_v, count(*) from v_api_biler_n2_merker_modeller group by bil_merke_v, bil_modell_v, bil_scope_v having count(*)>1;
                    0   2021-01-01

                select bil_merke_v, bil_modell_v, count(*) from v_api_biler_n2_merker_modeller group by bil_merke_v, bil_modell_v having count(*)>1 order by 1,2;
                    141 2021-01-01

        --v_api_biler_n1_merker                            Router / SSR     select * from ola.v_api_biler_n1_merker                             where 1=1 and  lager_status like decode(lower(:lager_status_x10),'x','%DELER/VRAK%','1','DELER/VRAK-FINNES','0','ALLE-DELER/VRAK-AVHENDET','%DELER/VRAK%') and upper(bil_merke_v) like decode(upper(:merke_v),null,'%',upper(:merke_v)) 
            --test                    
                    "x=alt, 1 inn, 0 ute"   --https://api.qrv.no/obas/v_api_biler_n1_merker?lager_status_x10=1                          --> alle
                    "x=alt, 1 inn, 0 ute"   --https://api.qrv.no/obas/v_api_biler_n1_merker?lager_status_x10=1&merke_v=GMC              -->ingen treff
                    "x=alt, 1 inn, 0 ute"   --https://api.qrv.no/obas/v_api_biler_n1_merker?lager_status_x10=x&merke_v=GMC&xyz=123      -->GMC
            create or replace view v_api_biler_n1_merker as
                with full_n1 as (
                        select
                            --n1
                                 to_number(fab_seq_no)                          as fab_seq_no 
                                ,bil_merke_obas                                 as bil_merke
                                ,vasket_merke                                   as bil_merke_v
                            --n1_antall
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 0, 1) else 0 end )         as n1_new_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 0, 1) else 0 end )         as n1_new_biler
                                ,sum(case when prosess like 'D%' then decode(prosess,'D99', 1, 0) else 0 end )         as n1_old_deler
                                ,sum(case when prosess like 'V%' then decode(prosess,'V99', 1, 0) else 0 end )         as n1_old_biler
                        from t_enhet3
                        --tar vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no
                        where var_bil_seq_no is not null
                        group by fab_seq_no, bil_merke_obas,vasket_merke
                        --order by                          vasket_merke
                    )               
                select 
                     full_n1.fab_seq_no 
                    ,full_n1.bil_merke
                    ,full_n1.bil_merke_v
                    --antall
                        ,decode(n1_new_deler + n1_new_biler, 0,'ALLE-DELER/VRAK-AVHENDET','DELER/VRAK-FINNES') as lager_status
                        ,n1_new_deler
                        ,n1_old_deler
                        ,n1_new_biler
                        ,n1_old_biler 
                    -------------------- 
                        ,full_n1.bil_merke      as id           
                        ,full_n1.bil_merke_v    as url  
                        ,null                   as description
                        ,null                   as longdescription     
                        ,full_n1.fab_seq_no     as seqno     
                        ,null                   as iconurl     
                        ,null                   as price     
                        ,null                   as uploadedImageurl     
                        ,null                   as courselisticon     
                        ,null                   as category     
                        ,null                   as lessonscount                          
                from  full_n1
                where 1=1
                order by full_n1.bil_merke_v
            /

                select count(*) from v_api_biler_n1_merker;
                    75
                    76  2020-12-03
                    77  2020-12-12
                    77  2020-12-12    tatt vekk dekk,hold,radio,annet phø, vrak uten var_bil_seq_no

                select bil_merke_v, count(*) from v_api_biler_n1_merker group by bil_merke_v having count(*)>1;
                    0

        --v_api_deler
            create or replace view v_api_deler as 
                --create or replace view v_api_1test as 
                /*  https://api.qrv.no/obas/deler
                    https://raw.githubusercontent.com/qrv/bildeler-json/master/deler.json
                    batch-3 test :  SC78431
                                    TV82737 SUBARU XV 2.0 D AWD 2.0 D AWD 2012 Lukket terrengbil EE20
                                    116065--F Dynamo
                    */
                with deler as (
                    select  enhet.dele_nr||' '||
                            enhet.bil||' '||
                            f_utf('AA')||'r:'||enhet.aar_4||
                            decode(trim(enhet.motor        )  ,null,null,' Motor:'  ||upper(trim(enhet.motor) )                     )   ||
                            decode(trim(enhet.gir          )  ,null,null,' Gir:'    ||upper(trim(enhet.gir  ) )                     )   ||
                            decode(trim(enhet.s_deler_inne )  ,null,null,', '||enhet.s_deler_inne||' deler p'||f_utf('aa')||' lager')                   as bil
                            --NB NB må alltid returnere verdier i hver array eller så klikker det
                            ,'["'||                                                                                 
                                enhet.enhet_seq_no                                                                                      ||'" , "'||     --0
                                nvl(trim(enhet.dele_nr      ) ,'p'||f_utf('aa')||' bil' ) ||
                                  ' '||loc_id||
                                  decode(enhet.pris_inkl_mva,null,null,' '||enhet.pris_inkl_mva||'kr')                                  ||'" , "'||     --1
                                nvl(trim(enhet.bil_merke    ) ,null )                                                                   ||'" , "'||     --2  merke
                                nvl(trim(enhet.bil_modell   ) ,null )                                                                   ||'" , "'||     --3  modell
                                nvl(trim(enhet.bil_type     ) ,null )                                                                   ||'" , "'||     --4  type
                                nvl(trim(enhet.bil_interval ) ,null )                                                                   ||'" , "'||     --5  intervall
                                nvl(to_char(enhet.bil_aar   ) ,null )                                                                   ||'" , "'||     --6  aar
                                upper(nvl(trim(REGEXP_REPLACE(enhet.motor, '[^0-9A-Za-z ]', '')) ,null ) )                              ||'" , "'||     --7  motor      full av dritt må røske det vekk
                                upper(nvl(trim(enhet.gir          ) ,null )                              )                              ||'" , "'||     --8  gir
                                nvl(enhet.s_deler_inne        ,0    )                                                                   ||'" , "'||     --9  deler_inne
                                blobs.blobs_seq_no                                                                                      ||'" , "'||     --10 deler_inne_link
                                enhet.vare_gruppe_id                                                                                    ||'" , "'||     --11 varegruppe
                                --speziL DEKK
                                    decode(dekk_type_seq_no,    null,null,  dekk_bredde||'/'||dekk_hoyde||'-'||dekk_dim                 )||
                                    decode(dekk_monster_dybde_1,null,null,' m'||f_utf('oe')||'nsterdybde '||dekk_monster_dybde_1||'mm'  )||
                                    decode(dekk_load_index_1,   null,null,' lasteindex '||dekk_load_index_1                             )||
                                    decode(dekk_antall,         null,null,' '||dekk_antall||'stk'                                       )||
                                    decode(dekk_produsert_aar_1,null,null,' produsert '||dekk_produsert_aar_1                           )||
                                    decode(actor_id_dekk,       null,null,' '||actor_id_dekk                                            )||
                                    decode(felg_bolt_sirkel,    null,null,' boltsirkel '||felg_bolt_sirkel||'mm'                        )||
                                    decode(felg_innpress,       null,null,' inpress '||felg_innpress||'mm'                              )||
                                    decode(felg_navhull,        null,null,' navnhull '||felg_navhull                                    )||
                                --gode gamle
                                    decode(dekk_felg,null,upper(nvl(trim(REGEXP_REPLACE(enhet.beskrivelse,'[^0-9A-Za-z ]', ' ')),null)))||'" , "'||     --12 beskrivelse    
                                part_nr                                                                                                 ||'" , "'||     --13 partnr
                                trim(rtrim(trim( --for å ta vekk siste ' , '
                                  REGEXP_REPLACE(
                                    trim(decode(replace(vrak_nr    ,' '),null,null,replace(vrak_nr          ,' ')) || decode(replace(vrak_nr    ,' ')  ,null,null,','))||                   
                                    trim(decode(replace(chassis_no ,' '),null,null,replace(chassis_no       ,' ')) || decode(replace(chassis_no ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(reg_no     ,' '),null,null,replace(reg_no           ,' ')) || decode(replace(reg_no     ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(km         ,' '),null,null,replace(km||'km'         ,' ')) || decode(replace(km         ,' ')  ,null,null,','))||                     
                                    trim(decode(replace(tecdoc_id  ,' '),null,null,replace('fab'||tecdoc_id ,' ')) || decode(replace(tecdoc_id  ,' ')  ,null,null,','))                     
                                  ,'[^0-9A-Za-z]', ', ')
                                ),','))                                                                                                 ||'" , "'||     --14 info_bil
                                nvl(trim(enhet.dele_nr      ) ,'p'||f_utf('aa')||' bil' )                                               ||'" , "'||     --15 cart-delenr
                                loc_id                                                                                                  ||'" , "'||     --16 cart-locid
                                enhet.pris_inkl_mva                                                                                     ||'" , "'||     --17 cart-pris
                                nvl(blobs.blobs_seq_no, blobs_prev.blobs_seq_no )                                                       ||              --18 cart-image
                             '"]'                                                                                                                       as bil_array 
                             --------------------------------------------------
                                ,'$'||enhet.prosess                                                                                                     as prosess
                               ,part_nr_raw                                                                                                             as raw_part_nr   --kun tall, bokstaver og komma1
                               ,tecdoc_ids                                                                                                              as fab_nr        --$1234567890--F
                               ,'$'||lbknr_bil||'--K'                                                                                                   as bilkod        --$011701--K
                               ,'$'||bil_merke_obas||'--M'                                                                                              as merke         --$BMW--M
                               ,nvl(trim(enhet.bil_modell_obas),null )                                                                                  as bil_modell_obas
                               --Radio buttons selvplukk, dekk_felg
                                    --1)    prosess V3 eller V_SELVPLUKK og V_UTE_SELVPLUKK
                                    --      select count(*) from t_enhet3 where loc_id like '%_SELVPLUKK%' 111 
                                    --      tas fra loc_id over
                                    --2)    dekk og felg fra 
                                    ,dekk_felg
                            ,case when nvl(upper(substr(bil_merke,1,1)),'-') in ('A','B','C','D','E','F','G','H','I','J','K','L') then 'batch-1'
                                  when nvl(upper(substr(bil_merke,1,1)),'-') in ('M','N','O','P','Q','R'                        ) then 'batch-2'
                                  else                                                                                                 'batch-3'          
                             end                                                                                                                        as batch
                            -- ,enhet.bil_interval                                                                                                         as bil_interval                 
                            -- ,enhet.bil_aar                                                                                                              as bil_aar  
                            ,nvl(blobs.blobs_seq_no, blobs_prev.blobs_seq_no )                                                                          as image
                            ,'["'||
                                decode(blobes.blobs_seq_nos     ,null,null,       blobes.blobs_seq_nos            ) 
                                ||
                                case when blobes.blobs_seq_nos is     null and blobes_prev.blobs_seq_nos is not null then ''
                                     when blobes.blobs_seq_nos is not null and blobes_prev.blobs_seq_nos is not null then '","'
                                     else                                                                                 ''
                                end 
                                ||
                                decode(blobes_prev.blobs_seq_nos,null,null,       blobes_prev.blobs_seq_nos       ) ||
                            '"]'                                                                                                                        as images
                            ,nvl(enhet.s_deler_inne,0)                                                                                                  as deler_inne
                            ,trunc(sysdate -dato_inn)                                                                                                   as dager_inne
                            ,trunc(
                                    to_date(to_char(sysdate,'yyyy-mm-dd') ,'yyyy-mm-dd')-
                                    to_date(to_char(dato_inn,'yyyy-mm-dd'),'yyyy-mm-dd') )                                                              as dato_inne
                    from ola.t_enhet3 enhet
                         ,(select enhet_seq_no,  min(blobs_seq_no)                                                                      as blobs_seq_no  from enhet_blobs group by enhet_seq_no) blobs
                         ,(select enhet_seq_no,  min(blobs_seq_no)                                                                      as blobs_seq_no  from enhet_blobs group by enhet_seq_no) blobs_prev
                        --  ,(select enhet_seq_no, listagg(blobs_seq_no,',') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                         ,(select enhet_seq_no, listagg(blobs_seq_no,'","') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                         ,(select enhet_seq_no, listagg(blobs_seq_no,'","') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes_prev
                        --  ,(select enhet_seq_no, listagg(blobs_seq_no,'"} , {blobs_seq_no:"') within group (order by nvl(sort_order,9999), blobs_seq_no) 	as blobs_seq_nos from enhet_blobs group by enhet_seq_no) blobes
                    where prosess not in ('D99','ED1','V99','EV1','EF1')
                    and enhet.enhet_seq_no      = blobs.enhet_seq_no        (+)
                    and enhet.prev_enhet_seq_no = blobs_prev.enhet_seq_no   (+)
                    and enhet.enhet_seq_no      = blobes.enhet_seq_no       (+)
                    and enhet.prev_enhet_seq_no = blobes_prev.enhet_seq_no  (+)
                    order by bil_merke, bil_modell, vare_gruppe_id
                ) 
                select * from deler
                where 1=1
                    --batach 1-3 for å omgå ords begrensninger på 10 000 records
                    --and batch='batch-1'
                    --and batch='batch-2'
                    and batch='batch-3'
            /
 
            grant all on v_api_deler to public;

            --test
                select enhet_seq_no, paa_bil, count(*) from v_api_deler where dele_nr is null and nvl(paa_bil,'x')<>'J' group by enhet_seq_no,paa_bil;

            --https://raw.githubusercontent.com/qrv/bildeler-json/master/deler.json
                select batch, count(*) from v_api_deler group by batch order by 1;
                    batch-1       6862  7075    7139    
                    batch-2       7232  7312    7428
                    batch-3       6997  7235    7291

                select substr(bil_merke,1,1), count(*) from v_api_deler group by substr(bil_merke,1,1) order by 1;
                        A          1253
                        B          1912
                        C           753
                        D            27
                        F          1198
                        H           745
                        I           208
                        J            63
                        K           414
                        L           289     "6862"
                        M          3375
                        N          1109
                        O          1227
                        P           918
                        R           603     "7232"
                        S          1428
                        T          1177
                        V          4384
                                    8       "6997"

        
-t--------------------------------------------------------- v_api_driver_lager -----------------------------------------------------------------------------------------------------------------------------------
    --drop table v_api_driver_lager;
    create table v_api_driver_lager as 
    --create table t as 
    --create or replace view tt as 
        with prosess_decode as ( 
            select 'D1' as prosess, 'Deler i plukkeliste                                                  ' as prosess_desc from dual union
            select 'D2' as prosess, 'Deler punchet (av vidar)                                             ' as prosess_desc from dual union
            select 'D3' as prosess, 'Deler pa lager (av Toralv)                                           ' as prosess_desc from dual union
            select 'D4' as prosess, 'Deler solgt                                                          ' as prosess_desc from dual union   
            select 'V1' as prosess, 'Vrak lagt inn pa henteliste                                          ' as prosess_desc from dual union
            select 'V2' as prosess, 'Vrak motatt (av Tommy)                                               ' as prosess_desc from dual union
            select 'V3' as prosess, 'Vrak plassert pa selvplukk                                           ' as prosess_desc from dual union
            select 'V4' as prosess, 'Vrak i sirkulasjon inne, ute etc                                     ' as prosess_desc from dual union
            select 'V5' as prosess, 'Vrak presset                                                         ' as prosess_desc from dual union   
            select 'V6' as prosess, 'Vrak feilregistrert                                                  ' as prosess_desc from dual union
            select 'S1' as prosess, 'Alle deler og vrak som har dele nummer (avhengig av Dxx og Vxx verdi)' as prosess_desc from dual 
        )
        select    
                    v_enhet2.enhet_seq_no                                           as enhet_seq_no           ,
                    cast(null as varchar2(1))                                       as sok_uri                ,
                    cast(null as varchar2(1))                                       as prosess                , 
                    cast(null as varchar2(1))                                       as s_fri_tekst            ,
                    cast(null as varchar2(1))                                       as s_enhet_seq_no         ,                    
                    cast(null as varchar2(1))                                       as s_prev_enhet_seq_no    ,                    
                    cast(null as varchar2(1))                                       as s_vare_gruppe_id       ,
                    cast(null as varchar2(1))                                       as s_paa_bil              ,
                    cast(null as varchar2(1))                                       as s_loc_id               ,
                    cast(null as varchar2(1))                                       as s_serie_no             ,
                    cast(null as varchar2(1))                                       as s_fab_navn             ,
                    cast(null as varchar2(1))                                       as s_type_id              ,
                    cast(null as varchar2(1))                                       as s_aar                  ,
                    cast(null as varchar2(1))                                       as s_enhet_besk           ,
                    'v_api_driver_get'                          as code                   ,
                                                       '**'||                   --               2 =    2
            to_char (v_enhet2.enhet_seq_no         ) ||'**'||                   --    2 +    8 + 2 =   12                                                   
                     v_enhet2.vare_gruppe_id         ||'**'||                   --   12 +   30 + 2 =   44                                                           
                     v_enhet2.loc_id                 ||'**'||                   --   44 +   20 + 2 =   66
            to_char (v_enhet2.serie_no             ) ||'**'||                   --   66 +    8 + 2 =   76
                     v_enhet2.fab_navn               ||'**'||                   --   76 +   30 + 2 =  108 
                     v_enhet2.type_id                ||'**'||                   --  108 +   30 + 2 =  140
                     v_enhet2.aar                    ||'**'||                   --  140 +    4 + 2 =  146
            to_char (v_enhet2.dato_inn,'yyyy-mm-dd') ||'**'||                   --  146 +   10 + 2 =  158
            to_char (round(v_enhet2.pris_inkl_mva) ) ||'**'||                   --  158 +    5 + 2 =  165 (99 999)
                     v_enhet2.motor_kode             ||'**'||                   --  165 +   80 + 2 =  247
                     v_enhet2.gear_kode              ||'**'||                   --  247 +   80 + 2 =  329
                     v_enhet2.reg_no                 ||'**'||                   --  329 +   10 + 2 =  341
                     v_enhet2.betegnelse             ||'**'||                   --  341 +   20 + 2 =  363
                     v_enhet2.oem_maker              ||'**'||                   --  363 +   50 + 2 =  415
                     v_enhet2.vendor_data_no         ||'**'||                   --  415 +   50 + 2 =  467
                     v_enhet2.chassis_no             ||'**'||                   --  467 +   25 + 2 =  494
            substr ( v_enhet2.prod_nr,1,44)          ||'**'||                   --  494 +   44 + 2 =  540   
                     v_enhet2.enhet_besk             ||'**'||                   --  540 + 1024 + 2 = 1566
            substr ( v_enhet2.temp, 1,2000         ) ||'**'                     --  1566+ 2000 + 2 = 3568
                                                                                        as fri_tekst,               -- 0
            v_enhet2.vare_gruppe_seq_no                                                 as vare_gruppe_seq_no,      -- 1
            v_enhet2.vare_gruppe_id                                                     as vare_gruppe_id,          -- 2
            v_enhet2.paa_bil                                                            as paa_bil,                 -- 3
            v_enhet2.hold_on                                                            as hold_on,                 -- 4
            v_enhet2.location_seq_no                                                    as location_seq_no,         -- 5
            v_enhet2.loc_id                                                             as loc_id,                  -- 6
            v_enhet2.serie_seq_no                                                       as serie_seq_no,            -- 7
            v_enhet2.serie_no                                                           as serie_no,                -- 8
            v_enhet2.var_bil_seq_no                                                     as var_bil_seq_no,          -- 9
            v_enhet2.fab_navn                                                           as fab_navn,                --10
            v_enhet2.type_id                                                            as type_id,                 --11
            v_enhet2.aar                                                                as aar,                     --12
            v_enhet2.enhet_besk                                                         as enhet_besk,              --13
            v_enhet2.temp                                                               as temp,                    --14
            v_enhet2.dato_inn                                                           as dato_inn,                --15
            v_enhet2.pris_inkl_mva                                                      as pris_inkl_mva,           --16
            v_enhet2.bilder_ant                                                         as bilder_ant,              --17
            --Hentes fra ALLE VRAK                                      
              cast(null as varchar2(1))                                                 as del_vasket,              --18
              substr(
                      substr(lower(loc_id),3,length(loc_id))||' ' 
                      ||
                      --1 pri = enhet
                      case when v_enhet2.merke_vasket is not null then 
                          ':'||v_enhet2.merke_vasket
                      else
                          --2 pri = vegdir
                            case when vognkort.merke_navn is not null then 
                              ':'||vognkort.merke_navn
                            else
                                  --3pri = enhet_ekstern
                                  case when enhet_ekstern.bil_merke is not null then
                                    ':'||enhet_ekstern.bil_merke
                                  else
                                    ''
                                  end 
                            end               
                      end
                      ,1,25)                                                            as scroll_info,             --19
              case when upper(loc_id) = 'V_MOTATT'       then 1
                   when upper(loc_id) = 'V_EKSTERN'      then 2
                   when upper(loc_id) = 'V_UTE1'         then 3
                   when upper(loc_id) = 'V_UTE2'         then 4
                   when upper(loc_id) = 'V_UTE1_HOGGET'  then 5
                   when upper(loc_id) = 'V_UTE2_HOGGET'  then 6
              else                                            7
              end                                                                       as sort_order,              --20
            --Hentes på paa_bil_VRAK                    
              v_enhet2.prev_enhet_seq_no                                                as prev_enhet_seq_no,       --21
              v_enhet2.prev_serie_seq_no                                                as prev_serie_seq_no,       --22
              v_enhet2.prev_serie_no                                                    as prev_serie_no,           --23
            ---                     
              v_enhet2.motor_kode                                                       as motor_kode,              --24    
              v_enhet2.gear_kode                                                        as gear_kode,               --25
              v_enhet2.gear_type                                                        as gear_type,               --26 
              v_enhet2.reg_no                                                           as reg_no,                  --27
              v_enhet2.betegnelse                                                       as betegnelse,              --28
              nvl(v_enhet2.miljo_klarert_id,'N')                                        as miljo_klarert_id,        --29
              v_enhet2.oem_maker                                                        as oem_maker,               --30
              v_enhet2.prod_nr                                                          as prod_nr,                 --31
              v_enhet2.vendor_data_seq_no                                               as vendor_data_seq_no,      --32
              v_enhet2.vendor_data_no                                                   as vendor_data_no,          --33  
              v_enhet2.chassis_no                                                       as chassis_no,              --34     
              v_enhet2.km                                                               as km,                      --35   
              v_enhet2.del_1                                                            as del_1,                   --36  
              v_enhet2.bil_1                                                            as bil_1,                   --37 
              cast(null as number(1)  )                                                 as blobs_seq_no,            --38 
              cast(null as varchar2(1))                                                 as mime_type,               --39         
              cast(null as varchar2(1))                                                 as blobs_size,              --40
              --EMPTY_BLOB()                                                              as blobs,                 -- 
              --Bilanmerkning (fra v_map_obas_nbd)
              v_enhet2.k_grp_id||' '||v_enhet2.dorer_id||' '||decode(v_enhet2.servo,'J','m/servo',null)  as bilanmarkning,    --41  c25 Anmärkning på bilen Tex. 5D CC 4WD
              v_enhet2.farge_kode                                                                        as fargkod,          --42  c15 Koden anger vilken färg det är på Bilen.
              decode(v_enhet2.motor_vol_id,null,null,
                      rtrim(v_enhet2.motor_vol_id,' ')||'l')
              ||' '||v_enhet2.betegnelse                                                                 as motoranm,         --43  c20 Anmärkningar på motorn
              decode(v_enhet2.loc_id,'V_UTE1_HOGGET','hogget ')||
                decode(v_enhet2.loc_id,'V_UTE2_HOGGET','hogget ')||
                decode(v_enhet2.loc_id,'V_INNE_HOGGET','hogget ')||
                v_enhet2.dorer_id  ||' '||v_enhet2.k_grp_id                                              as kaross,           --43  c20 Bilens kaross.
            --Status
            decode(v_enhet2.vare_gruppe_id,'VRAK','VRAK', 'DEL')                    as status_vare,
            decode(v_enhet2.location_seq_no,null,null,
                                            3300,'3300 V_EKSTERN'  ,
                                            -1,  '-1   V_MOTATT'   ,
                                            695, '695  V_SELVPLUKK',
                                            0,   '0    HOLD'       ,
                                                 'exist'           )                as status_loc,
            decode(v_enhet2.serie_seq_no   ,null,null,'exist')                      as status_serie_no,
            nvl(v_enhet2.paa_bil,'N')                                               as status_paa_bil,
            --DEL -------------------------------------------------------------------------------------------------------------------------------------------------------
            --d1) Plukke-liste
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') = 'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 'D1' end ||
            --d2) Vidar punchet             
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    = 0                 and v_enhet2.serie_seq_no is not null   then 'D2' end ||
            --d3) Deler på lager                
            case when  v_enhet2.vare_gruppe_seq_no <>1 and                                 nvl(v_enhet2.location_seq_no,0) > 0                                                         then 'D3' end ||
            --d4) Solgt             
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 'D4' end ||
            --VRAK-------------------------------------------------------------------------------------------------------------------------------------------------------
            --v1) Hente-liste
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =3300                  and v_enhet2.serie_seq_no is not null   then 'V1' end ||
            --v2) Motatt
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =-1                    and v_enhet2.serie_seq_no is not null   then 'V2' end ||
            --v3) Selvplukk
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =695                   and v_enhet2.serie_seq_no is not null   then 'V3' end ||
            --v4) Vrak
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no not in (3300,-1,695)   
                                                                                           and v_enhet2.location_seq_no is not null            and v_enhet2.serie_seq_no is not null   then 'V4' end ||
            --v5) Presset
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is not null   then 'V5' end ||
            --v6) Feil
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is     null   then 'V6' end ||
            --S1) Alle med serie_no
            case when  v_enhet2.serie_no is not null                                                                                                                                   then 'S1' end as prosess_retur
        from ola.v_enhet2,                          
             ola.enhet_ekstern,
             vegdir.v_vognkort vognkort
        where 1=1
            and v_enhet2.enhet_seq_no       = enhet_ekstern.enhet_seq_no (+)
            and v_enhet2.reg_no             = vognkort.kjennemerke       (+)
            --vrak som finner eller V_Ekstern som ikke har f†tt location_seq_no enda (i gamle dager)            
            --and   (v_enhet2.serie_git clone https://github.com/qrv/bildeler-dev.gitviewno like 'V%' and v_enhet2.location_seq_no is not null ) or v_enhet2.location_seq_no=3300
            --and v_enhet2.vare_gruppe_seq_no =1
            --and v_enhet2.location_seq_no is not null
    /

    select count(*) from v_api_driver_lager;
    --137320  2018-05-17
    --137320  2018-05-20
    --137369  2018-10-01
    --153957  2019-12-29
    
    select count(*) from v_enhet2;
    --137367
    --140402  2018-10-01
    --140481  2018-10-02

    select enhet_seq_no from v_enhet2 minus select enhet_seq_no from v_api_driver_lager;
    select enhet_seq_no from tt minus select enhet_seq_no from v_enhet2;
    select enhet_seq_no from v_enhet2 minus select enhet_seq_no from tt;
    select enhet_seq_no, count(*) from tt group by enhet_seq_no having count(*) >1;
    ENHET_SEQ_NO   COUNT(*)
    ------------ ----------
       87263          2
       87262          2



----------------------------------------------------------- v_api_driver_get -----------------------------------------------------------------------------------------------------------------------------------
    --drop table v_api_driver_get;
    --create table v_api_driver_get as select * from tt
    --create or replace view v_api_driver_get as
    --create or replace view tt as 
        with prosess_decode as ( 
            select 'D1' as prosess, 'Deler i plukkeliste                                                  ' as prosess_desc from dual union
            select 'D2' as prosess, 'Deler punchet (av vidar)                                             ' as prosess_desc from dual union
            select 'D3' as prosess, 'Deler pa lager (av Toralv)                                           ' as prosess_desc from dual union
            select 'D4' as prosess, 'Deler solgt                                                          ' as prosess_desc from dual union   
            select 'V1' as prosess, 'Vrak lagt inn pa henteliste                                          ' as prosess_desc from dual union
            select 'V2' as prosess, 'Vrak motatt (av Tommy)                                               ' as prosess_desc from dual union
            select 'V3' as prosess, 'Vrak plassert pa selvplukk                                           ' as prosess_desc from dual union
            select 'V4' as prosess, 'Vrak i sirkulasjon inne, ute etc                                     ' as prosess_desc from dual union
            select 'V5' as prosess, 'Vrak presset                                                         ' as prosess_desc from dual union   
            select 'V6' as prosess, 'Vrak feilregistrert                                                  ' as prosess_desc from dual union
            select 'S1' as prosess, 'Alle deler og vrak som har dele nummer (avhengig ac Dxx og Vxx verdi)' as prosess_desc from dual 
        )
        select    
                    v_enhet2.enhet_seq_no                                           as enhet_seq_no           ,
                    cast(null as varchar2(1))                                       as sok_uri                ,
                    cast(null as varchar2(1))                                       as prosess                , 
                    cast(null as varchar2(1))                                       as s_fri_tekst            ,
                    cast(null as varchar2(1))                                       as s_enhet_seq_no         ,                    
                    cast(null as varchar2(1))                                       as s_prev_enhet_seq_no    ,                    
                    cast(null as varchar2(1))                                       as s_vare_gruppe_id       ,
                    cast(null as varchar2(1))                                       as s_paa_bil              ,
                    cast(null as varchar2(1))                                       as s_loc_id               ,
                    cast(null as varchar2(1))                                       as s_serie_no             ,
                    cast(null as varchar2(1))                                       as s_fab_navn             ,
                    cast(null as varchar2(1))                                       as s_type_id              ,
                    cast(null as varchar2(1))                                       as s_aar                  ,
                    cast(null as varchar2(1))                                       as s_enhet_besk           ,
                    'v_api_driver_get'                          as code                   ,
                                                       '**'||                   --               2 =    2
            to_char (v_enhet2.enhet_seq_no         ) ||'**'||                   --    2 +    8 + 2 =   12                                                   
                     v_enhet2.vare_gruppe_id         ||'**'||                   --   12 +   30 + 2 =   44                                                           
                     v_enhet2.loc_id                 ||'**'||                   --   44 +   20 + 2 =   66
            to_char (v_enhet2.serie_no             ) ||'**'||                   --   66 +    8 + 2 =   76
                     v_enhet2.fab_navn               ||'**'||                   --   76 +   30 + 2 =  108 
                     v_enhet2.type_id                ||'**'||                   --  108 +   30 + 2 =  140
                     v_enhet2.aar                    ||'**'||                   --  140 +    4 + 2 =  146
            to_char (v_enhet2.dato_inn,'yyyy-mm-dd') ||'**'||                   --  146 +   10 + 2 =  158
            to_char (round(v_enhet2.pris_inkl_mva) ) ||'**'||                   --  158 +    5 + 2 =  165 (99 999)
                     v_enhet2.motor_kode             ||'**'||                   --  165 +   80 + 2 =  247
                     v_enhet2.gear_kode              ||'**'||                   --  247 +   80 + 2 =  329
                     v_enhet2.reg_no                 ||'**'||                   --  329 +   10 + 2 =  341
                     v_enhet2.betegnelse             ||'**'||                   --  341 +   20 + 2 =  363
                     v_enhet2.oem_maker              ||'**'||                   --  363 +   50 + 2 =  415
                     v_enhet2.vendor_data_no         ||'**'||                   --  415 +   50 + 2 =  467
                     v_enhet2.chassis_no             ||'**'||                   --  467 +   25 + 2 =  494
            substr ( v_enhet2.prod_nr,1,44)          ||'**'||                   --  494 +   44 + 2 =  540   
                     v_enhet2.enhet_besk             ||'**'||                   --  540 + 1024 + 2 = 1566
            substr ( v_enhet2.temp, 1,2000         ) ||'**'                     --  1566+ 2000 + 2 = 3568
                                                                                        as fri_tekst,               -- 0
            v_enhet2.vare_gruppe_seq_no                                                 as vare_gruppe_seq_no,      -- 1
            v_enhet2.vare_gruppe_id                                                     as vare_gruppe_id,          -- 2
            v_enhet2.paa_bil                                                            as paa_bil,                 -- 3
            v_enhet2.hold_on                                                            as hold_on,                 -- 4
            v_enhet2.location_seq_no                                                    as location_seq_no,         -- 5
            v_enhet2.loc_id                                                             as loc_id,                  -- 6
            v_enhet2.serie_seq_no                                                       as serie_seq_no,            -- 7
            v_enhet2.serie_no                                                           as serie_no,                -- 8
            v_enhet2.var_bil_seq_no                                                     as var_bil_seq_no,          -- 9
            v_enhet2.fab_navn                                                           as fab_navn,                --10
            v_enhet2.type_id                                                            as type_id,                 --11
            v_enhet2.aar                                                                as aar,                     --12
            v_enhet2.enhet_besk                                                         as enhet_besk,              --13
            v_enhet2.temp                                                               as temp,                    --14
            v_enhet2.dato_inn                                                           as dato_inn,                --15
            v_enhet2.pris_inkl_mva                                                      as pris_inkl_mva,           --16
            v_enhet2.bilder_ant                                                         as bilder_ant,              --17
            --Hentes fra ALLE VRAK                                      
              cast(null as varchar2(1))                                                 as del_vasket,              --18
              substr(
                      substr(lower(loc_id),3,length(loc_id))||' ' 
                      ||
                      --1 pri = enhet
                      case when v_enhet2.merke_vasket is not null then 
                          ':'||v_enhet2.merke_vasket
                      else
                          --2 pri = vegdir
                            case when vognkort.merke_navn is not null then 
                              ':'||vognkort.merke_navn
                            else
                                  --3pri = enhet_ekstern
                                  case when enhet_ekstern.bil_merke is not null then
                                    ':'||enhet_ekstern.bil_merke
                                  else
                                    ''
                                  end 
                            end               
                      end
                      ,1,25)                                                            as scroll_info,             --19
              case when upper(loc_id) = 'V_MOTATT'       then 1
                   when upper(loc_id) = 'V_EKSTERN'      then 2
                   when upper(loc_id) = 'V_UTE1'         then 3
                   when upper(loc_id) = 'V_UTE2'         then 4
                   when upper(loc_id) = 'V_UTE1_HOGGET'  then 5
                   when upper(loc_id) = 'V_UTE2_HOGGET'  then 6
              else                                            7
              end                                                                       as sort_order,              --20
            --Hentes på paa_bil_VRAK                    
              v_enhet2.prev_enhet_seq_no                                                as prev_enhet_seq_no,       --21
              v_enhet2.prev_serie_seq_no                                                as prev_serie_seq_no,       --22
              v_enhet2.prev_serie_no                                                    as prev_serie_no,           --23
            ---                     
              v_enhet2.motor_kode                                                       as motor_kode,              --24    
              v_enhet2.gear_kode                                                        as gear_kode,               --25
              v_enhet2.gear_type                                                        as gear_type,               --26 
              v_enhet2.reg_no                                                           as reg_no,                  --27
              v_enhet2.betegnelse                                                       as betegnelse,              --28
              nvl(v_enhet2.miljo_klarert_id,'N')                                        as miljo_klarert_id,        --29
              v_enhet2.oem_maker                                                        as oem_maker,               --30
              v_enhet2.prod_nr                                                          as prod_nr,                 --31
              v_enhet2.vendor_data_seq_no                                               as vendor_data_seq_no,      --32
              v_enhet2.vendor_data_no                                                   as vendor_data_no,          --33  
              v_enhet2.chassis_no                                                       as chassis_no,              --34     
              v_enhet2.km                                                               as km,                      --35   
              v_enhet2.del_1                                                            as del_1,                   --36  
              v_enhet2.bil_1                                                            as bil_1,                   --37 
              cast(null as number(1)  )                                                 as blobs_seq_no,            --38 
              cast(null as varchar2(1))                                                 as mime_type,               --39         
              cast(null as varchar2(1))                                                 as blobs_size,              --40
              --EMPTY_BLOB()                                                              as blobs,                 -- 
              --Bilanmerkning (fra v_map_obas_nbd)
              v_enhet2.k_grp_id||' '||v_enhet2.dorer_id||' '||decode(v_enhet2.servo,'J','m/servo',null)  as bilanmarkning,    --41  c25 Anmärkning på bilen Tex. 5D CC 4WD
              v_enhet2.farge_kode                                                                        as fargkod,          --42  c15 Koden anger vilken färg det är på Bilen.
              decode(v_enhet2.motor_vol_id,null,null,
                      rtrim(v_enhet2.motor_vol_id,' ')||'l')
              ||' '||v_enhet2.betegnelse                                                                 as motoranm,         --43  c20 Anmärkningar på motorn
              decode(v_enhet2.loc_id,'V_UTE1_HOGGET','hogget ')||
                decode(v_enhet2.loc_id,'V_UTE2_HOGGET','hogget ')||
                decode(v_enhet2.loc_id,'V_INNE_HOGGET','hogget ')||
                v_enhet2.dorer_id  ||' '||v_enhet2.k_grp_id                                              as kaross,           --43  c20 Bilens kaross.
            --Status
            decode(v_enhet2.vare_gruppe_id,'VRAK','VRAK', 'DEL')                    as status_vare,
            decode(v_enhet2.location_seq_no,null,null,
                                            3300,'3300 V_EKSTERN'  ,
                                            -1,  '-1   V_MOTATT'   ,
                                            695, '695  V_SELVPLUKK',
                                            0,   '0    HOLD'       ,
                                                 'exist'           )                as status_loc,
            decode(v_enhet2.serie_seq_no   ,null,null,'exist')                      as status_serie_no,
            nvl(v_enhet2.paa_bil,'N')                                               as status_paa_bil,
            --DEL -------------------------------------------------------------------------------------------------------------------------------------------------------
            --d1) Plukke-liste
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') = 'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 'D1' end ||
            --d2) Vidar punchet             
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    = 0                 and v_enhet2.serie_seq_no is not null   then 'D2' end ||
            --d3) Deler på lager                
            case when  v_enhet2.vare_gruppe_seq_no <>1 and                                 nvl(v_enhet2.location_seq_no,0) > 0                                                         then 'D3' end ||
            --d4) Solgt             
            case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 'D4' end ||
            --VRAK-------------------------------------------------------------------------------------------------------------------------------------------------------
            --v1) Hente-liste
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =3300                  and v_enhet2.serie_seq_no is not null   then 'V1' end ||
            --v2) Motatt
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =-1                    and v_enhet2.serie_seq_no is not null   then 'V2' end ||
            --v3) Selvplukk
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =695                   and v_enhet2.serie_seq_no is not null   then 'V3' end ||
            --v4) Vrak
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no not in (3300,-1,695)   
                                                                                           and v_enhet2.location_seq_no is not null            and v_enhet2.serie_seq_no is not null   then 'V4' end ||
            --v5) Presset
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is not null   then 'V5' end ||
            --v6) Feil
            case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is     null   then 'V6' end ||
            --S1) Alle med serie_no
            case when  v_enhet2.serie_no is not null                                                                                                                                   then 'S1' end as prosess_retur
        from ola.v_enhet2,                          
             ola.enhet_ekstern,
             v_vognkort vognkort
        where 1=1
            and v_enhet2.enhet_seq_no       = enhet_ekstern.enhet_seq_no (+)
            and v_enhet2.reg_no             = vognkort.kjennemerke       (+)
            --vrak som finner eller V_Ekstern som ikke har f†tt location_seq_no enda (i gamle dager)            
            --and   (v_enhet2.serie_git clone https://github.com/qrv/bildeler-dev.gitviewno like 'V%' and v_enhet2.location_seq_no is not null ) or v_enhet2.location_seq_no=3300
            --and v_enhet2.vare_gruppe_seq_no =1
            --and v_enhet2.location_seq_no is not null
    /

    select count(*) from v_api_driver_get;
    --135 996
    --136 173 2018-03-31 påske
    --153 957 2019-12-29

    select prosess_retur, count(*) from v_api_driver_get group by prosess_retur order by 1;
    --PROSESS_RETUR            COUNT(*)
    ------------------------ ----------
    --D1                            173
    --D2S1                          273
    --D3S1                        19924
    --D4                          85528
    --V1S1                           15
    --V2S1                            2
    --V3S1                           94
    --V4S1                          263
    --V5S1                        29722
    --V6                              2    

    select count(*) from v_api_driver_get
    where upper(prosess_retur)    like upper('D3')||'%';
    --19924

    select count(*) from v_api_driver_get
    where upper(prosess_retur)    like '%'||upper('S1')||'%';
    --50293

    select serie_no from v_api_driver_get
    where upper(prosess_retur)    like '%'||upper('V2S1')||'%';

----------------------------------------------------------- v_api_vrak_loc_exist -------------------------------------------------------------------------------------------------------------------------------
    create or replace force editionable view   v_api_vrak_loc_exist as 
        select
                  v_enhet2.enhet_seq_no                                                               as enhet_seq_no,
                  v_enhet2.vare_gruppe_seq_no                                                         as vare_gruppe_seq_no,
                  v_enhet2.del_vasket                                                                 as del_vasket,
                  v_enhet2.serie_no                                                                   as serie_no,
                  --
                  substr(
                  substr(lower(loc_id),3,length(loc_id))||' '
                  ||
                  --1 pri = enhet
                  case when v_enhet2.merke_vasket is NOT null then
                      ':'||v_enhet2.merke_vasket
                  else
                      --2 pri = vegdir
                        case when vognkort.merke_navn is NOT null then
                          ':'||vognkort.merke_navn
                        else
                              --3pri = enhet_ekstern
                              case when enhet_ekstern.bil_merke is NOT null then
                                ':'||enhet_ekstern.bil_merke
                              else
                                ''
                              end
                        end
                  end
                  ,1,25)                                                                              as scroll_info,
                  v_enhet2.location_seq_no                                                            as location_seq_no,
                  case when loc_id = 'V_MOTATT'       then 1
                       when loc_id = 'V_EKSTERN'      then 2
                       when loc_id = 'V_UTE1'         then 3
                       when loc_id = 'V_UTE2'         then 4
                       when loc_id = 'V_UTE1_HOGGET'  then 5
                       when loc_id = 'V_UTE2_HOGGET'  then 6
                  else 7
                  end                                                                                 as sort_order,
                  v_enhet2.loc_id                                                                     as loc_id,
                  case when v_enhet2.reg_no is NOT null then
                    v_enhet2.reg_no
                  else
                    'reg.no :...'
                  end                                                                                 as reg_no,
                  --
                  --merke_vasket,modell_vasket,aar,scope_vasket,
                  ----------------------------------------------
                  --1 pri = enhet
                  case when v_enhet2.merke_vasket||v_enhet2.modell_vasket||v_enhet2.aar||v_enhet2.scope_vasket is NOT null then
                      v_enhet2.merke_vasket||' '||v_enhet2.modell_vasket||' '||v_enhet2.aar||' '||v_enhet2.scope_vasket
                  else
                      --2 pri = vegdir
                        case when vognkort.merke_navn||vognkort.modellbetegnelse||vognkort.typebetegnelse||vognkort.reg_aar_mod_aar is NOT null then
                          vognkort.merke_navn||' '||vognkort.modellbetegnelse||' '||vognkort.typebetegnelse||' '||vognkort.reg_aar_mod_aar
                        else
                              --3pri = enhet_ekstern
                              case when enhet_ekstern.bil_merke is NOT null then
                                enhet_ekstern.bil_merke
                              else
                                'ikke tilgjengelig...'
                              end
                        end
                  end                                                                                                               as bil_info,
                  v_enhet2.merke_vasket||' '||v_enhet2.modell_vasket||' '||v_enhet2.aar||' '||v_enhet2.scope_vasket                 as bil_enhet,
                  vognkort.merke_navn||' '||vognkort.modellbetegnelse||' '||vognkort.typebetegnelse||' '||vognkort.reg_aar_mod_aar  as bil_vegdir,
                  enhet_ekstern.bil_merke                                                                                           as bil_enhet_ekstern,
                  --chassis_info
                  --------------
                  --1 pri = enhet
                  case when chassis_no is NOT null then
                      'ch.no: '||chassis_no
                  else
                      --2 pri = vegdir
                        case when chassis_no_vegdir  is NOT null then
                          'ch.no: '||chassis_no_vegdir
                        else
                          'ch.no: ikke tilgjengelig...'
                        end
                  end                                                                                                               as chassis_no_info,
                  chassis_no                                                                                                        as chassis_no_enhet,
                  chassis_no_vegdir                                                                                                 as chassis_no_vegdir,
                  dato_inn
            from ola.v_enhet2,
                     ola.enhet_ekstern,
                     v_vognkort vognkort
                where 1=1
                and v_enhet2.enhet_seq_no = enhet_ekstern.enhet_seq_no (+)
                and v_enhet2.reg_no       = vognkort.kjennemerke       (+)
                and v_enhet2.vare_gruppe_seq_no=1
                --V_EKSTERN eller V_MOTATT  in (3300,-1)
                and v_enhet2.location_seq_no is not null
                order by dato_inn desc,sort_order, v_enhet2.serie_no
    /       

----------------------------------------------------------- REST module apex_42   v_api_xxx  -------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_api_driver as
        select
                        v_enhet2.enhet_seq_no                               as enhet_seq_no           ,
                                                                   '**'||                   --               2 =    2
                        to_char (v_enhet2.enhet_seq_no         ) ||'**'||                   --    2 +    8 + 2 =   12
                                 v_enhet2.vare_gruppe_id         ||'**'||                   --   12 +   30 + 2 =   44
                                 v_enhet2.loc_id                 ||'**'||                   --   44 +   20 + 2 =   66
                        to_char (v_enhet2.serie_no             ) ||'**'||                   --   66 +    8 + 2 =   76
                                 v_enhet2.fab_navn               ||'**'||                   --   76 +   30 + 2 =  108
                                 v_enhet2.type_id                ||'**'||                   --  108 +   30 + 2 =  140
                                 v_enhet2.aar                    ||'**'||                   --  140 +    4 + 2 =  146
                        to_char (v_enhet2.dato_inn,'yyyy-mm-dd') ||'**'||                   --  146 +   10 + 2 =  158
                        to_char (round(v_enhet2.pris_inkl_mva) ) ||'**'||                   --  158 +    5 + 2 =  165 (99 999)
                                 v_enhet2.motor_kode             ||'**'||                   --  165 +   80 + 2 =  247
                                 v_enhet2.gear_kode              ||'**'||                   --  247 +   80 + 2 =  329
                                 v_enhet2.reg_no                 ||'**'||                   --  329 +   10 + 2 =  341
                                 v_enhet2.betegnelse             ||'**'||                   --  341 +   20 + 2 =  363
                                 v_enhet2.oem_maker              ||'**'||                   --  363 +   50 + 2 =  415
                                 v_enhet2.vendor_data_no         ||'**'||                   --  415 +   50 + 2 =  467
                                 v_enhet2.chassis_no             ||'**'||                   --  467 +   25 + 2 =  494
                        substr ( v_enhet2.prod_nr,1,44)          ||'**'||                   --  494 +   44 + 2 =  540
                                 v_enhet2.enhet_besk             ||'**'||                   --  540 + 1024 + 2 = 1566
                        substr ( v_enhet2.temp, 1,2000         ) ||'**'                     --  1566+ 2000 + 2 = 3568
                                                                                                    as fri_tekst,               -- 0
                        v_enhet2.vare_gruppe_seq_no                                                 as vare_gruppe_seq_no,      -- 1
                        v_enhet2.vare_gruppe_id                                                     as vare_gruppe_id,          -- 2
                        v_enhet2.paa_bil                                                            as paa_bil,                 -- 3
                        v_enhet2.hold_on                                                            as hold_on,                 -- 4
                        v_enhet2.location_seq_no                                                    as location_seq_no,         -- 5
                        v_enhet2.loc_id                                                             as loc_id,                  -- 6
                        v_enhet2.serie_seq_no                                                       as serie_seq_no,            -- 7
                        v_enhet2.serie_no                                                           as serie_no,                -- 8
                        v_enhet2.var_bil_seq_no                                                     as var_bil_seq_no,          -- 9
                        v_enhet2.fab_navn                                                           as fab_navn,                --10
                        v_enhet2.type_id                                                            as type_id,                 --11
                        v_enhet2.aar                                                                as aar,                     --12
                        v_enhet2.enhet_besk                                                         as enhet_besk,              --13
                        v_enhet2.temp                                                               as temp,                    --14
                        v_enhet2.dato_inn                                                           as dato_inn,                --15
                        v_enhet2.pris_inkl_mva                                                      as pris_inkl_mva,           --16
                        v_enhet2.bilder_ant                                                         as bilder_ant,              --17
                        --Hentes fra ALLE VRAK
                          null                                                                      as del_vasket,              --18
                          substr(
                                  substr(lower(loc_id),3,length(loc_id))||' '
                                  ||
                                  --1 pri = enhet
                                  case when v_enhet2.merke_vasket is not null then
                                      ':'||v_enhet2.merke_vasket
                                  else
                                      --2 pri = vegdir
                                        case when vognkort.merke_navn is not null then
                                          ':'||vognkort.merke_navn
                                        else
                                              --3pri = enhet_ekstern
                                              case when enhet_ekstern.bil_merke is not null then
                                                ':'||enhet_ekstern.bil_merke
                                              else
                                                ''
                                              end
                                        end
                                  end
                                  ,1,25)                                                            as scroll_info,             --19
                          case when upper(loc_id) = 'V_MOTATT'       then 1
                               when upper(loc_id) = 'V_EKSTERN'      then 2
                               when upper(loc_id) = 'V_UTE1'         then 3
                               when upper(loc_id) = 'V_UTE2'         then 4
                               when upper(loc_id) = 'V_UTE1_HOGGET'  then 5
                               when upper(loc_id) = 'V_UTE2_HOGGET'  then 6
                          else                                            7
                          end                                                                       as sort_order,              --20
                        --Hentes p† paa_bil_VRAK
                          v_enhet2.prev_enhet_seq_no                                                as prev_enhet_seq_no,       --21
                          v_enhet2.prev_serie_seq_no                                                as prev_serie_seq_no,       --22
                          v_enhet2.prev_serie_no                                                    as prev_serie_no,           --23
                        ---
                          v_enhet2.motor_kode                                                       as motor_kode,              --24
                          v_enhet2.gear_kode                                                        as gear_kode,               --25
                          v_enhet2.reg_no                                                           as reg_no,                  --26
                          v_enhet2.betegnelse                                                       as betegnelse,              --27
                          nvl(v_enhet2.miljo_klarert_id,'N')                                        as miljo_klarert_id,        --28
                          nvl(v_enhet2.miljo_klarert_oppe_id,'N')                                   as miljo_klarert_oppe_id,   --29
                          v_enhet2.oem_maker                                                        as oem_maker,               --30
                          v_enhet2.prod_nr                                                          as prod_nr,                 --31
                          v_enhet2.vendor_data_seq_no                                               as vendor_data_seq_no,      --32
                          v_enhet2.vendor_data_no                                                   as vendor_data_no,          --33
                          v_enhet2.chassis_no                                                       as chassis_no,              --34
                        --Status
                        decode(v_enhet2.vare_gruppe_id,'VRAK','VRAK', 'DEL')                    as status_vare,
                        decode(v_enhet2.location_seq_no,null,null,
                                                        3300,'3300 V_EKSTERN'  ,
                                                        -1,  '-1   V_MOTATT'   ,
                                                        695, '695  V_SELVPLUKK',
                                                        0,   '0    HOLD'       ,
                                                             'exist'           )                as status_loc,
                        decode(v_enhet2.serie_seq_no   ,null,null,'exist')                      as status_serie_no,
                        nvl(v_enhet2.paa_bil,'N')                                               as status_paa_bil,
                        --DEL -------------------------------------------------------------------------------------------------------------------------------------------------------
                        --d1) Plukke-liste
                        case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') = 'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 1 end as flow_d1_plukkeliste,
                        --d2) Vidar punchet
                        case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    = 0                 and v_enhet2.serie_seq_no is not null   then 1 end as flow_d2_punchet,
                        --d3) Deler p† lager
                        case when  v_enhet2.vare_gruppe_seq_no <>1 and                                 nvl(v_enhet2.location_seq_no,0) > 0                                                         then 1 end as flow_d3_paa_lager,
                        --d4) Solgt
                        case when  v_enhet2.vare_gruppe_seq_no <>1 and nvl(v_enhet2.paa_bil,'N') <>'J' and v_enhet2.location_seq_no    is null             and v_enhet2.serie_seq_no is     null   then 1 end as flow_d4_solgt,
                        --VRAK-------------------------------------------------------------------------------------------------------------------------------------------------------
                        --v1) Hente-liste
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =3300                  and v_enhet2.serie_seq_no is not null    then 1 end as flow_v1_henteliste,
                        --v2) Motatt
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =-1                    and v_enhet2.serie_seq_no is not null    then 1 end as flow_v2_motatt,
                        --v3) Selvplukk
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no =695                   and v_enhet2.serie_seq_no is not null    then 1 end as flow_v3_selvplukk,
                        --v4) Vrak
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no not in (3300,-1,695)
                                                                                                       and v_enhet2.location_seq_no is not null            and v_enhet2.serie_seq_no is not null    then 1 end as flow_v4_vrak,
                        --v5) Presset
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is not null    then 1 end as flow_v5_presset,
                        --v6) Feil
                        case when  v_enhet2.vare_gruppe_seq_no = 1                                     and v_enhet2.location_seq_no is null                and v_enhet2.serie_seq_no is     null    then 1 end as flow_v6_feil
        from ola.v_enhet2,
                     ola.enhet_ekstern,
                     --obas4 vegdir.v_vognkort vognkort
                     v_vognkort vognkort
        where 1=1
                        and v_enhet2.enhet_seq_no       = enhet_ekstern.enhet_seq_no (+)
                        and v_enhet2.reg_no             = vognkort.kjennemerke       (+)
                        --vrak som finner eller V_Ekstern som ikke har f+tt location_seq_no enda (i gamle dager)
                        --and   (v_enhet2.serie_no like 'V%' and v_enhet2.location_seq_no is not null ) or v_enhet2.location_seq_no=3300
                        --and v_enhet2.vare_gruppe_seq_no =1
                        --and v_enhet2.location_seq_no is not null
    /
    grant all on    v_api_driver                    to public;
    create or replace view   v_api_2_1_paa_bil as
        select
                    driver.enhet_seq_no             as enhet_seq_no           ,
                    null                            as sok_uri                ,
                    null                            as prosess                ,
                    null                            as s_fri_tekst            ,
                    null                            as s_enhet_seq_no         ,
                    null                            as s_prev_enhet_seq_no    ,
                    null                            as s_vare_gruppe_id       ,
                    null                            as s_paa_bil              ,
                    null                            as s_loc_id               ,
                    null                            as s_serie_no             ,
                    null                            as s_fab_navn             ,
                    null                            as s_type_id              ,
                    null                            as s_aar                  ,
                    null                            as s_enhet_besk           ,
                   'v_api_2_1_paa_bil'              as code                   ,
                    -----------------------------------------------------------
                    driver.fri_tekst                                  as fri_tekst,               -- 0
                    driver.vare_gruppe_seq_no                         as vare_gruppe_seq_no,      -- 1
                    driver.vare_gruppe_id                             as vare_gruppe_id,          -- 2
                    driver.paa_bil                                    as paa_bil,                 -- 3
                    driver.hold_on                                    as hold_on,                 -- 4
                    driver.location_seq_no                            as location_seq_no,         -- 5
                    driver.loc_id                                     as loc_id,                  -- 6
                    driver.serie_seq_no                               as serie_seq_no,            -- 7
                    driver.serie_no                                   as serie_no,                -- 8
                    driver.var_bil_seq_no                             as var_bil_seq_no,          -- 9
                    driver.fab_navn                                   as fab_navn,                --10
                    driver.type_id                                    as type_id,                 --11
                    driver.aar                                        as aar,                     --12
                    driver.enhet_besk                                 as enhet_besk,              --13
                    driver.temp                                       as temp,                    --14
                    driver.dato_inn                                   as dato_inn,                --15
                    driver.pris_inkl_mva                              as pris_inkl_mva,           --16
                    driver.bilder_ant                                 as bilder_ant,              --17
                    --Hentes fra ALLE VRAK
                      null                                            as del_vasket,              --18
                      null                                            as scroll_info,             --19
                      null                                            as sort_order,              --20
                    --Hentes p† paa_bil_VRAK
                      driver.prev_enhet_seq_no                        as prev_enhet_seq_no,       --21
                      driver.prev_serie_seq_no                        as prev_serie_seq_no,       --22
                      driver.prev_serie_no                            as prev_serie_no,           --23
                    ---
                      driver.motor_kode                               as motor_kode,              --24
                      driver.gear_kode                                as gear_kode,               --25
                      driver.reg_no                                   as reg_no,                  --26
                      driver.betegnelse                               as betegnelse,              --27
                      driver.miljo_klarert_id                         as miljo_klarert_id,        --28
                      driver.miljo_klarert_oppe_id                    as miljo_klarert_oppe_id,   --29
                      driver.oem_maker                                as oem_maker,               --30
                      driver.prod_nr                                  as prod_nr,                 --31
                      driver.vendor_data_seq_no                       as vendor_data_seq_no,      --32
                      driver.vendor_data_no                           as vendor_data_no,          --33
                      driver.chassis_no                               as chassis_no               --34
                from ola.v_api_driver driver
                where 1=1
                    and  ( nvl(driver.paa_bil,'x') = 'J' and location_seq_no is null and serie_seq_no is     null )
                    or   ( nvl(driver.paa_bil,'x') <>'J' and location_seq_no =   0   and serie_seq_no is not null )
    /
    grant all on    v_api_2_1_paa_bil               to public;
    create or replace view  v_api_2_2_paa_bil_vrak as
        select
                    distinct
                    driver.prev_enhet_seq_no          as enhet_seq_no           ,
                    null                              as sok_uri                ,
                    null                              as prosess                ,
                    null                              as s_fri_tekst            ,
                    null                              as s_enhet_seq_no         ,
                    null                              as s_prev_enhet_seq_no    ,
                    null                              as s_vare_gruppe_id       ,
                    null                              as s_paa_bil              ,
                    null                              as s_loc_id               ,
                    null                              as s_serie_no             ,
                    null                              as s_fab_navn             ,
                    null                              as s_type_id              ,
                    null                              as s_aar                  ,
                    null                              as s_enhet_besk           ,
                    'v_api_2_2_paa_bil_vrak'          as code                   ,
                    -------------------------------------------------------------
                                                             '**'||                   --               2 =    2
                    to_char (driver.prev_enhet_seq_no    ) ||'**'||                   --    2 +    8 + 2 =   12
                    to_char (driver.prev_serie_no        ) ||'**'||                   --   12 +    8 + 2 =   22
                             driver.fab_navn               ||'**'||                   --   22 +   30 + 2 =   54
                             driver.type_id                ||'**'||                   --   54 +   30 + 2 =   86
                             driver.aar                    ||'**'||                   --   86 +    4 + 2 =   92
                             driver.chassis_no             ||'**'                     --   92 +   25 + 2 =  109
                                                                        as fri_tekst,               -- 0 spezial her for † unng† duplikater
                    null                                                as vare_gruppe_seq_no,      -- 1
                    null                                                as vare_gruppe_id,          -- 2
                    null                                                as paa_bil,                 -- 3
                    null                                                as hold_on,                 -- 4
                    null                                                as location_seq_no,         -- 5
                    null                                                as loc_id,                  -- 6
                    null                                                as serie_seq_no,            -- 7
                    driver.prev_serie_no                                as serie_no,                -- 8
                    null                                                as var_bil_seq_no,          -- 9
                    driver.fab_navn                                     as fab_navn,                --10
                    driver.type_id                                      as type_id,                 --11
                    driver.aar                                          as aar,                     --12
                    null                                                as enhet_besk,              --13
                    null                                                as temp,                    --14
                    null                                                as dato_inn,                --15
                    null                                                as pris_inkl_mva,           --16
                    null                                                as bilder_ant,              --17
                    --Hentes fra ALLE VRAK
                    null                                                as del_vasket,              --18
                    null                                                as scroll_info,             --19
                    null                                                as sort_order,              --20
                    --Hentes p† paa_bil_VRAK
                    null                                                as prev_enhet_seq_no,       --21
                    null                                                as prev_serie_seq_no,       --22
                    null                                                as prev_serie_no,           --23
                    null                                                as motor_kode,              --24
                    null                                                as gear_kode,               --25
                    null                                                as reg_no,                  --26
                    null                                                as betegnelse,              --27
                    null                                                as miljo_klarert_id,        --28
                    null                                                as miljo_klarert_oppe_id,   --29
                    null                                                as oem_maker,               --30
                    null                                                as prod_nr,                 --31
                    null                                                as vendor_data_seq_no,      --32
                    null                                                as vendor_data_no,          --33
                    driver.chassis_no                                   as chassis_no               --34
        from ola.v_api_driver driver
                where 1=1
                    and  ( nvl(driver.paa_bil,'x') = 'J' and location_seq_no is null and serie_seq_no is     null )
                    or   ( nvl(driver.paa_bil,'x') <>'J' and location_seq_no =   0   and serie_seq_no is not null )
    /
    grant all on    v_api_2_2_paa_bil_vrak          to public;
    create or replace view v_api_3_1_vrak as
        select
                    driver.enhet_seq_no             as enhet_seq_no           ,
                    null                            as sok_uri                ,
                    null                            as prosess                ,
                    null                            as s_fri_tekst            ,
                    null                            as s_enhet_seq_no         ,
                    null                            as s_prev_enhet_seq_no    ,
                    null                            as s_vare_gruppe_id       ,
                    null                            as s_paa_bil              ,
                    null                            as s_loc_id               ,
                    null                            as s_serie_no             ,
                    null                            as s_fab_navn             ,
                    null                            as s_type_id              ,
                    null                            as s_aar                  ,
                    null                            as s_enhet_besk           ,
                    'v_api_3_1_vrak'                as code                   ,
                    -----------------------------------------------------------
                    driver.fri_tekst                                              as fri_tekst,               -- 0
                    driver.vare_gruppe_seq_no                                     as vare_gruppe_seq_no,      -- 1
                    driver.vare_gruppe_id                                         as vare_gruppe_id,          -- 2
                    driver.paa_bil                                                as paa_bil,                 -- 3
                    driver.hold_on                                                as hold_on,                 -- 4
                    driver.location_seq_no                                        as location_seq_no,         -- 5
                    driver.loc_id                                                 as loc_id,                  -- 6
                    driver.serie_seq_no                                           as serie_seq_no,            -- 7
                    driver.serie_no                                               as serie_no,                -- 8
                    driver.var_bil_seq_no                                         as var_bil_seq_no,          -- 9
                    driver.fab_navn                                               as fab_navn,                --10
                    driver.type_id                                                as type_id,                 --11
                    driver.aar                                                    as aar,                     --12
                    driver.enhet_besk                                             as enhet_besk,              --13
                    driver.temp                                                   as temp,                    --14
                    driver.dato_inn                                               as dato_inn,                --15
                    driver.pris_inkl_mva                                          as pris_inkl_mva,           --16
                    driver.bilder_ant                                             as bilder_ant,              --17
                    --Hentes fra ALLE VRAK
                      null                                                        as del_vasket,              --18
                      driver.scroll_info                                          as scroll_info,             --19
                      driver.sort_order                                           as sort_order,              --20
                    --Hentes p† paa_bil_VRAK
                      driver.prev_enhet_seq_no                                    as prev_enhet_seq_no,       --21
                      driver.prev_serie_seq_no                                    as prev_serie_seq_no,       --22
                      driver.prev_serie_no                                        as prev_serie_no,           --23
                    ---
                      driver.motor_kode                                           as motor_kode,              --24
                      driver.gear_kode                                            as gear_kode,               --25
                      driver.reg_no                                               as reg_no,                  --26
                      driver.betegnelse                                           as betegnelse,              --27
                      driver.miljo_klarert_id                                     as miljo_klarert_id,        --28
                      driver.miljo_klarert_oppe_id                                as miljo_klarert_oppe_id,   --29
                      driver.oem_maker                                            as oem_maker,               --30
                      driver.prod_nr                                              as prod_nr,                 --31
                      driver.vendor_data_seq_no                                   as vendor_data_seq_no,      --32
                      driver.vendor_data_no                                       as vendor_data_no,          --33
                      driver.chassis_no                                           as chassis_no               --34
                from ola.v_api_driver driver
                where 1=1
                    and driver.vare_gruppe_seq_no =1
                    and driver.location_seq_no is not null
    /
    grant all on    v_api_3_1_vrak                  to public;
    create or replace view v_api_3_2_vrak_ekst_motatt as
        select
                    driver.enhet_seq_no               as enhet_seq_no           ,
                    null                                as sok_uri                ,
                    null                                as prosess                ,
                    null                                as s_fri_tekst            ,
                    null                                as s_enhet_seq_no         ,
                    null                                as s_prev_enhet_seq_no    ,
                    null                                as s_vare_gruppe_id       ,
                    null                                as s_paa_bil              ,
                    null                                as s_loc_id               ,
                    null                                as s_serie_no             ,
                    null                                as s_fab_navn             ,
                    null                                as s_type_id              ,
                    null                                as s_aar                  ,
                    null                                as s_enhet_besk           ,
                    'v_api_3_2_vrak_ekst_motatt'        as code                   ,
                    -----------------------------------------------------------
                    driver.fri_tekst                                                as fri_tekst,               -- 0
                    driver.vare_gruppe_seq_no                                     as vare_gruppe_seq_no,      -- 1
                    driver.vare_gruppe_id                                         as vare_gruppe_id,          -- 2
                    driver.paa_bil                                                as paa_bil,                 -- 3
                    driver.hold_on                                                as hold_on,                 -- 4
                    driver.location_seq_no                                        as location_seq_no,         -- 5
                    driver.loc_id                                                 as loc_id,                  -- 6
                    driver.serie_seq_no                                           as serie_seq_no,            -- 7
                    driver.serie_no                                               as serie_no,                -- 8
                    driver.var_bil_seq_no                                         as var_bil_seq_no,          -- 9
                    driver.fab_navn                                               as fab_navn,                --10
                    driver.type_id                                                as type_id,                 --11
                    driver.aar                                                    as aar,                     --12
                    driver.enhet_besk                                             as enhet_besk,              --13
                    driver.temp                                                   as temp,                    --14
                    driver.dato_inn                                               as dato_inn,                --15
                    driver.pris_inkl_mva                                          as pris_inkl_mva,           --16
                    driver.bilder_ant                                             as bilder_ant,              --17
                    --Hentes fra ALLE VRAK
                      null                                                          as del_vasket,              --18
                      driver.scroll_info                                            as scroll_info,             --19
                      driver.sort_order                                             as sort_order,              --20
                    --Hentes p† paa_bil_VRAK
                      driver.prev_enhet_seq_no                                    as prev_enhet_seq_no,       --21
                      driver.prev_serie_seq_no                                    as prev_serie_seq_no,       --22
                      driver.prev_serie_no                                        as prev_serie_no,           --23
                    ---
                      driver.motor_kode                                           as motor_kode,              --24
                      driver.gear_kode                                            as gear_kode,               --25
                      driver.reg_no                                               as reg_no,                  --26
                      driver.betegnelse                                           as betegnelse,              --27
                      driver.miljo_klarert_id                                     as miljo_klarert_id,        --28
                      driver.miljo_klarert_oppe_id                                as miljo_klarert_oppe_id,   --29
                      driver.oem_maker                                            as oem_maker,               --30
                      driver.prod_nr                                              as prod_nr,                 --31
                      driver.vendor_data_seq_no                                   as vendor_data_seq_no,      --32
                      driver.vendor_data_no                                       as vendor_data_no,          --33
                      driver.chassis_no                                           as chassis_no               --34
                from ola.v_api_driver driver
                where 1=1
                    and driver.vare_gruppe_seq_no =1
                    and driver.location_seq_no in (-1,3300)
    /
    grant all on    v_api_3_2_vrak_ekst_motatt      to public;
    create or replace view v_api_4_1_del as
        select
                    driver.enhet_seq_no           as enhet_seq_no           ,
                    null                            as sok_uri                ,
                    null                            as prosess                ,
                    null                            as s_fri_tekst            ,
                    null                            as s_enhet_seq_no         ,
                    null                            as s_prev_enhet_seq_no    ,
                    null                            as s_vare_gruppe_id       ,
                    null                            as s_paa_bil              ,
                    null                            as s_loc_id               ,
                    null                            as s_serie_no             ,
                    null                            as s_fab_navn             ,
                    null                            as s_type_id              ,
                    null                            as s_aar                  ,
                    null                            as s_enhet_besk           ,
                   'v_api_4_1_del'                  as code                   ,
                    driver.fri_tekst                                    as fri_tekst,               -- 0
                    driver.vare_gruppe_seq_no                         as vare_gruppe_seq_no,      -- 1
                    driver.vare_gruppe_id                             as vare_gruppe_id,          -- 2
                    driver.paa_bil                                    as paa_bil,                 -- 3
                    driver.hold_on                                    as hold_on,                 -- 4
                    driver.location_seq_no                            as location_seq_no,         -- 5
                    driver.loc_id                                     as loc_id,                  -- 6
                    driver.serie_seq_no                               as serie_seq_no,            -- 7
                    driver.serie_no                                   as serie_no,                -- 8
                    driver.var_bil_seq_no                             as var_bil_seq_no,          -- 9
                    driver.fab_navn                                   as fab_navn,                --10
                    driver.type_id                                    as type_id,                 --11
                    driver.aar                                        as aar,                     --12
                    driver.enhet_besk                                 as enhet_besk,              --13
                    driver.temp                                       as temp,                    --14
                    driver.dato_inn                                   as dato_inn,                --15
                    driver.pris_inkl_mva                              as pris_inkl_mva,           --16
                    driver.bilder_ant                                 as bilder_ant,              --17
                    --Hentes fra ALLE VRAK
                    null                                                as del_vasket,              --18
                    null                                                as scroll_info,             --19
                    null                                                as sort_order,              --20
                    --Hentes p† paa_bil_VRAK
                      driver.prev_enhet_seq_no                        as prev_enhet_seq_no,       --21
                      driver.prev_serie_seq_no                        as prev_serie_seq_no,       --22
                      driver.prev_serie_no                            as prev_serie_no,           --23
                    ---
                      driver.motor_kode                               as motor_kode,              --24
                      driver.gear_kode                                as gear_kode,               --25
                      driver.reg_no                                   as reg_no,                  --26
                      driver.betegnelse                               as betegnelse,              --27
                      driver.miljo_klarert_id                         as miljo_klarert_id,        --28
                      driver.miljo_klarert_oppe_id                    as miljo_klarert_oppe_id,   --29
                      driver.oem_maker                                as oem_maker,               --30
                      driver.prod_nr                                  as prod_nr,                 --31
                      driver.vendor_data_seq_no                       as vendor_data_seq_no,      --32
                      driver.vendor_data_no                           as vendor_data_no,          --33
                      driver.chassis_no                               as chassis_no               --34
                from ola.v_api_driver driver
                where 1=1
    /
    grant all on    v_api_4_1_del                   to public;

    create or replace view v_api_vrak_motatt_ekstern as
        select
            v_enhet2.enhet_seq_no                                                               as enhet_seq_no,
            v_enhet2.vare_gruppe_seq_no                                                         as vare_gruppe_seq_no,
            v_enhet2.del_vasket                                                                 as del_vasket,
            v_enhet2.serie_no                                                                   as serie_no,
            --
            substr(
            substr(lower(loc_id),3,length(loc_id))||' '
            ||
            --1 pri = enhet
            case when v_enhet2.merke_vasket is NOT null then
                ':'||v_enhet2.merke_vasket
            else
                --2 pri = vegdir
                  case when vognkort.merke_navn is NOT null then
                    ':'||vognkort.merke_navn
                  else
                        --3pri = enhet_ekstern
                        case when enhet_ekstern.bil_merke is NOT null then
                          ':'||enhet_ekstern.bil_merke
                        else
                          ''
                        end
                  end
            end
            ,1,25)                                                                              as scroll_info,
            v_enhet2.location_seq_no                                                            as location_seq_no,
            v_enhet2.loc_id                                                                     as loc_id,
            v_enhet2.bilder_ant                                                                 as bilder_ant,
            case when v_enhet2.reg_no is NOT null then
              v_enhet2.reg_no
            else
              'reg.no :...'
            end                                                                                 as reg_no,
            --
            --merke_vasket,modell_vasket,aar,scope_vasket,
            ----------------------------------------------
            --1 pri = enhet
            case when v_enhet2.merke_vasket||v_enhet2.modell_vasket||v_enhet2.aar||v_enhet2.scope_vasket is NOT null then
                v_enhet2.merke_vasket||' '||v_enhet2.modell_vasket||' '||v_enhet2.aar||' '||v_enhet2.scope_vasket
            else
                --2 pri = vegdir
                  case when vognkort.merke_navn||vognkort.modellbetegnelse||vognkort.typebetegnelse||vognkort.reg_aar_mod_aar is NOT null then
                    vognkort.merke_navn||' '||vognkort.modellbetegnelse||' '||vognkort.typebetegnelse||' '||vognkort.reg_aar_mod_aar
                  else
                        --3pri = enhet_ekstern
                        case when enhet_ekstern.bil_merke is NOT null then
                          enhet_ekstern.bil_merke
                        else
                          'ikke tilgjengelig...'
                        end
                  end
            end                                                                                                               as bil_info,
            v_enhet2.merke_vasket||' '||v_enhet2.modell_vasket||' '||v_enhet2.aar||' '||v_enhet2.scope_vasket                 as bil_enhet,
            vognkort.merke_navn||' '||vognkort.modellbetegnelse||' '||vognkort.typebetegnelse||' '||vognkort.reg_aar_mod_aar  as bil_vegdir,
            enhet_ekstern.bil_merke                                                                                           as bil_enhet_ekstern,
            --chassis_info
            --------------
            --1 pri = enhet
            case when chassis_no is NOT null then
                'ch.no: '||chassis_no
            else
                --2 pri = vegdir
                  case when chassis_no_vegdir  is NOT null then
                    'ch.no: '||chassis_no_vegdir
                  else
                    'ch.no: ikke tilgjengelig...'
                  end
            end                                                                                                               as chassis_no_info,
            chassis_no                                                                                                        as chassis_no_enhet,
            chassis_no_vegdir                                                                                                 as chassis_no_vegdir,
            dato_inn
        from ola.v_enhet2,
             ola.enhet_ekstern,
             ola.v_vognkort vognkort
        where 1=1
            and v_enhet2.enhet_seq_no = enhet_ekstern.enhet_seq_no (+)
            and v_enhet2.reg_no       = vognkort.kjennemerke       (+)
            and v_enhet2.vare_gruppe_seq_no=1
            --V_EKSTERN eller V_MOTATT
            and v_enhet2.location_seq_no in (3300,-1)
        order by v_enhet2.loc_id desc, v_enhet2.serie_no
    /
    grant all on    v_api_vrak_motatt_ekstern       to public;        
                
------------------------------- apier --------------------- REST module apex_42 setup -------------------------------------------------------------------------------------------------------------------------------
    --nginx obas3
        server_name     api.qrv.no;
        location / {
            proxy_pass https://192.168.1.5:8443/ords/apex_obas/v1/;
        location /ords/obas/ {
            proxy_pass https://192.168.1.5:8443/ords/apex_obas/v1/;
        location /obas/ {
            proxy_pass https://192.168.1.5:8443/ords/apex_obas/v1/;                     

        --test 
            https://192.168.1.5:8443/ords/apex_obas/v1/location_vrak/   <--ok
            https://obas.qrv.no/ords/apex_obas/v1/location_vrak/        <--ok
            api.qrv.no/location_vrak/                                   <--ok
            api.qrv.no/ords/obas/location_vrak/                         <--ok
            api.qrv.no/obas/location_vrak/                              <--ok



    --swift xcode (D:\util\dbms\_Swift xcode\)
        --Alle.swift
            let lookupURL =     "https://api.qrv.no/ords/obas/bildeler_lookup/"
            let lagerURL =      "https://api.qrv.no/ords/obas/bildeler_lager/"
            let uploadURL =     "https://api.qrv.no/ords/obas/bildeler_lager/?dummy"
            Alamofire.request(  "https://api.qrv.no/obas/blobs_list/\(test)").responseJSON(completionHandler: {

        --NyttVrak.swift
            let vrakURL =       "https://api.qrv.no/ords/obas/v_bildeler_motatt_ekstern"
            let vrakURL =       "https://api.qrv.no/ords/obas/         v_bildeler_motatt_ekstern"
            obas6          https://obas.qrv.no/ords/apex_obas/v1/v_bildeler_motatt_ekstern/

        --Scan.swift
            let searchURL =     "https://api.qrv.no/obas/v_bildeler_sok/"
            let locURL =        "https://api.qrv.no/obas/location_vrak"
            let setURL =        "https://api.qrv.no/obas/enhet/"
            let setM =          "https://api.qrv.no/obas/location_vrak"

        --Search.swift
            let searchURL =     "https://api.qrv.no/obas/v_bildeler_sok/"
            let bildelerURL =   "https://api.qrv.no/ords/obas/bildeler_lager/"

        --Upload.swift
            let uploadURL =     "https://api.qrv.no/ords/obas/bildeler_lager/?dummy"
            let url =           "https://api.qrv.no/obas/blobs_insert/" as URLConvertible

        --View.swift
            Alamofire.request(  "https://api.qrv.no/obas/blobs_list/\(enhetSeqNo)").responseJSON(completionHandler: {

    --swift Per Ole dokumentasjon
    
    -- SETUP i APEX 
        2020-01-05 TML  obas 6 flyttet fra ola -> apex_ola og Migrere fra obas4 til bruk i iphone app
        2020-02-19 TML  setter opp obas5 utenbaskup fra obas6, bruker obas4
        2020-12-20 TML  lagt til plukke_deler / vrak
        
        --nginx access log fra iphone
              79.160.20.249 - - [05/Jan/2020:22:45:02 +0100] "GET /ords/obas/bildeler_lager/?%7B%27prosess%27%3A%27VRAK_ALLE%27%7D=dummy HTTP/1.1" 304 0 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"
              79.160.20.249 - - [05/Jan/2020:22:45:02 +0100] "GET /ords/obas/bildeler_lookup/?%7B%27prosess%27%3A%27loc_vrak%27%7D=dummy HTTP/1.1" 304 0 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"
              79.160.20.249 - - [05/Jan/2020:22:45:08 +0100] "GET /obas/v_bildeler_sok/V25245 HTTP/1.1" 404 16127 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"
              79.160.20.249 - - [05/Jan/2020:22:45:13 +0100] "GET /obas/location_vrak HTTP/1.1" 404 16127 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"
              79.160.20.249 - - [05/Jan/2020:22:45:16 +0100] "GET /ords/obas/v_bildeler_motatt_ekstern HTTP/1.1" 404 16127 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"
              79.160.20.249 - - [05/Jan/2020:22:45:51 +0100] "GET /obas/blobs_list/300167 HTTP/1.1" 404 16127 "-" "OBAS/2 (obas.jsonobas; build:2.5; iOS 13.3.0) Alamofire/4.5.1" "-"

        --sql tester
            sqlplus  ola/ola@192.168.1.5:1521/pdbobas.bildeler.net
                grant all on    v_api_driver                    to public;
                grant all on    v_api_2_1_paa_bil               to public;    
                grant all on    v_api_2_2_paa_bil_vrak          to public;        
                grant all on    v_api_3_1_vrak                  to public;    
                grant all on    v_api_3_2_vrak_ekst_motatt      to public;    
                grant all on    v_api_4_1_del                   to public;
                grant all on    v_api_vrak_motatt_ekstern       to public;        

            sqlplus  apex_obas/apex_obas@192.168.1.5:1521/pdbobas.bildeler.net
                select count(*) from     ola.v_api_driver                    ;
                select count(*) from     ola.v_api_2_1_paa_bil               ;    
                select count(*) from     ola.v_api_2_2_paa_bil_vrak          ;        
                select count(*) from     ola.v_api_3_1_vrak                  ;    
                select count(*) from     ola.v_api_3_2_vrak_ekst_motatt      ;    
                select count(*) from     ola.v_api_4_1_del                   ;

        --ymse https://192.168.1 og https://api.qrv.no adresser
                https://obas.qrv.no/ords/apex_obas/hr/version/
                https://obas.qrv.no/ords/apex_obas/hr/employees/
                https://192.168.1.7:8443/ords/apex_obas/hr/employees/
                https://192.168.1.5:8443/ords/apex_obas/hr/employees/
                https://192.168.1.3:8080/ords/obas/blobs_list/300167
                https://192.168.1.7:8443/ords/apex_obas/v1/blobs_list/300167
                https://obas.qrv.no/ords/apex_obas/v1/blobs_list/300167
                https://api.qrv.no/ords/obas/blobs_list/300167

        --1)   ORDS Schema Attributes
            Schema alias    obas
        --2)   REST module apex_42 base path v1
            Module Name     apex_42
            Base Path       /v1/        -- https://obas.qrv.no/ords/apex_obas/v1/
            Pagenation Size 999

        --3)   REST Templates (i prioritet rekkefølge for iPhone app)...
            Status:
                3.a-c --> forside i appen funker uten feilmeldinger


        --3.a)   bildeler_lager/?{sok_uri}                      GET,   Source Type: Query (depricated)
                kallt api.bildeler.net/_lager i nginx
            --Test 
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?{%27prosess%27:%27VRAK_ALLE%27,%27s_loc_id%27:%27ute1%27}
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?{sok_uri}
                https://api.qrv.no/ords/obas/bildeler_lager/?{%27prosess%27:%27VRAK_ALLE%27,%27s_loc_id%27:%27ute1%27}
                https://api.qrv.no/ords/obas/bildeler_lager/?{'prosess':'VRAK_ALLE','s_loc_id':'ute1'}

                var sok_uri     varchar2(255) ='{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}';

            --Parameter
                sok_uri             sok_uri     IN  URI            String    

            --Source
                with driver as ( 
                        select     
                            -1                                                                     as enhet_seq_no           , 
                            case when :sok_uri    is not null then :sok_uri    else null end       as sok_uri                ,
                            json_value(:sok_uri, '$.prosess'               returning varchar2)     as prosess                ,
                            json_value(:sok_uri, '$.s_fri_tekst'           returning varchar2)     as s_fri_tekst            ,
                            json_value(:sok_uri, '$.s_enhet_seq_no'        returning varchar2)     as s_enhet_seq_no         ,
                            json_value(:sok_uri, '$.s_prev_enhet_seq_no'   returning varchar2)     as s_prev_enhet_seq_no    ,                                                            
                            json_value(:sok_uri, '$.s_vare_gruppe_id'      returning varchar2)     as s_vare_gruppe_id       ,
                            json_value(:sok_uri, '$.s_paa_bil'             returning varchar2)     as s_paa_bil              ,
                            json_value(:sok_uri, '$.s_loc_id'              returning varchar2)     as s_loc_id               ,
                            json_value(:sok_uri, '$.s_serie_no'            returning varchar2)     as s_serie_no             ,
                            json_value(:sok_uri, '$.s_fab_navn'            returning varchar2)     as s_fab_navn             ,
                            json_value(:sok_uri, '$.s_type_id'             returning varchar2)     as s_type_id              ,
                            json_value(:sok_uri, '$.s_aar'                 returning varchar2)     as s_aar                  ,
                            json_value(:sok_uri, '$.s_enhet_besk'          returning varchar2)     as s_enhet_besk           ,
                            'Nr 1 driver'                                                          as code                   ,
                            --'driver'                                                               as code_id                ,
                            --0                                                                      as cnt                    ,       
                            --------------------------------------------------------------------------------------------------
                            null fri_tekst         ,                                                                                              --0
                            null vare_gruppe_seq_no, null vare_gruppe_id   , null paa_bil          , null hold_on       , null location_seq_no,   --1  -  5
                            null loc_id            , null serie_seq_no     , null serie_no         , null var_bil_seq_no, null fab_navn       ,   --6  - 10
                            null type_id           , null aar              , null enhet_besk       , null temp          , null dato_inn       ,   --11 - 15
                            null pris_inkl_mva     , null bilder_ant       , null del_vasket       , null scroll_info   , null sort_order     ,   --16 - 20
                            null prev_enhet_seq_no , null prev_serie_seq_no, null prev_serie_no    , null motor_kode    , null gear_kode      ,   --21 - 25
                            null reg_no            , null betegnelse       , null miljo_klarert_id ,                                              --26
                                                                             null miljo_klarert_oppe_id                                           --27
                                                                                                   , null oem_maker     , null prod_nr        ,   --28 - 31
                            null vendor_data_seq_no, null vendor_data_no   , null chassis_no                                                      --32 - ...
                            from dual union                        
                        select * from ola.v_api_2_1_paa_bil          where rownum <= case when upper(json_value(:sok_uri, '$.prosess') ) in ('PAA_BIL')             then 99999999 else 0 end union
                        select * from ola.v_api_2_2_paa_bil_vrak     where rownum <= case when upper(json_value(:sok_uri, '$.prosess') ) in ('PAA_BIL_VRAK')        then 99999999 else 0 end union
                        select * from ola.v_api_3_1_vrak             where rownum <= case when upper(json_value(:sok_uri, '$.prosess') ) in ('VRAK_ALLE')           then 99999999 else 0 end union
                        select * from ola.v_api_3_2_vrak_ekst_motatt where rownum <= case when upper(json_value(:sok_uri, '$.prosess') ) in ('VRAK_EKSTERN_MOTATT') then 99999999 else 0 end union
                        select * from ola.v_api_4_1_del              where rownum <= case when upper(json_value(:sok_uri, '$.prosess') ) in ('DEL')                 then 99999999 else 0 end
                            )
                select                      
                    rownum -1               as no,
                    --------------------------------------------------------------------------------------------------
                    enhet_seq_no            ,
                    sok_uri                 ,
                    prosess                 ,
                    s_fri_tekst             ,
                    s_enhet_seq_no          ,
                    s_prev_enhet_seq_no     ,
                    s_vare_gruppe_id        ,
                    s_paa_bil               ,
                    s_loc_id                ,
                    s_serie_no              ,
                    s_fab_navn              ,
                    s_type_id               ,
                    s_aar                   ,
                    s_enhet_besk            ,
                    code                    ,
                    --------------------------------------------------------------------------------------------------
                    vare_gruppe_seq_no,         vare_gruppe_id   ,      paa_bil          ,       hold_on       ,         location_seq_no,   --1  -  5
                    loc_id            ,         serie_seq_no     ,      serie_no         ,       var_bil_seq_no,         fab_navn       ,   --6  - 10
                    type_id           ,         aar              ,      enhet_besk       ,       temp          ,         dato_inn       ,   --11 - 15
                    pris_inkl_mva     ,         bilder_ant       ,      del_vasket       ,       scroll_info   ,         sort_order     ,   --16 - 20
                    prev_enhet_seq_no ,         prev_serie_seq_no,      prev_serie_no    ,       motor_kode    ,         gear_kode      ,   --21 - 25
                    reg_no            ,         betegnelse       ,      miljo_klarert_id ,                                                  --26
                                                                        miljo_klarert_oppe_id                                               --27
                                                                                         ,       oem_maker     ,         prod_nr        ,   --28 - 31
                    vendor_data_seq_no,         vendor_data_no   ,      chassis_no                                                          --32 - ...
                from driver
                where 1=1
                    --Må alltid ha med 1 record med søke-kriteriene
                    and enhet_seq_no = -1 or 
                    (   upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(1, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(2, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(3, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(4, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(5, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and to_char(enhet_seq_no)                 like case when json_value(:sok_uri, '$.s_enhet_seq_no'     ) is not null then                       upper(json_value(:sok_uri, '$.s_enhet_seq_no'     returning varchar2))       else '%'  end
                    and to_char(nvl(prev_enhet_seq_no, -1  )) like case when json_value(:sok_uri, '$.s_prev_enhet_seq_no') is not null then                       upper(json_value(:sok_uri, '$.s_prev_enhet_seq_no'))       else '%'  end                
                    and upper  (nvl(vare_gruppe_id   , '**')) like case when json_value(:sok_uri, '$.s_vare_gruppe_id'   ) is not null then                       upper(json_value(:sok_uri, '$.s_vare_gruppe_id'   ))       else '%'  end                
                    and upper  (nvl(paa_bil          , '**')) like case when json_value(:sok_uri, '$.s_paa_bil'          ) is not null then                       upper(json_value(:sok_uri, '$.s_paa_bil'          ))       else '%'  end                
                    and upper  (nvl(loc_id           , '**')) like case when json_value(:sok_uri, '$.s_loc_id'           ) is not null then                       upper(json_value(:sok_uri, '$.s_loc_id'           ))       else '%'  end                
                    and upper  (nvl(serie_no         , '**')) like case when json_value(:sok_uri, '$.s_serie_no'         ) is not null then                       upper(json_value(:sok_uri, '$.s_serie_no'         ))       else '%'  end                
                    and upper  (nvl(fab_navn         , '**')) like case when json_value(:sok_uri, '$.s_fab_navn'         ) is not null then                       upper(json_value(:sok_uri, '$.s_fab_navn'         ))       else '%'  end                
                    and upper  (nvl(type_id          , '**')) like case when json_value(:sok_uri, '$.s_type_id'          ) is not null then                       upper(json_value(:sok_uri, '$.s_type_id'          ))       else '%'  end                
                    and upper  (nvl(aar              , '**')) like case when json_value(:sok_uri, '$.s_aar'              ) is not null then                       upper(json_value(:sok_uri, '$.s_aar'              ))       else '%'  end                
                    )  --enhet_besk utelates er typisk fritekt felt som allerde er dekket

        --3.b1)  bildeler_lager/?{sok_uri}                      POST,  Source Type: PL/SQL
            --Test må gjøres i PostMan
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?{sok_uri}
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?
                https://api.qrv.no/ords/obas/bildeler_lager/?

                sette l_miljo_klarert_id
                tester på vrak V25245  enhet_seq 300167
                    select enhet_seq_no, dele_nr, miljo_klarert_id, miljo_klarert_oppe_id from ola.t_enhet3 where dele_nr='V25245'
                    select enhet_seq_no, miljo_klarert_id, miljo_klarert_oppe_id from ola.enhet where enhet_seq_no=300167
                
                https://api.qrv.no/ords/obas/bildeler_lager/?xxx
                Header setvalues =  {'prosess':'UPD','l_enhet_seq_no':'300167', 'l_miljo_klarert_id':'1'}
                                    {'prosess':'UPD','l_enhet_seq_no':'300167', 'l_miljo_klarert_oppe_id':'1'}

            --Parameter
                setvalues               setvalues   IN      HTTP header     String
                X-APEX-FORWARD          ls_forward  OUT     Response Body   String
                X-APEX-STATUS-CODE      ls_status   OUT     HTTP header     String

            --Source
                declare
                    -- 201 Created, The request has been fulfilled, resulting in the creation of a new resource.
                    -- 400 Bad Request, The server cannot or will not process the request due to an apparent client error, e.g. object exist already
                    -- 404 Not Found, Object which is updated does not exist, e.g. have not been created yet, or is deleted
                    todo_txt                varchar2(4000);
                    error_txt               varchar2(4000);
                    error_exc               exception;

                    http_status              varchar2(4000) :='501';    --FALLBACK
                                                                        -- 501 Not Implemented
                                                                        -- The server either does not recognize the request method, or it lacks the ability to fulfil the request. Usually this implies future availability (e.g., a new feature of a web-service API)

                    temp                    varchar2(4000);
                    d                       varchar2(4000);    --dummy for else i case statment

                    l_prosess               varchar2(4000);    
                    l_enhet_seq_no          varchar2(4000);    
                    l_vare_gruppe_seq_no    varchar2(4000);
                    l_vare_gruppe_id        varchar2(4000);
                    l_serie_seq_no          varchar2(4000);
                    l_serie_no_vrak         varchar2(4000);
                    l_serie_no_del          varchar2(4000);
                    l_location_seq_no       varchar2(4000);
                    l_loc_id                varchar2(4000);
                    l_miljo_klarert_id      varchar2(4000);
                    l_miljo_klarert_oppe_id varchar2(4000);
                    l_enhet_kval_seq_no     varchar2(4000);
                    l_enhet_besk            varchar2(4000);
                    l_vendor_data           varchar2(4000);
                    l_prod_nr               varchar2(4000);
                    l_pris_inkl_mva         varchar2(4000);
                    l_file_name             varchar2(4000);
                    l_content_type          varchar2(4000) := :content_type;     --Header: key=Content-Type value=application/octet-stream   application/x-www-form-urlencoded  'image/jpg'
                    l_blob                  blob := :body;
                    l_body_kb               varchar2(25) :=nvl( to_char( round(dbms_lob.GETLENGTH(l_blob)/1024,2)  ) ,'-tomt-' ); 
                    l_body_txt              varchar2(4000);-- := UTL_RAW.CAST_TO_VARCHAR2(l_blob);                                                  
                begin
                    --test
                            --owa_util.mime_header ('application/json', true);
                            --                htp.p('hei');
                            -- error_txt := error_txt||  ' content_type='||:content_type;
                            -- error_txt := error_txt||  ' current_user='||:current_user;
                            -- error_txt := error_txt||  ' page_size='   ||:page_size;
                            -- error_txt := error_txt||  ' page_offset=' ||:page_offset;
                            -- error_txt := error_txt||  ' row_offset='  ||:row_offset;
                            -- error_txt := error_txt||  ' row_count='   ||:row_count;
                            -- error_txt := error_txt||  ' body='        ||nvl(to_char(dbms_lob.GETLENGTH(:body)/1024/1024),'0');
                            -- -- error_txt := error_txt||  ' path_info' ||owa_util.get_cgi_env('PATH_INFO');               
                            -- --
                            -- error_txt := error_txt||  ' setvalues='  ||:setvalues;
                            -- raise error_exc;

                    --1) INPUT VALIDATION
                        begin
                            l_body_txt := UTL_RAW.CAST_TO_VARCHAR2(l_blob); 
                            --Hvis l_blob er tom ->rett ut til ytterste exception 
                            --Derfor fikser vi det her
                            exception when others  then temp :='';
                        end;

                        todo_txt :=  'INPUT VALIDATION 1: i)Content-Type '||:content_type  ||
                                                      ' ii)Body '         ||l_body_kb      ||'kb '||l_body_txt ||' '||
                                                     ' iii)Header key=setvalues, values='||nvl(:setvalues,
                                                                                    'is empty expects: key=setvalues, value={'||chr(39)||'key1'||chr(39)||':'||chr(39)||'value1'||chr(39)||','
                                                                                                                              ||chr(39)||'key2'||chr(39)||':'||chr(39)||'value2'||chr(39)||',...} )');
                        error_txt :=  todo_txt;    
                        if :setvalues is null then 
                            http_status :='400'; 
                            raise error_exc; 
                        end if;

                    --2) PARSE
                        select upper(json_value(:setvalues, '$.prosess'                 returning varchar2)) into l_prosess                 from dual; if l_prosess      is null then error_txt:=error_txt||' INPUT VALIDATION 2: prosess [UPD/INS/IMG] må ALLTID oppgis'; http_status :='400'; raise error_exc; end if;
                        select upper(json_value(:setvalues, '$.l_enhet_seq_no'          returning varchar2)) into l_enhet_seq_no            from dual; if l_enhet_seq_no is null then error_txt:=error_txt||' INPUT VALIDATION 2: l_enhet_seq_no må ALLTID oppgis'       ; http_status :='400'; raise error_exc; end if;
                        select upper(json_value(:setvalues, '$.l_vare_gruppe_seq_no'    returning varchar2)) into l_vare_gruppe_seq_no      from dual;
                        select upper(json_value(:setvalues, '$.l_vare_gruppe_id'        returning varchar2)) into l_vare_gruppe_id          from dual;
                        select upper(json_value(:setvalues, '$.l_serie_seq_no'          returning varchar2)) into l_serie_seq_no            from dual;
                        select upper(json_value(:setvalues, '$.l_serie_no_vrak'         returning varchar2)) into l_serie_no_vrak           from dual;
                        select upper(json_value(:setvalues, '$.l_serie_no_del'          returning varchar2)) into l_serie_no_del            from dual;
                        select upper(json_value(:setvalues, '$.l_location_seq_no'       returning varchar2)) into l_location_seq_no         from dual;
                        select upper(json_value(:setvalues, '$.l_loc_id'                returning varchar2)) into l_loc_id                  from dual;
                        select upper(json_value(:setvalues, '$.l_miljo_klarert_id'      returning varchar2)) into l_miljo_klarert_id        from dual;
                        select upper(json_value(:setvalues, '$.l_miljo_klarert_oppe_id' returning varchar2)) into l_miljo_klarert_oppe_id   from dual;
                        select upper(json_value(:setvalues, '$.l_enhet_kval_seq_no'     returning varchar2)) into l_enhet_kval_seq_no       from dual;
                        select upper(json_value(:setvalues, '$.l_enhet_besk'            returning varchar2)) into l_enhet_besk              from dual;
                        select upper(json_value(:setvalues, '$.l_vendor_data'           returning varchar2)) into l_vendor_data             from dual;
                        select upper(json_value(:setvalues, '$.l_prod_nr'               returning varchar2)) into l_prod_nr                 from dual;
                        select upper(json_value(:setvalues, '$.l_pris_inkl_mva'         returning varchar2)) into l_pris_inkl_mva           from dual;
                        select upper(json_value(:setvalues, '$.l_file_name'             returning varchar2)) into l_file_name               from dual;
                        --parse log
                                                                        temp:='';
                        case when l_prosess                 is not null then temp:= temp||'prosess'                 ||'='||l_prosess                      ||' ';                                  else d:='nop'; end case;
                        case when l_enhet_seq_no            is not null then temp:= temp||'l_enhet_seq_no'          ||'='||l_enhet_seq_no                 ||' ';                                  else d:='nop'; end case;
                        case when l_vare_gruppe_seq_no      is not null then temp:= temp||'l_vare_gruppe_seq_no'    ||'='||l_vare_gruppe_seq_no           ||' ';                                  else d:='nop'; end case;
                        case when l_vare_gruppe_id          is not null then temp:= temp||'l_vare_gruppe_id'        ||'='||l_vare_gruppe_id               ||' ';                                  else d:='nop'; end case;
                        case when l_serie_seq_no            is not null then temp:= temp||'l_serie_seq_no'          ||'='||l_serie_seq_no                 ||' ';                                  else d:='nop'; end case;
                        case when l_serie_no_vrak           is not null then temp:= temp||'l_serie_no_vrak'         ||'='||l_serie_no_vrak                ||' ';                                  else d:='nop'; end case;
                        case when l_serie_no_del            is not null then temp:= temp||'l_serie_no_del'          ||'='||l_serie_no_del                 ||' ';                                  else d:='nop'; end case;
                        case when l_location_seq_no         is not null then temp:= temp||'l_location_seq_no'       ||'='||l_location_seq_no              ||' ';                                  else d:='nop'; end case;
                        case when l_loc_id                  is not null then temp:= temp||'l_loc_id'                ||'='||l_loc_id                       ||' ';                                  else d:='nop'; end case;
                        case when l_miljo_klarert_id        is not null then temp:= temp||'l_miljo_klarert_id'      ||'='||l_miljo_klarert_id             ||' ';                                  else d:='nop'; end case;
                        case when l_miljo_klarert_oppe_id   is not null then temp:= temp||'l_miljo_klarert_oppe_id' ||'='||l_miljo_klarert_oppe_id        ||' ';                                  else d:='nop'; end case;
                        case when l_enhet_kval_seq_no       is not null then temp:= temp||'l_enhet_kval_seq_no'     ||'='||l_enhet_kval_seq_no            ||' ';                                  else d:='nop'; end case;
                        case when l_enhet_besk              is not null then temp:= temp||'l_enhet_besk'            ||'='||l_enhet_besk                   ||' ';                                  else d:='nop'; end case;
                        case when l_vendor_data             is not null then temp:= temp||'l_vendor_data'           ||'='||l_vendor_data                  ||' ';                                  else d:='nop'; end case;
                        case when l_prod_nr                 is not null then temp:= temp||'l_prod_nr'               ||'='||l_prod_nr                      ||' ';                                  else d:='nop'; end case;
                        case when l_pris_inkl_mva           is not null then temp:= temp||'l_pris_inkl_mva'         ||'='||l_pris_inkl_mva                ||' ';                                  else d:='nop'; end case;
                        case when l_file_name               is not null then temp:= temp||'l_file_name'             ||'='||l_file_name                    ||' ';                                  else d:='nop'; end case;

                        todo_txt  := todo_txt || ' INPUT VALIDATION 3: PARSE RESULTS '||temp;
                        error_txt :=             ' INPUT VALIDATION 3: PARSE RESULTS '||temp;

                        --listing
                        --error_txt:= todo_txt; raise error_exc;

                    --3) EXECUTE
                        case 
                        when l_prosess in ('UPD', 'INS', 'IMG','QR_1','QR_2', 'U1') then
                            if l_prosess='IMG' and l_body_kb='-tomt-' then   error_txt:= todo_txt ||' INPUT VALIDATION 4: PARSE RESULTS bilde er tomt '; http_status:='400'; raise error_exc; end if;
                            --2020-01-05 rest ligger i apex_obas men pr_api ligger i ola
                            ola.pr_api( l_prosess           ,
                                    l_enhet_seq_no          ,
                                    l_vare_gruppe_seq_no    ,
                                    l_vare_gruppe_id        ,
                                    l_serie_seq_no          ,
                                    l_serie_no_vrak         ,
                                    l_serie_no_del          ,
                                    l_location_seq_no       ,
                                    l_loc_id                ,
                                    l_miljo_klarert_id      ,
                                    l_miljo_klarert_oppe_id ,
                                    l_enhet_kval_seq_no     ,
                                    l_enhet_besk            ,
                                    l_vendor_data           ,
                                    l_prod_nr               ,
                                    l_pris_inkl_mva         , 
                                    l_file_name             ,
                                    l_content_type          ,
                                    l_blob                  ,
                                    http_status             ,  -- out
                                    error_txt);                 -- out


                            if http_status <> '201'  then 
                                error_txt:= todo_txt ||' PR VALIDATION 1: ' ||error_txt; raise error_exc;
                            else  
                                todo_txt := todo_txt ||' PR VALIDATION 2: ' ||error_txt;
                            end if;
                        when l_prosess in ('IMGcccc') then
                            error_txt := todo_txt || ' 3) EXCECUTE pr_rest  IKKE KLAR ENDA...';
                            raise error_exc;
                            -- ola.pr_rest ('blobs_insert',:enhet_seq_no,null,null,:file_name,:content_type,:body,:blobs_seq_no,sysdate,ret);            
                        end case;                                        

                    --4) Clean up
                        :ls_status  := http_status;
                        :ls_forward := to_number(l_enhet_seq_no)||' '||todo_txt;

                    exception when error_exc then :ls_status := http_status;  :ls_forward := 'ERROR_EXC => {ERROR_TXT: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm||'}';
                              when others    then :ls_status := http_status;  :ls_forward := 'ERROR_OTH => {ERROR_TXT: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm||'}';
                    -- raise_application_error(-20001,out_feil);   
                end;
        
        --3.b2)  felles ORDS.pr_api_post plukke_deler, dekk etc POST,  Source Type: PL/SQL
            --Test må gjøres i PostMan
                --pipe deler
                     •	Plukke deler fra vraket, POST
                            https://api.qrv.no/obas/pipe_deler
                            setvalues= {'prosess':'PIP','l_pip':'hylle1,hylle2,D12,D13,hylle88'}
                            setvalues= {'prosess':'PIP','l_pip':'26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743'}
                        
                        --20200109_104912.txt   test fil exigo1 Toralv    
                            26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                --plukke_deler                
                    000)
                        •	Liste vrak som har deler i plukkeliste, GET
                            https://api.qrv.no/obas/plukke_vrak

                        •	Liste deler i plukkliste på vrak, GET
                            https://api.qrv.no/obas/plukke_deler/?352673

                        •	Plukke deler fra vraket, POST
                            https://api.qrv.no/obas/plukke_deler
                            setvalues= {'prosess':'PLUKKE_HOLD','l_enhet_seq_no':'357891', 'l_enhet_besk':'linje enhet_besk','l_temp':'linje temp'}
                            
                            --testdata 
                                select loc_id, serie_no, dato_inn  from v_enhet2@obas6 where loc_id like '1%' and vare_gruppe_seq_no <>1 order by loc_id, serie_no
                            
                                {'prosess':'PIP','l_pip':'1B1A,D25548'} 

                    00)
                        https://api.qrv.no/obas/plukke_deler/?352673
                        https://api.qrv.no/obas/plukke_deler
                        Header setvalues =
                            {'prosess':'PLUKKE_HOLD','l_enhet_seq_no':'357890'}  
                            {'prosess':'PLUKKE_HOLD','l_enhet_seq_no':'357890', 'l_enhet_besk':'linje enhet_besk','l_temp':'linje temp'}  
                            {'prosess':'PLUKKE_SLETT','l_enhet_seq_no':'357888'}  
                            {'prosess':'UPD','l_prev_enhet_seq_no':'353475','l_var_bil_seq_no':'','l_serie_seq_no':'104323','l_location_seq_no':'0','l_vare_gruppe_seq_no':'40063','l_dekk_antall':'4','l_pris_inkl_mva':'100','l_prod_nr':'prod','l_enhet_besk':'besk','l_actor_seq_no':'1760','l_dekk_type_seq_no':'14','l_dekk_monster_dybde_1':'3','l_dekk_monster_dybde_2':'4','l_dekk_produsert_aar_1':'2014','l_dekk_produsert_aar_2':'2015','l_dekk_load_index_1':'index1','l_dekk_load_index_2':'index2','l_felg_type_seq_no':''}          

                    0) tester på vrak V38226  enhet_seq_no  355371,  
                              med 2 deler  enhet_seq_no  357346,357347
                        select max(enhet_seq_no) from enhet;

                        select * from t_enhet3@obas6 where prosess in ('D1', 'D2')  and p_serie_no ='V36537' order by prev_enhet_seq_no, prosess
                            "D2"
                          enhet: serie_seq_no   serie_no    dele_nr     location_seq_no loc_id  lokasjon    prosess prosess_detaljer
                          enhet     105184                              0
                        t_enhet3    105184      D68568      D68568      0               HOLD    HOLD        D2      oppdateres ved neste kjoring...

                    1) legger inn plukke liste på V37500 Saab 9-3 på selvplukk
                        "alt1"
                            https://api.qrv.no/obas/plukke_deler/?352673
                        "alt2"                            
                            create or replace view tt as 
                            select prev_enhet_seq_no, enhet_seq_no, enhet_besk,temp,serie_seq_no, location_seq_no, pris_inkl_mva,  
                            f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) as prosess,
                            f_prosess( null, vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) as prosess_desc
                            from enhet@obas6 
                            where prev_enhet_seq_no=352673;
    
                            PREV_ENHET_SEQ_NO	ENHET_SEQ_NO	ENHET_BESK	TEMP	SERIE_SEQ_NO	LOCATION_SEQ_NO	PRIS_INKL_MVA
                            352673	            357886	        del 2	    merk 2	                                1560
                            352673	            357887	        del4	    merk 4	                                1950
                            352673	            357885	        del 1	    merk	                                520
                            352673	            357888	        		    		                                1950
                            352673	            357889	        		    		                                1820
                            352673	            357890	        		    		                                1820
                            352673	            357891	        		    		                                1950
                            352673	            357892	        		    		                                1560
                            352673	            357893	        		    		                                1625
                            352673	            357894	        		    		                                1950
                            352673	            357895	        		    		                                1820
                            352673	            357896	        		    		                                260

                    2) oppdater t_enhet3

                --dekk
                    https://api.qrv.no/obas/v_api_lov_serie_no_del_nye
                    https://api.qrv.no/obas/v_api_lov_lokasjon
                    https://api.qrv.no/obas/v_api_lov_vare_gruppe
                    https://api.qrv.no/obas/v_api_lov_actor_id
                    https://api.qrv.no/obas/v_api_lov_dekk_type
                    https://api.qrv.no/obas/v_api_lov_felg_type
                    
                    https://api.qrv.no/ords/obas/bildeler_dekk
                    Header setvalues =  {'prosess':'UPD','l_serie_seq_no':'104313','l_location_seq_no':'10059','l_vare_gruppe_seq_no':'40061','l_dekk_antall':'4','l_pris_inkl_mva':'100','l_prod_nr':'prod','l_enhet_besk':'besk','l_actor_seq_no':'1760','l_dekk_type_seq_no':'14','l_dekk_monster_dybde_1':'3','l_dekk_monster_dybde_2':'4','l_dekk_produsert_aar_1':'2014','l_dekk_produsert_aar_2':'2015','l_dekk_load_index_1':'index1','l_dekk_load_index_2':'index2','l_felg_type_seq_no':''}          
                    Header setvalues =  {'prosess':'UPD','l_serie_seq_no':'104314','l_location_seq_no':'10059','l_vare_gruppe_seq_no':'40061','l_dekk_antall':'4','l_pris_inkl_mva':'100','l_prod_nr':'prod','l_enhet_besk':'besk','l_actor_seq_no':'1760','l_dekk_type_seq_no':'14','l_dekk_monster_dybde_1':'3','l_dekk_monster_dybde_2':'4','l_dekk_produsert_aar_1':'2014','l_dekk_produsert_aar_2':'2015','l_dekk_load_index_1':'index1','l_dekk_load_index_2':'index2'}          
                    Header setvalues =  {'prosess':'UPD','l_prev_enhet_seq_no':'353475','l_var_bil_seq_no':'','l_serie_seq_no':'104323','l_location_seq_no':'0','l_vare_gruppe_seq_no':'40061','l_dekk_antall':'4','l_pris_inkl_mva':'100','l_prod_nr':'prod','l_enhet_besk':'besk','l_actor_seq_no':'1760','l_dekk_type_seq_no':'14','l_dekk_monster_dybde_1':'3','l_dekk_monster_dybde_2':'4','l_dekk_produsert_aar_1':'2014','l_dekk_produsert_aar_2':'2015','l_dekk_load_index_1':'index1','l_dekk_load_index_2':'index2','l_felg_type_seq_no':''}          


                    sette l_miljo_klarert_id
                    tester på vrak V25245  enhet_seq 300167
                        select max(enhet_seq_no) from enhet;

                        353478
                        select 
                             prev_enhet_seq_no              --  353475                         -- 353478                --                       
                            ,var_bil_seq_no                 --                                 --                       -- 107805                
                            ,serie_seq_no                   --  104318      D67905             -- 104320 D67907         -- 104322 D67909                              
                            ,location_seq_no                --  0           Hold               -- 0                     -- 0                  
                            ,vare_gruppe_seq_no             --  40061       Dekkhelår          -- 101059 Felgsett alu   -- 100700 Hjulsett                                        
                            ,dekk_antall                    --  4                              --                       --                  
                            ,pris_inkl_mva                  --  100                            --  100                  -- 100                 
                            ,prod_nr                        --  dekk helår                     --                       --                  
                            ,enhet_besk                     --  besk                           --                       --                  
                            ,actor_seq_no                   --  1760                           --                       -- 1760                     
                            ,dekk_type_seq_no               --  14                             --                       -- 14                     
                            ,dekk_monster_dybde_1           --  3                              --                       -- 3                    
                            ,dekk_monster_dybde_2           --  4                              --                       -- 4                    
                            ,dekk_produsert_aar_1           --  2014                           --                       -- 2014                
                            ,dekk_produsert_aar_2           --  2015                           --                       -- 2015                     
                            ,dekk_load_index_1              --  index1                         --                       -- index1                         
                            ,dekk_load_index_2              --  index 2                        --                       -- index2                         
                            ,felg_type_seq_no               --                                 -- 3                     -- 3                      
                        from ola.enhet where enhet_seq_no in (353478,353481,353484,353486)

                    select min(serie_seq_no) from ola.v_api_lov_serie_no_del_nye;

            --Parameter
                setvalues               setvalues   IN      HTTP header     String
                X-APEX-FORWARD          ls_forward  OUT     Response Body   String
                X-APEX-STATUS-CODE      ls_status   OUT     HTTP header     String

                --APEX
                    --plukke_deler
                        "tba"

                    --dekk
                        prev_enhet_seq_no       v_api_lov_enhet
                        var_bil_seq_no          v_api_lov_bil_obas
                        serie_seq_no            v_api_lov_serie_no_del_nye
                        location_seq_no         v_api_lov_lokasjon
                        vare_gruppe_seq_no      v_api_lov_vare_gruppe               -------------------------
                        dekk_antall             1-7
                        pris_inkl_mva           v_api_lov_pris
                        prod_nr                 visuelt delenummer
                        enhet_besk              xxx                                 -----------------------------
                        actor_seq_no            v_api_lov_actor_id
                        dekk_type_seq_no        v_api_lov_dekk_type
                        dekk_monster_dybde_1    3-8
                        dekk_monster_dybde_2    3-8
                        dekk_produsert_aar_1    2014-2025
                        dekk_produsert_aar_2    2014-2025
                        dekk_load_index_1       xxx
                        dekk_load_index_2       xxx                                 ---------------------------------------
                        felg_type_seq_no        v_api_felg_type
            --Source                
                declare
                    -- 200 Request was received and understood and is being processed
                    -- 201 Created, The request has been fulfilled, resulting in the creation of a new resource.
                    -- 400 Bad Request, The server cannot or will not process the request due to an apparent client error, e.g. object exist already
                    -- 404 Not Found, Object which is updated does not exist, e.g. have not been created yet, or is deleted
                    -- 501 Not Implemented, The server either does not recognize the request method, or it lacks the ability to fulfil the request. Usually this implies future availability (e.g., a new feature of a web-service API)
                    /*
      		            ** Changed by:  Date:       Description:
      		            **        TML   2020-12-20  kopi fra bildeler_dekk POST
                        */
                        -- 201 Created, The request has been fulfilled, resulting in the creation of a new resource.
                        -- 400 Bad Request, The server cannot or will not process the request due to an apparent client error, e.g. object exist already
                        -- 404 Not Found, Object which is updated does not exist, e.g. have not been created yet, or is deleted
                    todo_txt                varchar2(4000);
                    error_txt               varchar2(4000);
                    ret_txt                 varchar2(4000);     ---retur fra prossedyre
                    error_exc               exception;

                    http_status              varchar2(4000) :='501';    --FALLBACK
                                                                        -- 501 Not Implemented
                                                                        -- The server either does not recognize the request method, or it lacks the ability to fulfil the request. Usually this implies future availability (e.g., a new feature of a web-service API)

                    temp                    varchar2(4000);
                    d                       varchar2(4000);    --dummy for else i case statment
                    l_prosess               varchar2(4000);    
                    --------------
                    l_enhet_seq_no              varchar2(4000);
                    l_prev_enhet_seq_no         varchar2(4000);
                    l_var_bil_seq_no            varchar2(4000);
                    l_serie_seq_no              varchar2(4000);
                    l_location_seq_no           varchar2(4000);
                    l_vare_gruppe_seq_no        varchar2(4000);
                    l_pris_inkl_mva             varchar2(4000);
                    l_prod_nr                   varchar2(4000);
                    l_enhet_besk                varchar2(4000);
                    l_temp                      varchar2(4000);
                    --
                    l_paa_bil                   varchar2(4000);
                    --
                    l_dekk_antall               varchar2(4000);
                    l_actor_seq_no              varchar2(4000);
                    l_dekk_type_seq_no          varchar2(4000);
                    l_dekk_monster_dybde_1      varchar2(4000);
                    l_dekk_monster_dybde_2      varchar2(4000);
                    l_dekk_produsert_aar_1      varchar2(4000);
                    l_dekk_produsert_aar_2      varchar2(4000);
                    l_dekk_load_index_1         varchar2(4000);
                    l_dekk_load_index_2         varchar2(4000);
                    l_felg_type_seq_no          varchar2(4000);
                    ---------
                    l_pip                       varchar2(4000);
                    l_pda_iphone_pre_seq_no     number(8);
                    ---------
                    l_file_name             varchar2(4000);
                    l_content_type          varchar2(4000) := :content_type;     --Header: key=Content-Type value=application/octet-stream   application/x-www-form-urlencoded  'image/jpg'
                    l_blob                  blob := :body;
                    l_body_kb               varchar2(25) :=nvl( to_char( round(dbms_lob.GETLENGTH(l_blob)/1024,2)  ) ,'-tomt-' ); 
                    l_body_txt              varchar2(4000);-- := UTL_RAW.CAST_TO_VARCHAR2(l_blob);                                                  
                begin
                    --test
                            --owa_util.mime_header ('application/json', true);
                            --                htp.p('hei');
                            -- error_txt := error_txt||  ' content_type='||:content_type;
                            -- error_txt := error_txt||  ' current_user='||:current_user;
                            -- error_txt := error_txt||  ' page_size='   ||:page_size;
                            -- error_txt := error_txt||  ' page_offset=' ||:page_offset;
                            -- error_txt := error_txt||  ' row_offset='  ||:row_offset;
                            -- error_txt := error_txt||  ' row_count='   ||:row_count;
                            -- error_txt := error_txt||  ' body='        ||nvl(to_char(dbms_lob.GETLENGTH(:body)/1024/1024),'0');
                            -- -- error_txt := error_txt||  ' path_info' ||owa_util.get_cgi_env('PATH_INFO');               
                            -- --
                            -- error_txt := error_txt||  ' setvalues='  ||:setvalues;
                            -- raise error_exc;

                    --1) INPUT VALIDATION
                        begin
                            l_body_txt := UTL_RAW.CAST_TO_VARCHAR2(l_blob); 
                            --Hvis l_blob er tom ->rett ut til ytterste exception 
                            --Derfor fikser vi det her
                            exception when others  then temp :='';
                        end;

                        todo_txt :=  'ORDS-1 INPUT VALIDATION: i)Content-Type '||:content_type  ||
                                                      ' ii)Body '         ||l_body_kb      ||'kb '||l_body_txt ||' '||
                                                     ' iii)Header key=setvalues, values='||nvl(:setvalues,
                                                                                    'is empty expects: key=setvalues, value={'||chr(39)||'key1'||chr(39)||':'||chr(39)||'value1'||chr(39)||','
                                                                                                                              ||chr(39)||'key2'||chr(39)||':'||chr(39)||'value2'||chr(39)||',...} )');
                        --NB rekkefølge --
                        error_txt := error_txt || todo_txt; 
                        todo_txt  := todo_txt  || todo_txt;

                        if :setvalues is null then 
                            http_status :='400'; 
                            raise error_exc; 
                        end if;

                    --2) PARSE                        
                        select upper(json_value(:setvalues, '$.prosess'                     returning varchar2)) into l_prosess                     from dual;  
                                                                                                                                                                if l_prosess is null then 
                                                                                                                                                                        error_txt   :=error_txt ||' ORDS-2 INPUT VALIDATION: prosess [UPD/INS/IMG] må ALLTID oppgis'; 
                                                                                                                                                                        http_status :='400'; 
                                                                                                                                                                        raise error_exc;
                                                                                                                                                                else
                                                                                                                                                                        error_txt   :=error_txt ||' ORDS-2 INPUT VALIDATION: prosess='||l_prosess||' oppgitt OK' ; 
                                                                                                                                                                        todo_txt    := todo_txt ||' ORDS-2 INPUT VALIDATION: prosess='||l_prosess||' oppgitt OK' ; 
                                                                                                                                                                end if;
                        select upper(json_value(:setvalues, '$.l_enhet_seq_no'              returning varchar2)) into l_enhet_seq_no                from dual;
                        select upper(json_value(:setvalues, '$.l_prev_enhet_seq_no'         returning varchar2)) into l_prev_enhet_seq_no           from dual;
                        select upper(json_value(:setvalues, '$.l_var_bil_seq_no'            returning varchar2)) into l_var_bil_seq_no              from dual;
                        select upper(json_value(:setvalues, '$.l_serie_seq_no'              returning varchar2)) into l_serie_seq_no                from dual;
                        select upper(json_value(:setvalues, '$.l_location_seq_no'           returning varchar2)) into l_location_seq_no             from dual;
                        select upper(json_value(:setvalues, '$.l_vare_gruppe_seq_no'        returning varchar2)) into l_vare_gruppe_seq_no          from dual;
                        select upper(json_value(:setvalues, '$.l_pris_inkl_mva'             returning varchar2)) into l_pris_inkl_mva               from dual;
                        select upper(json_value(:setvalues, '$.l_prod_nr'                   returning varchar2)) into l_prod_nr                     from dual;
                        select upper(json_value(:setvalues, '$.l_enhet_besk'                returning varchar2)) into l_enhet_besk                  from dual;
                        select upper(json_value(:setvalues, '$.l_temp'                      returning varchar2)) into l_temp                        from dual;
                        --
                        select upper(json_value(:setvalues, '$.l_paa_bil'                   returning varchar2)) into l_paa_bil                     from dual;
                        --
                        select upper(json_value(:setvalues, '$.l_dekk_antall'               returning varchar2)) into l_dekk_antall                 from dual;
                        select upper(json_value(:setvalues, '$.l_actor_seq_no'              returning varchar2)) into l_actor_seq_no                from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_type_seq_no'          returning varchar2)) into l_dekk_type_seq_no            from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_monster_dybde_1'      returning varchar2)) into l_dekk_monster_dybde_1        from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_monster_dybde_2'      returning varchar2)) into l_dekk_monster_dybde_2        from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_produsert_aar_1'      returning varchar2)) into l_dekk_produsert_aar_1        from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_produsert_aar_2'      returning varchar2)) into l_dekk_produsert_aar_2        from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_load_index_1'         returning varchar2)) into l_dekk_load_index_1           from dual;
                        select upper(json_value(:setvalues, '$.l_dekk_load_index_2'         returning varchar2)) into l_dekk_load_index_2           from dual;
                        select upper(json_value(:setvalues, '$.l_felg_type_seq_no'          returning varchar2)) into l_felg_type_seq_no            from dual;
                        select upper(json_value(:setvalues, '$.l_pip'                       returning varchar2)) into l_pip                         from dual;
                        --parse log
                                                                             temp:='';
                        case when l_prosess                 is not null then temp:= temp||'prosess'                     ||'='||l_prosess                ||' ';  else d:='nop'; end case;
                        case when l_enhet_seq_no            is not null then temp:= temp||'l_enhet_seq_no'              ||'='||l_enhet_seq_no           ||' ';  else d:='nop'; end case;
                        case when l_prev_enhet_seq_no       is not null then temp:= temp||'l_prev_enhet_seq_no'         ||'='||l_prev_enhet_seq_no      ||' ';  else d:='nop'; end case;
                        case when l_var_bil_seq_no          is not null then temp:= temp||'l_var_bil_seq_no'            ||'='||l_var_bil_seq_no         ||' ';  else d:='nop'; end case;
                        case when l_serie_seq_no            is not null then temp:= temp||'l_serie_seq_no'              ||'='||l_serie_seq_no           ||' ';  else d:='nop'; end case;
                        case when l_location_seq_no         is not null then temp:= temp||'l_location_seq_no'           ||'='||l_location_seq_no        ||' ';  else d:='nop'; end case;
                        case when l_vare_gruppe_seq_no      is not null then temp:= temp||'l_vare_gruppe_seq_no'        ||'='||l_vare_gruppe_seq_no     ||' ';  else d:='nop'; end case;
                        case when l_pris_inkl_mva           is not null then temp:= temp||'l_pris_inkl_mva'             ||'='||l_pris_inkl_mva          ||' ';  else d:='nop'; end case;
                        case when l_prod_nr                 is not null then temp:= temp||'l_prod_nr'                   ||'='||l_prod_nr                ||' ';  else d:='nop'; end case;
                        case when l_enhet_besk              is not null then temp:= temp||'l_enhet_besk'                ||'='||l_enhet_besk             ||' ';  else d:='nop'; end case;
                        case when l_temp                    is not null then temp:= temp||'l_temp'                      ||'='||l_temp                   ||' ';  else d:='nop'; end case;
                        ----
                        case when l_paa_bil                 is not null then temp:= temp||'l_paa_bil'                   ||'='||l_paa_bil                ||' ';  else d:='nop'; end case;
                        ----
                        case when l_dekk_antall             is not null then temp:= temp||'l_dekk_antall'               ||'='||l_dekk_antall            ||' ';  else d:='nop'; end case;
                        case when l_actor_seq_no            is not null then temp:= temp||'l_actor_seq_no'              ||'='||l_actor_seq_no           ||' ';  else d:='nop'; end case;
                        case when l_dekk_type_seq_no        is not null then temp:= temp||'l_dekk_type_seq_no'          ||'='||l_dekk_type_seq_no       ||' ';  else d:='nop'; end case;
                        case when l_dekk_monster_dybde_1    is not null then temp:= temp||'l_dekk_monster_dybde_1'      ||'='||l_dekk_monster_dybde_1   ||' ';  else d:='nop'; end case;
                        case when l_dekk_monster_dybde_2    is not null then temp:= temp||'l_dekk_monster_dybde_2'      ||'='||l_dekk_monster_dybde_2   ||' ';  else d:='nop'; end case;
                        case when l_dekk_produsert_aar_1    is not null then temp:= temp||'l_dekk_produsert_aar_1'      ||'='||l_dekk_produsert_aar_1   ||' ';  else d:='nop'; end case;
                        case when l_dekk_produsert_aar_2    is not null then temp:= temp||'l_dekk_produsert_aar_2'      ||'='||l_dekk_produsert_aar_2   ||' ';  else d:='nop'; end case;
                        case when l_dekk_load_index_1       is not null then temp:= temp||'l_dekk_load_index_1'         ||'='||l_dekk_load_index_1      ||' ';  else d:='nop'; end case;
                        case when l_dekk_load_index_2       is not null then temp:= temp||'l_dekk_load_index_2'         ||'='||l_dekk_load_index_2      ||' ';  else d:='nop'; end case;
                        case when l_felg_type_seq_no        is not null then temp:= temp||'l_felg_type_seq_no'          ||'='||l_felg_type_seq_no       ||' ';  else d:='nop'; end case;
                        ----
                        case when l_pip                     is not null then temp:= temp||'l_pip'                       ||'='||l_pip                    ||' ';  else d:='nop'; end case;
                        ----
                        case when l_file_name               is not null then temp:= temp||'l_file_name'                 ||'='||l_file_name              ||' ';  else d:='nop'; end case;

                        error_txt := error_txt || ' ORDS-3 INPUT VALIDATION: PARSE RESULTS '||temp;
                        todo_txt  := todo_txt  || ' ORDS-2 INPUT VALIDATION: prosess oppgitt OK ORDS-3 INPUT VALIDATION: PARSE RESULTS '||temp;

                        --listing
                        --error_txt:= todo_txt; raise error_exc;

                    --3) EXECUTE
                        case 
                        when l_prosess in ('UPD', 'INS', 'IMG','QR_1','QR_2', 'U1','PLUKKE_HOLD','PLUKKE_SLETT','PLUKKE_UPD','PLUKKE','PLUKK_NY') then
                            --alt 1
                                if l_prosess='IMG' and l_body_kb='-tomt-' then   error_txt:= todo_txt ||' ORDS-4 INPUT VALIDATION: PARSE RESULTS bilde er tomt '; http_status:='400'; raise error_exc; end if;
                            
                            --alt 2
                                ola.pr_api_post( 
                                        l_prosess               ,
                                        l_enhet_seq_no          ,
                                        l_prev_enhet_seq_no     ,
                                        l_var_bil_seq_no        ,
                                        l_serie_seq_no          ,
                                        l_location_seq_no       ,
                                        l_vare_gruppe_seq_no    ,
                                        l_pris_inkl_mva         ,
                                        l_prod_nr               ,
                                        l_enhet_besk            ,
                                        l_temp                  ,
                                        ----
                                        l_paa_bil               ,
                                        ----
                                        l_dekk_antall           ,
                                        l_actor_seq_no          ,
                                        l_dekk_type_seq_no      ,
                                        l_dekk_monster_dybde_1  ,
                                        l_dekk_monster_dybde_2  ,
                                        l_dekk_produsert_aar_1  ,
                                        l_dekk_produsert_aar_2  , 
                                        l_dekk_load_index_1     , 
                                        l_dekk_load_index_2     , 
                                        l_felg_type_seq_no      , 
                                        ---------
                                        l_file_name             ,
                                        l_content_type          ,
                                        l_blob                  ,
                                        http_status             ,   -- out
                                        ret_txt  );                 -- out


                                if http_status not in ('200','201')  then 
                                    error_txt:= error_txt ||' ORDS-4 PR RETURNS ERROR : '  ||ret_txt; raise error_exc;
                                else  
                                    todo_txt := todo_txt  ||' ORDS-4 PR RETURNS SUCESS : ' ||ret_txt;
                                end if;

                        when l_prosess in ('IMGcccc') then
                            error_txt := error_txt || ' ORDS-4 INPUT VALIDATION: EXCECUTE pr_api_post for '||l_prosess||' IKKE KLAR ENDA...';
                            raise error_exc;
                            -- ola.pr_rest ('blobs_insert',:enhet_seq_no,null,null,:file_name,:content_type,:body,:blobs_seq_no,sysdate,ret);        
                        when l_prosess in ('PIP') then
                            begin 
                                --1 kommaseparert -> linje --> pda_iphone_details
                                    l_pda_iphone_pre_seq_no := pda_iphone_pre_seq_no.nextval;

                                    --raise_application_error(-20010,'Test');

                                    --https://stackoverflow.com/questions/38371989/how-to-convert-comma-separated-values-to-rows-in-oracle
                                    insert into pda_iphone_details(pda_iphone_pre_seq_no, scan_id, nr, org_scan_id) 
                                        with tbl1 as (  
                                        select l_pda_iphone_pre_seq_no  as id, 
                                               l_pip                    as value 
                                        from dual )
                                        --with tbl1 as (  select 11 as id, 'AA, UT, BT, SK, SX' as value from dual )
                                        , med_d as (
                                                select distinct 
                                                    id                                              as id, 
                                                    trim(regexp_substr(value,'[^,]+', 1, level) )   as value, 
                                                    level                                           as nr
                                                from tbl1
                                                connect by regexp_substr(value, '[^,]+', 1, level) is not null
                                                order by id, level)
                                        select  id,
                                                case when upper(substr(value,1,1))='D' then 
                                                    substr(value,2,length(value))
                                                else
                                                    value
                                                end,
                                                nr,
                                                l_pip
                                        from med_d;                         

                                --2 fyrer i gang gamle logikk
                                    insert into pda_iphone_pre(pda_iphone_pre_seq_no,metod) values(l_pda_iphone_pre_seq_no,'SHELF');

                                    http_status :='201';
                                    todo_txt := todo_txt  ||' ORDS-4.1 PDA-iPhone RETURNS SUCESS : pda_iphone_pre_seq_no=' ||l_pda_iphone_pre_seq_no;

                                --2
                            exception when others then
                                http_status :='400';
                                error_txt:= error_txt ||' ORDS-4 PDA-iPhone RETURNS ERROR : pda_iphone_pre_seq_no=' ||l_pda_iphone_pre_seq_no;
                                raise error_exc;  
                            end;                        
                        end case;                                        

                    --4) Clean up
                                                  :ls_status := http_status;  :ls_forward := 'ORDS => SUCESS: '   ||todo_txt;

                    exception when error_exc then :ls_status := http_status;  :ls_forward := 'ORDS => ERROR_EXC: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm;
                              when others    then :ls_status := http_status;  :ls_forward := 'ORDS => ERROR_OTH: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm;
                    -- raise_application_error(-20001,out_feil);   
                end;                
         
        --3.b4)  pipe-deler                                     POST,  Source Type: PL/SQL
                select max(location_seq_no), min(location_seq_no), max(loc_id), min (loc_id) from location;
                    11092   -1  V_UTLÅN 10D1A

                select max(serie_seq_no), min(serie_seq_no), max(serie_no), min(serie_no) from serie;
                    315287  1   156139  1

                Alle D5x oppover har QR kode D5123456  barcode 5123456

                select loc_id from location where loc_id like 'D%' order by 1;
                    0
                    



        --3.b4)  bildeler_query                                 POST,  Source Type: PL/SQL
            --Test må gjøres i PostMan
                https://api.qrv.no/ords/obas/bildeler_query
                Header setvalues =  {'prosess':'UPD','l_prev_enhet_seq_no':'353475','l_var_bil_seq_no':'','l_serie_seq_no':'104323','l_location_seq_no':'0','l_vare_gruppe_seq_no':'40061','l_dekk_antall':'4','l_pris_inkl_mva':'100','l_prod_nr':'prod','l_enhet_besk':'besk','l_actor_seq_no':'1760','l_dekk_type_seq_no':'14','l_dekk_monster_dybde_1':'3','l_dekk_monster_dybde_2':'4','l_dekk_produsert_aar_1':'2014','l_dekk_produsert_aar_2':'2015','l_dekk_load_index_1':'index1','l_dekk_load_index_2':'index2','l_felg_type_seq_no':''}          

            --Parameter
                setvalues               setvalues   IN      HTTP header     String
                X-APEX-FORWARD          ls_forward  OUT     Response Body   String
                X-APEX-STATUS-CODE      ls_status   OUT     HTTP header     String

                --APEX
                    prev_enhet_seq_no       v_api_lov_enhet

            --Source
                declare
                    -- 200 Request was received and understood and is being processed
                    -- 201 Created, The request has been fulfilled, resulting in the creation of a new resource.
                    -- 400 Bad Request, The server cannot or will not process the request due to an apparent client error, e.g. object exist already
                    -- 404 Not Found, Object which is updated does not exist, e.g. have not been created yet, or is deleted
                    -- 501 Not Implemented, The server either does not recognize the request method, or it lacks the ability to fulfil the request. Usually this implies future availability (e.g., a new feature of a web-service API)
                    todo_txt                varchar2(4000);
                    error_txt               varchar2(4000);
                    error_exc               exception;

                    http_status              varchar2(4000) :='501';
                                                                                                                                     
                    temp                    varchar2(4000);
                    d                       varchar2(4000);    --dummy for else i case statment
                    l_prosess               varchar2(4000);    
                    --------------
                    l_mobil_no              varchar2(4000);
                    l_seq_no                varchar2(4000);
                    ---------
                    l_file_name             varchar2(4000);
                    l_content_type          varchar2(4000) := :content_type;     --Header: key=Content-Type value=application/octet-stream   application/x-www-form-urlencoded  'image/jpg'
                    l_blob                  blob := :body;
                    l_body_kb               varchar2(25) :=nvl( to_char( round(dbms_lob.GETLENGTH(l_blob)/1024,2)  ) ,'-tomt-' ); 
                    l_body_txt              varchar2(4000);-- := UTL_RAW.CAST_TO_VARCHAR2(l_blob);                                                  
                begin
                    --test
                        --Header  https://api.qrv.no/obas/bildeler_query
                            --    setvalues=  {'prosess':'UPD','l_mobil_no':'93664977', 'l_seq_no':'1313'}
                            --owa_util.mime_header ('application/json', true);
                            --                htp.p('hei');
                            -- error_txt := error_txt||  ' content_type='||:content_type;
                            -- error_txt := error_txt||  ' current_user='||:current_user;
                            -- error_txt := error_txt||  ' page_size='   ||:page_size;
                            -- error_txt := error_txt||  ' page_offset=' ||:page_offset;
                            -- error_txt := error_txt||  ' row_offset='  ||:row_offset;
                            -- error_txt := error_txt||  ' row_count='   ||:row_count;
                            -- error_txt := error_txt||  ' body='        ||nvl(to_char(dbms_lob.GETLENGTH(:body)/1024/1024),'0');
                            -- -- error_txt := error_txt||  ' path_info' ||owa_util.get_cgi_env('PATH_INFO');               
                            -- --
                            -- error_txt := error_txt||  ' setvalues='  ||:setvalues;
                            -- raise error_exc;

                    --1) INPUT VALIDATION
                        begin
                            l_body_txt := UTL_RAW.CAST_TO_VARCHAR2(l_blob); 
                            --Hvis l_blob er tom ->rett ut til ytterste exception 
                            --Derfor fikser vi det her
                            exception when others  then temp :='';
                        end;

                        todo_txt :=  'INPUT VALIDATION 1: i)Content-Type '||:content_type  ||
                                                      ' ii)Body '         ||l_body_kb      ||'kb '||l_body_txt ||' '||
                                                     ' iii)Header key=setvalues, values='||nvl(:setvalues,
                                                                                    'is empty expects: key=setvalues, value={'||chr(39)||'key1'||chr(39)||':'||chr(39)||'value1'||chr(39)||','
                                                                                                                              ||chr(39)||'key2'||chr(39)||':'||chr(39)||'value2'||chr(39)||',...} )');
                        error_txt :=  todo_txt;    
                        if :setvalues is null then 
                            http_status :='400'; 
                            raise error_exc; 
                        end if;

                    --2) PARSE
                        select upper(json_value(:setvalues, '$.prosess'                    returning varchar2)) into l_prosess                   from dual; if l_prosess      is null then error_txt:=error_txt||' INPUT VALIDATION 2: prosess [UPD/INS/IMG] må ALLTID oppgis'; http_status :='400'; raise error_exc; end if;
                        select upper(json_value(:setvalues, '$.l_mobil_no'                 returning varchar2)) into l_mobil_no                  from dual;
                        select upper(json_value(:setvalues, '$.l_seq_no'                   returning varchar2)) into l_seq_no                    from dual;                 
                        --parse log
                                                                             temp:='';
                        case when l_prosess                 is not null then temp:= temp||'prosess'                     ||'='||l_prosess                ||' ';  else d:='nop'; end case;
                        case when l_mobil_no                is not null then temp:= temp||'l_mobil_no'                  ||'='||l_mobil_no               ||' ';  else d:='nop'; end case;
                        case when l_seq_no                  is not null then temp:= temp||'l_seq_no'                    ||'='||l_seq_no                 ||' ';  else d:='nop'; end case;

                        case when l_file_name               is not null then temp:= temp||'l_file_name'                 ||'='||l_file_name              ||' ';  else d:='nop'; end case;

                        todo_txt  := todo_txt || ' INPUT VALIDATION 3: PARSE RESULTS '||temp;
                        error_txt :=             ' INPUT VALIDATION 3: PARSE RESULTS '||temp;

                        --listing
                        --error_txt:= todo_txt; raise error_exc;

                    --3) EXECUTE
                        case 
                        when l_prosess in ('UPD') then
                            ola.pr_query_ins (l_mobil_no, l_seq_no,error_txt);
                            if error_txt like 'FEIL%' then http_status :=400;
                            else    http_status := 201;
                            end if;

                            if http_status <> '201'  then 
                                error_txt:= todo_txt ||' PR VALIDATION 1: ' ||error_txt; raise error_exc;
                            else  
                                todo_txt := todo_txt ||' PR VALIDATION 2: ' ||error_txt;
                            end if;
                        when l_prosess in ('IMGcccc') then
                            error_txt := todo_txt || ' 3) EXCECUTE pr_rest  IKKE KLAR ENDA...';
                            raise error_exc;
                            -- ola.pr_rest ('blobs_insert',:enhet_seq_no,null,null,:file_name,:content_type,:body,:blobs_seq_no,sysdate,ret);            
                        end case;                                        

                    --4) Clean up
                        :ls_status  := http_status;
                        :ls_forward := todo_txt;

                    exception when error_exc then :ls_status := http_status;  :ls_forward := 'ERROR_EXC => {ERROR_TXT: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm||'}';
                              when others    then :ls_status := http_status;  :ls_forward := 'ERROR_OTH => {ERROR_TXT: '||error_txt||', SQLCODE: '||sqlcode||', SQLERRM: '||sqlerrm||'}';
                    -- raise_application_error(-20001,out_feil);   
                end;
        


        --3.c)   bildeler_lookup/?{sok_uri}                     GET,   Source Type: Query (depricated)
            --Test 
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lookup/?d
                https://api.qrv.no/ords/obas/bildeler_lookup/?d

            --Parameter
                sok_uri             sok_uri     IN  URI            String    

            --Source
                select  
                                rownum -1               as no,
                                --------------------------------------------------------------------------------------------------
                                enhet_seq_no            ,
                                sok_uri                 ,
                                prosess                 ,
                                code                    ,
                                --------------------------------------------------------------------------------------------------
                                key1              ,         key2             ,      key3             ,       desc1         ,         value              --1  -  5
                      from (        
                        select * 
                        from (    
                            --Nr 1 driver              
                                select     
                                    -1                                                                     as enhet_seq_no           , 
                                    case when :sok_uri    is not null then :sok_uri    else null end       as sok_uri                ,
                                    json_value(:sok_uri, '$.prosess'               returning varchar2)     as prosess                ,                    
                                    'Nr 1 driver'                                                          as code                   ,
                                    null key1,
                                    null key2,
                                    null key3,
                                    null desc1,
                                    null value
                                from dual
                                union
                            --Nr 2 vare_gruppe_seq
                                select    
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 2 vare_gruppe_seq'                                                  as code                   ,
                                    vare_gruppe_seq_no,
                                    null,
                                    null,
                                    vare_gruppe,
                                    vare_gruppe_id
                                from ola.v_vare_gruppe
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('vare_gruppe_seq_no')       then 999 else 0 end
                                  and dummy='N'
                                union
                            --Nr 3 location_seq_no
                                select    
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 3 location_seq_no'                                                  as code                   ,
                                    location_seq_no,
                                    null,
                                    null,
                                    null,
                                    loc_id
                                from ola.location
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('location_seq_no')          then 999 else 0 end
                                union
                            --Nr 4 enhet_kval_seq_no
                                select    
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 4 enhet_kval_seq_no'                                                as code                   ,
                                    enhet_kval_seq_no,
                                    null,
                                    null,
                                    null,
                                    kval_id
                                from ola.enhet_kvalitet
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('enhet_kval_seq_no')        then 999 else 0 end
                                union
                            --Nr 5 vendor_seq_no
                                select    
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 5 vendor_seq_no'                                                    as code                   ,
                                    vendor_seq_no,
                                    null,
                                    null,
                                    null,
                                    vendor
                                from ola.vendor
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('vendor_seq_no')            then 999 else 0 end
                                  and vendor <>'USPES'
                                union
                            --Nr 6 vendor_data_seq_no
                                select
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 6 vendor_data_seq_no'                                               as code                   ,
                                    vendor_data_seq_no,
                                    vendor_seq_no,
                                    vare_gruppe_seq_no,
                                    null,
                                    vendor_data_no
                                from ola.vendor_data
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('vendor_data_seq_no')       then 999 else 0 end
                                union
                            --Nr 7 loc_vrak
                                select
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 7 loc_vrak'                                                         as code                   ,
                                    location_seq_no,
                                    null,
                                    null,
                                    null,
                                    loc_id
                                from ola.location
                                where 1=1
                                    and rownum <= case when json_value(:sok_uri, '$.prosess') in ('loc_vrak')                then 999 else 0 end
                                    -- V_MOTATT          -1     Brukes for å ta bileder å dermed få nytt vrak-nr
                                    -- V_SELVPLUKK      695     VRAK PLASERT PÅ SELVPLUKK
                                    -- V_KLAR_PRESSING  697     VRAK SOM ER KLAR FOR PRESSING
                                    -- V_UTE2           1740    USANERTE VRAK SOM VENTER PÅ Å BLI SANERT
                                    -- V_UTE2_HOGGET    1906    VRAK KUN KAROSSERI SOM STÅR I V_UTE2
                                    -- V_EKSTERN        3300    vrak for henting, har ikke vrak.nr før fullstendig registrering
                                    -- V_INNE1          10179   BILER SOM STÅR INNE FØRSTE ETASJE
                                    -- V_INNE3          10180   BILER SOM STÅR INNE TREDJE ETASJE
                                    -- V_INNE2          10181   BILER SOM STÅR UNDER KUNDEMOTAK
                                    -- V_INNE1_HOGGET   10182   HUGGEDE BILER SOM STÅR I FØRSTE ETASJE
                                    -- V_INNE           10184   KODE FOR Å SØKE OPP ALLE V_INNE VRAKENE
                                    -- V_UTE2_INN       10185   BILER SOM STÅR I V_UTE2 SOM SKAL HUGGES
                                    -- V_INNE2_HOGGET   10186   HUGGEDE BILER SOM STÅR UNDER KUNDEMOTAK
                                    --and location_seq_no in (-1, 695, 697, 1740, 1905, 1906, 1907, 3220, 3300, 3301)
                                    and loc_id like 'V%' 
                                    and location_seq_no is not null
                                union
                                --2016_01_15 legger inn -1 slik at det kan brukes til å slette lagerplass
                                select
                                    null                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 7 loc_vrak'                                                         as code                   ,
                                    -99                                                                     as location_seq_no,
                                    null,
                                    null,
                                    null,
                                    ' - ingen lager loc.-'                                                   as loc_id
                                from dual
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('loc_vrak')                then 999 else 0 end   
                union
                            select    
                                    rownum                                                                    as enhet_seq_no           ,
                                    null                                                                    as sok_uri                ,
                                    null                                                                    as prosess                , 
                                    'Nr 8 selvplukk_priser'                                                 as code                   ,
                                    null,
                                    null,
                                    null,
                                    substr(type,1,55),
                                    to_char(pris)
                                from ola.t_selvplukk
                                where 1=1
                                  and rownum <= case when json_value(:sok_uri, '$.prosess') in ('selvplukk_priser')       then 999 else 0 end  
                        )
                        order by nvl(enhet_seq_no,0), desc1, value    
                      )

        --3.d)   v_bildeler_sok/{sok}                           GET,   Source Type: Query (depricated) Pagenation Size 50
            --Test 
                https://api.qrv.no/ords/obas/v_bildeler_sok/V25245
                https://obas.qrv.no/ords/apex_obas/v1/v_bildeler_sok/V25245

            --Parameter
                sok                 uri         IN  URI            String    

            --Source
                --laget ...
                --vrak som finner eller V_Ekstern som ikke har fått location_seq_no enda
                /*
                  Kall                    GET
                  Source Type             Query
                  Format                  JSON
                  Requires Secure Access  No
                  Pagination Size         9999
                  Parameters
                     Name            Binde Variable Name   Access Method   Source Type     Parameter Type
                     sok             sok                   IN              URI             String

                  http://api.qrv.no/ords/obas/v_bildeler_sok/V26150
                */
                  select  
                      enhet_seq_no,
                      serie_seq_no,
                      serie_no,
                      location_seq_no,
                      replace(loc_id,' ','_') as loc_id,
                      decode(miljo_klarert_id,'J','J','N') as miljo_klarert_id,
                      v0_fab_navn,
                      v0_type_id,
                      v1_chassis_no,
                      v1_reg_no,
                      enhet_besk
                  from ola.v_bildeler
                  where serie_no like upper(:sok)||'%' 
                  and location_seq_no is not null 
                  order by serie_no


        --3.d.1) location_vrak/                                 GET,   Source Type: Query (depricated) Pagenation Size 25
            --Test 
                https://obas.qrv.no/ords/obas/v1/location_vrak/    		--ok obas6 2020-05-02
                https://api.qrv.no/ords/obas/location_vrak/             --ok obas6 2020-05-07

            --Parameter

            --Source
                --http://192.168.1.4:8080/apex/apex_obas/rest/location_vrak
                --http://79.161.63.42:443/apex/apex_obas/rest/location_vrak
                --roter til swift tatt ut 2015_12_12
                --2016_01_15 legger inn -1 slik at det kan brukes til å slette lagerplass
                select -1 as location_seq_no , ' - ingen lager loc.-' as loc_id from dual
                union
                select         location_seq_no ,replace(loc_id,' ','_') as loc_id from  ola.location 
                where loc_id like 'V%' 
                and location_seq_no is not null
                order by 2

        --3.d.2) location_vrak/{location_seq_no}                GET,   Source Type: Query (depricated)
            --Test 
                https://obas.qrv.no/ords/obas/v1/location_vrak/10239    --ok obas5 2020-02-19
                https://api.qrv.no/ords/obas/location_vrak/             --ok obas5 2020-02-19

            --Parameter
                location_seq_no     location_seq_no     IN      URI         Integer

            --Source
                --http://192.168.1.4:8080/apex/apex_obas/rest/location_vrak/3300
                --http://79.161.63.42:443/apex/apex_obas/rest/location_vrak/3300
                select         location_seq_no , 			   replace(loc_id,' ','_') as loc_id, from  ola.location where location_seq_no = :location_seq_no


        --3.g)   v_bildeler_motatt_ekstern/                     GET,   Source Type: Query (depricated)
            --Test 
                https://obas.qrv.no/ords/apex_obas/v1/v_bildeler_motatt_ekstern/
                https://obas.qrv.no/ords/apex_obas/v1/v_bildeler_motatt_ekstern/    --obas6
                https://api.qrv.no/ords/apex_obas/v1/v_bildeler_motatt_ekstern/

                https://api.qrv.no/ords/obas/v_bildeler_motatt_ekstern              --swift

                https://192.168.1.7:8443/ords/apex_obas/hr/employees/
                https://192.168.1.3:8080/ords/obas/blobs_list/300167



            --Parameter

            --Source
                --laget 2016-07-24  Ta bilder av vrak på plassen. Forutsetter at vrak er registerert som V_EKSTERN (i henteliste) eller V_MOTATT (i bildeleprogram med tilbod generert i UNI)
                /*
                  Kall                    GET
                  Source Type             Query
                  Format                  JSON
                  Requires Secure Access  No
                  Pagination Size         9999
                  Parameters
                     Name            Binde Variable Name   Access Method   Source Type     Parameter Type

                  http://api.qrv.no/ords/obas/v_bildeler_motatt_ekstern
                  fikset 2020-02-20 tatt vekk * og helle spesifisert kolonnene slik at parsingen til Per Ole ikke klikker
                */
                select 
                    enhet_seq_no
                    ,vare_gruppe_seq_no
                    ,del_vasket
                    ,serie_no
                    ,scroll_info
                    ,location_seq_no
                    ,loc_id
                    ,bilder_ant
                    ,reg_no
                    ,bil_info
                    ,bil_enhet
                    ,bil_vegdir
                    ,chassis_no_info
                    ,dato_inn
                from ola.v_api_vrak_motatt_ekstern
                --where serie_no like '%V36587%'

            --feil pr 2020-02-20
                --ok                                                  --feil
                --https://192.168.1.3:8080/ords/obas/               https://192.168.1.7:8443/ords/apex_obas/v1
                --        /v_bildeler_motatt_ekstern/                       /v_bildeler_motatt_ekstern/
                enhet_seq_no: 346844,                               enhet_seq_no: 348495,
                vare_gruppe_seq_no: 1,                              vare_gruppe_seq_no: 1,
                del_vasket: "VRAK",                                 del_vasket: "VRAK",
                serie_no: "V36284",                                 serie_no: "V36587",
                scroll_info: "motatt :MAZDA",                       scroll_info: "motatt :HYUNDAI",
                location_seq_no: -1,                                location_seq_no: -1,
                loc_id: "V_MOTATT",                                 loc_id: "V_MOTATT",
                bilder_ant: 2,                                      bilder_ant: 0,
                reg_no: "SD91163",                                  reg_no: "SD34351",
                bil_info: "MAZDA 323 2002 1999-2003",               bil_info: "HYUNDAI H1 2006 2005-2007",
                bil_enhet: "MAZDA 323 2002 1999-2003",              bil_enhet: "HYUNDAI H1 2006 2005-2007",
                bil_vegdir: " ",                                    bil_vegdir: "HYUNDAI H-1 HSV CRDI 4WD KMJWWH7JP 2006",
                                                                    bil_enhet_ekstern: " ",
                chassis_no_info: "ch.no: ikke tilgjengelig...",     chassis_no_info: "ch.no: KMJWWH7JP6U752622",
                                                                    chassis_no_enhet: "KMJWWH7JP6U752622",
                                                                    chassis_no_vegdir: "KMJWWH7JP6U752622",
                dato_inn: "2020-01-04T08:57:05Z"                    dato_inn: "2020-02-19T15:23:02Z"
        


   
        --3.d)   blobs_list_{enhet_seq_no}                      GET,   Source Tyep: Feed  (depricated)    
            --Test 
                https://192.168.1.7:8443/ords/apex_obas/v1/blobs_list/300167
                https://obas.qrv.no/ords/apex_obas/v1/blobs_list/300167
                https://api.qrv.no/ords/obas/blobs_list/300167
				https://192.168.1.3:8080/ords/obas/blobs_list/300167

				https://obas.qrv.no/ords/obas/v1/blobs_list/{enhet_seq_no}

                https://192.168.1.3:8080/ords/obas/blobs_list/300167				--ok obas4 2020-05-02
				https://192.168.1.3:8080/ords/obas/blobs_list/single/141078			--ok child til linje over obas4 2020-05-02

				https://obas.qrv.no/ords/obas/v1/blobs_list/300167					--ok obas6 2020-05-02
				https://192.168.1.3:8080/ords/obas/blobs_list/single/141078			--feil child til linje over obas4 2020-05-02

                SELECT JSON_VALUE('{a:100}', '$.a' RETURNING NUMBER) AS value   FROM DUAL;
                SELECT JSON_VALUE('{a:"\/"}', '$.a' ) AS value   FROM DUAL;

                https://api.qrv.no/ords/obas/blobs_list_                  <-"nytt kall pr 2020-05-07 ungår esscaping av forward slash"

            --Parameter

            --Source
                /*
                  Kall                    GET
                  Source Type             Feed
                  Requires Secure Access  No
                  Pagination Size         9999
                  Parameters
                    Name            Binde Variable Name   Access Method   Source Type     Parameter Type
                    ----
                
                  http://api.qrv.no/obas/blobs_list/1
                */
                  select 'blobs_list_single_'||enhet_blobs.blobs_seq_no as blobs_seq_no, blobs.apex_app_files_mime_type as apex_app_files_mime_type
                  from ola.enhet_blobs enhet_blobs,
                       blobs.blobs     blobs
                  where enhet_blobs.blobs_seq_no = blobs.blobs_seq_no
                  and enhet_blobs.enhet_seq_no = :enhet_seq_no
                  --default rekkefølge første bilde først
                  order by decode(enhet_blobs.sort_order,null,99999999+abs(enhet_blobs.blobs_seq_no),enhet_blobs.sort_order)

        --3.e)   blobs_list/single/{blobs_seq_no}               GET,   Source Type: Media Resource   NBNB  Pagenation Size må settes f.eks til 999 slik at det kommer frem noe

            --Test 
                https://192.168.1.3:8080/ords/obas/blobs_list/single/141074
                https://192.168.1.7:8443/ords/apex_obas/v1/blobs_list/single/141074
                https://obas.qrv.no/ords/apex_obas/v1/blobs_list/single/141074
                https://api.qrv.no/ords/obas/blobs_list/single/141074
                https://192.168.1.3:8080/ords/obas/blobs_list/300167				--ok obas4 2020-05-02
				https://192.168.1.3:8080/ords/obas/blobs_list/single/141078			--ok child til linje over obas4 2020-05-02

				https://obas.qrv.no/ords/obas/v1/blobs_list/300167					--ok obas6 2020-05-02
				https://192.168.1.3:8080/ords/obas/blobs_list/single/141078			--feil child til linje over obas4 2020-05-02
                https://obas.qrv.no/ords/obas/v1/blobs_list/single/141078


                --Feilmelding kun med https://192.168.1.7:8443/ords/apex_obas/v1/blobs_list/single/300167
                The request could not be processed because an error occurred whilst attempting to evaluate the SQL statement associated with this resource. 
                Please check the SQL statement is correctly formed and executes without error. SQL Error Code: ORA-01722: ugyldig tall , Error Message: {2}.

                    sqlplus ola/ola@192.168.1.5/pdbobas.bildeler.net
                    select apex_app_files_mime_type as content_type
                           --,blobs as image
                    from   blobs.blobs     blobs
                    where blobs_seq_no = 141078 --:blobs_seq_no


            --Parameter

            --Source
                  /*
                    Kall                    GET
                    Source Type             Media Resource
                    Requires Secure Access  No
                    Pagination Size         9999
                    Parameters
                      Name            Binde Variable Name   Access Method   Source Type     Parameter Type
                      ----              

                    http://api.qrv.no/obas/blobs_list/single/1
                  */
                select apex_app_files_mime_type as content_type
                       ,blobs as image
                from   blobs.blobs     blobs
                where blobs_seq_no = :blobs_seq_no
        
                

        --3.f)   enhet/{enhet_seq_no}/{location_seq_no}         GET,   Source Type: PL/SQL
            --Test må gjøres i PostMan
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?{sok_uri}
                https://obas.qrv.no/ords/apex_obas/v1/bildeler_lager/?
                https://api.qrv.no/ords/obas/bildeler_lager/?


                tester på vrak V25245

            --Parameter
                enhet_seq_no        enhet_seq_no        IN  URI     Integer 
                miljo_klarert_id    miljo_klarert_id    IN  URI     String

            --Source        
                begin
                  --http://79.161.63.42:443/apex/apex_obas/rest/enhet/87643/1907

                  --insert into ola.test(enhet_seq_no,serie_seq_no,merknad) 
                  --values(ola.enhet_seq_no.nextval, :enhet_seq_no, :location_seq_no);

                --20 12 2015 satt i produksjon endrer enhet_rest med enhet
                --15 01 2015 lar -1 indikere at lagerplass skal slettes
                  update ola.enhet set location_seq_no = decode(:location_seq_no,-1,null,:location_seq_no)
                  where enhet_seq_no =:enhet_seq_no;
                end;

        --3.g)   priser_selvplukk                               GET,   Source Type: PL/SQL
            --Test må gjøres i PostMan
                https://api.qrv.no/obas/priser_selvplukk

                
            --Parameter

            --Source        
                select * from bildeler.t_selvplukk order by 2,3,4

        --3.h)   deler_selvplukk                                GET,   Source Type: PL/SQL

        --enhet_miljo

        --bildeler/?{sok_uri}
        
            https://192.168.1.3:8080/ords/obas/bildeler/?%7B%27prosess%27:%27D3%27%2C%27s_fri_tekst%27:%27saab+lys%27%7D&page=1%22
            http://api.qrv.no/ords/obas/bildeler/?%7B%27prosess%27:%27D3%27%2C%27s_fri_tekst%27:%27saab+lys%27%7D&page=1
            https://api.qrv.no/ords/obas/bildeler/?{%27prosess%27:%27D3%27%2C%27s_fri_tekst%27:%27saab+lys%27}&page=1

                select * from ola.v_api_driver_get


        --3.g) blobs_insert/                            POST,  Source Type: PL/SQL
            --Test 
                https://192.168.1.3:8080/ords/obas/blobs_list/300167desc en
                https://192.168.1.7:8443/ords/apex_obas/v1/blobs_list/300167
                https://obas.qrv.no/ords/apex_obas/v1/blobs_list/300167
                https://api.qrv.no/ords/obas/blobs_list/300167

            --Parameter
                EnhetSeqNo                  enhet_seq_no                    IN              Http header     Integer
                FileName                    file_name                       IN              Http header     String
                X-APEX-FORWARD              blobs_seq_no                    IN              Http header     String
                X-APEX-STATUS-CODE          status                          IN              Http header     Integer

            --Source (finnes ikke i 19c pr 2020-11-13)
                declare 
                   ret varchar2(1012);
                  begin
                    ola.pr_rest ('blobs_insert',:enhet_seq_no,null,null,:file_name,:content_type,:body,:blobs_seq_no,sysdate,ret);            
                   :status := 201;
                  end;

        --json fix
            --obas4 
                SELECT 'test single quote''' from dual;
                select '{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}' from dual;

                select  serie_no
                        ,case when '{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}'   is not null then '{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}'    else null end       as sok_uri                
                from ola.v_api_2_1_paa_bil          where rownum <= 5

                set serveroutput on size unlimited                  
                var ret     varchar2(255) ='{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}';
                select :ret from dual;
                -- execute pr_to_obas ('y','NA','UNItoOBAS',4,:ret);

                var sok_uri     varchar2(255) ='{''prosess'':''VRAK_ALLE'',''s_loc_id'':''ute1''}';
                select  
                serie_no
                ,case when :sok_uri    is not null then :sok_uri    else null end       as sok_uri   
                ,f_split_query(1, upper(json_value(:sok_uri, '$.s_fri_tekst'        ))) as ss            
                from ola.v_api_2_1_paa_bil          
                where rownum <= 5
                    --Må alltid ha med 1 record med søke-kriteriene
                    and enhet_seq_no = -1 or 
                    (   upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(1, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(2, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(3, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(4, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and upper  (nvl(fri_tekst        , '**')) like case when json_value(:sok_uri, '$.s_fri_tekst'        ) is not null then '%'||f_split_query(5, upper(json_value(:sok_uri, '$.s_fri_tekst'        )))||'%' else '%'  end                
                    and to_char(enhet_seq_no)                 like case when json_value(:sok_uri, '$.s_enhet_seq_no'     ) is not null then                       upper(json_value(:sok_uri, '$.s_enhet_seq_no'     returning varchar2))       else '%'  end
                    and to_char(nvl(prev_enhet_seq_no, -1  )) like case when json_value(:sok_uri, '$.s_prev_enhet_seq_no') is not null then                       upper(json_value(:sok_uri, '$.s_prev_enhet_seq_no'))       else '%'  end                
                    and upper  (nvl(vare_gruppe_id   , '**')) like case when json_value(:sok_uri, '$.s_vare_gruppe_id'   ) is not null then                       upper(json_value(:sok_uri, '$.s_vare_gruppe_id'   ))       else '%'  end                
                    and upper  (nvl(paa_bil          , '**')) like case when json_value(:sok_uri, '$.s_paa_bil'          ) is not null then                       upper(json_value(:sok_uri, '$.s_paa_bil'          ))       else '%'  end                
                    and upper  (nvl(loc_id           , '**')) like case when json_value(:sok_uri, '$.s_loc_id'           ) is not null then                       upper(json_value(:sok_uri, '$.s_loc_id'           ))       else '%'  end                
                    and upper  (nvl(serie_no         , '**')) like case when json_value(:sok_uri, '$.s_serie_no'         ) is not null then                       upper(json_value(:sok_uri, '$.s_serie_no'         ))       else '%'  end                
                    and upper  (nvl(fab_navn         , '**')) like case when json_value(:sok_uri, '$.s_fab_navn'         ) is not null then                       upper(json_value(:sok_uri, '$.s_fab_navn'         ))       else '%'  end                
                    and upper  (nvl(type_id          , '**')) like case when json_value(:sok_uri, '$.s_type_id'          ) is not null then                       upper(json_value(:sok_uri, '$.s_type_id'          ))       else '%'  end                
                    and upper  (nvl(aar              , '**')) like case when json_value(:sok_uri, '$.s_aar'              ) is not null then                       upper(json_value(:sok_uri, '$.s_aar'              ))       else '%'  end                
                    )  --enhet_besk utelates er typisk fritekt felt som allerde er dekket




----------------------------------------------------------- v_info_flow -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_info_flow as
        with driver as (
                select  flow_d1_plukkeliste, flow_d2_punchet, flow_d3_paa_lager, flow_d4_solgt,
                        flow_v1_henteliste,  flow_v2_motatt,  flow_v3_selvplukk, flow_v4_vrak, flow_v5_presset, flow_v6_feil,
                        count(*) as cnt,  
                        status_vare, status_loc, status_serie_no,status_paa_bil
                from v_api_driver_get 
                group by flow_d1_plukkeliste, flow_d2_punchet, flow_d3_paa_lager, flow_d4_solgt, 
                         flow_v1_henteliste,  flow_v2_motatt,  flow_v3_selvplukk, flow_v4_vrak, flow_v5_presset, flow_v6_feil,
                         status_vare, status_loc, status_serie_no, status_paa_bil
                order by 1,2,3,4,5,6,7,8,9,10 )
        select case when flow_d1_plukkeliste  is not null then 'D1 Deler i plukkeliste'
                    when flow_d2_punchet      is not null then 'D2 Deler punchet (av vidar)'
                    when flow_d3_paa_lager    is not null then 'D3 Deler pa lager (av Toralv)'
                    when flow_d4_solgt        is not null then 'D4 Deler solgt'
                    when flow_v1_henteliste   is not null then 'V1 Vrak lagt inn pa henteliste'
                    when flow_v2_motatt       is not null then 'V2 Vrak motatt (av Tommy)'
                    when flow_v3_selvplukk    is not null then 'V3 Vrak plassert pa selvplukk'
                    when flow_v4_vrak         is not null then 'V4 Vrak i sirkulasjon inne, ute etc'
                    when flow_v5_presset      is not null then 'V5 Vrak presset'   
                    when flow_v6_feil         is not null then 'V6 Vrak feilregistrert'     end as flow,
              cnt,status_vare, status_loc, status_serie_no, status_paa_bil
        from driver
    /


----------------------------------------------------------- uni testdata uni_2_ -----------------------------------------------------------------------------------------------------------------------------------    
        kolonne/pk          tabell              verdier                         view                kommentar 
        "Tilbudsnr"         tilbud@uni_2        3730, 3731, 3732, 3733, 3734    v_uni_tilbud        status  
                                                                                                    -- 0                            tilbudsnr 3730 
                                                                                                    -- 110300 reg, 
                                                                                                    -- 110301 Overført til ordre,   tilbudsnr 3731-3731
                                                                                                    -- 110302 Overført til faktura

        "Tilbudsnr"         tilbud@uni_2        27920, 28059                    v_uni_tilbud_rapp   vaar_ref=bildeler.net dvs vrakmeldinger


        "Ordrenr"           ordre@uni_2         18449-18452 (4stk)              v_uni_ordre

----------------------------------------------------------- v_uni_lev -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_uni_lev  as
        --create table t as
        --
        select
              lev."Kontonr"               as levnr              --number(10)
             ,lev."VartKundenr"           as vart_kundenr              --number(10)
             ,lev."NameID"                as nameid               --number(10)
             ,navn."Name"                 as levnavn            --varchar2(50)
             ,lev."Gironr"                as giro_nr
             ,lev."MVANr"                 as org_nr
             --
             ,telefon."Phone"       as kunde_telefon        --varchar2(20)
             ,mobil."Phone"         as kunde_mobil          --varchar2(50)
             ,email."mailadr"       as kunde_mail           --varchar2(80)
             ,lev."Web"           as www                  --varchar2(80)
             ,adr."Address"         as adresse              --varchar2(60)
             ,adr."Address2"        as adresse2             --varchar2(60)
             ,adr."Postal_code"     as postnr               --varchar2(10)
             ,adr."City"            as poststed             --varchar2(50)
             ,adr."Country_code"    as land_kode            --varchar2(50)
             ,adr."Country"         as land                 --varchar2(50)
        from  
        -- c_Adres@uni_2s   adr        --id 33 krutvik
          --   ,c_email    email      --id 101017 odd arne
              KREDITOR@uni_2     lev
             ,(select distinct "ID"      , "Name"                           from c_Name@uni_2                                                )   navn 
             ,(select distinct "NameLink", "Phone", "phonetype"             from c_Phone@uni_2   where "standard"  =1 and "phonetype" =150101)   telefon
             ,(select distinct "NameLink", "Phone", "phonetype"             from c_Phone@uni_2   where "standard"  =1 and "phonetype" =150102)   mobil
             ,(select distinct "namelink", "mailadr","standard"             from c_email@uni_2   where "standard"  =1                        )   email   --velge hoved mail
             ,(select distinct "NameLink", "Address", "Address2",
                               "Postal_code", "City",
                               "Country","Country_code" 
                                                                            from c_Address@uni_2 where "dm"        =1                        )   adr     --velge hoved adresse
        where 1=1
            and lev."NameID"  = navn."ID"             (+)
            and lev."NameID"  = telefon."NameLink"    (+)
            and lev."NameID"  = mobil."NameLink"      (+)
            and lev."NameID"  = email."namelink"      (+)
            and lev."NameID"  = adr."NameLink"        (+)
        order by navn."Name"
    /

----------------------------------------------------------- v_uni_kunde -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_uni_kunde  as
        --create table t as
        --
        select
              kunde."Kontonr"               as kundenr              --number(10)
             ,kunde."NameID"                as nameid               --number(10)
             ,navn."Name"                   as kundenavn            --varchar2(50)
             ,kunde."Gironr"                as giro_nr
             ,kunde."MVANr"                 as org_nr
             ,kunde."Rating"                as rating
             --,substr(kunde."RatingDescription",1,4000)     as rating_bekrivelse
             ,''                            as rating_bekrivelse
             ,kunde."RatingDato"            as rating_dato
             --
             ,telefon."Phone"       as kunde_telefon        --varchar2(20)
             ,mobil."Phone"         as kunde_mobil          --varchar2(50)
             ,email."mailadr"       as kunde_mail           --varchar2(80)
             ,kunde."Web"           as www                  --varchar2(80)
             ,adr."Address"         as adresse              --varchar2(60)
             ,adr."Address2"        as adresse2             --varchar2(60)
             ,adr."Postal_code"     as postnr               --varchar2(10)
             ,adr."City"            as poststed             --varchar2(50)
             ,adr."Country_code"    as land_kode            --varchar2(50)
             ,adr."Country"         as land                 --varchar2(50)
        from  
        -- c_Adres@uni_2s   adr        --id 33 krutvik
          --   ,c_email    email      --id 101017 odd arne
              DEBITOR@uni_2     kunde
             ,(select distinct "ID"      , "Name"                           from c_Name@uni_2                                                )   navn 
             ,(select distinct "NameLink", "Phone", "phonetype"             from c_Phone@uni_2   where "standard"  =1 and "phonetype" =150101)   telefon
             ,(select distinct "NameLink", "Phone", "phonetype"             from c_Phone@uni_2   where "standard"  =1 and "phonetype" =150102)   mobil
             ,(select distinct "namelink", "mailadr","standard"             from c_email@uni_2   where "standard"  =1                        )   email   --velge hoved mail
             ,(select distinct "NameLink", "Address", "Address2",
                               "Postal_code", "City",
                               "Country","Country_code" 
                                                                            from c_Address@uni_2 where "dm"        =1                        )   adr     --velge hoved adresse
        where 1=1
            and kunde."NameID"  = navn."ID"             (+)
            and kunde."NameID"  = telefon."NameLink"    (+)
            and kunde."NameID"  = mobil."NameLink"      (+)
            and kunde."NameID"  = email."namelink"      (+)
            and kunde."NameID"  = adr."NameLink"        (+)
        order by navn."Name"
    /
    
    grant select on v_uni_kunde to public;

        select kundenr , count(*) from v_actor group by kundenr having count(*) >1;
        --0

        select kundenavn||' {'||kundenr||'}' , count(*) from v_actor group by kundenavn||' {'||kundenr||'}' having count(*) >1;
        --0

        select kundenavn , count(*) from v_actor group by kundenavn having count(*) >1;
        --89


        select count(*) from DEBITOR@uni_2;
        --9604

        select count(*) from (select distinct kunde_id from v_uni_actor);
        --9604
      
        select count(*) from v_uni_actor;
        --9604 28.10.2019

        select kunde_id, count(*) 
        from v_uni_actor
        group by kunde_id
        having count(*) >1;
        --0
    --uttrekk
        select count(*) from DEBITOR@uni_2
        --9843

        select count(*) 
        from    DEBITOR@uni_2   kunde,
                c_Name@uni_2    navn
        where 1=1
            and kunde."NameID"  = navn."ID"             (+)
        --9843

----------------------------------------------------------- v_uni_faktura (spezial versjon i ola/ola@obas) -----------------------------------------------------------------------------------------------------------------------------------    
    create or replace view v_uni_faktura as
        select
             faktura."Fakturanr"                         as f_fakturanr
            ,faktura."Kundenr"                           as f_kundenr
            ,faktura."Kjedenrex"                         as f_kjedenrex
            ,faktura."Kundenavn"                         as f_kundenavn
            ,faktura."Adresse"                           as f_adresse
            ,faktura."Adresse2"                          as f_adresse2
            ,faktura."Postnr"                            as f_postnr
            ,faktura."Poststed"                          as f_poststed
            ,faktura."Landkode"                          as f_landkode
            ,faktura."Land"                              as f_land
            ,faktura."Fakturadato"                       as f_fakturadato
            ,faktura."Forfallsdato"                      as f_forfallsdato
            ,faktura."Ant_Purret"                        as f_ant_purret
            ,faktura."Avdragsplan"                       as f_avdragsplan
            ,faktura."Avgfritt_grunnlag"                 as f_avgfritt_grunnlag
            ,faktura."Behandlingsregel"                  as f_behandlingsregel
            ,faktura."Bet_maate"                         as f_bet_maate
            ,faktura."Bilagsnr_Regnskap"                 as f_bilagsnr_regnskap
            ,faktura."DagtilleggPurr"                    as f_dagtilleggpurr
            ,faktura."Dekningsbidrag"                    as f_dekningsbidrag
            ,faktura."Deres_Ref"                         as f_deres_ref
            ,faktura."Vaar_Ref"                          as f_vaar_ref
            ,faktura."Fritekst"                          as f_fritekst
            ,faktura."Innbet_Dato"                       as f_innbet_dato
            ,faktura."Innbet_Sum"                        as f_innbet_sum
            ,faktura."KIDnr"                             as f_kidnr
            ,faktura."Koblet_til_Faktnr"                 as f_koblet_til_faktnr
            ,faktura."Kommentarer"                       as f_kommentarer
            ,faktura."Kreditert_Sum"                     as f_kreditert_sum
            ,faktura."Levering"                          as f_levering
            ,faktura."Leveringsdato"                     as f_leveringsdato
            ,faktura."Moms"                              as f_moms
            ,faktura."Momsprosent"                       as f_momsprosent
            ,faktura."Mvagrunnlag"                       as f_mvagrunnlag
            ,faktura."NameID"                            as f_nameid
            ,faktura."Nettosum"                          as f_nettosum
            ,faktura."Ordrenr"                           as f_ordrenr
            ,faktura."Purregebyr"                        as f_purregebyr
            ,faktura."Rabatt"                            as f_rabatt
            ,faktura."Registreringsdato"                 as f_registreringsdato
            ,faktura."Rekvisisjon"                       as f_rekvisisjon
            ,faktura."Rentetall"                         as f_rentetall
            ,faktura."Selgernr1"                         as f_selgernr1
            ,faktura."Selgernr2"                         as f_selgernr2
            ,faktura."Spraak"                            as f_spraak
            ,faktura."Tilbudsnr"                         as f_tilbudsnr
            ,faktura."Totalsum"                          as f_totalsum
            ,faktura."Transportmaate"                    as f_transportmaate
            ,faktura."Transport"                         as f_transport
            ,faktura."Transportoer"                      as f_transportoer
            ,faktura."Status"                            as f_status
            ,faktura."Type"                              as f_type
            ,faktura."Valuta"                            as f_valuta
            ,faktura."AvtaleGiroStatus"                  as f_avtalegirostatus
            ,faktura."dim1"                              as f_dim1
            ,faktura."dim2"                              as f_dim2
            ,faktura."dim3"                              as f_dim3
            ,faktura."dim4"                              as f_dim4
            ,faktura."dim5"                              as f_dim5
            ,faktura."dim6"                              as f_dim6
            ,faktura."dim7"                              as f_dim7
            ,faktura."dim8"                              as f_dim8
            ,faktura."dim9"                              as f_dim9
            ,faktura."dim10"                             as f_dim10
            ,faktura."Renteberegnet"                     as f_renteberegnet
            ,faktura."PostPost"                          as f_postpost
            ,faktura."ValutaKode"                        as f_valutakode
            ,faktura."ValutaSum"                         as f_valutasum
            ,faktura."ValutaForced"                      as f_valutaforced
            ,faktura."Factoring"                         as f_factoring
            ,faktura."PrintStatus"                       as f_printstatus
            ,faktura."GrlHoy"                            as f_grlhoy
            ,faktura."GrlLav"                            as f_grllav
            ,faktura."GrlLav2"                           as f_grllav2
            ,faktura."MomsHoy"                           as f_momshoy
            ,faktura."MomsLav"                           as f_momslav
            ,faktura."MomsLav2"                          as f_momslav2
            ,faktura."BetBetingelse"                     as f_betbetingelse
            ,faktura."LevBetingelse"                     as f_levbetingelse
            ,faktura."eFakttura"                         as f_efakttura
            ,faktura."Signatur"                          as f_signatur
            ,faktura."Dagsoppgjnr"                       as f_dagsoppgjnr
            ,faktura."Selgernr3"                         as f_selgernr3
            ,faktura."Selgernr4"                         as f_selgernr4
            ,faktura."Selgernr5"                         as f_selgernr5
            ,faktura."IkkeBokfort"                       as f_ikkebokfort
            ,faktura."PurresIkke"                        as f_purresikke
            ,faktura."Rabattavtalenr"                    as f_rabattavtalenr
            ,faktura."CashRegisterID"                    as f_cashregisterid
            ,faktura."postenefaktura"                    as f_postenefaktura
            ,faktura."fraktid"                           as f_fraktid
            ,faktura."e2bStatus"                         as f_e2bstatus
            ,faktura."faktadr_backup"                    as f_faktadr_backup
            ,faktura."KreditnotaComment"                 as f_kreditnotacomment
            ,faktura."APStatus"                          as f_apstatus
            ,faktura."EStatus"                           as f_estatus
            ,faktura."KontoInnkommende"                  as f_kontoinnkommende
            ,faktura."Mottaker"                          as f_mottaker
            ,faktura."LevAdr1"                           as f_levadr1
            ,faktura."LevAdr2"                           as f_levadr2
            ,faktura."LevPostnr"                         as f_levpostnr
            ,faktura."LevPoststed"                       as f_levpoststed
            ,faktura."LevLandkode"                       as f_levlandkode
            ,faktura."LevLand"                           as f_levland
            ,faktura."GrlMarine"                         as f_grlmarine
            ,faktura."MomsMarine"                        as f_momsmarine
            ,faktura."LevAdrID"                          as f_levadrid
            ,faktura."TransportoerEx"                    as f_transportoerex
            ,faktura."ProduktEx"                         as f_produktex
            ,faktura."ServiceEx"                         as f_serviceex
            ,faktura."AntKolli"                          as f_antkolli
            ,faktura."Fraktpris"                         as f_fraktpris
            ,faktura."ServicePris"                       as f_servicepris
            ,faktura."KolliCT"                           as f_kollict
            ,faktura."sporingsnr"                        as f_sporingsnr
            ,faktura."TracknrEx"                         as f_tracknrex
            ,faktura."ServiceCT"                         as f_servicect
            ,faktura."pickupct"                          as f_pickupct
            ,faktura."lblPickup"                         as f_lblpickup
            ,faktura."LogistraSender"                    as f_logistrasender
            ,faktura."LogistraTelefon"                   as f_logistratelefon
            ,faktura."LogistraEpost"                     as f_logistraepost
            ,faktura."ESignatur"                         as f_esignatur
            ,faktura."ESignaturVer"                      as f_esignaturver
            ,faktura."ESignaturAncestor"                 as f_esignaturancestor
            ,varelnfakt."ID"                                     as f_ln_id
            ,varelnfakt."Fakturanr"                              as f_ln_fakturanr
            ,varelnfakt."Kundenr"                                as f_ln_kundenr
            ,varelnfakt."Varenr"                                 as f_ln_varenr
            ,varelnfakt."Varetekst"                              as f_ln_varetekst
            ,varelnfakt."ErstatnVareid"                          as f_ln_erstatnvareid
            ,varelnfakt."Antall"                                 as f_ln_antall
            ,varelnfakt."Enhet"                                  as f_ln_enhet
            ,varelnfakt."InnPris"                                as f_ln_innpris
            ,varelnfakt."Kostnad"                                as f_ln_kostnad
            ,varelnfakt."Kontonr"                                as f_ln_kontonr
            ,varelnfakt."Momskode"                               as f_ln_momskode
            ,varelnfakt."Pris"                                   as f_ln_pris
            ,varelnfakt."Rabatt"                                 as f_ln_rabatt
            ,varelnfakt."Serienr"                                as f_ln_serienr
            ,varelnfakt."LSum"                                   as f_ln_lsum
            ,varelnfakt."Type"                                   as f_ln_type
            ,varelnfakt."Status"                                 as f_ln_status
            ,varelnfakt."Db"                                     as f_ln_db
            ,varelnfakt."Netto"                                  as f_ln_netto
            ,varelnfakt."Mva"                                    as f_ln_mva
            ,varelnfakt."AB_ID"                                  as f_ln_ab_id
            ,varelnfakt."dim1"                                   as f_ln_dim1
            ,varelnfakt."dim2"                                   as f_ln_dim2
            ,varelnfakt."dim3"                                   as f_ln_dim3
            ,varelnfakt."dim4"                                   as f_ln_dim4
            ,varelnfakt."dim5"                                   as f_ln_dim5
            ,varelnfakt."dim6"                                   as f_ln_dim6
            ,varelnfakt."dim7"                                   as f_ln_dim7
            ,varelnfakt."dim8"                                   as f_ln_dim8
            ,varelnfakt."dim9"                                   as f_ln_dim9
            ,varelnfakt."dim10"                                  as f_ln_dim10
            ,varelnfakt."Antall_lev"                             as f_ln_antall_lev
            ,varelnfakt."Komp_lagertype"                         as f_ln_komp_lagertype
            ,varelnfakt."Komp_visningstype"                      as f_ln_komp_visningstype
            ,varelnfakt."Komp_pristype"                          as f_ln_komp_pristype
            ,varelnfakt."ValutaKode"                             as f_ln_valutakode
            ,varelnfakt."ValutaLSum"                             as f_ln_valutalsum
            ,varelnfakt."ValutaPrice"                            as f_ln_valutaprice
            ,varelnfakt."Komp_level"                             as f_ln_komp_level
            ,varelnfakt."Momsprosent"                            as f_ln_momsprosent
            ,varelnfakt."PlukkID"                                as f_ln_plukkid
            ,varelnfakt."ordrenr"                                as f_ln_ordrenr
            ,varelnfakt."itemnr"                                 as f_ln_itemnr
            ,varelnfakt."div1"                                   as f_ln_div1
            ,varelnfakt."weight_per_unit"                        as f_ln_weight_per_unit
            ,varelnfakt."weight_total"                           as f_ln_weight_total
            ,varelnfakt."dimension_x"                            as f_ln_dimension_x
            ,varelnfakt."dimension_y"                            as f_ln_dimension_y
            ,varelnfakt."dimension_z"                            as f_ln_dimension_z
            ,varelnfakt."dimension_p"                            as f_ln_dimension_p
            ,varelnfakt."dimension_n"                            as f_ln_dimension_n
            ,varelnfakt."MS_GroupInvoiceRef"                     as f_ln_ms_groupinvoiceref
            ,varelnfakt."anbudtype"                              as f_ln_anbudtype
            ,varelnfakt."Snittpris"                              as f_ln_snittpris
            ,varelnfakt."AvgMalId"                               as f_ln_avgmalid
            ,varelnfakt."AvgMalType"                             as f_ln_avgmaltype
            ,varelnfakt."MiljoavgForID"                          as f_ln_miljoavgforid
            ,varelnfakt."fraktLinjeID"                           as f_ln_fraktlinjeid
            ,varelnfakt."Selgerid"                               as f_ln_selgerid
            ,varelnfakt."Serienrlager"                           as f_ln_serienrlager
            ,varelnfakt."Lager"                                  as f_ln_lager
            ,varelnfakt."Lokasjon"                               as f_ln_lokasjon
            ,varelnfakt."LineGUID"                               as f_ln_lineguid
            ,varelnfakt."KorrigertAvdeling"                      as f_ln_korrigertavdeling
        from     faktura@uni_2     faktura
                ,varelnfakt@uni_2  varelnfakt
        where faktura."Fakturanr" = varelnfakt."Fakturanr"
    /

    grant select on v_uni_faktura to public;

    select count(*) from faktura@uni_2 faktura, varelnfakt@uni_2 varelnfakt where faktura."Fakturanr" = varelnfakt."Fakturanr";
    #207936
    select count(*) from faktura@uni_2 faktura, varelnfakt@uni_2 varelnfakt where faktura."Fakturanr" = varelnfakt."Fakturanr" (+);
    #207937

    --ola/ola@obas spezial
    create or replace view v_uni_faktura as
        /*brukes i side 210 */
        --eks 286333 / D14988  DØRVINDUSHEIS-VF VW GOLF 5 2007 V22505 har 3 faktura nr
        select  varelnfakt."ID"                       as id , 
                varelnfakt."Fakturanr"                as fakturanr, 
                to_char(faktura."Fakturadato",'yyyy') as aar,
                faktura."Fakturadato"                 as fakturadato,
                faktura."Kundenr"                     as kundenr, 
                faktura."Tilbudsnr"                   as tilbudsnr, 
                varelnfakt."Varenr"                   as varenr, 
                varelnfakt."Varetekst"                as varetekst, 
                varelnfakt."ErstatnVareid"            as enhet_seq_no, 
                varelnfakt."LSum"                     as lsum, 
                varelnfakt."Kontonr"                  as kontonr
        from varelnfakt@uni_2  varelnfakt,
             faktura@uni_2     faktura
        where 1=1
        and faktura."Fakturanr" = varelnfakt."Fakturanr"
        --and varelnfakt."Varenr" like 'D%'
        order by faktura."Kundenr", faktura."Tilbudsnr" ,  varelnfakt."Fakturanr" desc
    /

----------------------------------------------------------- v_uni_ordre -----------------------------------------------------------------------------------------------------------------------------------    
    create or replace view v_uni_ordre as
        select               
             ordre."Ordrenr"                                as o_ordrenr
            ,ordre."Kundenr"                                as o_kundenr
            ,ordre."NameID"                                 as o_nameid
            ,ordre."Kundenavn"                              as o_kundenavn
            ,ordre."Adresse"                                as o_adresse
            ,ordre."Adresse2"                               as o_adresse2
            ,ordre."Postnr"                                 as o_postnr
            ,ordre."Poststed"                               as o_poststed
            ,ordre."Landkode"                               as o_landkode
            ,ordre."Land"                                   as o_land
            ,ordre."Ordredato"                              as o_ordredato
            ,ordre."Leveringsdato"                          as o_leveringsdato
            ,ordre."Avgfritt_grunnlag"                      as o_avgfritt_grunnlag
            ,ordre."Behandlingsregel"                       as o_behandlingsregel
            ,ordre."Bet_maate"                              as o_bet_maate
            ,ordre."Dekningsbidrag"                         as o_dekningsbidrag
            ,ordre."Deres_Ref"                              as o_deres_ref
            ,ordre."Vaar_Ref"                               as o_vaar_ref
            ,ordre."Fritekst"                               as o_fritekst
            ,ordre."Kommentarer"                            as o_kommentarer
            ,ordre."Levering"                               as o_levering
            ,ordre."Moms"                                   as o_moms
            ,ordre."Momsprosent"                            as o_momsprosent
            ,ordre."Mvagrunnlag"                            as o_mvagrunnlag
            ,ordre."Nettosum"                               as o_nettosum
            ,ordre."Rabatt"                                 as o_rabatt
            ,ordre."Registreringsdato"                      as o_registreringsdato
            ,ordre."Rekvisisjon"                            as o_rekvisisjon
            ,ordre."Selgernr1"                              as o_selgernr1
            ,ordre."Selgernr2"                              as o_selgernr2
            ,ordre."Spraak"                                 as o_spraak
            ,ordre."Totalsum"                               as o_totalsum
            ,ordre."Transportmaate"                         as o_transportmaate
            ,ordre."Transport"                              as o_transport
            ,ordre."Transportoer"                           as o_transportoer
            ,ordre."Status"                                 as o_status
            ,ordre."Type"                                   as o_type
            ,ordre."Valuta"                                 as o_valuta
            ,ordre."dim1"                                   as o_dim1
            ,ordre."dim2"                                   as o_dim2
            ,ordre."dim3"                                   as o_dim3
            ,ordre."dim4"                                   as o_dim4
            ,ordre."dim5"                                   as o_dim5
            ,ordre."dim6"                                   as o_dim6
            ,ordre."dim7"                                   as o_dim7
            ,ordre."dim8"                                   as o_dim8
            ,ordre."dim9"                                   as o_dim9
            ,ordre."dim10"                                  as o_dim10
            ,ordre."ValutaKode"                             as o_valutakode
            ,ordre."ValutaSum"                              as o_valutasum
            ,ordre."ValutaForced"                           as o_valutaforced
            ,ordre."GrlHoy"                                 as o_grlhoy
            ,ordre."GrlLav"                                 as o_grllav
            ,ordre."GrlLav2"                                as o_grllav2
            ,ordre."MomsHoy"                                as o_momshoy
            ,ordre."MomsLav"                                as o_momslav
            ,ordre."MomsLav2"                               as o_momslav2
            ,ordre."PrintStatus"                            as o_printstatus
            ,ordre."ExportHandTerm"                         as o_exporthandterm
            ,ordre."Assigned1"                              as o_assigned1
            ,ordre."Assigned2"                              as o_assigned2
            ,ordre."Internal_comment"                       as o_internal_comment
            ,ordre."BetBetingelse"                          as o_betbetingelse
            ,ordre."LevBetingelse"                          as o_levbetingelse
            ,ordre."Signatur"                               as o_signatur
            ,ordre."ValgtLagerID"                           as o_valgtlagerid
            ,ordre."ms_ordretype"                           as o_ms_ordretype
            ,ordre."ms_fastpris"                            as o_ms_fastpris
            ,ordre."ms_avsluttet"                           as o_ms_avsluttet
            ,ordre."MS_PriceCollectionRef"                  as o_ms_pricecollectionref
            ,ordre."Selgernr3"                              as o_selgernr3
            ,ordre."Selgernr4"                              as o_selgernr4
            ,ordre."Selgernr5"                              as o_selgernr5
            ,ordre."Rabattavtalenr"                         as o_rabattavtalenr
            ,ordre."fraktid"                                as o_fraktid
            ,ordre."finishedDate"                           as o_finisheddate
            ,ordre."LastEdit"                               as o_lastedit
            ,ordre."tracknr"                                as o_tracknr
            ,ordre."innbet_sum"                             as o_innbet_sum
            ,ordre."Mottaker"                               as o_mottaker
            ,ordre."LevAdr1"                                as o_levadr1
            ,ordre."LevAdr2"                                as o_levadr2
            ,ordre."LevPostnr"                              as o_levpostnr
            ,ordre."LevPoststed"                            as o_levpoststed
            ,ordre."LevLandkode"                            as o_levlandkode
            ,ordre."LevLand"                                as o_levland
            ,ordre."TransportoerEx"                         as o_transportoerex
            ,ordre."ProduktEx"                              as o_produktex
            ,ordre."ServiceEx"                              as o_serviceex
            ,ordre."AntKolli"                               as o_antkolli
            ,ordre."Fraktpris"                              as o_fraktpris
            ,ordre."ServicePris"                            as o_servicepris
            ,ordre."KolliCT"                                as o_kollict
            ,ordre."sporingsnr"                             as o_sporingsnr
            ,ordre."TracknrEx"                              as o_tracknrex
            ,ordre."ServiceCT"                              as o_servicect
            ,ordre."pickupct"                               as o_pickupct
            ,ordre."lblPickup"                              as o_lblpickup
            ,ordre."LogistraSender"                         as o_logistrasender
            ,ordre."GrlMarine"                              as o_grlmarine
            ,ordre."MomsMarine"                             as o_momsmarine
            ,ordre."jobbBeskrivelse"                        as o_jobbbeskrivelse
            ,ordre."LevAdrID"                               as o_levadrid
            ,ordre."LogistraTelefon"                        as o_logistratelefon
            ,ordre."LogistraEpost"                          as o_logistraepost
            ,ordre."Uni24Workflow"                          as o_uni24workflow
            ,varelnordre."ID"                                       as o_l_id 
            ,varelnordre."Ordrenr"                                  as o_l_ordrenr
            ,varelnordre."Kundenr"                                  as o_l_kundenr
            ,varelnordre."Varenr"                                   as o_l_varenr
            ,varelnordre."Varetekst"                                as o_l_varetekst
            ,varelnordre."ErstatnVareid"                            as o_l_erstatnvareid
            ,varelnordre."Antall"                                   as o_l_antall
            ,varelnordre."Antall_lev"                               as o_l_antall_lev
            ,varelnordre."Antall_fakt"                              as o_l_antall_fakt
            ,varelnordre."Enhet"                                    as o_l_enhet
            ,varelnordre."InnPris"                                  as o_l_innpris
            ,varelnordre."Kostnad"                                  as o_l_kostnad
            ,varelnordre."Kontonr"                                  as o_l_kontonr
            ,varelnordre."Momskode"                                 as o_l_momskode
            ,varelnordre."Pris"                                     as o_l_pris
            ,varelnordre."Rabatt"                                   as o_l_rabatt
            ,varelnordre."Serienr"                                  as o_l_serienr
            ,varelnordre."LSum"                                     as o_l_lsum
            ,varelnordre."Type"                                     as o_l_type
            ,varelnordre."Status"                                   as o_l_status
            ,varelnordre."Db"                                       as o_l_db
            ,varelnordre."Netto"                                    as o_l_netto
            ,varelnordre."Mva"                                      as o_l_mva
            ,varelnordre."AB_ID"                                    as o_l_ab_id
            ,varelnordre."AB_AVREGNID"                              as o_l_ab_avregnid
            ,varelnordre."GrpKode"                                  as o_l_grpkode
            ,varelnordre."kun_til_samlefaktura"                     as o_l_kun_til_samlefaktura
            ,varelnordre."dim1"                                     as o_l_dim1
            ,varelnordre."dim2"                                     as o_l_dim2
            ,varelnordre."dim3"                                     as o_l_dim3
            ,varelnordre."dim4"                                     as o_l_dim4
            ,varelnordre."dim5"                                     as o_l_dim5
            ,varelnordre."dim6"                                     as o_l_dim6
            ,varelnordre."dim7"                                     as o_l_dim7
            ,varelnordre."dim8"                                     as o_l_dim8
            ,varelnordre."dim9"                                     as o_l_dim9
            ,varelnordre."dim10"                                    as o_l_dim10
            ,varelnordre."Komp_lagertype"                           as o_l_komp_lagertype
            ,varelnordre."Komp_visningstype"                        as o_l_komp_visningstype
            ,varelnordre."Komp_pristype"                            as o_l_komp_pristype
            ,varelnordre."ValutaKode"                               as o_l_valutakode
            ,varelnordre."ValutaLSum"                               as o_l_valutalsum
            ,varelnordre."ValutaPrice"                              as o_l_valutaprice
            ,varelnordre."Komp_level"                               as o_l_komp_level
            ,varelnordre."Momsprosent"                              as o_l_momsprosent
            ,varelnordre."PlukkID"                                  as o_l_plukkid
            ,varelnordre."RenteJobbID"                              as o_l_rentejobbid
            ,varelnordre."DeliveryLink"                             as o_l_deliverylink
            ,varelnordre."itemnr"                                   as o_l_itemnr
            ,varelnordre."leveringsdato"                            as o_l_leveringsdato
            ,varelnordre."TrackingID"                               as o_l_trackingid
            ,varelnordre."div1"                                     as o_l_div1
            ,varelnordre."weight_per_unit"                          as o_l_weight_per_unit
            ,varelnordre."weight_total"                             as o_l_weight_total
            ,varelnordre."dimension_x"                              as o_l_dimension_x
            ,varelnordre."dimension_y"                              as o_l_dimension_y
            ,varelnordre."dimension_z"                              as o_l_dimension_z
            ,varelnordre."dimension_p"                              as o_l_dimension_p
            ,varelnordre."dimension_n"                              as o_l_dimension_n
            ,varelnordre."MS_GroupInvoiceRef"                       as o_l_ms_groupinvoiceref
            ,varelnordre."anbudtype"                                as o_l_anbudtype
            ,varelnordre."ExternalInvoiceRowID"                     as o_l_externalinvoicerowid
            ,varelnordre."Snittpris"                                as o_l_snittpris
            ,varelnordre."Registreringsdato"                        as o_l_registreringsdato
            ,varelnordre."AvgMalId"                                 as o_l_avgmalid
            ,varelnordre."AvgMalType"                               as o_l_avgmaltype
            ,varelnordre."MiljoavgForID"                            as o_l_miljoavgforid
            ,varelnordre."fraktLinjeID"                             as o_l_fraktlinjeid
            ,varelnordre."levOrg_ant"                               as o_l_levorg_ant
            ,varelnordre."levTracknr"                               as o_l_levtracknr
            ,varelnordre."SC_JobNrRef"                              as o_l_sc_jobnrref
            ,varelnordre."Selgerid"                                 as o_l_selgerid
            ,varelnordre."SerienrLager"                             as o_l_serienrlager
            ,varelnordre."LastEdit"                                 as o_l_lastedit
            ,varelnordre."Lager"                                    as o_l_lager
            ,varelnordre."Lokasjon"                                 as o_l_lokasjon
            ,varelnordre."KorrigertAvdeling"                        as o_l_korrigertavdeling
        from     ordre@uni_2         ordre
                ,varelnordre@uni_2   varelnordre
        where varelnordre."Ordrenr" = ordre."Ordrenr" 
    /

    grant select on v_uni_ordre to public;

        select count(*) from ordre@uni_2 ordre , varelnordre@uni_2 varelnordre where varelnordre."Ordrenr" = ordre."Ordrenr";
        #47923
        select count(*) from ordre@uni_2 ordre , varelnordre@uni_2 varelnordre where varelnordre."Ordrenr" = ordre."Ordrenr" (+);
        #48318

    --test
        1)
        Uni sjekke høyeste ordre nr alltid MEN  hvis nummer serien er fra 18478 og oppover og vi legger inn
        f.eks 200006 vil allikevel 18479 bli valgt i UNI programmet på neste ordre
        --> vi kan ha egen handlekorg serie

        2) 
        UNI renummerer id i varelnordre ALLTID dersom odren endres i UNI programmet,  alle id på denne orren blir renummerert
        --> vi kan ikke endre i UNI ordre bilde dersom vi. feks skal ha en ekstra frakt kode
        -- hvis vi gjør det kan vi ikke bruke sequence men må sjekke inni UNI hvor høy vi er kommet i id nummeringen.

      grant all on v_uni_tilbud to public
      /

    --drop sequence uni_ordrenr;
    create sequence uni_ordrenr_seq increment by 1 start with 200010;  
        --pr 2019_11_18 max nr i vrak tilbuden 35967
        --pr 2019_11_18 max nr i tilbud generert i UNI gui  tilbuden 3719

    create or replace trigger tr_instd_v_uni_ordre instead of insert or update or delete on v_uni_ordre for each row
        /*  2019_11_23 laget

              Test
                   --set serveroutput on size unlimited                  

                  --select "Tilbudsnr" from v_test where rownum <5;
                  --select uni_tilbudsnr_seq.nextval from dual;
                  --insert into v_uni_ordre(o_ordrenr, o_kundenr) values (uni_ordrenr_seq.nextval,101793);
                  --insert into v_uni_tilbud(tilbudsnr) values (36008);
                  --insert into tilbud@uni_2("Tilbudsnr") values(uni_tilbudsnr_seq.nextval);
                  --insert into tilbud@uni_2("Tilbudsnr") values(36001);

                  --sqlplus sys/Ora12c1601@192.168.1.3:1521/pdbobas as sysdba
                  --create table ttt (ant number);
                  --insert into ttt(ant) values(-1);
                  --drop public database link test ;
                  --create public database link test connect to ola identified by ola using 'obas';
                  --desc enhet@test
                  --insert into ttt@test(ant) values(-2);
            */
        declare
          --PRAGMA AUTONOMOUS_TRANSACTION;  --ORA-02047: cannot join the distributed  workaround http://www.orafaq.com/forum/t/186525/
            proc_name       varchar2(35) :='tr_instd_v_uni_ordre';
            txt_todo   		varchar2(32767);
            txt_error   	varchar2(32767);
            txt_status   	varchar2(32767);    --akumulert
            txt_return   	varchar2(32767);    
            error_txt   	varchar2(32767);
            error_exc       exception;

            l_time_stamp    date 	:= sysdate;
            l_date_in       date    := l_time_stamp;  
            l_date_upd      date    := l_time_stamp;  

            todo_txt      varchar2(1024);
            p_out_feil    varchar2(1024);
            date_in       date;
            date_upd      date;
            tilbudsnr     number;
            id_nr         number;
          ---kunde info
            s_kundenavn       varchar2(60);
            s_adresse         varchar2(60);
            s_adresse2        varchar2(60);
            s_postnr          varchar2(10);
            s_poststed        varchar2(60);  
            s_kommentarer     varchar2(100);
          ---uni info    
            s_dato            varchar2(10);
            s_gyldigtildato   varchar2(10);
            n_momsprosent     number;       
            n_mvagrunnlag     number;  
            n_moms            number;  
            n_nettosum        number;  
            n_dekningsbidrag  number; 
          --uni varelntilb
            s_varenr          varchar2(20);
            s_varetekst       varchar2(150);
    
        begin
          dbms_output.put_line ('>>>>>>>> '||proc_name||' '||l_time_stamp||'.......');

            if INSERTING  then

                txt_status := ' 1)   INPUT';
                    --1.a) kunde info
                        --piping substr, case funker ikke inni insert statment mot hetrogenous gateways
                        --ORA-02070: databasen UNI_2 st�tter ikke SUBSTR i denne konteksten
                        txt_status := ' 1) INPUT'                                   ||
                                ': Ordrenr='                    ||:new.o_ordrenr    ||
                                ', Kundenr=='                   ||:new.o_kundenr    ;

                        --    s_kundenavn       := substr(:new.navn||' '||:new.etternavn                                                    ,1,60);
                        --    s_adresse         := substr(:new.adr                                                                          ,1,60);
                        --    s_adresse2        := substr(:new.adr2                                                                         ,1,60);
                        --    s_postnr          := substr(:new.pnr                                                                          ,1,10);
                        --    s_poststed        := substr(:new.psted                                                                        ,1,60);  
                        --    s_kommentarer     := substr('V'||tilbudsnr                        
                        --                 ||case when :new.b_konto       is not null then ', konto:'     ||:new.b_konto           end         
                        --                 ||case when :new.bil_drivstoff is not null then ', drivstoff:' ||:new.bil_drivstoff     end        
                        --                 ||case when :new.telefon       is not null then ', tlf:'       ||:new.telefon           end         
                        --                 ||case when :new.mail          is not null then ', mail:'      ||:new.mail              end 
                        --                 ||case when :new.leg_ref       is not null then ', leg-ref:'   ||:new.leg_ref           end 
                        --                                                                                                                  ,1,100);
                        ----1.a) uni info          
                        --    s_dato            := to_char(sysdate    ,'yyyy-mm-dd');
                        --    s_gyldigtildato   := to_char(sysdate+10d,'yyyy-mm-dd');
                        --    n_momsprosent     := case when :new.priv_bed='B' then 25                else 0          end;          
                        --    n_mvagrunnlag     := case when :new.priv_bed='B' then -:new.pris * 0.75 else 0          end;              
                        --    n_moms            := case when :new.priv_bed='B' then -:new.pris * 0.25 else 0          end;              
                        --    n_nettosum        := case when :new.priv_bed='B' then -:new.pris * 0.75 else -:new.pris end;                     
                        --    n_dekningsbidrag  := case when :new.priv_bed='B' then -:new.pris * 0.75 else -:new.pris end;                     
                    dbms_output.put_line (txt_status);
                    txt_return := txt_status;     txt_status:=null;  txt_todo:=null; 

                txt_status := ' 2)   NESTE ID i varelnordre@uni_2: ';
                    dbms_output.put_line (txt_status);
                        select max("ID")+1  into tilbudsnr from varelnordre@uni_2;

                    txt_todo := txt_todo ||'--> tilbudsnr='||tilbudsnr;
                    dbms_output.put_line (txt_todo);
                    txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 

                txt_status := ' 3)   INSERT: ';
                    dbms_output.put_line (txt_status);
                    begin
                        insert into tilbud@uni_2( "Signatur"        ,
                                                  "Vaar_Ref"        ,
                                                  "Deres_Ref"       ,
                                                  "Behandlingsregel",
                                                  "Bet_maate"       ,
                                                  "NameID"          ,
                                                  "Rabatt"          ,
                                                  "Avgfritt_grunnlag",
                                                  "Registreringsdato",
                                      --enhet
                                                  "dim10"           ,  --enhet_seq_no                       
                                                  "dim9"            ,  --serie_seq_no                       
                                      ---kunde info
                                                  "Tilbudsnr"       ,
                                                  "Kundenr"         ,
                                                  "Kundenavn"       ,
                                                  "Adresse"         ,
                                                  "Adresse2"        ,
                                                  "Postnr"          ,
                                                  "Poststed"        ,  
                                                  "Kommentarer"     ,  --her m� vraknr inn slik at det vises p� faktura evnt mer info....                              
                                      ---bil info
                                                  --se varelntilb
                                      ---uni info
                                                  "Dato"            ,
                                                  "GyldigTilDato"   ,
                                                  "Status"          ,  --110300 Registrert
                                                  "Totalsum"        ,  -- 1000kr
                                                  "Momsprosent"     ,  -- 25%                                  
                                                  "Mvagrunnlag"     ,  -- Hvis bedrift 1000 x 0,75
                                                  "Moms"            ,  -- Hvis bedrift 1000 x 0,25
                                                  "Nettosum"        ,  --brukes uavhengig om det er privat / bedrift
                                                  "Dekningsbidrag"  ) 
                        values(                 
                                                  'bildeler.net'                                                      ,
                                                  'bildeler.net'                                                      ,
                                                  'vrakpantbil'                                                       ,
                                                  0                                                                   ,  --Behandlingsregel
                                                  0                                                                   ,  --Bet_maate
                                                  0                                                                   ,  --NameID
                                                  0                                                                   ,  --Rabatt
                                                  0                                                                   ,  --Avgfritt_grunnlag
                                                  s_dato                                                              ,  --Registreringsdato
                                      --enhet
                                                  :new.enhet_seq_no                                                   ,
                                                  :new.serie_seq_no                                                   ,
                                      ---kunde info           
                                                  tilbudsnr                                                           ,
                                                  :new.kundenr                                                        ,
                                                  s_kundenavn                                                         , 
                                                  s_adresse                                                           , 
                                                  s_adresse2                                                          , 
                                                  s_postnr                                                            , 
                                                  s_poststed                                                          ,
                                                  s_kommentarer                                                       ,
                                      ---bil info
                                                  --se varelntilb
                                      ---uni info
                                                  s_dato                                                              ,  --dato
                                                  s_gyldigtildato                                                     ,  --gyldigtildato 
                                                  110300                                                              ,  --status
                                                  -:new.pris                                                          ,  --totalsum
                                                  n_momsprosent                                                       ,
                                                  n_mvagrunnlag                                                       ,
                                                  n_moms                                                              ,
                                                  n_nettosum                                                          ,
                                                  n_dekningsbidrag                                                    );  --dekningsbidrag

                        txt_todo  := '  3.a) Success inserting'; 
                        dbms_output.put_line (txt_todo);
                        txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 

                    exception when others then 
                        txt_todo := '  3.b) Failure inserting sqlcode='||sqlcode||' sqlerrm='||sqlerrm; 
                        dbms_output.put_line (txt_todo);
                        txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 
                        raise error_exc;  --hopper exception ut
                    end;

                --2  ) varelntilb@uni_2
                --2.a) Linje 1 = pris
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    --s_varenr     := substr('V'||tilbudsnr              ,1,20);
                    s_varenr     := substr('vrak'                      ,1,20);  --bruker eksisterende s� blir det ikke kr�ll med fakturering
                    s_varetekst  := substr('Vrak kj�pt av Olas Bil as',1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,
                                              1                  ,
                                              8                  ,  --Momskode 
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              -:new.pris         ,
                                              -:new.pris         ,
                                              n_moms             ,
                                              110300             ,  
                                              100                ,
                                              n_dekningsbidrag   ,
                                              10                 );

                --2.b) Linje 2 = Merke/ Type/Model
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Merke/ Type / Model'      ,1,20);

                    --2018-09-20 Legger inn infor fra LOV_OBAS_BIL helle
                    --s_varetekst  := substr(:new.bil_merke||' '||:new.bil_type||' '||:new.bil_modell||' '||:new.bil_drivstoff   ,1,150);
                    select substr(max(obas),1,150) into s_varetekst from ola.v_var_bil where var_bil_seq_no = :new.var_bil_seq_no;


                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              20                 );

                --2.c) Linje 3 = Reg.no /chassisnr
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr(:new.reg_no      ,1,20);
                    s_varetekst  := substr(:new.chassis_no  ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              30                 );

                --2.d) Linje 4 = Vrakmelding
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Vrakmelding:'                               ,1,20);
                    s_varetekst  := substr('Oversendes Oslo og Akershus Tolldistrikt'   ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              40                 );

                --2.e) Linje 5 = NB! Ta med bombrikke  / N�kler legges i bilen/ Er det gasstank i bilen?
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Bankkonto'                              ,1,20);
                    s_varetekst  := substr(:new.b_konto                             ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              50                 );

                --2.f) Linje 6 = SELGERS UNDERSKRIFT:
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr(:new.telefon ,1,20);
                    s_varetekst  := substr(:new.leg_ref ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              60                 );

    
            end if;
        
            if UPDATING and nvl(:new.bet_metode,'x')<>'V' then 
              dbms_output.put_line ('NOP');
            end if;   
       
            txt_return := chr(10)||'<'||proc_name||'>'||chr(10)||txt_return||chr(10)||'</'||proc_name||'>';
            dbms_output.put_line (                               txt_return);           

            exception when error_exc then
                --if error_txt is not null then
                --    error_txt := 'PR_V_ITEM retur1111: '||txt_return||' error: '||error_txt||' sqlcode='||sqlcode||' sqlerrm='||sqlerrm;
                --    dbms_output.put_line (          chr(10)||error_txt||' '||chr(10)||sqlcode||' '||chr(10)||sqlerrm);
                --    raise_application_error(-20001, chr(10)||error_txt||' '||chr(10)||sqlcode||' '||chr(10)||sqlerrm);	  		       
                --else 
                txt_return := txt_return||chr(10)||txt_status||txt_todo;     txt_status:=null;  txt_todo:=null; 
                txt_return := chr(10)||'<'||proc_name||' CUSTOM ERROR>'||chr(10)||txt_return||                                                                                        '</'||proc_name||' CUSTOM ERROR>'||chr(10);
                dbms_output.put_line (                                            txt_return);
                -- p_result :=                                                    txt_return;
                --end if;
                raise_application_error(-20001,                                   txt_return);	  		       
            when others then
                txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 
                txt_return := chr(10)||'<'||proc_name||' OTHER ERROR>' ||chr(10)||txt_return||chr(10)||'<OTHR> sqlcode='||sqlcode||chr(10)||' sqlerrm='||sqlerrm||'</OTHR>'||chr(10)||'</'||proc_name||' OTHER ERROR>'||chr(10);
                dbms_output.put_line (                                            txt_return);
                -- p_result :=                                                    txt_return;
                raise_application_error(-20001,                                   txt_return);	  		       
        end;
    /




----------------------------------------------------------- v_uni_tilbud  (spezial versjon i ola/ola@obas) -----------------------------------------------------------------------------------------------------------------------------------    
    create or replace view v_uni_tilbud as
        select
             tilbud."Kundenr"                        as t_kundenr
            ,tilbud."NameID"                         as t_nameid
            ,tilbud."Kundenavn"                      as t_kundenavn
            ,tilbud."Adresse"                        as t_adresse
            ,tilbud."Adresse2"                       as t_adresse2
            ,tilbud."Postnr"                         as t_postnr
            ,tilbud."Poststed"                       as t_poststed
            ,tilbud."Landkode"                       as t_landkode
            ,tilbud."Land"                           as t_land
            ,tilbud."Dato"                           as t_dato
            ,tilbud."GyldigTilDato"                  as t_gyldigtildato
            ,tilbud."Avgfritt_grunnlag"              as t_avgfritt_grunnlag
            ,tilbud."Behandlingsregel"               as t_behandlingsregel
            ,tilbud."Bet_maate"                      as t_bet_maate
            ,tilbud."Dekningsbidrag"                 as t_dekningsbidrag
            ,tilbud."Deres_Ref"                      as t_deres_ref
            ,tilbud."Vaar_Ref"                       as t_vaar_ref
            ,tilbud."Fritekst"                       as t_fritekst
            ,tilbud."Kommentarer"                    as t_kommentarer
            ,tilbud."Levering"                       as t_levering
            ,tilbud."Moms"                           as t_moms
            ,tilbud."Momsprosent"                    as t_momsprosent
            ,tilbud."Mvagrunnlag"                    as t_mvagrunnlag
            ,tilbud."Nettosum"                       as t_nettosum
            ,tilbud."Rabatt"                         as t_rabatt
            ,tilbud."Registreringsdato"              as t_registreringsdato
            ,tilbud."Rekvisisjon"                    as t_rekvisisjon
            ,tilbud."Selgernr1"                      as t_selgernr1
            ,tilbud."Selgernr2"                      as t_selgernr2
            ,tilbud."Spraak"                         as t_spraak
            ,tilbud."Totalsum"                       as t_totalsum
            ,tilbud."Transportmaate"                 as t_transportmaate
            ,tilbud."Transport"                      as t_transport
            ,tilbud."Transportoer"                   as t_transportoer
            ,tilbud."Status"                         as t_status
            ,tilbud."Type"                           as t_type
            ,tilbud."Valuta"                         as t_valuta
            ,tilbud."Dager_Kreditt"                  as t_dager_kreditt
            ,tilbud."DokumentID"                     as t_dokumentid
            ,tilbud."dim1"                           as t_dim1
            ,tilbud."dim2"                           as t_dim2
            ,tilbud."dim3"                           as t_dim3
            ,tilbud."dim4"                           as t_dim4
            ,tilbud."dim5"                           as t_dim5
            ,tilbud."dim6"                           as t_dim6
            ,tilbud."dim7"                           as t_dim7
            ,tilbud."dim8"                           as t_dim8
            ,tilbud."dim9"                           as t_dim9
            ,tilbud."dim10"                          as t_dim10
            ,tilbud."ValutaKode"                     as t_valutakode
            ,tilbud."ValutaSum"                      as t_valutasum
            ,tilbud."ValutaForced"                   as t_valutaforced
            ,tilbud."GrlHoy"                         as t_grlhoy
            ,tilbud."GrlLav"                         as t_grllav
            ,tilbud."GrlLav2"                        as t_grllav2
            ,tilbud."MomsHoy"                        as t_momshoy
            ,tilbud."MomsLav"                        as t_momslav
            ,tilbud."MomsLav2"                       as t_momslav2
            ,tilbud."PrintStatus"                    as t_printstatus
            ,tilbud."Leveringstid"                   as t_leveringstid
            ,tilbud."BetBetingelse"                  as t_betbetingelse
            ,tilbud."LevBetingelse"                  as t_levbetingelse
            ,tilbud."Signatur"                       as t_signatur
            ,tilbud."BehStatID"                      as t_behstatid
            ,tilbud."ForventetSalgsDato"             as t_forventetsalgsdato
            ,tilbud."SannsynligSalgProsent"          as t_sannsynligsalgprosent
            ,tilbud."Selgernr3"                      as t_selgernr3
            ,tilbud."Selgernr4"                      as t_selgernr4
            ,tilbud."Selgernr5"                      as t_selgernr5
            ,tilbud."Rabattavtalenr"                 as t_rabattavtalenr
            ,tilbud."fraktid"                        as t_fraktid
            ,tilbud."Mottaker"                       as t_mottaker
            ,tilbud."LevAdr1"                        as t_levadr1
            ,tilbud."LevAdr2"                        as t_levadr2
            ,tilbud."LevPostnr"                      as t_levpostnr
            ,tilbud."LevPoststed"                    as t_levpoststed
            ,tilbud."LevLandkode"                    as t_levlandkode
            ,tilbud."LevLand"                        as t_levland
            ,tilbud."GrlMarine"                      as t_grlmarine
            ,tilbud."MomsMarine"                     as t_momsmarine
            ,tilbud."LevAdrID"                       as t_levadrid
            ,varelntilb."ID"                                  as t_l_id                      
            ,varelntilb."Tilbudsnr"                           as t_l_tilbudsnr                       
            ,varelntilb."Kundenr"                             as t_l_kundenr                     
            ,varelntilb."Varenr"                              as t_l_varenr                      
            ,varelntilb."Varetekst"                           as t_l_varetekst                       
            ,varelntilb."ErstatnVareid"                       as t_l_erstatnvareid                       
            ,varelntilb."Antall"                              as t_l_antall                      
            ,varelntilb."Enhet"                               as t_l_enhet                       
            ,varelntilb."InnPris"                             as t_l_innpris                     
            ,varelntilb."Kostnad"                             as t_l_kostnad                     
            ,varelntilb."Kontonr"                             as t_l_kontonr                     
            ,varelntilb."Momskode"                            as t_l_momskode                        
            ,varelntilb."Pris"                                as t_l_pris                        
            ,varelntilb."Rabatt"                              as t_l_rabatt                      
            ,varelntilb."Serienr"                             as t_l_serienr                     
            ,varelntilb."LSum"                                as t_l_lsum                        
            ,varelntilb."Type"                                as t_l_type                        
            ,varelntilb."Status"                              as t_l_status                      
            ,varelntilb."Db"                                  as t_l_db                      
            ,varelntilb."Netto"                               as t_l_netto                       
            ,varelntilb."Mva"                                 as t_l_mva                     
            ,varelntilb."dim1"                                as t_l_dim1                        
            ,varelntilb."dim2"                                as t_l_dim2                        
            ,varelntilb."dim3"                                as t_l_dim3                        
            ,varelntilb."dim4"                                as t_l_dim4                        
            ,varelntilb."dim5"                                as t_l_dim5                        
            ,varelntilb."dim6"                                as t_l_dim6                        
            ,varelntilb."dim7"                                as t_l_dim7                        
            ,varelntilb."dim8"                                as t_l_dim8                        
            ,varelntilb."dim9"                                as t_l_dim9                        
            ,varelntilb."dim10"                               as t_l_dim10                       
            ,varelntilb."Komp_lagertype"                      as t_l_komp_lagertype                      
            ,varelntilb."Komp_visningstype"                   as t_l_komp_visningstype                       
            ,varelntilb."Komp_pristype"                       as t_l_komp_pristype                       
            ,varelntilb."ValutaKode"                          as t_l_valutakode                      
            ,varelntilb."ValutaLSum"                          as t_l_valutalsum                      
            ,varelntilb."ValutaPrice"                         as t_l_valutaprice                     
            ,varelntilb."Komp_level"                          as t_l_komp_level                      
            ,varelntilb."Momsprosent"                         as t_l_momsprosent                     
            ,varelntilb."div1"                                as t_l_div1                        
            ,varelntilb."weight_per_unit"                     as t_l_weight_per_unit                     
            ,varelntilb."weight_total"                        as t_l_weight_total                        
            ,varelntilb."dimension_x"                         as t_l_dimension_x                     
            ,varelntilb."dimension_y"                         as t_l_dimension_y                     
            ,varelntilb."dimension_z"                         as t_l_dimension_z                     
            ,varelntilb."dimension_p"                         as t_l_dimension_p                     
            ,varelntilb."dimension_n"                         as t_l_dimension_n                     
            ,varelntilb."itemnr"                              as t_l_itemnr                      
            ,varelntilb."anbudtype"                           as t_l_anbudtype                       
            ,varelntilb."AvgMalId"                            as t_l_avgmalid                        
            ,varelntilb."AvgMalType"                          as t_l_avgmaltype                      
            ,varelntilb."MiljoavgForID"                       as t_l_miljoavgforid                       
            ,varelntilb."fraktLinjeID"                        as t_l_fraktlinjeid                        
            ,varelntilb."SerienrLager"                        as t_l_serienrlager                        
            ,varelntilb."TrackingID"                           as t_l_trackingid                       
        from     tilbud@uni_2           tilbud
                ,varelntilb@uni_2       varelntilb
        where varelntilb."Tilbudsnr" = tilbud."Tilbudsnr" 
    /

    grant select on v_uni_tilbud to public;

    --spezial obas6 6 lager tabell identisk til view
    create table v_uni_tilbud (
 		 TILBUDSNR                                          NUMBER(10)
 		,KUNDENR                                            NUMBER(10)
 		,NAMEID                                             NUMBER(10)
 		,KUNDENAVN                                          VARCHAR2(60)
 		,ADRESSE                                            VARCHAR2(60)
 		,ADRESSE2                                           VARCHAR2(60)
 		,POSTNR                                             VARCHAR2(10)
 		,POSTSTED                                           VARCHAR2(60)
 		,LANDKODE                                           VARCHAR2(10)
 		,LAND                                               VARCHAR2(30)
 		,DATO                                               DATE
 		,GYLDIGTILDATO                                      DATE
 		,AVGFRITT_GRUNNLAG                                  NUMBER(19,4)
 		,BEHANDLINGSREGEL                                   NUMBER(10)
 		,BET_MAATE                                          NUMBER(10)
 		,DEKNINGSBIDRAG                                     NUMBER(19,4)
 		,DERES_REF                                          VARCHAR2(50)
 		,VAAR_REF                                           VARCHAR2(50)
 		,KOMMENTARER                                        VARCHAR2(100)
 		,MOMS                                               NUMBER(19,4)
 		,MOMSPROSENT                                        NUMBER(19,4)
 		,MVAGRUNNLAG                                        NUMBER(19,4)
 		,NETTOSUM                                           NUMBER(19,4)
 		,RABATT                                             NUMBER(19,4)
 		,REGISTRERINGSDATO                                  DATE
 		,REKVISISJON                                        VARCHAR2(60)
 		,SELGERNR1                                          NUMBER(10)
 		,SELGERNR2                                          NUMBER(10)
 		,SPRAAK                                             NUMBER(10)
 		,TOTALSUM                                           NUMBER(19,4)
 		,TRANSPORTMAATE                                     VARCHAR2(50)
 		,TRANSPORT                                          VARCHAR2(40)
 		,TRANSPORTOER                                       NUMBER(10)
 		,STATUS                                             NUMBER(10)
 		,TYPE                                               NUMBER(10)
 		,VALUTA                                             NUMBER(10)
 		,DAGER_KREDITT                                      NUMBER(10)
 		,DOKUMENTID                                         NUMBER(10)
 		,DIM1                                               NUMBER(10)
 		,DIM2                                               NUMBER(10)
 		,DIM3                                               NUMBER(10)
 		,DIM4                                               NUMBER(10)
 		,DIM5                                               NUMBER(10)
 		,DIM6                                               NUMBER(10)
 		,DIM7                                               NUMBER(10)
 		,DIM8                                               NUMBER(10)
 		,DIM9                                               NUMBER(10)
 		,DIM10                                              NUMBER(10)
 		,VALUTAKODE                                         VARCHAR2(10)
 		,VALUTASUM                                          NUMBER(19,4)
 		,VALUTAFORCED                                       NUMBER(10)
 		,GRLHOY                                             NUMBER(19,4)
 		,GRLLAV                                             NUMBER(19,4)
 		,GRLLAV2                                            NUMBER(19,4)
 		,MOMSHOY                                            NUMBER(19,4)
 		,MOMSLAV                                            NUMBER(19,4)
 		,MOMSLAV2                                           NUMBER(19,4)
 		,PRINTEGERSTATUS                                    NUMBER(10)
 		,LEVERINGSTID                                       VARCHAR2(50)
 		,BETBETINGELSE                                      VARCHAR2(50)
 		,LEVBETINGELSE                                      VARCHAR2(50)
 		,SIGNATUR                                           VARCHAR2(50)
 		,BEHSTATID                                          NUMBER(10)
 		,FORVENTETSALGSDATO                                 DATE
 		,SANNSYNLIGSALGPROSENT                              NUMBER(10)
 		,SELGERNR3                                          NUMBER(10)
 		,SELGERNR4                                          NUMBER(10)
 		,SELGERNR5                                          NUMBER(10)
 		,RABATTAVTALENR                                     NUMBER(10)
 		,FRAKTID                                            NUMBER(10)
 		,MOTTAKER                                           VARCHAR2(60)
 		,LEVADR1                                            VARCHAR2(60)
 		,LEVADR2                                            VARCHAR2(60)
 		,LEVPOSTNR                                          VARCHAR2(10)
 		,LEVPOSTSTED                                        VARCHAR2(60)
 		,LEVLANDKODE                                        VARCHAR2(60)
 		,LEVLAND                                            VARCHAR2(60)
 		,LEG_REF                                            VARCHAR2(60)
 		,NAVN                                               VARCHAR2(60)
 		,ETTERNAVN                                          VARCHAR2(60)
 		,ADR                                                VARCHAR2(60)
 		,ADR2                                               VARCHAR2(60)
 		,PNR                                                VARCHAR2(10)
 		,PSTED                                              VARCHAR2(60)
 		,TELEFON                                            VARCHAR2(60)
 		,MAIL                                               VARCHAR2(60)
 		,REG_NO                                             VARCHAR2(60)
 		,CHASSIS_NO                                         VARCHAR2(60)
 		,BIL_MERKE                                          VARCHAR2(60)
 		,BIL_TYPE                                           VARCHAR2(60)
 		,BIL_MODELL                                         VARCHAR2(60)
 		,BIL_DRIVSTOFF                                      VARCHAR2(60)
 		,BET_METODE                                         VARCHAR2(1)
 		,B_KONTO                                            VARCHAR2(60)
 		,PRIV_BED                                           VARCHAR2(1)
 		,MVA                                                NUMBER
 		,PRIS                                               NUMBER
 		,MERKNAD                                            VARCHAR2(60)
 		,ENHET_SEQ_NO                                       NUMBER
 		,SERIE_SEQ_NO                                       NUMBER
 		,VAR_BIL_SEQ_NO                                     NUMBER
 		,TEMP                                               VARCHAR2(4000)
        )
    /

    select count(*) from tilbud@uni_2 tilbud, varelntilb@uni_2 varelntilb where varelntilb."Tilbudsnr" = tilbud."Tilbudsnr";
    #42182
    select count(*) from tilbud@uni_2 tilbud, varelntilb@uni_2 varelntilb where varelntilb."Tilbudsnr" = tilbud."Tilbudsnr" (+);
    #42184

    --ola/ola@obas spezial
    create or replace view v_uni_tilbud  as
      --2016-07-18 laget 
      --2019-11-19 oppdatert med apex +++
      ------------------
      --
      --NBNB  HUSK å LEGGER INSTEAD of trigger 
      --
      select
          "Tilbudsnr"                         tilbudsnr               ,   --int                 
          "Kundenr"                           kundenr                 ,   --int                 
          "NameID"                            nameid                  ,   --int                 
          "Kundenavn"                         kundenavn               ,   --varchar(60)         
          "Adresse"                           adresse                 ,   --varchar(60)         
          "Adresse2"                          adresse2                ,   --varchar(60)         
          "Postnr"                            postnr                  ,   --varchar(10)         
          "Poststed"                          poststed                ,   --varchar(60)         
          "Landkode"                          landkode                ,   --varchar(10)         
          "Land"                              land                    ,   --varchar(30)         
          "Dato"                              dato                    ,   --smalldatetime       
          "GyldigTilDato"                     gyldigtildato           ,   --smalldatetime       
          "Avgfritt_grunnlag"                 avgfritt_grunnlag       ,   --money               
          "Behandlingsregel"                  behandlingsregel        ,   --int                 
          "Bet_maate"                         bet_maate               ,   --int                 
          "Dekningsbidrag"                    dekningsbidrag          ,   --money               
          "Deres_Ref"                         deres_ref               ,   --varchar(50)         
          "Vaar_Ref"                          vaar_ref                ,   --varchar(50) 
        --CAST("Fritekst" as varchar(800))    fritekst                ,   --text          <<-------      
        --convert(varchar(80),"Fritekst")     fritekst                ,   --text          <<-------      
          "Kommentarer"                       kommentarer             ,   --varchar(100)        
        --CAST("Levering" as varchar(800))    levering                ,   --text          <<-------      
        --convert(varchar(80),"Levering")     levering                ,   --text          <<-------      
          "Moms"                              moms                    ,   --money               
          "Momsprosent"                       momsprosent             ,   --money               
          "Mvagrunnlag"                       mvagrunnlag             ,   --money               
          "Nettosum"                          nettosum                ,   --money               
          "Rabatt"                            rabatt                  ,   --money               
          "Registreringsdato"                 registreringsdato       ,   --smalldatetime       
          "Rekvisisjon"                       rekvisisjon             ,   --varchar(60)         
          "Selgernr1"                         selgernr1               ,   --int                 
          "Selgernr2"                         selgernr2               ,   --int                 
          "Spraak"                            spraak                  ,   --int                 
          "Totalsum"                          totalsum                ,   --money               
          "Transportmaate"                    transportmaate          ,   --varchar(50)         
          "Transport"                         transport               ,   --varchar(40)         
          "Transportoer"                      transportoer            ,   --int                 
          "Status"                            status                  ,   --int                 
          "Type"                              type                    ,   --int                 
          "Valuta"                            valuta                  ,   --int                 
          "Dager_Kreditt"                     dager_kreditt           ,   --int                 
          "DokumentID"                        dokumentid              ,   --int                 
          "dim1"                              dim1                    ,   --int                 
          "dim2"                              dim2                    ,   --int                 
          "dim3"                              dim3                    ,   --int                 
          "dim4"                              dim4                    ,   --int                 
          "dim5"                              dim5                    ,   --int                 
          "dim6"                              dim6                    ,   --int                 
          "dim7"                              dim7                    ,   --int                 
          "dim8"                              dim8                    ,   --int                 
          "dim9"                              dim9                    ,   --int                 
          "dim10"                             dim10                   ,   --int                 
          "ValutaKode"                        valutakode              ,   --varchar(10)         
          "ValutaSum"                         valutasum               ,   --money               
          "ValutaForced"                      valutaforced            ,   --int                 
          "GrlHoy"                            grlhoy                  ,   --money               
          "GrlLav"                            grllav                  ,   --money               
          "GrlLav2"                           grllav2                 ,   --money               
          "MomsHoy"                           momshoy                 ,   --money               
          "MomsLav"                           momslav                 ,   --money               
          "MomsLav2"                          momslav2                ,   --money               
          "PrintStatus"                       printegerstatus         ,   --int                 
          "Leveringstid"                      leveringstid            ,   --varchar(50)         
          "BetBetingelse"                     betbetingelse           ,   --varchar(50)         
          "LevBetingelse"                     levbetingelse           ,   --varchar(50)         
          "Signatur"                          signatur                ,   --varchar(50)         
          "BehStatID"                         behstatid               ,   --int                 
          "ForventetSalgsDato"                forventetsalgsdato      ,   --smalldatetime       
          "SannsynligSalgProsent"             sannsynligsalgprosent   ,   --int                 
          "Selgernr3"                         selgernr3               ,   --int                 
          "Selgernr4"                         selgernr4               ,   --int                 
          "Selgernr5"                         selgernr5               ,   --int                 
          "Rabattavtalenr"                    rabattavtalenr          ,   --int                 
          "fraktid"                           fraktid                 ,   --int                 
          "Mottaker"                          mottaker                ,   --varchar(60)         
          "LevAdr1"                           levadr1                 ,   --varchar(60)         
          "LevAdr2"                           levadr2                 ,   --varchar(60)         
          "LevPostnr"                         levpostnr               ,   --varchar(10)         
          "LevPoststed"                       levpoststed             ,   --varchar(60)         
          "LevLandkode"                       levlandkode             ,   --varchar(60)         
          "LevLand"                           levland,                     --varchar(60) 
          -------------kunde
          cast ('' as varchar2(60))           leg_ref             ,
          cast ('' as varchar2(60))           navn                ,
          cast ('' as varchar2(60))           etternavn           ,
          cast ('' as varchar2(60))           adr                 ,
          cast ('' as varchar2(60))           adr2                ,
          cast ('' as varchar2(10))           pnr                 ,
          cast ('' as varchar2(60))           psted               ,
          cast ('' as varchar2(60))           telefon             ,
          cast ('' as varchar2(60))           mail                ,
          -------------bil
          cast ('' as varchar2(60))           reg_no              ,
          cast ('' as varchar2(60))           chassis_no          ,
          cast ('' as varchar2(60))           bil_merke           ,
          cast ('' as varchar2(60))           bil_type            ,
          cast ('' as varchar2(60))           bil_modell          ,
          cast ('' as varchar2(60))           bil_drivstoff       ,   --check list1 bensin, diesel, elektrisk gass
          -------------uni 
          cast ('' as varchar2(1) )           bet_metode          ,  --radio button
          cast ('' as varchar2(60))           b_konto             ,
          cast ('' as varchar2(1) )           priv_bed            ,  --radio butt
          cast ('' as number)                 mva                 ,  --settes hvis bed i trigger ikke i APEX
          cast ('' as number)                 pris                ,  --alltid inkl mva hvis bedrift
          cast ('' as varchar2(60))           merknad             ,
          -------------enhet
          cast ('' as number)                 enhet_seq_no        ,  
          cast ('' as number)                 serie_seq_no        ,        
          cast ('' as number)                 var_bil_seq_no      ,          
          cast ('' as varchar2(4000))         temp             
      from tilbud@uni_2
      /
      grant all on v_uni_tilbud to public
      /

    --drop sequence uni_tilbudsnr;
    create sequence uni_tilbudsnr increment by 1 start with 36000;  
        --pr 2019_11_18 max nr i vrak tilbuden 35967
        --pr 2019_11_18 max nr i tilbud generert i UNI gui  tilbuden 3719

    create or replace trigger tr_instd_v_uni_tilbud instead of insert or update or delete on v_uni_tilbud for each row
        /* ***********************************************************************
            **
            2016_07_18 laget  etter at alt annet feilet (dvs uni_tilbud tabbelll og triggere)
            2018_09_06 hvis betalingsmåte V Vraksys legges ikke noe inni UNI

              Test
                   --set serveroutput on size unlimited                  

                  --select "Tilbudsnr" from v_test where rownum <5;
                  --select uni_tilbudsnr_seq.nextval from dual;
                  --insert into v_uni_tilbud(tilbudsnr) values (uni_tilbudsnr_seq.nextval);
                  --insert into v_uni_tilbud(tilbudsnr) values (36008);
                  --insert into tilbud@uni_2("Tilbudsnr") values(uni_tilbudsnr_seq.nextval);
                  --insert into tilbud@uni_2("Tilbudsnr") values(36001);

                  --sqlplus sys/Ora12c1601@192.168.1.3:1521/pdbobas as sysdba
                  --create table ttt (ant number);
                  --insert into ttt(ant) values(-1);
                  --drop public database link test ;
                  --create public database link test connect to ola identified by ola using 'obas';
                  --desc enhet@test
                  --insert into ttt@test(ant) values(-2);

            **
            ** **********************************************************************/
        declare
          --PRAGMA AUTONOMOUS_TRANSACTION;  --ORA-02047: cannot join the distributed  workaround http://www.orafaq.com/forum/t/186525/
            proc_name       varchar2(35) :='tr_instd_v_uni_tilbud';
            txt_todo   		varchar2(32767);
            txt_error   	varchar2(32767);
            txt_status   	varchar2(32767);    --akumulert
            txt_return   	varchar2(32767);    
            error_txt   	varchar2(32767);
            error_exc       exception;

            l_time_stamp    date 	:= sysdate;
            l_date_in       date    := l_time_stamp;  
            l_date_upd      date    := l_time_stamp;  

            todo_txt      varchar2(1024);
            p_out_feil    varchar2(1024);
            date_in       date;
            date_upd      date;
            tilbudsnr     number;
            id_nr         number;
          ---kunde info
            s_kundenavn       varchar2(60);
            s_adresse         varchar2(60);
            s_adresse2        varchar2(60);
            s_postnr          varchar2(10);
            s_poststed        varchar2(60);  
            s_kommentarer     varchar2(100);
          ---uni info    
            s_dato            varchar2(10);
            s_gyldigtildato   varchar2(10);
            n_momsprosent     number;       
            n_mvagrunnlag     number;  
            n_moms            number;  
            n_nettosum        number;  
            n_dekningsbidrag  number; 
          --uni varelntilb
            s_varenr          varchar2(20);
            s_varetekst       varchar2(150);
    
        begin
          dbms_output.put_line ('>>>>>>>> '||proc_name||' '||l_time_stamp||'.......');

            if INSERTING  and nvl(:new.bet_metode,'x') <> 'V' then

                txt_status := ' 1)   INPUT';
                    --1.a) kunde info
                        --piping substr, case funker ikke inni insert statment mot hetrogenous gateways
                        --ORA-02070: databasen UNI_2 st�tter ikke SUBSTR i denne konteksten
                        s_kundenavn       := substr(:new.navn||' '||:new.etternavn                                                    ,1,60);
                        s_adresse         := substr(:new.adr                                                                          ,1,60);
                        s_adresse2        := substr(:new.adr2                                                                         ,1,60);
                        s_postnr          := substr(:new.pnr                                                                          ,1,10);
                        s_poststed        := substr(:new.psted                                                                        ,1,60);  
                        s_kommentarer     := substr('V'||tilbudsnr                        
                                     ||case when :new.b_konto       is not null then ', konto:'     ||:new.b_konto           end         
                                     ||case when :new.bil_drivstoff is not null then ', drivstoff:' ||:new.bil_drivstoff     end        
                                     ||case when :new.telefon       is not null then ', tlf:'       ||:new.telefon           end         
                                     ||case when :new.mail          is not null then ', mail:'      ||:new.mail              end 
                                     ||case when :new.leg_ref       is not null then ', leg-ref:'   ||:new.leg_ref           end 
                                                                                                                                      ,1,100);
                    --1.a) uni info          
                        s_dato            := to_char(sysdate    ,'yyyy-mm-dd');
                        s_gyldigtildato   := to_char(sysdate+10d,'yyyy-mm-dd');
                        n_momsprosent     := case when :new.priv_bed='B' then 25                else 0          end;          
                        n_mvagrunnlag     := case when :new.priv_bed='B' then -:new.pris * 0.75 else 0          end;              
                        n_moms            := case when :new.priv_bed='B' then -:new.pris * 0.25 else 0          end;              
                        n_nettosum        := case when :new.priv_bed='B' then -:new.pris * 0.75 else -:new.pris end;                     
                        n_dekningsbidrag  := case when :new.priv_bed='B' then -:new.pris * 0.75 else -:new.pris end;                     
                    dbms_output.put_line (txt_status);
                    txt_return := txt_status;     txt_status:=null;  txt_todo:=null; 

                txt_status := ' 2)   NESTE TILBUDSNR: ';
                    dbms_output.put_line (txt_status);
                    if :new.tilbudsnr is null then
                        txt_todo                :=  '  2.a) fra tilbud@uni_2 ';
                        select max("Tilbudsnr")+1  into tilbudsnr from tilbud@uni_2;
                    else
                        txt_todo                :=  '  2.b) fra input ';
                        tilbudsnr := :new.tilbudsnr;
                    end if;

                    s_varenr := substr('V'||tilbudsnr,1,20);
                    txt_todo := txt_todo ||'--> tilbudsnr='||s_varenr;
                    dbms_output.put_line (txt_todo);
                    txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 

                txt_status := ' 3)   INSERT: ';
                    dbms_output.put_line (txt_status);
                    begin
                        insert into tilbud@uni_2( "Signatur"        ,
                                                  "Vaar_Ref"        ,
                                                  "Deres_Ref"       ,
                                                  "Behandlingsregel",
                                                  "Bet_maate"       ,
                                                  "NameID"          ,
                                                  "Rabatt"          ,
                                                  "Avgfritt_grunnlag",
                                                  "Registreringsdato",
                                      --enhet
                                                  "dim10"           ,  --enhet_seq_no                       
                                                  "dim9"            ,  --serie_seq_no                       
                                      ---kunde info
                                                  "Tilbudsnr"       ,
                                                  "Kundenr"         ,
                                                  "Kundenavn"       ,
                                                  "Adresse"         ,
                                                  "Adresse2"        ,
                                                  "Postnr"          ,
                                                  "Poststed"        ,  
                                                  "Kommentarer"     ,  --her m� vraknr inn slik at det vises p� faktura evnt mer info....                              
                                      ---bil info
                                                  --se varelntilb
                                      ---uni info
                                                  "Dato"            ,
                                                  "GyldigTilDato"   ,
                                                  "Status"          ,  --110300 Registrert
                                                  "Totalsum"        ,  -- 1000kr
                                                  "Momsprosent"     ,  -- 25%                                  
                                                  "Mvagrunnlag"     ,  -- Hvis bedrift 1000 x 0,75
                                                  "Moms"            ,  -- Hvis bedrift 1000 x 0,25
                                                  "Nettosum"        ,  --brukes uavhengig om det er privat / bedrift
                                                  "Dekningsbidrag"  ) 
                        values(                 
                                                  'bildeler.net'                                                      ,
                                                  'bildeler.net'                                                      ,
                                                  'vrakpantbil'                                                       ,
                                                  0                                                                   ,  --Behandlingsregel
                                                  0                                                                   ,  --Bet_maate
                                                  0                                                                   ,  --NameID
                                                  0                                                                   ,  --Rabatt
                                                  0                                                                   ,  --Avgfritt_grunnlag
                                                  s_dato                                                              ,  --Registreringsdato
                                      --enhet
                                                  :new.enhet_seq_no                                                   ,
                                                  :new.serie_seq_no                                                   ,
                                      ---kunde info           
                                                  tilbudsnr                                                           ,
                                                  :new.kundenr                                                        ,
                                                  s_kundenavn                                                         , 
                                                  s_adresse                                                           , 
                                                  s_adresse2                                                          , 
                                                  s_postnr                                                            , 
                                                  s_poststed                                                          ,
                                                  s_kommentarer                                                       ,
                                      ---bil info
                                                  --se varelntilb
                                      ---uni info
                                                  s_dato                                                              ,  --dato
                                                  s_gyldigtildato                                                     ,  --gyldigtildato 
                                                  110300                                                              ,  --status
                                                  -:new.pris                                                          ,  --totalsum
                                                  n_momsprosent                                                       ,
                                                  n_mvagrunnlag                                                       ,
                                                  n_moms                                                              ,
                                                  n_nettosum                                                          ,
                                                  n_dekningsbidrag                                                    );  --dekningsbidrag

                        txt_todo  := '  3.a) Success inserting'; 
                        dbms_output.put_line (txt_todo);
                        txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 

                    exception when others then 
                        txt_todo := '  3.b) Failure inserting sqlcode='||sqlcode||' sqlerrm='||sqlerrm; 
                        dbms_output.put_line (txt_todo);
                        txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 
                        raise error_exc;  --hopper exception ut
                    end;

                --2  ) varelntilb@uni_2
                --2.a) Linje 1 = pris
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    --s_varenr     := substr('V'||tilbudsnr              ,1,20);
                    s_varenr     := substr('vrak'                      ,1,20);  --bruker eksisterende s� blir det ikke kr�ll med fakturering
                    s_varetekst  := substr('Vrak kj�pt av Olas Bil as',1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,
                                              1                  ,
                                              8                  ,  --Momskode 
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              -:new.pris         ,
                                              -:new.pris         ,
                                              n_moms             ,
                                              110300             ,  
                                              100                ,
                                              n_dekningsbidrag   ,
                                              10                 );

                --2.b) Linje 2 = Merke/ Type/Model
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Merke/ Type / Model'      ,1,20);

                    --2018-09-20 Legger inn infor fra LOV_OBAS_BIL helle
                    --s_varetekst  := substr(:new.bil_merke||' '||:new.bil_type||' '||:new.bil_modell||' '||:new.bil_drivstoff   ,1,150);
                    select substr(max(obas),1,150) into s_varetekst from ola.v_var_bil where var_bil_seq_no = :new.var_bil_seq_no;


                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              20                 );

                --2.c) Linje 3 = Reg.no /chassisnr
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr(:new.reg_no      ,1,20);
                    s_varetekst  := substr(:new.chassis_no  ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              30                 );

                --2.d) Linje 4 = Vrakmelding
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Vrakmelding:'                               ,1,20);
                    s_varetekst  := substr('Oversendes Oslo og Akershus Tolldistrikt'   ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              40                 );

                --2.e) Linje 5 = NB! Ta med bombrikke  / N�kler legges i bilen/ Er det gasstank i bilen?
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr('Bankkonto'                              ,1,20);
                    s_varetekst  := substr(:new.b_konto                             ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              50                 );

                --2.f) Linje 6 = SELGERS UNDERSKRIFT:
                    select max("ID")+1  into id_nr from varelntilb@uni_2;

                    s_varenr     := substr(:new.telefon ,1,20);
                    s_varetekst  := substr(:new.leg_ref ,1,150);

                    insert into varelntilb@uni_2(
                                              "ID"              , 
                                              "Tilbudsnr"       ,
                                              "Kundenr"         ,
                                              "Varenr"          ,
                                              "Varetekst"       ,
                                              "Antall"          ,
                                              "Momskode"        ,   --8
                                              "InnPris"         ,   --0
                                              "Kostnad"         ,   --0
                                              "Rabatt"          ,   --0
                                              "Type"            ,   --0
                                              "Pris"            ,
                                              "LSum"            ,  -- minus pris  -3000
                                              "Mva"             ,
                                              "Status"          ,  --110300 reg, 110301 Overf�rt til ordre, 110302 Overf�rt til faktura
                                              "Db"              ,
                                              "Netto"           ,
                                              "TrackingID"      )   --sort order
                    values(   
                                              id_nr              ,
                                              tilbudsnr          ,
                                              :new.kundenr       ,
                                              s_varenr           ,
                                              s_varetekst        ,                                  
                                              0                  ,
                                              0                  ,  --Momskode  NB 0 n�
                                              0                  ,  --innpris
                                              0                  ,  --kostnad                                 
                                              0                  ,  --rabatt
                                              0                  ,  --type
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              110300             ,  
                                              0                  ,  --NB 0 n�
                                              0                  ,  --NB 0 n�
                                              60                 );

    
            end if;
        
            if UPDATING and nvl(:new.bet_metode,'x')<>'V' then 
              dbms_output.put_line ('NOP');
            end if;   
       
            txt_return := chr(10)||'<'||proc_name||'>'||chr(10)||txt_return||chr(10)||'</'||proc_name||'>';
            dbms_output.put_line (                               txt_return);           

            exception when error_exc then
                --if error_txt is not null then
                --    error_txt := 'PR_V_ITEM retur1111: '||txt_return||' error: '||error_txt||' sqlcode='||sqlcode||' sqlerrm='||sqlerrm;
                --    dbms_output.put_line (          chr(10)||error_txt||' '||chr(10)||sqlcode||' '||chr(10)||sqlerrm);
                --    raise_application_error(-20001, chr(10)||error_txt||' '||chr(10)||sqlcode||' '||chr(10)||sqlerrm);	  		       
                --else 
                txt_return := txt_return||chr(10)||txt_status||txt_todo;     txt_status:=null;  txt_todo:=null; 
                txt_return := chr(10)||'<'||proc_name||' CUSTOM ERROR>'||chr(10)||txt_return||                                                                                        '</'||proc_name||' CUSTOM ERROR>'||chr(10);
                dbms_output.put_line (                                            txt_return);
                -- p_result :=                                                    txt_return;
                --end if;
                raise_application_error(-20001,                                   txt_return);	  		       
            when others then
                txt_return := txt_return||chr(10)||txt_status||chr(10)||txt_todo;     txt_status:=null;  txt_todo:=null; 
                txt_return := chr(10)||'<'||proc_name||' OTHER ERROR>' ||chr(10)||txt_return||chr(10)||'<OTHR> sqlcode='||sqlcode||chr(10)||' sqlerrm='||sqlerrm||'</OTHR>'||chr(10)||'</'||proc_name||' OTHER ERROR>'||chr(10);
                dbms_output.put_line (                                            txt_return);
                -- p_result :=                                                    txt_return;
                raise_application_error(-20001,                                   txt_return);	  		       
        end;
    /

----------------------------------------------------------- v_uni_tilbud_rapp--------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_uni_tilbud_rapp  as
      /*
        Before we can create a report in the FO Designer we need 2 items:
          1) the schema of the xml data to be printed.
          2) an example xml file with sample data for testing.
            0)APEX Shared Components Report Query
                Output format : pdf
                View file  as :  attachment
                Source for rep: XML
                Print URL     : f?p=_APP_ID.:0:_SESSION.:PRINT_REPORT=V_UNI_TILBUD_RAPP
                Source Queries: select * from v_uni_tilbud_rapp where enhet_seq_no =:P627_ENHET_SEQ_NO
                                  --Test data
                                  --:P209_TIILBUDSNR =27185
                                  --200643  test 2013_05_11
                                  --select * from v_uni_tilbud_rapp where tilbudsnr=27185
                Session State : Incliude application and session information <<<<---- Må med elles klikker datasourcen i FO Designer
            1)Select XML data checkbox and click download to save the xml data file tasks_query.xml in your local drive
            2)Select XML Schema checkbox and click download to save the xml schema file tasks_query.xsd in your local drive
      Dato        Endring
      ===         =======        
      2016_08_04 laget
      */        
      select
          tilbud."Tilbudsnr"                                        tilbudsnr               ,   --int                 
          (select "Varetekst" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 60   )                  leg_ref                 ,   --varchar(150)          
          tilbud."Kundenavn"                                        kundenavn               ,   --varchar(60)  
          (select "Varenr" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 60   )                  telefon                 ,   --varchar(150)          
          (select "Varetekst" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 50   )                  b_konto                 ,   --varchar(150)          
          tilbud."Adresse"                                          adresse                 ,   --varchar(60)         
          tilbud."Postnr"                                           postnr                  ,   --varchar(10)         
          tilbud."Postnr" ||' '||tilbud."Poststed"                  poststed                ,   --varchar(60)         
          to_char(tilbud."Dato",'dd.mm.yyyy')                       dato                    ,   --smalldatetime       
          tilbud."Vaar_Ref"                                         vaar_ref                ,   --varchar(50) 
          tilbud."Kommentarer"                                      kommentarer             ,   --varchar(100)        
          to_char(tilbud."Totalsum"*-1)                             totalsum                ,   --money 
          (select "Varetekst" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 20   ) ||' '
                              merke_type_modell,          --varchar(150)          
          (select "Varenr" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 30   )                  reg_no,                     --varchar(150)          
          (select "Varetekst" 
            from varelntilb@uni_2 varelntilb
            where tilbud."Tilbudsnr" = varelntilb."Tilbudsnr"
            and   varelntilb."TrackingID" = 30   )                  chassis_no                  --varchar(150)          
      from tilbud@uni_2     tilbud
      --test TML
      --where tilbud."Tilbudsnr"=27000
      /
      grant select on v_uni_tilbud_rapp to public
      /
    
      select count(*) from v_uni_tilbud_rapp;
      --#93
    
        

----------------------------------------------------------- v_uni_bildeler -----------------------------------------------------------------------------------------------------------------------------------    
    --Døme fra Java som henter fra UNI og legger inni ekstern 11.04.2019  sequence var blitt number 9
        --Direkte i sqlserver
                SELECT 	distinct	'ORDRE',				           
                      VARELN.ERSTATNVAREID,                  
                      rtrim(VARELN.Ordrenr)    as ordrenr,   
                      VARE.VAAR_REF,                         
                      VARE.lastedit,                         
                      VARE.status,                           
                      rtrim(VARELN.Varenr)     as varenr,    
                      rtrim(VARELN.Varetekst)  as varetekst, 
                      VARELN.pris,                           
                      VARELN.rabatt,                         
                      VARELN.netto,                          
                      VARELN.mva,                            
                      VARELN.pris*1.25        as salgs_pris  
                FROM 	uni_2.dbo.VARELNORDRE VARELN,          
                      uni_2.dbo.ORDRE VARE                   
                where 1=1                                    
                and VARE.ordrenr = VARELN.ordrenr            
                and VARELN.Varenr like 'D%' 			           
                and 1=1                                      
                ORDER BY rtrim(VARELN.Ordrenr) DESC,         
                         rtrim(VARELN.Varenr)                

        --tilsvarende i sqlplus 
            --drop table t;
            --create table t as select * from  ekstern.uni_t_vareln ;
            --truncate table t;
            insert into t (type, enhet_seq_no, ordrenr, ordrenr_vaar_ref, ordrenr_last_edit, ordrenr_status, varenr, varetekst, pris, rabatt, netto, mva, salgs_pris) 
            select 	distinct	'ORDRE'     as type,				           
                  vareln."ErstatnVareid"    as enhet_seq_no,                  
                  rtrim(vareln."Ordrenr")    as ordrenr,   
                  vare."Vaar_Ref"           as ordrenr_vaar_ref              ,
                  vare."LastEdit"           as ordrenr_last_edit,                         
                  vare."Status"             as ordrenr_status,                           
                  rtrim(vareln."Varenr")     as varenr,    
                  rtrim(vareln."Varetekst")  as varetekst, 
                  vareln."Pris"             as pris,                           
                  vareln."Rabatt"           as rabatt,                         
                  vareln."Netto"            as netto,                          
                  vareln."Mva"              as mva,                            
                  round(vareln."Pris"*1.25,2)   as salgs_pris  
            from 	varelnordre@uni_2 vareln,          
                  ordre@uni_2 vare                   
            where 1=1                                    
            and vare."Ordrenr" = vareln."Ordrenr"            
            and vareln."Varenr" like 'D%' 			           
            and 1=1                                      
            order by rtrim(vareln."Ordrenr") desc,         
                     rtrim(vareln."Varenr") 
            /               


            --delete from ekstern.uni_t_vareln ;
            select count(*) from ekstern.uni_t_vareln ;

            insert into ekstern.uni_t_vareln (type, enhet_seq_no, ordrenr, ordrenr_vaar_ref, ordrenr_last_edit, ordrenr_status, varenr, varetekst, pris, rabatt, netto, mva, salgs_pris) 
            select type, enhet_seq_no, ordrenr, ordrenr_vaar_ref, ordrenr_last_edit, ordrenr_status, varenr, varetekst, pris, rabatt, netto, mva, salgs_pris from ola.t;
            select * from ola.t;




    select * from v_enhet2
    where vare_gruppe_id like 'MOTOR%'
    and location_seq_no is not null
    and prev_enhet_seq_no is null
    
    SELECT V_UNI_T_VARELN2.VARELN_T_SEQ_NO, V_UNI_T_VARELN2.ENHET_SEQ_NO, V_UNI_T_VARELN2.SERIE_SEQ_NO_UT, V_UNI_T_VARELN2.LOCATION_SEQ_NO, V_UNI_T_VARELN2.SERIE_NO, V_UNI_T_VARELN2.VARE_GRUPPE_ID, V_UNI_T_VARELN2.SERIE_SEQ_NO, V_UNI_T_VARELN2.SERIE_NO_JOIN_VARENR, V_UNI_T_VARELN2.VARE_GRUPPE_ID_JOIN_VARENR, V_UNI_T_VARELN2.FORCE_UPDATE, V_UNI_T_VARELN2.TYPE, V_UNI_T_VARELN2.STATUS, V_UNI_T_VARELN2.TILBUDSNR, V_UNI_T_VARELN2.TILBUDSNR_VAAR_REF, V_UNI_T_VARELN2.TILBUDSNR_DATO, V_UNI_T_VARELN2.TILBUDSNR_DATO_GYLDIG_TIL, V_UNI_T_VARELN2.TILBUDSNR_STATUS, V_UNI_T_VARELN2.ORDRENR, V_UNI_T_VARELN2.ORDRENR_VAAR_REF, V_UNI_T_VARELN2.ORDRENR_LAST_EDIT, V_UNI_T_VARELN2.ORDRENR_STATUS, V_UNI_T_VARELN2.FAKTURANR, V_UNI_T_VARELN2.FAKTURANR_VAAR_REF, V_UNI_T_VARELN2.FAKTURANR_LEVERINGS_DATO, V_UNI_T_VARELN2.FAKTURANR_STATUS, V_UNI_T_VARELN2.INNKJOPNR, V_UNI_T_VARELN2.INNKJOPNR_VAAR_REF, V_UNI_T_VARELN2.INNKJOPNR_DATO, V_UNI_T_VARELN2.INNKJOPNR_STATUS, V_UNI_T_VARELN2.VARENR, V_UNI_T_VARELN2.VARETEKST, V_UNI_T_VARELN2.PRIS, V_UNI_T_VARELN2.RABATT, V_UNI_T_VARELN2.NETTO, V_UNI_T_VARELN2.MVA, V_UNI_T_VARELN2.SALGS_PRIS
    FROM EKSTERN.V_UNI_T_VARELN2 V_UNI_T_VARELN2
    ORDER BY V_UNI_T_VARELN2.VARELN_T_SEQ_NO DESC
    
    1003147   kasse
    1003148   tiolbud ordre faktura
    
    ID  Fakturanr Kundenr Varenr  Varetekst ErstatnVareid LSum  Kontonr
    36783 1003147 100999  D39922                BAKLYKT-V CITROEN BERLINGO 1 FACELIFT 2005 V12457             87713                 300,0000  3000
    36784 1003147 100999  D22917                BAKLYKT-H CITROEN BERLINGO 1 FACELIFT 2005 V13828             101202                300,0000  3000
    
    SELECT VARELNFAKT.ID, VARELNFAKT.Fakturanr, VARELNFAKT.Kundenr, VARELNFAKT.Varenr, VARELNFAKT.Varetekst, VARELNFAKT.ErstatnVareid, VARELNFAKT.LSum, VARELNFAKT.Kontonr
    FROM uni_2.dbo.VARELNFAKT VARELNFAKT
    WHERE (VARELNFAKT.Varenr Like 'D%')
    ORDER BY VARELNFAKT.Fakturanr DESC
    
    create or replace view v_uni_bildeler as
      /*brukes i side 210 */
      --eks 286333 / D14988  DØRVINDUSHEIS-VF VW GOLF 5 2007 V22505 har 3 faktura nr
      select  varelnfakt."ID"               as id , 
              varelnfakt."Fakturanr"        as fakturanr, 
              to_char(faktura."Fakturadato",'yyyy') as aar,
              faktura."Fakturadato"         as fakturadato,
              varelnfakt."Kundenr"          as kundenr, 
              varelnfakt."Varenr"           as varenr, 
              varelnfakt."Varetekst"        as varetekst, 
              varelnfakt."ErstatnVareid"    as enhet_seq_no, 
              varelnfakt."LSum"             as lsum, 
              varelnfakt."Kontonr"          as kontonr
      from varelnfakt@uni_2  varelnfakt,
           faktura@uni_2     faktura
      where 1=1
      and faktura."Fakturanr" = varelnfakt."Fakturanr"
      and varelnfakt."Varenr" like 'D%'
      order by varelnfakt."Fakturanr" desc

      SELECT FAKTURA.Fakturanr, VARELNFAKT.ordrenr, VARELNFAKT.Varenr, VARELNFAKT.Varetekst, VARELNFAKT.ErstatnVareid, FAKTURA.Fakturadato
      FROM uni_2.dbo.FAKTURA FAKTURA, uni_2.dbo.VARELNFAKT VARELNFAKT
      WHERE FAKTURA.Fakturanr = VARELNFAKT.Fakturanr AND ((VARELNFAKT.Varenr Like 'D%') AND (FAKTURA.Fakturadato>{ts '2016-05-17 00:00:00'}))
      ORDER BY VARELNFAKT.Varenr
      --8079

    --obas 6 spezial , gidder ikke sett opp Hetrogen Service mot uni_2@obas4 maskinen 2020-02-25
    create table v_uni_bildeler (
         ID                                        NUMBER(10)
        ,FAKTURANR                                          NUMBER(10)
        ,AAR                                                VARCHAR2(4)
        ,FAKTURADATO                                        DATE
        ,KUNDENR                                            NUMBER(10)
        ,VARENR                                             VARCHAR2(20)
        ,VARETEKST                                          VARCHAR2(150)
        ,ENHET_SEQ_NO                                       VARCHAR2(20)
        ,LSUM                                               NUMBER(19,4)
        ,KONTONR                                            NUMBER(10)        
        )
    /

----------------------------------------------------------- v_uni_402x -----------------------------------------------------------------------------------------------------------------------------------
    drop view v_uni_402x;
    obas5_19c_ola> create table v_uni_402x as select * from v_uni_402x@obas_obas4;


    --create or replace view v_uni_402x  as
        --create table t as
        --
       select 
             m."ID"   id_inoice_incoming, 
             d."ID"   id_invoice_inc_details,
             m."Kreditert"  kreditert,
             case when m."Status"=1 then 'Opprettet ('||to_char(m."Status")||')'
                  when m."Status"=5 then 'Bokført ('||to_char(m."Status")||')'
                  when m."Status"=6 then 'Betalt ('||to_char(m."Status")||')'
                  when m."Status"=7 then 'Slettet ('||to_char(m."Status")||')'
                  when m."Status"=9 then 'Betalt ('||to_char(m."Status")||')'
                  else to_char(m."Status")
             end            status,
             m."Status"     status_nr,
             d."Status"     status_nr_detail,
             m."text"         merknad, 
             cast(null as varchar2(25) ) obas_vrak,
             /*
             (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no  
              from enhet, serie 
              where 1=1
                and enhet.serie_seq_no= serie.serie_seq_no
                and m."text"          = decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no )  obas_vrak,
              */
             m."tfakturanr"   fakturanr,
             cast(null as varchar2(25) ) obas_reg_no,
             --(select reg_no   from enhet where m."tfakturanr" = reg_no) obas_reg_no,
             d."Total"        total,
             d."Account"      konto, 
             m."Invoice_Date" fakturadato, 
             m."Bilagsnr"     bilagsnr, 
             m."LedgerText"   bilagstekst, 
             m."PaymentInfo"  betalingsinfo         
       from  invoice_incoming@uni_2 m,
             invoice_inc_details@uni_2 d
       where 1=1
          and m."ID" = d."Invoice_Inc_ID"
          and d."Account" in ('4020', '4021')
       order by decode(m."text",null,'a',m."text")
    /
    
        select count(*) from v_uni_402x;
        --680   06.01.2019
        --681   07.01.2019

        select merknad, count(*) from v_uni_402x where total>0 and merknad is not null group by merknad having count(*)>1;
        --0 2018
        --2 06.01.2018  V30131, V30861
         
        create table tt_2 as select 
             d."Total"        total,
             d."Account"      konto, 
             d."Price"      price, 
             d."Status"      status,
             d."NoOfItems"     nos,
             d."fakturanr"     fakturanr
        from  
             invoice_inc_details@uni_2 d
       where 1=1
          and d."Account" in ('4020', '4021');

----------------------------------------------------------- t_xxx_402x_map_obas --brukes hvert år ifbm varelelling---------------------------------------------------------------------------------------------------------
    --drop table t_uni_402x_map_obas;
        --truncate table t_uni_402x_map_obas;
        --create table t_uni_402x_map_obas as
        insert into t_uni_402x_map_obas
          /*brukes hvert år ifbm varelelling*/
          select  to_number(to_char(to_date(v_uni_402x.fakturadato,'dd-mm-yyyy'),'yyyy'))  as aar4,
                  upper(substr(v_uni_402x.merknad,1,6))         as vraknr,
                  enhet_seq_no                                  as enhet_seq_no,
                  to_number(v_uni_402x.total)                   as pris_4021,
                  to_date(v_uni_402x.fakturadato,'dd-mm-yyyy')  as date_4021,
                  total,
                  merknad,
                  kreditert,
                  status,
                  status_nr,
                  status_nr_detail,
                  bilagsnr,
                  bilagstekst, 
                  betalingsinfo 
          from  
            ( --select serie_no, count(*) from t group by serie_no having count(*)>1
              --create table t as   
              select distinct upper(substr(merknad,1,6)) serie_no from v_uni_402x 
              where 1=1
            )  driver_vrak,
            v_uni_402x,
            v_enhet_master
          where 1=1
            and driver_vrak.serie_no = v_enhet_master.serie_no
            and driver_vrak.serie_no = upper(substr(v_uni_402x.merknad,1,6))
        /
    
        --842 2020-01-11

        create table t_uni_402x_map_obas_2018 as select * from t_uni_402x_map_obas;
        select count(*) from t_uni_402x_map_obas_2018;
        --667

    --eks   V27228 f.nr BD49667  har 2 bilag ett på 1000kr og ett på 9000kr det er gode greier
            V29638 2 faktura hvorav en er kreditert...


    --drop table t_4021_2016;
      create table t_4021_2016 as select aar4, vraknr, enhet_seq_no, date_4021, sum(pris_4021) pris_4021 from v_uni_402x_map_obas group by aar4, vraknr, enhet_seq_no, date_4021 ;
      select enhet_seq_no , count(*) from t_4021_2016 group by enhet_seq_no having count(*)>1;
      select count(*) from t_4021_2016;
      --184
      --192 
      --V27228 1000,- + 9000 SUM 10000,- = 2 FAKTURA  -->> må gruppere

        --update enhet t1 set pris_4021=null , date_4021= null where to_char(date_4021,'yyyy')='2016';
        update enhet t1 set (pris_4021, date_4021) = (
            select pris_4021, date_4021
            from  t_4021_2016 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2016
            )
        where exists (
            select 'x'
            from t_4021_2016 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2016
            )
        and t1.pris_4021 is null;
        --184

    --drop table t_4021_2017;
        create table t_4021_2017 as select aar4, vraknr, enhet_seq_no, date_4021, sum(pris_4021) pris_4021 from v_uni_402x_map_obas group by aar4, vraknr, enhet_seq_no, date_4021 ;
        select count(*) from t_4021_2017;
        --397
        
        select enhet_seq_no , count(*) from t_4021_2017 group by enhet_seq_no having count(*)>1;
        --0

        --Brukes kun til å sjeke godhet
        select upper(substr(merknad,1,6)) serie_no from v_uni_402x where total>0 and merknad is not null
          minus
        select serie_no from v_enhet_master
            CF5406
            IKKE H
            RZ3480
            SKAL F
            V30289
                SELECT V_UNI_402X.MERKNAD
                FROM OLA.V_UNI_402X V_UNI_402X
                WHERE (upper(V_UNI_402X.MERKNAD) Like '%CF5406%') OR (upper(V_UNI_402X.MERKNAD) Like '%IKKE H%') OR (upper(V_UNI_402X.MERKNAD) Like '%RZ3480%') OR (upper(V_UNI_402X.MERKNAD) Like '%SKAL F%') OR (upper(V_UNI_402X.MERKNAD) Like '%V30289%')

        --update enhet t1 set pris_4021=null , date_4021= null where to_char(date_4021,'yyyy')='2016';
        update enhet t1 set (pris_4021, date_4021) = (
            select pris_4021, date_4021
            from  t_4021_2017 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2017
            )
        where exists (
            select 'x'
            from t_4021_2017 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2017
            )
        and t1.pris_4021 is null;
        --195 201.01.2018

    --drop table t_4021_2018;
        create table t_4021_2018 as select aar4, vraknr, enhet_seq_no, date_4021, sum(pris_4021) pris_4021 
        from t_uni_402x_map_obas 
        where 1=1
            and   ( total>0 or total <0 )
            and merknad is not null
            and bilagsnr  >0                --2019.01.06 for å like ut status Slettet (7) og Opprettet (1)
            and kreditert =0
            and status_nr = 6               --betalt
            and kreditert = 0    
        group by aar4, vraknr, enhet_seq_no, date_4021 ;
        select count(*) from t_4021_2018;
        --564
        --557  etter betalingstatus satt til 6

        select enhet_seq_no , count(*) from t_4021_2018 group by enhet_seq_no having count(*)>1;
        --2 06.01.2019   enhet_seq_no 327109  vrak V31329
        --0 06.01.2019   etter betalinstatus er satt til 6
     --Brukes kun til å sjeke godhet
        select upper(substr(merknad,1,6)) serie_no from v_uni_402x where total>0 and merknad is not null
          minus
        select serie_no from v_enhet_master
            CF5406
            IKKE H
            RZ3480
            SKAL F
            V30289
                SELECT V_UNI_402X.MERKNAD
                FROM OLA.V_UNI_402X V_UNI_402X
                WHERE (upper(V_UNI_402X.MERKNAD) Like '%CF5406%') OR (upper(V_UNI_402X.MERKNAD) Like '%IKKE H%') OR (upper(V_UNI_402X.MERKNAD) Like '%RZ3480%') OR (upper(V_UNI_402X.MERKNAD) Like '%SKAL F%') OR (upper(V_UNI_402X.MERKNAD) Like '%V30289%')

        --update enhet t1 set pris_4021=null , date_4021= null where to_char(date_4021,'yyyy')='2016';
        update enhet t1 set (pris_4021, date_4021) = (
            select pris_4021, date_4021
            from  t_4021_2018 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2018
            )
        where exists (
            select 'x'
            from t_4021_2018 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=2018
            )
        and t1.pris_4021 is null;
        --195 20.01.2018
        --170 06.01.2019
      
      --drop table t_enhet_pris_full_2018 ;
      create table  t_enhet_pris_full_2018 as
        select  *
        from  	ola.v_enhet_pris_full_2018 		t1
        where  	t1.dato_inn 						<	to_date('01_01_2019','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2017','dd_mm_yyyy')
        and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2019','dd_mm_yyyy')
        order by chassis_no,vare_gruppe_id
        /

        select count(*) from t_enhet_pris_full_2018; 
        --11043  2019.01.06

    --drop table t_4021_2019;
        create table t_4021_2019 as select aar4, vraknr, enhet_seq_no, date_4021, sum(pris_4021) pris_4021 
        from t_uni_402x_map_obas 
        where 1=1
            and   ( total>0 or total <0 )
            and merknad is not null
            and bilagsnr  >0                --2019.01.06 for å like ut status Slettet (7) og Opprettet (1)
            and kreditert =0
            and status_nr = 6               --betalt
            and kreditert = 0    
        group by aar4, vraknr, enhet_seq_no, date_4021 ;

        select count(*) from t_4021_2018;
        --564
        --557  etter betalingstatus satt til 6
        select count(*) from t_4021_2019;
        1264
         707 2021-01-15

      --Før start 2019 fra app108 p721
                2005	2006	2007	2008	2009	2010	2011	2012	2013	2014	2015	2016	2017	    2018
        for     358 148	673 381	752 011	836 052	722 736	601 767	684 262	800 483	808 638	909 966	894 376	863 205	1 066 657	949 103
        etter   358 148	673 381	752 011	836 052	722 736	601 767	684 262	800 483	808 638	909 966	894 376	863 205	1 066 657	949 103
      --


        select enhet_seq_no , count(*) from t_4021_2018 group by enhet_seq_no having count(*)>1;
        --2 06.01.2019   enhet_seq_no 327109  vrak V31329
        --0 06.01.2019   etter betalinstatus er satt til 6

        select enhet_seq_no , count(*) from t_4021_2019 group by enhet_seq_no having count(*)>1;
        --0 11.01.2019
        --0 15.01.2021

     --Brukes kun til å sjeke godhet
        select upper(substr(merknad,1,6)) serie_no from v_uni_402x where total>0 and merknad is not null
          minus
        select serie_no from v_enhet_master
        order by 1;
            BET. M  --2019
            BETALT  --2019
            CF5406
            IKKE H
            RZ3480
            SKAL F
            SKANNE  --2019
            V30289  --vekke i 2019
                SELECT V_UNI_402X.MERKNAD
                FROM OLA.V_UNI_402X V_UNI_402X
                WHERE (upper(V_UNI_402X.MERKNAD) Like '%CF5406%') OR (upper(V_UNI_402X.MERKNAD) Like '%IKKE H%') OR (upper(V_UNI_402X.MERKNAD) Like '%RZ3480%') OR (upper(V_UNI_402X.MERKNAD) Like '%SKAL F%') OR (upper(V_UNI_402X.MERKNAD) Like '%V30289%')

        --update enhet t1 set pris_4021=null , date_4021= null where to_char(date_4021,'yyyy')='2016';

        update enhet t1 set (pris_4021, date_4021) = (
            select pris_4021, date_4021
            from  t_4021_2019 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=19
            )
        where exists (
            select 'x'
            from t_4021_2019 v_uni_402x_map_obas
            where t1.enhet_seq_no = v_uni_402x_map_obas.enhet_seq_no
            and v_uni_402x_map_obas.aar4=19
            )
        and t1.pris_4021 is null;
        --195 20.01.2018
        --170 06.01.2019
        --145 11.01.2019 med og uten and t1.pris_4021 is null;
      
    --drop table t_enhet_pris_full_2019 ;
      create table  t_enhet_pris_full_2019 as
        select  *
        from  	ola.v_enhet_pris_full_2019 		t1
        where  	t1.dato_inn 						<	to_date('01_01_2020','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2018','dd_mm_yyyy')
        and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2020','dd_mm_yyyy')
        order by chassis_no,vare_gruppe_id
        /

        select count(*) from t_enhet_pris_full_2018; 
        --11043  2019.01.06

        select count(*) from t_enhet_pris_full_2019; 
        --14406

    --drop table t_visma_402x_2020
        1) laste opp i ny tabell med APEX
            fra     U:\dbms\Scripts\OBAS\2020 varelager
        
            drop table t_visma_402x_2020;
            select * from t_visma_402x_2020@obas6
            delete from t_visma_402x_2020 where id_1 in (185,186);
        
        2) joine opp
            ID_1	ID	    DATO	            B_NR	SELSKAP	TYPE	    REF_NR	VRAK	PRIS	VRAK_0	VRAK_0_KOMMENTAR
            157	    O 949	2020-11-09 00:00:00	200048	Tryg	Forsikring	RJ89614	V38487		    1	    O vrak
            158	    L 1952	2020-11-11 00:00:00	200020	Frende	Forsikring	BD79116	V38506	3 000,00		
            159	    O 970	2020-11-12 00:00:00	200020	Frende	Forsikring	NV56424	V38519		    1	    O vrak
            160	    L 1975	2020-11-16 00:00:00	200048	Tryg	Forsikring	VB14121	V38502	3 000,00		        

            select count(*) from enhet;
            --165144
            select count(*) from v_enhet2;
            --165144

            select vrak from t_visma_402x_2020
            minus
            select serie_no from v_enhet2;
                --0



            select count(*) from t_visma_402x_2020;
                --184

            select vrak from t_visma_402x_2020
            intersect
            select serie_no from v_enhet2;
            --184   ok

            select pris_4021      , count(*) from enhet where vare_gruppe_seq_no=1 group by pris_4021       order by 1;
            select to_number(pris_4021), count(*) from t_visma_402x_2020                group by to_number(pris_4021) order by 1;

        3)  create table t_visma_402x_2020_map as
                select enhet_seq_no, nvl(t1.pris_4021,0) as pris_4021, t1.dato as date_4021
                from v_enhet2,
                     t_visma_402x_2020 t1
                where v_enhet2.serie_no = t1.vrak
            /

            select count(*) from t_visma_402x_2020_map;
            --184
                select t1.pris_4021, t1.date_4021
                from t_visma_402x_2020_map t1
                        ,enhet
                where t1.enhet_seq_no = enhet.enhet_seq_no
                and enhet.pris_4021 is null



        4) 
            alter table enhet disble all triggers;
            update enhet set (pris_4021, date_4021) = 
                (select t1.pris_4021, t1.date_4021
                from t_visma_402x_2020_map t1
                where t1.enhet_seq_no = enhet.enhet_seq_no
                and enhet.pris_4021 is null)
            where exists (  select 'x'
                            from t_visma_402x_2020_map t1
                            where t1.enhet_seq_no = enhet.enhet_seq_no
                            and enhet.pris_4021 is null )
            /
            --184
            alter table enhet enable all triggers;
            
----------------------------------------------------------- v_pda2 -----------------------------------------------------------------------------------------------------------------------------------   
    --links
        https://stackoverflow.com/questions/38371989/how-to-convert-comma-separated-values-to-rows-in-oracle
            with tbl1 as (  select 1 as id, 'AA, UT, BT, SK, SX' as value from dual union
                            select 2 as id, 'AA, UT, SX'         as value from dual union
                            select 3 as id, 'UT, SK, SX, ZF'     as value from dual 
            )
            select distinct id, trim(regexp_substr(value,'[^,]+', 1, level) ) value, level
            from tbl1
            connect by regexp_substr(value, '[^,]+', 1, level) is not null
            order by id, level;

                ID	VALUE	LEVEL
                1	AA	       1
                1	UT	       2
                1	BT	       3
                1	SK	       4
                1	SX	       5
                2	AA	       1
                2	UT	       2
                2	SX	       3
                3	UT	       1
                3	SK	       2
                3	SX	       3
                3	ZF	       4

        with line2rows as (
           select distinct pda_iphone_pre_seq_no, trim(regexp_substr(org_scan_id,'[^,]+', 1, level) ) org_scan_id, level
            from pda_iphone_details
            connect by regexp_substr(org_scan_id, '[^,]+', 1, level) is not null
            order by pda_iphone_pre_seq_no, level 
        )

    --logikk
        Pda lager fil
            8S2C
            65779
            65780 

        select loc_id, serie_no, dato_inn  from v_enhet2@obas6 where loc_id like '1%' and vare_gruppe_seq_no <>1 order by loc_id, serie_no            
            LOC_ID	SERIE_NO	DATO_INN
            1B1A	D25548	    2008-11-12 12:23:28
            1B1B	D21592	    2006-11-16 14:13:31
            1B1B	D55272	    2018-11-15 13:48:20
            1B1C	D24543	    2011-05-27 11:09:00
            1B1C	D31616	    2014-03-10 15:12:06

        iphone leser inn    -- https://api.qrv.no/obas/pipe_deler POST header setvalues=
                            {'prosess':'PIP','l_pip':'26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743'} 
                            {'prosess':'PIP','l_pip':'1B1A,D25548'} 

        ORDS eksekvere 1
                            --1. select pda_dock_pre_seq_no.nextval from dual
                            --2. direkte line to values i PDA_IPHONE_DETAILS

                                PDA_IPHONE_DETAILS_SEQ_NO	PDA_IPHONE_PRE_SEQ_NO	NR	SCAN_ID	PDA_DATE	        ORG_SCAN_ID
                                92	                        21	                    1	26S11F	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                93	                        21	                    2	65637	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                94	                        21	                    3	26S11E	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                95	                        21	                    4	65501	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                96	                        21	                    5	65638	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                97	                        21	                    6	26S11D	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                98	                        21	                    7	60950	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                99	                        21	                    8	65660	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                100	                        21	                    9	65743	2021-01-12 21:24:32	26S11F,65637,26S11E,65501,65638,26S11D,60950,65660,65743
                                101	                        41	                    1	1B1A	2021-01-14 22:00:14	1B1A,D25548
                                102	                        41	                    2	25548	2021-01-14 22:00:14	1B1A,D25548
        
         ORDS eksekvere 1   set serveroutput on size unlimited
                            --insert into pda_iphone_pre(pda_iphone_pre_seq_no,metod) values("+seq_no+",'SHELF')
                            --insert into pda_iphone_pre(pda_iphone_pre_seq_no,metod) values(15992,'SHELF')
                            --truncate table pda_iphone_details;
                            --truncate table pda_iphone_pre;
                            --truncate table pda_iphone;
                            --insert into pda_iphone_pre(pda_iphone_pre_seq_no,metod) values(21,'SHELF');
                            --insert into pda_iphone_pre(pda_iphone_pre_seq_no,metod) values(41,'SHELF');
 

    create or replace view  v_pda_iphone_details_2c as 
        --create or replace view tt as
        /*      Konvertere 1 kolonne verdier til 2 kolonner
                Forutsetter:
            Dato   Endring
            ===       =======
            28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
            14.1.2021  Migrer fra pda_dock til pda_iphone
            */
        select
            driver.pda_iphone_details_seq_no        as pda_iphone_details_seq_no,
            driver.pda_iphone_pre_seq_no            as pda_iphone_pre_seq_no,
            driver.pda_date                         as pda_date,
            (   select loc.scan_id
                from pda_iphone_details  loc
                where loc.pda_iphone_details_seq_no = driver.pda_iphone_details_seq_no
                --gir 0 hvis tall
                and
                -- gir tall > 0 hvis inner holder bokstav
                to_number(  instr(lower(to_char(loc.scan_id)),'a')||
                            instr(lower(to_char(loc.scan_id)),'b')||
                            instr(lower(to_char(loc.scan_id)),'c')||
                            instr(lower(to_char(loc.scan_id)),'d')||
                            instr(lower(to_char(loc.scan_id)),'e')||
                            instr(lower(to_char(loc.scan_id)),'f')||
                            instr(lower(to_char(loc.scan_id)),'g')||
                            instr(lower(to_char(loc.scan_id)),'h')||
                            instr(lower(to_char(loc.scan_id)),'i')||
                            instr(lower(to_char(loc.scan_id)),'j')||
                            instr(lower(to_char(loc.scan_id)),'k')||
                            instr(lower(to_char(loc.scan_id)),'l')||
                            instr(lower(to_char(loc.scan_id)),'m')||
                            instr(lower(to_char(loc.scan_id)),'n')||
                            instr(lower(to_char(loc.scan_id)),'o')||
                            instr(lower(to_char(loc.scan_id)),'p')||
                            instr(lower(to_char(loc.scan_id)),'q')||
                            instr(lower(to_char(loc.scan_id)),'r')||
                            instr(lower(to_char(loc.scan_id)),'s')||
                            instr(lower(to_char(loc.scan_id)),'t')||
                            instr(lower(to_char(loc.scan_id)),'u')||
                            instr(lower(to_char(loc.scan_id)),'v')||
                            instr(lower(to_char(loc.scan_id)),'w')||
                            instr(lower(to_char(loc.scan_id)),'x')||
                            instr(lower(to_char(loc.scan_id)),'y')||
                            instr(lower(to_char(loc.scan_id)),'z')||
                            instr(lower(to_char(loc.scan_id)),'‘')||
                            instr(lower(to_char(loc.scan_id)),'›')||
                            instr(lower(to_char(loc.scan_id)),'†')  )   != '0' )   as loc_id,
            (   select item.scan_id
                from pda_iphone_details item
                where item.pda_iphone_details_seq_no = driver.pda_iphone_details_seq_no
                --gir 0 hvis tall
                and
                -- gir tall > 0 hvis inner holder bokstav
                to_number(  instr(lower(to_char(item.scan_id)),'a')||
                            instr(lower(to_char(item.scan_id)),'b')||
                            instr(lower(to_char(item.scan_id)),'c')||
                            instr(lower(to_char(item.scan_id)),'d')||
                            instr(lower(to_char(item.scan_id)),'e')||
                            instr(lower(to_char(item.scan_id)),'f')||
                            instr(lower(to_char(item.scan_id)),'g')||
                            instr(lower(to_char(item.scan_id)),'h')||
                            instr(lower(to_char(item.scan_id)),'i')||
                            instr(lower(to_char(item.scan_id)),'j')||
                            instr(lower(to_char(item.scan_id)),'k')||
                            instr(lower(to_char(item.scan_id)),'l')||
                            instr(lower(to_char(item.scan_id)),'m')||
                            instr(lower(to_char(item.scan_id)),'n')||
                            instr(lower(to_char(item.scan_id)),'o')||
                            instr(lower(to_char(item.scan_id)),'p')||
                            instr(lower(to_char(item.scan_id)),'q')||
                            instr(lower(to_char(item.scan_id)),'r')||
                            instr(lower(to_char(item.scan_id)),'s')||
                            instr(lower(to_char(item.scan_id)),'t')||
                            instr(lower(to_char(item.scan_id)),'u')||
                            instr(lower(to_char(item.scan_id)),'v')||
                            instr(lower(to_char(item.scan_id)),'w')||
                            instr(lower(to_char(item.scan_id)),'x')||
                            instr(lower(to_char(item.scan_id)),'y')||
                            instr(lower(to_char(item.scan_id)),'z')||
                            instr(lower(to_char(item.scan_id)),'‘')||
                            instr(lower(to_char(item.scan_id)),'›')||
                            instr(lower(to_char(item.scan_id)),'†')     )= '0' )   as serie_no
        from  pda_iphone_details driver
        order by pda_iphone_pre_seq_no, nr
    /    
 
        select count(*) from v_pda_iphone_details_2c;
            9   2020-01-12

    create or replace view  v_pda_iphone_details_loc_id as 
        select
            /*  Lister alle unike loc_id uten at de sorteres
                NB m† bruke inline view i from ellers fyres
                ORA-01446:kan ikke velge ROWID fra utsnitt med
                DISTINCT, GROUP BY, osv
                       Forutsetter:
                Dato   Endring
                ===    =======
                28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
                14.1.2021  Migrer fra pda_dock til pda_iphone
            */
            pda_iphone_details_seq_no as pda_iphone_details_seq_no,
            loc_id                  as loc_id
        from (  select loc_id,pda_iphone_details_seq_no
                from v_pda_iphone_details_2c
                where loc_id is not null)
    /   

    create or replace view  v_pda_iphone_details as 
        /*      Ferdig konvertere 1 kolonne verdier til 2 kolonner med repeterende loc_id
                    Forutsetter: kreve ORA ODBC-driver
            Dato   Endring
            ===       =======
            28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
            09.1.2020  Snodig feil, kun første del på en lokasjon klarer å joines opp
            14.1.2021  Migrer fra pda_dock til pda_iphone
            */
        select
             driver.pda_iphone_details_seq_no                                                                                      as pda_iphone_details_seq_no
            ,driver.pda_iphone_pre_seq_no                                                                                          as pda_iphone_pre_seq_no
            ,driver.pda_date                                                                                                     as pda_date
            --originale
            --,(  select loc_id from v_pda_dock_details_loc_id
            --    where pda_dock_details_seq_no =(select max(pda_dock_details_seq_no)
            --                                    from v_pda_dock_details_loc_id
            --                                    where pda_dock_details_seq_no < driver.pda_dock_details_seq_no) )                as loc_id
            -------------
            --test
            --nvl(driver.y,'driver tom') as x,
            ,(  select loc.loc_id as xx
                from v_pda_iphone_details_loc_id loc
            where loc.pda_iphone_details_seq_no =  (  select max(loc2.pda_iphone_details_seq_no)                                      
                                                        --from v_pda_dock_details_loc_id loc2
                                                        --magic 19c sensurete nr 2, 3, del... osv på samme location 
                                                        --løsning var å skrive v_pda_doc_details_loc_id viewet direkte inn her
                                                        from v_pda_iphone_details_2c loc2 where loc2.loc_id is not null
                                                        and loc2.pda_iphone_details_seq_no < driver.pda_iphone_details_seq_no ))    as loc_id
            ,driver.serie_no                                                                                                    as serie_no
        from  v_pda_iphone_details_2c driver
        where serie_no is not null
    /    

    create or replace view  v_pda_iphone_enhet as 
        /* Forekomster som IKKE er prossesert i pda_dock    dvs pda_dock.proc_date              is null
            og
            som ikke    FINNES i enhet enda                 dvs v_pda_dock_enhet.enhet_seq_no   is null
                        --> PR_PDA_DOCK_ENHET_INS
            eller
            som allerede FINNES i enhet                     dvs v_pda_dock_enhet.enhet_seq_no   is NOT null
                                  er 
                                  1) punshet uten loc eller
                                  2) har for bytter lager plass
                        --> PR_PDA_DOCK_ENHET_UPD
            */
            /*
    	            Forutsetter:
    	            grant select on enhet to public
    	    Dato	   Endring
    	    ===        =======
    	    14.02.2005 laget
    	    06.08.2016 lagt inn oppslag mot del i enhet
            14.01.2021  Migrer fra pda_dock til pda_iphone            
    	    */
      select
    	pda_iphone.pda_iphone_details_seq_no	                                            as pda_iphone_details_seq_no,
    	pda_iphone.pda_iphone_pre_seq_no                                                    as pda_iphone_pre_seq_no,
    	pda_iphone.pda_date                                                                 as pda_date,
    	pda_iphone.metod                                                                    as metod,
    	pda_iphone.proc_date                                                                as proc_date,
    	pda_iphone.loc_id                                                                   as loc_id,
    	pda_iphone.location_seq_no                                                          as location_seq_no,
    	pda_iphone.serie_no                                                                 as serie_no,
    	pda_iphone.serie_seq_no                                                             as serie_seq_no,
    	enhet.enhet_seq_no			 			                                            as enhet_seq_no,
    	pda_iphone.enhet_seq_no_org		 		                                            as enhet_seq_no_org,
        enhet_org.fab_navn||' '||enhet_org.type_id||' '||enhet_org.aar                      as bil,
        enhet_org.vare_gruppe_id, 
        enhet_org.serie_no                                                                  as serie_no_current, 
        enhet_org.loc_id                                                                    as loc_id_current,
        enhet_org.enhet_besk, enhet_org.dato_inn, enhet_org.dato_ut, enhet_org.old_dato_inn, enhet_org.old_dato_ut, enhet_org.temp, enhet_org.temp_dato, enhet_org.old_serie_seq_no, enhet_org.salg_via
    	from
    	  pda_iphone	pda_iphone,
    	  ola.enhet		enhet,
    	  ola.v_enhet2  enhet_org
    	where  1=1
    	and pda_iphone.serie_seq_no      = enhet.serie_seq_no      (+)
    	and pda_iphone.enhet_seq_no_org  = enhet_org.enhet_seq_no  (+)
    	order by pda_iphone.pda_iphone_details_seq_no
    /

    create or replace view  v_pda_iphone as 
        /*  Legger p† OBAS seq_no for loc og serie
                Forutsetter: kreve ORA ODBC-driver p† v_pda_dock_details
                grant select on location to public
                grant select on serie to public
                NB alle data som er blitt registrert uten at loc_id er lagt først SENSURERES
                    Dato   Endring
                    ===       =======
                    06_03_05    definerer alle scan_id fra 1-9999 som vrak og >9999 som deler
                    28.03.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
                    09.01.2020  Feilsøking i obas6 19C migrert
                    14.1.2021  Migrer fra pda_dock til pda_iphone
            */
        select
            driver.pda_iphone_details_seq_no                                                            as pda_iphone_details_seq_no,
            driver.pda_iphone_pre_seq_no                                                                as pda_iphone_pre_seq_no,
            -- NB2 dersom pda_date mangler legges sysdate inn!
            nvl(driver.pda_date,sysdate)                                                                as pda_date,
            driver.loc_id                                                                               as loc_id,
            loc.location_seq_no                                                                         as location_seq_no,
            driver.serie_no                                                                             as serie_no,
            (case when driver.serie_no< 9999 then (
                --vrak
                    select t1.serie_seq_no
                    from ola.serie t1
                    where   t1.serie_no =driver.serie_no
                            --vrak godtar KUN ute loc som en ekstra sikkerhet
                    and     driver.loc_id in ('V_UTE1','V_UTE2','V_KLAR_PRESSING','V_INNE')
                    and     nvl(t1.serie_anv_seq_no,0) = 1   
            )else (
                --deler
                    select t1.serie_seq_no
                    from ola.serie t1
                    where   t1.serie_no =driver.serie_no
                            --deler godtar IKKE ute loc som en ekstra sikkerhet
                    and     driver.loc_id not in ('V_UTE1','V_UTE2','V_KLAR_PRESSING','V_INNE')
                    and     nvl(t1.serie_anv_seq_no,0) != 1  )
            end )                                                                                       as serie_seq_no
            from  v_pda_iphone_details  driver,
                  ola.location          loc
                  -- ola.serie          serie
            where   driver.loc_id is not null
            and     driver.serie_no is not null
                --INNER er ikke intressert i ugyldige loc og serier
            and     driver.loc_id   = loc.loc_id
            --and   driver.serie_no = serie.serie_no
            -- kun serie no til deler dvs ikke vrak som er 1
            --and   nvl(serie.serie_anv_seq_no,0) != 1
    /
   
----------------------------------------------------------- v_pda -----------------------------------------------------------------------------------------------------------------------------------   
    --logikk
        Pda lager fil
            8S2C
            65779
            65780 

        java lesere inni    --1. select pda_dock_pre_seq_no.nextval from dual
                            --2. cursor
                            --  insert into PDA_DOCK_DETAILS(pda_dock_pre_seq_no,scan_id)values ("+seq_no+",?)
                            --  insert into PDA_DOCK_DETAILS(pda_dock_pre_seq_no,scan_id)values (15992,?) created


            PDA_DOCK_PRE_SEQ_NO	PDA_DOCK_DETAILS_SEQ_NO	SCAN_ID	PDA_DATE	        ORG_SCAN_ID
            15990	            154814	                8S2C	2020-01-09 09:36:03	
            15990	            154815	                65779	2020-01-09 09:36:03	
            15990	            154816	                65780	2020-01-09 09:36:03	        
        
        java eksekverer --insert into pda_dock_pre(pda_dock_pre_seq_no,metod) values("+seq_no+",'SHELF')
                        --insert into pda_dock_pre(pda_dock_pre_seq_no,metod) values(15992,'SHELF')
 
    create or replace view  v_pda_dock_details_2c as 
        --create or replace view tt as
        /*      Konvertere 1 kolonne verdier til 2 kolonner
                Forutsetter:
            Dato   Endring
            ===       =======
            28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
            */
        select
            driver.pda_dock_details_seq_no   as pda_dock_details_seq_no,
            driver.pda_dock_pre_seq_no      as pda_dock_pre_seq_no,
            driver.pda_date                 as pda_date,
            (   select loc.scan_id
                from pda_dock_details  loc
                where loc.pda_dock_details_seq_no = driver.pda_dock_details_seq_no
                --gir 0 hvis tall
                and
                -- gir tall > 0 hvis inner holder bokstav
                to_number(  instr(lower(to_char(loc.scan_id)),'a')||
                            instr(lower(to_char(loc.scan_id)),'b')||
                            instr(lower(to_char(loc.scan_id)),'c')||
                            instr(lower(to_char(loc.scan_id)),'d')||
                            instr(lower(to_char(loc.scan_id)),'e')||
                            instr(lower(to_char(loc.scan_id)),'f')||
                            instr(lower(to_char(loc.scan_id)),'g')||
                            instr(lower(to_char(loc.scan_id)),'h')||
                            instr(lower(to_char(loc.scan_id)),'i')||
                            instr(lower(to_char(loc.scan_id)),'j')||
                            instr(lower(to_char(loc.scan_id)),'k')||
                            instr(lower(to_char(loc.scan_id)),'l')||
                            instr(lower(to_char(loc.scan_id)),'m')||
                            instr(lower(to_char(loc.scan_id)),'n')||
                            instr(lower(to_char(loc.scan_id)),'o')||
                            instr(lower(to_char(loc.scan_id)),'p')||
                            instr(lower(to_char(loc.scan_id)),'q')||
                            instr(lower(to_char(loc.scan_id)),'r')||
                            instr(lower(to_char(loc.scan_id)),'s')||
                            instr(lower(to_char(loc.scan_id)),'t')||
                            instr(lower(to_char(loc.scan_id)),'u')||
                            instr(lower(to_char(loc.scan_id)),'v')||
                            instr(lower(to_char(loc.scan_id)),'w')||
                            instr(lower(to_char(loc.scan_id)),'x')||
                            instr(lower(to_char(loc.scan_id)),'y')||
                            instr(lower(to_char(loc.scan_id)),'z')||
                            instr(lower(to_char(loc.scan_id)),'‘')||
                            instr(lower(to_char(loc.scan_id)),'›')||
                            instr(lower(to_char(loc.scan_id)),'†')  )   != '0' )   as loc_id,
            (   select item.scan_id
                from pda_dock_details item
                where item.pda_dock_details_seq_no = driver.pda_dock_details_seq_no
                --gir 0 hvis tall
                and
                -- gir tall > 0 hvis inner holder bokstav
                to_number(  instr(lower(to_char(item.scan_id)),'a')||
                            instr(lower(to_char(item.scan_id)),'b')||
                            instr(lower(to_char(item.scan_id)),'c')||
                            instr(lower(to_char(item.scan_id)),'d')||
                            instr(lower(to_char(item.scan_id)),'e')||
                            instr(lower(to_char(item.scan_id)),'f')||
                            instr(lower(to_char(item.scan_id)),'g')||
                            instr(lower(to_char(item.scan_id)),'h')||
                            instr(lower(to_char(item.scan_id)),'i')||
                            instr(lower(to_char(item.scan_id)),'j')||
                            instr(lower(to_char(item.scan_id)),'k')||
                            instr(lower(to_char(item.scan_id)),'l')||
                            instr(lower(to_char(item.scan_id)),'m')||
                            instr(lower(to_char(item.scan_id)),'n')||
                            instr(lower(to_char(item.scan_id)),'o')||
                            instr(lower(to_char(item.scan_id)),'p')||
                            instr(lower(to_char(item.scan_id)),'q')||
                            instr(lower(to_char(item.scan_id)),'r')||
                            instr(lower(to_char(item.scan_id)),'s')||
                            instr(lower(to_char(item.scan_id)),'t')||
                            instr(lower(to_char(item.scan_id)),'u')||
                            instr(lower(to_char(item.scan_id)),'v')||
                            instr(lower(to_char(item.scan_id)),'w')||
                            instr(lower(to_char(item.scan_id)),'x')||
                            instr(lower(to_char(item.scan_id)),'y')||
                            instr(lower(to_char(item.scan_id)),'z')||
                            instr(lower(to_char(item.scan_id)),'‘')||
                            instr(lower(to_char(item.scan_id)),'›')||
                            instr(lower(to_char(item.scan_id)),'†')     )= '0' )   as serie_no
        from  pda_dock_details driver
    /    
        select count(*) from v_pda_dock_details_2c;
            53846   2020-01-12

    create or replace view  v_pda_dock_details_loc_id as 
        select
            /*  Lister alle unike loc_id uten at de sorteres
                NB m† bruke inline view i from ellers fyres
                ORA-01446:kan ikke velge ROWID fra utsnitt med
                DISTINCT, GROUP BY, osv
                       Forutsetter:
                Dato   Endring
                ===    =======
                28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
            */
            pda_dock_details_seq_no as pda_dock_details_seq_no,
            loc_id                  as loc_id
        from (  select loc_id,pda_dock_details_seq_no
                from v_pda_dock_details_2c
                where loc_id is not null)
    /   

    create or replace view  v_pda_dock_details as 
        select
            /*      Ferdig konvertere 1 kolonne verdier til 2 kolonner med repeterende loc_id
                    Forutsetter: kreve ORA ODBC-driver
            Dato   Endring
            ===       =======
            28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
            09.1.2020  Snodig feil, kun første del på en lokasjon klarer å joines opp
            */
             driver.pda_dock_details_seq_no                                                                                      as pda_dock_details_seq_no
            ,driver.pda_dock_pre_seq_no                                                                                          as pda_dock_pre_seq_no
            ,driver.pda_date                                                                                                     as pda_date
            --originale
            --,(  select loc_id from v_pda_dock_details_loc_id
            --    where pda_dock_details_seq_no =(select max(pda_dock_details_seq_no)
            --                                    from v_pda_dock_details_loc_id
            --                                    where pda_dock_details_seq_no < driver.pda_dock_details_seq_no) )                as loc_id
            -------------
            --test
            --nvl(driver.y,'driver tom') as x,
            ,(  select loc.loc_id as xx
                from v_pda_dock_details_loc_id loc
                where loc.pda_dock_details_seq_no =  (  select max(loc2.pda_dock_details_seq_no)                                      
                                                        --from v_pda_dock_details_loc_id loc2
                                                        --magic 19c sensurete nr 2, 3, del... osv på samme location 
                                                        --løsning var å skrive v_pda_doc_details_loc_id viewet direkte inn her
                                                        from v_pda_dock_details_2c loc2 where loc2.loc_id is not null
                                                        and loc2.pda_dock_details_seq_no < driver.pda_dock_details_seq_no ))    as loc_id
            ,driver.serie_no                                                                                                    as serie_no
        from  v_pda_dock_details_2c driver
        where serie_no is not null
    /    


    CREATE OR REPLACE FORCE EDITIONABLE VIEW  "V_PDA_DOCK_ENHET" ("PDA_DOCK_DETAILS_SEQ_NO", "PDA_DOCK_PRE_SEQ_NO", "PDA_DATE", "METOD", "PROC_DATE", "LOC_ID", "LOCATION_SEQ_NO", "SERIE_NO", "SERIE_SEQ_NO", "ENHET_SEQ_NO", "ENHET_SEQ_NO_ORG", "BIL", "VARE_GRUPPE_ID", "SERIE_NO_CURRENT", "LOC_ID_CURRENT", "ENHET_BESK", "DATO_INN", "DATO_UT", "OLD_DATO_INN", "OLD_DATO_UT", "TEMP", "TEMP_DATO", "OLD_SERIE_SEQ_NO", "SALG_VIA") AS 
      select
    	/*      Forekomster som IKKE er prossesert i pda_dock dvs pda_dock.proc_date is null
    		og						  ==========================
    		    som allerede FINNES i enhet dvs v_pda_dock_enhet.enhet_seq_no is NOT null
    		    				    =========================================
    		    				    er 1) punshet uten loc eller
    		 				       2) har for bytter lager plass
    	          eller
    		    som ikke    FINNES i enhet enda dvs v_pda_dock_enhet.enhet_seq_no is NOT null
    		                                        =========================================
    	        Forutsetter:
    	        grant select on enhet to public
    	Dato	   Endring
    	===        =======
    	14.02.2005 laget
    	06.08.2016 lagt inn oppslag mot del i enhet
    	*/
    	pda_dock.pda_dock_details_seq_no	 as pda_dock_details_seq_no,
    	pda_dock.pda_dock_pre_seq_no             as pda_dock_pre_seq_no,
    	pda_dock.pda_date                        as pda_date,
    	pda_dock.metod                           as metod,
    	pda_dock.proc_date                       as proc_date,
    	pda_dock.loc_id                          as loc_id,
    	pda_dock.location_seq_no                 as location_seq_no,
    	pda_dock.serie_no                        as serie_no,
    	pda_dock.serie_seq_no                    as serie_seq_no,
    	enhet.enhet_seq_no			 			 as enhet_seq_no,
    	pda_dock.enhet_seq_no_org		 		 as enhet_seq_no_org,
        enhet_org.fab_navn||' '||enhet_org.type_id||' '||enhet_org.aar as bil,
        enhet_org.vare_gruppe_id, enhet_org.serie_no as serie_no_current, enhet_org.loc_id as loc_id_current,
        enhet_org.enhet_besk, enhet_org.dato_inn, enhet_org.dato_ut, enhet_org.old_dato_inn, enhet_org.old_dato_ut, enhet_org.temp, enhet_org.temp_dato, enhet_org.old_serie_seq_no, enhet_org.salg_via
    	from
    	  pda_dock	pda_dock,
    	  ola.enhet		enhet,
    	  ola.v_enhet2  enhet_org
    	where  1=1
    	and pda_dock.serie_seq_no      = enhet.serie_seq_no      (+)
    	and pda_dock.enhet_seq_no_org  = enhet_org.enhet_seq_no  (+)
    	order by pda_dock.pda_dock_details_seq_no
    /



      --testing
        --drop table t;
        --create table t as select * from  v_pda_dock_details_loc_id ;
        --19c mot 12c data funker
        --    --create or replace view tt as
        --    with driver as (    select   pda_dock_details_seq_no
        --                                ,pda_dock_pre_seq_no
        --                                ,pda_date
        --                                ,serie_no  
        --                        from  v_pda_dock_details_2c@obas4_ola
        --                        order  by pda_dock_details_seq_no desc)
        --    select
        --        /*      Ferdig konvertere 1 kolonne verdier til 2 kolonner med repeterende loc_id
        --                Forutsetter: kreve ORA ODBC-driver
        --        Dato   Endring
        --        ===       =======
        --        28.3.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
        --        09.1.2020  Snodig feil, kun første del på en lokasjon klarer å joines opp
        --        */
        --        driver.pda_dock_details_seq_no                                                                                      as pda_dock_details_seq_no,
        --        driver.pda_dock_pre_seq_no                                                                                          as pda_dock_pre_seq_no,
        --        driver.pda_date                                                                                                     as pda_date,
        --        (   select loc.loc_id 
        --            from v_pda_dock_details_loc_id@obas4_ola loc
        --            where loc.pda_dock_details_seq_no = (   select max(loc2.pda_dock_details_seq_no)
        --                                                    from v_pda_dock_details_loc_id@obas4_ola loc2
        --                                                    where loc2.pda_dock_details_seq_no < driver.pda_dock_details_seq_no  ) 
        --                                                                                                                           )as loc_id,
        --        driver.serie_no                                                                                                     as serie_no
        --    from  driver
        --    where serie_no is not null
        --/    




    CREATE OR REPLACE FORCE EDITIONABLE VIEW  "V_PDA_DOCK" ("PDA_DOCK_DETAILS_SEQ_NO", "PDA_DOCK_PRE_SEQ_NO", "PDA_DATE", "LOC_ID", "LOCATION_SEQ_NO", "SERIE_NO", "SERIE_SEQ_NO") AS 
        select
            /*  Legger p† OBAS seq_no for loc og serie
                Forutsetter: kreve ORA ODBC-driver p† v_pda_dock_details
                grant select on location to public
                grant select on serie to public
                NB alle data som er blitt registrert uten at loc_id er lagt først SENSURERES
                    Dato   Endring
                    ===       =======
                    06_03_05    definerer alle scan_id fra 1-9999 som vrak og >9999 som deler
                    28.03.2016  Flyttet fra 11g lbk bruker til 12c ola bruker
                    09.01.2020  Feilsøking i obas6 19C migrert
            */
            driver.pda_dock_details_seq_no                                                              as pda_dock_details_seq_no,
            driver.pda_dock_pre_seq_no                                                                  as pda_dock_pre_seq_no,
            -- NB2 dersom pda_date mangler legges sysdate inn!
            nvl(driver.pda_date,sysdate)                                                                as pda_date,
            driver.loc_id                                                                               as loc_id,
            loc.location_seq_no                                                                         as location_seq_no,
            driver.serie_no                                                                             as serie_no,
            (case when driver.serie_no< 9999 then (
                --vrak
                    select t1.serie_seq_no
                    from ola.serie t1
                    where   t1.serie_no =driver.serie_no
                            --vrak godtar KUN ute loc som en ekstra sikkerhet
                    and     driver.loc_id in ('V_UTE1','V_UTE2','V_KLAR_PRESSING','V_INNE')
                    and     nvl(t1.serie_anv_seq_no,0) = 1   
            )else (
                --deler
                    select t1.serie_seq_no
                    from ola.serie t1
                    where   t1.serie_no =driver.serie_no
                            --deler godtar IKKE ute loc som en ekstra sikkerhet
                    and     driver.loc_id not in ('V_UTE1','V_UTE2','V_KLAR_PRESSING','V_INNE')
                    and     nvl(t1.serie_anv_seq_no,0) != 1  )
            end )                                                                                       as serie_seq_no
            from  v_pda_dock_details    driver,
                  ola.location          loc
                  -- ola.serie          serie
            where   driver.loc_id is not null
            and     driver.serie_no is not null
                --INNER er ikke intressert i ugyldige loc og serier
            and     driver.loc_id   = loc.loc_id
            --and   driver.serie_no = serie.serie_no
            -- kun serie no til deler dvs ikke vrak som er 1
            --and   nvl(serie.serie_anv_seq_no,0) != 1
    /
    

    --20200109_104912.txt   test fil exigo1 Toralv    
        26S11F
        65637
        26S11E
        65501
        65638
        26S11D
        60950
        65660
        65743
        --log
            C:\prog\ImpPDA>pda

            C:\prog\ImpPDA>rem java ImpPDA "C:\\Documents and Settings\\rodkleiv\Mine dokume
            nter\\WM_rodkleiv My Documents" "ora_ms"

            C:\prog\ImpPDA>echo TML pÕ exigo java ImpPDA "C:\\Documents and Settings\\rodkle
            iv.OBAS-NB.000\\Mine dokumenter\\Symbol_PPT8800w My Documents" "ora_ms"
            TML pÕ exigo java ImpPDA "C:\\Documents and Settings\\rodkleiv.OBAS-NB.000\\Mine
             dokumenter\\Symbol_PPT8800w My Documents" "ora_ms"

            C:\prog\ImpPDA>java ImpPDA "C:\\Documents and Settings\\rodkleiv.OBAS-NB.000\\Mi
            ne dokumenter\\Symbol_PPT8800w My Documents" "ora_ms"
            20200109_090835.txt
            20200109_104912.txt
            sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms ola ola


            TrancationOject for:  sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms ola ola crea
            ted


            executeQuery for select pda_dock_pre_seq_no.nextval from dual
            ResultSet created
            select pda_dock_pre_seq_no.nextval from dual --> 15992
            Fil nr 1 20200109_090835.txt
            ===========================================================
            Fil nr 1 20200109_090835.txt


            TrancationOject for: Read/Write=R, directory=C:\Documents and Settings\rodkleiv.
            OBAS-NB.000\Mine dokumenter\Symbol_PPT8800w My Documents, fil= 20200109_090835.t
            xt created


            TrancationOject for:  sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms ola ola inse
            rt into PDA_DOCK_DETAILS(pda_dock_pre_seq_no,scan_id)values (15992,?) created
            x8S2Cy
            x65779y
            x65780y

            executeUpdate
            suceeded #=3


            Close: sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms done


            Close: Read/Write=R, directory=C:\Documents and Settings\rodkleiv.OBAS-NB.000\Mi
            ne dokumenter\Symbol_PPT8800w My Documents, fil= 20200109_090835.txt done
            Fil nr 2 20200109_104912.txt
            ===========================================================
            Fil nr 2 20200109_104912.txt


            TrancationOject for: Read/Write=R, directory=C:\Documents and Settings\rodkleiv.
            OBAS-NB.000\Mine dokumenter\Symbol_PPT8800w My Documents, fil= 20200109_104912.t
            xt created


            TrancationOject for:  sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms ola ola inse
            rt into PDA_DOCK_DETAILS(pda_dock_pre_seq_no,scan_id)values (15992,?) created
            x26S11Fy
            x65637y
            x26S11Ey
            x65501y
            x65638y
            x26S11Dy
            x60950y
            x65660y
            x65743y

            executeUpdate
            suceeded #=9


            Close: sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms done


            Close: Read/Write=R, directory=C:\Documents and Settings\rodkleiv.OBAS-NB.000\Mi
            ne dokumenter\Symbol_PPT8800w My Documents, fil= 20200109_104912.txt done


            Close: sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms done
            Execing cmd.exe /c ImpPDA.bat "C:\Documents and Settings\rodkleiv.OBAS-NB.000\Mi
            ne dokumenter\Symbol_PPT8800w My Documents\*.*"
            OUTPUT>http://www.robvanderwoude.com/index.html
            OUTPUT>Strip both leading and trailing double quotes ,
            OUTPUT>use NT's SET's string substitution to replace or remove characters anywhe
            re in a string
            OUTPUT>overskriver allerede eksisterende filer
            OUTPUT>C:\Documents and Settings\rodkleiv.OBAS-NB.000\Mine dokumenter\Symbol_PPT
            8800w My Documents\20200109_090835.txt
            OUTPUT>C:\Documents and Settings\rodkleiv.OBAS-NB.000\Mine dokumenter\Symbol_PPT
            8800w My Documents\20200109_104912.txt
            OUTPUT>        2 fil(er) ble kopiert.
            OUTPUT>sletter
            ExitValue: 0
            insert into pda_dock_pre(pda_dock_pre_seq_no,metod) values(15992,'SHELF')


            TrancationOject for:  sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms ola ola crea
            ted

            executeUpdate Sql: insert into pda_dock_pre(pda_dock_pre_seq_no,metod) values(15
            992,'SHELF')
            suceeded #=1


            Close: sun.jdbc.odbc.JdbcOdbcDriver jdbc:odbc:ora_ms done

            C:\prog\ImpPDA>pause
            Trykk en tast for å fortsette...
    --20200109_090835.txt
        8S2C
        65779
        65780   
----------------------------------------------------------- v_html_fancy_fab brukes i SELVPLUKK -----------------------------------------------------------------------------------------------------------------------------------
    
    create or replace view v_html_mobis_selvplukk_fab as
      --2015-01-02 laget kopi v_html_mobis_fab_type
      --
      --bildeler.net brukte tabellen t_enhet_full (gamle internett versjon)  
      --HER bruker t_enhet2_full på V_UTE1, ref trenger ikke sjekke på html_ok på disse vrakene slik t_enhet2 gjør
           -- <li data-val="/ALFA-ROMEO"><a href="http://www.olasbil.as/ALFA-ROMEO/ALFA-ROMEO-SELVPLUKK.html">ALFA-ROMEO</a></li>
           -- <li data-val="/AUDI">      <a href="http://www.olasbil.as/AUDI/AUDI-SELVPLUKK.html">AUDI</a></li>
           -- <li data-val="/SAAB">      <a href="http://www.olasbil.as/SAAB/SAAB-SELVPLUKK.html">SAAB</a></li>
           --<li data-val="/ALFA-ROMEO"><a href="http://www.olasbil.as/ALFA-ROMEO/ALFA-ROMEO-SELVPLUKK.html">ALFA-ROMEO <span class="mobi_sp badge">5</span></a></li>
           --<li data-val="/AUDI"><a href="http://www.olasbil.as/AUDI-SELVPLUKK.html"><span class="mobi_sp_fab">AUDI </span><span class="mobi_sp_ant badge">5</span></a><div class="ant"> (1stk)</div></li>
    with html_mobis_selvplukk_fab as (
        select distinct 
              0             as fab_seq_no,
              merke_vasket  as fab_navn,
              count(*)        as ant,
              (select to_char(html_ref_kode) from html_ref where use='RSP2_WWW_ROOT_OBAS') as www_root
        from t_enhet2_full
        where loc_id='V_UTE1'
        group by merke_vasket
        order by merke_vasket)
        --alternaiv til v_html_merke_modell_del_item_l 
        --http://www.oracle-base.com/articles/misc/lag-lead-analytic-functions.php
        --select rownum , fab_navn,type_id from html_mobiscroll_fab_type
    select 
        fab_navn                                                 as                fab_navn,
        --Nivå 1
          --<li data-val="/ALFA-ROMEO"><a href="http://www.olasbil.as/ALFA-ROMEO/ALFA-ROMEO-SELVPLUKK.html">ALFA-ROMEO <span class="mobi_sp badge">5</span></a></li>
          '                                    '||
          '<li data-val="/'||fab_navn||'"><a href="'||www_root||fab_navn||'-SELVPLUKK.html"><span class="mobi_sp_fab">'||fab_navn||
                ' </span><span class="mobi_sp_ant badge">'||ant||'</span></a><div class="ant"> ('||ant||')</div></li>'    as nivaa_1      
    from html_mobis_selvplukk_fab
    where 1=1
    and fab_navn is not null
    order by fab_navn
    /
    
----------------------------------------------------------- v_html_fancy_fab_type & del_scope brukes i DELER -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_html_fancy_fab_type as
      --2015-12-21 kopi fra v_html_modi_fab_type  
      --2015-12-27 lagt inn to_url       =http://www.olasbil.as/ALFA-ROMEO/156/ALFA-ROMEO-156.html
      --                    to_url_parent=http://www.olasbil.as/ALFA-ROMEO/ALFA-ROMEO.html
      --                    ft_level
    with html_fancy_fab_type as (
        select distinct 
              0             as fab_seq_no,
              0             as type_seq_no,
              merke_vasket  as fab_navn,
              modell_vasket as type_id,
              --http://www.olasbil.as/
              (select to_char(html_ref_kode) from html_ref where use='RSP2_WWW_ROOT_OBAS') as www_root
        from t_enhet2
        order by fab_navn,type_id)
        --alternaiv til v_html_merke_modell_del_item_l 
        --http://www.oracle-base.com/articles/misc/lag-lead-analytic-functions.php
        --select rownum , fab_navn,type_id from html_mobiscroll_fab_type
    select 
        fab_navn                                                 as                curr_fab_navn,
        lag (fab_navn,1,'---') over(order by fab_navn)           as prev_fab_navn,
        lead(fab_navn,1,'+++') over(order by fab_navn)           as                               next_fab_navn,
        type_id                                                  as                curr_type_id,
        lag (type_id,1 ,'---') over(order by fab_navn||type_id)  as prev_type_id,
        lead(type_id,1 ,'+++') over(order by fab_navn||type_id)  as                               next_type_id,
              -- [{"title": "opelde lux","expanded": false, "folder": true, "children": [
              --    {"title": "900", "folder": true, },
              --    {"title": "9-3", "folder": true, }
              -- ]}]          
      --Nivå 1
          --[{"title": "opelde lux","expanded": false, "folder": true, "children": [
          -- {"title": "opelde lux","expanded": false, "folder": true, "children": [
          case when    '---' = lag (fab_navn,1,'---') over(order by fab_navn) then 
          '[ '||'{"title": "'||fab_navn||'","expanded": false, "folder": true, "ft_level":"1_parent", "to_url_parent": "'||www_root||fab_navn||'/'||fab_navn||'.html", "children": ['||chr(13)||chr(10)   
               when fab_navn <> lag(fab_navn,1,'---') over(order by fab_navn) then 
          '  '||'{"title": "'||fab_navn||'","expanded": false, "folder": true, "ft_level":"1_parent", "to_url_parent": "'||www_root||fab_navn||'/'||fab_navn||'.html", "children": ['||chr(13)||chr(10)
          end  
          as nivaa_1,   
      --Nivå 2
          --{"title": "900", "folder": true, },
          --{"title": "9-3", "folder": true, }
           case when fab_navn = lead(fab_navn,1,'---') over(order by fab_navn) then
           '      '||'{"title": "'||type_id||'", "folder": true , "key":"'||fab_navn||type_id||'" , "ft_level":"1_child", "to_url": "'||www_root||fab_navn||'/'||type_id||'/'||fab_navn||'-'||type_id||'.html", "lazy": true }'||','||chr(13)||chr(10)
           else 
           '      '||'{"title": "'||type_id||'", "folder": true , "key":"'||fab_navn||type_id||'" , "ft_level":"1_child", "to_url": "'||www_root||fab_navn||'/'||type_id||'/'||fab_navn||'-'||type_id||'.html", "lazy": true }'||     chr(13)||chr(10)   
           end 
          as nivaa_2,       
      --Nivå 3
          -- ]},   eller ]}nylinje]       
           case when fab_navn <> lead(fab_navn,1,'+++') over(order by fab_navn) 
                 and   '+++'  <> lead(fab_navn,1,'+++') over(order by fab_navn) then 
           '      '||']},' 
                when fab_navn <> lead(fab_navn, 1,'+++') over(order by fab_navn) 
                 and   '+++'  =  lead(fab_navn,1,'+++') over(order by fab_navn) then 
           '      '||']}]'||chr(13)||chr(10) 
           end
           as nivaa_3
    from html_fancy_fab_type
    where 1=1
    and fab_navn is not null
    order by fab_navn,type_id
    /
    
    create or replace view v_html_fancy_del_scope as
      --2015-12-21 kopi fra v_html_modi_del_scope  
      --2015-12-27 lagt inn to_url       =http://www.olasbil.as/ALFA-ROMEO/156/ABS-ENHET/ALFA-ROMEO-156-1997-2003-ABS-ENHET.html
      --2015-12-27 lagt inn to_url_parent=http://www.olasbil.as/ALFA-ROMEO/156/ABS-ENHET/ALFA-ROMEO-156-ABS-ENHET.html
      --https://technology.amis.nl/2011/06/14/creating-json-document-straight-from-sql-query-using-listagg-and-with-clause/  
      with html_fancy_del_scope as (
        select distinct
              merke_vasket  as n1_fab_navn,
              modell_vasket as n1_type_id,     
              merke_vasket  ||
              modell_vasket as n1_break_fab_type,     
              del_vasket    as n2_del,
              merke_vasket  ||
              modell_vasket ||
              del_vasket    as n2_break_fab_type_del,     
              scope_vasket  as n3_scope,
              (select to_char(html_ref_kode) from html_ref where use='RSP2_WWW_ROOT_OBAS') as www_root,
              count(*)      as ant
        from t_enhet2
        where 1=1
        group by merke_vasket,modell_vasket, merke_vasket||modell_vasket, del_vasket, merke_vasket||modell_vasket||del_vasket,  scope_vasket
        order by n2_break_fab_type_del, n3_scope )
      select 
        n1_fab_navn                                                               as fab_navn,             
        n1_type_id                                                                as type_id,
        n1_break_fab_type                                                         as                curr_fab_type,
        -- NBNB denne order by kostet 6 timer       ---->>>>>> xxxxxxxxxxxx <<<---
        lag (n1_break_fab_type,1,'---') over(order by n2_break_fab_type_del)      as prev_fab_type,
        lead(n1_break_fab_type,1,'+++') over(order by n2_break_fab_type_del)      as                               next_fab_type,
        n2_del                                                                    as del,
        n2_break_fab_type_del                                                     as                curr_fab_type_del,
        lag (n2_break_fab_type_del,1,'---') over(order by n2_break_fab_type_del)  as prev_fab_type_del,
        lead(n2_break_fab_type_del,1,'+++') over(order by n2_break_fab_type_del)  as                               next_fab_type_del,
        n3_scope                                                                  as scope,
            --Døme
              -- [{"title": "opelde lux","expanded": false, "folder": true, "children": [
              --    {"title": "900", "folder": true, },
              --    {"title": "9-3", "folder": true, }
              -- ]}]          
      --Nivå 1
          --[{"title": "opelde lux","expanded": false, "folder": true, "children": [
          -- {"title": "opelde lux","expanded": false, "folder": true, "children": [
          case when   '---'             = lag (n1_break_fab_type,1,'---')         over(order by n2_break_fab_type_del) or 
                     --spezial her siden vi har mange separatejson i en sql 
                     n1_break_fab_type     <> lag (n1_break_fab_type,1,'---')     over(order by n2_break_fab_type_del) then 
            '[ '||'{"title": "'||n2_del||'","expanded": false, "folder": true, "ft_level":"2_parent", "to_url_parent": "'||www_root||n1_fab_navn||'/'||n1_type_id||'/'||n2_del||'/'||n1_fab_navn||'-'||n1_type_id||'-'||n2_del||'.html" , "children": ['||chr(13)||chr(10)   
               when  n2_break_fab_type_del <> lag (n2_break_fab_type_del,1,'---') over(order by n2_break_fab_type_del) then 
            '  '||'{"title": "'||n2_del||'","expanded": false, "folder": true, "ft_level":"2_parent", "to_url_parent": "'||www_root||n1_fab_navn||'/'||n1_type_id||'/'||n2_del||'/'||n1_fab_navn||'-'||n1_type_id||'-'||n2_del||'.html" , "children": ['||chr(13)||chr(10)   
          end  
          as nivaa_1,   
      --Nivå 2
          --{"title": "900", "folder": true, },
          --{"title": "9-3", "folder": true, }
           case when n2_break_fab_type_del = lead(n2_break_fab_type_del,1,'+++') over(order by n2_break_fab_type_del) then
           '      '||'{"title": "'||n3_scope||'", "folder": true , "ft_level":"2_child" , "to_url": "'||www_root||n1_fab_navn||'/'||n1_type_id||'/'||n2_del||'/'||n1_fab_navn||'-'||n1_type_id||'-'||n3_scope||'-'||n2_del||'.html" },'||chr(13)||chr(10)
           else 
           '      '||'{"title": "'||n3_scope||'", "folder": true , "ft_level":"2_child" , "to_url": "'||www_root||n1_fab_navn||'/'||n1_type_id||'/'||n2_del||'/'||n1_fab_navn||'-'||n1_type_id||'-'||n3_scope||'-'||n2_del||'.html"} '||chr(13)||chr(10)   
           end 
          as nivaa_2,       
      --Nivå 3
          -- ]},   eller ]}nylinje]       
          case when n2_break_fab_type_del =  lead(n2_break_fab_type_del,1,'+++') over(order by n2_break_fab_type_del) then 
           ''||       chr(13)||chr(10) 
               when n2_break_fab_type_del <> lead(n2_break_fab_type_del,1,'+++') over(order by n2_break_fab_type_del) 
               and  n1_break_fab_type     =  lead(n1_break_fab_type    ,1,'+++') over(order by n2_break_fab_type_del) then            
           ''||']},'||chr(13)||chr(10) 
           else   
           ''||']}]'||chr(13)||chr(10) 
           end
          as nivaa_3
    from html_fancy_del_scope
    where 1=1
    and n3_scope is not null
    order by n2_break_fab_type_del, n3_scope 
    /
    
----------------------------------------------------------- v_html_mobis_fab_type & del_scope brukes i DELER-----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_html_mobis_fab_type as
      --2015-07-06 where på location_seq_no og paa_bil
      --2015-07-07 bytter ut t_enhet2_full med t_enhet_2 tar vekk where klasul igjen (den er allerede dekket)
      --2015-10-18 bytte _desktop ut med pages
      --201512-12 RSP2_WWW_ROOT_OBAS fra html_kode isteden for http://www,olasbil.as
      -- select html_ref_kode from html_ref where use='RSP2_WWW_ROOT_OBAS'
    with html_mobiscroll_fab_type as (
        select distinct 
              0             as fab_seq_no,
              0             as type_seq_no,
              merke_vasket  as fab_navn,
              modell_vasket as type_id,
              (select to_char(html_ref_kode) from html_ref where use='RSP2_WWW_ROOT_OBAS') as www_root
        from t_enhet2
        order by fab_navn,type_id)
        --alternaiv til v_html_merke_modell_del_item_l 
        --http://www.oracle-base.com/articles/misc/lag-lead-analytic-functions.php
        --select rownum , fab_navn,type_id from html_mobiscroll_fab_type
    select 
        fab_navn                                                 as                curr_fab_navn,
        lag (fab_navn,1,'---') over(order by fab_navn)           as prev_fab_navn,
        lead(fab_navn,1,'+++') over(order by fab_navn)           as                               next_fab_navn,
        type_id                                                  as                curr_type_id,
        lag (type_id,1 ,'---') over(order by fab_navn||type_id)  as prev_type_id,
        lead(type_id,1 ,'+++') over(order by fab_navn||type_id)  as                               next_type_id,
        --Nivå 1
          --<li data-val='ALFA-ROMEO'>ALFA-ROMEO<ul>
          --<li data-val="http://www.olasbil.as/_desktop/AUDI">AUDI<ul>
          case when fab_navn <> lag(fab_navn,1,'---') over(order by fab_navn) then 
           '                                    '||
           --       '<li data-val="http://www.olasbil.as/_desktop/'||fab_navn||'">'||fab_navn||'<ul>'||chr(13)||chr(10) end  
                  '<li data-val="'||www_root||fab_navn||'">'||fab_navn||'<ul>'||chr(13)||chr(10) end  
          as nivaa_1,   
        --Nivå 2 <<ALLTID>>
          --<li data-val='156'>156</li>
          --<li data-val="/A3/AUDI-A3.html"><a href="http://www.olasbil.as/_util/_dev/bildeler.net/AUDI/A3/AUDI-A3.html">A3</a></li>
           '                                    '||'      '||      
           '<li data-val="/'||type_id||'/'||fab_navn||'-'||type_id||'.html"><a href="'||www_root||fab_navn||'/'||type_id||'/'||fab_navn||'-'||type_id||'.html">'||type_id||'</a><div class="level">n2</div></li>'      
          as nivaa_2,       
        --Nivå 3
          -- </ul></li>
           case when fab_navn <> lead(fab_navn,1,'---') over(order by fab_navn) then '</ul></li>' end
          as nivaa_3          
    from html_mobiscroll_fab_type
    where 1=1
    and fab_navn is not null
    order by fab_navn,type_id
    /
        --dill
          spool c:\temp\t.lis
          set linesize 500
          set pagesize 9999
          set heading off
          --select max(length(nivaa_1||nivaa_2||nivaa_3))
          select '                 '||nivaa_1||nivaa_2||nivaa_3
          from v_html_mobis_fab_type;
          spool off
          
          select distinct       merke_vasket  as fab_navn,      modell_vasket as type_id from t_enhet2_full 
           where (  location_seq_no is not null or paa_bil='J') and html_ok='ja'                order by fab_navn,type_id;
          --#346 -->334
          select distinct       merke_vasket  as fab_navn,      modell_vasket as type_id from v_html_merke_modell_del_item_l order by fab_navn,type_id;
          --#344
                  select distinct       merke_vasket  as fab_navn,      modell_vasket as type_id from t_enhet2_full                  
                  minus
                  select distinct       merke_vasket  as fab_navn,      modell_vasket as type_id from v_html_merke_modell_del_item_l ;
                  --HONDA CBR
          
    create or replace view v_html_mobis_del_scope as
      --2015-07-07 bytter ut v_t_enhet2_full med v_t_enhet_2 tar vekk where klasul igjen (den er allerede dekket)
      --2015-10-18 bytte _desktop ut med pages  
      -- select html_ref_kode from html_ref where use='RSP2_WWW_ROOT_OBAS'
      with html_mobiscroll_del_scope as
        (
        select distinct
              merke_vasket  as fab_navn,
              modell_vasket as type_id,      
              del_vasket    as del,
              scope_vasket  as scope,
              (select to_char(html_ref_kode) from html_ref where use='RSP2_WWW_ROOT_OBAS') as www_root,
              count(*)      as ant
        from t_enhet2
        where 1=1
        --and scope is not null
        --and merke_vasket  ='BMW'
        --and modell_vasket ='500'
        --and (location_seq_no is not null or paa_bil='J')
        group by merke_vasket,modell_vasket,del_vasket,scope_vasket
        order by del,scope)
        --alternaiv til v_html_merke_modell_del_item_l 
        --http://www.oracle-base.com/articles/misc/lag-lead-analytic-functions.php
        --select rownum , fab_navn,type_id from html_mobiscroll_fab_type
    select 
        fab_navn                                                 as                curr_fab_navn,
        lag (fab_navn,1,'---') over(order by fab_navn)           as prev_fab_navn,
        lead(fab_navn,1,'+++') over(order by fab_navn)           as                               next_fab_navn,
        type_id                                                  as                curr_type_id,
        lag (type_id,1 ,'---') over(order by fab_navn||type_id)  as prev_type_id,
        lead(type_id,1 ,'+++') over(order by fab_navn||type_id)  as                               next_type_id,
        del                                                      as                curr_del,
        lag (del,1,'---') over(order by scope||del)              as prev_del,
        lead(del,1,'+++') over(order by scope||del)              as                               next_del,
        scope                                                    as                curr_scope,
        lag (scope,1   ,'---') over(order by scope)              as prev_scope,
        lead(scope,1   ,'+++') over(order by scope)              as                               next_scope,
        --Nivå 1
         --<li data-val="http://www.olasbil.as/_desktop/BMW"            >BMW    <ul>
         --=========================================================================
         --<li data-val="http://www.olasbil.as/_desktop/BMW/300/BAKLUKE">BAKLUKE<ul>
         --=========================================================================
           case when del      <> lag(del  ,1,'---')    over(order by del  )    then
           '                          '||
           '<li data-val="'||www_root||fab_navn||'/'||type_id||'/'||del||'">'||del||'<ul>'||chr(13)||chr(10) end        
         as nivaa_1,   
         --  
        --Nivå 2 <<ALLTID>>
         --<li data-val="/X5/BMW-X5.html">          <a href="http://www.olasbil.as/_desktop/BMW/X5/BMW-X5.html"                            >X5       </a></li>
         --<li data-val="/Z3/BMW-Z3.html">          <a href="http://www.olasbil.as/_desktop/BMW/Z3/BMW-Z3.html"                            >Z3       </a></li>
         --<li data-val="/1-SERIE/BMW-1-SERIE.html"><a href="http://www.olasbil.as/_desktop/BMW/1-SERIE/BMW-1-SERIE.html"                  >1-SERIE  </a></li>
         --<li data-val="/300/BMW-300.html">        <a href="http://www.olasbil.as/_desktop/BMW/300/BMW-300.html"                          >300      </a></li>
         --===================================================================================================================================================
         --                                                  http://www.olasbil.as/_desktop/BMW/300/BAKLUKE/BMW-300-1991-2000-BAKLUKE.html">1991-2000</a></li>
         --                                                  http://www.olasbil.as/_desktop/BMW/300/BAKLUKE/BMW-300-1998-2005-BAKLUKE.html">1998-2005</a></li>
         --                                                  http://www.olasbil.as/_desktop/BMW/300/BAKLUKE/BMW-300-BAKLUKE.html"          >alle år  </a></li>
         --alt1
         --<li data-val="/BMW-500-1988-1996-ABS-ENHET.html"><a href="http://www.olasbil.as/_desktop/BMW/500/ABS-ENHET/BMW-500-1988-1996-ABS-ENHET.html">1988-1996</a></li>     
         --alt2
         --<li data-val="/BMW-500-1988-1996-ABS-ENHET.html"><a href="http://www.olasbil.as/_desktop/BMW/500/ABS-ENHET/BMW-500-1988-1996-ABS-ENHET.html">1988-1996</a><div class='ant'> (55stk)</div></li>     
         --===================================================================================================================================================
         --alt 1
         --'                          '||'      '||      
         --'<li data-val="/'||fab_navn||'-'||type_id||'-'||scope||'-'||del||'.html"><a href="http://www.olasbil.as/_desktop/'||fab_navn||'/'||type_id||'/'||del||'/'||fab_navn||'-'||type_id||'-'||scope||'-'||del||'.html">'||scope||'</a></li>'      
         --alt 2
           '                          '||'      '||      
           '<li data-val="/'||fab_navn||'-'||type_id||'-'||scope||'-'||del||'.html"><a href="'||www_root||fab_navn||'/'||type_id||'/'||del||'/'||fab_navn||'-'||type_id||'-'||scope||'-'||del||'.html">'||scope||'</a><div class="ant"> ('||ant||'stk)</div></li>'      
         as nivaa_2,       
        --Nivå 3
          -- </ul></li>
           case when del      <> lead(del     ,1,'---') over(order by del     ) then '</ul></li>' end
          as nivaa_3          
    from html_mobiscroll_del_scope
    order by del,scope
    /
        --dill
          spool c:\temp\t.txt
          set linesize 250
          set heading off
          set pagesize 9999
          select nivaa_1||nivaa_2||nivaa_3 from v_html_mobis_fab_type;
          spool off
          
          
          --http://www.dba-oracle.com/t_recompile_recompliling_invalid_objects.htm
          Set heading off;
          set feedback off;
          set echo off;
          Set lines 999;
          Spool c:\temp\t.lis
          select
             'ALTER ' || OBJECT_TYPE || ' ' ||   OWNER || '.' || OBJECT_NAME || ' COMPILE;' from    dba_objects
          where   status = 'INVALID'
          --and   object_type in ('PACKAGE','FUNCTION','PROCEDURE','VIEW')
          ;
          spool off;
          set heading on;
          set feedback on;
          set echo on;
          @c:\temp\t.lis
          
          
          select distinct modell_vasket, 
          scope_vasket,
          --AUDI
          case when modell_vasket like 'A3%' then 'A3'
               when modell_vasket like 'A4%' then 'A4'
               when modell_vasket like 'A6%' then 'A6'
               when modell_vasket like 'A8%' then 'A8'    
          --BMW     
               else modell_vasket
          end     
          from t_enhet2_full
          where merke_vasket in ('AUDI','BMW','CITROEN','FORD','HONDA','MAZDA','MERCEDES','NISSAN','OPEL','RENAULT'
                                ,'SUBARU','TOYOTA','VOLVO','VW')
          order by 1;
    -----------------------------------------------------------v_apex_list_mobas_menu (krever apex installert) -----------------------------------------------------------------------------------------------------------------------------------
    create or replace view v_apex_list_mobas_menu as
        /*
          2013_06_17 bygget sommerfeire
        */  
        select  apex_level                                              as par_chld,--1,2  For hierarchical lists, the level parameter should be supplied. For non-hierarchical lists, this parameter can be set to NULL  
                apex_label                                              as label, 
               'f?p='||chr(38)||'APP_ID.:'||apex_target||':'||chr(38)||'SESSION.::'||chr(38)||'DEBUG.::::'  as target,  
                                                                                    --f?p=...APP_ID.:300:...SESSION.::...DEBUG.::::
                                                                                    --NOTE:The is_current column can be set to one of the following three values:
                                                                                    --'YES','NO' or NULL. If set to NULL, the currency of the list entry will be based on the target page of the list entry.
               null             is_current_list_entry,
               null             image,                                              --The name of image to be display on the list entry
               null             image_attribute,                                    --Attributes of the image, such as the width or height
               null             image_alt_attribute,                                --Value for Image ALT tag, required for accessibility purposes in templates where the user must click on the image.
               null             attribute1,                                         --These attributes tie in with the existing ten User Attributes exposed on the Static List Entry page.
               null             attribute2,
               null             attribute3,
               null             attribute4,
               null             attribute5,
               null             attribute6,
               null             attribute7,
               null             attribute8,
               null             attribute9,
               apex_sort        attribute10
        from html_ref
        where use like 'MOBAS%'
        and date_hist is null
        union
          --Få inn session id i innlogging
          --da page 101 er public sensurer APEX all mulig listing session id i strengen 
          --ingen annen måte å få dette ut
          select 2,'</a></li><li><a href="f?p=106:101:'||v('APP_SESSION')||'">Logg inn',null,
          null,null,null,null,null,null,null,null,null,null,null,
          'class="skip"' as attribute8 ,
          null,9997
          from dual
        union
          --Må legge til en sub-liste slik at man får tvinget frem autogenerert </li>
          --Hvis ikke kan den komme tidligere i listingen dersom det ikke finnes flere sublister og da mister vi kontroll
          select 1,'skip_end_list_level1','9998',
          null,null,null,null,null,null,null,null,null,null,null,null,'<li class="skip">' as attribute9,9998 as attribute10
          from dual
        union
          select 2,'skip_end_list_level2','9999',
          null,null,null,null,null,null,null,null,null,null,null,null,null,9999 as attribute10
          from dual
        order by attribute10
    /
    
    
    
    create or replace view v_todo_apex as
    /*
      2012_04_15 bygget etter v_movie_apex
    */  
    select 
      '_1'                                          as sort_order,
      null                                          as todo_seq_no,
      null                                          as ansv,
      null                                          as date_start,
      null                                          as date_due,
      null                                          as date_ok,
      null                                          as del,
      chr(38)||'nbsp;'       || --en space
      '<font face="Courier">'||                  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+0  ),3) || --as "0",
      rpad(to_char(to_number(to_char(sysdate,'iw'))+1  ),3) || --as "+1",
      rpad(to_char(to_number(to_char(sysdate,'iw'))+2  ),3) || --as "+2",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+3  ),3) || --as "+3",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+4  ),3) || --as "+4",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+5  ),3) || --as "+5",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+6  ),3) || --as "+6",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+7  ),3) || --as "+7",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+8  ),3) || --as "+8",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+9  ),3) || --as "+9",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+10 ),4) || chr(38)||'nbsp;'|| --as "+10",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+11 ),4) || chr(38)||'nbsp;'|| --as "+11",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+12 ),4) || chr(38)||'nbsp;'|| --as "+12",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+13 ),4) || chr(38)||'nbsp;'|| --as "+13",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+14 ),4) || chr(38)||'nbsp;'|| --as "+14",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+15 ),4) || chr(38)||'nbsp;'|| --as "+15",  
      rpad(to_char(to_number(to_char(sysdate,'iw'))+16 ),4) || chr(38)||'nbsp;'|| --as "+16"
      ' uke</font>'                                 as timeline 
    from dual
    union
    select 
      '_2'                                          as sort_order,
      null                                          as todo_seq_no,
      null                                          as ansv,
      null                                          as date_start,
      null                                          as date_due,
      null                                          as date_ok,
      null                                          as del,
      chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  || --tre space
      '<font face="Courier">'|| 
      rpad('0 +1 +2 +3 +4 +5 +6 +7 +8 +9 +10 +11 +12 +13 +14 +15 +16',56)||
      '</font>                                                 'as timeline
    from dual  
    union
    select 
      '_3'                    as sort_order,
      todo.todo_seq_no        as todo_seq_no,
      todo.ansv               as ansv,
      todo.date_start         as date_start,
      todo.date_due           as dato_due,
      todo.date_ok            as dato_ok,
      null                    as del,
      '<font face="Courier">'||
      --case when to_number(to_char(sysdate,'iw'))+1 >= to_number(to_char(firstdate,'iw'))  then rpad('<span style="background-color:yellow;font-weight:bold;"> </span>',3)  end  as "+1",
      case when to_number(to_char(sysdate,'yyyyiw'))+0 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+0 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('--'  ,2)  when to_number(to_char(sysdate,'yyyyiw'))+0  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[-'  ,2)  when to_number(to_char(sysdate,'yyyyiw'))+0  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'                    end  ||  --as "+0",
      case when to_number(to_char(sysdate,'yyyyiw'))+1 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+1 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+1  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+1  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+1",
      case when to_number(to_char(sysdate,'yyyyiw'))+2 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+2 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+2  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+2  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+2",
      case when to_number(to_char(sysdate,'yyyyiw'))+3 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+3 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+3  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+3  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+3",
      case when to_number(to_char(sysdate,'yyyyiw'))+4 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+4 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+4  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+4  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+4",
      case when to_number(to_char(sysdate,'yyyyiw'))+5 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+5 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+5  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+5  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+5",
      case when to_number(to_char(sysdate,'yyyyiw'))+6 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+6 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+6  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+6  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+6",
      case when to_number(to_char(sysdate,'yyyyiw'))+7 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+7 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+7  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+7  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+7",
      case when to_number(to_char(sysdate,'yyyyiw'))+8 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+8 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+8  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--'  ,3)  when to_number(to_char(sysdate,'yyyyiw'))+8  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+8",
      case when to_number(to_char(sysdate,'yyyyiw'))+9 > to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+9 < to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+9  = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[--' ,3)  when to_number(to_char(sysdate,'yyyyiw'))+9  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'  end  ||  --as "+9",
      case when to_number(to_char(sysdate,'yyyyiw'))+10> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+10< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+10 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+10  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+10",
      case when to_number(to_char(sysdate,'yyyyiw'))+11> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+11< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+11 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+11  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --s "+11",
      case when to_number(to_char(sysdate,'yyyyiw'))+12> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+12< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+12 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+12  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+12",
      case when to_number(to_char(sysdate,'yyyyiw'))+13> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+13< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+13 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+13  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+13",
      case when to_number(to_char(sysdate,'yyyyiw'))+14> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+14< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+14 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+14  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+14",
      case when to_number(to_char(sysdate,'yyyyiw'))+15> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+15< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+15 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+15  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+15",
      case when to_number(to_char(sysdate,'yyyyiw'))+16> to_number(to_char(todo.date_start,'yyyyiw'))  and to_number(to_char(sysdate,'yyyyiw'))+16< to_number(to_char(todo.date_due,'yyyyiw')) then rpad('----',4)  when to_number(to_char(sysdate,'yyyyiw'))+16 = to_number(to_char(todo.date_start,'yyyyiw')) then rpad('[---',4)  when to_number(to_char(sysdate,'yyyyiw'))+16  = to_number(to_char(todo.date_due,'yyyyiw')) then rpad('---]',4)  else chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;' end  ||  --as "+16"
      '</font>'            as timeline
    from ola.todo         todo
    order by sort_order,date_start,ansv;
    /
        --dill
          select count(*) from v_movie_apex;
          
          Gyldige kombinasjoner på enhet (ser enhet_xx.sql for evnt opprydding/validering
          
          VARE_GRUPPE_SEQ_NO  PAA_BIL  HOLD_ON  SERIE_SEQ_NO  LOCATION_SEQ_NO  VAR_BIL_SEQ_NO  
             NOT NULL                                                                        
          ==================  =======  =======  ============  ===============  ==============  
          x                   J                                                                     plukke deler
          x                   x        J        x             x                x                   en eller annen enhet_seq_no satt på HOLD_ON
          0                                                                                        temp PDA se enhet_18.sql from opprydding
          1                                     x                                                  alle vrak må ha serie nr ALLTID untatt V_ekstern
          1                                                   3330                                 kun V_EKSTERN slipper serie_nr       
          -->HOTTE DELER      !=J      !=J                    !=null & -EKSTERN
                                                                       -EKSPORT etc           
    
----------------------------------------------------------- v_enhet4 ------------------------------------------------------------------------------------------    
    create or replace view v_enhet4 as
        select    
            --primært
                 sysdate                    stamp
                ,c.enhet_seq_no             c_enhet_seq_no              ,p.enhet_seq_no             p_enhet_seq_no              ,nvl2(c.enhet_seq_no,       c.enhet_seq_no,         p.enhet_seq_no          ) r_enhet_seq_no  
                ,c.prev_enhet_seq_no        c_prev_enhet_seq_no         ,p.prev_enhet_seq_no        p_prev_enhet_seq_no         ,nvl2(c.prev_enhet_seq_no,  c.prev_enhet_seq_no,    p.prev_enhet_seq_no     ) r_prev_enhet_seq_no  
                ,c.vare_gruppe_seq_no       c_vare_gruppe_seq_no        ,p.vare_gruppe_seq_no       p_vare_gruppe_seq_no        ,nvl2(c.vare_gruppe_seq_no, c.vare_gruppe_seq_no,   p.vare_gruppe_seq_no    ) r_vare_gruppe_seq_no
                ,c.var_bil_seq_no           c_var_bil_seq_no            ,p.var_bil_seq_no           p_var_bil_seq_no_p          ,nvl2(c.var_bil_seq_no,     c.var_bil_seq_no,       p.var_bil_seq_no        ) r_var_bil_seq_no               
            --BIL fab-type, fage, dører ...///////////////////////////////////////////////////////////////////////////////////
                ,nvl2(c.var_bil_seq_no, (select fab_navn                       from fabrikant, var_bil where c.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.fab_seq_no  = fabrikant.fab_seq_no   )
                                      , (select fab_navn                       from fabrikant, var_bil where p.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.fab_seq_no  = fabrikant.fab_seq_no   ) )  as fab_navn
                ,nvl2(c.var_bil_seq_no, (select type_id                        from type     , var_bil where c.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.type_seq_no = type.type_seq_no       )
                                      , (select type_id                        from type     , var_bil where p.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.type_seq_no = type.type_seq_no       ) )  as type_id
                ,nvl2(c.var_bil_seq_no, (select to_char(aar_model.aar,'yyyy')  from aar_model, var_bil where c.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.aar_seq_no  = aar_model.aar_seq_no   )
                                      , (select to_char(aar_model.aar,'yyyy')  from aar_model, var_bil where p.var_bil_seq_no = var_bil.var_bil_seq_no and var_bil.aar_seq_no  = aar_model.aar_seq_no   ) )  as aar_4
        from 
             enhet             c   --child
            ,enhet             p   --parent
        where 1=1
            and c.prev_enhet_seq_no     = p.enhet_seq_no  (+)        
    /

    --sjekk
        select count(*) from v_enhet4;
        --139162

    --tune
            truncate table plan_table;
            explain plan set statement_id='v_enhet4_plain'          into plan_table for select * from v_enhet4 ;
            explain plan set statement_id='v_enhet4_v_grp_seq_no'   into plan_table for select * from v_enhet4 where r_vare_gruppe_seq_no=1;
            commit;


----------------------------------------------------------- v_prosess ------------------------------------------------------------------------------------------    
    create or replace view v_prosess as    
    --create table  t as
    --create or replace view ttt as
        with 
            --HUSK å avstemme med f_prosess ved endringer
            prosess_decode as ( 
                    select 'D11'                 as prosess, 'Deler i plukkeliste'                                                      as prosess_desc from dual union
                    select 'D12'                 as prosess, 'Deler demontert har ikke f'||f_utf('aa')||'tt delenr'                     as prosess_desc from dual union
                    select 'D13'                 as prosess, 'Deler punchet med delenr (av Vidar)'                                      as prosess_desc from dual union
                    select 'D21'                 as prosess, 'Deler p'||f_utf('aa')||' lager (av Toralv)'                               as prosess_desc from dual union
                    select 'ED1'                 as prosess, 'Deler feilregistrert'                                                     as prosess_desc from dual union   
                    select 'D99'                 as prosess, 'Deler solgt'                                                              as prosess_desc from dual union   
                    select 'V11'                 as prosess, 'Vrak lagt inn p'||f_utf('aa')||' henteliste'                              as prosess_desc from dual union
                    select 'V12'                 as prosess, 'Vrak motatt (av Tommy)'                                                   as prosess_desc from dual union
                    select 'V21'                 as prosess, 'Vrak plassert p'||f_utf('aa')||' selvplukk'                               as prosess_desc from dual union
                    select 'V41'                 as prosess, 'Vrak i sirkulasjon inne, ute etc'                                         as prosess_desc from dual union
                    select 'EV1'                 as prosess, 'Vrak feilregistrert'                                                      as prosess_desc from dual union
                    select 'V99'                 as prosess, 'Vrak presset'                                                             as prosess_desc from dual union   
                    select 'EF1'                 as prosess, 'Deler feilregistrert'                                                     as prosess_desc from dual  
            )
        select * from prosess_decode
        order by 1
    /

    create or replace view v_prosess_snapshot as
        select prosess, prosess_desc, count(*) as nos
        from t_enhet3
        group by prosess, prosess_desc
        order by prosess
    /

    
    --avstemming
        select sum(nos) from v_prosess_snapshot;
        163 242     2020-11-10

        select count(*) from enhet;
        163 242     2020-11-10

    
----------------------------------------------------------- v_prosess_enhet ------------------------------------------------------------------------------------------    
    create or replace view  v_prosess_enhet as 
        with
            prosess_enhet as (
                    select
                        --prim‘rt
                             enhet.enhet_seq_no                                                                                     enhet_seq_no
                        --prosess
                            --DEL -------------------------------------------------------------------------------------------------------------------------------------------------------
                            --d1) Plukke-liste
                            ,case when enhet.vare_gruppe_seq_no <>1 and nvl(enhet.paa_bil,'N') = 'J' and enhet.location_seq_no    is null               and enhet.serie_seq_no is     null  then 'D1' end ||
                            --d2) Vidar punchet
                            case when  enhet.vare_gruppe_seq_no <>1 and nvl(enhet.paa_bil,'N') <>'J' and enhet.location_seq_no    = 0                   and enhet.serie_seq_no is not null  then 'D2' end ||
                            --d3) Deler p† lager
                            case when  enhet.vare_gruppe_seq_no <>1 and                                 nvl(enhet.location_seq_no,0) > 0                                                    then 'D3' end ||
                            --d4) Solgt
                            case when  enhet.vare_gruppe_seq_no <>1 and nvl(enhet.paa_bil,'N') <>'J' and enhet.location_seq_no    is null               and enhet.serie_seq_no is     null  then 'D4' end ||
                            --VRAK-------------------------------------------------------------------------------------------------------------------------------------------------------
                            --v1) Hente-liste
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no =3300                 and enhet.serie_seq_no is not null  then 'V1' end ||
                            --v2) Motatt
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no =-1                   and enhet.serie_seq_no is not null  then 'V2' end ||
                            --v3) Selvplukk
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no =695                  and enhet.serie_seq_no is not null  then 'V3' end ||
                            --v4) Vrak
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no not in (3300,-1,695)
                                                                                                        and enhet.location_seq_no is not null           and enhet.serie_seq_no is not null  then 'V4' end ||
                            --v5) Presset
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no is null               and enhet.serie_seq_no is not null  then 'V5' end ||
                            --v6) Feil
                            case when  enhet.vare_gruppe_seq_no = 1                                     and enhet.location_seq_no is null               and enhet.serie_seq_no is     null  then 'V6' end
                            --S1) Alle med serie_no
                            --case when  enhet.serie_seq_no is not null                                                                                                                       then ' (S1)' end
                            as prosess
                    from enhet
                )
        select
            prosess_enhet.enhet_seq_no
            ,prosess_enhet.prosess
            ,nvl( prosess_decode.prosess_desc, 'TBA mangle prosess...') as prosess_desc
        from
             v_prosess prosess_decode
            ,prosess_enhet
        where prosess_enhet.prosess = prosess_decode.prosess (+)
    /

----------------------------------------------------------- p 205 -------------------------------------------------------------------------------------------------    
    --Regions
        --&nbsp;
            Region Source
                select
                  NULL              del_link,
                  NULL              new_link,
                  seq_id,                                            --Text Field, Select List eller Hidden altå etiterbare
                  seq_id            seq_id_display,
                  -----------------------------------------
                      c001                    spacer,                   --NB ikke edit på denne
                --  to_number(c002)          del_seq_no,               --Text Field, Select List eller Hidden altå etiterbare
                --  to_number(c003)          enhet_seq_no,             --Text Field, Select List eller Hidden altå etiterbare
                --  to_number(c004)          vare_gruppe_seq_no,
                --            c005           to_do,                    --Text Field, Select List eller Hidden altå etiterbare
                --  to_number(c006)          pris,                     --Text Field, Select List eller Hidden altå etiterbare
                --            c007           besk,                     --Text Field, Select List eller Hidden altå etiterbare
                --            c008           merk,                     --Text Field, Select List eller Hidden altå etiterbare
                  --------------slutt collection som gjøres noe med --------------
                   to_number(c002)   enhet_seq_no,                      --Text Field, Select List eller Hidden altå etiterbare
                  -----------------------------------------
                  -----------------------------------------
                  --link direkte her slik at vi kan sette flere parameter i kall
                  --                        f?p=&APP_ID.  :210:&SESSION.         :UPD    :&DEBUG. ::P210_ENHET_SEQ_NO,P210_REQUEST,P210_SEQ_ID:   #ENHET_SEQ_NO#    ,UPD,#SEQ_ID#
                  --http://obas.qrv.no/ords/f?p=108       :210:14027960090309    :UPD    :NO      ::P210_ENHET_SEQ_NO,P210_REQUEST,P210_SEQ_ID:   298453            ,UPD,1
                  ' <a href="f?p='            ||:APP_ID||':210:'||:APP_SESSION||':UPD:'||:DEBUG||'::P210_ENHET_SEQ_NO,P210_REQUEST,P210_SEQ_ID,P210_TILBUDSNR:'||to_number(c002)||',UPD,'||seq_id||','||
                      (select tilbudsnr from v_uni_tilbud where rekvisisjon=c002)
                      ||'">'||
                								        '<i class="fa fa-bomb" aria-hidden="true" title="Redigere" style="color:red"></i>'||
                  					'</a>' as new_link2,
                  -----------------------------------------
                  -----------------------------------------
                      c003   prev_enhet_seq_no,      
                      c004   vare_gruppe_seq_no,     
                      c005   vare_gruppe_id,         
                      c006   prev_vare_gruppe_id,    
                      c007   serie_seq_no,           
                      c008   serie_no,               
                      c009   prev_serie_no,          
                      c010   old_serie_no,           
                      c011   location_seq_no,        
                      c012   loc_id,                 
                      c013   kval_id,                
                      c014   enhet_besk,             
                      c015   temp,                   
                      c016   temp_dato,              
                      c017   dato_inn,               
                      c018   dato_ut,                
                      c019   paa_bil,                
                      c020   hold_on,                
                      to_number(c021)   pris_inkl_mva,          
                      c022   miljo_klarert_id,       
                      c023   pris_solgt_inkl_mva,                   
                      c024   salg_via,                   
                      c025   salg_funnet,                   
                      to_number(c026)   org_pris_inkl_mva,                   
                      c027   org_dato_inn,                   
                      c028   takst_seq_no,                   
                      c029   fab_seq_no,                   
                      c030   type_seq_no,                   
                      c031   var_bil_scope_seq_no,                   
                      c032   c032,     --reg_no              
                      c033   c033,     --ant foto              
                      c034   c034,                   
                      c035   c035,                   
                      c036   c036,                   
                      c037   c037,                   
                      c038   c038,                   
                      c039   c039,                   
                      c040   nr,                     
                      c041   motor,                  
                      c042   gear,                   
                      c043   v0_var_bil_seq_no,      
                      c044   v0_info,                
                      c045   v1_info,                
                      c046   v2_info_a,              
                      c047   v2_info_b,              
                      c048   v2_info_c,              
                      c049   c049,                   
                      c050   c050                    
                from apex_collections
                where 1=1
                and collection_name = 'P205_PLUKK_COLL'

            Region Attributes
                PRIS_INKL_MVA
                    Column Formatting
                        CSS style   width:20px; display:block; white-space:normal;

    --On Load - Before header
        -- 5 create_SQL
            --Condition
                Value of Item / Column in Expression 1 != Expression 2
                    Expression 1    P208_DISPLAY
                    Expression 2    plukk

            declare
                error_txt                 varchar2(500);
                error_exc                 exception;
                i                         number(8)          :=0;
                sok_type                  varchar2(25)       :=null;  
                v_serie_seq_no            number(8);
                v_var_bil_seq_no          number(8);
                v_vare_gruppe_seq_no      number(8);
                v_fab_seq_no              number(8);
                v_type_seq_no             number(8);
                v_var_bil_scope_seq_no    number(8);
                v_reg_no_sok              varchar2(10);        --Reg nr i søkestreng
                v_reg_no_del_vrak         varchar2(10);        --Reg nr funnet via del/vrak  
                v_reg_no_sok_internt      varchar2(10);        --Reg nr i søkestreng,  finnes      internt registrert gitt at det ikke er flere forskjellige i collectionen
                v_reg_no_sok_eksternt     varchar2(10);        --Reg nr i søkestreng,  finnes IKKE internt registrert 
                v_fab_navn                varchar2(50);
                v_type_id                 varchar2(50);
                v_aar                     varchar2(50); 
                v_scope                   varchar2(50);
                v_betegnelse              varchar2(50);
                v_dummy                   varchar2(1024);

                v_sok                     varchar2(1024);
                v_split                   varchar2(1024);
                v_first_word              varchar2(1024);   
                v_rest                    varchar2(1024);

                v_sok_select              varchar2 (4000)    :=null;
                v_sok_select_old_loc      varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 and (c012_loc_id is not null or c019_paa_bil='||chr(39)||'J'||chr(39)||') ';
                v_sok_select_new_loc      varchar2 (4000)    := 'select * from ola.mv_v_bildeler_apex   where 1=1 ';
                v_sok_select_old_all      varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 ';
                v_sok_select_del          varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 and (c012_loc_id is not null or c019_paa_bil='||chr(39)||'J'||chr(39)||') ';

                v_sok_col                 varchar2 (4000)    :=null;
                v_sok_col_old_loc         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||')||upper(c032_reg_no) '; 
                v_sok_col_new_loc         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c008_serie_no)||upper(c012_loc_id)||upper(c014_enhet_besk)||upper(c015_temp)||upper(to_char(c021_pris_inkl_mva))||upper(c040_nr)||upper(c041_motor)||upper(c042_gear)||upper(c045_v1_info)||upper(c046_v2_info_a)||upper(c047_v2_info_b)||upper(c048_v2_info_c)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||') '; 
                v_sok_col_old_all         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c010_old_serie_no)||upper(c012_loc_id)||upper(c014_enhet_besk)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||')||upper(c032_reg_no)||upper(c041_motor)||upper(c042_gear) '; 
                --v_sok_col_del             varchar2 (4000);   --lages lengre nede     ' and c007_serie_seq_no <> '||v_serie_seq_no||' and c004_vare_gruppe_seq_no='||v_vare_gruppe_seq_no||' and c029_fab_seq_no='||v_fab_seq_no||' and c030_type_seq_no='||v_type_seq_no||' and c031_var_bil_scope_seq_no='||v_var_bil_scope_seq_no||' '; 

                v_sok_where               varchar2 (4000)    :=null;  
                v_sok_where_first         varchar2 (4000)    :=null;  
                v_sok_where_del           varchar2 (4000)    :=null;  
                v_sok_where_vognkort_1    varchar2 (4000)    :=null;  

                --STATIC2:del, bil;del_bil,dato_inn, del, bil;dato_del_bil
                v_sok_order               varchar2 (4000)    := null;
                v_sok_order_del_bil       varchar2 (4000)    := ' order by c005_vare_gruppe_id,c044_v0_info';
                v_sok_order_dato_del_bil  varchar2 (4000)    := null;  --2016-03-06 tatt vekk og lagt i report view for å speede opp' order by c017_dato_inn,c005_vare_gruppe_id,c044_v0_info';

                v_sql                     varchar2 (4000)    :=null;  
                v_sql_first               varchar2 (4000)    :=null;  
                v_sql_del                 varchar2 (4000)    :=null;  

            begin
                error_txt :=': Process> After Submit> Søke master..  '||
                                                   '<p> søkestreng   '||v_sok ||
                                                   '<p> prosseserings resultat f'||chr(248) ||'lger:';

                -----------------------------------------start spezial------------------------------------------   
                    :P205_FEED_BACK        :=null;
                    :P205_FEED_BACK_1      :=null;
                    :P205_ERROR_MASTER     :=null;
                    :P205_VOGNKORT_INFO    :=null;        
                    :P205_ERROR_VOGNKORT   :=null;
                    :P205_ARRAY            :=null;
                    :P205_SOK_TYPE         :=null;
                    :P205_REG_NO           :=null;    --is not null kriterie for å starte create_coll add-on vognkort (kalles flere ganger)
                    :P205_REG_NO_INTERNT   :=null;
                    :P205_REG_NO_EKSTERNT  :=null;
                    :P205_SQL              :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_01           :=null;
                    :P205_SQL_FIRST        :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_DEL          :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)

                    if :P205_SOK is not null then v_sok:=upper(:P205_SOK); end if;  --ref tom streng gir feil


                if (:P205_SOK is  null and :P205_ADV_1 is null) or (:P205_SOK is  null and :P205_ADV_1 is not null and :P205_ADV_1_SOK is null) then
                   :P205_FEED_BACK :='tomt søkefelt';
                else
                    --P205_SOK_MET, static2                   
                    --            på lager;  old_loc,
                    --    lager(alle felt);  new_loc,
                    --                 alt;  old_all,
                    --            plukking;  plukk
                    case
                        when :P205_SOK_MET = 'old_loc'     then
                          v_sok_select := v_sok_select_old_loc;          
                          v_sok_col    :=    v_sok_col_old_loc;
                        when :P205_SOK_MET = 'new_loc'     then
                          v_sok_select := v_sok_select_new_loc;
                          v_sok_col    :=    v_sok_col_new_loc;
                        when :P205_SOK_MET = 'old_all'     then
                          v_sok_select := v_sok_select_old_all;
                          v_sok_col    :=    v_sok_col_old_all;
                        else
                          v_sok_select := v_sok_select_old_loc;
                          v_sok_col    :=    v_sok_col_old_loc;
                        end case;

                    --P205_SORT, static2
                    --del, bil;del_bil,dato_inn, del, bil;dato_del_bil
                    case
                        when :P205_SORT = 'del_bil'          then
                          v_sok_order  := v_sok_order_del_bil;
                        when :P205_SORT = 'dato_del_bil'     then
                          v_sok_order  := v_sok_order_dato_del_bil;
                        else
                          v_sok_order  := v_sok_order_del_bil;
                        end case;

                    --P205_ADV_1_SOK
                    case 
                      when ( :P205_SOK_MET = 'old_loc'  and :P205_ADV_1_SOK is not null  ) then 
                           v_sok_select := v_sok_select||' and upper(c040_nr|| c041_motor||c042_gear) like '||chr(39)||'%'||upper(:P205_ADV_1_SOK)||'%'||chr(39)||' ';
                        else   
                          --NOP
                          error_txt :=error_txt;
                        end case;                                                                                 


                    --vi submitter siden ymse ganger for å får Ny og slett rekke til å virke
                    --Derfor testes det på om P205_SEQ_ID er tom Det betyr at vi ikke har gjort noen endringer og kan hente alt på nytt når vi kommer fraoversikts-side
                    --Dett virker fordi 620 clearer cach når den kaller siden
                    --if  not apex_collection.collection_exists       (p_collection_name      => v_collection_name)  or  :P205_SEQ_ID is null   then

                    --NO.1 behandler søkestreng

                      --1.a trekker ut evnt streng i anførselstegn (finner kun første) NB INGEN LOGIKK HVIS REG.NR
                        --Re: Extract string between two parts
                        --https://community.oracle.com/thread/2320195?tstart=0
                        --Kun 1
                        -----------------------------------------------------------------------------------------------------------------------
                        --select regexp_substr ('vanlig saab bmw " forste "  opel "andre " audi', '"(.*?)\"', 1, 1,null,1) ||'<---' from dual
                        --select regexp_substr (v_sok,'"(.*?)\"', 1, 1,null,1) into v_split from dual;
                        --v_rest      := replace(v_rest,'"'||v_split||'"',' '); --<<<<  her UTEN apostroff
                        --Mange
                        -----------------------------------------------------------------------------------------------------------------------
                        --select                      regexp_substr ('vanlig saab bmw " forste "  opel "andre " au"di', '"(.*?)\"', 1,  rownum) split  
                        --from dual
                        --connect by level <= length (regexp_substr ('vanlig saab bmw " forste "  opel "andre " aud"i', '"(.*?)\"', 1,  rownum)
                        --                           ) + 1                                                                                                   
                        --  " forste "
                        --  "andre "
                        --
                        v_rest := v_sok;
                        :P205_ARRAY   := 'orginal soke streng=['||v_sok||']';
                        v_split :=null;
                        i:=0;
                        for x in ( select                      regexp_substr (v_rest, '"(.*?)\"', 1,  rownum) split
                                   from dual                                                                                                                  
                                   connect by level <= length (regexp_substr (v_rest, '"(.*?)\"', 1,  rownum)      
                                                              ) + 1                                                                                           
                        ) loop
                            v_split:=x.split;
                            v_rest      := replace(v_rest,v_split,''); --rusker vekk allerede behandlet søke kritere        
                            :P205_ARRAY := :P205_ARRAY||' rest soke streng'||to_char(i+1)||' gir ('||v_split||')';
                            v_split     := replace(upper(v_split),'"','');
                            v_sok_where := v_sok_where|| v_sok_col || 'like '||chr(39)||'%'||v_split||'%'||chr(39)||' ';
                            if i =0 and v_split is NOT null then
                              v_sok_where_first := v_sok_where; 
                              v_first_word := v_split; 
                              :P205_ARRAY   := :P205_ARRAY||' forste ord='||v_first_word;
                            end if;           
                            i := i+1; 
                        end loop; 

                      --1.b splitter opp alt som er delt med mellomrom i v_rest (hvor evnt streng i anførseltegn er rusket vekk)  PLUSS  ser etter reg-nr
                        --http://nuijten.blogspot.nl/2009/07/splitting-comma-delimited-string-regexp.html
                        --with test as (select 'ABC   DEF GHI    JKL MNO' str from dual  )  
                        --select regexp_substr (str, '[^ ]+', 1, rownum) split  
                        --from test  
                        --connect by level <= length (regexp_replace (str, '[^ ]+'))  + 1
                        -- eller .....
                        -- select regexp_substr ('ABC   DEF GHI    JKL MNO', '[^ ]+', 1, rownum) split  
                        -- from dual
                        -- connect by level <= length (regexp_replace ('ABC   DEF GHI    JKL MNO', '[^ ]+'))  + 1
                        -------------------------------------------------------------------------------------------
                        --http://psoug.org/snippet/Regular-Expressions--REGEXP_REPLACE_882.htm
                        -- collapse multiple spaces to a single space:
                        --SELECT REGEXP_REPLACE('some    text    with lots     of    extra spaces', '( ){2,}', ' ') RESULT FROM dual
                        -------------------------------------------------------------------------------------------
                        -- RESULTAT
                        --select                      regexp_substr ( REGEXP_REPLACE('ABC   DEF GHI    JKL MNO','( ){2,}' , ' '        ) 
                        --                                                                                     ,'[^ ]+'   , 1  , rownum) split  
                        --from dual
                        --connect by level <= length (regexp_replace (REGEXP_REPLACE('ABC   DEF GHI    JKL MNO','( ){2,}' , ' '        ) 
                        --                                                                                     ,'[^ ]+')
                        --                           ) + 1
                        :P205_ARRAY   := :P205_ARRAY||' vanlig uttrekk gir ';
                        v_split :=null;
                        i:=0;
                        for x in ( select                      regexp_substr ( REGEXP_REPLACE(v_rest,'( ){2,}' , ' '        ) 
                                                                                                       ,'[^ ]+'   , 1  , rownum) split  
                                   from dual
                                   connect by level <= length (regexp_replace (REGEXP_REPLACE(v_rest,'( ){2,}' , ' '        ) 
                                                                                                       ,'[^ ]+')
                                                              ) + 1
                        ) loop
                          v_split:=x.split;
                          :P205_ARRAY   := :P205_ARRAY||' ('||v_split||')';               
                          v_split     := upper(v_split);
                          v_sok_where := v_sok_where|| v_sok_col || 'like '||chr(39)||'%'||v_split||'%'||chr(39)||' ';           
                          if i =0 and v_sok_where_first is null then
                            v_sok_where_first := v_sok_where; 
                            v_first_word := v_split;    
                            :P205_ARRAY   := :P205_ARRAY||' forste ord='||v_first_word;                            
                          end if;                               
                          i:=i+1;    
                          --regnr add-on 1
                          ----------------
                          --http://www.techonthenet.com/oracle/questions/isalpha.php
                          --TEST A STRING FOR AN ALPHABETIC VALUE
                          --length(trim(translate('Tech on the Net', 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ' ')))  would return null
                          --2014_05_25
                          --NBNB Volvo XC70 oppfattes som reg nr--> feil tester påminst 5posisjoner i reg. no
                          if    length(trim(translate(substr(v_split,1,2) , 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', ' '))) is null
                                   and                       substr(v_split,3,1) in ('1','2','3','4','5','6','7','8','9','0') 
                                   and length (v_split)>4 then
                            :P205_REG_NO := v_split;  
                          end if;                 
                        end loop;                                                  

                    --NO.2 TILSVARENDE deler fra vrak.nr. eller dele.nr. (kun ett søke ord)
                      if i=1 and substr(v_first_word,1,1) in ('V','D') and substr(v_first_word,2,1) in ('1','2','3','4','5','6','7','8','9') then
                            :P205_SOK_TYPE :='TILSVARENDE';
                            begin
                              --SERIE_SEQ_NO
                              ---------------
                              --select trim(TRANSLATE('1tech23', '123',' ')) from dual;
                              select serie_seq_no  
                              into v_serie_seq_no
                              from serie 
                              where 1=1
                              and nvl(serie_anv_seq_no,-1) = decode(substr(v_first_word,1,1),'V',1,-1)
                              and   serie_no= to_number(trim(TRANSLATE(v_first_word, 'VD',' ')));

                              --VARE_GRUPPE_SEQ_NO, VAR_BIL_SEQ_NO
                              ------------------------------------
                              select  nvl(enhet.var_bil_seq_no,enhet_2.var_bil_seq_no),   enhet.vare_gruppe_seq_no,  nvl(enhet.reg_no,enhet_2.reg_no)
                              into                                   v_var_bil_seq_no ,       v_vare_gruppe_seq_no,          v_reg_no_del_vrak
                              from enhet enhet, 
                                   enhet enhet_2
                              where 1=1
                              and enhet.prev_enhet_seq_no  = enhet_2.enhet_seq_no           (+)
                              and enhet.serie_seq_no =v_serie_seq_no
                              and decode(enhet.vare_gruppe_seq_no,1,1,-1)  = decode(substr(v_first_word,1,1),'V',1,-1)
                              and (enhet.location_seq_no is not null or enhet.paa_bil ='J');

                              --regnr add-on PRELIMINARY
                              --------------------------
                              :P205_REG_NO_INTERNT:= upper(trim(v_reg_no_sok_internt));            


                              --FAB_SEQ_NO, TYPE_SEQ_NO, VAR_BIL_SCOPE_SEQ_NO
                              -----------------------------------------------
                              select fab_seq_no,   type_seq_no,   var_bil_scope_seq_no
                              into v_fab_seq_no, v_type_seq_no, v_var_bil_scope_seq_no
                              from var_bil
                              where 1=1
                              and var_bil_seq_no =v_var_bil_seq_no;

                              v_sok_where_del :=' and c007_serie_seq_no <> '        ||v_serie_seq_no||
                                                ' and c004_vare_gruppe_seq_no='     ||v_vare_gruppe_seq_no||
                                                ' and c029_fab_seq_no='             ||v_fab_seq_no||
                                                ' and c030_type_seq_no='            ||v_type_seq_no||
                                                ' and c031_var_bil_scope_seq_no='   ||v_var_bil_scope_seq_no||' '; 

                            exception when others then
                              --v_dummy:='feil '||sqlcode||' '||sqlerrm ;
                              -- må unngå at alle delene listes ut
                              v_sok_where_del :=' and 1=2 ';
                            end;
                      end if;

                    v_sql             := v_sok_select    ||v_sok_where        ||v_sok_order;
                    v_sql_first       := v_sok_select    ||v_sok_where_first  ||v_sok_order;
                    v_sql_del         := v_sok_select_del||v_sok_where_del    ||v_sok_order;

                    :P205_SQL         := v_sql;
                    :P205_SQL_01      := v_sql;
                    :P205_SQL_FIRST   := v_sql_first;
                    :P205_SQL_DEL     := v_sql_del;

                end if;  --:P205_sok behandling ferdig

                exception when error_exc then           
                    --apex_application.g_print_success_message :='<span style="color:red"> Process... </span>'||error_txt;
                    :P205_ERROR_MASTER                       :='create_sql ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                    apex_application.g_print_success_message :='create_sql ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                when others then   
                    :P205_ERROR_MASTER                       :='create_sql ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                    apex_application.g_print_success_message :='create_sql OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         

            end;

        --10 create_coll
            --Condition
                Value of Item / Column in Expression 1 != Expression 2
                    Expression 1    P208_DISPLAY
                    Expression 2    plukk

            declare
                error_txt                 varchar2(500);
                error_exc                 exception;
                v_row_limit               number(8)          :=50; 
                v_row                     number(8)          :=0;
                v_row_go_1                number(8)          :=0;
                v_row_go_2                number(8)          :=0;

                v_reg_no_sok_internt      varchar2(10);        --Reg nr i søkestreng,  finnes      internt registrert gitt at det ikke er flere forskjellige i collectionen
                v_dummy                   varchar2(1024);

                v_sql                     varchar2 (4000)    :=null;  
                v_sql_first               varchar2 (4000)    :=null;  
                v_sql_del                 varchar2 (4000)    :=null;  
                v_spacer                  varchar2 (255);

                --http://www.dbforums.com/oracle/1000258-how-create-dynamic-cursor-like.html
                v_collection_name   varchar2 (30)      := 'P205_PLUKK_COLL';
                rc SYS_REFCURSOR;
                --cursor må henspeile på rett view  eller så får vi bare feil
                --dermed lager vi de like mhp number / chars
                --c1_rec ola.mv_v_bildeler_apex%rowtype; 
                c1_rec ola.mv_v_enhet_master_apex%rowtype; 

            begin
              error_txt :=': Process> After Submit> Søke master..  '||
                                                 '<p> søkestreng   '||:P205_SOK ||
                                                 '<p> prosseserings resultat f'||chr(248) ||'lger:';


              if :P205_SQL is not null or :P205_SQL_FIRST is not null or :P205_SQL_DEL is not null then
                    v_sql             := :P205_SQL; 
                    v_sql_first       := :P205_SQL_FIRST; 
                    v_sql_del         := :P205_SQL_DEL; 
                    :P205_SQL         :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_FIRST   :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_DEL     :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)

                    if :P205_REG_NO_EKSTERNT is not null then v_spacer := '<img src="#APP_IMAGES#vegdir_32_32.png"       border="0">'; end if;

                    --brukes bare nå vi evnt modder på collectionen
                    --apex_collection.delete_collection   (p_collection_name      => v_collection_name);
                    apex_collection.create_or_truncate_collection (p_collection_name      => v_collection_name);

                    :P205_COUNT        :='...';

                    if :P205_ANT_LINJER is not null and :P205_ANT_LINJER<1000 then 
                      v_row_limit := :P205_ANT_LINJER; 
                    else
                      v_row_limit      := 50;
                      :P205_ANT_LINJER := 50;
                    end if;  


                --NO.1 Første forsøk
                ------------------------
                OPEN rc FOR v_sql;
                loop
                  fetch rc into c1_rec;
                  exit when rc%notfound;
                  --legger ut
                  if v_row<v_row_limit then 
                    begin       
                      apex_collection.add_member (
                        p_collection_name => v_collection_name,
                        p_c001            => v_spacer,             --brukes for å få sørge for at CSS id og Collection attr_nr er like 
                                                                   --seq_id hentes nemelig fra Collection i Report viewet
                        p_c002            => c1_rec.c002_enhet_seq_no,         
                        p_c003            => c1_rec.c003_prev_enhet_seq_no,
                        p_c004            => c1_rec.c004_vare_gruppe_seq_no,
                        p_c005            => c1_rec.c005_vare_gruppe_id,
                        p_c006            => c1_rec.c006_prev_vare_gruppe_id,
                        p_c007            => c1_rec.c007_serie_seq_no,
                        p_c008            => c1_rec.c008_serie_no,
                        p_c009            => c1_rec.c009_prev_serie_no,
                        p_c010            => c1_rec.c010_old_serie_no,
                        p_c011            => c1_rec.c011_location_seq_no,
                        p_c012            => c1_rec.c012_loc_id,
                        p_c013            => c1_rec.c013_kval_id,
                        p_c014            => c1_rec.c014_enhet_besk,
                        p_c015            => c1_rec.c015_temp,
                        p_c016            => c1_rec.c016_temp_dato,
                        p_c017            => c1_rec.c017_dato_inn,
                        p_c018            => c1_rec.c018_dato_ut,
                        p_c019            => c1_rec.c019_paa_bil,
                        p_c020            => c1_rec.c020_hold_on,
                        p_c021            => c1_rec.c021_pris_inkl_mva,
                        p_c022            => c1_rec.c022_miljo_klarert_id,
                        p_c023            => c1_rec.c023_pris_solgt_inkl_mva,
                        p_c024            => c1_rec.c024_salg_via,
                        p_c025            => c1_rec.c025_salg_funnet,
                        p_c026            => c1_rec.c026_org_pris_inkl_mva,
                        p_c027            => c1_rec.c027_org_dato_inn,
                        p_c028            => c1_rec.c028_takst_seq_no,
                        p_c029            => c1_rec.c029_fab_seq_no,
                        p_c030            => c1_rec.c030_type_seq_no,
                        p_c031            => c1_rec.c031_var_bil_scope_seq_no,
                        p_c032            => c1_rec.c032_reg_no,
                        p_c033            => c1_rec.c033,
                        p_c034            => c1_rec.c034,
                        p_c035            => c1_rec.c035,
                        p_c036            => c1_rec.c036,     
                        p_c037            => c1_rec.c037,
                        p_c038            => c1_rec.c038,
                        p_c039            => c1_rec.c039,
                        p_c040            => c1_rec.c040_nr,
                        p_c041            => c1_rec.c041_motor,
                        p_c042            => c1_rec.c042_gear,
                        p_c043            => c1_rec.c043_v0_var_bil_seq_no,
                        p_c044            => c1_rec.c044_v0_info,
                        p_c045            => c1_rec.c045_v1_info,
                        p_c046            => c1_rec.c046_v2_info_a,
                        p_c047            => c1_rec.c047_v2_info_b,
                        p_c048            => c1_rec.c048_v2_info_c,
                        p_c049            => c1_rec.c049,
                        p_c050            => c1_rec.c050
                      );
                    end;
                    v_row := v_row+1;
                  end if;  --legge ut       
                end loop;
                v_row_go_1 := rc%rowcount;
                close rc;


                --NO.2 Tilsvareende deler
                ----------------------------------------------------------------------------------------
                if :P205_SOK_TYPE = 'TILSVARENDE' then
                  v_spacer := '<img src="#APP_IMAGES#tilsvarende_32_34.png"  border="0">';
                  OPEN rc FOR v_sql_del;
                  loop
                    fetch rc into c1_rec;
                    exit when rc%notfound;
                    --legger ut
                    if v_row<v_row_limit then 
                      begin       
                        apex_collection.add_member (
                          p_collection_name => v_collection_name,
                          p_c001            => v_spacer,             --brukes for å få sørge for at CSS id og Collection attr_nr er like 
                                                                     --seq_id hentes nemelig fra Collection i Report viewet
                          p_c002            => c1_rec.c002_enhet_seq_no,         
                          p_c003            => c1_rec.c003_prev_enhet_seq_no,
                          p_c004            => c1_rec.c004_vare_gruppe_seq_no,
                          p_c005            => c1_rec.c005_vare_gruppe_id,
                          p_c006            => c1_rec.c006_prev_vare_gruppe_id,
                          p_c007            => c1_rec.c007_serie_seq_no,
                          p_c008            => c1_rec.c008_serie_no,
                          p_c009            => c1_rec.c009_prev_serie_no,
                          p_c010            => c1_rec.c010_old_serie_no,
                          p_c011            => c1_rec.c011_location_seq_no,
                          p_c012            => c1_rec.c012_loc_id,
                          p_c013            => c1_rec.c013_kval_id,
                          p_c014            => c1_rec.c014_enhet_besk,
                          p_c015            => c1_rec.c015_temp,
                          p_c016            => c1_rec.c016_temp_dato,
                          p_c017            => c1_rec.c017_dato_inn,
                          p_c018            => c1_rec.c018_dato_ut,
                          p_c019            => c1_rec.c019_paa_bil,
                          p_c020            => c1_rec.c020_hold_on,
                          p_c021            => c1_rec.c021_pris_inkl_mva,
                          p_c022            => c1_rec.c022_miljo_klarert_id,
                          p_c023            => c1_rec.c023_pris_solgt_inkl_mva,
                          p_c024            => c1_rec.c024_salg_via,
                          p_c025            => c1_rec.c025_salg_funnet,
                          p_c026            => c1_rec.c026_org_pris_inkl_mva,
                          p_c027            => c1_rec.c027_org_dato_inn,
                          p_c028            => c1_rec.c028_takst_seq_no,
                          p_c029            => c1_rec.c029_fab_seq_no,
                          p_c030            => c1_rec.c030_type_seq_no,
                          p_c031            => c1_rec.c031_var_bil_scope_seq_no,
                          p_c032            => c1_rec.c032_reg_no,
                          p_c033            => c1_rec.c033,
                          p_c034            => c1_rec.c034,
                          p_c035            => c1_rec.c035,
                          p_c036            => c1_rec.c036,     
                          p_c037            => c1_rec.c037,
                          p_c038            => c1_rec.c038,
                          p_c039            => c1_rec.c039,
                          p_c040            => c1_rec.c040_nr,
                          p_c041            => c1_rec.c041_motor,
                          p_c042            => c1_rec.c042_gear,
                          p_c043            => c1_rec.c043_v0_var_bil_seq_no,
                          p_c044            => c1_rec.c044_v0_info,
                          p_c045            => c1_rec.c045_v1_info,
                          p_c046            => c1_rec.c046_v2_info_a,
                          p_c047            => c1_rec.c047_v2_info_b,
                          p_c048            => c1_rec.c048_v2_info_c,
                          p_c049            => c1_rec.c049,
                          p_c050            => c1_rec.c050
                        );
                      end;

                      v_row := v_row+1;       
                    end if;  --legge ut       
                  end loop;
                  v_row_go_2 := rc%rowcount;
                  if v_row_go_2 >0 then
                    :P205_FEED_BACK := :P205_FEED_BACK ||'Wow  det var flere deler/vrak innen for samme delegruppe, bil-scope';      
                  end if;
                  close rc;     
                end if;  --Fail Safe no.2

                :P205_COUNT :=v_row||' av '||to_number(v_row_go_1 + v_row_go_2);

              end if;  --:P205_SQLxx behandling ferdig


              exception when error_exc then           
                --apex_application.g_print_success_message :='<span style="color:red"> Process... </span>'||error_txt;
                :P205_ERROR_MASTER                       :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                apex_application.g_print_success_message :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
              when others then   
                :P205_ERROR_MASTER                       :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                apex_application.g_print_success_message :='create_coll OUTHERS_EXC...: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         

            end;        

        --15 create_coll add-on vognkort
            --Condition
                Value of Item / Column in Expression 1 != Expression 2
                    Expression 1    P208_DISPLAY
                    Expression 2    plukk

            declare
              error_txt                 varchar2(500);
              error_exc                 exception;
              v_kjennemerke             varchar2(10); 
              c_seq_no                  number;
              c_seq_id                  number;
              c_inst_code               number;
              c_po_no                   varchar2(500);
              temp                      varchar2(1021);

            begin
              :P205_ERROR_VOGNKORT := null;
              error_txt :=': Process> After Submit> Hente vognkort..  '||
                                                 '<p> registrerings nr internt '||:P205_REG_NO_INTERNT || ' ekstern : '||:P205_REG_NO_EKSTERNT||
                                                 '<p> prosseserings resultat f'||chr(248) ||'lger:';
              --raise error_exc;
                --resetter ALLTID ref sqlen kan feile å da ligger mye grums og flyter
                      :P205_VEGDIR_VOGNKORT_SEQ_NO := null;                         
                      :P205_ID_TEKN := null;
                      :P205_ID_UTEK_TYPG := null; 
                      :P205_MERKE_NAVN := null;
                      :P205_MODELLBETEGNELSE := null;
                      :P205_TYPEBETEGNELSE := null;
                      :P205_REG_AAR_MOD_AAR := null;
                      :P205_KJENNEMERKE := null;
                      :P205_MERKE_MODELL_AAR := null;
                      :P205_MKODE_TYPEBETEGNELSE := null;
                      :P205_KJORETOYGRUPPE := null;
                      :P205_REG_FORSTEG := null;
                      :P205_UNDERSTELLSNUMMER := null;
                      :P205_REG_FORSTEG_NORGE := null;
                      :P205_TYPEGODKJENNINGSNR := null;
                      :P205_SISTE_REG_DATO := null;
                      :P205_EU_HOVEDNUMMER := null;
                      :P205_AVREG_DATO := null;
                      :P205_VERSJON := null;
                      :P205_BRUKTIMPORTERT := null;
                      :P205_VARIANT := null;
                      :P205_FARGE := null;
                      :P205_MOTORMERKING := null;
                      :P205_MOTORYTELSE := null;
                      :P205_GYLDIG_FRA_UNR := null;
                      :P205_SLAGVOLUM := null;
                      :P205_EURONORM := null;
                      :P205_DRIVSTOFF := null;
                      :P205_TOTALVEKT := null;
                      :P205_CO2_UTSLIPP := null;
                      :P205_EGENVEKT := null;
                      :P205_FAB_M_PARTIKKELFILTER := null;
                      :P205_NYTTELAST := null;
                      :P205_STAND_DB_A_OMDREININGER := null;
                      :P205_MAX_TAKLAST := null;
                      :P205_GIRKASSE := null;
                      :P205_LENGDE_BREDDE := null;
                      :P205_SPACER := null;
                      :P205_SITTEPLASSER_TOTALT := null;
                      :P205_STD_DEKK_FORAN_BAK := null;
                      :P205_DRIVENDE_HJUL := null;
                      :P205_STD_FELG_FORAN_BAK := null;
                      :P205_ANTALL_AKSLER := null;
                      :P205_MIN_LI_FORAN_BAK := null;
                      :P205_ANTALL_AKSLER_MED_DRIFT := null;
                      :P205_MIN_HAST_FORAN_BAK := null;
                      :P205_TILL_FORAKSELLAST := null;
                      :P205_MIN_INNPRESS_FORAN_BAK := null;
                      :P205_TILL_BAKAKSELLAST := null;
                      :P205_MAKS_SPORV_FORAN_BAK := null;
                      :P205_TILHENGERVEKT_M_U_BREMS := null;
                      :P205_LENGDE_TIL_TILH_KOBLING := null;
                      :P205_MAX_BELASTNING_H_FESTE := null;
                      :P205_VOGNTOGVEKT := null;
                      :P205_SIST_PKK_GODKJENT := null;
                      :P205_NESTE_PKK := null;
                      :P205_RAMME_KAROSSERI := null;
                      :P205_VOGNKORT_ANM := null;
                      :P205_IDENTITET_ANM := null;
                      :P205_YTELSESMAAL := null;

              if :P205_REG_NO is not null then

                v_kjennemerke :=upper(trim(:P205_REG_NO));
                begin
                    select vegdir_vognkort_seq_no,id_tekn,id_utek_typg,merke_navn,modellbetegnelse,typebetegnelse,reg_aar_mod_aar,kjennemerke,merke_modell_aar,merkekode_typebetegnelse,kjoretoygruppe,reg_forsteg,understellsnummer,reg_forsteg_norge,
                           typegodkjenningsnr,siste_reg_dato,eu_hovednummer,avreg_dato,versjon,bruktimportert,variant,farge,motormerking,motorytelse,gyldig_fra_unr,slagvolum,euronorm,drivstoff,
                           totalvekt,co2_utslipp,egenvekt,fab_mont_partikkelfilter,nyttelast,stand_db_a_omdreininger,max_taklast,girkasse,lengde_bredde,spacer,sitteplasser_totalt,std_dekk_foran_bak,
                           drivende_hjul,std_felg_foran_bak,antall_aksler,min_li_foran_bak,antall_aksler_med_drift,min_hast_foran_bak,till_foraksellast,min_innpress_foran_bak,till_bakaksellast,
                           maks_sporv_foran_bak,tilhengervekt_m_u_brems,lengde_til_tilh_kobling,max_belastning_h_feste,vogntogvekt,sist_pkk_godkjent,neste_pkk,ramme_karosseri,vognkort_anm,identitet_anm,ytelsesmaal
                    into 
                      :P205_VEGDIR_VOGNKORT_SEQ_NO,                         
                      :P205_ID_TEKN,
                      :P205_ID_UTEK_TYPG,
                      :P205_MERKE_NAVN,
                      :P205_MODELLBETEGNELSE,
                      :P205_TYPEBETEGNELSE,
                      :P205_REG_AAR_MOD_AAR,         
                      :P205_KJENNEMERKE,
                      :P205_MERKE_MODELL_AAR,
                      :P205_MKODE_TYPEBETEGNELSE,
                      :P205_KJORETOYGRUPPE,
                      :P205_REG_FORSTEG,
                      :P205_UNDERSTELLSNUMMER,
                      :P205_REG_FORSTEG_NORGE,
                      :P205_TYPEGODKJENNINGSNR,
                      :P205_SISTE_REG_DATO,
                      :P205_EU_HOVEDNUMMER,
                      :P205_AVREG_DATO,
                      :P205_VERSJON,
                      :P205_BRUKTIMPORTERT,
                      :P205_VARIANT,
                      :P205_FARGE,
                      :P205_MOTORMERKING,
                      :P205_MOTORYTELSE,
                      :P205_GYLDIG_FRA_UNR,
                      :P205_SLAGVOLUM,
                      :P205_EURONORM,
                      :P205_DRIVSTOFF,
                      :P205_TOTALVEKT,
                      :P205_CO2_UTSLIPP,
                      :P205_EGENVEKT,
                      :P205_FAB_M_PARTIKKELFILTER,
                      :P205_NYTTELAST,
                      :P205_STAND_DB_A_OMDREININGER,
                      :P205_MAX_TAKLAST,
                      :P205_GIRKASSE,
                      :P205_LENGDE_BREDDE,
                      :P205_SPACER,
                      :P205_SITTEPLASSER_TOTALT,
                      :P205_STD_DEKK_FORAN_BAK,
                      :P205_DRIVENDE_HJUL,
                      :P205_STD_FELG_FORAN_BAK,
                      :P205_ANTALL_AKSLER,
                      :P205_MIN_LI_FORAN_BAK,
                      :P205_ANTALL_AKSLER_MED_DRIFT,
                      :P205_MIN_HAST_FORAN_BAK,
                      :P205_TILL_FORAKSELLAST,
                      :P205_MIN_INNPRESS_FORAN_BAK,
                      :P205_TILL_BAKAKSELLAST,
                      :P205_MAKS_SPORV_FORAN_BAK,
                      :P205_TILHENGERVEKT_M_U_BREMS,
                      :P205_LENGDE_TIL_TILH_KOBLING,
                      :P205_MAX_BELASTNING_H_FESTE,
                      :P205_VOGNTOGVEKT,
                      :P205_SIST_PKK_GODKJENT,
                      :P205_NESTE_PKK,
                      :P205_RAMME_KAROSSERI,
                      :P205_VOGNKORT_ANM,
                      :P205_IDENTITET_ANM,
                      :P205_YTELSESMAAL
                    from vegdir.v_vognkort_apex
                    where kjennemerke =v_kjennemerke;  --'NF34682' 'SC78431';

                exception when others then          
                   :P205_ERROR_VOGNKORT :='INNER_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                end;

              end if;


              exception when error_exc then           
                :P205_ERROR_VOGNKORT                     :='create coll add-on vognkort ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                --apex_application.g_print_success_message :='<span style="color:red"> Process... </span>'||error_txt;
                apex_application.g_print_success_message :='create coll add-on vognkort ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
              when others then   
                :P205_ERROR_VOGNKORT                     :='create coll add-on vognkort OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         
                apex_application.g_print_success_message :='create coll add-on vognkort OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         
            end;        

        --20 create_SQL add-on vognkort
            --Condition
                Value of Item / Column in Expression 1 != Expression 2
                    Expression 1    P208_DISPLAY
                    Expression 2    plukk
            declare
              error_txt                 varchar2(500);
              error_exc                 exception;
              i                         number(8)          :=0;
              sok_type                  varchar2(25)       :=null;  
              v_serie_seq_no            number(8);
              v_var_bil_seq_no          number(8);
              v_vare_gruppe_seq_no      number(8);
              v_fab_seq_no              number(8);
              v_type_seq_no             number(8);
              v_var_bil_scope_seq_no    number(8);
              v_reg_no_sok              varchar2(10);        --Reg nr i søkestreng
              v_reg_no_del_vrak         varchar2(10);        --Reg nr funnet via del/vrak  
              v_reg_no_sok_internt      varchar2(10);        --Reg nr i søkestreng,  finnes      internt registrert gitt at det ikke er flere forskjellige i collectionen
              v_reg_no_sok_eksternt     varchar2(10);        --Reg nr i søkestreng,  finnes IKKE internt registrert 
              v_fab_navn                varchar2(50);
              v_type_id                 varchar2(50);
              v_aar                     varchar2(50); 
              v_scope                   varchar2(50);
              v_betegnelse              varchar2(50);
              v_dummy                   varchar2(1024);

              v_sok                     varchar2(1024);
              v_split                   varchar2(1024);
              v_first_word              varchar2(1024);   
              v_rest                    varchar2(1024);

              v_sok_select              varchar2 (4000)    :=null;
              v_sok_select_old_loc      varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 and (c012_loc_id is not null or c019_paa_bil='||chr(39)||'J'||chr(39)||') ';
              v_sok_select_new_loc      varchar2 (4000)    := 'select * from ola.mv_v_bildeler_apex   where 1=1 ';
              v_sok_select_old_all      varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 ';
              v_sok_select_del          varchar2 (4000)    := 'select * from ola.v_enhet_master_apex  where 1=1 and (c012_loc_id is not null or c019_paa_bil='||chr(39)||'J'||chr(39)||') ';

              v_sok_col                 varchar2 (4000)    :=null;
              v_sok_col_old_loc         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||')||upper(c032_reg_no) '; 
              v_sok_col_new_loc         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c008_serie_no)||upper(c012_loc_id)||upper(c014_enhet_besk)||upper(c015_temp)||upper(to_char(c021_pris_inkl_mva))||upper(c040_nr)||upper(c041_motor)||upper(c042_gear)||upper(c045_v1_info)||upper(c046_v2_info_a)||upper(c047_v2_info_b)||upper(c048_v2_info_c)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||') '; 
              v_sok_col_old_all         varchar2 (4000)    := ' and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c010_old_serie_no)||upper(c012_loc_id)||upper(c014_enhet_besk)||to_char(c017_dato_inn,'||chr(39)||'yyyy-mm-dd'||chr(39)||')||upper(c032_reg_no) '; 
              --v_sok_col_del             varchar2 (4000);   --lages lengre nede     ' and c007_serie_seq_no <> '||v_serie_seq_no||' and c004_vare_gruppe_seq_no='||v_vare_gruppe_seq_no||' and c029_fab_seq_no='||v_fab_seq_no||' and c030_type_seq_no='||v_type_seq_no||' and c031_var_bil_scope_seq_no='||v_var_bil_scope_seq_no||' '; 

              v_sok_where               varchar2 (4000)    :=null;  
              v_sok_where_first         varchar2 (4000)    :=null;  
              v_sok_where_del           varchar2 (4000)    :=null;  
              v_sok_where_vognkort_1    varchar2 (4000)    :=null;    

              --STATIC2:del, bil;del_bil,dato_inn, del, bil;dato_del_bil
              v_sok_order               varchar2 (4000)    := null;
              v_sok_order_del_bil       varchar2 (4000)    := ' order by c005_vare_gruppe_id,c044_v0_info';
              v_sok_order_dato_del_bil  varchar2 (4000)    := ' order by c017_dato_inn,c005_vare_gruppe_id,c044_v0_info';

              v_sql                     varchar2 (4000)    :=null;  
              v_sql_first               varchar2 (4000)    :=null;  
              v_sql_del                 varchar2 (4000)    :=null;  

            begin
              error_txt :=': Process> After Submit> Søke master..  '||
                                                 '<p> søkestreng   '||v_sok ||
                                                 '<p> prosseserings resultat f'||chr(248) ||'lger:';

              -----------------------------------------start spezial------------------------------------------   
                  --:P205_FEED_BACK        :=null;
                    :P205_FEED_BACK_1      :=null;
            	    --:P205_ERROR_MASTER     :=null;  
            	      :P205_VOGNKORT_INFO    :=null;
            	      :P205_ERROR_VOGNKORT   :=null;
                    :P205_ARRAY            :=null;
                    :P205_SOK_TYPE         :=null;
                  --:P205_REG_NO           :=null;    --is not null kriterie for å starte create_coll add-on vognkort (kalles flere ganger)
                    :P205_REG_NO_INTERNT   :=null;
                    :P205_REG_NO_EKSTERNT  :=null;
                    :P205_SQL              :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_FIRST        :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_DEL          :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)

                    if :P205_SOK    is not null then v_sok        :=upper(:P205_SOK);         end if;  --ref tom streng gir feil
                    if :P205_REG_NO is not null then v_reg_no_sok :=upper(trim(:P205_REG_NO));end if;  --ref tom streng gir feil
                    v_sok := replace(v_sok,upper(trim(v_reg_no_sok)),'');                              --rusker vekk reg no det gir ingentreff internt

                    if :P205_REG_NO is not null then
                      --internt/ekstern
                      -----------------
                      begin
                        select  reg_no
                        into    v_reg_no_sok_internt
                        from enhet
                        where 1=1
                        and upper(trim(reg_no))= upper(trim(:P205_REG_NO));              
                        :P205_REG_NO_INTERNT  := upper(trim(:P205_REG_NO));
                        :P205_VOGNKORT_INFO   :='Registrerings-nr oppgitt i søket, FINNES internt';             

                      exception when others then  
                        --Her havner vi dersom selecten over ikke finner noe reg.nr
                        v_reg_no_sok_eksternt:=upper(trim(:P205_REG_NO));
                        :P205_REG_NO_EKSTERNT:=upper(trim(:P205_REG_NO));
                        :P205_VOGNKORT_INFO  :='Registrerings-nr oppgitt i søket, KUN eksternt';
                        :P205_FEED_BACK      :='NB. NB. Vognkort registeret er brukt for å finne deler til '||:P205_REG_NO||' Merke/ modell/år '||
                                                upper(:P205_MERKE_NAVN)||'/ '||upper(:P205_MODELLBETEGNELSE)||'/ '||upper(:P205_REG_AAR_MOD_AAR);
                        --:P205_ERROR_MASTER                    :='INNER_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;    
                        --litt tung sql for å finne scopet
                          select max(c031_var_bil_scope_seq_no) 
                          into   v_var_bil_scope_seq_no
                          from v_bildeler_apex
                          where 1=1
                          and upper(c044_v0_info) like '%'||upper(:P205_MERKE_NAVN)                        ||'%'
                          and upper(c044_v0_info) like '%'||upper(replace(:P205_MODELLBETEGNELSE,' ','%')) ||'%'
                          and upper(c044_v0_info) like '%'||upper(:P205_REG_AAR_MOD_AAR)                   ||'%';
                          :P205_FEED_BACK :=:P205_FEED_BACK||' scope '||v_var_bil_scope_seq_no;              

                        v_sok_where_vognkort_1 := ' and upper(c044_v0_info) like '||chr(39)||'%'||upper(:P205_MERKE_NAVN)                        ||'%'||chr(39)||
                                                  --' and upper(c044_v0_info) like '||chr(39)||'%'||upper(replace(:P205_MODELLBETEGNELSE,' ','%')) ||'%'||chr(39)||
                                                  --' and upper(c044_v0_info) like '||chr(39)||'%'||upper(:P205_REG_AAR_MOD_AAR)                   ||'%'||chr(39);
                                                  ' and c031_var_bil_scope_seq_no ='||v_var_bil_scope_seq_no;

                        v_sok_where       := v_sok_where_vognkort_1;
                        v_sok_where_first := ' and 1=2 ';
                        v_sok_where_del   := ' and 1=2 ';

                      end;
                    else
                      --reg.no på del/vrak indirekte
                      ------------------------------
                      begin
                    	  select c032 , count(*)
                    	  into v_reg_no_sok_internt,v_dummy
                    	  from apex_collections
                        where 1=1
                        and c032 is not null
                        and collection_name = 'P205_PLUKK_COLL'
                        group by c032;

                    	  :P205_REG_NO_INTERNT:=  upper(trim(v_reg_no_sok_internt));
                    	  :P205_REG_NO        := :P205_REG_NO_INTERNT;
                    	  :P205_VOGNKORT_INFO :='Registrerings-nr funnet på delene (Hvis flere deler med ulike reg nr vises ikke vognkort info)';
                      exception when others then
                          v_dummy := 'Her havner vi dersom det er flere reg_nr i selecten over det betyr at vi ikke henter noen av vognkortene';          
                          --:P205_ERROR_MASTER                    :='INNER_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;       
                      end;      
                    end if;       


              -----------------------------------------slutt spezial------------------------------------------   

                if :P205_REG_NO_EKSTERNT is  null then
                    v_dummy :='tomt reg. no.';

                else    


                      --STATIC2:    på lager;  old_loc,
                      --    lager(alle felt);  new_loc,
                      --                 alt;  old_all,
                      --            plukking;  plukk
                    case
                    when :P205_SOK_MET = 'old_loc'     then
                      v_sok_select := v_sok_select_old_loc;
                      v_sok_col    :=    v_sok_col_old_loc;
                    when :P205_SOK_MET = 'new_loc'     then
                      v_sok_select := v_sok_select_new_loc;
                      v_sok_col    :=    v_sok_col_new_loc;
                    when :P205_SOK_MET = 'old_all'     then
                      v_sok_select := v_sok_select_old_all;
                      v_sok_col    :=    v_sok_col_old_all;
                    else
                      v_sok_select := v_sok_select_old_loc;
                      v_sok_col    :=    v_sok_col_old_loc;
                    end case;

                    --STATIC2:del, bil;del_bil,dato_inn, del, bil;dato_del_bil
                    case
                    when :P205_SORT = 'del_bil'          then
                      v_sok_order  := v_sok_order_del_bil;
                    when :P205_SORT = 'dato_del_bil'     then
                      v_sok_order  := v_sok_order_dato_del_bil;
                    else
                      v_sok_order  := v_sok_order_del_bil;
                    end case;


              --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                --NO.1
              ----------
                --Vognkort deler (eksternt reg_no)
                ----------------------------------
                  --1.a trekker ut evnt streng i anførselstegn (finner kun første) NB INGEN LOGIKK HVIS REG.NR
                  --------------------------------------------------------------------------------------------
                    v_rest := v_sok;
                    :P205_ARRAY   := 'orginal soke streng=['||v_sok||']';
                    v_split :=null;
                    i:=0;
                    for x in ( select                      regexp_substr (v_rest, '"(.*?)\"', 1,  rownum) split
                               from dual                                                                                                                  
                               connect by level <= length (regexp_substr (v_rest, '"(.*?)\"', 1,  rownum)      
                                                          ) + 1                                                                                           
                    ) loop
                      v_split:=x.split;
                      v_rest      := replace(v_rest,v_split,''); --rusker vekk allerede behandlet søke kritere        
                      :P205_ARRAY := :P205_ARRAY||' rest soke streng'||to_char(i+1)||' gir ('||v_split||')';
                      v_split     := replace(upper(v_split),'"','');
                      v_sok_where := v_sok_where|| v_sok_col || 'like '||chr(39)||'%'||v_split||'%'||chr(39)||' ';
                      if i =0 and v_split is NOT null then
                        v_sok_where_first := v_sok_where; 
                        v_first_word := v_split; 
                        :P205_ARRAY   := :P205_ARRAY||' forste ord='||v_first_word;
                      end if;           
                      i := i+1; 
                    end loop; 


                  --1.b splitter opp alt som er delt med mellomrom i v_rest (hvor evnt streng i anførseltegn er rusket vekk)  PLUSS  ser etter reg-nr
                  -----------------------------------------------------------------------------------------------------------------------------------
                    :P205_ARRAY   := :P205_ARRAY||' vanlig uttrekk gir ';
                    v_split :=null;
                    i:=0;
                    for x in ( select                      regexp_substr ( REGEXP_REPLACE(v_rest,'( ){2,}' , ' '        ) 
                                                                                                   ,'[^ ]+'   , 1  , rownum) split  
                               from dual
                               connect by level <= length (regexp_replace (REGEXP_REPLACE(v_rest,'( ){2,}' , ' '        ) 
                                                                                                   ,'[^ ]+')
                                                          ) + 1
                    ) loop
                      v_split:=x.split;
                      :P205_ARRAY   := :P205_ARRAY||' ('||v_split||')';               
                      v_split     := upper(v_split);
                      v_sok_where := v_sok_where|| v_sok_col || 'like '||chr(39)||'%'||v_split||'%'||chr(39)||' ';           
                      if i =0 and v_sok_where_first is null then
                        v_sok_where_first := v_sok_where; 
                        v_first_word := v_split;    
                        :P205_ARRAY   := :P205_ARRAY||' forste ord='||v_first_word;                            
                      end if;                               
                      i:=i+1;    
                      --regnr add-on 1
                      ----------------          --------------------------
                        --UTGÅR  kun eksterne deler      
                    end loop;                                                  



                --NO.2 TILSVARENDE deler fra vrak.nr. eller dele.nr. (kun ett søke ord)
              ---------------------------------------
                --UTGÅR  kun eksterne deler      

                  v_sql             := v_sok_select    ||v_sok_where        ||v_sok_order;
                  v_sql_first       := v_sok_select    ||v_sok_where_first  ||v_sok_order;
                  v_sql_del         := v_sok_select_del||v_sok_where_del    ||v_sok_order;

                  :P205_SQL         := v_sql;
                  :P205_SQL_FIRST   := v_sql_first;
                  :P205_SQL_DEL     := v_sql_del;
                end if;  --:P205_sok behandling ferdig


              exception when error_exc then           
                :P205_ERROR_VOGNKORT                     :='create sql add-on vognkort ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                --apex_application.g_print_success_message :='<span style="color:red"> Process... </span>'||error_txt;
                apex_application.g_print_success_message :='create sql add-on vognkort ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
              when others then   
                :P205_ERROR_VOGNKORT                     :='create sql add-on vognkort OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         
                apex_application.g_print_success_message :='create sql add-on vognkort OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         
            end;

        --25 create_coll_kopi
            --Condition
                Value of Item / Column in Expression 1 != Expression 2
                    Expression 1    P208_DISPLAY
                    Expression 2    plukk

            declare
              error_txt                 varchar2(500);
              error_exc                 exception;
              v_row_limit               number(8)          :=50; 
              v_row                     number(8)          :=0;
              v_row_go_1                number(8)          :=0;
              v_row_go_2                number(8)          :=0;

              v_reg_no_sok_internt      varchar2(10);        --Reg nr i søkestreng,  finnes      internt registrert gitt at det ikke er flere forskjellige i collectionen
              v_dummy                   varchar2(1024);

              v_sql                     varchar2 (4000)    :=null;  
              v_sql_first               varchar2 (4000)    :=null;  
              v_sql_del                 varchar2 (4000)    :=null;  
              v_spacer                  varchar2 (255);

              --http://www.dbforums.com/oracle/1000258-how-create-dynamic-cursor-like.html
              v_collection_name   varchar2 (30)      := 'P205_PLUKK_COLL';
              rc SYS_REFCURSOR;
              c1_rec ola.mv_v_bildeler_apex%rowtype; 

            begin
              error_txt :=': Process> After Submit> Søke master..  '||
                                                 '<p> søkestreng   '||:P205_SOK ||
                                                 '<p> prosseserings resultat f'||chr(248) ||'lger:';


              if :P205_SQL is not null or :P205_SQL_FIRST is not null or :P205_SQL_DEL is not null then
                    v_sql             := :P205_SQL; 
                    v_sql_first       := :P205_SQL_FIRST; 
                    v_sql_del         := :P205_SQL_DEL; 
                    :P205_SQL         :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_FIRST   :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)
                    :P205_SQL_DEL     :=null;    --is not null kriterie for å starte create_coll  (kalles flere ganger)

                    if :P205_REG_NO_EKSTERNT is not null then v_spacer := '<img src="#APP_IMAGES#vegdir_32_32.png"       border="0">'; end if;

                    --brukes bare nå vi evnt modder på collectionen
                    --apex_collection.delete_collection   (p_collection_name      => v_collection_name);
                    apex_collection.create_or_truncate_collection (p_collection_name      => v_collection_name);

                    :P205_COUNT        :='...';

                    if :P205_ANT_LINJER is not null and :P205_ANT_LINJER<1000 then 
                      v_row_limit := :P205_ANT_LINJER; 
                    else
                      v_row_limit      := 50;
                      :P205_ANT_LINJER := 50;
                    end if;  


                --NO.1 Første forsøk
                OPEN rc FOR v_sql;
                loop
                  fetch rc into c1_rec;
                  exit when rc%notfound;
                  --legger ut
                  if v_row<v_row_limit then 
                    begin       
                      apex_collection.add_member (
                        p_collection_name => v_collection_name,
                        p_c001            => v_spacer,             --brukes for å få sørge for at CSS id og Collection attr_nr er like 
                                                                   --seq_id hentes nemelig fra Collection i Report viewet
                        p_c002            => c1_rec.c002_enhet_seq_no,         
                        p_c003            => c1_rec.c003_prev_enhet_seq_no,
                        p_c004            => c1_rec.c004_vare_gruppe_seq_no,
                        p_c005            => c1_rec.c005_vare_gruppe_id,
                        p_c006            => c1_rec.c006_prev_vare_gruppe_id,
                        p_c007            => c1_rec.c007_serie_seq_no,
                        p_c008            => c1_rec.c008_serie_no,
                        p_c009            => c1_rec.c009_prev_serie_no,
                        p_c010            => c1_rec.c010_old_serie_no,
                        p_c011            => c1_rec.c011_location_seq_no,
                        p_c012            => c1_rec.c012_loc_id,
                        p_c013            => c1_rec.c013_kval_id,
                        p_c014            => c1_rec.c014_enhet_besk,
                        p_c015            => c1_rec.c015_temp,
                        p_c016            => c1_rec.c016_temp_dato,
                        p_c017            => c1_rec.c017_dato_inn,
                        p_c018            => c1_rec.c018_dato_ut,
                        p_c019            => c1_rec.c019_paa_bil,
                        p_c020            => c1_rec.c020_hold_on,
                        p_c021            => c1_rec.c021_pris_inkl_mva,
                        p_c022            => c1_rec.c022_miljo_klarert_id,
                        p_c023            => c1_rec.c023_pris_solgt_inkl_mva,
                        p_c024            => c1_rec.c024_salg_via,
                        p_c025            => c1_rec.c025_salg_funnet,
                        p_c026            => c1_rec.c026_org_pris_inkl_mva,
                        p_c027            => c1_rec.c027_org_dato_inn,
                        p_c028            => c1_rec.c028_takst_seq_no,
                        p_c029            => c1_rec.c029_fab_seq_no,
                        p_c030            => c1_rec.c030_type_seq_no,
                        p_c031            => c1_rec.c031_var_bil_scope_seq_no,
                        p_c032            => c1_rec.c032_reg_no,
                        p_c033            => c1_rec.c033,
                        p_c034            => c1_rec.c034,
                        p_c035            => c1_rec.c035,
                        p_c036            => c1_rec.c036,     
                        p_c037            => c1_rec.c037,
                        p_c038            => c1_rec.c038,
                        p_c039            => c1_rec.c039,
                        p_c040            => c1_rec.c040_nr,
                        p_c041            => c1_rec.c041_motor,
                        p_c042            => c1_rec.c042_gear,
                        p_c043            => c1_rec.c043_v0_var_bil_seq_no,
                        p_c044            => c1_rec.c044_v0_info,
                        p_c045            => c1_rec.c045_v1_info,
                        p_c046            => c1_rec.c046_v2_info_a,
                        p_c047            => c1_rec.c047_v2_info_b,
                        p_c048            => c1_rec.c048_v2_info_c,
                        p_c049            => c1_rec.c049,
                        p_c050            => c1_rec.c050
                      );
                    end;
                    v_row := v_row+1;
                  end if;  --legge ut       
                end loop;
                v_row_go_1 := rc%rowcount;
                close rc;


                --NO.2 Tilsvareende deler
                if :P205_SOK_TYPE = 'TILSVARENDE' then
                  v_spacer := '<img src="#APP_IMAGES#tilsvarende_32_34.png"  border="0">';
                  OPEN rc FOR v_sql_del;
                  loop
                    fetch rc into c1_rec;
                    exit when rc%notfound;
                    --legger ut
                    if v_row<v_row_limit then 
                      begin       
                        apex_collection.add_member (
                          p_collection_name => v_collection_name,
                          p_c001            => v_spacer,             --brukes for å få sørge for at CSS id og Collection attr_nr er like 
                                                                     --seq_id hentes nemelig fra Collection i Report viewet
                          p_c002            => c1_rec.c002_enhet_seq_no,         
                          p_c003            => c1_rec.c003_prev_enhet_seq_no,
                          p_c004            => c1_rec.c004_vare_gruppe_seq_no,
                          p_c005            => c1_rec.c005_vare_gruppe_id,
                          p_c006            => c1_rec.c006_prev_vare_gruppe_id,
                          p_c007            => c1_rec.c007_serie_seq_no,
                          p_c008            => c1_rec.c008_serie_no,
                          p_c009            => c1_rec.c009_prev_serie_no,
                          p_c010            => c1_rec.c010_old_serie_no,
                          p_c011            => c1_rec.c011_location_seq_no,
                          p_c012            => c1_rec.c012_loc_id,
                          p_c013            => c1_rec.c013_kval_id,
                          p_c014            => c1_rec.c014_enhet_besk,
                          p_c015            => c1_rec.c015_temp,
                          p_c016            => c1_rec.c016_temp_dato,
                          p_c017            => c1_rec.c017_dato_inn,
                          p_c018            => c1_rec.c018_dato_ut,
                          p_c019            => c1_rec.c019_paa_bil,
                          p_c020            => c1_rec.c020_hold_on,
                          p_c021            => c1_rec.c021_pris_inkl_mva,
                          p_c022            => c1_rec.c022_miljo_klarert_id,
                          p_c023            => c1_rec.c023_pris_solgt_inkl_mva,
                          p_c024            => c1_rec.c024_salg_via,
                          p_c025            => c1_rec.c025_salg_funnet,
                          p_c026            => c1_rec.c026_org_pris_inkl_mva,
                          p_c027            => c1_rec.c027_org_dato_inn,
                          p_c028            => c1_rec.c028_takst_seq_no,
                          p_c029            => c1_rec.c029_fab_seq_no,
                          p_c030            => c1_rec.c030_type_seq_no,
                          p_c031            => c1_rec.c031_var_bil_scope_seq_no,
                          p_c032            => c1_rec.c032_reg_no,
                          p_c033            => c1_rec.c033,
                          p_c034            => c1_rec.c034,
                          p_c035            => c1_rec.c035,
                          p_c036            => c1_rec.c036,     
                          p_c037            => c1_rec.c037,
                          p_c038            => c1_rec.c038,
                          p_c039            => c1_rec.c039,
                          p_c040            => c1_rec.c040_nr,
                          p_c041            => c1_rec.c041_motor,
                          p_c042            => c1_rec.c042_gear,
                          p_c043            => c1_rec.c043_v0_var_bil_seq_no,
                          p_c044            => c1_rec.c044_v0_info,
                          p_c045            => c1_rec.c045_v1_info,
                          p_c046            => c1_rec.c046_v2_info_a,
                          p_c047            => c1_rec.c047_v2_info_b,
                          p_c048            => c1_rec.c048_v2_info_c,
                          p_c049            => c1_rec.c049,
                          p_c050            => c1_rec.c050
                        );
                      end;

                      v_row := v_row+1;       
                    end if;  --legge ut       
                  end loop;
                  v_row_go_2 := rc%rowcount;
                  if v_row_go_2 >0 then
                    :P205_FEED_BACK := :P205_FEED_BACK ||'Wow  det var flere deler/vrak innen for samme delegruppe, bil-scope';      
                  end if;
                  close rc;     
                end if;  --Fail Safe no.2

                :P205_COUNT :=v_row||' av '||to_number(v_row_go_1 + v_row_go_2);

              end if;  --:P205_SQLxx behandling ferdig


              exception when error_exc then           
                --apex_application.g_print_success_message :='<span style="color:red"> Process... </span>'||error_txt;
                :P205_ERROR_MASTER                       :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                apex_application.g_print_success_message :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
              when others then   
                :P205_ERROR_MASTER                       :='create_coll ERROR_EXC: '  ||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;
                apex_application.g_print_success_message :='create_coll OUTHERS_EXC: '||error_txt||' <p>'||sqlcode||'&nbsp;&nbsp;'||sqlerrm;                                         

            end;        

    --Dynamic Actions
        --15 oppdatere priser_apex5
            When    Event           Changed
                    Selection Type  jQuery selector
                    jQuery selector input[name="f01"],input[name="f02"],input[name="f03"]

            True Acions
                #   Action      On P-load   Selection Type  Affeded elemts          Set Type    Code
                10  Set Value   No          Items           P205_ID                 js          this.triggeringElement.id
                20  Set Value   No          Items           P205_VALUE              js          this.triggeringElement.value
                30  Set Value   Yes         Items           P205_SEQ_NO             js          $('#'+'f01_'+$('#P205_ID').val().substring(4)).val();
                40  Set Value   No          Items           P205_ENHET_SEQ_NO2      js          $('#'+'f02_'+$('#P205_ID').val().substring(4)).val();
                50  Set Value   No          Items           P205_PRIS               js          $('#'+'f03_'+$('#P205_ID').val().substring(4)).val();
                60  Execute sql No                          
                70  Refresh     No          Region                                  region      &nbsp;

                60 sql
                    Page Items to Submit:   P205_ID,P205_VALUE,P205_SEQ_ID,P205_ENHET_SEQ_NO2,P205_PRIS
                    Code
                        DECLARE
                          v_collection_name   VARCHAR2 (30) := 'P205_PLUKK_COLL';
                          v_member            NUMBER;
                          v_to_do             VARCHAR2 (3);
                          v_enhet_seq_no      NUMBER; 
                          --JS ekvivalent
                          j_aksjon             varchar2(255);             
                          j_del_seq_no_old     number;
                          j_enhet_seq_no       number;
                          j_vare_gruppe_seq_no number;

                        BEGIN
                          --COLLECTION: Oppdaterer endret verdi fra skjerm i aktuelle felt
                          ----------------------------------------------------------------
                          v_member := TO_NUMBER (SUBSTR (:p205_id, 2, 2));           --P205_ID=f03_0006--> tallet 3 (her er altså P205_SEQ_ID 6)

                         --2016_03_22 UT migrering APEX 5 
                         --apex_collection.update_member_attribute
                         --                                    (p_collection_name      => v_collection_name,
                         --                                     p_seq                  => :p205_seq_id,
                         --                                     p_attr_number          => v_member,
                         --                                     p_attr_value           => :p205_value
                         --                                   );	



                          --SQL alternativ til JS (bruker data i Collection istedefor skjerm(vi skal jo ikke se disse tallene på skjermen allikevel))
                          ---------------------------------------------------------------------------------------------------------------------------
                        --2016_03_22 UT migrering APEX 5  
                        --select to_number(c002) into j_enhet_seq_no       from apex_collections where collection_name = v_collection_name and seq_id =:p205_seq_id;
                        -- v_enhet_seq_no :=j_enhet_seq_no;
                        --update enhet set pris_inkl_mva= to_number(:P205_PRIS), org_pris_inkl_mva=null where enhet_seq_no = v_enhet_seq_no;

                        --2016_03_22 NY... migrering APEX 5 
                        --bruker P205_ENHET_SEQ_NO2 som er satte med JS tidlger i denne DA
                          update enhet set pris_inkl_mva= to_number(:P205_PRIS), org_pris_inkl_mva=null where enhet_seq_no = :P205_ENHET_SEQ_NO2;


                          v_to_do:='UPD';
                        END;


----------------------------------------------------------- v_enhet3 -------------------------------------------------------------------------------------------------    
    "TODO"
        motor med rare tegn
            4G69 2,4l 165hk
            AVQ 1,9l 101hk
            MD25NA 2,5l 78hk
            Z18XE 1,8l 125hk

            select motor, count(*) from bildeler.v_varelager_master@obas6 where lokasjon is not null and varenavn like 'MOTOR%' group by motor order by 2 desc

            select gir, count(*) from bildeler.v_varelager_master@obas6 where lokasjon is not null and varenavn like 'GEAR%' group by gir order by 2 desc

    create or replace view v_enhet3 as
        --create table  t as
        --create or replace view ttt as
        with 
            vare_full      as ( --alternativ til v_vare_gruppe
				--x-sjekk 
				-- select vare_gruppe_seq_no from ola.enhet minus
                -- select vare_gruppe_seq_no from ola.vare_gruppe_fase2 where nvl(dummy,'x')<>'Y'
                -- 676 2020-11-28
                -- select count(*) from (
                    select
                         v_3.vare_gruppe_seq_no                                                  vare_gruppe_seq_no
                        ,v_3.vare_gruppe_id                                                      vare_gruppe_id
                        ,cast(f_vasket('DEL_VASKET',v_3.vare_gruppe_id) as varchar2(50))      as vasket_del
                        ,nvl2(v_1.vare_gruppe_id,v_1.vare_gruppe_id||'> ',null)||
                         nvl2(v_2.vare_gruppe_id,v_2.vare_gruppe_id||'> ',null)||
                                                 v_3.vare_gruppe_id                              vare_gruppe
                        ,v_1.vare_gruppe_id                                                      vare_gruppe_nivaa_1
                        ,v_2.vare_gruppe_id                                                      vare_gruppe_nivaa_2
                        ,v_3.vare_gruppe_id                                                      vare_gruppe_nivaa_3
                    from     
                                --2020-03-22 lagt inn fase 2 som test #472 før                     
                                vare_gruppe_fase2     v_3,  --Nivå 3                    
                                vare_gruppe_fase2     v_2,  --Nivå 2                      
                                vare_gruppe_fase2     v_1   --Nivå 1
                    where 1=1
                    and v_3.prev_vare_gruppe_seq_no  = v_2.vare_gruppe_seq_no   (+)
                    and v_2.prev_vare_gruppe_seq_no  = v_1.vare_gruppe_seq_no   (+) 
                )
            ,serie_full     as ( -- alternativ til v_serie_no
                    select 
                         serie_seq_no                                          serie_seq_no
                        ,decode(serie_anv_seq_no,0,null,1,'V','D')|| serie_no  serie_no
                    from serie where serie_seq_no <> -99999999
                    union select -99999999, null from dual
                ) 
            ,loc_full       as ( 
                    select 
                         location_seq_no  
                        ,loc_id
                        ,loc_besk
                        ,export_yn
                    from location where location_seq_no <> -99999999
                    union select -99999999, null, null, null from dual
                ) 
            ,bil_full       as (
                    --8434 2020-07-04 
                    --select count(*) from (
                    --select var_bil_seq_no from v_var_bil group by var_bil_seq_no having count(*)>1
                    select 
                         var_bil_seq_no 
                        ,fab_seq_no
                        ,type_seq_no
                        ,var_bil_scope_seq_no
                        ,vasket_merke
                        ,vasket_modell
                        ,vasket_scope
                        ,sbrnr sbrnr_bil 
                        ,lbknr lbknr_bil
                        ,fab_navn 
                        ,type_id  
                        ,aar      
                        ,aar_4    
                        ,scope                             
                    from v_var_bil where var_bil_seq_no <> -99999999
                    union select -99999999, null, null, null,null, null, null, null,null, null, null,null,null,null from dual
                ) 
            ,kjore_full     as ( 
                    select 
                         var_kjore_grp_seq_no  
                        ,k_grp_id
                        ,k_grp_besk
                    from var_kjore_grp where var_kjore_grp_seq_no <> -99999999
                    union select -99999999, null, null from dual
                ) 
            ,dorer_full     as ( 
                    select 
                         var_dorer_seq_no  
                        ,dorer_id
                    from var_dorer where var_dorer_seq_no <> -99999999
                    union select -99999999, null from dual
                ) 
            ,m_vol_full     as ( 
                    select 
                         var_motor_volum_seq_no  
                        ,motor_vol_id
                    from var_motor_volum where var_motor_volum_seq_no <> -99999999
                    union select -99999999, null from dual
                ) 
            ,m_type_full    as ( 
                    select 
                         var_motor_type_seq_no  
                        ,motor_type_id
                        ,motor_type_besk
                    from var_motor_type where var_motor_type_seq_no <> -99999999
                    union select -99999999, null, null from dual
                ) 
            ,kval_full      as ( 
                    select 
                         enhet_kval_seq_no  
                        ,kval_id
                        ,kval_besk
                    from enhet_kvalitet where enhet_kval_seq_no <> -99999999
                    union select -99999999, null, null from dual
                ) 
            ,vendor_full    as ( 
                    select   vendor_data.vendor_data_seq_no                                         vendor_data_seq_no           
                            ,vendor.vendor                                                          vendor              
                            ,vendor_data.vendor_data_no                                             vendor_no           
                            ,vendor_data.pris_inkl_mva                                              vendor_pris_inkl_mva
                    from     vendor
                            ,vendor_data
                    where vendor.vendor_seq_no = vendor_data.vendor_seq_no and vendor_data.vendor_data_seq_no <> -99999999
                    union select -99999999, null, null, null from dual
                )
            ,bilder_full    as (select enhet_seq_no, count(blobs_seq_no) bilder_ant from enhet_blobs group by enhet_seq_no )
            ,enhet_full     as (
                --select count(*) from enhet
                select 
                    --primært
                         enhet.enhet_seq_no                                                                                     enhet_seq_no
                        ,enhet.prev_enhet_seq_no                                                                                prev_enhet_seq_no
                        ,enhet.vare_gruppe_seq_no                                                                               vare_gruppe_seq_no
                        ,vare_full.vare_gruppe_id                                                                               vare_gruppe_id
                        ,vare_full.vare_gruppe                                                                                  vare_gruppe
                        ,vare_full.vasket_del                                                                                   vasket_del
                        ,vare_full.vare_gruppe_nivaa_1                                                                          vare_gruppe_nivaa_1
                        ,vare_full.vare_gruppe_nivaa_2                                                                          vare_gruppe_nivaa_2
                        ,vare_full.vare_gruppe_nivaa_3                                                                          vare_gruppe_nivaa_3
                        ---------
                        ,decode(serie_full.serie_seq_no     , -99999999 ,null,serie_full.serie_seq_no   )                       serie_seq_no
                        ,decode(serie_full.serie_seq_no     , -99999999 ,null,serie_full.serie_no       )                       serie_no
                        ,decode(serie_full_old.serie_seq_no , -99999999 ,null,serie_full_old.serie_seq_no   )                   serie_old_seq_no
                        ,decode(serie_full_old.serie_seq_no , -99999999 ,null,serie_full_old.serie_no       )                   serie_old_no
                        ----------
                        ,decode(  loc_full.location_seq_no  , -99999999 ,null,  loc_full.location_seq_no)                       location_seq_no
                        ,decode(  loc_full.location_seq_no  , -99999999 ,null,  loc_full.loc_id         )                       loc_id
                        -- SJEKK er var_bil kun brukt på deler som ikke har parent
                        --       select count(*) from v_enhet3 where var_bil_seq_no is not null and p_enhet_seq_no is not null
                        --       0
                        ,decode    (  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.var_bil_seq_no         )   var_bil_seq_no
                        ,decode    (  bil_full.fab_seq_no               , -99999999 ,null,  bil_full.fab_seq_no             )   fab_seq_no
                        ,decode    (  bil_full.type_seq_no              , -99999999 ,null,  bil_full.type_seq_no            )   type_seq_no
                        ,decode    (  bil_full.var_bil_scope_seq_no     , -99999999 ,null,  bil_full.var_bil_scope_seq_no   )   var_bil_scope_seq_no
                        ,decode    (  bil_full.sbrnr_bil                , -99999999 ,null,  bil_full.sbrnr_bil              )   sbrnr_bil
                        ,decode    (  bil_full.lbknr_bil                , -99999999 ,null,  bil_full.lbknr_bil              )   lbknr_bil
                        ,stamp_chassis_no
                        ,stamp_miljo_klarert_id
                    --prosess  
                        ,f_prosess( 'id', enhet.vare_gruppe_seq_no, enhet.serie_seq_no, enhet.location_seq_no, enhet.paa_bil)  as prosess
                    --BIL fab-type, fage, dører ...///////////////////////////////////////////////////////////////////////////////////
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.fab_navn               )   fab_navn
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.type_id                )   type_id
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.aar                    )   aar
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.aar_4                  )   aar_4
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.scope                  )   scope
                            --
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.vasket_merke           )   vasket_merke
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.vasket_modell          )   vasket_modell
                            ,decode(  bil_full.var_bil_seq_no           , -99999999 ,null,  bil_full.vasket_scope           )   vasket_scope
                            ------------------------------------------------------------------------------------------                                 
                            ,betegnelse                                                                                         betegnelse                                                     
                            ,decode( kjore_full.var_kjore_grp_seq_no    , -99999999 ,null,  enhet.var_kjore_grp_seq_no      )   var_kjore_grp_seq_no
                            ,decode( kjore_full.var_kjore_grp_seq_no    , -99999999 ,null,  kjore_full.k_grp_id             )   k_grp_id
                            ,decode( dorer_full.var_dorer_seq_no        , -99999999 ,null,  dorer_full.dorer_id             )   dorer_id
                            ------------------------------------------------------------------------------------------       
                            ,reg_no                                                                                             reg_no                      
                            ,chassis_no                                                                                         chassis_no                  
                            ,chassis_no_vegdir                                                                                  chassis_no_vegdir           
                            ,regexp_replace(tecdoc_id, '[^0-9A-Za-z]','')                                                       tecdoc_id                   
                            ,tecdoc_besk                                                                                        tecdoc_besk                 
                            ,km                                                                                                 km                          
                            ,farge_kode                                                                                         farge_kode                  
                            ,servo                                                                                              servo                                                 
                            ,miljo_klarert_id                                                                                   miljo_klarert_id                                     
                            ,miljo_klarert_oppe_id                                                                              miljo_klarert_oppe_id                                     
                            ------------------------------------------------------------------------------------------   
                            ,decode( m_vol_full.var_motor_volum_seq_no  , -99999999 ,null,  m_vol_full.motor_vol_id          )  motor_vol_id
                            ,decode( m_type_full.var_motor_type_seq_no  , -99999999 ,null,  m_type_full.var_motor_type_seq_no)  var_motor_type_seq_no
                            ,decode( m_type_full.var_motor_type_seq_no  , -99999999 ,null,  m_type_full.motor_type_id        )  motor_type_id
                            ,decode( m_type_full.var_motor_type_seq_no  , -99999999 ,null,  m_type_full.motor_type_besk      )  motor_type_besk
                            ,enhet.motor_kode                                                                              motor_kode
                            ,enhet.motor_test                                                                              motor_test
                            ,enhet.hk                                                                                      motor_hk
                            ------------------------------------------------------------------------------------------   
                            ,gear_type                                                                                          gear_type
                            ,enhet.gear_kode                                                                               gear_kode
                            ,enhet.gear_test                                                                               gear_test
                            ------------------------------------------------------------------------------------------   
                            --resten av kolonner fra enhet_sub
                                ,enhet.abs_yn
                                ,enhet.sentral_laas_yn
                                ,enhet.skinn_yn
                                ,enhet.tilhengerfeste_yn
                                ,enhet.metallic_yn
                                ,enhet.cruise_cont_yn
                                ,enhet.kjore_comp_yn
                                ,enhet.setevarmere_yn
                                ,enhet.xenon_yn
                                ,enhet.org_audio_yn
                                ,enhet.brukt_imp_yn
                                ,enhet.el_speil_yn
                                ,enhet.el_speil_ant
                                ,enhet.aircon
                                ,enhet.soltak
                                ,enhet.lys
                                ,enhet.farge_int
                                ,enhet.hk
                                ,enhet.in_date
                                ,enhet.el_heis_yn
                                ,enhet.drift
                                ,enhet.airbag_ant
                                ,enhet.airbag_def
                                ,enhet.esp
                                ,enhet.batteri_kwh 
                    --DEL .../////////////////////////////////////////////////////////////////////////////////////////////////////////
                            ,enhet.paa_bil                                                                                      paa_bil
                            ,enhet.hold_on                                                                                      hold_on
                            ,enhet_besk                                                                                         enhet_besk
                            ,temp                                                                                               temp      
                            ,decode( kval_full.enhet_kval_seq_no        , -99999999 ,null,  kval_full.kval_id               )   kval_id
                            ,dato_inn                                                                                           dato_inn
                            ,dato_ut                                                                                            dato_ut                             
                            ,pris_inkl_mva                                                                                      pris_inkl_mva      
                            ,pris_solgt_inkl_mva                                                                                pris_solgt_inkl_mva
                            ,bilder_ant                                                                                         bilder_ant
                            ------------------------------------------------------------------------------------------------------------------------   
                            ,decode( vendor_full.vendor_data_seq_no  , -99999999 ,null,  vendor_full.vendor                 )   vendor
                            ,decode( vendor_full.vendor_data_seq_no  , -99999999 ,null,  vendor_full.vendor_no              )   vendor_no
                            ,decode( vendor_full.vendor_data_seq_no  , -99999999 ,null,  vendor_full.vendor_pris_inkl_mva   )   vendor_pris_inkl_mva
                    --PART
                            --,upper(replace(replace(prod_nr_old,chr(10)),chr(13),' '))                                           prod_nr_old     --Nr på del  / OEM nr hhv gamle / nye bildelerprogh 
                            --,upper(replace(replace(prod_nr,chr(10)),chr(13),' '))       as part_oem_visual
                        --                                                                                      først                 etter          tall char  .;             bare ,     dobble ,, fjerne   fjerne evnt flere ,, på slutten
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(prod_nr               ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_prod_nr
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_main         ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_part_oem_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_part_oem_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_main         ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_part_eqv_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_part_eqv_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_brand            ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]'      ,''),';',',')),',,',',')          ,','),',')                      as raw_part_brand
                        ----------
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(prod_nr               ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as prod_nr
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_main         ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as part_oem_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as part_oem_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_main         ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as part_eqv_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as part_eqv_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_brand            ,chr(13)||chr(10),','),chr(10),','), '[^;.,-_/\0-9A-Za-z ]',''),';',',')),',,',',')          ,','),',')                      as part_brand
                    --dekk
                        ,f_dekk_felg( enhet.vare_gruppe_seq_no)     as dekk_felg        --returnerer med store bokstaver
                        ,actor.actor_seq_no
                        ,actor.actor_id_dekk                
                        ,dekk_type.dekk_type_seq_no
                        ,dekk_type.dekk_bredde              
                        ,dekk_type.dekk_hoyde               
                        ,dekk_type.dekk_dim                 
                        ,enhet.dekk_monster_dybde_1
                        ,enhet.dekk_monster_dybde_2
                        ,enhet.dekk_produsert_aar_1
                        ,enhet.dekk_produsert_aar_2
                        ,enhet.dekk_load_index_1
                        ,enhet.dekk_load_index_2
                        ,enhet.dekk_antall
                    --felg
                        ,felg_type.felg_type_seq_no
                        ,felg_type.felg_bolt_sirkel              
                        ,felg_type.felg_innpress                 
                        ,felg_type.felg_navhull             
                from     enhet 
                        ,vare_full          vare_full 
                        ,serie_full         serie_full
                        ,serie_full         serie_full_old
                        ,loc_full           loc_full
                    --BIL
                        ,bil_full           bil_full            
                        ,kjore_full         kjore_full
                        ,dorer_full         dorer_full
                        ,m_vol_full         m_vol_full
                        ,m_type_full        m_type_full
                    --DEL
                        ,kval_full          kval_full
                        ,vendor_full        vendor_full
                        ,bilder_full        bilder_full
                    --ACTOR, DEKK, FELH
                        ,actor
                        ,dekk_type
                        ,felg_type
                where 1=1
                    and   enhet.vare_gruppe_seq_no      = vare_full.vare_gruppe_seq_no      (+)
                    and   enhet.serie_seq_no            = serie_full.serie_seq_no           (+)     --nvl -999999 funker IKKE
                    and   enhet.old_serie_seq_no        = serie_full_old.serie_seq_no       (+)     --nvl -999999 funker IKKE
                    and   enhet.location_seq_no         = loc_full.location_seq_no          (+)                
                    and   enhet.var_bil_seq_no          = bil_full.var_bil_seq_no           (+)               
                    and   enhet.var_kjore_grp_seq_no    = kjore_full.var_kjore_grp_seq_no   (+)        
                    and   enhet.var_dorer_seq_no        = dorer_full.var_dorer_seq_no       (+)        
                    and   enhet.var_motor_volum_seq_no  = m_vol_full.var_motor_volum_seq_no (+)            
                    and   enhet.var_motor_type_seq_no   = m_type_full.var_motor_type_seq_no (+)            
                    and   enhet.enhet_kval_seq_no       = kval_full.enhet_kval_seq_no       (+)        
                    and   enhet.vendor_data_seq_no      = vendor_full.vendor_data_seq_no    (+)            
                    and   enhet.enhet_seq_no            = bilder_full.enhet_seq_no          (+)
                    and   enhet.actor_seq_no            = actor.actor_seq_no                (+)
                    and   enhet.dekk_type_seq_no        = dekk_type.dekk_type_seq_no        (+)           
                    and   enhet.felg_type_seq_no        = felg_type.felg_type_seq_no        (+)
                )           
            ,full           as ( 
                select 
                    --primært
                         sysdate                    stamp
                        ,c.enhet_seq_no             enhet_seq_no                ,p.enhet_seq_no             p_enhet_seq_no          
                        ,c.prev_enhet_seq_no        prev_enhet_seq_no           ,p.prev_enhet_seq_no        p_prev_enhet_seq_no       
                        ,c.vare_gruppe_seq_no       vare_gruppe_seq_no          ,p.vare_gruppe_seq_no       p_vare_gruppe_seq_no    
                        ,c.vare_gruppe_id           vare_gruppe_id              ,p.vare_gruppe_id           p_vare_gruppe_id        
                        ,c.vare_gruppe              vare_gruppe                 ,p.vare_gruppe              p_vare_gruppe    
                        ,c.vasket_del               vasket_del 
                        ,c.vare_gruppe_nivaa_1      vare_gruppe_nivaa_1         ,c.vare_gruppe_nivaa_2      vare_gruppe_nivaa_2     ,c.vare_gruppe_nivaa_3      vare_gruppe_nivaa_3
                        ---
                        ,c.serie_seq_no             serie_seq_no                ,p.serie_seq_no             p_serie_seq_no          
                        ,c.serie_no                 serie_no                    ,p.serie_no                 p_serie_no    
                        ----                                                                                            
                        ,c.serie_old_seq_no         serie_old_seq_no            ,p.serie_old_seq_no         p_serie_old_seq_no          
                        ,c.serie_old_no             serie_old_no                ,p.serie_old_no             p_serie_old_no                                                                                                
                        ----
                        ,c.location_seq_no          location_seq_no             ,p.location_seq_no          p_location_seq_no       
                        ,c.loc_id                   loc_id                      ,p.loc_id                   p_loc_id     
                        ,c.var_bil_seq_no           c_var_bil_seq_no            ,p.var_bil_seq_no           p_var_bil_seq_no 
                        ,nvl(c.var_bil_seq_no                                   ,p.var_bil_seq_no)         as var_bil_seq_no  
                        ,nvl(c.fab_seq_no                                       ,p.fab_seq_no)             as fab_seq_no  
                        ,nvl(c.type_seq_no                                      ,p.type_seq_no)            as type_seq_no  
                        ,nvl(c.var_bil_scope_seq_no                             ,p.var_bil_scope_seq_no)   as var_bil_scope_seq_no
                        ,nvl(c.sbrnr_bil                                        ,p.sbrnr_bil)              as sbrnr_bil
                        ,nvl(c.lbknr_bil                                        ,p.lbknr_bil)              as lbknr_bil
                    --stamp
                        ,        c.stamp_chassis_no                        as stamp_ch
                        ,to_char(c.stamp_chassis_no         ,'yyyy-mm-dd') as stamp_ch_yyyy_mm_dd
                        ,to_char(c.stamp_chassis_no         ,'yyyy-ww'   ) as stamp_ch_yyyy_ww
                        ,to_char(c.stamp_chassis_no         ,'yyyy-mm'   ) as stamp_ch_yyyy_mm
                        ,to_char(c.stamp_chassis_no         ,'yyyy'      ) as stamp_ch_yyyy
                        ,        c.stamp_miljo_klarert_id                  as stamp_mj
                        ,to_char(c.stamp_miljo_klarert_id   ,'yyyy-mm-dd') as stamp_mj_yyyy_mm_dd
                        ,to_char(c.stamp_miljo_klarert_id   ,'yyyy-ww'   ) as stamp_mj_yyyy_ww
                        ,to_char(c.stamp_miljo_klarert_id   ,'yyyy-mm'   ) as stamp_mj_yyyy_mm
                        ,to_char(c.stamp_miljo_klarert_id   ,'yyyy'      ) as stamp_mj_yyyy
                    --prosess                   
                        --,s.prosess            2020-07-21 f_prosess brukes
                        ,c.prosess
                        -- ,s.prosess_desc      2020-07-21 f_prosess brukes
                        ,f_prosess( c.prosess, null, null, null, null)  as prosess_desc
                    --BIL fab-type, fage, dører ...///////////////////////////////////////////////////////////////////////////////////
                            ,nvl(c.fab_navn             ,                p.fab_navn             )       fab_navn
                            ,nvl(c.type_id              ,                p.type_id              )       type_id
                            ,nvl(c.aar                  ,                p.aar                  )       aar
                            ,nvl(c.aar_4                ,                p.aar_4                )       aar_4
                            ,nvl(c.scope                ,                p.scope                )       scope
                            ,nvl(c.vasket_merke         ,                p.vasket_merke         )       vasket_merke
                            ,nvl(c.vasket_modell        ,                p.vasket_modell        )       vasket_modell
                            ,nvl(c.vasket_scope         ,                p.vasket_scope         )       vasket_scope
                            ------------------------------------------------------------------------------------------                                                         
                            ,nvl(c.betegnelse           ,                p.betegnelse           )       betegnelse
                            ,nvl(c.var_kjore_grp_seq_no ,                p.var_kjore_grp_seq_no )       var_kjore_grp_seq_no
                            ,nvl(c.k_grp_id             ,                p.k_grp_id             )       k_grp_id
                            ,nvl(c.dorer_id             ,                p.dorer_id             )       dorer_id
                            ------------------------------------------------------------------------------------------                                                         
                            ,nvl(c.reg_no               ,                p.reg_no               )       reg_no               
                            ,nvl(c.chassis_no           ,                p.chassis_no           )       chassis_no           
                            ,nvl(c.chassis_no_vegdir    ,                p.chassis_no_vegdir    )       chassis_no_vegdir    
                            ,nvl(c.tecdoc_id            ,                p.tecdoc_id            )       tecdoc_id            
                            ,nvl(c.tecdoc_besk          ,                p.tecdoc_besk          )       tecdoc_besk          
                            ,nvl(c.km                   ,                p.km                   )       km                   
                            ,nvl(c.farge_kode           ,                p.farge_kode           )       farge_kode           
                            ,nvl(c.servo                ,                p.servo                )       servo                
                            ,nvl(c.miljo_klarert_id     ,                p.miljo_klarert_id     )       miljo_klarert_id   
                            ,nvl(c.miljo_klarert_oppe_id,                p.miljo_klarert_oppe_id)       miljo_klarert_oppe_id   
                            ------------------------------------------------------------------------------------------                                                         
                            ,nvl(c.motor_vol_id         ,                p.motor_vol_id         )       motor_vol_id   
                            ,nvl(c.var_motor_type_seq_no,                p.var_motor_type_seq_no)       var_motor_type_seq_no
                            ,nvl(c.motor_type_id        ,                p.motor_type_id        )       motor_type_id   
                            ,nvl(c.motor_type_besk      ,                p.motor_type_besk      )       motor_type_besk   
                            ,nvl(c.motor_kode           ,                p.motor_kode           )       motor_kode
                            ,nvl(c.motor_test           ,                p.motor_test           )       motor_test
                            ,nvl(c.motor_hk             ,                p.motor_hk             )       motor_hk
                            ------------------------------------------------------------------------------------------                                                         
                            ,nvl(c.gear_type            ,                p.gear_type            )        gear_type   
                            ,nvl(c.gear_kode            ,                p.gear_kode            )        gear_kode
                            ,nvl(c.gear_test            ,                p.gear_test            )        gear_test
                            ------------------------------------------------------------------------------------------                                                         
                            --resten av kolonner fra enhet_sub
                                ,nvl(c.abs_yn               ,           p.abs_yn                )       abs_yn               
                                ,nvl(c.sentral_laas_yn      ,           p.sentral_laas_yn       )       sentral_laas_yn      
                                ,nvl(c.skinn_yn             ,           p.skinn_yn              )       skinn_yn             
                                ,nvl(c.tilhengerfeste_yn    ,           p.tilhengerfeste_yn     )       tilhengerfeste_yn    
                                ,nvl(c.metallic_yn          ,           p.metallic_yn           )       metallic_yn          
                                ,nvl(c.cruise_cont_yn       ,           p.cruise_cont_yn        )       cruise_cont_yn           
                                ,nvl(c.kjore_comp_yn        ,           p.kjore_comp_yn         )       kjore_comp_yn            
                                ,nvl(c.setevarmere_yn       ,           p.setevarmere_yn        )       setevarmere_yn               
                                ,nvl(c.xenon_yn             ,           p.xenon_yn              )       xenon_yn                             
                                ,nvl(c.org_audio_yn         ,           p.org_audio_yn          )       org_audio_yn                 
                                ,nvl(c.brukt_imp_yn         ,           p.brukt_imp_yn          )       brukt_imp_yn                 
                                ,nvl(c.el_speil_yn          ,           p.el_speil_yn           )       el_speil_yn                      
                                ,nvl(c.el_speil_ant         ,           p.el_speil_ant          )       el_speil_ant             
                                ,nvl(c.aircon               ,           p.aircon                )       aircon               
                                ,nvl(c.soltak               ,           p.soltak                )       soltak                       
                                ,nvl(c.lys                  ,           p.lys                   )       lys                      
                                ,nvl(c.farge_int            ,           p.farge_int             )       farge_int                
                              --,nvl(c.motor_kode           ,           p.motor_kode            )       motor_kode                   
                              --,nvl(c.gear_kode            ,           p.gear_kode             )       gear_kode                    
                                ,nvl(c.hk                   ,           p.hk                    )       hk                           
                                ,nvl(c.in_date              ,           p.in_date               )       in_date                  
                              --,nvl(c.motor_test           ,           p.motor_test            )       motor_test                   
                              --,nvl(c.gear_test            ,           p.gear_test             )       gear_test                
                                ,nvl(c.el_heis_yn           ,           p.el_heis_yn            )       el_heis_yn               
                                ,nvl(c.drift                ,           p.drift                 )       drift                
                                ,nvl(c.airbag_ant           ,           p.airbag_ant            )       airbag_ant               
                                ,nvl(c.airbag_def           ,           p.airbag_def            )       airbag_def               
                                ,nvl(c.esp                  ,           p.esp                   )       esp                      
                                ,nvl(c.batteri_kwh          ,           p.batteri_kwh           )       batteri_kwh                             
                    --DEL ...//////////////////////////////////////////////////////////////////////////////////////////////////////////
                            ,c.paa_bil                                                                      paa_bil
                            ,c.hold_on                                                                      hold_on
                            ,c.enhet_besk                                                                   enhet_besk
                            ,c.temp                                                                         temp      
                            ,c.kval_id                                                                      kval_id
                            ,c.dato_inn                                                                     dato_inn
                            ,c.dato_ut                                                                      dato_ut 
                            ,c.pris_inkl_mva                                                                pris_inkl_mva      
                            ,c.pris_solgt_inkl_mva                                                          pris_solgt_inkl_mva     
                            ,c.bilder_ant                                                                   bilder_ant
                            ------------------------------------------------------------------------------------------   
                            ,C.vendor                                                                       vendor                                                                       
                            ,C.vendor_no                                                                    vendor_no                                                                    
                            ,C.vendor_pris_inkl_mva                                                         vendor_pris_inkl_mva   
                    --PART
                            ,c.prod_nr  
                            ,c.part_oem_main 
                            ,c.part_oem_secondary 
                            ,c.part_eqv_main 
                            ,c.part_eqv_secondary
                            ,c.part_brand
                            ----
                            ,c.raw_prod_nr  
                            ,c.raw_part_oem_main 
                            ,c.raw_part_oem_secondary 
                            ,c.raw_part_eqv_main 
                            ,c.raw_part_eqv_secondary
                            ,c.raw_part_brand
                    --dekk
                        ,c.dekk_felg
                        ,c.actor_seq_no
                        ,c.actor_id_dekk                
                        ,c.dekk_type_seq_no
                        ,c.dekk_bredde              
                        ,c.dekk_hoyde               
                        ,c.dekk_dim                 
                        ,c.dekk_monster_dybde_1
                        ,c.dekk_monster_dybde_2
                        ,c.dekk_produsert_aar_1
                        ,c.dekk_produsert_aar_2
                        ,c.dekk_load_index_1
                        ,c.dekk_load_index_2
                        ,c.dekk_antall
                    --felg
                        ,c.felg_type_seq_no
                        ,c.felg_bolt_sirkel              
                        ,c.felg_innpress                 
                        ,c.felg_navhull             
                from 
                     enhet_full             c   --child
                    ,enhet_full             p   --parent
                    --,prosess_decode         s   --status
                    --,v_prosess_enhet        s   --status  2020-07-21 f_prosess brukes
                where 1=1
                    and c.prev_enhet_seq_no     = p.enhet_seq_no          (+)
                    and                           p.prev_enhet_seq_no     (+) is null
                    --and c.enhet_seq_no          = s.enhet_seq_no          (+) 2020-07-21 f_prosess brukes
                    --and substr(c.prosess,1,2)   = s.prosess               (+)
                )
        select
                --ordinære
                     stamp
			        ,cast ( null as number(8)    ) site_seq_no
			        ,cast ( null as number(8)    ) enhet_hist_seq_no
			        ,cast ( null as date         ) date_in  
			        ,cast ( null as date         ) date_upd 
			        ,cast ( null as date         ) date_hist 
			        ,cast ( null as date         ) date_del 
			        ,cast ( null as varchar2(25) ) deleted
			        ,cast ( null as varchar2(25) ) bildeler_user 
                    ,  enhet_seq_no
                    ,p_enhet_seq_no
                    ,  prev_enhet_seq_no
                    ,p_prev_enhet_seq_no
                --vare_gruppe                    
                    ,  vare_gruppe_seq_no
                    ,p_vare_gruppe_seq_no
                    ,  vare_gruppe_id
                    ,  vare_gruppe_id                   as varenavn             --visning
                    ,p_vare_gruppe_id
                      ,vare_gruppe
                    ,  vare_gruppe                      as varegruppe_komplett  --visning vare_gruppe_nivaa_1-2-3
                    ,p_vare_gruppe
                    ,  vare_gruppe_nivaa_1
                    ,  vare_gruppe_nivaa_1              as varegruppe           --visning
                    ,  vare_gruppe_nivaa_2
                    ,  vare_gruppe_nivaa_2              as varegruppe_detaljer  --visninig
                    ,  vare_gruppe_nivaa_3
                --serie_no
                    ,  serie_seq_no
                    ,p_serie_seq_no
                    ,  serie_old_seq_no
                    ,p_serie_old_seq_no
                    ,serie_no
                    ,serie_no                           as dele_nr              --visning
                    ,serie_old_no
                    ,serie_old_no                       as dele_old_nr          --visning
                --lov
                    ,  location_seq_no
                    ,p_location_seq_no
                    ,  loc_id
                    ,  loc_id                           as lokasjon             --visning
                    ,p_loc_id
                --bil
                    ,  var_bil_seq_no
                    ,c_var_bil_seq_no
                    ,p_var_bil_seq_no
                    ,fab_seq_no  
                    ,type_seq_no  
                    ,var_bil_scope_seq_no
                    ,sbrnr_bil
                    ,lbknr_bil
                --html
                    ,vasket_del
                    ,vasket_merke
                    ,vasket_modell
                    ,vasket_scope
                -- stamp
                    ,stamp_ch
                    ,stamp_ch_yyyy_mm_dd
                    ,stamp_ch_yyyy_ww
                    ,stamp_ch_yyyy_mm
                    ,stamp_ch_yyyy
                    ,stamp_mj
                    ,stamp_mj_yyyy_mm_dd
                    ,stamp_mj_yyyy_ww
                    ,stamp_mj_yyyy_mm
                    ,stamp_mj_yyyy
                --prosess
                    ,prosess
                    ,prosess_desc
                    ,prosess_desc                       as prosess_detaljer     --visning
                --PART----------------------------------------------------------------------------------
                  ,ltrim(rtrim(replace(replace(replace(replace(replace(replace( 
                                -- raw_prod_nr||','||raw_part_oem_main||','||raw_part_oem_secondary||','||raw_part_eqv_main||','||raw_part_eqv_secondary||','||raw_part_brand
                                raw_prod_nr||','||raw_part_oem_main||','||raw_part_oem_secondary||','||raw_part_eqv_main||','||raw_part_eqv_secondary
                  ,',,,,,,,',',')
                  ,',,,,,,' ,',')
                  ,',,,,,'  ,',')
                  ,',,,,'   ,',')
                  ,',,,'    ,',')
                  ,',,'     ,',')
                  ,',')
                  ,',')                                                   as part_nr_raw
                  --
                  ,ltrim(rtrim(replace(replace(replace(replace(replace(replace( 
                                    --                                                              || komma hvis vi har flere ...
                                    --replace( replace(trim(part_oem_main)     ,' ')      ,';',',')   || case when replace( replace(trim(part_oem_main)     ,' ') ,';',',') is not null then      decode(part_oem_secondary||prod_nr||part_eqv_main||part_eqv_secondary||part_brand  ,null,null,',')    end ||
                                    --replace( replace(trim(part_oem_secondary),' ')      ,';',',')   || case when replace( replace(trim(part_oem_secondary),' ') ,';',',') is not null then      decode(                    prod_nr||part_eqv_main||part_eqv_secondary||part_brand  ,null,null,',')    end ||
                                    --replace( replace(trim(prod_nr)           ,' ')      ,';',',')   || case when replace( replace(trim(prod_nr)           ,' ') ,';',',') is not null then      decode(                             part_eqv_main||part_eqv_secondary||part_brand  ,null,null,',')    end ||
                                    --replace( replace(trim(part_eqv_main)     ,' ')      ,';',',')   || case when replace( replace(trim(part_eqv_main)     ,' ') ,';',',') is not null then      decode(                                            part_eqv_secondary||part_brand  ,null,null,',')    end ||
                                    --replace( replace(trim(part_eqv_secondary),' ')      ,';',',')   || case when replace( replace(trim(part_eqv_secondary),' ') ,';',',') is not null then      decode(                                                                part_brand  ,null,null,',')    end ||
                                    --replace( replace(trim(part_brand)        ,' ')      ,';',',')
                                -- prod_nr||','||part_oem_main||','||part_oem_secondary||','||part_eqv_main||','||part_eqv_secondary||','||part_brand
                                prod_nr||','||part_oem_main||','||part_oem_secondary||','||part_eqv_main||','||part_eqv_secondary
                  ,',,,,,,,',',')
                  ,',,,,,,' ,',')
                  ,',,,,,'  ,',')
                  ,',,,,'   ,',')
                  ,',,,'    ,',')
                  ,',,'     ,',')
                  ,',')
                  ,',')                                                   as part_nr
                    ,part_oem_main                                                              as original_nr              --enhet.part_oem_main
                    ,part_oem_secondary                                                         as original_nr_2            --enhet.part_oem_secondary
                    ,part_eqv_main                                                              as meca_nr                  --enhet.part_eqv_main
                    ,part_eqv_secondary                                                         as nbk_nr                   --enhet.part_eqv_secondary
                    ,part_brand                                                                 as produsent                --enhet.part_brand  
                            ,prod_nr     
                            ,part_oem_main 
                            ,part_oem_secondary 
                            ,part_eqv_main 
                            ,part_eqv_secondary
                            ,part_brand
                --BIL-----------------------------------------------------------------------------------
                  --vraknr
                    ,p_serie_no
                    ,p_serie_no                                                                                                                             as vrak_nr              --vis_no
                  --bil
                    ,cast( upper(fab_navn          ||' '|| type_id ||' '||betegnelse||tecdoc_besk||' '||scope                        )  as varchar(255))    as bil_obas
                    ,cast( upper(t_tecdoc.gen_type ||' '                                              ||t_tecdoc.gen_constr_interval )  as varchar(255))    as bil_tecdoc
                    ,case when  t_tecdoc.gen_type is not null and t_tecdoc.gen_constr_interval is not null then
                     cast( upper(t_tecdoc.gen_type ||' '                                              ||t_tecdoc.gen_constr_interval )  as varchar(255))
                           else
                     cast( upper(fab_navn          ||' '|| type_id ||' '||betegnelse||tecdoc_besk||' '||scope                        )  as varchar(255))
                     end                                                                                                                                    as bil                  --vis_no
                  --merke
                    ,cast( upper(                                    fab_navn                                          )                as varchar(255))    as bil_merke_obas
                    ,cast( upper(    t_tecdoc.merke                                                                    )                as varchar(255))    as bil_merke_tecdoc
                    ,cast( upper(nvl(t_tecdoc.merke                 ,fab_navn                                        ) )                as varchar(255))    as bil_merke
                  --modell  
                    ,cast( upper(                                    type_id                                           )                as varchar(255))    as bil_modell_obas
                    ,cast( upper(    t_tecdoc.modell                                                                   )                as varchar(255))    as bil_modell_tecdoc
                    ,cast( upper(nvl(t_tecdoc.modell                ,type_id                                         ) )                as varchar(255))    as bil_modell
                  --modell_int
                    ,cast( upper(                                    type_id ||' '||scope                              )                as varchar(255))    as bil_modell_int_obas
                    ,cast( upper(    t_tecdoc.modell                         ||' '||t_tecdoc.gen_constr_interval       )                as varchar(255))    as bil_modell_int_tecdoc
                    ,case when  t_tecdoc.modell is not null and t_tecdoc.gen_constr_interval  is not null then
                     cast( upper(    t_tecdoc.modell                         ||' '||t_tecdoc.gen_constr_interval       )                as varchar(255))
                           else
                     cast( upper(                                    type_id ||' '||scope                              )                as varchar(255))
                     end                                                                                                                                    as bil_modell_int
                  --type
                    ,cast( upper(                                    betegnelse                                        )                as varchar(255))    as bil_type_obas
                    ,cast( upper(    t_tecdoc.type                                                                     )                as varchar(255))    as bil_type_tecdoc
                    ,cast( upper(nvl(t_tecdoc.type                  ,betegnelse                                      ) )                as varchar(255))    as bil_type
                  --intervall                    
                    ,cast( upper(                                    scope                                             )                as varchar(255))    as bil_interval_obas
                    ,cast( upper(    t_tecdoc.gen_constr_interval                                                      )                as varchar(255))    as bil_interval_tecdoc
                    ,cast( upper(nvl(t_tecdoc.gen_constr_interval   ,scope                                           ) )                as varchar(255))    as bil_interval
                  --aar
                    ,aar_4                                                                                                                                  as bil_aar          
                  ---Obas only
                    ,fab_navn           
                    ,fab_navn                   as fabrikant
                    ,type_id 
                    ,type_id                    as modell
                    ,betegnelse         
                    ,aar                
                    ,aar_4              
                    ,drift                      as hjuldrift
                    ,km
                    ,motor_type_besk            as drivstoff
                    ,full.tecdoc_besk           as modell_type
                    ,var_kjore_grp_seq_no
                    ,k_grp_id
                    ,k_grp_id                   as karosseriform
                    ,dorer_id
                    ,dorer_id                   as antall_dorer
                    ,farge_kode
                    ,reg_no
                    ,reg_no                     as regnummer
                    ,chassis_no
                    ,chassis_no_vegdir
                    ,servo
                    ,miljo_klarert_id
                    ,miljo_klarert_id           as miljoklarert     --visning
                    ,miljo_klarert_oppe_id
                    ,miljo_klarert_oppe_id      as miljoklarert_oppe --visning
                --tecdoc
                    ,cast( null                           as varchar2(4000)) as tecdoc_ids       --pre prosseseres inn  med xxxx_F,yyyy_F osv
                    ,cast(full.tecdoc_id                  as varchar2(25))  as tecdoc_id
                    ,full.tecdoc_besk
                    ,cast( t_tecdoc.merke                 as varchar2(255)) as td_merke
                    ,cast( t_tecdoc.modell                as varchar2(255)) as td_modell
                    ,cast( t_tecdoc.type                  as varchar2(255)) as td_type                  
                    ,cast( t_tecdoc.gen_constr_interval   as varchar2(255)) as td_interval       
                    ---------------------------
                    ,cast( t_tecdoc.gen_type              as varchar2(255)) as td_gen_type                  
                    ,cast( t_tecdoc.gen_constr_interval   as varchar2(255)) as td_gen_constr_interval       
                    ,cast( t_tecdoc.gen_tecdoc_type_id    as varchar2(255)) as td_gen_tecdoc_type_id        
                    ,cast( t_tecdoc.body_body_type        as varchar2(255)) as td_body_body_type            
                    ,cast( t_tecdoc.body_drive_type       as varchar2(255)) as td_body_drive_type           
                    ,cast( t_tecdoc.power_kw              as varchar2(255)) as td_power_kw                  
                    ,cast( t_tecdoc.power_hp              as varchar2(255)) as td_power_hp                  
                    ,cast( t_tecdoc.power_cap_tax         as varchar2(255)) as td_power_cap_tax             
                    ,cast( t_tecdoc.power_cap_technical   as varchar2(255)) as td_power_cap_technical       
                    ,cast( t_tecdoc.power_cap_l           as varchar2(255)) as td_power_cap_l               
                    ,cast( t_tecdoc.power_nos_valves      as varchar2(255)) as td_power_nos_valves          
                    ,cast( t_tecdoc.power_nos_cylinders   as varchar2(255)) as td_power_nos_cylinders       
                    ,cast( t_tecdoc.power_engine_type     as varchar2(255)) as td_power_engine_type         
                    ,cast( t_tecdoc.power_fuel_type       as varchar2(255)) as td_power_fuel_type           
                    ,cast( t_tecdoc.power_fuel_mixture    as varchar2(255)) as td_power_fuel_mixture        
                    ,cast( t_tecdoc.engine_engine_code    as varchar2(255)) as td_engine_engine_code                
                --MOTOR---------------------------------------------------------------------------------
                    ,        nvl(motor_kode   ,t_tecdoc.engine_engine_code)||
                     --vol
                     decode( nvl(motor_vol_id ,t_tecdoc.power_cap_l),
                        null,null,
                        --rensker vekk space, l + trim
                        ' '||trim(replace(replace(nvl(motor_vol_id ,t_tecdoc.power_cap_l),'l'), ''))||'l')||
                     --hk
                     decode( nvl(motor_hk     ,t_tecdoc.power_hp),
                        null,null,
                        ' '||nvl(motor_hk     ,t_tecdoc.power_hp)||'hk')    as motor            --vis_no
                    --test
                        ,motor_test                                         as motor_test       --  ed
                    --type
                        ,var_motor_type_seq_no
                        ,motor_type_id                                      as motor_type       --  ed
                        ,motor_type_id          --I, D etc
                        ,motor_type_besk        --Injection Diesel etc.
                    --kode
                        ,motor_kode                                         as motor_kode       --  ed
                        ,t_tecdoc.engine_engine_code                        as motor_kode_td    
                    --vol
                        --,var_motor_vol_seq_no
                        ,motor_vol_id                                       as motor_vol        --  ed
                        ,motor_vol_id   --kun for bakover kompabilitet, som type
                        ,t_tecdoc.power_cap_l                               as motor_vol_td     --td
                    --hk
                        ,motor_hk                                           as motor_hk         --  ed
                        ,t_tecdoc.power_hp                                  as motor_hk_td      --td
                --GEAR-----------------------------------------------------------------------------------
                    ,gear_kode||' '||gear_type                              as gir              --vis_no
                    ,gear_test                                              as gear_test        --  ed
                    ,gear_type                                              as gear_type        --  ed
                    ,gear_kode                                              as gear_kode        --  ed
                --BIL
                    ,abs_yn            
                    ,sentral_laas_yn   
                    ,skinn_yn          
                    ,tilhengerfeste_yn 
                    ,metallic_yn       
                    ,cruise_cont_yn    
                    ,kjore_comp_yn     
                    ,setevarmere_yn    
                    ,xenon_yn          
                    ,org_audio_yn      
                    ,brukt_imp_yn      
                    ,el_speil_yn       
                    ,el_speil_ant      
                    ,aircon            
                    ,soltak            
                    ,lys               
                    ,farge_int         
                    ,in_date           
                    ,el_heis_yn        
                    ,drift             
                    ,airbag_ant        
                    ,airbag_def        
                    ,esp               
                    ,batteri_kwh       
                    ----
                    ,paa_bil
                    ,paa_bil                    as i_bil            --visning
                    ,hold_on
                    ,hold_on                    as hold             --visning
                    ,enhet_besk
                    ,enhet_besk                 as beskrivelse      --visning
                    ,temp
                    ,kval_id
                    ,dato_inn
                    ,dato_ut
                    ,pris_inkl_mva
                    ,pris_inkl_mva              as pris             --visnining
                    ,pris_solgt_inkl_mva
                    ,bilder_ant
                    ,vendor
                    ,vendor_no
                    ,vendor_pris_inkl_mva
                --dekk
                    ,dekk_felg
                    ,actor_seq_no
                    ,actor_id_dekk                
                    ,dekk_type_seq_no
                    ,dekk_bredde              
                    ,dekk_hoyde               
                    ,dekk_dim                 
                    ,dekk_monster_dybde_1
                    ,dekk_monster_dybde_2
                    ,dekk_produsert_aar_1
                    ,dekk_produsert_aar_2
                    ,dekk_load_index_1
                    ,dekk_load_index_2
                    ,dekk_antall
                --felg
                    ,felg_type_seq_no
                    ,felg_bolt_sirkel          
                    ,felg_innpress           
                    ,felg_navhull  
                --statistikk  
                    --statistikk på prosess
                        ,cast (null     as number(8))   as s_prosess_total              --brukes på hvert enkelt vrak og hver del
                    --statistikk på vrak
                        ,cast (null    as number(8))    as s_biler_totalt               --brukes på hvert enkelt vrak og hver del
                        ,cast (null    as number(8))    as s_biler_inne
                        ,cast (null    as number(8))    as s_biler_presset
                        ,cast (null    as number(8))    as s_biler_presset_i_aar
                        ,cast (null    as number(8))    as s_biler_presset_i_fjor
                        ,cast (null    as number(8))    as s_biler_presset_tidligere
                    --statistikk på deler
                        ,cast (null    as number(8))    as s_deler_totalt               --brukes på hvert enkelt vrak og hver del MEN telles pr varegruppe for deler, for biler tas alle varegrupper med
                        ,cast (null    as number(8))    as s_deler_inne
                        ,cast (null    as number(8))    as s_deler_solgt
                        ,cast (null    as number(8))    as s_deler_solgt_i_aar
                        ,cast (null    as number(8))    as s_deler_solgt_i_fjor
                        ,cast (null    as number(8))    as s_deler_solgt_tidligere
                    --statistikk kun på deler
                        ,cast (null    as number(8))    as pris_max_obas
                        ,cast (null    as number(8))    as pris_min_obas
                        ,cast (null    as number(8))    as pris_max_nbf
                        ,cast (null    as number(8))    as pris_min_nbf
                        ,cast (null    as number(8))    as pris_max_lbk
                        ,cast (null    as number(8))    as pris_min_lbk
        from full
             --,t_tecdoc@pdbtecdoc t_tecdoc
             ,t_tecdoc t_tecdoc
        where trim(full.tecdoc_id) = to_char(t_tecdoc.tecdoc_id(+))
        order by vare_gruppe_id, fab_navn, type_id, aar
    /

    --oem uttrekk
        --spec
            Her ser det ut for meg at dynamoer til minst 4 biltype har samme OEM nr lagt inn av Ulf….

            For meg er det da easy peasy å legge inn alle mulig Tecdoc nr som ligge på disse på alle altså

            Mitt uttrekk på bildeler.net i kveld med «03L903023ax  dyna»

            d.nr                       info                                       oem                      org tecdoc          aggregert tecdoc kun på DYNAMO
            D50994                Audi       A3                          03L903023AX    31319                    31319, 31340, 33674, 55526
            D25086                 VW         Golf                       03L903023AX     31340                    31319, 31340, 33674, 55526
            D57364                 VW         Tiguan                  03L903023AX     33674                    31319, 31340, 33674, 55526
            D65424                 VW         Touran                 03L903023AX     55526                    31319, 31340, 33674, 55526

            Dermed vil et regnr søk på PP87816 https://www.finn.no/car/used/ad.html?finnkode=189130723
            Gi 6 treff og ikke 1 som i dag

            Dette funker uten at dere vaser rundt med lure ting,  enklet å greit.  LEGG INN OEM OG IKKE TENK

            Nå jeg bygger opp de aggregrete tecdoc vil jeg også bruke solgte deler og dermed får vi enda større treff
            Dette gjøres pr varegruppefor alle deler hver natt enkelt og greit

        --validering  
            _   95
            LF  10
            CR  13

            select distinct 
                 part_nr                        -- sammen satt av alle under     
                --,prod_nr                        -- prod_nr                    
                --,original_nr                    -- part_oem_main              
                --,original_nr_2                  -- part_oem_secondary         
                --,meca_nr                        -- part_eqv_main              
                --,nbk_nr                         -- part_eqv_secondary         
                --,produsent                      -- part_brand 
                ----------------------                
                ,prod_nr                            --source_1
                ,part_oem_main                      --source_2
                ,part_oem_secondary                 --source_3
                ,part_eqv_main                      --source_4
                ,part_eqv_secondary                 --source_5
                ,part_brand                         --source_6
            from t_enhet3@obas6
            -- where enhet_seq_no in(347236,347234,347240,347131,347274,347232,347295,347157,347176)
            where enhet_seq_no in (328170)
            order by 1

            select enhet_seq_no 
                        ,prod_nr
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(prod_nr               ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as prod_nr
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_main         ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as part_oem_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_oem_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as part_oem_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_main         ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as part_eqv_main
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_eqv_secondary    ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as part_eqv_secondary
                        ,rtrim(rtrim(replace(upper(replace(REGEXP_REPLACE(replace(replace(part_brand            ,chr(13)||chr(10),','),chr(10),','), '[^0-9A-Za-z,;]',''),';',',')),',,',',')          ,','),',')                      as part_brand
            from enhet@obas6
            where enhet_seq_no = 333804 --71357
            order by 1

            select serie_no, enhet_seq_no ,prod_nr
                ,prod_nr                            --source_1
                ,part_oem_main                      --source_2
                ,part_oem_secondary                 --source_3
                ,part_eqv_main                      --source_4
                ,part_eqv_secondary                 --source_5
                ,part_brand                         --source_6
            from t_enhet3@obas6
            where prod_nr like '%SOL%'
            --where part_nr like '%'||chr(13)||chr(10)||'%'     9           <--ok sjekk
            --where part_nr like '%'||chr(10)||chr(13)||'%'     0
            --where part_nr like '%'||chr(10)||         '%'     maaange     <--ok sjekk
            --where part_nr like '%'||chr(13)||         '%'     de 9 over

            order by 1

            select distinct replace(replace(replace(replace(replace(part_nr,' '),','),';'),'_'),'-')
            ,length(replace(replace(replace(replace(replace(part_nr,' '),','),';'),'_'),'-'))
            from t_enhet3
            where replace(replace(replace(replace(replace(part_nr,' '),','),';'),'_'),'-') like '%_%'
            order by 1


            select enhet_seq_no, part_nr,REGEXP_COUNT (part_nr, ',')
            from t_enhet3@obas6
            where part_nr is not null
            order by 3 desc

            --tecdoc id
                select distinct trim(tecdoc_id) , regexp_replace(tecdoc_id, '[^0-9A-Za-z]','') from t_enhet3@obas6 order by 1
                    TRIM(TECDOC_ID)	REGEXP_REPLACE(TECDOC_ID,'[^0-9A-ZA-Z,;]','')
                    .	
                     14693	14693
                     16743	16743
                     17752	17752
                    BP10434	BP10434
                    MX	    MX
                    NFU	    NFU
                    O	    O
                    V_HUFF	VHUFF
                    V_HUFF_BILDE	VHUFFBILDE
                    0	0
                    00	00
                    000	000
                    0000	0000
                    00000	00000
                    02313	02313
                    1	1

                --fikse i enhet
                    alter table enhet disable all triggers;
                    update enhet set tecdoc_id = regexp_replace(tecdoc_id, '[^0-9A-Za-z,;]','')
                    where regexp_replace(tecdoc_id, '[^0-9A-Za-z,;]','') in ('14693', '16743', '17752');
                    alter table enhet enable all triggers;

                    alter table enhet disable all triggers;
                    update enhet set tecdoc_id = '2313'
                    where regexp_replace(tecdoc_id, '[^0-9A-Za-z,;]','') in ('02313');
                    alter table enhet enable all triggers;

                    alter table enhet disable all triggers;
                    update enhet set tecdoc_id= null 
                    where trim(tecdoc_id) in ('.');
                    alter table enhet enable all triggers;

            --vinter dekk
                select vare_gruppe_seq_no, enhet_seq_no ,prod_nr_old
                     ,prod_nr                            --source_1
                     ,part_oem_main                      --source_2
                     ,part_oem_secondary                 --source_3
                     ,part_eqv_main                      --source_4
                     ,part_eqv_secondary                 --source_5
                     ,part_brand                         --source_6
                             ,enhet.dekk_type_seq_no                                                         --  v_api_lov_dekk_type 
                             ,enhet.dekk_monster_dybde_1                                                     --  3-8
                             ,enhet.dekk_monster_dybde_2                                                     --  3-8
                             ,enhet.dekk_produsert_aar_1                                                     --  2014-2025
                             ,enhet.dekk_produsert_aar_2                                                     --  2014-2025   
                             ,enhet.dekk_load_index_1                                                        --  xxx         
                             ,enhet.dekk_load_index_2                                                        --  xxx                                
                             ,enhet.felg_type_seq_no                                                         --  v_api_felg_type 
                --from enhet@obas6 enhet
                from t_enhet3@obas6
                where vare_gruppe_seq_no in (40061,40062,40063,36590,36591,101019,101059,101060,100699,100700)
                order by 4,3

                create table enget_2020_08_30 as select * from enhet;
                update enhet set prod_nr_old=prod_nr||', '||prod_nr_old, prod_nr=null 
                where prod_nr is not null
                and vare_gruppe_seq_no in (40061,40062,40063,36590,36591,101019,101059,101060,100699,100700);
                --#272

            --hva med tecdoc
                    select enhet_seq_no, serie_no, location_seq_no, tecdoc_id, part_nr
                    from t_enhet3@obas6
                    where part_nr is not null
                    and tecdoc_id is null

                    select distinct vrak_nr,dato_inn
                    from t_enhet3@obas6
                    where part_nr is not null
                    and tecdoc_id is null
                    and vrak_nr is not null
                    order by vrak_nr

                    "sendt mail morten om å fikse 2020.08.30"


            --list agg
                select enhet_seq_no, listagg(part_nr,',') within group (order by part_nr) 	as part_nr
                from t_enhet3@obas6
                where part_nr is not null
                group by enhet_seq_no
                order by 1,2

        --gogo
            -->flyttet til pr_scheduler
    --synonyms se ora12c_setup_xx.sql

    --apex
        https://blogs.oracle.com/apex/web-source-modules-and-the-interactive-grid-part-1

    --count
            select sysdate, (select count(*) from enhet) enhet, (select count(*) from v_enhet2) enhet2, (select count(*) from v_enhet3) enhet3 from dual ;
            SYSDATE       ENHET      ENHET2     ENHET3  
            06.10.2018    140819     140819     140819
            03-MAY-20     158131     158131     158131
            10-NOV-20     163242     163242     163242
            28-NOV-20     163628     163628     163628

    --sjekk
                1) er var_bil kun brukt på deler som ikke har parent
                        select count(*)
                        from v_enhet3
                        where var_bil_seq_no is not null 
                        and   p_enhet_seq_no is not null

                select motor from t_enhet3 where rownum <3 and motor is not null;

    --scheduler
                select count(*) from enhet;
                select count(*) from t_enhet3;
                select count(*) from v_enhet3;
                --137367
                --140481    2018-10-02
                --150415    2019-09-04
                --151312    2019-10-02
                --153247    2019-12-02
                --155275    2020-02-03
                --156956    156956  156956  2020-03-22
                --158494    2020-05-13
                --159853    2020-07-04
                --161613    2020-09-20


				--hvis sletting t_enhet3 
					--create table t_enhet3 as select * from v_enhet3;
				    --grant all on t_enhet3 to public;    --viktig pga brukes i instead i bildeler.v_varelager
          select coun      delete from t_enhet3;
                --truncate table t_enhet3; 
                insert into t_enhet3 select * from v_enhet3;
                commit;

                select enhet_Seq_no from enhet minus
                select enhet_Seq_no from t_enhet3;
                


-T--------------------------------------------------------- t_enhet3 -------------------------------------------------------------------------------------------------    

    "se \\192.168.1.100\util\dbms\Scheduler\sch_xxx.sql"
    --ved endringer i v_enhet3
        --sqlplus ola/ola@192.168.1.5/pdbobas.bildeler.net
            "rebuild"
                --drop table t_enhet3;
                create table t_enhet3 as select * from v_enhet3 where rownum <2;
                --viktig pga brukes i instead i bildeler.v_varelager
                grant all on t_enhet3 to public;    
                alter table t_enhet3 add constraint t_enhet3_pk primary key (enhet_seq_no);
                create index t_enhet3_i2  on t_enhet3(enhet_seq_no, part_nr_raw);
                create index t_enhet3_i3  on t_enhet3(enhet_seq_no, part_nr);
                create index t_enhet3_i4  on t_enhet3(enhet_seq_no, tecdoc_id, prod_nr);
                create index t_enhet3_i5  on t_enhet3(vare_gruppe_seq_no, prosess,tecdoc_id);
                create index t_enhet3_i6  on t_enhet3(dele_nr,lokasjon,vrak_nr);
                create index t_enhet3_i7  on t_enhet3(varenavn,beskrivelse,pris,part_nr);
                create index t_enhet3_i8  on t_enhet3(bil,aar_4,km,motor,gir);
                create index t_enhet3_i9  on t_enhet3(vare_gruppe_seq_no,fab_seq_no,type_seq_no,var_bil_scope_seq_no);
                create index t_enhet3_i10 on t_enhet3(enhet_seq_no,bil,bil_interval);

            "daglig oppdatering"            
                --NBNB tar ikke å masserer oem nr , det ligger i execute dbms_scheduler.run_job('ola_oppdatere_ebay');
                --truncate table t_enhet3;
                insert into t_enhet3 select * from v_enhet3;
                commit;
                grant all on t_enhet3 to public; 
                select count(*) from t_enhet3;
                select count(*) from v_enhet3;
                select count(*) from enhet;
                    --137367    21.05.2018
                    --137382    22.05.2018 kll 09:14
                    --137860    08.06.2018
                    --137875    11.06.2018
                    --138855    08.08.2018
                    --139036    16.08.2018
                    --140481    02.10.2018
                    --140588    03.10.2018
                    --140588    03.10.2018
                    --140916    12.10.2018
                    --140921    14.10.2018
                    --137063    24.10.2018 får import fra Morten
                    --137101    24.10.2018
                    --137212    30.10.2018
                    --137313    31.10.2018
                    --141404    31.10.2018  tatt nvl(xxx, -9999999)  stemmer med enhet antall   
                    --141491
                    --141992    18.11.2018
                    --153247    02.12.2019
                    --153957    29.12.2019
                    --154049    05.01.2020 første kjøring obas6 Ora 19c
                    --158131    03.05.2020 motor_test
                    --158377    10.05.2020 flyttet all manipulering fra v_varelager -> v_enhet3 
                    --159628    23.06.2020
                    --159853    04.07.2020
                    --159753    04.07.2020  etter oprydding
                    --159968    21.07.2020
                    --159986    26.07.2020
                    --160095    05.08.2020
                    --160112    07.08.2020
                    --161231    29.08.2020
                    --161252    31.08.2020
                    --161311    07-09-2020
                    --161613    20-09-2020
                    --163242    10-11-2020
                    --163628    28-11-2020


        --scheduler
            oppdatering av t_enhet3,kpi og priser skjer i scheduleren se:   --\\192.168.1.100\util\dbms\Scheduler\sch_xx.sql
                                                                            "Scheduler startes   med: execute dbms_scheduler.run_job('ola_oppdatere_ebay');"
                                                                            "Prossedyren startes med: execute pr_obas_scheduler(1); "
                                                                
        --v_bildeler views

    --dill
        select vare_gruppe_id, loc_id, decode(nvl(deler_totalt,0),0,'tomt','>0'), count(*) 
        from t_enhet3 
        where deler_totalt is null
        group by vare_gruppe_id, loc_id,decode(nvl(deler_totalt,0),0,'tomt','>0') order by 1,2;

            VARE_GRUPPE_ID                                     LOC_ID               DECO   COUNT(*)
            -------------------------------------------------- -------------------- ---- ----------
            DEKK PIGG                                                               tomt          1
            HOLD                                                                    tomt         92
            RADIO UORIGINAL                                                         tomt         11
            VRAK                                               V_EKSTERN            tomt          9
            VRAK                                               V_INNE1              tomt          1
            VRAK                                               V_SELVPLUKK          tomt          4
            VRAK                                               V_UTE2               tomt         22
            VRAK                                               V_UTE2_INN           tomt          2
            VRAK                                                                    tomt       1877
            annet ph° ...                                                           tomt          2


    --status
                    select distinct
                         enhet_seq_no
                        ,bil
                        ,vare_gruppe_id
                        ,vrak_nr
                        ,loc_id
                        ,deler_totalt
                        ,deler_inne
                        ,deler_solgt
                        ,deler_solgt_i_aar
                        ,deler_solgt_i_fjor
                        ,deler_solgttidligere
                    from t_enhet3@obas6 
                    where 1=1
                    -- and vare_gruppe_seq_no =1
                    and location_seq_no is not null
                    
                     select 
                        deler_totalt-nvl(deler_inne,0)-nvl(deler_solgt,0) 
                        , enhet_seq_no
                        ,deler_totalt
                        ,deler_inne
                        ,deler_solgt
                    from t_enhet3@obas6 
                    where 1=1
                    and deler_totalt>0
                    order by 1 




    --t_vidar
                --drop table t_vidar;
                    create table t_vidar as 
                    select * 
                        from t_enhet3 
                        where 1=1
                        and vidar_orginal is not null
                        and   (   ( vare_gruppe_seq_no <> 1 and location_seq_no is not null )
                                    or prosess='D1'
                                );
                    alter table t_vidar add constraint t_vidar_pk1 primary key (enhet_seq_no);
                    create index t_vidar_i1 on t_vidar(vare_gruppe_seq_no, location_seq_no, prosess,vidar_orginal );
                    select count(*) from t_vidar;
                    --11259 2018-10-12 TML

                select replace(vidar_orginal,' ',',') from t_vidar where rownum <100

                select 'abcd1234-123334', regexp_substr('abcd1234-123334','^*\d\d\d\d-$') from dual;
                select 'abcd1234-123334', regexp_substr('abcd 1234-123334','^* \d\d\d\d-*$') from dual;
                select 'abcd1234-123334', regexp_substr('abcd 1234-123334','^* \s\d{4}-*$') from dual;

                REGEXP_LIKE(vidar_orginal,'^-([[:digit:]]{3}\) [[:digit:]]{3}-[[:digit:]]{4}$'))

            truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select * from v_enhet3 --where vare_gruppe_seq_no=1;
            commit;

            create table t (t_v varchar2(4000), t_c clob);
            alter table t modify (t_v varchar2(8000));
            insert into t values ('hei' ,'på deg');
            select * from t where t_v like '%ei%' or t_c like '%deg%'

----------------------------------------------------------- t_enhet3 p 706 -(prossesere av pr_blobs_out OBAS_to_BLOBS-------------------------------------------------------------------
    --info KPI
        select 
             prosess
            ,prosess_desc
            ,yyyy_mm_dd     as yyyy_mm_dd_p
            ,yyyy_ww        as yyyy_ww_p
            ,yyyy_mm        as yyyy_mm_p
            ,yyyy           as yyyy_p
            ,case when prosess = 'D1'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D2'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D3'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'D4'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V1'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V2'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V3'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V4'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V5'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'V6'               and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRC_PROSESS' ||':'||prosess||'"> '                                                          ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'X1 Chassis reg.'  and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_MM_DD'||':,'||to_char(sysdate,'yyyy-mm-dd')||'"> '  ||yyyy_mm_dd      ||'</a>'  
                  when prosess = 'X2 Miljoklaert'   and yyyy_mm_dd is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_MM_DD'||':,'||to_char(sysdate,'yyyy-mm-dd')||'"> '  ||yyyy_mm_dd      ||'</a>'  end as yyyy_mm_dd
            ,case when prosess = 'X1 Chassis reg.'  and yyyy_ww    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_WW'   ||':,'||to_char(sysdate,'yyyy-ww')   ||'"> '  ||yyyy_ww         ||'</a>'  
                  when prosess = 'X2 Miljoklaert'   and yyyy_ww    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_WW'   ||':,'||to_char(sysdate,'yyyy-ww')   ||'"> '  ||yyyy_ww         ||'</a>'  end as yyyy_ww
            ,case when prosess = 'X1 Chassis reg.'  and yyyy_mm    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY_MM'   ||':,'||to_char(sysdate,'yyyy-mm')   ||'"> '  ||yyyy_mm         ||'</a>'  
                  when prosess = 'X2 Miljoklaert'   and yyyy_mm    is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY_MM'   ||':,'||to_char(sysdate,'yyyy-mm')   ||'"> '  ||yyyy_mm         ||'</a>'  end as yyyy_mm
            ,case when prosess = 'X1 Chassis reg.'  and yyyy       is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_CH'||','||'IRC_STAMP_CH_YYYY'      ||':,'||to_char(sysdate,'yyyy'   )   ||'"> '  ||yyyy            ||'</a>'  
                  when prosess = 'X2 Miljoklaert'   and yyyy       is not null then '<a href="f?p='||:APP_ID||':706:'||:APP_SESSION||':IR_215318:'||:DEBUG||':RIR'||':IRNN_STAMP_MJ'||','||'IRC_STAMP_MJ_YYYY'      ||':,'||to_char(sysdate,'yyyy'   )   ||'"> '  ||yyyy            ||'</a>'  end as yyyy
        from v_kpi

    --Dynamic Action
        Update
            begin
              delete from t_enhet3; 
              insert into t_enhet3 select * from v_enhet3;
              commit;
            end;

    --before header PL/SQL Code
        begin
            select to_char(max(stamp), 'yyyy-mm-dd hh24:mi:ss') into :P706_STAMP from t_enhet3;
        end;
    --sql
        select   enhet_seq_no
                ,'<a href="f?p='||:APP_ID||':210:'||:APP_SESSION||':UPD:'||:DEBUG||'::P210_ENHET_SEQ_NO,P210_REQUEST,P210_SEQ_ID,P210_TILBUDSNR:'||
                                                                                      enhet_seq_no||  ',UPD,'        ||'1'   ||', '||
                    '"><i class="fa fa-bomb" aria-hidden="true" title="Redigere" style="color:red"></i></a>' as detail
                ,stamp
                ,prosess
                ,prosess_desc
                ,serie_no
                ,stamp_ch
                ,stamp_ch_yyyy_mm_dd
                ,stamp_ch_yyyy_ww
                ,stamp_ch_yyyy_mm
                ,stamp_ch_yyyy
                ,stamp_mj
                ,stamp_mj_yyyy_mm_dd
                ,stamp_mj_yyyy_ww
                ,stamp_mj_yyyy_mm
                ,stamp_mj_yyyy
                ,loc_id
                ,vare_gruppe_id
                ,vare_gruppe
                ,vrak
                ,fab_navn
                ,type_id
                ,aar
                ,aar_4
                ,scope
                ----------               
                ,betegnelse
                ,k_grp_id
                ,dorer_id
                ----------               
                ,reg_no               
                ,chassis_no           
                ,chassis_no_vegdir    
                ,tecdoc_id            
                ,tecdoc_besk          
                ,km                   
                ,farge_kode           
                ,servo                
                ,miljo_klarert_id   
                ----------               
                ,motor_vol_id   
                ,motor_type_id   
                ,motor_type_besk   
                ,motor_kode
                ,motor_hk
                ----------               
                ,gear_type   
                ,gear_kode
                ,gear_test
                --/////////////////////////
                ,del            
                ,paa_bil
                ,hold_on
                ,enhet_besk
                ,substr(temp,1,20) temp      
                ,kval_id
                ,dato_inn
                ,dato_ut 
                ,pris_inkl_mva      
                ,pris_solgt_inkl_mva      
                ----------
                ,vendor                   
                ,vendor_no                
                ,vendor_pris_inkl_mva     
            --PART
                --,part_oem_visual
                ,part_oem_main
                ,part_oem_secondarY
                ,part_eqv_main
                ,part_eqv_secondarY
                ,part_brand
        from t_enhet3

----------------------------------------------------------- v_enhet2 ------------------------------------------------------------------------------------------
    create or replace view v_enhet2 as
        --create or replace view ttt as 
        /*   ERSTATTER V_ENHET_FULL (som har 8 table scan, denne har 1)
          ==========================================================
          Joiner opp prev info på del og viser "effiktivt resultat
          --ORA-01799: a column may not be outer-joined to a subquery
          --må lage tabell med alle enhet og effektive var_bil_seq_no (kan ikke joine direkte)                                 ......info fra bil ................
              --enhet_seq_no    prev_enhet_seq_no    vare_gruppe_seq_no    var_bil_seq_no                                      serie_seq_no
              --           1                    -                   !=1              SAAB   del med bil    direkte                       88
              --           2                    -                     1              AUDI   vrak (må alltid ha bil)                      89
              --           3                    2                   !=1                 -   del med bil INNdirekte                       90
              --
              --logikk krever at var_bil_seq_no 
              --KUN kan finnes dersom prev_enhet_seq_no er tom
              --implementer i tr_enhet_af_ins og bf_upf, pkt B "--   Kun Vrak får lov å registrere overordnetdel info som følger:"
              --     select enhet_seq_no from enhet where var_bil_seq_no is not null and prev_enhet_seq_no is not null
              --eller alt annet enn ekstern
              --     select enhet_seq_no from enhet where var_bil_seq_no is     null and prev_enhet_seq_no is     null and location_seq_no not in (3300)
              ---------------------------------------------------------------------------------------------------------------------------------------
              --                                                          nvl(enhet.var_bil_seq_no,select var_bil_seq_no            
              --                                                                             from enhet prev_enhet 
              --                                                                             where enhet.prev_enhet_seq_no=
              --                                                                                   prev_enhet.enhet_seq_no)
              --           1                                                         SAAB                                                 -
              --           2                                                         AUDI                                                89 
              --           3                                                         AUDI   <--avledet                                   89 <--avledet
              --
              --http://etutorials.org/SQL/Mastering+Oracle+SQL/Chapter+9.+DECODE+and+CASE/9.1+DECODE+NULLIF+NVL+and+NVL2/ 
              -----------------------------------------------------------------------------------------------------------
              --NVL (E1, E2)     IF E1 IS NULL THEN E2 ELSE E1
              --NVL2(E1, E2, E3) IF E1 IS NULL THEN E3 ELSE E2
              --select enhet_seq_no,
              --       nvl (enhet.var_bil_seq_no,                   (select prev_enhet.var_bil_seq_no from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no)) var_bil_seq_no,  
              --        nvl2(enhet.var_bil_seq_no,enhet.serie_seq_no,(select prev_enhet.serie_seq_no   from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no)) bil_serie_seq_no                                
              --from enhet
          --
          --
          --   NB pr_html bruker insert into t_eneh2 select * from v_enhet2  <<<<<---- må synkronisere kolonneliste her med tabelldefinisjon
          --
          --
          2012_03_06 logikk konstruert og sjekket at triggerne bibeholder konsistens dvs at:   var_bil_seq_no is not null and prev_enhet_seq_no is not null                                                                                     (med ord dersom bil er reg på del kan delen ikke ha overordnet vrak/del som kan/skal ineholde bil-info)
          2012_07_30 lagt inn scope fra v_bil 
          2012_08_23 lagt inn paa_bil inni html_ok
          2012_09_01 fikset vasket på modell og type som hentes via prev (ALFA-ROMEO ble returnert uten bindestrek)
          2012_11_11 fikser HOLD deler som er reg med feilnr og dermed pipet inn uten merke modell--> feil i HTML ok
          2012_12_02 lagt inn www som er fil referansen til enhet på web
          2013_06_23 krysstabulerer alle bildene inni kolonnen bilder
          2014_02_16 old_dato_inn/ut lagt inn --> alle felt fra enhet er ajour med v_enhet2
          2015_10_07 lagt inn oem_maker,motor_kode og gear_kode 
          2015_12_12 byttet ut type_if med type_parent i merke_vasket
          2016_01_19 legger inn plukkliste  for tomme lager plass
          --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<NB>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          --<<<<<<<<<<<<<<<<<<<<<<< v_enhet2      SKAL være identisk >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          --<<<<<<<<<<<<<<<<<<<<<<< t_enhet2_full SKAL være identisk >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          --<<<<<<<<<<<<<<<<<<<<<<< t_enhet2      SKAL være identisk >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  
          --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
          --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        */                                                                                      
        select
          -- 
            enhet.enhet_seq_no                                                                                                                                                                              enhet_seq_no,
            enhet.prev_enhet_seq_no                                                                                                                                                                    prev_enhet_seq_no,
            --Informasjon som ALLTID skal hentes fra overordnet del                                                                                                                                    
            --dersom var_bil_seq_no er null                                                                                                                                                            
            ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------
              --var_bil_seq_no
                --
                nvl2(enhet.var_bil_seq_no,  enhet.var_bil_seq_no        ,(select prev_enhet.var_bil_seq_no         from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_bil_seq_no,
              --var_motor_type_seq_no
                --
                nvl2(enhet.var_bil_seq_no,  enhet.var_motor_type_seq_no ,(select prev_enhet.var_motor_type_seq_no  from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_motor_type_seq_no,
              --type_klasse
                nvl2(enhet.var_bil_seq_no, (select type_klasse 
                                            from type,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.type_seq_no
                                            =type.type_seq_no)
                                                                        ,(select type_klasse                           from type,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.type_seq_no           =type.type_seq_no))
                                                                                                                                                                                                                type_klasse,  
              --fab_navn
                nvl2(enhet.var_bil_seq_no, (select fab_navn 
                                            from fabrikant,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.fab_seq_no
                                            =fabrikant.fab_seq_no)
                                                                        ,(select fab_navn                          from fabrikant,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.fab_seq_no            =fabrikant.fab_seq_no))
                                                                                                                                                                                                                fab_navn,  
              --merke_vasket
                nvl2(enhet.var_bil_seq_no, (select f_vasket('MERKE_VASKET',fab_navn)
                                            from fabrikant,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.fab_seq_no
                                            =fabrikant.fab_seq_no)
                                                                        ,(select f_vasket('MERKE_VASKET',fab_navn) from fabrikant,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.fab_seq_no            =fabrikant.fab_seq_no))
                                                                                                                                                                                                                merke_vasket,  
              --type_id
                nvl2(enhet.var_bil_seq_no, (select type_id 
                                            from type,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.type_seq_no
                                            =type.type_seq_no)
                                                                        ,(select type_id                           from type,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.type_seq_no           =type.type_seq_no))
                                                                                                                                                                                                                type_id,  
              --modell_vasket
                nvl2(enhet.var_bil_seq_no, (select f_vasket('MODELL_VASKET',type_parent)
                                            from type,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.type_seq_no
                                            =type.type_seq_no)
                                                                        ,(select f_vasket('MODELL_VASKET',type_parent) from type,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.type_seq_no           =type.type_seq_no))
                                                                                                                                                                                                                modell_vasket,  
              --aar
                nvl2(enhet.var_bil_seq_no, (select to_char(aar_model.aar,'yyyy') 
                                            from aar_model,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.aar_seq_no
                                            =aar_model.aar_seq_no)
                                                                        ,(select to_char(aar_model.aar,'yyyy')     from aar_model,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.aar_seq_no            =aar_model.aar_seq_no))
                                                                                                                                                                                                                aar,  
              --scope         2013_08_25 må bruker outer join på scope får å få frem default aar dersom scope mangler
                nvl2(enhet.var_bil_seq_no, (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),to_char(aar_model.aar,'yyyy'))
                                            from var_bil_scope,
                                                 aar_model,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.var_bil_scope_seq_no
                                            =var_bil_scope.var_bil_scope_seq_no (+)
                                            and var_bil.aar_seq_no
                                            =aar_model.aar_seq_no)
                                                                        ,(select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),to_char(aar_model.aar,'yyyy'))
                                                                                                                   from var_bil_scope,
                                                                                                                        aar_model,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.var_bil_scope_seq_no  =var_bil_scope.var_bil_scope_seq_no (+)
                                                                                                                                         and var_bil.aar_seq_no              =aar_model.aar_seq_no))
                                                                                                                                                                                                                scope,  
              --scope_vasket  2013_08_25 må bruker outer join på scope får å få frem default aar dersom scope mangler
                nvl2(enhet.var_bil_seq_no, (select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),to_char(aar_model.aar,'yyyy')))
                                            from var_bil_scope,
                                                 aar_model,
                                                 var_bil
                                            where enhet.var_bil_seq_no
                                            =var_bil.var_bil_seq_no
                                            and var_bil.var_bil_scope_seq_no
                                            =var_bil_scope.var_bil_scope_seq_no (+)
                                            and var_bil.aar_seq_no
                                            =aar_model.aar_seq_no)
                                                                        ,(select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),to_char(aar_model.aar,'yyyy')))
                                                                                                                   from var_bil_scope,
                                                                                                                        aar_model,
                                                                                                                        var_bil,
                                                                                                                        enhet prev_enhet  
                                                                                                                                         where    enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no
                                                                                                                                         and   var_bil.var_bil_scope_seq_no  =var_bil_scope.var_bil_scope_seq_no (+)
                                                                                                                                         and var_bil.aar_seq_no              =aar_model.aar_seq_no))
                                                                                                                                                                                                                scope_vasket,
              --motor_type_besk
                nvl2(enhet.var_bil_seq_no, (select var_motor_type.motor_type_besk 
                                            from var_motor_type
                                            where enhet.var_motor_type_seq_no
                                            =var_motor_type.var_motor_type_seq_no)
                                                                        ,(select var_motor_type.motor_type_besk    from var_motor_type, 
                                                                                                                        enhet prev_enhet 
                                                                                                                                         where      enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and   prev_enhet.var_motor_type_seq_no=var_motor_type.var_motor_type_seq_no))
                                                                                                                                                                                                                motor_type_besk,  
              --motor_type_id
                nvl2(enhet.var_bil_seq_no, (select var_motor_type.motor_type_id 
                                            from var_motor_type
                                            where enhet.var_motor_type_seq_no
                                            =var_motor_type.var_motor_type_seq_no)
                                                                        ,(select var_motor_type.motor_type_id      from var_motor_type, 
                                                                                                                        enhet prev_enhet 
                                                                                                                                         where      enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and   prev_enhet.var_motor_type_seq_no=var_motor_type.var_motor_type_seq_no))
                                                                                                                                                                                                                motor_type_id,  
                nvl2(enhet.var_bil_seq_no,  enhet.var_motor_volum_seq_no,(select prev_enhet.var_motor_volum_seq_no from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_motor_volum_seq_no,
                nvl2(enhet.var_bil_seq_no, (select var_motor_volum.motor_vol_id 
                                            from var_motor_volum
                                            where enhet.var_motor_volum_seq_no
                                            =var_motor_volum.var_motor_volum_seq_no)
                                                                        ,(select var_motor_volum.motor_vol_id      from var_motor_volum, 
                                                                                                                        enhet prev_enhet 
                                                                                                                                         where      enhet.prev_enhet_seq_no   =prev_enhet.enhet_seq_no
                                                                                                                                         and   prev_enhet.var_motor_volum_seq_no=var_motor_volum.var_motor_volum_seq_no))
                                                                                                                                                                                                                motor_vol_id,
              --motor_kode (kodelinje fra v_bildeler)
                nvl2(enhet.prev_enhet_seq_no, 
                    (select nvl2(enhet.motor_kode,enhet.motor_kode,null)
                                                             from enhet prev_enhet
                                                             where 1=1
                                                             and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                            nvl2(enhet.motor_kode,enhet.motor_kode,null)
                                                             )                                                          as motor_kode,
              --gear_kode (kodelinje fra v_bildeler)
                nvl2(enhet.prev_enhet_seq_no, 
                    (select nvl2(enhet.gear_kode,enhet.gear_kode,null)
                                                             from enhet prev_enhet
                                                             where 1=1
                                                             and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                            nvl2(enhet.gear_kode,enhet.gear_kode,null))                   as gear_kode,
              ---                                                             
                nvl2(enhet.var_bil_seq_no,  enhet.var_betegn_seq_no     ,(select prev_enhet.var_betegn_seq_no      from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_betegn_seq_no,
                nvl2(enhet.var_bil_seq_no,  enhet.var_kjore_grp_seq_no  ,(select prev_enhet.var_kjore_grp_seq_no   from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_kjore_grp_seq_no,
                nvl2(enhet.var_bil_seq_no, (select var_kjore_grp.k_grp_id 
                                            from var_kjore_grp 
                                            where enhet.var_kjore_grp_seq_no
                                            =var_kjore_grp.var_kjore_grp_seq_no)
                                                                        ,(select var_kjore_grp.k_grp_id            from var_kjore_grp, 
                                                                                                                        enhet prev_enhet 
                                                                                                                                         where      enhet.prev_enhet_seq_no   =prev_enhet.enhet_seq_no
                                                                                                                                         and   prev_enhet.var_kjore_grp_seq_no=var_kjore_grp.var_kjore_grp_seq_no ))
                                                                                                                                                                                                                k_grp_id,                                                          
                nvl2(enhet.var_bil_seq_no,  enhet.var_dorer_seq_no      ,(select prev_enhet.var_dorer_seq_no       from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                var_dorer_seq_no,
                nvl2(enhet.var_bil_seq_no, (select var_dorer.dorer_id||'d'  
                                            from var_dorer
                                            where enhet.var_dorer_seq_no
                                            =var_dorer.var_dorer_seq_no)
                                                                        ,(select var_dorer.dorer_id||'d'           from var_dorer, 
                                                                                                                        enhet prev_enhet 
                                                                                                                                         where      enhet.prev_enhet_seq_no    =prev_enhet.enhet_seq_no
                                                                                                                                         and   prev_enhet.var_dorer_seq_no     =var_dorer.var_dorer_seq_no))
                                                                                                                                                                                                                dorer_id,  
                nvl2(enhet.var_bil_seq_no,  enhet.km                    ,(select prev_enhet.km                     from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                km,
                --NB forutsetter at alle vrak har var_bil_seq_no (det har de jo etter reprod 2013_05_21 er i boks
                nvl2(enhet.reg_no,  enhet.reg_no                        ,(select prev_enhet.reg_no                 from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                reg_no,
                nvl2(enhet.var_bil_seq_no,  enhet.chassis_no            ,(select prev_enhet.chassis_no             from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                chassis_no,
                --NB legges også inn i henteordre og da har vi ikke biltype, men reg_no
                nvl2(enhet.reg_no,          enhet.chassis_no_vegdir     ,(select prev_enhet.chassis_no_vegdir      from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                chassis_no_vegdir,      
                nvl2(enhet.var_bil_seq_no,  enhet.farge_kode            ,(select prev_enhet.farge_kode             from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                farge_kode,
                nvl2(enhet.var_bil_seq_no,  enhet.betegnelse            ,(select prev_enhet.betegnelse             from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                betegnelse,
                nvl2(enhet.var_bil_seq_no,  enhet.gear_type             ,(select prev_enhet.gear_type              from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                gear_type,
                nvl2(enhet.var_bil_seq_no,  enhet.miljo_klarert_id      ,(select prev_enhet.miljo_klarert_id       from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                miljo_klarert_id,
                nvl2(enhet.var_bil_seq_no,  enhet.miljo_klarert_oppe_id ,(select prev_enhet.miljo_klarert_oppe_id  from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                miljo_klarert_oppe_id,
                nvl2(enhet.var_bil_seq_no,  enhet.servo                 ,(select prev_enhet.servo                  from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                servo,
                nvl2(enhet.var_bil_seq_no,  enhet.tecdoc_id             ,(select prev_enhet.tecdoc_id              from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                tecdoc_id,
                nvl2(enhet.var_bil_seq_no,  enhet.tecdoc_besk           ,(select prev_enhet.tecdoc_besk            from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))                tecdoc_besk,
                ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------
                --                          ^
                --                          |
                --                          |
                --                 alltid prev i kolonne navn
                --           sjekk:select enhet_seq_no from enhet where var_bil_seq_no is null and prev_enhet_seq_no is null
                --                          |
                --                          |
                --                          V
                ------------------------------------------------------------------------------------------------ ------------------------------------------------------------------------
                                                                                      enhet.vare_gruppe_seq_no                                                                                                  vare_gruppe_seq_no,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.vare_gruppe_seq_no     from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_vare_gruppe_seq_no,
              --vare_gruppe_id
                --  
                                                                         (select vare_gruppe.vare_gruppe_id        from vare_gruppe               where enhet.vare_gruppe_seq_no=vare_gruppe.vare_gruppe_seq_no)           vare_gruppe_id,
                                                                         (select vare_gruppe.vare_gruppe           from v_vare_gruppe vare_gruppe where enhet.vare_gruppe_seq_no=vare_gruppe.vare_gruppe_seq_no)           vare_gruppe,
              --del_vasket  
                                                                         (select f_vasket('DEL_VASKET',vare_gruppe.vare_gruppe_id)
                                                                                                                   from vare_gruppe      where enhet.vare_gruppe_seq_no=vare_gruppe.vare_gruppe_seq_no)           del_vasket,
              --serie_seq_no
                --
                                                                                      enhet.serie_seq_no                                                                                                        serie_seq_no,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.serie_seq_no           from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_serie_seq_no,
              --serie_no  
                       --sørger for at D,V ikke skriver ut dersom serie_no er tomt som for solgte deler                                                                                                           
                       --decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no                                                                                                
                                                                         (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no                                 
                                                                                                                   from serie serie      where enhet.serie_seq_no=serie.serie_seq_no)                           serie_no,
              --prev_serie_no
                nvl2(enhet.var_bil_seq_no,  null                        ,(select decode(prev_enhet.vare_gruppe_seq_no,1,'V',decode(prev_serie.serie_no,null,'','D'))||prev_serie.serie_no                  
                                                                                                                   from serie prev_serie,                                                                  
                                                                                                                        enhet prev_enhet                                                                                                                          
                                                                                                                                         where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no             
                                                                                                                                         and   prev_enhet.serie_seq_no=prev_serie.serie_seq_no))           prev_serie_no,
              --location_seq_no
                --
                                                                                      enhet.location_seq_no                                                                                                     location_seq_no,
              --html_ok     sjekk mot v_map_status  hele logikken ligget der f.o.m v_obas_416.sql
                (select ready_html from v_map_status where enhet.enhet_seq_no=v_map_status.enhet_seq_no)                                                                                                        html_ok,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.location_seq_no        from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_location_seq_no,
                --2016_01_19 legger inn plukkeliste hvis tom lager plass nvl2(test,not null,null)
                nvl2(enhet.location_seq_no,
                                                                         (select loc_id                            from location         where enhet.location_seq_no  =location.location_seq_no),
                                                                         'plukkeliste')                                                                                                                         loc_id,
                                                                                      enhet.enhet_kval_seq_no                                                                                                   enhet_kval_seq_no,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.enhet_kval_seq_no      from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_enhet_kval_seq_no,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select enhet_kvalitet.kval_id            from enhet_kvalitet   where enhet.enhet_kval_seq_no=enhet_kvalitet.enhet_kval_seq_no))       kval_id,
                                                                                      enhet.enhet_besk                                                                                                          enhet_besk,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.enhet_besk             from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_enhet_besk,
                                                                                      enhet.dato_inn                                                                                                            dato_inn,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.dato_inn               from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_dato_inn,
                                                                                      enhet.dato_ut                                                                                                             dato_ut,
                nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.dato_ut                from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_dato_ut,
                temp                                                                                                                                                                                            temp,
                temp_dato                                                                                                                                                                                       temp_dato,
                db_katalog                                                                                                                                                                                      db_katalog,
                paa_bil                                                                                                                                                                                         paa_bil,
                merke_nr                                                                                                                                                                                        merke_nr,
                -- upper(replace(replace(prod_nr_old,chr(10)),chr(13),' '))                                                                                                                                     prod_nr,
                upper(replace(replace(prod_nr,chr(10)),chr(13),' '))                                                                                                                                            prod_nr,
                oem_maker                                                                                                                                                                                       oem_maker,        
                old_serie_seq_no                                                                                                                                                                                old_serie_seq_no,
                vendor_data_seq_no                                                                                                                                                                              vendor_data_seq_no,
                                                                         (select vendor_data_no                    from vendor_data      where enhet.vendor_data_seq_no  =vendor_data.vendor_data_seq_no)       vendor_data_no,
                endring                                                                                                                                                                                         endring,
                hold_on                                                                                                                                                                                         hold_on,
                pris_4021                                                                                                                                                                                       pris_4021,
                date_4021                                                                                                                                                                                       date_4021,
                pris_inkl_mva                                                                                                                                                                                   pris_inkl_mva,
                pris_solgt_inkl_mva                                                                                                                                                                             pris_solgt_inkl_mva,
                org_pris_inkl_mva                                                                                                                                                                               org_pris_inkl_mva,
                org_dato_inn                                                                                                                                                                                    org_dato_inn,
                takst_seq_no                                                                                                                                                                                    takst_seq_no,
                salg_via                                                                                                                                                                                        salg_via,
                salg_funnet                                                                                                                                                                                     salg_funnet,
                --'http://www.vg.no/index.html'                                                                                                                                                                     www,
                                                                         (select (select html_ref.html_ref_kode from html_ref where use='WWW_ROT')||
                                                                                  enhet_html.rev_html_fil 
                                                                          from enhet_html
                                                                          where enhet_html.enhet_seq_no  =enhet.enhet_seq_no
                                                                          and   enhet_html.rev_html_fil is not null)                                                                                            www,
              reprod_2013_04_21                                                                                                                                                                                 reprod_2013_04_21,                                                            
            -------------------------------------------------------------------------------------slutt enhet ------------------------------------------------------------------------
          --bilder
              --start
                                                                       (select count(enhet_blobs.blobs_seq_no) from enhet_blobs     where enhet.enhet_seq_no     =enhet_blobs.enhet_seq_no)                 bilder_ant,
                                                                       (select count(enhet_blobs.blobs_seq_no) from enhet_blobs     where enhet.prev_enhet_seq_no=enhet_blobs.enhet_seq_no)            prev_bilder_ant,
              --NBNB ingen joining av var_bil (map_bil) map_del da disse er mange til 1 og vi vil få ORA-01427: single-row subquery returns more than one
              --har ikke bruk for max() her  lar helle f.eks v_map_obas_lbk .... joine
              --KAN ikke legges in ref da virker ikke insert .... select * from v_enhet2   
              null                                                                                                                                                                                            bilder,
              --(select rtrim(xmlagg (xmlelement (e, blobs_seq_no || ',')).extract ('//text()'), ',') as bilder    from enhet_blobs     where enhet.enhet_seq_no     =enhet_blobs.enhet_seq_no group by enhet_blobs.enhet_seq_no) bilder,
              --(select listagg(blobs_seq_no,',') within group (order by blobs_seq_no)                as bilder    from enhet_blobs     where enhet.enhet_seq_no     =enhet_blobs.enhet_seq_no group by enhet_blobs.enhet_seq_no)
            --dummyer   
              (select listagg(blobs_seq_no,',') within group (order by sort_order) from enhet_blobs where enhet.enhet_seq_no=enhet_blobs.enhet_seq_no group by enhet_blobs.enhet_seq_no)       as del_1,
              null                                                                                        as del_2,
              null                                                                                        as del_3,
              null                                                                                        as del_4,
              (select listagg(blobs_seq_no,',') within group (order by sort_order) from enhet_blobs where enhet.prev_enhet_seq_no =enhet_blobs.enhet_seq_no group by enhet_blobs.enhet_seq_no) as bil_1,
              null                                                                                        as bil_2,
              null                                                                                        as bil_3,
              null                                                                                        as bil_4,
              nvl2(karroseribyttebiler,'j','n')  karroseribyttebiler,
              enhet.old_dato_inn                 old_dato_inn,  
              enhet.old_dato_ut                  old_dato_ut
          --kpi
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D1' then 'D1'                                                                                                        end as flow_d1
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D1' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_d1_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D2' then 'D2'                                                                                                        end as flow_d2
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D2' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_d2_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D3' then 'D3'                                                                                                        end as flow_d3
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D3' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_d3_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D4' then 'D4'                                                                                                        end as flow_d4
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'D4' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_d4_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V1' then 'V1'                                                                                                        end as flow_v1
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V1' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v1_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V2' then 'V2'                                                                                                        end as flow_v2
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V2' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v2_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V3' then 'V3'                                                                                                        end as flow_v3
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V3' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v3_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V4' then 'V4'                                                                                                        end as flow_v4
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V4' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v4_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V5' then 'V5'                                                                                                        end as flow_v5
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V5' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v5_desc
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V6' then 'V6'                                                                                                        end as flow_v6
                ,case when f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil) = 'V6' then f_prosess(f_prosess( 'id', vare_gruppe_seq_no, serie_seq_no, location_seq_no, paa_bil),null,null,null,null) end as flow_v6_desc
                ,case when                                                                                                                   serie_seq_no is not null  then 'S1'                                 end as stat_s1
                ,case when                                                                                                                   serie_seq_no is not null  then 'Deler og vrak med nr'               end as stat_s1_desc
                ,case when  stamp_chassis_no        is not null                                                                                                        then 'X1'                                 end as stat_x1 
                ,case when  stamp_chassis_no        is not null                                                                                                        then 'Vrak med chassis nr'                end as stat_x1_desc
                ,case when  stamp_miljo_klarert_id  is not null                                                                                                        then 'X2'                                 end as stat_x2
                ,case when  stamp_miljo_klarert_id  is not null                                                                                                        then 'Vrak milj'||f_utf('oe')||'klarert'  end as stat_x2_desc
        from 
          enhet                  enhet
        where 1=1
    /
            select count(*) from enhet;
            select count(*) from v_enhet2;
            --137358
            --139122 22.08.2018
            --140921 14.10.2018
            --159968 21.07.2020
            --160105 06.08.2020
            --162057 11.10.2020
            --165160 18.01.2021 etter kill enhet_sub

      --tune
            truncate table plan_table;
		    delete from plan_table where statement_id='733';
		    explain plan set statement_id='733' into plan_table for 
		    --ordered  all_rows  RASKT...
		    select * from v_enhet2;
		    commit;	      

      --dill
          --drop table t_enhet2;
          create table t_enhet2 as select * from v_enhet2 where html_ok='ja' ;
          --truncate table t_enhet2;
          insert into t_enhet2 select * from v_enhet2 where html_ok='ja' ;
          commit;

          --drop  table t_enhet2_full;
          --truncate table t_enhet2_full;
          insert into t_enhet2_full select * from v_enhet2 where LOCATION_SEQ_NO is not null ;
          commit;
    
          select enhet_seq_no, listagg(blobs_seq_no,',') within group (order by blobs_seq_no) as txt 
          from enhet_blobs
          where enhet_seq_no=323611 
          group by enhet_seq_no

          select
          (select count(*) from   enhet                                         ) tot_enhet,
          (select count(*) from v_enhet2                                        ) tot_v_enhet2,
          --gamle v_enhet_full
          (select count(*) from v_enhet_full                                    ) tot_v_enhet_full,
          (select count(*) from v_enhet2 where html_ok='ja'                     ) html_ok,
          (select count(*) from v_enhet_master                                  ) master,
          (select count(*) from t_enhet2                                        ) t_enhet2,
          (select count(*) from t_enhet2_full                                   ) t_enhet2_full
          --(select count(*) from mv_v_enhet2                                     ) mv_v_enhet2
          from dual;
           TOT_ENHET TOT_V_ENHET2 TOT_V_ENHET_FULL    HTML_OK     MASTER    t_enhet2    t_enhet2_full
          ---------- ------------ ---------------- ----------     ------    --------    -------------
               86233        86233            86233      22240
               88310        88310            88310      22229
               
               88310        88310            88310      22228                                          <--fils 2012_11_11
               88578        88578            88578      22256                                          <-2012_11_18 FØR v_map_status koblet inn d.v.s html_ok='Y'  
               88578        88578            88578      21804                                          <-- v_obas_417.sql flyttet logikk til c_map_status + 
               90152        90152            90152      21739      90152                                        
               93856        93856            93856      21709      93856                               <--2013_06_23 før krysstabulering av bilder   
               98067        98067            98067      21075      98067      21092       21505       <--før karroseribyttebiler
               98067        98067            98067      21075      98067      21092       21505     
               99182        99182            99182      20569      99182      20571       20869     
                           135361                                                                     <<-2018_02_18 
              

              --ENHET_SEQ_NO	PREV_ENHET_SEQ_NO	FAB_NAVN	LOC_ID	    BIL_1	                        DEL_1
              --105485	      104142	          BMW	      plukkeliste	-10000,-10001,-10002,-10003	  -8050,-8051,-8052
              --106024	      104142	          BMW	      plukkeliste	-10000,-10001,-10002,-10003	  -7843,-7844
              --105491	      104142	          BMW	      plukkeliste	-10000,-10001,-10002,-10003	  -8134,72237,72238,72239,72240
              --105473	      104142	          BMW	      plukkeliste	-10000,-10001,-10002,-10003	  -8038,-8039
              --105474	      104142	          BMW	      plukkeliste	-10000,-10001,-10002,-10003	  -8196
              --105475	      104142	          BMW	      3S5D	      -10000,-10001,-10002,-10003	  -8201

          --ny kun 1 table scan
          --truncate table plan_table;
          explain plan set statement_id='733' into plan_table for 
          select * from v_enhet2;
          --select * from v_enhet2 where html_ok='Y'
          --select distinct merke_vasket as kat1_merke from v_enhet_html_katalog where merke_vasket in ('AUDI') and modell_vasket='A6'
          select distinct merke_vasket,modell_vasket,del_vasket from v_enhet2 where html_ok='Y' and merke_vasket in ('AUDI') and modell_vasket='A6';
          commit;
    
          delete from enhet_html
          where
          exists (select 'x' from enhet where enhet.enhet_seq_no=enhet_html.enhet_seq_no and enhet.paa_bil='J');
    
          eller
          set linesize 3500        
          set pagesize 9999                         
          set array 1                               
          set ti on
          set wra off
          set autotrace trace exp stat     
    
          SELECT * from ola.v_enhet_html_katalog_item_list where 1=1         and merke_vasket  = 'AUDI' and modell_vasket = 'A6' and del_vasket='BENSINPUMP'
          SELECT * from ola.v_enhet2 where html_ok='Y' and merke_vasket  = 'AUDI' and modell_vasket = 'A6' and del_vasket='BENSINPUMP'
    
          select count(*) from t_enhet2; 
          select count(*) from v_enhet2 where html_ok='ja';
          select count(*) from t_enhet2_full;
          select count(*) from v_enhet2 where location_seq_no is not null ;
    
    
          --bilde statisikk til html
          select merke_vasket, modell_vasket,del_vasket||' '||scope_vasket, count(bilder) as ant
          from t_enhet2
          where 1=1
          group by merke_vasket, modell_vasket,del_vasket||' '||scope_vasket
          order by 1,2,3,4
    
          select ant, count(ant)
          from (select merke_vasket, modell_vasket,del_vasket||' '||scope_vasket, count(bilder) as ant
                from t_enhet2
                where 1=1
                group by merke_vasket, modell_vasket,del_vasket||' '||scope_vasket
               )
          group by ant
          order by 2 desc;
                 ANT COUNT(ANT)
          ---------- ----------
                   1      10363        
                   2       2605        <-- kon 23 i bredden nok
                   0       1146
                   3        675
                   4        240
                   5         82
                   6         27
                   7          9
                   8          5
                  12          1
                   9          1
    
------------------------------------------------------------mv_v_bildeler-----------------------------------------------------------------------------------------------------------------------------------
      create materialized view ola.mv_v_bildeler pctfree 0  tablespace mv storage (initial 10M next 10M pctincrease 0) build immediate as  
        select * from v_bildeler
        --where location_seq_no is not null
        /
    
------------------------------------------------------------v_prise -----------------------------------------------------------------------------------------------------------------------------------
      create or replace view v_prise as
        ---------<<<<<<husk INSTEAD OF TRIGGEREN >>>>>>>>>>>>>>>>>>>>>>>-------------------
        -----------------------------------------------------------------------------------
        /*
          kopi kode mv_obas_xx.sql
           materialized view ola.mv_scope_bil_vare_ant_p_lager
           bytter ut count med enhet_seq_no og pris
        */
        select  
                var_bil.var_bil_seq_no    var_bil_seq_no,
                enhet.vare_gruppe_seq_no  vare_gruppe_seq_no,
                enhet.enhet_seq_no        enhet_seq_no,
                enhet.serie_seq_no        serie_seq_no,
                v_enhet2.serie_no,
                v_enhet2.fab_navn         fab_navn,
                v_enhet2.type_id          type_id,
                v_enhet2.aar              aar,
                v_enhet2.scope            scope,
                v_enhet2.pris_inkl_mva    pris_inkl_mva,
                v_enhet2.enhet_besk       enhet_besk,
                v_enhet2.temp             temp,
                v_enhet2.dato_inn         dato_inn,
                v_enhet2.bilder_ant       bilder_ant
        from  
              ola.var_bil   var_bil,
              ola.var_bil   var_bil_alle,
              ola.enhet     enhet_prev,
              ola.enhet     enhet,
              ola.v_enhet2  v_enhet2
        where 1=1
          --scope til bilen
          and nvl(var_bil.var_bil_scope_seq_no     ,-var_bil.var_bil_seq_no)  = nvl(var_bil_alle.var_bil_scope_seq_no,-var_bil_alle.var_bil_seq_no)        
          and var_bil.fab_seq_no                                              = var_bil_alle.fab_seq_no   
          and var_bil.type_seq_no                                             = var_bil_alle.type_seq_no
          --alle bilene på scopet   
          and var_bil_alle.var_bil_seq_no      =enhet_prev.var_bil_seq_no
          --med alle delene
          and enhet.prev_enhet_seq_no          = enhet_prev.enhet_seq_no                 
          --på lager
          and enhet.location_seq_no is not null
          --ikke i plukke listen
          and nvl(enhet.paa_bil,'x') <> 'J'
          --spare arbeid
          and enhet.enhet_seq_no = v_enhet2.enhet_seq_no
        /
    
------------------------------------------------------------v_bildeler p 210 APEX (108 app) ----------------------------------------------------------------------------------------------------------------------------
    create or replace view v_bildeler as
        /*
            Brukes i APEX bilde 108:210 og 117:220 delaljer om del/vrak
            --kjempe raskt nå enhet_seq_no brukes i fetch alt annet SUGER
            2014_02_17 laget som kopi av v_enhet2  
            2014_02_25 fikset Valldal vinterferie
            2014_04_02 lagt inn enhet_sub_seq_no;
            2014_04_05 lagt inn pris_solgt_inkl_mva,salg_funnet, salg_via
            2014_04_12 lagt in v_interior_farge_yn_real  NB enhet_sub.airbag_ant||' airbagger' --> airbag_ant_real ELLER replace(:P210_MOTOR_HK,'hk',' ')
            2014_05_25 lagt inn v0_var_bil_scope_seq_no  
            2014_06_15 lagt inn oem_maker
            2015_04_11 fikset v_lbk_type som returnerer flere rows pr enhet_seq_no
            2015_10_07 byttet ut v_map_bil med v_var_bil  --> redusert tablescan FULL drygt mye men fremdeles ca 7 sekund i søket D25931
            2016_10_26 lagt inn kolonne bilder_ant (NB indexsen på enhet_seq_no i enhet_blobs var borte... huff måtte legge inn på  nytt)
            2018_10_14 lagt ut nr_oem som nr_oem_old
            --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<NB>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<       legg inn inn trigger       >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<     tr_instd_v_bildeler_zz.sql   >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<       legg inn inn mv_v_bildeler >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<     mv_obas_zz.sql               >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        */
        select 
            --ITEM..
              enhet.enhet_seq_no                                                                                                    as      enhet_seq_no,
              enhet.prev_enhet_seq_no                                                                                               as prev_enhet_seq_no,
            --   (select enhet_sub.enhet_sub_seq_no from enhet_sub where enhet.enhet_seq_no=enhet_sub.enhet_seq_no)                    as  enhet_sub_seq_no,
              null                                                                                                                  as  enhet_sub_seq_no,
            --DEL
              enhet.vare_gruppe_seq_no                                                                                              as      vare_gruppe_seq_no,
              (select vare_gruppe.vare_gruppe_pris_info
                                                   from vare_gruppe                  where 1=1
                                                   and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as      vare_gruppe_pris_info,
              (select prev_enhet.vare_gruppe_seq_no  from enhet prev_enhet             where 1=1
                                                     and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_vare_gruppe_seq_no,
              (select vare_gruppe.vare_gruppe_id     from vare_gruppe                  where 1=1
                                                     and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as      vare_gruppe_id,
              (select vare_gruppe.vare_gruppe_id     from vare_gruppe,enhet prev_enhet where 1=1 
                                                     and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no 
                                                     and prev_enhet.vare_gruppe_seq_no =vare_gruppe.vare_gruppe_seq_no       )      as prev_vare_gruppe_id,
              (select f_vasket('DEL_VASKET', vare_gruppe.vare_gruppe_id)
                                                     from vare_gruppe                  where 1=1
                                                     and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as del_vasket,
            --SERIE_NO
              --NB ved sjekk varegruppe=1 her forutsetter det at kun denne kan få bruke V serien ref problem V21822 reg på varegruppe_HOLD--> ikke søkbart
              enhet.serie_seq_no                                                                                                    as      serie_seq_no,
              --dummy brukes i p210 for å sikre at vi kan sette kolonne_verdien
              enhet.serie_seq_no                                                                                                    as      serie_seq_no_nytt_vrak,
              (select prev_enhet.serie_seq_no        from enhet prev_enhet             where 1=1
                                                     and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_serie_seq_no,
              (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                     from serie                        where 1=1
                                                     and enhet.serie_seq_no            =serie.serie_seq_no                   )      as      serie_no,
              (select decode(prev_enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                     from serie,enhet prev_enhet       where 1=1 
                                                     and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no 
                                                     and prev_enhet.serie_seq_no       =serie.serie_seq_no                   )      as prev_serie_no,
              (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                     from serie                        where 1=1
                                                     and enhet.old_serie_seq_no        =serie.serie_seq_no                   )      as  old_serie_no,
            --LOC 
              enhet.location_seq_no                                                                                                 as location_seq_no, 
              --dummy brukes i p210 for å sikre at vi kan sette kolonne_verdien
              enhet.location_seq_no                                                                                                 as location_seq_no_nytt_vrak, 
              --kan underscore i location erstattes med  space slik at APEX-table html wrapping blir bedre
              (select replace( loc_id,'_',' ')       from location                     where 1=1
                                                     and enhet.location_seq_no         =location.location_seq_no             )      as loc_id, 
              (select prev_enhet.location_seq_no     from enhet prev_enhet             where 1=1
                                                     and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_location_seq_no,                                           
            --ymse
              enhet.enhet_kval_seq_no                                                                                               as enhet_kval_seq_no,            --enhet_kval_seq_no
              (select enhet_kvalitet.kval_id         from enhet_kvalitet               where 1=1
                                                     and enhet.enhet_kval_seq_no       =enhet_kvalitet.enhet_kval_seq_no     )      as kval_id,                      --kval med tekst
              --kan ha CR(0D/13) + LF (0A/10) disse byttes ut med EN space  (20/32)
              replace( replace( enhet.enhet_besk,chr(13),null),chr(10), ' ')                                                        as enhet_besk,
              replace( replace( enhet.temp,chr(13),null),chr(10), ' ')                                                              as temp,
              enhet.temp_dato                                                                                                       as temp_dato,
              enhet.dato_inn                                                                                                        as dato_inn,
              enhet.dato_ut                                                                                                         as dato_ut,
              enhet.paa_bil                                                                                                         as paa_bil,
              enhet.hold_on                                                                                                         as hold_on,
              enhet.pris_inkl_mva                                                                                                   as pris_inkl_mva,
              nvl2(enhet.miljo_klarert_id,                                                                                                    
                   enhet.miljo_klarert_id,                                                                                                    
                  (select prev_enhet.miljo_klarert_id from enhet prev_enhet                                                                   
                                                      where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                as miljo_klarert_id,                                          
              pris_solgt_inkl_mva,
              org_pris_inkl_mva,
              org_dato_inn,
              (select count(*) from enhet_blobs where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no)                                as bilder_ant,
              takst_seq_no,
              salg_via,
              salg_funnet,
              --db_katalog
              --endring
              --pris_4021
              --date_4021
              --old_dato_inn
              --old_dato_ut
              --reprod_2013_04_21
              --nvl2(karroseribyttebiler,'j','n')karroseribyttebiler,
            ---oem nr etc
              --kan ha CR(0D/13) + LF (0A/10) disse byttes ut med EN space  (20/32)
              oem_maker                                                                                                                       as oem,
              replace( replace( prod_nr,chr(13),null),chr(10), ' ')                                                                           as nr_oem,             --LEV i bildeler prog (ikke dynamo!!)
              replace( replace( prod_nr_old,chr(13),null),chr(10), ' ')                                                                       as nr_oem_old,         --LEV i bildeler prog (ikke dynamo!!)
              enhet.vendor_data_seq_no                                                                                                        as vendor_data_seq_no,
              (select vendor_data_no                  from vendor_data      
                                                     where enhet.vendor_data_seq_no      =vendor_data.vendor_data_seq_no)                     as nr_bytte_nr_vendor, --Nr på del i bildel prog (start,dyn,servo-p,tannstang,ac-komp,calip))
              merke_nr                                                                                                                        as nr_bytte_nr,        --utgått kan evnt brukes til bytte_nr i stede for vendor
            --MOTOR (nbk,mevca)
              nvl2(enhet.var_motor_type_seq_no,  
                   enhet.var_motor_type_seq_no,
                  (select 
                     var_motor_type.var_motor_type_seq_no  from var_motor_type,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as var_motor_type_seq_no,
              nvl2(enhet.var_motor_type_seq_no,  
                  (select var_motor_type.motor_type_id     from var_motor_type
                                                           where 1=1
                                                           and   enhet.var_motor_type_seq_no      =var_motor_type.var_motor_type_seq_no),
                  (select var_motor_type.motor_type_id     from var_motor_type,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as motor_type_id,
              nvl2(enhet.var_motor_type_seq_no,  
                  (select var_motor_type.motor_type_besk   from var_motor_type
                                                           where 1=1
                                                           and   enhet.var_motor_type_seq_no      =var_motor_type.var_motor_type_seq_no),
                  (select var_motor_type.motor_type_besk   from var_motor_type,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as motor_type_besk,
              nvl2(enhet.var_motor_volum_seq_no,  
                   enhet.var_motor_volum_seq_no,
                  (select 
                   var_motor_volum.var_motor_volum_seq_no  from var_motor_volum,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_motor_volum_seq_no =var_motor_volum.var_motor_volum_seq_no))   as var_motor_volum_seq_no,
              nvl2(enhet.var_motor_volum_seq_no,  
                  (select nvl2(var_motor_volum.motor_vol_id,trim(var_motor_volum.motor_vol_id)||'l',null) 
                                                          from var_motor_volum
                                                           where 1=1
                                                           and   enhet.var_motor_volum_seq_no     =var_motor_volum.var_motor_volum_seq_no),
                  (select nvl2(var_motor_volum.motor_vol_id,trim(var_motor_volum.motor_vol_id)||'l',null) 
                                                           from var_motor_volum,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_motor_volum_seq_no=var_motor_volum.var_motor_volum_seq_no))     as motor_vol_id,
            --
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.hk,enhet.hk||'hk',null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.hk,enhet.hk||'hk',null))                                       as motor_hk,        --med hk
            --
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.hk,enhet.hk,null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.hk,enhet.hk,null))                                                                                         as motor_hk_real,   --kun tall
            --
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.motor_kode,enhet.motor_kode,null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.motor_kode,enhet.motor_kode,null))                                                                         as motor_kode,
            --
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.motor_test,enhet.motor_test,null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.motor_test,enhet.motor_test,null))                                                                         as motor_test,
            --GEAR  (gearkode  vognklort avlesing  hva med vognkort)
              nvl2(enhet.gear_type,
                   enhet.gear_type,  
                  (select prev_enhet.gear_type             from enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no))                    as gear_type,
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.gear_kode,enhet.gear_kode,null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.gear_kode,enhet.gear_kode,null)                                              )                         as gear_kode,
              nvl2(enhet.prev_enhet_seq_no, 
                  (select nvl2(enhet.gear_test,enhet.gear_test,null)
                                                           from enhet prev_enhet
                                                           where 1=1
                                                           and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no),
                          nvl2(enhet.gear_test,enhet.gear_test,null) )                                                                      as gear_test,
            --Informasjon som ALLTID skal hentes fra overordnet del                                                                                                                                    
            --dersom var_bil_seq_no er null
            --nvl2 (xxxx, xxx finnes ,  xxx fra prev)                                                                                                                                                            
            --BIL v0_xxx
              nvl2(enhet.var_bil_seq_no,  
                   enhet.var_bil_seq_no,
                  (select prev_enhet.var_bil_seq_no  from enhet prev_enhet 
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v0_var_bil_seq_no,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select var_bil_scope.var_bil_scope_seq_no
                                                     from var_bil_scope,var_bil                                                     
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+) ),             
                  (select var_bil_scope.var_bil_scope_seq_no                                                                                  
                                                     from var_bil_scope,var_bil,enhet prev_enhet                                    
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+) ) )          as v0_var_bil_scope_seq_no,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select type_klasse                from type,var_bil                                                                        
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.type_seq_no             =type.type_seq_no),                                  
                  (select type_klasse                from type,var_bil,enhet prev_enhet                                                       
                                                     where 1=1                                                                                
                                                     and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_type_klasse,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select fabrikant.fab_navn         from fabrikant,var_bil                                                                   
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.fab_seq_no              =fabrikant.fab_seq_no),                              
                  (select fabrikant.fab_navn         from fabrikant,var_bil,enhet prev_enhet                                                  
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.fab_seq_no              =fabrikant.fab_seq_no))                               as v0_fab_navn,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select f_vasket('MERKE_VASKET',fab_navn) from fabrikant,var_bil                                                            
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.fab_seq_no              =fabrikant.fab_seq_no),                              
                  (select f_vasket('MERKE_VASKET',fab_navn) from fabrikant,var_bil,enhet prev_enhet                                           
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.fab_seq_no              =fabrikant.fab_seq_no))                              as v0_merke_vasket,  --fab_navn
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select type.type_id               from type,var_bil                                                                        
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.type_seq_no             =type.type_seq_no),                                  
                  (select type.type_id               from type,var_bil,enhet prev_enhet                                                       
                                                     where 1=1                                                                                
                                                     and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_type_id,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select f_vasket('MODELL_VASKET',type_id) from type,var_bil                                                                 
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.type_seq_no             =type.type_seq_no),                                  
                  (select f_vasket('MODELL_VASKET',type_id) from type,var_bil,enhet prev_enhet                                                
                                                      where 1=1                                                                               
                                                     and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_modell_vasket, --type_id
              --legges inn for å muliggjør søk på LBK merke Mercedez eks W123 ,
              --alle var_bil_seq_no finnes i v_var_bil select var_bil_seq_no from var_bil minus select obv_var_bil_seq_no from v_var_bil  
              --
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select v_var_bil.lbk
                                                     from v_var_bil                                                     
                                                     where 1=1
                                                     and enhet.var_bil_seq_no            =v_var_bil.var_bil_seq_no            ),             
                  (select v_var_bil.lbk                                                                                 
                                                     from v_var_bil,enhet prev_enhet                                    
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no  
                                                     --linje under ble glemt frem til 2014_04_11 samrt at var_bil tabellen fra med i from ...listingen
                                                     and prev_enhet.var_bil_seq_no       =v_var_bil.var_bil_seq_no))                       as v0_lbk_type,                                         
              nvl2(enhet.var_bil_seq_no,                                                                                                           
                   enhet.betegnelse,                                                                                                          
                  (select prev_enhet.betegnelse      from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v0_betegnelse,
              --chr(229)||'rsmodell:'||
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select nvl2(aar_model.aar,to_char(aar_model.aar,'yyyy'),null) 
                                                    from aar_model,var_bil                                                                
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
                  (select nvl2(aar_model.aar,to_char(aar_model.aar,'yyyy'),null) 
                                                     from aar_model,var_bil,enhet prev_enhet                                               
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_aar,
              --2013_08_25 må bruker outer join på scope får å få frem default aar dersom scope mangler                                       
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                              to_char(aar_model.aar,'yyyy'))                                                                                  
                                                     from var_bil_scope,aar_model,var_bil                                                     
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
                  (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                              to_char(aar_model.aar,'yyyy'))                                                                                  
                                                     from var_bil_scope,aar_model,var_bil,enhet prev_enhet                                    
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_scope,
              nvl2(enhet.var_bil_seq_no,                                                                                                      
                  (select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                   
                                    to_char(aar_model.aar,'yyyy')))                                                                           
                                                     from var_bil_scope,aar_model,var_bil                                                     
                                                     where 1=1                                                                                
                                                     and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
                  (select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                   
                                    to_char(aar_model.aar,'yyyy')))                                                                           
                                                     from var_bil_scope,aar_model,var_bil,enhet prev_enhet                                    
                                                     where 1=1                                                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                     and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                     and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                     and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_scope_vasket,
            --BIL v1_xxx
              nvl2(enhet.reg_no,                                                                                                              
                   enhet.reg_no,                                                                                                              
                  (select prev_enhet.reg_no          from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_reg_no,
              nvl2(enhet.prev_enhet_seq_no,                                                                                                   
                  (select decode(enhet.brukt_imp_yn,'y','brukt importert',null)                                                          
                                                     from enhet prev_enhet where 1=1                                                
                                                     and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no),                            
                  decode(enhet.brukt_imp_yn,'y','brukt importert',null) )                            as v1_brukt_imp_yn,
              nvl2(enhet.chassis_no,                                                                                                          
                   enhet.chassis_no,                                                                                                          
                  (select prev_enhet.chassis_no      from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_chassis_no,
              nvl2(enhet.chassis_no_vegdir,                                                                                                          
                   enhet.chassis_no_vegdir,                                                                                                          
                  (select prev_enhet.chassis_no_vegdir from enhet prev_enhet                                                                    
                                                      where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_chassis_no_vegdir,
              nvl2(enhet.tecdoc_id,                                                                                                           
                   enhet.tecdoc_id,                                                                                                           
                  (select prev_enhet.tecdoc_id       from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_tecdoc_id,
              nvl2(enhet.tecdoc_besk,                                                                                                         
                   enhet.tecdoc_besk,                                                                                                         
                  (select prev_enhet.tecdoc_besk     from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_tecdoc_besk,
              nvl2(enhet.km,                                                                                                                  
                   enhet.km,                                                                                                                  
                  (select prev_enhet.km              from enhet prev_enhet                                                                    
                                                     where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_km,
            --BIL utvendig
              nvl2(enhet.var_kjore_grp_seq_no,  
                   enhet.var_kjore_grp_seq_no,
                  (select 
                   var_kjore_grp.var_kjore_grp_seq_no      from var_kjore_grp,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_kjore_grp_seq_no  =var_kjore_grp.var_kjore_grp_seq_no))       as var_kjore_grp_seq_no,
              nvl2(enhet.var_kjore_grp_seq_no,  
                  (select var_kjore_grp.k_grp_id           from var_kjore_grp
                                                           where 1=1
                                                           and   enhet.var_kjore_grp_seq_no       =var_kjore_grp.var_kjore_grp_seq_no),
                  (select var_kjore_grp.k_grp_id           from var_kjore_grp,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_kjore_grp_seq_no  =var_kjore_grp.var_kjore_grp_seq_no))       as v1_k_grp_id,  --sedan, combie ...
              nvl2(enhet.var_dorer_seq_no,  
                   enhet.var_dorer_seq_no,
                  (select 
                    var_dorer.var_dorer_seq_no             from  var_dorer,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_dorer_seq_no      =var_dorer.var_dorer_seq_no))               as var_dorer_seq_no,
              nvl2(enhet.var_dorer_seq_no,  
                  (select var_dorer.dorer_id||'d'||chr(248)||'rs' from var_dorer
                                                           where 1=1
                                                           and   enhet.var_dorer_seq_no           = var_dorer.var_dorer_seq_no),
                  (select var_dorer.dorer_id||'d'||chr(248)||'rs' from var_dorer,enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                           and   prev_enhet.var_dorer_seq_no = var_dorer.var_dorer_seq_no))                   as v1_dorer_id,
              nvl2(enhet.farge_kode,
                   enhet.farge_kode,  
                  (select prev_enhet.farge_kode            from enhet prev_enhet
                                                           where 1=1
                                                           and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no))                  as v1_farge,
            --BIL v2_xxx vrak-info
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.abs_yn           ,'y','ABS',null                                                ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                          decode(enhet.abs_yn                ,'y','ABS',null                                                )                                                      )   as v2_abs,
              nvl2(enhet.servo,
                   'servostyring',  
                  (select decode(prev_enhet.servo            ,null,null,'servostyring'                                      ) from enhet prev_enhet where 1=1
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no)) as v2_servo,
              nvl2(enhet.prev_enhet_seq_no,
                   (select decode(prev_enhet.sentral_laas_yn   ,'y','sentrall'||chr(229)||'s',null                           ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.sentral_laas_yn   ,'y','sentrall'||chr(229)||'s',null                            ) )                                                     as v2_sentral_laas,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.farge_int         ,null,null,'interi'||chr(248)||'rfarge: '||prev_enhet.farge_int) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.farge_int         ,null,null,'interi'||chr(248)||'rfarge: '||enhet.farge_int ) )                                                         as v2_farge_int,        --med tekst interior
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.farge_int         ,null,null,prev_enhet.farge_int                                ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.farge_int         ,null,null,enhet.farge_int )                                  )                                                        as v2_farge_int_real,   --kun frage
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.skinn_yn        ,'y','skinn interi'||chr(248)||'r',null                        ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                              decode(enhet.skinn_yn          ,'y','skinn interi'||chr(248)||'r',null                        ) )                                                      as v2_skinn_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.setevarmere_yn   ,'y','setevarmere',null                                        ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                              decode(enhet.setevarmere_yn    ,'y','setevarmere',null                                        ) )                                                      as v2_setevarmere_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.tilhengerfeste_yn ,'y','tilhengerfeste',null                                     ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                                decode(enhet.tilhengerfeste_yn ,'y','tilhengerfeste',null                                     ) )                                                     as v2_tilhengerfeste_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.metallic_yn       ,'y','metallic-lakk',null                                      ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                                decode(enhet.metallic_yn       ,'y','metallic-lakk',null                                      ) )                                                     as v2_metallic_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.xenon_yn          ,'y','xenon-lys',null                                          ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.xenon_yn          ,'y','xenon-lys',null                                          ) )                                                      as v2_xenon_yn,
              nvl2(enhet.prev_enhet_seq_no,
                   (select decode(prev_enhet.lys              ,'y','ekstralys',null                                          ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.lys               ,'y','ekstralys',null                                          ) )                                                     as v2_lys,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.org_audio_yn      ,'y','orginal radio/cd/audio',null                             ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.org_audio_yn      ,'y','orginal radio/cd/audio',null                             ) )                                                     as v2_org_audio_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.el_speil_yn       ,'y','elektriske-speil',null                                   ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.el_speil_yn       ,'y','elektriske-speil',null                                   ) )                                                     as v2_el_speil_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.cruise_cont_yn    ,'y','cruise control',null                                     ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.cruise_cont_yn    ,'y','cruise control',null                                     ) )                                                     as v2_cruise_cont_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.kjore_comp_yn     ,'y','kj'||chr(248)||'re computer',null                        ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.kjore_comp_yn     ,'y','kj'||chr(248)||'re computer',null                        ) )                                                     as v2_kjore_comp_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.esp              ,'y','ESP',null                                                ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.esp               ,'y','ESP',null                                                ) )                                                     as v2_esp,
                                                                      --air condt.:AUT   air condt.:MAN
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.aircon           ,null,null,'air condt.:'||prev_enhet.aircon                     ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                              decode(enhet.aircon            ,null,null,'air condt.:'||enhet.aircon                          ) )                                                      as v2_aircon,
                                                                       --soltak:EL   soltak:MAN
              nvl2(enhet.prev_enhet_seq_no, 
                   (select decode(prev_enhet.soltak          ,null,null,'soltak:'||prev_enhet.soltak                         ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                               decode(enhet.soltak           ,null,null,'soltak:'||enhet.soltak                              ) )                                                     as v2_soltak,
              --2 vindusheiser   4 vindusheiser
              nvl2(enhet.prev_enhet_seq_no, 
                       decode(enhet.el_heis_yn       ,null,null,enhet.el_heis_yn||' vindusheiser'                ) ,
                       decode(enhet.el_heis_yn       ,null,null,enhet.el_heis_yn||' vindusheiser'                           ) )                                                      as v2_el_heis_yn,
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.drift          ,null,null,'f','framhjuls-drift', 
                                                                      'b', 'bakhjuls-drift',
                                                                      '4', 'firhjuls-drift'                                 ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                              decode(enhet.drift           ,null,null,'f','framhjuls-drift',
                                                                      'b', 'bakhjuls-drift',
                                                                      '4', 'firhjuls-drift'                                 ) )                                                      as v2_drift,
                                                                       --1-10  airbagger                                                                                                                                     
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.airbag_ant      ,null,null,prev_enhet.airbag_ant||' airbagger'                    ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                  decode(enhet.airbag_ant      ,null,null,enhet.airbag_ant||' airbagger'                                    ) )                                                      as v2_airbag_ant,      --med tekst
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.airbag_ant      ,null,null,prev_enhet.airbag_ant                                  ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                  decode(enhet.airbag_ant      ,null,null,enhet.airbag_ant                                  ) )                                                      as v2_airbag_ant_real, --kun tall
                                                                       --1-10  DEFEKTE airbagger                                                                                                                                     
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.airbag_def      ,null,null,prev_enhet.airbag_def||' DEFEKTE airbagger'            ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                  decode(enhet.airbag_def      ,null,null,enhet.airbag_def||' DEFEKTE airbagger'            ) )                                                      as v2_airbag_def,      --med tekst
              nvl2(enhet.prev_enhet_seq_no, 
                  (select decode(prev_enhet.airbag_def      ,null,null,prev_enhet.airbag_def                                  ) from enhet prev_enhet where 1=1 
                                                                                                                              and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no),
                  decode(enhet.airbag_def      ,null,null,enhet.airbag_def                                  ) )                                                      as v2_airbag_def_real  --kun tall
        from enhet
    /
       
------------------------------------------------------------v_bildeler_rest-----------------------------------------------------------------------------------------------------------------------------------
      create or replace view v_bildeler_rest as
        /*
                  Brukes i APEX web services testing copy v_bildeler 2015_10_14
                  enhet byttet ut med enhet_rest
                create table enhet_rest as select * from enhet
                grant all on enhet_rest to public
                */
                select 
        --ITEM..
          enhet.enhet_seq_no                                                                                                    as      enhet_seq_no,
          enhet.prev_enhet_seq_no                                                                                               as prev_enhet_seq_no,
          (select enhet_sub.enhet_sub_seq_no from enhet_sub where enhet.enhet_seq_no=enhet_sub.enhet_seq_no)                    as  enhet_sub_seq_no,
        --DEL
          enhet.vare_gruppe_seq_no                                                                                              as      vare_gruppe_seq_no,
          (select vare_gruppe.vare_gruppe_pris_info
                                               from vare_gruppe                  where 1=1
                                               and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as      vare_gruppe_pris_info,
          (select prev_enhet.vare_gruppe_seq_no  from enhet prev_enhet             where 1=1
                                                 and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_vare_gruppe_seq_no,
          (select vare_gruppe.vare_gruppe_id     from vare_gruppe                  where 1=1
                                                 and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as      vare_gruppe_id,
          (select vare_gruppe.vare_gruppe_id     from vare_gruppe,enhet prev_enhet where 1=1 
                                                 and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no 
                                                 and prev_enhet.vare_gruppe_seq_no =vare_gruppe.vare_gruppe_seq_no       )      as prev_vare_gruppe_id,
          (select f_vasket('DEL_VASKET', vare_gruppe.vare_gruppe_id)
                                                 from vare_gruppe                  where 1=1
                                                 and enhet.vare_gruppe_seq_no      =vare_gruppe.vare_gruppe_seq_no       )      as del_vasket,
        --SERIE_NO
          --NB ved sjekk varegruppe=1 her forutsetter det at kun denne kan få bruke V serien ref problem V21822 reg på varegruppe_HOLD--> ikke søkbart
          enhet.serie_seq_no                                                                                                    as      serie_seq_no,
          (select prev_enhet.serie_seq_no        from enhet prev_enhet             where 1=1
                                                 and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_serie_seq_no,
          (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                 from serie                        where 1=1
                                                 and enhet.serie_seq_no            =serie.serie_seq_no                   )      as      serie_no,
          (select decode(prev_enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                 from serie,enhet prev_enhet       where 1=1 
                                                 and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no 
                                                 and prev_enhet.serie_seq_no       =serie.serie_seq_no                   )      as prev_serie_no,
          (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no
                                                 from serie                        where 1=1
                                                 and enhet.old_serie_seq_no        =serie.serie_seq_no                   )      as  old_serie_no,
        --LOC 
          enhet.location_seq_no                                                                                                 as location_seq_no, 
          --kan underscore i location erstattes med  space slik at APEX-table html wrapping blir bedre
          (select replace( loc_id,'_',' ')       from location                     where 1=1
                                                 and enhet.location_seq_no         =location.location_seq_no             )      as loc_id,  
          (select prev_enhet.location_seq_no     from enhet prev_enhet             where 1=1
                                                 and enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no              )      as prev_location_seq_no,                                           
        --ymse
          enhet.enhet_kval_seq_no                                                                                               as enhet_kval_seq_no,            --enhet_kval_seq_no
          (select enhet_kvalitet.kval_id         from enhet_kvalitet               where 1=1
                                                 and enhet.enhet_kval_seq_no       =enhet_kvalitet.enhet_kval_seq_no     )      as kval_id,                      --kval med tekst
          --kan ha CR(0D/13) + LF (0A/10) disse byttes ut med EN space  (20/32)
          replace( replace( enhet.enhet_besk,chr(13),null),chr(10), ' ')                                                        as enhet_besk,
          replace( replace( enhet.temp,chr(13),null),chr(10), ' ')                                                              as temp,
          enhet.temp_dato                                                                                                       as temp_dato,
          enhet.dato_inn                                                                                                        as dato_inn,
          enhet.dato_ut                                                                                                         as dato_ut,
          enhet.paa_bil                                                                                                         as paa_bil,
          enhet.hold_on                                                                                                         as hold_on,
          enhet.pris_inkl_mva                                                                                                   as pris_inkl_mva,
          nvl2(enhet.miljo_klarert_id,                                                                                                    
               enhet.miljo_klarert_id,                                                                                                    
              (select prev_enhet.miljo_klarert_id from enhet prev_enhet                                                                   
                                                  where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                as miljo_klarert_id,                                          
          pris_solgt_inkl_mva,
          org_pris_inkl_mva,
          org_dato_inn,
          takst_seq_no,
          salg_via,
          salg_funnet,
          --db_katalog
          --endring
          --pris_4021
          --date_4021
          --old_dato_inn
          --old_dato_ut
          --reprod_2013_04_21
          --nvl2(karroseribyttebiler,'j','n')karroseribyttebiler,
        ---oem nr etc
          --kan ha CR(0D/13) + LF (0A/10) disse byttes ut med EN space  (20/32)
          oem_maker                                                                                                                       as oem,
          replace( replace( prod_nr,chr(13),null),chr(10), ' ')                                                                           as nr_oem,             --LEV i bildeler prog (ikke dynamo!!)
          enhet.vendor_data_seq_no                                                                                                        as vendor_data_seq_no,
          (select vendor_data_no                  from vendor_data      
                                                 where enhet.vendor_data_seq_no      =vendor_data.vendor_data_seq_no)                     as nr_bytte_nr_vendor, --Nr på del i bildel prog (start,dyn,servo-p,tannstang,ac-komp,calip))
          merke_nr                                                                                                                        as nr_bytte_nr,        --utgått kan evnt brukes til bytte_nr i stede for vendor
        --MOTOR (nbk,mevca)
          nvl2(enhet.var_motor_type_seq_no,  
               enhet.var_motor_type_seq_no,
              (select 
                 var_motor_type.var_motor_type_seq_no  from var_motor_type,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as var_motor_type_seq_no,
          nvl2(enhet.var_motor_type_seq_no,  
              (select var_motor_type.motor_type_id     from var_motor_type
                                                       where 1=1
                                                       and   enhet.var_motor_type_seq_no      =var_motor_type.var_motor_type_seq_no),
              (select var_motor_type.motor_type_id     from var_motor_type,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as motor_type_id,
          nvl2(enhet.var_motor_type_seq_no,  
              (select var_motor_type.motor_type_besk   from var_motor_type
                                                       where 1=1
                                                       and   enhet.var_motor_type_seq_no      =var_motor_type.var_motor_type_seq_no),
              (select var_motor_type.motor_type_besk   from var_motor_type,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_motor_type_seq_no =var_motor_type.var_motor_type_seq_no))     as motor_type_besk,
          nvl2(enhet.var_motor_volum_seq_no,  
               enhet.var_motor_volum_seq_no,
              (select 
               var_motor_volum.var_motor_volum_seq_no  from var_motor_volum,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_motor_volum_seq_no =var_motor_volum.var_motor_volum_seq_no))   as var_motor_volum_seq_no,
          nvl2(enhet.var_motor_volum_seq_no,  
              (select nvl2(var_motor_volum.motor_vol_id,trim(var_motor_volum.motor_vol_id)||'l',null) 
                                                      from var_motor_volum
                                                       where 1=1
                                                       and   enhet.var_motor_volum_seq_no     =var_motor_volum.var_motor_volum_seq_no),
              (select nvl2(var_motor_volum.motor_vol_id,trim(var_motor_volum.motor_vol_id)||'l',null) 
                                                       from var_motor_volum,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_motor_volum_seq_no=var_motor_volum.var_motor_volum_seq_no))   as motor_vol_id,
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.hk,enhet_sub.hk||'hk',null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.hk,enhet_sub.hk||'hk',null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as motor_hk,        --med hk
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.hk,enhet_sub.hk,null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.hk,enhet_sub.hk,null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as motor_hk_real,   --kun tall
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.motor_kode,enhet_sub.motor_kode,null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.motor_kode,enhet_sub.motor_kode,null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as motor_kode,
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.motor_test,enhet_sub.motor_test,null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.motor_test,enhet_sub.motor_test,null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as motor_test,
        --GEAR  (gearkode  vognklort avlesing  hva med vognkort)
          nvl2(enhet.gear_type,
               enhet.gear_type,  
              (select prev_enhet.gear_type             from enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no))                  as gear_type,
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.gear_kode,enhet_sub.gear_kode,null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.gear_kode,enhet_sub.gear_kode,null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as gear_kode,
          nvl2(enhet.prev_enhet_seq_no, 
              (select nvl2(enhet_sub.gear_test,enhet_sub.gear_test,null)
                                                       from enhet_sub,enhet prev_enhet
                                                       where 1=1
                                                       and enhet.prev_enhet_seq_no            =prev_enhet.enhet_seq_no 
                                                       and prev_enhet.enhet_seq_no            =enhet_sub.enhet_seq_no),
              (select nvl2(enhet_sub.gear_test,enhet_sub.gear_test,null)
                                                       from enhet_sub
                                                       where 1=1
                                                       and enhet.enhet_seq_no                 =enhet_sub.enhet_seq_no))                   as gear_test,
        --Informasjon som ALLTID skal hentes fra overordnet del                                                                                                                                    
        --dersom var_bil_seq_no er null
        --nvl2 (xxxx, xxx finnes ,  xxx fra prev)                                                                                                                                                            
        --BIL v0_xxx
          nvl2(enhet.var_bil_seq_no,  
               enhet.var_bil_seq_no,
              (select prev_enhet.var_bil_seq_no  from enhet prev_enhet 
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v0_var_bil_seq_no,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select var_bil_scope.var_bil_scope_seq_no
                                                 from var_bil_scope,var_bil                                                     
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+) ),             
              (select var_bil_scope.var_bil_scope_seq_no                                                                                  
                                                 from var_bil_scope,var_bil,enhet prev_enhet                                    
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+) ) )          as v0_var_bil_scope_seq_no,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select type_klasse                from type,var_bil                                                                        
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.type_seq_no             =type.type_seq_no),                                  
              (select type_klasse                from type,var_bil,enhet prev_enhet                                                       
                                                 where 1=1                                                                                
                                                 and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_type_klasse,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select fabrikant.fab_navn         from fabrikant,var_bil                                                                   
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.fab_seq_no              =fabrikant.fab_seq_no),                              
              (select fabrikant.fab_navn         from fabrikant,var_bil,enhet prev_enhet                                                  
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.fab_seq_no              =fabrikant.fab_seq_no))                               as v0_fab_navn,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select f_vasket('MERKE_VASKET',fab_navn) from fabrikant,var_bil                                                            
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.fab_seq_no              =fabrikant.fab_seq_no),                              
              (select f_vasket('MERKE_VASKET',fab_navn) from fabrikant,var_bil,enhet prev_enhet                                           
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.fab_seq_no              =fabrikant.fab_seq_no))                              as v0_merke_vasket,  --fab_navn
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select type.type_id               from type,var_bil                                                                        
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.type_seq_no             =type.type_seq_no),                                  
              (select type.type_id               from type,var_bil,enhet prev_enhet                                                       
                                                 where 1=1                                                                                
                                                 and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_type_id,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select f_vasket('MODELL_VASKET',type_id) from type,var_bil                                                                 
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.type_seq_no             =type.type_seq_no),                                  
              (select f_vasket('MODELL_VASKET',type_id) from type,var_bil,enhet prev_enhet                                                
                                                  where 1=1                                                                               
                                                 and   enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and   var_bil.type_seq_no           =type.type_seq_no))                                  as v0_modell_vasket, --type_id
          --legges inn for å muliggjør søk på LBK merke Mercedez eks W123 ,
          --alle var_bil_seq_no finnes i v_var_bil select var_bil_seq_no from var_bil minus select obv_var_bil_seq_no from v_var_bil  
          --
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select v_var_bil.lbk
                                                 from v_var_bil                                                     
                                                 where 1=1
                                                 and enhet.var_bil_seq_no            =v_var_bil.var_bil_seq_no            ),             
              (select v_var_bil.lbk                                                                                 
                                                 from v_var_bil,enhet prev_enhet                                    
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no  
                                                 --linje under ble glemt frem til 2014_04_11 samrt at var_bil tabellen fra med i from ...listingen
                                                 and prev_enhet.var_bil_seq_no       =v_var_bil.var_bil_seq_no))                       as v0_lbk_type,                                         
          nvl2(enhet.var_bil_seq_no,                                                                                                           
               enhet.betegnelse,                                                                                                          
              (select prev_enhet.betegnelse      from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v0_betegnelse,
          --chr(229)||'rsmodell:'||
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select nvl2(aar_model.aar,to_char(aar_model.aar,'yyyy'),null) 
                                                from aar_model,var_bil                                                                
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
              (select nvl2(aar_model.aar,to_char(aar_model.aar,'yyyy'),null) 
                                                 from aar_model,var_bil,enhet prev_enhet                                               
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_aar,
          --2013_08_25 må bruker outer join på scope får å få frem default aar dersom scope mangler                                       
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                          to_char(aar_model.aar,'yyyy'))                                                                                  
                                                 from var_bil_scope,aar_model,var_bil                                                     
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
              (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                          to_char(aar_model.aar,'yyyy'))                                                                                  
                                                 from var_bil_scope,aar_model,var_bil,enhet prev_enhet                                    
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_scope,
          nvl2(enhet.var_bil_seq_no,                                                                                                      
              (select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                   
                                to_char(aar_model.aar,'yyyy')))                                                                           
                                                 from var_bil_scope,aar_model,var_bil                                                     
                                                 where 1=1                                                                                
                                                 and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
              (select f_vasket('SCOPE_VASKET',nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                   
                                to_char(aar_model.aar,'yyyy')))                                                                           
                                                 from var_bil_scope,aar_model,var_bil,enhet prev_enhet                                    
                                                 where 1=1                                                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                 and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                 and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as v0_scope_vasket,
        --BIL v1_xxx
          nvl2(enhet.reg_no,                                                                                                              
               enhet.reg_no,                                                                                                              
              (select prev_enhet.reg_no          from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_reg_no,
          nvl2(enhet.prev_enhet_seq_no,                                                                                                   
              (select decode(enhet_sub.brukt_imp_yn,'y','brukt importert',null)                                                          
                                                 from enhet_sub,enhet prev_enhet where 1=1                                                
                                                 and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                 and prev_enhet.enhet_seq_no         =enhet_sub.enhet_seq_no),                            
              (select decode(enhet_sub.brukt_imp_yn,'y','brukt importert',null)                                                          
                                                 from enhet_sub where 1=1                                                                 
                                                 and enhet.enhet_seq_no              =enhet_sub.enhet_seq_no))                            as v1_brukt_imp_yn,
          nvl2(enhet.chassis_no,                                                                                                          
               enhet.chassis_no,                                                                                                          
              (select prev_enhet.chassis_no      from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_chassis_no,
          nvl2(enhet.tecdoc_id,                                                                                                           
               enhet.tecdoc_id,                                                                                                           
              (select prev_enhet.tecdoc_id       from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_tecdoc_id,
          nvl2(enhet.tecdoc_besk,                                                                                                         
               enhet.tecdoc_besk,                                                                                                         
              (select prev_enhet.tecdoc_besk     from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_tecdoc_besk,
          nvl2(enhet.km,                                                                                                                  
               enhet.km,                                                                                                                  
              (select prev_enhet.km              from enhet prev_enhet                                                                    
                                                 where enhet.prev_enhet_seq_no       =prev_enhet.enhet_seq_no))                           as v1_km,
        --BIL utvendig
          nvl2(enhet.var_kjore_grp_seq_no,  
               enhet.var_kjore_grp_seq_no,
              (select 
               var_kjore_grp.var_kjore_grp_seq_no      from var_kjore_grp,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_kjore_grp_seq_no  =var_kjore_grp.var_kjore_grp_seq_no))       as var_kjore_grp_seq_no,
          nvl2(enhet.var_kjore_grp_seq_no,  
              (select var_kjore_grp.k_grp_id           from var_kjore_grp
                                                       where 1=1
                                                       and   enhet.var_kjore_grp_seq_no       =var_kjore_grp.var_kjore_grp_seq_no),
              (select var_kjore_grp.k_grp_id           from var_kjore_grp,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_kjore_grp_seq_no  =var_kjore_grp.var_kjore_grp_seq_no))       as v1_k_grp_id,  --sedan, combie ...
          nvl2(enhet.var_dorer_seq_no,  
               enhet.var_dorer_seq_no,
              (select 
                var_dorer.var_dorer_seq_no             from  var_dorer,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_dorer_seq_no      =var_dorer.var_dorer_seq_no))               as var_dorer_seq_no,
          nvl2(enhet.var_dorer_seq_no,  
              (select var_dorer.dorer_id||'d'||chr(248)||'rs' from var_dorer
                                                       where 1=1
                                                       and   enhet.var_dorer_seq_no           = var_dorer.var_dorer_seq_no),
              (select var_dorer.dorer_id||'d'||chr(248)||'rs' from var_dorer,enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no 
                                                       and   prev_enhet.var_dorer_seq_no = var_dorer.var_dorer_seq_no))                   as v1_dorer_id,
          nvl2(enhet.farge_kode,
               enhet.farge_kode,  
              (select prev_enhet.farge_kode            from enhet prev_enhet
                                                       where 1=1
                                                       and   enhet.prev_enhet_seq_no          =prev_enhet.enhet_seq_no))                  as v1_farge,
        --BIL v2_xxx vrak-info
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.abs_yn            ,'y','ABS',null                                                ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.abs_yn            ,'y','ABS',null                                                ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))   as v2_abs,
          nvl2(enhet.servo,
               'servostyring',  
              (select decode(prev_enhet.servo            ,null,null,'servostyring'                                      ) from enhet prev_enhet where 1=1
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no)) as v2_servo,
          nvl2(enhet.prev_enhet_seq_no,
              (select decode(enhet_sub.sentral_laas_yn   ,'y','sentrall'||chr(229)||'s',null                            ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.sentral_laas_yn   ,'y','sentrall'||chr(229)||'s',null                            ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_sentral_laas,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.farge_int         ,null,null,'interi'||chr(248)||'rfarge: '||enhet_sub.farge_int ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.farge_int         ,null,null,'interi'||chr(248)||'rfarge: '||enhet_sub.farge_int ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_farge_int,        --med tekst interior
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.farge_int         ,null,null,enhet_sub.farge_int )                                 from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.farge_int         ,null,null,enhet_sub.farge_int )                                 from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_farge_int_real,   --kun frage
          nvl2(enhet.prev_enhet_seq_no, 
               (select decode(enhet_sub.skinn_yn         ,'y','skinn interi'||chr(248)||'r',null                        ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.skinn_yn          ,'y','skinn interi'||chr(248)||'r',null                        ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_skinn_yn,
          nvl2(enhet.prev_enhet_seq_no, 
               (select decode(enhet_sub.setevarmere_yn   ,'y','setevarmere',null                                        ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.setevarmere_yn    ,'y','setevarmere',null                                        ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_setevarmere_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.tilhengerfeste_yn ,'y','tilhengerfeste',null                                     ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.tilhengerfeste_yn ,'y','tilhengerfeste',null                                     ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_tilhengerfeste_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.metallic_yn       ,'y','metallic-lakk',null                                      ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.metallic_yn       ,'y','metallic-lakk',null                                      ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_metallic_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.xenon_yn          ,'y','xenon-lys',null                                          ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.xenon_yn          ,'y','xenon-lys',null                                          ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_xenon_yn,
          nvl2(enhet.prev_enhet_seq_no,
              (select decode(enhet_sub.lys               ,'y','ekstralys',null                                          ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.lys               ,'y','ekstralys',null                                          ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_lys,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.org_audio_yn      ,'y','orginal radio/cd/audio',null                             ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.org_audio_yn      ,'y','orginal radio/cd/audio',null                             ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_org_audio_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.el_speil_yn       ,'y','elektriske-speil',null                                   ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.el_speil_yn       ,'y','elektriske-speil',null                                   ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_el_speil_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.cruise_cont_yn    ,'y','cruise control',null                                     ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.cruise_cont_yn    ,'y','cruise control',null                                     ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_cruise_cont_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.kjore_comp_yn     ,'y','kj'||chr(248)||'re computer',null                        ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.kjore_comp_yn     ,'y','kj'||chr(248)||'re computer',null                        ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_kjore_comp_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.esp               ,'y','ESP',null                                                ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.esp               ,'y','ESP',null                                                ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_esp,
                                                                  --air condt.:AUT   air condt.:MAN
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.aircon            ,null,null,'air condt.:'||enhet_sub.aircon                     ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.aircon            ,null,null,'air condt.:'||enhet_sub.aircon                     ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_aircon,
                                                                   --soltak:EL   soltak:MAN
          nvl2(enhet.prev_enhet_seq_no, 
               (select decode(enhet_sub.soltak           ,null,null,'soltak:'||enhet_sub.soltak                         ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.soltak            ,null,null,'soltak:'||enhet_sub.soltak                         ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_soltak,
                                                                   --2 vindusheiser   4 vindusheiser
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.el_heis_yn       ,null,null,enhet_sub.el_heis_yn||' vindusheiser'                ) from enhet_sub,enhet prev_enhet where 1=1 
                                         and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.el_heis_yn       ,null,null,enhet_sub.el_heis_yn||' vindusheiser'                ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_el_heis_yn,
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.drift           ,null,null,'f','framhjuls-drift', 
                                                                  'b', 'bakhjuls-drift',
                                                                  '4', 'firhjuls-drift'                                 ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.drift           ,null,null,'f','framhjuls-drift',
                                                                  'b', 'bakhjuls-drift',
                                                                  '4', 'firhjuls-drift'                                 ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_drift,
                                                                   --1-10  airbagger                                                                                                                                     
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.airbag_ant      ,null,null,enhet_sub.airbag_ant||' airbagger'                    ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.airbag_ant      ,null,null,enhet_sub.airbag_ant||' airbagger'                    ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_airbag_ant,      --med tekst
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.airbag_ant      ,null,null,enhet_sub.airbag_ant                                  ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.airbag_ant      ,null,null,enhet_sub.airbag_ant                                  ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_airbag_ant_real, --kun tall
                                                                   --1-10  DEFEKTE airbagger                                                                                                                                     
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.airbag_def      ,null,null,enhet_sub.airbag_def||' DEFEKTE airbagger'            ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.airbag_def      ,null,null,enhet_sub.airbag_def||' DEFEKTE airbagger'            ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_airbag_def,      --med tekst
          nvl2(enhet.prev_enhet_seq_no, 
              (select decode(enhet_sub.airbag_def      ,null,null,enhet_sub.airbag_def                                  ) from enhet_sub,enhet prev_enhet where 1=1 
                                                                                                                          and enhet.prev_enhet_seq_no =prev_enhet.enhet_seq_no 
                                                                                                                          and prev_enhet.enhet_seq_no =enhet_sub.enhet_seq_no),
              (select decode(enhet_sub.airbag_def      ,null,null,enhet_sub.airbag_def                                  ) from enhet_sub where 1=1 
                                                                                                                          and enhet.enhet_seq_no      =enhet_sub.enhet_seq_no))  as v2_airbag_def_real  --kun tall
                from enhet_rest enhet
                /
                grant select on v_bildeler_rest to public;
      
          --nbf, LBK TRIX
            select count(*) from v_map_obas_lbk;
              --19550
            select count(*) from v_map_obas_nbf;
              --20749
            select count(*) from v_bildeler;
            
            D25931 104979
      
      
      
          --truncate table plan_table;
            explain plan set statement_id='733_b' into plan_table for 
            select * from ola.v_t_bildeler where 1=1
            and upper(vare_gruppe_id)like '%SAAB%';
            commit;
      
          --dill  
            select 
            (select count(*) from     enhet)                 enhet,
            (select count(*) from   v_enhet2)              v_enhet2,        -- ERSTATTER V_ENHET_FULL (som har 8 table scan, denne har 1
            (select count(*) from   t_enhet2)              t_enhet2,        -->>>> html_ok='ja'               <<<<--- fram v_map_status
            (select count(*) from   t_enhet2_full)         t_enhet2_full,   -->>>> location_seq_no is not null<<<<---
            --(select count(*) from v_t_enhet2_full)       v_t_enhet2_full,   -- TB undo when modell_vasket like 'A1-%' then 'A1' osv
            --
            (select count(*) from    v_bildeler)         v_bildeler,        -- direkte fra enhet
            (select count(*) from mv_v_bildeler)        mv_bildeler,  
            (select count(*) from    v_bildeler_apex)    v_bildeler_apex,   -- fra v_bildeler
            (select count(*) from mv_v_bildeler_apex) mv_v_bildeler_apex,   -->>>> c011_location_seq_no is not null or c019_paa_bil ='J' <<<<--
            --
            (select count(*) from v_enhet_master)        v_enhet_master,
            (select count(*) from v_enhet_master_apex)   v_enhet_master_apex 
            from  dual;
            
                 ENHET   V_ENHET2   T_ENHET2 T_ENHET2_FULL V_T_ENHET2_FULL V_BILDELER MV_BILDELER V_BILDELER_APEX MV_V_BILDELER_APEX V_ENHET_MASTER V_ENHET_MASTER_APEX
            ---------- ---------- ---------- ------------- --------------- ---------- ----------- --------------- ------------------ -------------- -------------------
               111654     111654      21064         21322           21322     111654       111654          111654              21475         111654              111654       
               113287     113287      21010         21252                     113287       111654          113287              20984         113287              113287  <<--6.10.15
               113357     113357      21010         21252                     113357      111654           113357              21031         113357              113357  <<--7.10.15
      
------------------------------------------------------------v_bildeler_apex-----------------------------------------------------------------------------------------------------------------------------------
      create or replace view v_bildeler_apex as
        /*
          ---------<<<<<<husk INSTEAD OF TRIGGEREN >>>>>>>>>>>>>>>>>>>>>>>-------------------
          -----------------------------------------------------------------------------------
          Brukes i APEX bilde 205 søk på del/vrak..... men som  MV_V_BILDELER_APEX
          NBNB   <-----------oppdater materialized view ola.mv_v_bildeler_apex ved endringer ---->
          2014_02_17 laget som kopi av v_enhet2  
          2014_02_25 fikset Valldal vinterferie
          2014_05_25 lagt inn v0_var_bil_scope_seq_no
          2014_10_26 lagt inn to_char på c043_v0_var_bil_seq_no slik at creat_coll har identiske number/varcahr mellom v_emnet_master_apex og v_bildeler_apex
        */
        select 
          enhet_seq_no                              as  c002_enhet_seq_no,            --brukes APEX                                      
          prev_enhet_seq_no                         as  c003_prev_enhet_seq_no,                                                          
          vare_gruppe_seq_no                        as  c004_vare_gruppe_seq_no,      --brukes APEX                                      
          vare_gruppe_id                            as  c005_vare_gruppe_id,                              --1  vises i bilde 205 APEX    
          prev_vare_gruppe_id                       as  c006_prev_vare_gruppe_id,                                                        
          serie_seq_no                              as  c007_serie_seq_no,                                                               
          serie_no                                  as  c008_serie_no,                                    --3  vises i bilde 205 APEX    
          prev_serie_no                             as  c009_prev_serie_no,                                                              
          old_serie_no                              as  c010_old_serie_no,                                                               
          location_seq_no                           as  c011_location_seq_no,                                                            
          loc_id                                    as  c012_loc_id,                                      --4  vises i bilde 205 APEX    
          kval_id                                   as  c013_kval_id,                                                                    
          enhet_besk                                as  c014_enhet_besk,                                  --5  vises i bilde 205 APEX    
          temp                                      as  c015_temp,                                        --6  vises i bilde 205 APEX    
          temp_dato                                 as  c016_temp_dato,                                                                  
          dato_inn                                  as  c017_dato_inn,                                                                   
          dato_ut                                   as  c018_dato_ut,                                                                    
          paa_bil                                   as  c019_paa_bil,                                                                    
          hold_on                                   as  c020_hold_on,                                                                    
          pris_inkl_mva                             as  c021_pris_inkl_mva,                               --7  vises i bilde 205 APEX    
          miljo_klarert_id                          as  c022_miljo_klarert_id,                                                           
          pris_solgt_inkl_mva                       as  c023_pris_solgt_inkl_mva,                                                        
          salg_via                                  as  c024_salg_via,                                                                   
          salg_funnet                               as  c025_salg_funnet,                                                                
          org_pris_inkl_mva                         as  c026_org_pris_inkl_mva,                                                          
          org_dato_inn                              as  c027_org_dato_inn,                                                               
          takst_seq_no                              as  c028_takst_seq_no,                                                               
          0                                         as  c029_fab_seq_no,
          0                                         as  c030_type_seq_no,
          v0_var_bil_scope_seq_no                   as  c031_var_bil_scope_seq_no,
          v1_reg_no                                 as  c032_reg_no,
          -------------------  
          ' ' c033,' ' c034,' ' c035,' ' c036,' ' c037,' ' c038,' ' c039,
          -------------------
          nvl2(nr_oem             ,                                                                                    nr_oem             , null              ) ||
          nvl2(nr_bytte_nr_vendor ,nvl2(nr_oem                                                           , ', ',null)||nr_bytte_nr_vendor , nr_bytte_nr_vendor) ||
          nvl2(nr_bytte_nr        ,nvl2(nr_oem||nr_bytte_nr_vendor                                       , ', ',null)||nr_bytte_nr        , nr_bytte_nr       )      
                                                     as c040_nr,
          -------------------------------------------                                                                            
          nvl2(motor_type_besk    ,                                                                                    motor_type_besk    , null              ) ||
          nvl2(motor_vol_id       ,nvl2(motor_type_besk                                                  , '  ' ,null)||motor_vol_id      , motor_vol_id      ) ||
          nvl2(motor_hk           ,nvl2(motor_type_besk||motor_vol_id                                    , '  ' ,null)||motor_hk          , motor_hk          ) ||
          nvl2(motor_kode         ,nvl2(motor_type_besk||motor_vol_id||motor_hk                          , '  ' ,null)||motor_kode        , motor_kode        ) ||
          nvl2(motor_test         ,nvl2(motor_type_besk||motor_vol_id||motor_hk||motor_kode              , '  ' ,null)||motor_test        , motor_test        )     
                                                     as c041_motor,
          -------------------------------------------                                                                            
          nvl2(gear_type          ,                                                                                    gear_type          , null              ) ||
          nvl2(gear_kode          ,nvl2(gear_type                                                        , '  ',null)||gear_kode          , gear_kode         ) ||
          nvl2(gear_test          ,nvl2(gear_type||gear_kode                                             , '  ',null)||gear_test          , gear_test         )     
                                                     as c042_gear,
          -------------------------------------------                                                                              
          to_char(v0_var_bil_seq_no)                 as c043_v0_var_bil_seq_no,
          nvl2(v0_type_klasse     ,                                                                                     v0_type_klasse    , null              ) ||
          nvl2(v0_fab_navn        ,nvl2(v0_type_klasse                                                   , '  ' ,null)||v0_fab_navn       , v0_fab_navn       ) ||
          nvl2(v0_type_id         ,nvl2(v0_type_klasse||v0_fab_navn                                      , '  ' ,null)||v0_type_id        , v0_type_id        ) ||
          nvl2(v0_betegnelse      ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id                          , '  ' ,null)||v0_betegnelse     , v0_betegnelse     ) ||
          nvl2(v0_scope           ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id||v0_betegnelse           , '  ' ,null)||v0_scope          , v0_scope          ) ||
          nvl2(v0_aar             ,nvl2(v0_type_klasse||v0_fab_navn||v0_type_id||v0_betegnelse||v0_scope , '  ' ,null)||v0_aar            , v0_aar            )     
                                                     as c044_v0_info,
          ------------------------------------------   
          nvl2(prev_serie_no   ,                                                                                                                                            prev_serie_no  , null            ) ||
          nvl2(v1_reg_no       ,nvl2(prev_serie_no                                                                                                           , '  ' ,null)||v1_reg_no      , v1_reg_no       ) ||
          nvl2(v1_brukt_imp_yn ,nvl2(prev_serie_no||v1_reg_no                                                                                                , '  ' ,null)||v1_brukt_imp_yn, v1_brukt_imp_yn ) ||
          nvl2(v1_chassis_no   ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn                                                                               , '  ' ,null)||v1_chassis_no  , v1_chassis_no   ) ||
          nvl2(v1_tecdoc_id    ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no                                                                , '  ' ,null)||v1_tecdoc_id   , v1_tecdoc_id    ) ||
          nvl2(v1_tecdoc_besk  ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id                                                  , '  ' ,null)||v1_tecdoc_besk , v1_tecdoc_besk  ) ||
          nvl2(v1_km           ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk                                  , '  ' ,null)||v1_km          , v1_km           ) ||
          nvl2(v1_k_grp_id     ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km                           , '  ' ,null)||v1_km          , v1_km           ) ||
          nvl2(v1_dorer_id     ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km||v1_k_grp_id              , '  ' ,null)||v1_dorer_id    , v1_dorer_id     ) ||
          nvl2(v1_farge        ,nvl2(prev_serie_no||v1_reg_no||v1_brukt_imp_yn||v1_chassis_no||v1_tecdoc_id||v1_tecdoc_besk||v1_km||v1_k_grp_id||v1_dorer_id , '  ' ,null)||v1_farge       , v1_farge        )     
                                                    as c045_v1_info,  
          ------------------------------------------                                                                            
          nvl2(v2_abs               ,                                                                                                                          v2_abs               , null                 ) ||
          nvl2(v2_servo             ,nvl2(v2_abs                                                                                                , '  ' ,null)||v2_servo             , v2_servo             ) ||
          nvl2(v2_sentral_laas      ,nvl2(v2_abs||v2_servo                                                                                      , '  ' ,null)||v2_sentral_laas      , v2_sentral_laas      ) ||
          nvl2(v2_farge_int         ,nvl2(v2_abs||v2_servo||v2_sentral_laas                                                                     , '  ' ,null)||v2_farge_int         , v2_farge_int         ) ||
          nvl2(v2_skinn_yn          ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int                                                       , '  ' ,null)||v2_skinn_yn          , v2_skinn_yn          ) ||
          nvl2(v2_setevarmere_yn    ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn                                          , '  ' ,null)||v2_setevarmere_yn    , v2_setevarmere_yn    ) ||
          nvl2(v2_tilhengerfeste_yn ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn||v2_setevarmere_yn                       , '  ' ,null)||v2_tilhengerfeste_yn , v2_tilhengerfeste_yn ) ||
          nvl2(v2_metallic_yn       ,nvl2(v2_abs||v2_servo||v2_sentral_laas||v2_farge_int||v2_skinn_yn||v2_setevarmere_yn||v2_tilhengerfeste_yn , '  ' ,null)||v2_metallic_yn       , v2_metallic_yn       )     
                                                      as c046_v2_info_a,
          --------------------------------------------                                                                            
          nvl2(v2_xenon_yn          ,                                                                                                                          v2_xenon_yn          , null                 ) ||
          nvl2(v2_lys               ,nvl2(v2_xenon_yn                                                                                           , '  ' ,null)||v2_lys               , v2_lys               ) ||
          nvl2(v2_org_audio_yn      ,nvl2(v2_xenon_yn||v2_lys                                                                                   , '  ' ,null)||v2_org_audio_yn      , v2_org_audio_yn      ) ||
          nvl2(v2_el_speil_yn       ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn                                                                  , '  ' ,null)||v2_el_speil_yn       , v2_el_speil_yn       ) ||
          nvl2(v2_cruise_cont_yn    ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn                                                  , '  ' ,null)||v2_cruise_cont_yn    , v2_cruise_cont_yn    ) ||
          nvl2(v2_kjore_comp_yn     ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn                               , '  ' ,null)||v2_kjore_comp_yn     , v2_kjore_comp_yn     ) ||
          nvl2(v2_esp               ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn||v2_kjore_comp_yn             , '  ' ,null)||v2_esp               , v2_esp               ) ||
          nvl2(v2_aircon            ,nvl2(v2_xenon_yn||v2_lys||v2_org_audio_yn||v2_el_speil_yn||v2_cruise_cont_yn||v2_kjore_comp_yn||v2_esp     , '  ' ,null)||v2_aircon            , v2_aircon            )     
                                                     as c047_v2_info_b,
          -------------------------------------------                                                                            
          nvl2(v2_soltak            ,                                                                                                                          v2_soltak            , null                 ) ||
          nvl2(v2_el_heis_yn        ,nvl2(v2_soltak                                                                                             , '  ' ,null)||v2_el_heis_yn        , v2_el_heis_yn        ) ||
          nvl2(v2_drift             ,nvl2(v2_soltak||v2_el_heis_yn                                                                              , '  ' ,null)||v2_drift             , v2_drift             ) ||
          nvl2(v2_airbag_ant        ,nvl2(v2_soltak||v2_el_heis_yn||v2_drift                                                                    , '  ' ,null)||v2_airbag_ant        , v2_airbag_ant        ) ||
          nvl2(v2_airbag_def        ,nvl2(v2_soltak||v2_el_heis_yn||v2_drift||v2_airbag_ant                                                     , '  ' ,null)||v2_airbag_def        , v2_airbag_def        )    
                                                        as c048_v2_info_c,
          ' '                                           as c049,
          ' '                                           as c050
        from v_bildeler
        /  
        
    
    
        --dill
          select count(*) from v_bildeler_apex;
          --103 289
          
          
          --spesial uttrekk med ymse deler
          WHERE (V_BILDELER.ENHET_SEQ_NO=200641) OR (V_BILDELER.ENHET_SEQ_NO=201464) OR (V_BILDELER.ENHET_SEQ_NO=2378) OR (V_BILDELER.ENHET_SEQ_NO=32617) OR (V_BILDELER.ENHET_SEQ_NO=41441)
          
          --APEX
          select * from ola.v_bildeler_apex where 1=1
          and upper(vare_gruppe_id)||upper(v0_info)||upper(v1_info) like '%SAAB%'
          order by v0_info ,vare_gruppe_id;                             
          
          
          select count(*) from v_bildeler where v_abs like '%A%';
          select count(*) from mv_v_bildeler where v_abs like '%A%';
          
          
          select count(*) from v_bildeler;
          --99 612
          
          --truncate table plan_table;
          truncate table plan_table;
          explain plan set statement_id='733' into plan_table for 
          select * from v_bildeler;
          commit;
          
          select reg_no from v_bildeler where reg_no like '%SC%';
          
          truncate table plan_table;
          explain plan set statement_id='733' into plan_table for 
          select count(*) from v_bildeler where v_abs like '%A%';
          commit;
          
          truncate table plan_table;
          explain plan set statement_id='733' into plan_table for 
          select * from ola.v_bildeler_apex where 1=1
          and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c045_v1_info) like '%SAAB%';
          commit;
          --truncate table plan_table;
          explain plan set statement_id='733_b' into plan_table for 
          select * from ola.v_bildeler_apex where 1=1
          and upper(vare_gruppe_id)||upper(v0_info)like '%SAAB%';
          commit;
          explain plan set statement_id='733_c' into plan_table for 
          select * from ola.mv_v_bildeler_apex where 1=1
          and upper(vare_gruppe_id)||upper(v0_info)||upper(v1_info) like '%SAAB%';
----------------------------------------------------------- v_bilreg_data -----------------------------------------------------------------------------------------------
    create or replace view v_bilreg_data as
        select 
            --enhet seq
                 enhet.enhet_seq_no
                ,enhet.var_bil_seq_no
                ,enhet.var_kjore_grp_seq_no
                ,enhet.var_motor_type_seq_no
                ,enhet.var_motor_volum_seq_no
                ,enhet.location_seq_no
            --enhet_sub_seq
                ,enhet_sub_seq_no
            --var_bil_seq
                ,var_bil.fab_seq_no
                ,var_bil.type_seq_no
                ,var_bil.aar_seq_no
                ,var_bil.var_bil_scope_seq_no
            --enhet
                ,km                      
                ,Reg_no                  
                ,tecdoc_id               
                ,tecdoc_besk             
                ,Chassis_no              
                ,farge_kode              
                ,miljo_klarert_id        
                ,dato_inn                
                ,dato_ut                 
                ,servo                   
                ,gear_type               
            --var_kjore_grp
                ,var_kjore_grp.k_grp_id
            --var_motor_type
                ,var_motor_type.motor_type_id
                ,var_motor_type.motor_type_besk
            --var_motor_volum
                ,var_motor_volum.motor_vol_id
            --location
                ,location.loc_id
            --scope
                ,scope_start
                ,scope_stop
            --var_dorer
                ,dorer_id
            --fabrikant
                ,fab_navn
            --type
                ,type_id
            --årsmodell
                ,aar
            --enhet sub
                ,abs_yn
                ,sentral_laas_yn
                ,skinn_yn
                ,tilhengerfeste_yn
                ,metallic_yn
                ,cruise_cont_yn
                ,kjore_comp_yn
                ,setevarmere_yn
                ,xenon_yn
                ,org_audio_yn
                ,brukt_imp_yn
                ,el_speil_yn
                ,el_speil_ant
                ,aircon
                ,soltak
                ,lys
                ,farge_int
                ,motor_kode
                ,gear_kode
                ,hk
                ,in_date
                ,motor_test
                ,gear_test
                ,el_heis_yn
                ,drift
                ,airbag_ant
                ,airbag_def
                ,esp
                ,batteri_kwh
        from ola.enhet           enhet,
             ola.var_bil         var_bil,
             ola.var_kjore_grp   var_kjore_grp,
             ola.var_motor_type  var_motor_type,
             ola.var_motor_volum var_motor_volum,
             ola.location        location,
             ola.var_dorer       var_dorer,
             ola.fabrikant       fabrikant,
             ola.type            type,
             ola.aar_model       aar_model,
             ola.enhet_sub       enhet_sub,
             ola.var_bil_scope   var_bil_scope
        where 1=1
            and enhet.var_bil_seq_no            = var_bil.var_bil_seq_no
            and enhet.var_kjore_grp_seq_no      = var_kjore_grp.var_kjore_grp_seq_no    (+)
            and enhet.var_motor_type_seq_no     = var_motor_type.var_motor_type_seq_no  (+)
            and enhet.location_seq_no           = location.location_seq_no              (+)
            and enhet.var_dorer_seq_no          = var_dorer.var_dorer_seq_no            (+)
            and var_bil.fab_seq_no              = fabrikant.fab_seq_no                  (+)
            and var_bil.type_seq_no             = type.type_seq_no                      (+)
            and var_bil.aar_seq_no              = aar_model.aar_seq_no                  (+)
            and enhet.enhet_seq_no              = enhet_sub.enhet_seq_no                (+)
            and var_bil.var_bil_scope_seq_no    = var_bil_scope.var_bil_scope_seq_no    (+)
    ; 
        --validering
            enhet 2020-12-09
                SQL> select count (*) from enhet where dato_ut is null;
                    COUNT(*)
                    ----------
                        23381


------------------------------------------------------------v_enhet_master_apex-----------------------------------------------------------------------------------------------------------------------------------create or replace view v_enhet_master_apex as
      create or replace view v_enhet_master_apex as
        /*
          Brukes i APEX bilde 205 søk på del/vrak.....
          NB NB ved endringer i dene må
          1) colletion slettes i create_coll dvs linje: apex_collection.delete_collection   (p_collection_name      => v_collection_name)
          2) mv_v_bildeler_apex må også recreates pga ref_cursor henter definisjonen derifra
          2014_03_23 laget som kopi av v_bildeler_apex
          2014_04_16 Påske valldal lagt inn pris
          2014_05_01 lagt til fab_seq_no,type_seq_no,var_bil_scope_seq_no
          2014_06_26 legger ut prod_nr=oem_nr , motor_kode, gear_kode
          2014_08_20  lagt inn v0_lbk_type skal brukes i c045_v1_info
          2014_10_24  lbk_type tatt bort igjen ref søk tar 5 sekund !!!
          2014_11_18  legger ut temp infor fram V_ekstern bil i enhet besk,  ref Tommy klarer ikke identifisere bilen, + temp i temp
          2014_11_19  legger ut ant bilder etter ønske fr TB
        */
        select
           enhet_seq_no                                                        as  c002_enhet_seq_no,            --brukes APEX
           prev_enhet_seq_no                                                   as  c003_prev_enhet_seq_no,
           vare_gruppe_seq_no                                                  as  c004_vare_gruppe_seq_no,      --brukes APEX
           vare_gruppe_id                                                      as  c005_vare_gruppe_id,                              --1  vises i bilde 205 APEX
           ' '                                                                 as  c006_prev_vare_gruppe_id,
           serie_seq_no                                                        as  c007_serie_seq_no,
           serie_no                                                            as  c008_serie_no,                                    --3  vises i bilde 205 APEX
           prev_serie_no                                                       as  c009_prev_serie_no,
           old_serie_no                                                        as  c010_old_serie_no,
           location_seq_no                                                     as  c011_location_seq_no,
           loc_id                                                              as  c012_loc_id,                                      --4  vises i bilde 205 APEX
           to_char(kval_id  )                                                  as  c013_kval_id,
           decode(location_seq_no,3300,temp,enhet_besk)                        as  c014_enhet_besk,                                  --5  vises i bilde 205 APEX
           decode(location_seq_no,3300,null,temp)                              as  c015_temp,                                        --6  vises i bilde 205 APEX
           ' '                                                                 as  c016_temp_dato,
           dato_inn                                                            as  c017_dato_inn,
           dato_ut                                                             as  c018_dato_ut,
           paa_bil                                                             as  c019_paa_bil,
           hold_on                                                             as  c020_hold_on,
           pris_inkl_mva                                                       as  c021_pris_inkl_mva,                               --7  vises i bilde 205 APEX
           miljo_klarert_id                                                    as  c022_miljo_klarert_id,
           pris_solgt_inkl_mva                                                 as  c023_pris_solgt_inkl_mva,
           salg_via                                                            as  c024_salg_via,
           salg_funnet                                                         as  c025_salg_funnet,
           org_pris_inkl_mva                                                   as  c026_org_pris_inkl_mva,
           org_dato_inn                                                        as  c027_org_dato_inn,
           takst_seq_no                                                        as  c028_takst_seq_no,
           fab_seq_no                                                          as  c029_fab_seq_no,
           type_seq_no                                                         as  c030_type_seq_no,
           var_bil_scope_seq_no                                                as  c031_var_bil_scope_seq_no,
           reg_no                                                              as  c032_reg_no,
           ant_foto                                                            as  c033,
           ' '                                                                 as  c034,
           ' '                                                                 as  c035,
           ' '                                                                 as  c036,
           ' '                                                                 as  c037,
           ' '                                                                 as  c038,
           ' '                                                                 as  c039,
           prod_nr                                                             as  c040_nr,                                     --8  vises i bilde 205 APEX
           --henter kun motor og gir info fra dedikert del (ikke vrak)
           --motor bensin, disel
           --case when vare_gruppe_seq_no in (40021,40020) then 
           motor_kode --end                                                      
                                                                               as  c041_motor,                                  --9  vises i bilde 205 APEX
           --GEARKASSE AUTOMAT,GEARKASSE 4-TRINNS,GEARKASSE 5-TRINNS,GEARKASSE 6-TRINN  
           --case when vare_gruppe_seq_no in (1002,1000,1001,40040) then
           gear_kode --end
                                                                               as  c042_gear,                                   --10 vises i bilde 205 APEX
           ' '                                                                 as  c043_v0_var_bil_seq_no,
           nvl2(type_klasse        ,                                                                                    type_klasse        , null              ) ||
           nvl2(fab_navn           ,nvl2(type_klasse                                                           , '  ' ,null)||fab_navn           , fab_navn          ) ||
           nvl2(type_id            ,nvl2(type_klasse||fab_navn                                                 , '  ' ,null)||type_id            , type_id           ) ||
           nvl2(betegnelse         ,nvl2(type_klasse||fab_navn   ||type_id                                     , '  ' ,null)||betegnelse         , betegnelse        ) ||
           nvl2(to_char(aar,'yyyy'),nvl2(type_klasse||fab_navn   ||type_id   ||betegnelse                      , '  ' ,null)||to_char(aar,'yyyy'),to_char(aar,'yyyy')) ||    
           nvl2(scope              ,nvl2(type_klasse||fab_navn   ||type_id   ||betegnelse||to_char(aar,'yyyy') , '  ' ,null)||scope              , scope             ) 
    
                                                                               as  c044_v0_info,                                --2  vises i bilde 205 APEX
           --v1_info tom tidligere
           --SPEZIAL   bruker v1_info kolonnen til annet enn tilrtenkt pga
           -- TURBO brukes mye i børe betegnelse ig varegruppe  
           --2014-05-15                                                                     
           nvl2(type_klasse        ,                                                                                    type_klasse        , null              ) ||
           nvl2(fab_navn           ,nvl2(type_klasse                                                     , '  ' ,null)||fab_navn           , fab_navn          ) ||
           nvl2(type_id            ,nvl2(type_klasse||fab_navn                                           , '  ' ,null)||type_id            , type_id           ) ||
           nvl2(scope_range        ,nvl2(type_klasse||fab_navn   ||type_id                               , '  ' ,null)||scope_range        , scope_range       ) ||
           nvl2(to_char(aar,'yyyy'),nvl2(type_klasse||fab_navn   ||type_id               ||scope_range   , '  ' ,null)||to_char(aar,'yyyy'),to_char(aar,'yyyy')) 
           --||lbk_bil.lbk_type
                                                                               as  c045_v1_info,                                                                                                       
           ' '                                                                 as  c046_v2_info_a,                              --12 vises i bilde 205 APEX
           ' '                                                                 as  c047_v2_info_b,                              --13 vises i bilde 205 APEX
           ' '                                                                 as  c048_v2_info_c,                              --14 vises i bilde 205 APEX
           ' '                                                                 as  c049,
           ' '                                                                 as  c050
        from v_enhet_master
        /
    
            --dill
              select max(length(c045_v1_info)) from v_enhet_master_apex;
              #55  har mye å gå på
              truncate table plan_table;        
              explain plan set statement_id='v_enhet_master_apex' into plan_table for 
              --Trobbel med tregt view 24.10.2014                              
              select * from ola.v_enhet_master_apex  
              where 1=1 and (c012_loc_id is not null or c019_paa_bil='J')  
              and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'yyyy-mm-dd')||upper(c032_reg_no) like '%%'  
              and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'yyyy-mm-dd')||upper(c032_reg_no) like '%VRAK%'  
              and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'yyyy-mm-dd')||upper(c032_reg_no) like '%SAAB%'  
              order by c005_vare_gruppe_id,c044_v0_info;
              commit;
              
              
              select * from ola.v_enhet_master_apex  
              where 1=1 and (c012_loc_id is not null or c019_paa_bil='J')  
              and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'yyyy-mm-dd')||upper(c032_reg_no) like '%VRAK%'  
              and upper(c005_vare_gruppe_id)||upper(c045_v1_info)||upper(c008_serie_no)||upper(c009_prev_serie_no)||upper(c012_loc_id)||to_char(c017_dato_inn,'yyyy-mm-dd')||upper(c032_reg_no) like '%SAAB%'  
              order by c005_vare_gruppe_id,c044_v0_info
              
              
              truncate table plan_table;        
              explain plan set statement_id='v_enhet_master_apex' into plan_table for                               
                                       select *  from v_enhet_master_apex      where c045_v1_info like '%W168%' and c005_vare_gruppe_id like '%STAR%' ;
                                       select *  from mv_v_enhet_master_apex      where c045_v1_info like '%W168%' and c005_vare_gruppe_id like '%STAR%' ;
              commit;
              truncate table plan_table;        
              explain plan set statement_id='v_enhet_master' into plan_table for                               
                                       select *  from v_enhet_master      where fab_navn like '%SAA%' and vare_gruppe_id like '%STAR%' ;
              commit;
              truncate table plan_table;        
              explain plan set statement_id='v_enhet_master' into plan_table for                               
                                       select *  from v_enhet2      where fab_navn like '%SAA%' and vare_gruppe_id like '%STAR%' ;
              commit;
              
              
              
              
              select count(*) from v_enhet_master_apex where 1=1 
               and upper(c005_vare_gruppe_id)||upper(c044_v0_info)||upper(c008_serie_no)||upper(c012_loc_id)||upper(c014_enhet_besk)||upper(c015_temp)|
               |upper(to_char(c021_pris_inkl_mva))||upper(c040_nr)||upper(c041_motor)||upper(c042_gear)||upper(c045_v1_info)||upper(c046_v2_info_a)||upper(c047_v2_info_b)||
               upper(c048_v2_info_c)||to_char(c017_dato_inn,'yyyy-mm-dd') like '%W168%';
               
               
              select count(*) from v_enhet_master where vare_gruppe_id like '%MOT%' ;
              --106
              --103 289
              select 
    
----------------------------------------------------------  v_html_merke_modell_scope_del------------------------------------------------------------------------------------------
    select count(*) from t_enhet2;                 --html_ok=JA
    --21 292
    select count(*) from t_enhet2_full;            --html_ok HVASOMHELST men location is not null
    --21 680
    
    drop view v_google_sok
    create or replace view v_html_google as
    /*
      Policy function via tabel obas_access_xxx.sql som styrer tilgangen til dette view med kolonnen usr_grp_visning_deler
      2013_08_06 pga max 400 bytes i bind variable i APEX
      baserer seg på kode i lasger_master.asp som også er lagret i ...\scripts\fritekst_sokxxxx.sql
      brukes i mobil app P300
    */  
    select enhet.enhet_seq_no,
           enhet.prev_enhet_seq_no,
           enhet.fab_navn,
           enhet.type_id,
           enhet.vare_gruppe_id,
           enhet.betegnelse,
           enhet.aar,
           enhet.del_1,
           enhet.bil_1,
           null as blobs_ecu_seq_no,
           null as images_ecu,
           'enhet' as enhet,
           null as vognkort,
           null as ecu, 
           decode(enhet.html_ok,'ja','HTML_OK','nei','ALT') as usr_grp_visning_deler,
           --sok (brukes i like ...
           ------------------------
           upper(enhet.vare_gruppe_id)||upper(enhet.fab_navn)||upper(enhet.type_id) ||upper(enhet.aar)||upper(enhet.betegnelse)||
           upper(enhet.enhet_besk)||upper(enhet.loc_id)||upper(enhet.serie_no)||upper(enhet.prev_serie_no)||upper(enhet.kval_id)||
           upper(enhet.motor_type_besk)||upper(enhet.motor_vol_id)||upper(enhet.dorer_id)||upper(enhet.km)||upper(enhet.reg_no)||
           upper(enhet.chassis_no)||upper(enhet.farge_kode)||upper(enhet.gear_type)||upper(enhet.miljo_klarert_id)||upper(enhet.servo)||
           to_char(enhet.dato_ut,'dd.mm.yyyy')||to_char(enhet.dato_inn,'dd.mm.yyyy') ||upper(enhet.prod_nr)||upper(enhet.VENDOR_DATA_NO) as sok,
           --vis brukes i visning av resultat
           ----------------------------------
           enhet.fab_navn||' '||enhet.type_id||' '||enhet.vare_gruppe_id as vis
    from ola.t_enhet2_full enhet 
    where 1=1
    and enhet.location_seq_no is not null 
    order by enhet.fab_navn,enhet.type_id,enhet.vare_gruppe_id,enhet.aar
    /
    
    select count(*) from v_html_google where sok like '%SAAB%' or sok like '%900%';
    --1204->1249
    select count(*) from v_html_google where sok like '%SAAB%' and sok like '%900%';
    --84>131
    
    
    create or replace view v_html_merke as
    select distinct
    /*
    --------brukes i obas_mobil
    Policy function via tabel obas_access_xxx.sql som styrer tilgangen til dette view med kolonnen usr_grp_visning_deler
    2013_07_09 laget Sundøyhagen
    2013_07_31 oppdatert med policy kolonne og t_enhet2_full (som har ikke bare html_ok=ja
    */
      merke.fab_seq_no,      del.merke_vasket,
    decode(del.html_ok,'ja','HTML_OK','nei','ALT') as usr_grp_visning_deler
    from
       var_bil        merke,
       t_enhet2_full  del
    where 1=1
    --and del.html_ok='ja' 
    and del.var_bil_seq_no = merke.var_bil_seq_no
    order by del.merke_vasket;
    --select count(*) from v_html_merke;
    --66
    
                                               create or replace view v_html_merke_modell as
                                               select distinct
                                               /*
                                               --------brukes i obas_mobil
                                               Policy function via tabel obas_access_xxx.sql som styrer tilgangen til dette view med kolonnen usr_grp_visning_deler
                                               2013_07_09 laget Sundøyhagen
                                               2013_07_31 oppdatert med policy kolonne og t_enhet2_full (som har ikke bare html_ok=ja
                                               */
                                                 merke.fab_seq_no,           del.merke_vasket,
                                                 modell.type_seq_no,         del.modell_vasket,
                                                 merke.fab_seq_no||modell.type_seq_no as fab_type_seq_no,
                                                 decode(del.html_ok,'ja','HTML_OK','nei','ALT') as usr_grp_visning_deler
                                               from
                                                  var_bil        merke,
                                                  var_bil        modell,
                                                  t_enhet2_full  del   
                                               where 1=1
                                               --and del.html_ok='ja'      
                                               and del.var_bil_seq_no = modell.var_bil_seq_no
                                               and del.var_bil_seq_no = merke.var_bil_seq_no
                                               order by del.merke_vasket,del.modell_vasket;
                                               --  REGEXP_REPLACE(modell_vasket,'[[:alpha:]]')
                                               --  regexp_replace(substr(modell_vasket,1,1), '[[:alpha:]]') ,   regexp_replace(modell_vasket, '[^[:digit:]]') ,modell_vasket
                                               --select * from v_html_merke_modell;
                                               --295
    
                                                                                           create or replace view v_html_merke_modell_del as
                                                                                           select distinct
                                                                                           /*
                                                                                           --------brukes i obas_mobil
                                                                                           Policy function via tabel obas_access_xxx.sql som styrer tilgangen til dette view med kolonnen usr_grp_visning_deler
                                                                                           2013_07_09 laget Sundøyhagen
                                                                                           2013_07_31 oppdatert med policy kolonne og t_enhet2_full (som har ikke bare html_ok=ja
                                                                                           */
                                                                                             merke.fab_seq_no,           del.merke_vasket,
                                                                                             modell.type_seq_no,         del.modell_vasket,
                                                                                             merke.fab_seq_no||modell.type_seq_no as fab_type_seq_no,
                                                                                             merke.fab_seq_no||modell.type_seq_no||del.vare_gruppe_seq_no as fab_type_vare_g_seq_no,
                                                                                             del.vare_gruppe_seq_no,     del.del_vasket,  
                                                                                             decode(del.html_ok,'ja','HTML_OK','nei','ALT') as usr_grp_visning_deler
                                                                                           from
                                                                                              var_bil        merke,
                                                                                              var_bil        modell,
                                                                                              t_enhet2_full  del
                                                                                           where 1=1
                                                                                           --and del.html_ok='ja'      
                                                                                           and del.var_bil_seq_no = modell.var_bil_seq_no
                                                                                           and del.var_bil_seq_no = merke.var_bil_seq_no
                                                                                           order by del.merke_vasket,del.modell_vasket,del.del_vasket;
                                                                                           --select count(*) from v_html_merke_modell_del;
                                                                                           --508
    
    create or replace view v_html_merke_modell_del_item_l as
    select distinct
    /*
    --------brukes i obas_mobil
    Policy function via tabel obas_access_xxx.sql som styrer tilgangen til dette view med kolonnen usr_grp_visning_deler
    2013_07_09 laget Sundøyhagen
    2013_07_31 oppdatert med policy kolonne og t_enhet2_full (som har ikke bare html_ok=ja
    */
      merke.fab_seq_no,           del.merke_vasket,
      modell.type_seq_no,         del.modell_vasket,
      scope.var_bil_scope_seq_no, del.scope_vasket,
      merke.fab_seq_no||modell.type_seq_no||del.vare_gruppe_seq_no as fab_type_vare_g_seq_no,
      del.vare_gruppe_seq_no,      del.enhet_seq_no as enhet_seq_no  ,
      del.del_vasket, del.serie_no, 'dele.nr '||del.serie_no||', modell '||del.scope_vasket as item,
      decode(del.html_ok,'ja','HTML_OK','nei','ALT') as usr_grp_visning_deler
    from
       var_bil        merke,
       var_bil        modell,
       var_bil        scope,
       t_enhet2_full  del
    where 1=1
    --and del.html_ok='ja'      
    and del.var_bil_seq_no = scope.var_bil_seq_no                     --ikke alle har scope dette må fikses
    and scope.var_bil_scope_seq_no is not null                        --tas vekk nå var_bil.var_bil_scope_seq_no er satt not null
    and del.var_bil_seq_no = modell.var_bil_seq_no
    and del.var_bil_seq_no = merke.var_bil_seq_no
    order by del.merke_vasket,del.modell_vasket,del.scope_vasket,del.serie_no;
    
    select count(*) from v_html_merke_modell_del_item_l;
    select count(*) from ola.v_t;
    --21385
    --21723 (21763 t_enhet2_full)
    
    -----------------------------------------------------------v_html_enhet_diff ------------------------------------------------------------------------------------------
    create or replace view v_html_enhet_diff as
    select 
    /*
    --------brukes i pr_html_content_xxx.sql
    2012_08_17 laget
    2012_11_19 html_ok='ja'  før Y
    */
     enhet.enhet_seq_no,
         merke_vasket,    modell_vasket,    del_vasket, 
     rev_merke,       rev_modell,       rev_del,
    --KOPI FRA v_enhet2
    -------------------
    --serie_no  
             --sørger for at D,V ikke skriver ut dersom serie_no er tomt som for solgte deler                                                                                                           
             --decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no                                                                                                
                                                               (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no                                 
                                                                                                         from serie serie      where enhet.serie_seq_no=serie.serie_seq_no)                           serie_no,
    --loc_id                                                                                                     
                                                               (select loc_id                            from location         where enhet.location_seq_no  =location.location_seq_no)                loc_id,
    --STATUS
    --------
    --   html_ok     paa_disk   css_solgt    css_diff  komnnentar
    --    ja         nei                               klar men ikke lagt ut enda    
                                                                                                 html_ok,
    nvl2(rev_merke,'ja','nei')                                                                as paa_disk,
    --på disk men ikke html_ok --> fjernes (uansett)
    case 
       when (nvl2(rev_merke,'ja','nei')= 'ja' and
             html_ok='nei')
        then 
           'ja'
      else  
        'nei'
    end                                                                                       as css_solgt,
     --deler om er hotte det finnes varianter med annen merke_modell_del kombinasjoner
    case   
       when (    merke_vasket||    modell_vasket||    del_vasket !=
             rev_merke       ||rev_modell       ||rev_del         and
             html_ok='ja')
        then 
           'ja'
      else  
        'nei'
    end                                                                                       as css_diff
    from 
      (--deler som er på disk
      select  enhet_seq_no from enhet_html where rev_merke is not null
      union
       --deler som er hotte
      select  enhet_seq_no from enhet_html where html_ok='ja'
      ) driver,
      enhet, 
      enhet_html
    where 1=1   
      and driver.enhet_seq_no = enhet.enhet_seq_no
      and driver.enhet_seq_no = enhet_html.enhet_seq_no
    order by merke_vasket, modell_vasket,del_vasket,  serie_no
    /   
      
    select enhet_seq_no, html_ok from enhet_html
    minus  
    select enhet_seq_no, html_ok from v_enhet2;
    
    
    select count(*) from t_enhet2;
    select count(*) from enhet_html;
    
    
    
    
    -----------------------------------------------------------v_html_oversikt_modell ------------------------------------------------------------------------------------------
    create or replace view v_html_oversikt_modell as
    select distinct
    /*
    --------brukes i pr_html_content_sub_xxx.sql
    2012_08_17 laget
    2012_11_19 html_ok='ja'  før Y
    2012_12_23 lagt in loc og del_vasket,  ok ref grupper IGJEN når viewet brukes i pr_html_content_sub
    */
      t_enhet2.merke_vasket       as merke_vasket,
      t_enhet2.modell_vasket      as modell_vasket,
      t_enhet2.del_vasket         as del_vasket,  
      t_enhet2.loc_id             as loc_id, 
      decode(deler.deler,0,null,deler.deler)             as deler,
      decode(biler.biler,0,null,biler.biler)             as biler,
      decode(foto.foto,0,null,foto.foto)                 as foto,
      decode(foto_bil.foto,0,null,foto_bil.foto)         as foto_bil,
      decode(foto_plukk.foto,0,null,foto_plukk.foto)     as foto_plukk
    from t_enhet2,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,
        count(*)       as deler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no !=1
      group by merke_vasket,modell_vasket,del_vasket,loc_id)  deler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,
        count(*)       as biler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no =1
      group by merke_vasket,modell_vasket,del_vasket,loc_id)  biler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        del_vasket     as del_vasket,        
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,del_vasket,loc_id)  foto,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        del_vasket     as del_vasket,        
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,del_vasket,loc_id)  foto_bil,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        del_vasket     as del_vasket,        
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   loc_id='UTE_1'   
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,del_vasket,loc_id)  foto_plukk
    where 1=1
    and   t_enhet2.merke_vasket  = deler.merke_vasket        (+)
    and   t_enhet2.modell_vasket = deler.modell_vasket       (+) 
    and   t_enhet2.del_vasket    = deler.del_vasket          (+) 
    and   t_enhet2.loc_id        = deler.loc_id              (+) 
    and   t_enhet2.merke_vasket  = biler.merke_vasket        (+)
    and   t_enhet2.modell_vasket = biler.modell_vasket       (+)
    and   t_enhet2.del_vasket    = biler.del_vasket          (+) 
    and   t_enhet2.loc_id        = biler.loc_id              (+) 
    and   t_enhet2.merke_vasket  = foto.merke_vasket         (+)
    and   t_enhet2.modell_vasket = foto.modell_vasket        (+)
    and   t_enhet2.del_vasket    = foto.del_vasket           (+) 
    and   t_enhet2.loc_id        = foto.loc_id               (+) 
    and   t_enhet2.merke_vasket  = foto_bil.merke_vasket     (+)
    and   t_enhet2.modell_vasket = foto_bil.modell_vasket    (+)
    and   t_enhet2.del_vasket    = foto_bil.del_vasket       (+) 
    and   t_enhet2.loc_id        = foto_bil.loc_id           (+) 
    and   t_enhet2.merke_vasket  = foto_plukk.merke_vasket   (+)
    and   t_enhet2.modell_vasket = foto_plukk.modell_vasket  (+)
    and   t_enhet2.del_vasket    = foto_plukk.del_vasket     (+) 
    and   t_enhet2.loc_id        = foto_plukk.loc_id         (+) 
    order by merke_vasket,modell_vasket,del_vasket,loc_id
    /   
    -----------------------------------------------------------v_html_oversikt_scope ------------------------------------------------------------------------------------------
    create or replace view v_html_oversikt_scope as
    select distinct
    /*
    --------brukes i pr_html_content_sub_xxx.sql
    2012_08_17 laget
    2012_11_19 html_ok='ja'  før Y
    2012_12_23 lagt in loc og del_vasket,  ok ref grupper IGJEN når viewet brukes i pr_html_content_sub
    */
      t_enhet2.merke_vasket       as merke_vasket,
      t_enhet2.modell_vasket      as modell_vasket,
      t_enhet2.scope_vasket       as scope_vasket,
      t_enhet2.del_vasket         as del_vasket,  
      t_enhet2.loc_id             as loc_id, 
      decode(deler.deler,0,null,deler.deler)         as deler,
      decode(biler.biler,0,null,biler.biler)         as biler,
      decode(foto.foto,0,null,foto.foto)             as foto,
      decode(foto_bil.foto,0,null,foto_bil.foto)     as foto_bil,
      decode(foto_plukk.foto,0,null,foto_plukk.foto) as foto_plukk
    from t_enhet2,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,
        count(*)       as deler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no !=1
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  deler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,        
        loc_id         as loc_id,
        count(*)       as biler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no =1
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  biler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,    
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,    
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto_bil,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,    
        loc_id         as loc_id,    
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   loc_id='UTE_1'  
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto_plukk
     where 1=1
    and   t_enhet2.merke_vasket  = deler.merke_vasket        (+)
    and   t_enhet2.modell_vasket = deler.modell_vasket       (+) 
    and   t_enhet2.scope_vasket  = deler.scope_vasket        (+) 
    and   t_enhet2.del_vasket    = deler.del_vasket          (+) 
    and   t_enhet2.loc_id        = deler.loc_id              (+) 
    and   t_enhet2.merke_vasket  = biler.merke_vasket        (+)
    and   t_enhet2.modell_vasket = biler.modell_vasket       (+)
    and   t_enhet2.scope_vasket  = biler.scope_vasket        (+) 
    and   t_enhet2.del_vasket    = biler.del_vasket          (+) 
    and   t_enhet2.loc_id        = biler.loc_id              (+) 
    and   t_enhet2.merke_vasket  = foto.merke_vasket         (+)
    and   t_enhet2.modell_vasket = foto.modell_vasket        (+)
    and   t_enhet2.scope_vasket  = foto.scope_vasket         (+) 
    and   t_enhet2.del_vasket    = foto.del_vasket           (+) 
    and   t_enhet2.loc_id        = foto.loc_id               (+) 
    and   t_enhet2.merke_vasket  = foto_bil.merke_vasket     (+)
    and   t_enhet2.modell_vasket = foto_bil.modell_vasket    (+)
    and   t_enhet2.scope_vasket  = foto_bil.scope_vasket     (+) 
    and   t_enhet2.del_vasket    = foto_bil.del_vasket       (+) 
    and   t_enhet2.loc_id        = foto_bil.loc_id           (+) 
    and   t_enhet2.merke_vasket  = foto_plukk.merke_vasket   (+)
    and   t_enhet2.modell_vasket = foto_plukk.modell_vasket  (+)
    and   t_enhet2.scope_vasket  = foto_plukk.scope_vasket   (+) 
    and   t_enhet2.del_vasket    = foto_plukk.del_vasket     (+) 
    and   t_enhet2.loc_id        = foto_plukk.loc_id         (+) 
    order by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id
    /   
    -----------------------------------------------------------v_html_oversikt_del ------------------------------------------------------------------------------------------
    create or replace view v_html_oversikt_del as
    select distinct
    /*
    --------brukes i pr_html_content_sub_xxx.sql
    2012_9_26 laget
    2012_12_23 lagt in loc og del_vasket,  ok ref grupper IGJEN når viewet brukes i pr_html_content_sub
    */
      t_enhet2.merke_vasket       as merke_vasket,
      t_enhet2.modell_vasket      as modell_vasket,
      t_enhet2.scope_vasket       as scope_vasket,
      t_enhet2.del_vasket         as del_vasket, 
      t_enhet2.loc_id             as loc_id, 
      decode(deler.deler,0,null,deler.deler)         as deler,
      decode(biler.biler,0,null,biler.biler)         as biler,  --brukes som deler i pr_html_content_sub
      decode(foto.foto,0,null,foto.foto)             as foto,
      decode(foto_bil.foto,0,null,foto_bil.foto)     as foto_bil,
      decode(foto_plukk.foto,0,null,foto_plukk.foto) as foto_plukk
    from t_enhet2,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,
        loc_id         as loc_id,
        count(*)       as deler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no !=1
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  deler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,
        loc_id         as loc_id,
        count(*)       as biler
      from t_enhet2 --v_enhet_html_katalog
      where 1=1
      and   html_ok='ja'
      and   vare_gruppe_seq_no =1
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  biler,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto_bil,
      (select
        merke_vasket   as merke_vasket,
        modell_vasket  as modell_vasket,
        scope_vasket   as scope_vasket,
        del_vasket     as del_vasket,
        loc_id         as loc_id,
        count(*)       as foto
      from t_enhet2, --v_enhet_html_katalog
           enhet_blobs
      where 1=1
      and   html_ok='ja'
      and   del_vasket='VRAK'
      and   loc_id='UTE_1'
      and   t_enhet2.enhet_seq_no = enhet_blobs.enhet_seq_no
      group by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id)  foto_plukk
    where 1=1
    and   t_enhet2.merke_vasket  = deler.merke_vasket      (+)
    and   t_enhet2.modell_vasket = deler.modell_vasket     (+) 
    and   t_enhet2.scope_vasket  = deler.scope_vasket      (+) 
    and   t_enhet2.del_vasket    = deler.del_vasket        (+) 
    and   t_enhet2.loc_id        = deler.loc_id            (+) 
    and   t_enhet2.merke_vasket  = biler.merke_vasket      (+)
    and   t_enhet2.modell_vasket = biler.modell_vasket     (+) 
    and   t_enhet2.scope_vasket  = biler.scope_vasket      (+) 
    and   t_enhet2.del_vasket    = biler.del_vasket        (+) 
    and   t_enhet2.loc_id        = biler.loc_id            (+) 
    and   t_enhet2.merke_vasket  = foto.merke_vasket       (+)
    and   t_enhet2.modell_vasket = foto.modell_vasket      (+)
    and   t_enhet2.scope_vasket  = foto.scope_vasket       (+) 
    and   t_enhet2.del_vasket    = foto.del_vasket         (+) 
    and   t_enhet2.loc_id        = foto.loc_id             (+) 
    and   t_enhet2.merke_vasket  = foto_bil.merke_vasket   (+)
    and   t_enhet2.modell_vasket = foto_bil.modell_vasket  (+)
    and   t_enhet2.scope_vasket  = foto_bil.scope_vasket   (+) 
    and   t_enhet2.del_vasket    = foto_bil.del_vasket     (+) 
    and   t_enhet2.loc_id        = foto_bil.loc_id         (+) 
    and   t_enhet2.merke_vasket  = foto_plukk.merke_vasket (+)
    and   t_enhet2.modell_vasket = foto_plukk.modell_vasket(+)
    and   t_enhet2.scope_vasket  = foto_plukk.scope_vasket (+) 
    and   t_enhet2.del_vasket    = foto_plukk.del_vasket   (+) 
    and   t_enhet2.loc_id        = foto_plukk.loc_id       (+) 
    order by merke_vasket,modell_vasket,scope_vasket,del_vasket,loc_id
    /   
    
    select     
    (select count(*) from v_html_oversikt_scope),
    (select count(*) from v_html_oversikt_modell),      
    (select count(*) from v_html_oversikt_del) from dual; 
    506    294    14305
    508    195    14315  2012_11_19
    504    290    14431 2012_12_13
    503   289   21438 2012_12_23 FØR OVESOK SCOPE
    
      --truncate table t_enhet2;
      insert into t_enhet2 select * from v_enhet2 where html_ok='ja' ;
      commit;
      21783 2012_11_19
        
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for                       
    select * from v_enhet2 where html_ok='ja' ;
    commit;
    
    -----------------------------------------------------------v_enhet_html_katalog ------------------------------------------------------------------------------------------
    create or replace view v_enhet_html_katalog as
    select 
    /*
    --------brukes i IKKE pr_html__xxx.sql ref byttet ut med t_enhet2
    2011_06_13 laget
    2011_06_20 luker ut \ / : * ? " < > |
    2011_06_24 luker ut spesialtegn og bytter om på øæå
    2011_05_25 setter inn - for space og . 
               samt upper og trim 
    2011_08_15 lagt inn scope_vasket    
    2012_07_07 bytter ut t_enhet_html med inline tabeller
    2012_07_23 lagt inn klasse
    2012_07_29 byttet ut harkodet fabrikant, type etc med v_var_bil som har hele dritten, samt tatt vekkk distinct siden vi lister enhet_seq_no allikevel
    */
      enhet.enhet_seq_no                                                                                                      as enhet_seq_no, 
    nvl2(enhet.var_bil_seq_no,(select nvl2(type.type_klasse,type.type_klasse,'BIL')
                               from type,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.type_seq_no  = type.type_seq_no
                               ),null)                                                                                        as type_klasse,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('MERKE_VASKET',fabrikant.fab_navn)
                               from fabrikant,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.fab_seq_no   = fabrikant.fab_seq_no
                               ),null)                                                                                        as merke_vasket,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('MODELL_VASKET',type.type_id)
                               from type,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.type_seq_no  = type.type_seq_no
                               ),null)                                                                                        as modell_vasket,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('DEL_VASKET',vare_gruppe.vare_gruppe_id)
                               from vare_gruppe
                               where 1=1   
                               and   enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no
                               ),null)                                                                                        as del_vasket,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('SCOPE_VASKET',v_var_bil.scope)
                               from v_var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no         = v_var_bil.var_bil_seq_no
                               ),null)                                                                                        as scope_vasket,
    nvl2(enhet.var_bil_seq_no,(select v_var_bil.scope
                               from v_var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no         = v_var_bil.var_bil_seq_no
                               ),null)                                                                                        as scope
    from
      (select 
        enhet.enhet_seq_no                                                                  as enhet_seq_no,
        nvl2(enhet.prev_enhet_seq_no,(select enhet_2.var_bil_seq_no
                                      from enhet enhet_2
                                      where 1=1     
                                      and   enhet.prev_enhet_seq_no = enhet_2.enhet_seq_no
                                      ),
                                      enhet.var_bil_seq_no)                                 as var_bil_seq_no,
        enhet.vare_gruppe_seq_no                                                            as vare_gruppe_seq_no,
        enhet.location_seq_no                                                               as location_seq_no
      from enhet 
      where 1=1
      -- På lager 
    --  and location_seq_no is not null 
    --  and location_seq_no <> 3300        --ekstern    
      ) enhet
    where 1=1
        -- IKKE   NY           HELLANOR 2006
        --        NYE OG GAMLE DEKK     2007
        --------------------------------------
    --and enhet.var_bil_seq_no not in (41371,44780)
    order by   merke_vasket,  modell_vasket, del_vasket
    /  
    grant all on v_enhet_html_katalog to public;
    
    
    select count(*) from v_enhet_html_katalog;
    --21899  2012_08_04
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog where merke_vasket in ('AUDI') and modell_vasket='A6';
    commit;
    
    -----------------------------------------------------------v_enhet_html_katalog_item_list ------------------------------------------------------------------------------------------
    create or replace view v_enhet_html_katalog_item_list as
    select 
    /*
    Trengs(minst):
        enhet_seq_no    prev_enhet
        merke    modell    del    åår     scope
        vare_gruppe_id
        serie    loc_id
        prod_nr, pris_inkl_mva
        del_1
        pris_inkl_mva
    2011_08_07 laget kopi fra v_enhet_html_katalog
    */
      enhet.enhet_seq_no                                                                                                      as enhet_seq_no, 
      enhet.prev_enhet_seq_no                                                                                                 as prev_enhet_seq_no,
    nvl2(enhet.var_bil_seq_no,(select nvl2(type.type_klasse,type.type_klasse,'BIL')
                               from type,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.type_seq_no  = type.type_seq_no
                               ),null)                                                                                        as type_klasse,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('MERKE_VASKET',fabrikant.fab_navn)
                               from fabrikant,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.fab_seq_no   = fabrikant.fab_seq_no
                               ),null)                                                                                        as merke_vasket,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('MODELL_VASKET',type.type_id)
                               from type,
                                    var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                               and   var_bil.type_seq_no  = type.type_seq_no
                               ),null)                                                                                        as modell_vasket,
    nvl2(enhet.var_bil_seq_no,(select vare_gruppe.vare_gruppe_id
                               from vare_gruppe
                               where 1=1   
                               and   enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no
                               ),null)                                                                                        as vare_gruppe_id,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('DEL_VASKET',vare_gruppe.vare_gruppe_id)
                               from vare_gruppe
                               where 1=1   
                               and   enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no
                               ),null)                                                                                        as del_vasket,
    nvl2(enhet.var_bil_seq_no,(select f_vasket('SCOPE_VASKET',v_var_bil.scope)
                               from v_var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no         = v_var_bil.var_bil_seq_no
                               ),null)                                                                                        as scope_vasket,
    nvl2(enhet.var_bil_seq_no,(select v_var_bil.scope
                               from v_var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no         = v_var_bil.var_bil_seq_no
                               ),null)                                                                                        as scope,
    nvl2(enhet.var_bil_seq_no,(select v_var_bil.aar
                               from v_var_bil
                               where 1=1   
                               and   enhet.var_bil_seq_no         = v_var_bil.var_bil_seq_no
                               ),null)                                                                                        as aar,                          
    --prev_serie_no (kopi fra v_enhet2)
      nvl2(enhet.var_bil_seq_no,  null                        ,(select prev_enhet.serie_seq_no           from enhet prev_enhet where enhet.prev_enhet_seq_no=prev_enhet.enhet_seq_no))           prev_serie_seq_no,
    --serie_no (kopi fra v_enhet2)
             --sørger for at D,V ikke skriver ut dersom serie_no er tomt som for solgte deler                                                                                                           
             --decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no    
                                                               (select decode(enhet.vare_gruppe_seq_no,1,'V',decode(serie.serie_no,null,'','D'))||serie.serie_no                                 
                                                                                                         from serie serie      where enhet.serie_seq_no=serie.serie_seq_no)
                                                                                                                              as serie_no,
    --loc_id (kopi fra v_enhet2)
      (select loc_id from location where enhet.location_seq_no  =location.location_seq_no)                                      
                                                                                                                              as loc_id,
      enhet.location_seq_no
                                                                                                                              as location_seq_no,
      enhet.prod_nr                                                                                                           as prod_nr,
      enhet.pris_inkl_mva                                                                                                     as pris_inkl_mva,
      enhet.del_1                                                                                                             as del_1
    from
      (select 
        enhet.enhet_seq_no                                                                  as enhet_seq_no,
        enhet.prev_enhet_seq_no                                                             as prev_enhet_seq_no,
        nvl2(enhet.prev_enhet_seq_no,(select enhet_2.var_bil_seq_no
                                      from enhet enhet_2
                                      where 1=1     
                                      and   enhet.prev_enhet_seq_no = enhet_2.enhet_seq_no
                                      ),
                                      enhet.var_bil_seq_no)                                 as var_bil_seq_no,
        enhet.vare_gruppe_seq_no                                                            as vare_gruppe_seq_no,
        enhet.serie_seq_no                                                                  as serie_seq_no,
        enhet.location_seq_no                                                               as location_seq_no,
        enhet.prod_nr                                                                       as prod_nr,
        enhet.pris_inkl_mva                                                                 as pris_inkl_mva,
        null                                                                                as del_1
      from enhet 
      where 1=1
      -- På lager 
      --and location_seq_no is not null 
     -- and location_seq_no <> 3300        --ekstern    
      ) enhet
    where 1=1
        -- IKKE   NY           HELLANOR 2006
        --        NYE OG GAMLE DEKK     2007
        --------------------------------------
    --and enhet.var_bil_seq_no not in (41371,44780)
    order by   merke_vasket,  modell_vasket, del_vasket
    /  
    grant all on v_enhet_html_katalog_item_list to public;
    select count(*) from v_enhet_html_katalog_item_list;
    --21899  2012_08_04
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog_item_list where merke_vasket in ('AUDI') and modell_vasket='A6';
    commit;
    
    
    
    -----------------------------------------------------------html_dill ------------------------------------------------------------------------------------------
    --Static
      --se pr_html 
      insert into enhet_html (enhet_seq_no, date_vasket,merke_vasket,modell_vasket,del_vasket)
      select enhet_seq_no,sysdate,merke_vasket,modell_vasket,del_vasket
      from v_enhet_html_katalog
      where not exists (select 'x' from enhet_html where v_enhet_html_katalog.enhet_seq_no=enhet_html.enhet_Seq_no)
    --uttrekk
      select distinct merke_vasket,  modell_vasket, del_vasket 
      from enhet_html, enhet
      where enhet_html.enhet_seq_no = enhet.enhet_seq_no
      and   enhet_html.dir_cmd_olasbil_as_in is     null
      and   enhet.location_seq_no            is not null
      order by 1,2,3
    -- mangel ift enhet
       (select enhet_seq_no from enhet where location_seq_no is not null and location_seq_no <> 3300 and var_bil_seq_no not in (41371,44780) minus select enhet_seq_no from v_enhet_html_katalog) 
       union
       (select enhet_seq_no from v_enhet_html_katalog                                                                                        minus select enhet_seq_no from enhet)
       #8 2012_07_28  (varegruppe HOLD + varegruppe VRAK som er eksterne)
    -- mangel ift enhet_html
       (select enhet_seq_no from enhet_html where     minus select enhet_seq_no from v_enhet_html_katalog) union 
       (select enhet_seq_no from v_enhet_html_katalog minus select enhet_seq_no from enhet_html)
       #0 2012_07_28 
    -- diff ift enhet_html
        select * from (
       (select '  ENHET_HTML' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from enhet_html                   minus select '  ENHET_HTML' as suorce,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog) union 
       (select 'V_ENHET_HTML_KATALOG' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog minus select 'V_ENHET_HTML_KATALOG' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from enhet_html)
       ) order by 2,1
       #18 2012_07_28 
    ----------------------------  
    2012_07_18 NISSAN/DATSUN               endret til NISSAN-DATSUN
               MC SKARAPBIL 2009          endret til LINGBEN....
               MOPED ....                 endret til LINGBEN....
               MOPED
               MOTORSYKKEL  
               NY           HELLANOR
               NYE OG GAMLE DEKK
               SKARAPBIL 1967 
    >>>>>>>>>>>TODO pr 20.7.12 før sommerferie           
    >>>>>>>>>>>>>>>lag triggere som rydder oppi enhet_html nå frabrikant, type etc endres <<<<<<<<<<<<<
    >>>>>>>>>>>>>>>   samt dersom endringer gjøres i enhet (bytter fabrikant på del etc   <<<<<<<<<<<<<<           
    select * from v_test;
    
----------------------------------------------------------- v_enhet_html_diff ------------------------------------------------------------------------------------------
        select * from (
       (select '  ENHET_HTML' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from enhet_html                   minus select '  ENHET_HTML' as suorce,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog) union 
       (select 'V_ENHET_HTML_KATALOG' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog minus select 'V_ENHET_HTML_KATALOG' as source,enhet_seq_no,merke_vasket,modell_vasket,del_vasket from enhet_html)
    
    
    
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet2 where merke_vasket in ('AUDI') and modell_vasket='A6';  
    
----------------------------------------------------------- v_enhet_html_katalog_item------------------------------------------------------------------------------------------
    create or replace view v_enhet_html_katalog_item as
    select 
    /*
    Fabrikant   -> Modell  -> Del   -> Item
    ==========       
    2011_08_10 laget
    2011_08_15 lagt inn scope_vasket      
    2011_10_23 lagt til aar4, bilder, bil_x,del_x 
    2012_07_29 bytter ut t_enhet_html med t_enhet2,  ref v_enhet_full(tung)-> v_enhet_html->t_enhet_html (manuell insert) 
    2012_08_23 legger ikke in deler som er på hold, eller vent ref spesiellt for hold deler  så kan de bli slettet fra plukke listen
               og da feiler tr_instd_v_plukke_liste (som kun sletter fra enhet)
    */ 
      enhet_seq_no                                                as enhet_seq_no,
      prev_enhet_seq_no                                           as prev_enhet_seq_no,
      f_vasket('MERKE_VASKET',fab_navn)                           as merke_vasket,
      f_vasket('MODELL_VASKET',type_id)                           as modell_vasket,  
      f_vasket('DEL_VASKET',vare_gruppe_id)                       as del_vasket,
      f_vasket('SCOPE_VASKET',scope)                              as scope_vasket,
      nvl(scope, aar)                                             as scope,
      type_id,
      aar,
      aar                                      aar_4,
      betegnelse,
      vare_gruppe_id,
      pris_inkl_mva,
      enhet_besk,
      loc_id,
      nvl(serie_no,'...solgt')                                 as serie_no,
      kval_id,
      motor_type_besk,
      motor_vol_id,
      dorer_id,
      k_grp_id,
      km,
      reg_no,
      chassis_no,
      farge_kode,
      gear_type,
      miljo_klarert_id,
      servo,
      dato_ut,
      dato_inn,
      prod_nr,
      vendor_data_no,  
      null                                  bilder,
      null                                  del_1,
      null                                  del_2,
      null                                  del_3,
      null                                  del_4,
      null                                  bil_1,
      null                                  bil_2,
      null                                  bil_3,
      null                                  bil_4
    from v_enhet2
    where 1=1
      -- Ikke   NY           HELLANOR 2006
      --        NYE OG GAMLE DEKK     2007
      --------------------------------------
    --  and var_bil_seq_no not in (41371,44780)
      -- På lager 
    --  and location_seq_no is not null 
    --  and location_seq_no <> 3300        --ekstern    
    order by merke_vasket, modell_vasket,del_vasket,scope,serie_no
    /
    grant all on v_enhet_html_katalog_item to public;
    --truncate table t_enhet2;
    insert into t_enhet2 select * from v_enhet2;
    commit;
    
    
    
    select to_char(sysdate,'hh24_mm_ss') from dual;
    select count(*) from v_enhet_html_katalog_item;
    #21452 med gammel t_enhet_html den 29.7.2012_07_29
    #22010 2012_07_30 etter retten til v_enhet2
    
    select count(*) from v_enhet2
    #22010 2012_07_30 
    #21963 2012_07_31
    
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select * from v_enhet_html_katalog_item where merke_vasket in ('AUDI') and modell_vasket='A6' and del_vasket='ABS-ENHET';  
    commit;
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog_item where merke_vasket in ('AUDI') and modell_vasket='A6';  
    commit;
    
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog_item where merke_vasket in ('AUDI') and modell_vasket='A6';  
    select distinct merke_vasket,modell_vasket,del_vasket from v_enhet_html_katalog where merke_vasket in ('AUDI') and modell_vasket='A6';    
    
    
    
    
    
    
----------------------------------------------------------- v_enhet_blobs_access ------------------------------------------------------------------------------------------
    create or replace view v_enhet_blobs_access as
    /* 
       2015_07_20 lagt inn flere felter slik at StocckOnNet kan bruke v_enhet_blobs isteden for enhet_blobs
    */
    select 
      blobs_seq_no,
      enhet_seq_no,
      file_name,
      file_format,
      res,
      description,
      date_in,
      date_nbf,
      date_lbk,
      date_net,
      date_sek,
      nbf_log_seq_no,
      lbk_log_seq_no,
      net_log_seq_no,
      thm_log_seq_no,
      date_thm,
      date_p_250,
      log_seq_no_p_250,
      decode(sort_order,null,999999+abs(blobs_seq_no),sort_order) as sort_order
    from ola.enhet_blobs
    /   
    
----------------------------------------------------------- v_enhet_blobs ------------------------------------------------------------------------------------------
    create or replace view v_enhet_blobs as
    /* 2012_03_01 bytter ut map_bil med var_bil
       2012_03_02 lagt inn seq_no..  + blob + vare_gruppe 
       2012_12_29 lagt inn overordnet del info
       2012_01_01 lagt inn NET_thm
       2015_07_18 lagt inn enhet_blobs.sort_order
    */
    select 
    blobs.blobs_seq_no                                                                      as blobs_seq_no,
    nvl(round(dbms_lob.GETLENGTH(blobs.blobs)/1024,1),0)                                    as blobs_kB,
    blobs.blobs_date                                                                        as blobs_date,
    blobs.blobs_format                                                                      as blobs_format,
    blobs.blobs                                                                             as blobs,
    v_enhet2.enhet_seq_no                                                                   as enhet_seq_no,
    v_enhet2.prev_enhet_seq_no                                                              as prev_enhet_seq_no,
    v_enhet2.vare_gruppe_seq_no                                                             as vare_gruppe_seq_no,
    v_enhet2.serie_seq_no                                                                   as serie_seq_no,
    v_enhet2.location_seq_no                                                                as location_seq_no,      
    v_enhet2.var_bil_seq_no                                                                 as var_bil_seq_no,        
    v_enhet2.paa_bil                                                                        as paa_bil,
    v_enhet2.hold_on                                                                        as hold_on, 
    v_enhet2.loc_id                                                                         as loc_id,
    v_enhet2.dato_inn                                                                       as dato_inn,
    v_enhet2.dato_ut                                                                        as dato_ut,
    v_enhet2.vare_gruppe_id                                                                 as vare_gruppe_id,
    v_enhet2.serie_no                                                                       as serie_no,
    v_enhet2.prev_serie_no                                                                  as prev_serie_no,
    enhet_blobs.sort_order                                                                  as sort_order,
    case 
       when (select count(*) from enhet_blobs where v_enhet2.enhet_seq_no=enhet_blobs.enhet_seq_no)>4 then 
           '<span style="background-color:yellow;">'||
            (select count(*) from enhet_blobs where v_enhet2.enhet_seq_no=enhet_blobs.enhet_seq_no)
            ||' bilder</span>'
      else  to_char(
            (select count(*) from enhet_blobs where v_enhet2.enhet_seq_no=enhet_blobs.enhet_seq_no))
    end                                                                                     as ant_bilder_av_del,
    enhet_blobs.date_lbk                                                                    as LBK_dato,
    enhet_blobs.date_nbf                                                                    as NBF_dato,
    enhet_blobs.date_net                                                                    as NET_dato,
    enhet_blobs.date_thm                                                                    as THM_dato,
    decode(v_map_status.ready_lbk,                                                          
             'nei','<span style="background-color:red;">LBK ikke klar</span>',              
             v_map_status.ready_lbk)                                                        as LBK_map,
    decode(v_map_status.ready_nbf,                                                          
             'nei','<span style="background-color:red;">NBF ikke klar</span>',              
             v_map_status.ready_nbf)                                                        as NBF_map,
    decode(v_map_status.ready_net,                                                          
             'nei','<span style="background-color:red;">NET ikke klar</span>',              
             v_map_status.ready_net)                                                        as NET_map
    --decode(nvl(dbms_lob.getlength(p.product_image),0) ,0,null,
    -- '<img src="'||apex_util.get_blob_file_src('P26_PRODUCT_IMAGE',p.product_id)||'" height="75" width="75" />')    img
    --eget form
    --P26_PRODUCT_IMAGE   1)Display as=Filbrowser 2)Storage Type=BLOB  3)Source type=Database column, PRODUCT_IMEGE
    --After header fetch DML på PK til pex_obas.demo_product_info 
    from  
     blobs.blobs        blobs,
     enhet_blobs        enhet_blobs,
      -- Disse tabellene skal ha likt antall som enhet
      --select (select count(*) from enhet) enhet, (select count(*) from v_enhet2) v_enhet2, (select count(*) from v_map_status) v_map_status from dual
     v_map_status       v_map_status,
     v_enhet2           v_enhet2
    where  1=1
      and v_enhet2.enhet_seq_no    = v_map_status.enhet_seq_no         
      and v_enhet2.enhet_seq_no    = enhet_blobs.enhet_seq_no          
      and enhet_blobs.blobs_seq_no = blobs.blobs_seq_no                
    order by blobs.blobs_date desc
    /
    
    select (select count(*) from enhet) enhet, 
    (select count(*) from v_enhet2) v_enhet2, 
    (select count(*) from v_map_status) v_map_status, 
    (select count(*) from v_enhet_blobs) v_enhet_blobs, 
    (select count(*) from enhet_blobs) enhet_blobs
    from dual;
    
    --     ENHET   V_ENHET2 V_MAP_STATUS       V_ENHET_BLOBS ENHET_BLOBS
    ------------ ---------- ------------      -------------  -----------
    --     89526      89526        89526                              2012_12_29
    --     89927      89927        89927                              2013_03_13
    --     99873      99873        99873                              2013_03_10
    --     111701     111701       111701                             2015_07_18    
    --     111706     111706       111706        100140      101268    2015_07_20
    select count(*) from v_enhet_blobs;
    --64202    2012_12_29 før endring
    
    
    
    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select * from v_enhet_blobs;
    commit;
    
    select to_char(date_thm,'yyyy-mm-dd'), count(*) from enhet_blobs group by to_char(date_thm,'yyyy-mm-dd') order by 1;
    TO_CHAR(DA   COUNT(*)
    ---------- ----------
    2013-01-05      14997
    2013-01-06      19386
    2013-01-08         50
    2013-01-09         52
    2013-01-10         38
    2013-01-11         37
    2013-01-13         44-->   34 604,  stemmer med katalog innhold
                    30149
    
----------------------------------------------------------- v_serie_no_neste_vrak ------------------------------------------------------------------------------------------
    create or replace view v_serie_no_neste_vrak as
      /*      Brukes av APEX p205 for å klarere neste mulige vraknr som både uni og bildeler kan enes om
      Dato        Endring
      ===         =======        
      2016_08_02  laget
      */
      select min(serie_seq_no) as serie_seq_no
      from  v_serie_no,
           (select serie_no 
            from v_serie_no
            where 1=1
            and use is null 
            and vrak_del='VRAK'
            --start punkt V27000 (serie_seq_no >204183)
            and serie_seq_no > 204183
            --uni er ute pr 2020-01-06 visma på vei inn samt hetrogenous link ikke oppe
            --fikset
            minus
            select 'V'||"Tilbudsnr" 
            --sqlplus ola/nei@192.168.1.3:1521/pdbobas
            --create table uni_2_tilbud as select "Tilbudsnr" from tilbud@uni_2
            --sqlplus ola/ola@192.168.1.7/pdbobas.bildeler.net
            --create table uni_2_tilbud as select * from uni_2_tilbud@obas_obas4
            -- from tilbud@uni_2
            from uni_2_tilbud
            --startpunkt
            where "Tilbudsnr" >27000
           ) driver
      where v_serie_no.serie_no = driver.serie_no
    
    
----------------------------------------------------------- v_serie_no ------------------------------------------------------------------------------------------
    create or replace view v_serie_no as
      select 
      /*      Brukes av APEX som dropdown /LOV
      Dato      Endring
      ===         =======        
      2014_03_02  laget
      2014_10_26  implementert med kun ubruket
      2016_08_02  legger også ut dato_inn på brukt
      */
        serie.serie_seq_no                           as serie_seq_no,
        decode(serie_anv_seq_no,1,'VRAK','DEL')       as vrak_del,
        decode(serie_anv_seq_no,1,'V','D')|| serie_no as serie_no,
        serie_sort_no,
        dato,
        --NOT-IN USE vil aldri vises, rettes ikke i tilfelle APEX klikker , har ikke tid til å fikse dette
        (select decode( enhet.serie_seq_no   ,enhet.serie_seq_no   ,'IN-USE','NOT-IN-USE') from enhet where serie.serie_seq_no=enhet.serie_seq_no) as USE,
        (select         enhet.location_seq_no                                              from enhet where serie.serie_seq_no=enhet.serie_seq_no) as location_seq_no,
        (select enhet_seq_no from enhet where serie.serie_seq_no=enhet.serie_seq_no) as enhet_seq_no,
        (select dato_inn     from enhet where serie.serie_seq_no=enhet.serie_seq_no) as enhet_dato_inn,
        (select dato_ut      from enhet where serie.serie_seq_no=enhet.serie_seq_no)  as enhet_dato_ut
      from serie
      order by nvl(serie_anv_seq_no,0),serie_sort_no
    /
    
    select count(*) from v_serie_no;
    --115 369
    --155 426   2020-06-08
        select   min (serie_seq_no)
        from v_serie_no
        where 1=1
        --er hull i nummer serien, finner alltid et  nytt nr på topp
        and serie_seq_no >(select max(serie_seq_no) from v_serie_no where use is not null and vrak_del='VRAK')
        and use is null
        and vrak_del='VRAK';
    
    
    
    truncate table plan_table;        
    commit;                           
    explain plan set statement_id='v_enhet_master' into plan_table for                               
    select * from v_serie_no ;                 
    commit; 
    
    
    create or replace view v_serie_no_bil as
    select 
    /*      Brukes av APEX som dropdown /LOV
    Dato      Endring
    ===         =======        
    2014_04_05  laget kopi av v_serie_no
    */
      serie.serie_seq_no                            as serie_seq_no,
      enhet.enhet_seq_no                            as enhet_seq_no,
      decode(serie_anv_seq_no,1,'VRAK','DEL')       as vrak_del,
      decode(serie_anv_seq_no,1,'V','D')|| serie_no as serie_no,
      serie_sort_no,
      dato
    from --(select serie_seq_no from serie 
          --minus
          --select serie_seq_no from enhet ) driver,
          serie,
          enhet
    --where driver.serie_seq_no = serie.serie_seq_no
    where enhet.serie_seq_no       = serie.serie_seq_no
    and   enhet.vare_gruppe_seq_no = 1
    order by nvl(serie_anv_seq_no,0),serie_sort_no
    /
    
    
----------------------------------------------------------- v_vare_gruppe ------------------------------------------------------------------------------------------
    create or replace view v_location as
        --create or replace view t as
        with inne as (  
                select location_seq_no,count(*) ant 
                from enhet 
                where location_seq_no is not null 
                group by location_seq_no ) 
        select 
            /*      
                2020-11-10 laget
            */
            location.location_seq_no, loc_id, loc_besk, export_yn,inne.ant as inne
        from location, inne
        where location.location_seq_no = inne.location_seq_no (+)
        order by export_yn,loc_id
    /

    select count(*) from location;
    #3583   --2020-11-10

    select count(*) from v_location;
    #3583   --2020-11-10

----------------------------------------------------------- v_vare_gruppe ------------------------------------------------------------------------------------------
    create or replace view v_vare_gruppe as
        --create or replace view t as
        select 
            /*      Brukes av PB og APEX som dropdown /LOV
                Dato      Endring
                ===         =======        
                2010_04_04  laget
                2012_02_22  v_del selttet og koden flytte som inline view i dette viewet, PB rkompilert og fikset
                2013_05_04  lagt in vare_gruppe_id_vasket
                2014_03_02  forbedret vare_gruppe visningen og lagt tilbake where nvl(dummy,'x') <>'Y' (kanskje trøbbel med plukke etter dette !!!
                2014_03_04  tatt vekk igjen siden dummyer brykes til overordnet mapping
                2014_04_23  lagt til vare_gruppe_pris_info
                */   
                --nvl(vare_gruppe_id_1,'- ')||' > '||nvl(vare_gruppe_id_2,'- ')||' > '||vare_gruppe_id_3    as vare_gruppe,
            nvl2(vare_gruppe_id_1,vare_gruppe_id_1||' > ',null)||nvl2(vare_gruppe_id_2,vare_gruppe_id_2||' > ',null)||vare_gruppe_id_3 as vare_gruppe,
            vare_gruppe_id_1                                                                            as nivaa_1,
            vare_gruppe_id_2                                                                            as nivaa_2,
            vare_gruppe_id_3                                                                            as nivaa_3,
            vare_gruppe_id_3                                                                            as vare_gruppe_id,
            f_vasket('DEL_VASKET',vare_gruppe_id_3)                                                     as vare_gruppe_id_vasket,
            v_del.vare_gruppe_seq_no                                                                    as vare_gruppe_seq_no,
            enhet.inne,
            enhet.solgt,
            prev_vare_gruppe_seq_no                                                                     as prev_vare_gruppe_seq_no,
            vare_gruppe_besk                                                                            as vare_gruppe_besk,
            dummy                                                                                       as dummy, 
            vare_gruppe_pris_info                                                                       as vare_gruppe_pris_info                     
        from (  select 
                    /*      Brukes av PB i datavindu: d_bil_d_tabpage_3 , Dele-historikk tabpage
                                     datavinduobjekt: d_bil_d_tabpage_3
                                     som drop down  : d_bil_d_enhet_dddw_vare_grp
                            og i v_vare_gruppe (som er laget på nytt etter 2006)         
                            Merk at INGEN hardkoding av loc_id is not null --> mer generelt
                    Dato  Endring
                    ===     =======    
                    25-10-2004  Laget
                    23-04-2006  byttet navn til v_del fra v_vare_gruppe
                    */                 
                      v_1.vare_gruppe_id           as vare_gruppe_id_1,
                      v_2.vare_gruppe_id           as vare_gruppe_id_2,
                      v_3.vare_gruppe_id           as vare_gruppe_id_3,
                      v_3.vare_gruppe_seq_no       as vare_gruppe_seq_no,
                      v_3.prev_vare_gruppe_seq_no  as prev_vare_gruppe_seq_no,
                      v_3.vare_gruppe_besk         as vare_gruppe_besk,
                      v_3.dummy                    as dummy,
                      v_3.vare_gruppe_pris_info    as vare_gruppe_pris_info
                    from                         
                        vare_gruppe     v_3,  --Nivå 3                    
                        vare_gruppe     v_2,  --Nivå 2                      
                        vare_gruppe     v_1   --Nivå 1
                    where 1=1
                        and v_3.prev_vare_gruppe_seq_no  = v_2.vare_gruppe_seq_no   (+)
                        and v_2.prev_vare_gruppe_seq_no  = v_1.vare_gruppe_seq_no   (+) 
                  ) v_del, 
                  ( --https://www.oracletutorial.com/oracle-basics/oracle-pivot/
                      --create or replace view tt as
                      select * from  
                        (   select  vare_gruppe_seq_no, 
                                    nvl2(location_seq_no, 'lagerfort','solgt')    as status, 
                                    count(*)                                      as ant 
                            from enhet 
                            group by vare_gruppe_seq_no, nvl2(location_seq_no, 'lagerfort','solgt')
                        )
                    pivot (sum(ant)   for status in ('lagerfort' inne,'solgt' solgt) )
                    order by 1
                ) enhet
            --Tar vekk dummy på laveste nivaa
            --må implementeres i aktuelle view som bruker spesielt:
            --V_PLUKKE_LISTE_DETAIL
            --V_PLUKKE_LISTE_DETAIL_2
            --V_PLUKKE_LISTE_DETAIL_VIEW
            --V_PLUKKE_LISTE_DETAIL_RAPP
            --where nvl(dummy,'x') <>'Y'
            --legg merke til siste sortering hvor - legges inn istedenfor space --> bedre sortering
        where v_del.vare_gruppe_seq_no = enhet.vare_gruppe_seq_no (+)
        order by decode(dummy,'T','A',dummy),nvl(vare_gruppe_id_1,'1'), nvl(vare_gruppe_id_2,'1'),f_vasket('DEL_VASKET',vare_gruppe_id_3)
    /
        
    grant select on v_vare_gruppe to public
    /

            truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select * from v_vare_gruppe;
            commit;

    select count(*) from v_var_bil;                         select count(*) from v_map_bil;
    select count(*) from v_vare_gruppe;                     select count(*) from v_map_bil;
            --451
            --690   2020-09-02
            --711   2020-10-25 før og etter pivot

            select count(*) from vare_gruppe;
            --711   2020-10-25 

        --test
            select * from v_vare_gruppe@obas6 where dummy='N'

    create or replace view v_vare_gruppe_fase2 as
        --create or replace view t as
        select distinct
            /*      Brukes av PB og APEX som dropdown /LOV
                Dato      Endring
                ===         =======        
                2010_04_04  laget
                2012_02_22  v_del selttet og koden flytte som inline view i dette viewet, PB rkompilert og fikset
                2013_05_04  lagt in vare_gruppe_id_vasket
                2014_03_02  forbedret vare_gruppe visningen og lagt tilbake where nvl(dummy,'x') <>'Y' (kanskje trøbbel med plukke etter dette !!!
                2014_03_04  tatt vekk igjen siden dummyer brykes til overordnet mapping
                2014_04_23  lagt til vare_gruppe_pris_info
                */   
                --nvl(vare_gruppe_id_1,'- ')||' > '||nvl(vare_gruppe_id_2,'- ')||' > '||vare_gruppe_id_3    as vare_gruppe,
            nvl2(vare_gruppe_id_1,vare_gruppe_id_1||' > ',null)||nvl2(vare_gruppe_id_2,vare_gruppe_id_2||' > ',null)||vare_gruppe_id_3 as vare_gruppe,
            vare_gruppe_id_1                                                                            as nivaa_1,
            vare_gruppe_id_2                                                                            as nivaa_2,
            vare_gruppe_id_3                                                                            as nivaa_3,
            vare_gruppe_id_3                                                                            as vare_gruppe_id,
            f_vasket('DEL_VASKET',vare_gruppe_id_3)                                                     as vare_gruppe_id_vasket,
            vare_gruppe_seq_no                                                                          as vare_gruppe_seq_no,
            prev_vare_gruppe_seq_no                                                                     as prev_vare_gruppe_seq_no,
            vare_gruppe_besk                                                                            as vare_gruppe_besk,
            dummy                                                                                       as dummy, 
            vare_gruppe_pris_info                                                                       as vare_gruppe_pris_info                     
        from (  select 
                    /*      Brukes av PB i datavindu: d_bil_d_tabpage_3 , Dele-historikk tabpage
                                     datavinduobjekt: d_bil_d_tabpage_3
                                     som drop down  : d_bil_d_enhet_dddw_vare_grp
                            og i v_vare_gruppe (som er laget på nytt etter 2006)         
                            Merk at INGEN hardkoding av loc_id is not null --> mer generelt
                    Dato  Endring
                    ===     =======    
                    25-10-2004  Laget
                    23-04-2006  byttet navn til v_del fra v_vare_gruppe
                    */                 
                      v_1.vare_gruppe_id           as vare_gruppe_id_1,
                      v_2.vare_gruppe_id           as vare_gruppe_id_2,
                      v_3.vare_gruppe_id           as vare_gruppe_id_3,
                      v_3.vare_gruppe_seq_no       as vare_gruppe_seq_no,
                      v_3.prev_vare_gruppe_seq_no  as prev_vare_gruppe_seq_no,
                      v_3.vare_gruppe_besk         as vare_gruppe_besk,
                      v_3.dummy                    as dummy,
                      v_3.vare_gruppe_pris_info    as vare_gruppe_pris_info
                    from                         
                        vare_gruppe_fase2     v_3,  --Nivå 3                    
                        vare_gruppe_fase2     v_2,  --Nivå 2                      
                        vare_gruppe_fase2     v_1   --Nivå 1
                    where 1=1
                        and v_3.prev_vare_gruppe_seq_no  = v_2.vare_gruppe_seq_no   (+)
                        and v_2.prev_vare_gruppe_seq_no  = v_1.vare_gruppe_seq_no   (+) 
                  ) v_del 
        where vare_gruppe_seq_no not between 120000 and 150000
                --Tar vekk dummy på laveste nivaa
                --må implementeres i aktuelle view som bruker spesielt:
                --V_PLUKKE_LISTE_DETAIL
                --V_PLUKKE_LISTE_DETAIL_2
                --V_PLUKKE_LISTE_DETAIL_VIEW
                --V_PLUKKE_LISTE_DETAIL_RAPP
                --where nvl(dummy,'x') <>'Y'
            order by nvl(vare_gruppe_id_1,'1'), nvl(vare_gruppe_id_2,'1'),vare_gruppe_id_3
    /

    select count(*) from v_vare_gruppe;
    --472
    select count(*) from v_vare_gruppe_fase2;


    create or replace view v_vare_gruppe_ant as
        select 
        /*      
        Dato        Endring
        ===         =======        
        2012_02_23  laget
        */   
        vare_gruppe,
        nivaa_1,
        nivaa_2,
        nivaa_3,
        vare_gruppe_id,
        vare_gruppe_seq_no,
        prev_vare_gruppe_seq_no,
        vare_gruppe_besk,
        dummy,
        (select count(*) 
        from enhet 
        where vare_gruppe_seq_no = v_vare_gruppe.vare_gruppe_seq_no
        and   location_seq_no is not null)                             ant_inne,
        (select count(*) 
        from enhet 
        where vare_gruppe_seq_no = v_vare_gruppe.vare_gruppe_seq_no
        and   location_seq_no is null)                                 ant_solgt,
        (select count(*) 
        from enhet 
        where vare_gruppe_seq_no = v_vare_gruppe.vare_gruppe_seq_no)   ant_tot
        from v_vare_gruppe
        order by vare_gruppe
        /
    
----------------------------------------------------------- v_var_bil_fab_type ------------------------------------------------------------------------------------------
    create or replace view v_var_bil_fab_type as
    select distinct  
    /*
    ==========       
    2014_11_04 laget som kopi av v_var_bil til bruk i Padde apex
    */                 
      fabrikant.fab_navn||' '||type.type_id      as fab_type,
      fabrikant.fab_seq_no||type.type_seq_no     as fab_type_seq_no, 
      fabrikant.fab_seq_no,
      type.type_seq_no,
      fabrikant.fab_navn,
      type.type_id 
    from var_bil,
         fabrikant,
         type
    where 1=1     
    and   var_bil.fab_seq_no  = fabrikant.fab_seq_no
    and   var_bil.type_seq_no = type.type_seq_no
    order by fab_navn, type_id
    /
    grant all on v_var_bil_fab_type to public;
    select count(*) from v_var_bil_fab_type;
    #719 2014-11-04
    
    
          
----------------------------------------------------------- v_var_bil ------------------------------------------------------------------------------------------
    --drop table v_var_bil;
    --create table v_var_bil as 
    create or replace view v_var_bil as
        --create or replace view t as
            /*
                                    Forutsetter:   
                                    grant select on ola.var_bil     to public
                                    grant select on ola.fabrikant   to public
                                    grant select on ola.type        to public            
                                    grant select on ola.aar_model   to public            
                ==========       
                2011_01_30 laget
                2011_02_02 lagt inn aar fra v_bil som utgår, opprinnlige aar kolonne heter nå aar_d
                2011_02_19 legger ut fab,type aar kallt obas til bruk i mapping av takst APEX
                2012_02_09 byttet ut ola.bilkod med ekstern.v_nbf_bilkod
                             dependencies   v_map_bil    
                                           v_var_bil
                2012_03_01 byttet ut ola.xbnavn med ekstern.v_lbk_xbnavn    
                2012_07_29 legger inn type_klasse 
                2012_11_08 tull i SMS ref nvl(lbknr.... når det skulle vært nvl(sbrnr 
                2013_05_17 decode mot merkenavn Fra vegdir + DEAKTIVISERT NVL2
                2013_06_23 nvl2(type.type_klasse,type.type_klasse,'BIL')  istede for ,type.type_klasse
                2014_02_04 nvl(var_bil_scope_seq_no,-var_bil_seq_no) as c_var_bil_scope_seq_no til bruk i plukkelisten v_plukke2
                2015_03_06 lagt inn ant tecdoc i Valldal    
                2015_08_31 lagt inn f_scope_sok dva scope_range
                2015_12_12 lagt inn type_parent
                */                 
        with 
            full as (
                select  
                    var_bil.var_bil_seq_no                                                                                                    var_bil_seq_no,
                    nvl2(var_bil.var_bil_seq_no,(select fabrikant.fab_navn||' '||type.type_id||' '||to_char(aar_model.aar,'yyyy')
                                                from fabrikant,
                                                     type,
                                                     aar_model
                                                where 1=1     
                                                and   var_bil.fab_seq_no  = fabrikant.fab_seq_no
                                                and   var_bil.type_seq_no = type.type_seq_no
                                                and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                ),null)                                                                                       obas,
                    var_bil.fab_seq_no                                                                                                        fab_seq_no,
                    nvl2(var_bil.var_bil_seq_no,(select fabrikant.fab_navn
                                                from fabrikant
                                                where 1=1     
                                                and   var_bil.fab_seq_no  = fabrikant.fab_seq_no
                                                ),null)                                                                                       fab_navn,
                    var_bil.type_seq_no                                                                                                       type_seq_no,
                    nvl2(var_bil.var_bil_seq_no,(select type.type_parent
                                                from type
                                                where 1=1     
                                                and   var_bil.type_seq_no = type.type_seq_no
                                                ),null)                                                                                       type_parent,    
                    nvl2(var_bil.var_bil_seq_no,(select type.type_id
                                                from type
                                                where 1=1     
                                                and   var_bil.type_seq_no = type.type_seq_no
                                                ),null)                                                                                       type_id,
                    nvl2(var_bil.var_bil_seq_no,(select nvl2(type.type_klasse,type.type_klasse,'BIL')
                                                from type
                                                where 1=1     
                                                and   var_bil.type_seq_no = type.type_seq_no
                                                ),null)                                                                                       type_klasse,
                    var_bil.aar_seq_no                                                                                                        aar_seq_no,
                    nvl2(var_bil.var_bil_seq_no,(select aar_model.aar
                                                from aar_model
                                                where 1=1     
                                                and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                ),null)                                                                                       aar_d,
                    nvl2(var_bil.var_bil_seq_no,(select to_char(aar_model.aar,'yy')
                                                from aar_model
                                                where 1=1     
                                                and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                ),null)                                                                                       aar,
                    nvl2(var_bil.var_bil_seq_no,(select to_char(aar_model.aar,'yyyy')
                                                from aar_model
                                                where 1=1     
                                                and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                ),null)                                                                                       aar_4,
                    var_bil.date_in                                                                                                           date_in,
                    var_bil.date_upd                                                                                                          date_upd,
                        var_bil.var_bil_scope_seq_no                                                                                          var_bil_scope_seq_no,
                    nvl(var_bil.var_bil_scope_seq_no,-var_bil.var_bil_seq_no)                                                               c_var_bil_scope_seq_no,  
                    var_bil.var_bil_desc                                                                                                      var_bil_desc,
                    var_bil.lbknr                                                                                                             lbknr,
                    nvl2(var_bil.lbknr,(select xbnavn.merke||' '||xbnavn.type 
                                       from v_lbk_xbnavn xbnavn
                                       where 1=1     
                                       and var_bil.lbknr = xbnavn.lbknr
                                      ),null)                                                                                                 lbk,                  
                    var_bil.sbrnr                                                                                                             sbrnr,
                    nvl2(var_bil.sbrnr,(select bilkod.bilkodnamnnorge 
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),null)                                                                                                 nbf,
                    nvl2(var_bil.sbrnr,(select bilkod.nbf_start 
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),null)                                                                                                 nbf_start,
                    nvl2(var_bil.sbrnr,(select bilkod.nbf_slutt 
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),null)                                                                                                 nbf_slutt,
                    nvl2(var_bil.sbrnr,(select bilkod.startar
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),null)                                                                                                 nbf_startar,
                    nvl2(var_bil.sbrnr,(select bilkod.slutar
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),null)                                                                                                 nbf_slutar,
                    ---------
                    --SCOPE--
                    --------- 
                    nvl2(var_bil.var_bil_scope_seq_no,(select var_bil_scope.scope_start
                                                       from var_bil_scope
                                                       where 1=1     
                                                       and   var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no
                                                      ),null)                                                                                 scope_start,
                    nvl2(var_bil.var_bil_scope_seq_no,(select var_bil_scope.scope_stop
                                                       from var_bil_scope
                                                       where 1=1     
                                                       and   var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no
                                                      ),null)                                                                                 scope_stop,
                    --Hvis var_bil_seq_no finnes
                    --1) range fom, tom       1991 1992 1993 osv
                    --2) range fom            +50år
                    --3) range      tom       -50år
                    --4) range          null  1991  år bli laget inn fra var_bil
                    nvl2(var_bil.var_bil_seq_no,nvl(f_scope_sok(var_bil.var_bil_scope_seq_no,'RANGE'),
                                                    (select to_char(aar_model.aar,'yyyy')
                                                      from aar_model
                                                      where 1=1     
                                                      and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                    )
                                                )    
                                                ,null)                                                                                       scope_range,
                    nvl2(var_bil.var_bil_scope_seq_no,(select f_scope ('SCOPE_START_CHR',var_bil_scope.scope_start,var_bil_scope.scope_stop)
                                                       from var_bil_scope
                                                       where 1=1     
                                                       and   var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no
                                                      ),null)                                                                                 scope_start_chr,
                    nvl2(var_bil.var_bil_scope_seq_no,(select f_scope ('SCOPE_STOP_CHR',var_bil_scope.scope_start,var_bil_scope.scope_stop)
                                                       from var_bil_scope
                                                       where 1=1     
                                                       and   var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no
                                                      ),null)                                                                                 scope_stop_chr,
                    nvl2(var_bil.var_bil_scope_seq_no,(select f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop)                                                                              
                                                       from var_bil_scope
                                                       where 1=1     
                                                       and   var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no
                                                      ),
                                                      (select to_char(aar_model.aar,'yyyy')  --v_var_bil.aar_4
                                                       from aar_model
                                                       where 1=1     
                                                       and   var_bil.aar_seq_no  = aar_model.aar_seq_no
                                                      )
                        )                                                                                                                     scope,
                    ----------
                    --VEGDIR--
                    ----------   
                    --nvl2(var_bil.merke_navn,var_bil.merke_navn,
                          --samme dokoding som i vegdir.v_vokbkort
                                           (select vegdir_merkenavn.merke_navn
                                             from fabrikant,
                                                  vegdir_t_distinct_merkenavn vegdir_merkenavn
                                             where 1=1
                                             and   var_bil.fab_seq_no = fabrikant.fab_seq_no
                                             and   decode(fabrikant.fab_navn,  'MERCEDES',  'MERCEDES-BENZ',
                                                       'VW',    'VOLKSWAGEN',
                                                       'LADA',    'VAZ',  
                                                       fabrikant.fab_navn
                                                     )= vegdir_merkenavn.merke_navn            
                                           )--)
                                                                                                                                              merke_navn,
                    ----------
                    --TECDOC--
                    ----------
                    nvl2(var_bil.sbrnr,(select bilkod.ant_tecdocnr 
                                       from v_nbf_bilkod bilkod
                                       where 1=1
                                       and aktiv=1
                                       and var_bil.sbrnr= bilkod.bilkod
                                      ),0)                                                                                                 ant_tecdocnr                                                                                                                        
                from var_bil                              var_bil
                where 1=1
                )
        select 
             var_bil_seq_no         
            ,obas                   
            ,fab_seq_no             
            ,fab_navn               
            ,type_seq_no            
            ,type_parent            
            ,type_id                
            ,type_klasse            
            ,aar_seq_no             
            ,aar_d                  
            ,aar                    
            ,aar_4                  
            ,date_in                
            ,date_upd               
            ,var_bil_scope_seq_no   
            ,c_var_bil_scope_seq_no 
            ,var_bil_desc 
            --------vasket          
            ,cast( f_vasket('MERKE_VASKET' ,fab_navn)                                                            as varchar2(30) ) as vasket_merke
            ,cast( f_vasket('MODELL_VASKET',type_id)                                                             as varchar2(30) ) as vasket_modell
            ,cast( f_vasket('SCOPE_VASKET' ,nvl(f_scope ('SCOPE',scope_start,scope_stop),to_char(aar_d,'yyyy'))) as varchar2(30) ) as vasket_scope
            ---------
            ,lbknr                  
            ,lbk                    
            ,sbrnr                  
            ,nbf                    
            ,nbf_start              
            ,nbf_slutt              
            ,nbf_startar            
            ,nbf_slutar             
            ,scope_start            
            ,scope_stop             
            ,scope_range            
            ,scope_start_chr        
            ,scope_stop_chr         
            ,scope                  
            ,merke_navn             
            ,ant_tecdocnr    
        from full       
        order by fab_navn, type_id,aar,scope
    /
    
    grant all on v_var_bil to public;
    
    --create index  v_var_bil_i1 on  v_var_bil (var_bil_seq_no);

    select count(*) from v_var_bil;                         select count(*) from v_map_bil;
        --2446 2012_03_01 før og etter
        --2476 2012_04_21
        --2510 2012_07_29 før og etter
        --4891 2014_10_03
        --5381 2015_03_06 Valldal
        --5725 2015_08_31 for og etter scope_range
        --8115 2018_05_19
        --8580 2019_10_02
        --8435 2020_07_03
        --8467 2020-11-01                                   12061   2020-11-01
        --8457 2020-11-28                                   12047   2020-11-01

    --konsistens
    "1 pri ref integritet konsistens enhet"
        select var_bil_seq_no from enhet    minus select var_bil_seq_no from var_bil;
            #0  2020-07-03 ok
    
    "2a pri ref integritet var_bil type"
        select fab_seq_no    from var_bil  minus select fab_seq_no from fabrikant;
            #0  2020-07-03 ok

    "2b pri ref integritet var_bil type"
        select type_seq_no    from var_bil  minus select type_seq_no from type;
            #0  2020-07-03 ok

    "2c pri ref integritet var_bil type"
        select aar_seq_no    from var_bil  minus select aar_seq_no from aar_model;
            #0  2020-07-03 ok

    "3a fab_navn uikt"
        select fab_navn, count(*) from fabrikant group by fab_navn having count(*) >1;
            #0  2020-07-03 ok

    "3b type_id uikt"
        select type_id, count(*) from type group by type_id having count(*) >1;
            #0  2020-07-03 ok

    "3c aar uikt"
        select aar, count(*) from aar_model group by aar having count(*) >1;
            #0  2020-07-03 ok


    select fab_seq_no, type_seq_no, aar_seq_no, count(*) from var_bil group by fab_seq_no, type_seq_no, aar_seq_no having count(*) >1;
        --0

    select count(*) from var_bil;
        --8115  2018_05_19
        --8580  2019_10_02
        --8434  2020_07_04
   

    select var_bil_seq_no, count(*) from v_var_bil group by var_bil_seq_no having count(*) >1;
    --0

    truncate table plan_table;
    explain plan set statement_id='732' into plan_table for 
    select * from v_var_bil;
    commit;

    select type_id, count(*)
    from type
    group by type_id
    having count(*) >1
    order by type_id;
        S KLASSE W126                           2   101342  103793
        S KLASSE W126 FACELIFT                  2   103792  103794
        TILHENGER                               3   102948  103336
        VJ125                                   2   46241   46683
    
    --king cab D2   
        delete from type where type_seq_no=103967;
    --moped
        47625
        104667
        delete from type where type_seq_no=47625;
    --før
            select var_bil_seq_no from enhet    minus select var_bil_seq_no from var_bil;
                --tomt
                    select var_bil_seq_no from enhet
                    intersect
                    select var_bil_seq_no from var_bil where var_bil_seq_no in (50348,103181);
                    insert into var_bil select * from var_bil@obas4 where var_bil_seq_no in (50348,103181);
                    delete from var_bil where var_bil_seq_no in (50348,103181);
            select type_seq_no    from var_bil  minus select type_seq_no from type;
                105907
                    insert into type select * from type@obas4 where type_seq_no in (105907);
        
    --S KLASS W126
        update enhet set var_bil_seq_no = 22551 where var_bil_seq_no= 107949;
        --update var_bil set type_seq_no =101342 where type_seq_no=103793;
        delete var_bil where var_bil_seq_no= 107949;
        --delete from type where type_seq_no=103793;

        select var_bil_seq_no from enhet
        intersect
        select var_bil_seq_no from v_var_bil where type_id='S KLASSE W126';
        update enhet set var_bil_seq_no = 384 where var_bil_seq_no= 107945;

        delete from var_bil where var_bil_seq_no in (107944,107945,107946,107947,107948,107949);
        delete from type where type_seq_no=103793;

    --S KLASS W126 FACELIFT
        select var_bil_seq_no from enhet
        intersect
        select var_bil_seq_no from v_var_bil where type_id='S KLASSE W126 FACELIFT';
        delete from var_bil where var_bil_seq_no in (107937,107938,107939,107940,107941,107942,107943);
        delete from type where type_seq_no=103794;

    --TILGENGER
        select var_bil_seq_no from enhet
        intersect
        select var_bil_seq_no from v_var_bil where type_id='TILHENGER';
            111661

        delete from type where type_seq_no = 102948;
        delete from type where type_seq_no = 101319;
        delete from var_bil where type_seq_no=102948 and fab_seq_no <>51159;
        delete from var_bil where type_seq_no=103336 and var_bil_seq_no <>111661;

    --VJ125
        select var_bil_seq_no from enhet
        intersect
        select var_bil_seq_no from v_var_bil where type_id='VJ125';

        delete from var_bil where var_bil_seq_no in (47766,49011);
        delete from type where type_seq_no in (46241,46683);

    --111940
        select var_bil_seq_no from enhet
        intersect
        select var_bil_seq_no from var_bil where var_bil_seq_no=111940;
        delete from var_bil where var_bil_seq_no in (111940);

    --DAELIM
        update var_bil set fab_seq_no = 43140 where fab_seq_no=43241;
        delete from fabrikant where fab_seq_no=43241;




----------------------------------------------------------- v_t_enhet_full_nbf ------------------------------------------------------------------------------------------
    create or replace view v_t_enhet_full_nbf as
    select
    /*      Erstatter t_enhet_full, med kun
      deler p† lager og ALLE bilene til disse delene
    2010_12_12  A BIL     --distinct         171
        B DEL     --count   --> 20959 2010_12_12   (21371 i MySQL)
            --distinct  --> 20959 2010_12_12  (21371 i MySQL)
        C ALLE BIL  --distinct  -->  2036 2010_12_12
              sum  171+20959+2036 =23166
              union      23136   diff 30
    Dato      Endring
    ===     =======
    2010_12_12    laget
    2012_03_01    bytter ut map_bil med var_bil
    */
    --A)BIL inne
         enhet_seq_no
      from   t_enhet_full    obas,
        var_bil      var_bil
      where  obas.var_bil_seq_no  = var_bil.var_bil_seq_no
      and   obas.vare_gruppe_seq_no =1
      and   obas.loc_id is not null
      and   obas.loc_id not in ('V_KLAR_PRESSING')
      and   substr(obas.reg_no,4,1) is not null       -- maa ha en fornuftig del av reg -no i pos 4, ref Reg-no inng†r i bildene
      and  var_bil.sbrnr is not null
    union
    --B del
      select enhet_seq_no
      from   t_enhet_full    obas,
        map_del      map_del
      where
              decode(obas.vare_gruppe_seq_no,2824,
                                                  decode(obas.k_grp_id,     'COMBIE'      ,99999998, 'STASJONSVOGN',99999999,2824),
                                                3,decode(obas.motor_type_id,'D'           ,99999995,99999994),
                      obas.vare_gruppe_seq_no)
                                     = map_del.vare_gruppe_seq_no
      and   obas.vare_gruppe_seq_no <>1
      and   obas.loc_id is not null
      and  map_del.sbrnr is not null
    union
    --C BIL som overordnet del for ALLE deler
    --  (evnt p† nytt noen av de bilene vi plukket fra A
    select bil.enhet_seq_no
    from (select pre_enhet_seq_no
          from   t_enhet_full    obas,
            map_del      map_del
          where
                  decode(obas.vare_gruppe_seq_no,2824,
                                                      decode(obas.k_grp_id,     'COMBIE'      ,99999998, 'STASJONSVOGN',99999999,2824),
                                                    3,decode(obas.motor_type_id,'D'           ,99999995,99999994),
                          obas.vare_gruppe_seq_no)
                                         = map_del.vare_gruppe_seq_no
          and   obas.vare_gruppe_seq_no <>1
          and   obas.loc_id is not null
          and  map_del.sbrnr is not null )   del,
          t_enhet_full        bil
    where del.pre_enhet_seq_no = bil.enhet_seq_no
    and   substr(bil.reg_no,4,1) is not null       -- maa ha en fornuftig del av reg -no i pos 4, ref Reg-no inng†r i bildene
    /
    
    
----------------------------------------------------------- v_log_run_LBKtoOBAS ------------------------------------------------------------------------------------------
    create or replace view v_log_run_lbktoobas as
        /* 
          Alle v_log_xxxx brukes til spoolon av evnt resultat ved insert i log_run tabellen  
          xxxx må stemme med f.ks mobil, lbktoobas, lbktoobas etc
        --How to format 
        --http://dbaforums.org/oracle/index.php?showtopic=1259  
        Dato      Endring
        ===         =======        
        2012_02_05  laget
        2012_02_29  flyttet fra ekstern v_log_lbktoobas til ola.v_log_run_lbktoobas
        */   
        select 'v_log_lbktoobas status '||to_char(sysdate,'DD-MON-YYYY HH24:MI:SS') as status
        from dual
        union all
        select 'ekstern.lbk_t_xxx tabell status etter henting av data fra LBK' from dual
        union all
        select 
                                      --12345678901234567890        
                                       '#_t_bilk '||               
                                       '#_t_delk '||               
                                       't_medlnr '||               
                                       't_medlemsnamn____   '||      
                                       '#_t_delr '               
        from dual                              
        union all
        select  
          rpad(ant_t_bilkod  ,9)        ||
          rpad(ant_t_delkod  ,9)        ||
          rpad(t_medlemsnr   ,9)        ||
          rpad(substr(t_medlemsnamn,1,18) ,20)       ||
          rpad(ant_t_deler   ,9)        
        from
        (select count(*) as ant_t_bilkod  from lbk_t_xbnavn) t2,
        (select count(*) as ant_t_delkod  from lbk_t_xdnavn) t3,
        (select '' as t_medlemsnr, '' as t_medlemsnamn, '' as ant_t_deler from dual) t5
        --(select lagabasen.medlemsnr t_medlemsnr, medlemsnamn  t_medlemsnamn, count(*) as ant_t_deler 
        -- from ekstern.nbf_t_lagabasen lagabasen,
        --       ekstern.nbf_t_medlem     medlem
        -- where  lagabasen.medlemsnr = medlem.medlemsnr(+)      
        -- group by lagabasen.medlemsnr, medlemsnamn order by lagabasen.medlemsnr)                     t5
        union all
        select 'ekstern.lbk_xxx tabell status etter henting OG konvertering av data fra LBK' from dual
        union all
        select 
                                      --12345678901234567890        
                                       '#___bilk '||               
                                       '#___delk '||               
                                       '__medlnr '||               
                                       '__medlemsnamn____   '||      
                                       '#___delr'                
        from dual                              
        union all
        select  
          rpad(ant_bilkod    ,9)        ||
          rpad(ant_delkod    ,9)        ||
          rpad(medlemsnr     ,9)        ||
          rpad(substr(medlemsnamn,1,18)   ,20)       ||
          rpad(ant_deler     ,9)           
        from
        (select count(*) as ant_bilkod    from lbk_xbnavn where date_hist is null)   t22,
        (select count(*) as ant_delkod    from lbk_xdnavn where date_hist is null)   t33,
        (select '' as medlemsnr, '' as medlemsnamn, '' as ant_deler from dual)                t55
        --(select lagabasen.medlemsnr medlemsnr, medlemsnamn  medlemsnamn, count(*) as ant_deler 
        -- from ekstern.nbf_lagabasen lagabasen,
        --       ekstern.nbf_medlem     medlem
        -- where  lagabasen.medlemsnr = medlem.medlemsnr(+)    
        -- and    lagabasen.date_hist is null  
        -- group by lagabasen.medlemsnr, medlemsnamn order by lagabasen.medlemsnr)                     t55
    / 
    grant select on v_log_run_lbktoobas to public;
    
----------------------------------------------------------- v_log_run_nbftoobas ------------------------------------------------------------------------------------------
    create or replace view v_log_run_nbftoobas as
            /* 
              Alle v_log_xxxx brukes til spoolon av evnt resultat ved insert i log_run tabellen  
              xxxx må stemme med f.ks mobil, nbftoobas, lbktoobas etc
            --How to format 
            --http://dbaforums.org/oracle/index.php?showtopic=1259  
            Dato      Endring
            ===         =======        
            2012_02_05  laget
            2012_02_29  flyttet fra ekstern v_log_nbftoobas til ola.v_log_run_nbftoobas
            */   
            select 'v_log_nbftoobas status '||to_char(sysdate,'DD-MON-YYYY HH24:MI:SS') as status
            from dual
            union all
            select 'ekstern.nbf_t_xxx tabell status etter henting av data fra lagabasen' from dual
            union all
            select 
                                          --12345678901234567890        
                                           '#_t_medl '||              
                                           '#_t_bilk '||               
                                           '#_t_delk '||               
                                           '#_t_tecd '||               
                                           't_medlnr '||               
                                           't_medlemsnamn____   '||      
                                           '#_t_delr '               
            from dual                              
            union all
            select  
              rpad(ant_t_medlem   ,9)        ||
              rpad(ant_t_bilkod  ,9)        ||
              rpad(ant_t_delkod  ,9)        ||
              rpad(ant_t_tecdok  ,9)        ||
              rpad(t_medlemsnr   ,9)        ||
              rpad(substr(t_medlemsnamn,1,18) ,20)       ||
              rpad(ant_t_deler   ,9)        
            from
            (select count(*) as ant_t_medlem  from nbf_t_medlem) t1,
            (select count(*) as ant_t_bilkod  from nbf_t_bilkod) t2,
            (select count(*) as ant_t_delkod  from nbf_t_delkod) t3,
            (select count(*) as ant_t_tecdok  from nbf_t_tecdok) t4,
            (select lagabasen.medlemsnr t_medlemsnr, medlemsnamn  t_medlemsnamn, count(*) as ant_t_deler 
             from  nbf_t_lagabasen lagabasen,
                   nbf_t_medlem     medlem
             where  lagabasen.medlemsnr = medlem.medlemsnr(+)      
             group by lagabasen.medlemsnr, medlemsnamn order by lagabasen.medlemsnr)                     t5
            union all
            select 'ekstern.nbf_xxx tabell status etter henting OG konvertering av data fra lagabasen' from dual
            union all
            select 
                                          --12345678901234567890        
                                           '#___medl '||               
                                           '#___bilk '||               
                                           '#___delk '||               
                                           '#___tecd '||               
                                           '__medlnr '||               
                                           '__medlemsnamn____   '||      
                                           '#___delr'                
            from dual                              
            union all
            select  
              rpad(ant_medlem    ,9)        ||
              rpad(ant_bilkod    ,9)        ||
              rpad(ant_delkod    ,9)        ||
              rpad(ant_tecdok    ,9)        ||
              rpad(medlemsnr     ,9)        ||
              rpad(substr(medlemsnamn,1,18)   ,20)       ||
              rpad(ant_deler     ,9)           
            from
            (select count(*) as ant_medlem    from nbf_medlem where date_hist is null)   t11,
            (select count(*) as ant_bilkod    from nbf_bilkod where date_hist is null)   t22,
            (select count(*) as ant_delkod    from nbf_delkod where date_hist is null)   t33,
            (select count(*) as ant_tecdok    from nbf_tecdok where date_hist is null)   t44,
            (select lagabasen.medlemsnr medlemsnr, medlemsnamn  medlemsnamn, count(*) as ant_deler 
             from  nbf_lagabasen lagabasen,
                   nbf_medlem     medlem
             where  lagabasen.medlemsnr = medlem.medlemsnr(+)    
             and    lagabasen.date_hist is null  
             group by lagabasen.medlemsnr, medlemsnamn order by lagabasen.medlemsnr)                     t55
    / 
    grant select on v_log_run_nbftoobas to public;
    
    
----------------------------------------------------------- v_log ------------------------------------------------------------------------------------------
    create or replace view v_log as
    select
    /*
    Dato          Endring
    ===        =======
    2012_02_07 laget
    */
    log.log_seq_no as log_seq_no,
      case when log.log_id ='OBAS_BLOBS_LBK'   then '<span style="background-color:green;">'||log.log_seq_no||'</span>'
      else to_char(log.log_seq_no)      
      end                                as log_seq_no_display,            
      case when log.log_id ='OBAS_BLOBS_LBK'   then '<span style="background-color:green;">'||log.log_id||'</span>'
            --when log.log_id ='OBAS_BLOBS_NET'   then '<span style="background-color:blue;  ">'||log.log_id||'</span>'
            --when log.log_id ='OBAS_BLOBS_NBF'   then '<span style="background-color:red;   ">'||log.log_id||'</span>'
      else log.log_id      
      end                                as log_id,
      case when log.log_id ='OBAS_BLOBS_LBK'   then '<span style="background-color:green;">'||log.notes||'</span>'
      else log.notes      
      end                                as notes,
    log.log_date                        log_date,
    log.log_stamp                    as log_stamp,               
    log.apex_app_files_name             apex_app_files_name,    
    log.apex_app_files_filename         apex_app_files_filename,
      case when blobs_log.log_seq_no is not null   then '<span style="background-color:yellow;font-weight:bold;">'||blobs_log.ant||'</span>'
            --when sal between 1000 and 2000   then 'purple'
            --when sal > 2000       then 'green'
      end                                as ant
    from ola.log           log,
         (select log_seq_no,  count(*) ant
          from blobs.blobs_log 
          group by log_seq_no)   blobs_log
    where log.log_seq_no = blobs_log.log_seq_no(+)
    /
    grant all on v_log to public;
    select count(*) from v_log;
         
    
    
    
    
    
    select count(*) from hellanor_pris;        11226    11226
    select count(*) from v_hellanor;          11226    11776  select vendor_data_no,count(*) from v_hellanor having count(*) >1 group by vendor_data_no;
    select count(*) from v_hellanor_hellanor; 11226    11226
    select count(*) from v_hellanor_obas;      3925    3925

----------------------------------------------------------- v_hellanor_hellanor ------------------------------------------------------------------------------------------
    CREATE OR REPLACE FORCE VIEW  "V_HELLANOR_HELLANOR" ("MATERIALNR", "VENDOR_DATA_NO", "BESKRIVELSE", "RK", "RAB_MATGRKODE", "RAB_MATGRTEKST", "VEILPRIS", "VPENHET", "PRISLISTE", "PRIS", "PRIS_INKL_MVA", "ENHET", "RABATT", "RAB_KUNRAB", "EKSTRA", "NETTONETTO", "NNENHET", "EAN", "PRODUKTHIERARKI", "MILJO", "MILJOGEB", "PANT", "BLYTILLEGG", "KODE", "AVGIFT", "NETTOPRIS", "NPENHET", "FRADATO", "TILDATO", "KAMPPRIS", "KPENHET", "KUNDENR", "RAB_KUNDE") AS 
      select
    /*
    se v_vendor_data for statistikk
    Dato          Endring
    ===        =======
    2010_05_05 laget
    */
    MATERIALNR         as MATERIALNR,
    substr(regexp_replace(substr(materialnr,4,30),' ',''),1,50)    as vendor_data_no,
    BESKRIVELSE        as BESKRIVELSE,
    RK                 as RK,
    matgrkode    as rab_matgrkode,
    matgrtekst    as rab_matgrtekst,
    VEILPRIS           as VEILPRIS,
    VPENHET            as VPENHET,
    PRISLISTE          as PRISLISTE,
    PRIS               as PRIS,
    PRIS*1.25    as PRIS_inkl_mva,
    ENHET              as ENHET,
    RABATT             as RABATT,
    kunrab      as rab_kunrab,
    EKSTRA             as EKSTRA,
    NETTONETTO         as NETTONETTO,
    NNENHET            as NNENHET,
    EAN                as EAN,
    PRODUKTHIERARKI    as PRODUKTHIERARKI,
    MILJO              as MILJO,
    MILJOGEB           as MILJOGEB,
    PANT               as PANT,
    BLYTILLEGG         as BLYTILLEGG,
    KODE               as KODE,
    AVGIFT             as AVGIFT,
    NETTOPRIS          as NETTOPRIS,
    NPENHET            as NPENHET,
    FRADATO            as FRADATO,
    TILDATO            as TILDATO,
    KAMPPRIS           as KAMPPRIS,
    KPENHET            as KPENHET,
    KUNDENR            as KUNDENR,
    kunde      as rab_kunde
    from   hellanor_pris,
      hellanor_rabatt
    where    hellanor_pris.rk= hellanor_rabatt.matgrkode (+)
    /
----------------------------------------------------------- v_hellanor_obas ------------------------------------------------------------------------------------------
    CREATE OR REPLACE FORCE VIEW  "V_HELLANOR_OBAS" ("VENDOR", "VENDOR_DATA_SEQ_NO", "VENDOR_SEQ_NO", "VENDOR_DATA_NO", "VARE_GRUPPE_SEQ_NO", "VARE_GUPPE_ID", "PRIS_INKL_MVA", "PRIS_UMVA", "PANT", "QUOTA", "NOTES") AS 
      select
    /*
    se v_vendor_data for statistikk
    Dato          Endring
    ===        =======
    2010_05_05 laget
    */
    vendor.vendor      as vendor,
    vendor_data.VENDOR_DATA_SEQ_NO   as VENDOR_DATA_SEQ_NO,
    vendor_data.VENDOR_SEQ_NO        as VENDOR_SEQ_NO,
    vendor_data.VENDOR_DATA_NO       as VENDOR_DATA_NO,
    vendor_data.VARE_GRUPPE_SEQ_NO   as VARE_GRUPPE_SEQ_NO,
    vare_gruppe.vare_gruppe_id  as vare_guppe_id,
    vendor_data.PRIS_inkl_MVA       as PRIS_inkl_mva,
    vendor_data.PRIS_UMVA            as PRIS_UMVA,
    vendor_data.PANT                 as PANT,
    vendor_data.QUOTA                as QUOTA,
    vendor_data.NOTES                as NOTES
    from   vendor_data,
      vendor,
      vare_gruppe
    where  vendor_data.vendor_seq_no  = vendor.vendor_seq_no
    and    vendor_data.vare_gruppe_seq_no  = vare_gruppe.vare_gruppe_seq_no
    --1=Hellanor
    --2=Hafnor
    and    vendor_data.vendor_seq_no in (1,2)
    /
    
----------------------------------------------------------- v_enhet2_hellanor ------------------------------------------------------------------------------------------
    create or replace view v_enhet2_hellanor as
    select distinct 
      null                                              as enhet_seq_no,
      null                                              as prev_enhet_seq_no,
      null                                              as var_bil_seq_no,
      null                                              as var_motor_type_seq_no,
      null                                              as type_klasse,
      null                                              as fab_navn,
      v_enhet2.merke_vasket                             as merke_vasket,
      v_enhet2.type_id                                  as type_id,
      v_enhet2.modell_vasket                            as modell_vasket,
      v_enhet2.aar                                      as aar,
      v_enhet2.scope                                    as scope,
      v_enhet2.scope_vasket                             as scope_vasket,
      v_enhet2.motor_type_besk                          as motor_type_besk,
      v_enhet2.motor_type_id                            as motor_type_id,
      null                                              as var_motor_volum_seq_no,
      v_enhet2.motor_vol_id                             as motor_vol_id,
      null                                              as var_betegn_seq_no,
      null                                              as var_kjore_grp_seq_no,
      null                                              as k_grp_id,
      null                                              as var_dorer_seq_no,
      null                                              as dorer_id,
      null                                              as km,
      null                                              as reg_no,
      null                                              as chassis_no,
      null                                              as farge_kode,
      hellanor.ean                                      as betegnelse,
      null                                              as gear_type,
      null                                              as miljo_klarert_id,
      null                                              as servo,
      null                                              as tecdoc_id,                    --problem med duplikater her tas vekk
      decode(trim(v_enhet2.tecdoc_besk),'0',null,v_enhet2.tecdoc_besk) as tecdoc_besk,   --0 brukes for å oppfylle trigger krav når vi ikke har info
      v_enhet2.vare_gruppe_seq_no                       as vare_gruppe_seq_no,
      null                                              as prev_vare_gruppe_seq_no,
      null                                              as vare_gruppe_id,
      v_enhet2.del_vasket                               as del_vasket,
      null                                              as serie_seq_no,
      null                                              as prev_serie_seq_no,
      null                                              as serie_no,
      null                                              as prev_serie_no,
      null                                              as location_seq_no,
      'ja'                                              as html_ok,
      null                                              as prev_location_seq_no,
      'Hellanor'                                        as loc_id,                          --må ha space ellers virker ikke like 
      null                                              as enhet_kval_seq_no,
      null                                              as prev_enhet_kval_seq_no,
      'NY'                                              as kval_id,
      hellanor.beskrivelse                              as enhet_besk,
      null                                              as prev_enhet_besk,
      null                                              as dato_inn,
      null                                              as prev_dato_inn,
      null                                              as dato_ut,
      null                                              as prev_dato_ut,
      null                                              as temp,
      null                                              as temp_dato,
      null                                              as db_katalog,
      null                                              as paa_bil,
      null                                              as merke_nr,
      hellanor.materialnr                               as prod_nr,
      null                                              as old_serie_seq_no,
      null                                              as vendor_data_seq_no,
      v_enhet2.vendor_data_no                           as vendor_data_no,
      null                                              as endring,
      null                                              as hold_on,
      null                                              as pris_4021,
      null                                              as date_4021,
      round(hellanor.pris_inkl_mva,0)                   as pris_inkl_mva,
      null                                              as pris_solgt_inkl_mva,
      null                                              as org_pris_inkl_mva,
      null                                              as org_dato_inn,
      null                                              as takst_seq_no,
      null                                              as salg_via,
      null                                              as salg_funnet,
      null                                              as www,
      null                                              as bilder_ant,
      null                                              as prev_bilder_ant,
      null                                              as bilder,
      null                                              as del_1,
      null                                              as del_2,
      null                                              as del_3,
      null                                              as del_4,
      null                                              as bil_1,
      null                                              as bil_2,
      null                                              as bil_3,
      null                                              as bil_4
    from 
      v_enhet2,
      vendor_data, 
      (
      select 
        replace(substr(materialnr,4,30),' ','')                 as vendor_data_no, 
        materialnr                                              as materialnr,
        ean                                                     as ean,
        beskrivelse                                             as beskrivelse,
        decode(substr(materialnr,1,3),'STA',1300,'DYN',1301)    as vare_gruppe_seq_no,
        to_number(replace(pris,',','.'))*1.25                                    as pris_inkl_mva 
        from t_hellanor_pris where substr(materialnr,1,3) in ('DYN','STA')
      ) hellanor
    where v_enhet2.vendor_data_seq_no   = vendor_data.vendor_data_seq_no
    and   vendor_data.vendor_data_no = hellanor.vendor_data_no
    order by merke_vasket,modell_vasket,del_vasket
    ;
    
        delete  t_enhet2;
        insert into t_enhet2 (enhet_seq_no,prev_enhet_seq_no,var_bil_seq_no,var_motor_type_seq_no,type_klasse,fab_navn,merke_vasket,type_id,modell_vasket,aar,scope,scope_vasket,motor_type_besk,motor_type_id,var_motor_volum_seq_no,motor_vol_id,var_betegn_seq_no,var_kjore_grp_seq_no,k_grp_id,var_dorer_seq_no,dorer_id,km,reg_no,chassis_no,farge_kode,betegnelse,gear_type,miljo_klarert_id,servo,tecdoc_id,tecdoc_besk,vare_gruppe_seq_no,prev_vare_gruppe_seq_no,vare_gruppe_id,del_vasket,serie_seq_no,prev_serie_seq_no,serie_no,prev_serie_no,location_seq_no,html_ok,prev_location_seq_no,loc_id,enhet_kval_seq_no,prev_enhet_kval_seq_no,kval_id,enhet_besk,prev_enhet_besk,dato_inn,prev_dato_inn,dato_ut,prev_dato_ut,temp,temp_dato,db_katalog,paa_bil,merke_nr,prod_nr,old_serie_seq_no,vendor_data_seq_no,vendor_data_no,endring,hold_on,pris_4021,date_4021,pris_inkl_mva,pris_solgt_inkl_mva,org_pris_inkl_mva,org_dato_inn,takst_seq_no,salg_via,salg_funnet,www,bilder_ant,prev_bilder_ant,bilder,del_1,del_2,del_3,del_4,bil_1,bil_2,bil_3,bil_4)
        select                rownum,      prev_enhet_seq_no,var_bil_seq_no,var_motor_type_seq_no,type_klasse,fab_navn,merke_vasket,type_id,modell_vasket,aar,scope,scope_vasket,motor_type_besk,motor_type_id,var_motor_volum_seq_no,motor_vol_id,var_betegn_seq_no,var_kjore_grp_seq_no,k_grp_id,var_dorer_seq_no,dorer_id,km,reg_no,chassis_no,farge_kode,betegnelse,gear_type,miljo_klarert_id,servo,tecdoc_id,tecdoc_besk,vare_gruppe_seq_no,prev_vare_gruppe_seq_no,vare_gruppe_id,del_vasket,serie_seq_no,prev_serie_seq_no,serie_no,prev_serie_no,location_seq_no,html_ok,prev_location_seq_no,loc_id,enhet_kval_seq_no,prev_enhet_kval_seq_no,kval_id,enhet_besk,prev_enhet_besk,dato_inn,prev_dato_inn,dato_ut,prev_dato_ut,temp,temp_dato,db_katalog,paa_bil,merke_nr,prod_nr,old_serie_seq_no,vendor_data_seq_no,vendor_data_no,endring,hold_on,pris_4021,date_4021,pris_inkl_mva,pris_solgt_inkl_mva,org_pris_inkl_mva,org_dato_inn,takst_seq_no,salg_via,salg_funnet,www,bilder_ant,prev_bilder_ant,bilder,del_1,del_2,del_3,del_4,bil_1,bil_2,bil_3,bil_4
        from v_enhet2_hellanor ;
    --#1380
    --#2162
----------------------------------------------------------- v_hellanor ------------------------------------------------------------------------------------------
    CREATE OR REPLACE FORCE VIEW  "V_HELLANOR" ("KUN_HELLANOR", "FELLES", "KUN_OBAS", "VENDOR", "VENDOR_DATA_SEQ_NO", "VENDOR_SEQ_NO", "VENDOR_DATA_NO", "VARE_GRUPPE_SEQ_NO", "PRIS_UMVA", "PRIS_INKL_MVA", "PANT", "QUOTA", "NOTES", "HELLANOR_RK", "HELLANOR_RAB_MATGRTEKST", "HELLANOR_MATERIALNR", "HELLANOR_BESKRIVELSE", "HELLANOR_PRIS_INKL_MVA", "HELLANOR_PRIS_EX_MVA", "HELLANOR_NETTONETTO_EX_MVA", "HELLANOR_PANT") AS 
      select distinct
    /*
    se v_vendor_data for statistikk
    Dato          Endring
    ===        =======
    2010_05_05 laget
    */
    decode(kun_hellanor.vendor_data_no,null,null,'kun HellaNor '||antall.kun_hellanor||' stk')  as kun_HellaNor,
    decode(felles.vendor_data_no      ,null,null,'felles '      ||antall.felles      ||' stk')          as felles,
    decode(kun_obas.vendor_data_no    ,null,null,'kun OBAS '    ||antall.kun_obas    ||' stk')    as kun_OBAS,
    v_hellanor_obas.vendor                      as VENDOR,
    v_hellanor_obas.VENDOR_DATA_SEQ_NO             as VENDOR_DATA_SEQ_NO,
    v_hellanor_obas.VENDOR_SEQ_NO                  as VENDOR_SEQ_NO,
    driver.VENDOR_DATA_NO                          as VENDOR_DATA_NO,
    -------------------------------------------------------------------------
    -- OBAS 1301 dynamo  Hellanor RK =     161,    163,    165    ,167
    --      1300 startmotor        =desc 160,    162,    164,   ,166
    -- dcod m† v‘re streng ref rk er streng eller skjerer alt seg
    --NB noen 162 der DYN ....  hvilket betyr at DYN/STA bedre enn RK 2012_12_07
    -------------------------------------------------------------------------
    decode(v_hellanor_hellanor.rk,
                                                   '161','1301','163','1301','165','1301','167','1301',
                                                   '160','1300','162','1300','164','1300','166','1300',null)         as VARE_GRUPPE_SEQ_NO,
    v_hellanor_obas.PRIS_UMVA                      as PRIS_UMVA,
    v_hellanor_obas.PRIS_inkl_MVA                  as PRIS_inkl_MVA,
    v_hellanor_obas.PANT                           as PANT,
    v_hellanor_obas.QUOTA                          as QUOTA,
    v_hellanor_obas.NOTES                          as NOTES,
    v_hellanor_hellanor.rk           as HELLANOR_RK,
    v_hellanor_hellanor.rab_matgrtekst         as HELLANOR_rab_matgrtekst,
    v_hellanor_hellanor.MATERIALNR         as HELLANOR_MATERIALNR,
    v_hellanor_hellanor.BESKRIVELSE        as HELLANOR_BESKRIVELSE,
    v_hellanor_hellanor.pris_inkl_mva         as HELLANOR_pris_inkl_mva,
    v_hellanor_hellanor.pris           as HELLANOR_pris_ex_mva,
    v_hellanor_hellanor.NETTONETTO         as HELLANOR_NETTONETTO_ex_mva,
    v_hellanor_hellanor.PANT               as HELLANOR_PANT
    from
      (select vendor_data_no
      from v_hellanor_hellanor
      union
      select vendor_data_no
      from v_hellanor_obas     ) driver,
      (select vendor_data_no
      from v_hellanor_hellanor
      intersect
      select vendor_data_no
      from v_hellanor_obas     ) felles,
      (select vendor_data_no
      from v_hellanor_hellanor
      minus
      select vendor_data_no
      from v_hellanor_obas     ) kun_hellanor,
      (select vendor_data_no
      from v_hellanor_obas
      minus
      select vendor_data_no
      from v_hellanor_hellanor  ) kun_obas,
      v_hellanor_hellanor,
      v_hellanor_obas,
    --antall
      (select
      (select count(*)
      from
      (select vendor_data_no
      from v_hellanor_hellanor
      intersect
      select vendor_data_no
      from v_hellanor_obas)   ) as felles,
      (select count(*)
      from
      (select vendor_data_no
      from v_hellanor_hellanor
      minus
      select vendor_data_no
      from v_hellanor_obas)   ) as kun_hellanor,
      (select count(*)
      from
      (select vendor_data_no
      from v_hellanor_obas
      minus
      select vendor_data_no
      from v_hellanor_hellanor)) as kun_obas
      from dual)      antall
    where   driver.vendor_data_no   = felles.vendor_data_no     (+)
    and  driver.vendor_data_no   = kun_hellanor.vendor_data_no     (+)
    and  driver.vendor_data_no   = kun_obas.vendor_data_no     (+)
    and  driver.vendor_data_no   = v_hellanor_hellanor.vendor_data_no   (+)
    and   driver.vendor_data_no   = v_hellanor_obas.vendor_data_no       (+)
    /
    
----------------------------------------------------------- blobs ------------------------------------------------------------------------------------------
    create or replace view blobs as 
    select
    /*
      2014_03_12  Laget til APEX 750 etc for visning fra blobs.blobs direkte i schema ola
    */
     * 
    from blobs.blobs
    /
    
    --drop table ola.blobs;
    create table  blobs as select * from blobs where blobs_seq_no in (11715,11714,11713);
    insert into blobs select * from blobs.blobs where blobs_seq_no in (11715,11714,11713);
    
    
    
    
    
----------------------------------------------------------- v_blobs_ecu ------------------------------------------------------------------------------------------
    create or replace view v_blobs_ecu as
    select
    /*
    Spesial til APEX p640
    Implementerer Multi Row Update på OLA schema,  ref blobs.blobs_ecu er ikke aksesserbar med MRU stabilt fra denne siden
    1) selv om vi får det til m ed å lage identisk tabell i OLA og så generere kode og så slette tabell
    2) vi har globalt synonym kallt blobs_ecu .....
    MÅ ha insted trigger
    ==========       
    2011_06_13 laget
    */                 
      blobs_ecu_seq_no,
      enhet_seq_no,
      vare_gruppe_seq_no,
      converted_y_n,
      apex_app_files_filename
    from blobs.blobs_ecu
    /
      
    --DROP TABLE blobs_ecu;
    --drop view v_blobs_ecu;
    create table  v_blobs_ecu
       (  blobs_ecu_seq_no   number(8) ,
         enhet_seq_no     number(8) not null,
         vare_gruppe_seq_no   number(8),
         converted_y_n           varchar2(1),
      APEX_APP_FILES_FILENAME              VARCHAR2(400),
      constraint blobs_ecu_pk1 primary key (blobs_ecu_seq_no),
      constraint blobs_ecu_ck1 check       (converted_y_n in ('Y','N'))
       )
    /
    
    insert into v_blobs_ecu values (15,103658,2830,'N','kill_TAG.gif');
    
    
    
----------------------------------------------------------- v_request ------------------------------------------------------------------------------------------
    create or replace view v_request as
    select
    /*
    ==========       
    2013_12_01 laget
    2013_12_03 byttet navn fra dp_query til request ref takst og forespørsel på internett skal INN
    */     
      request.request_seq_no              as request_seq_no,   
      request.request_type                as request_type,        
      request.bruker_seq_no               as bruker_seq_no,              
      request.date_in                     as date_in,
      request.date_upd                    as date_upd,
      request.date_hist                   as date_hist,
      bruker.firma                        as firma,
      bruker.bruker                       as bruker, 
      request.kjennemerke                 as kjennemerke,
      v_vognkort.merke_navn||' '||
      v_vognkort.modellbetegnelse||' '||
      v_vognkort.reg_aar_mod_aar||' '||
      v_vognkort.typebetegnelse           as vegdir_modell_type,  
      request.var_bil_seq_no              as var_bil_seq_no,
      v_var_bil.sbrnr                     as bilkod,
      v_var_bil.nbf                       as nbf,
      request.beh_tid                     as beh_tid,
      request.status                      as status,
      dbms_lob.substr(request.request_kommentar,4000,1)  as request_kommentar,
      -----------------------TAKST info--------------------------------
      request.takst_usr_seq_no            as takst_usr_seq_no,
      --takst_usr.usr                       as takst_usr,
      --decode(upper(takst.usr),'RODKLEIV','Olas Bil','FORD','Haugesund Auto','TOYOTA','Toyota Haugesund','OPEL',chr(197)||'kra Bil',null) as verksted,
      --takst_usr.usr_desc                  as takst_bruker,
      --takst_selskap.usr_desc              as takst_selskap,
      request.takst_selskap_seq_no        as takst_selskap_seq_no,
      --takst_kunde.usr_desc                as takst_verksted,
      request.takst_kunde_seq_no          as takst_kunde_seq_no,
      request.takst_oppdrag_id            as takst_oppdrag_id,
      request.takst_skadenr               as takst_skadenr   
      --blobs_takst.ant      as ant,
      --case when blobs_takst.ant is not null   then '<span style="background-color:yellow;font-weight:bold;">'||blobs_takst.ant||'</span>'
            --when sal between 1000 and 2000   then 'purple'
            --when sal > 2000       then 'green'
      --end             as status_color,
      --enhet.ant_deler      as ant_deler,
      --case when enhet.ant_deler is not null   then '<span style="background-color:black;font-weight:bold;"><font color="#FFFFFF">'||enhet.ant_deler||'</font></span>'
            --when sal between 1000 and 2000   then 'purple'
            --when sal > 2000       then 'green'
      --end             as status_color_deler
    from     
      ola.request     request,
      ola.bruker      bruker,
      --ola.takst_usr    takst_selskap,
      --(select   takst_seq_no  as takst_seq_no,
      --     count(*)  as ant
      --from blobs.blobs_takst
      --group by takst_seq_no) blobs_takst,
      --(select   takst_seq_no  as takst_seq_no,
      --     count(*)  as ant_deler
      --from ola.enhet
      --where takst_seq_no is not null
      --group by takst_seq_no) enhet,
      ola.v_var_bil         v_var_bil,  
        --   vegdir.v_vognkort      v_vognkort
        v_vognkort      v_vognkort
    where request.bruker_seq_no   = bruker.bruker_seq_no 
    --and  takst.takst_seq_no      = blobs_takst.takst_seq_no  (+)
    --and  takst.takst_seq_no      = enhet.takst_seq_no        (+)
    and   request.kjennemerke     = v_vognkort.kjennemerke    (+)
    and   request.var_bil_seq_no  = v_var_bil.var_bil_seq_no  (+)
    order by bruker.firma,bruker.bruker, request.request_seq_no
    /       
    grant all on v_request to public;
    
----------------------------------------------------------- v_takst ------------------------------------------------------------------------------------------
    create or replace view v_takst as
    select
    /*
    ==========       
    2011_01_30 laget
    2011_02_02 lagt inn aar fra v_bil som utgår, opprinnlige aar kolonne heter nå aar_d
    2011_02_19 legger inn NBF info slik for bruk i APEX takst_detail (fetch på view update på tabell)
    2011_04_21 lagt inn beh_tid og status
    2011_09_04 lagt inn selskap
    */                 
      takst.takst_seq_no         as takst_seq_no,
         takst.date_in               as date_in,
      takst.date_upd          as date_upd,
      takst.takst_usr_seq_no        as takst_usr_seq_no,
      takst_usr.usr          as usr,
      --decode(upper(takst.usr),'RODKLEIV','Olas Bil','FORD','Haugesund Auto','TOYOTA','Toyota Haugesund','OPEL',chr(197)||'kra Bil',null) as verksted,
      takst_usr.usr_desc        as bruker,
      takst_selskap.usr_desc        as selskap,
      takst.takst_selskap_seq_no      as takst_selskap_seq_no,
      takst_kunde.usr_desc        as verksted,
      takst.takst_kunde_seq_no      as takst_kunde_seq_no,
      takst.oppdrag_id        as oppdrag_id,
      takst.skadenr          as skadenr,
      takst.kjennemerke        as kjennemerke,
      v_vognkort.merke_navn||' '||
      v_vognkort.modellbetegnelse||' '||
      v_vognkort.reg_aar_mod_aar||' '||
      v_vognkort.typebetegnelse      as vegdir_modell_type,  
      takst.var_bil_seq_no        as var_bil_seq_no,
      v_var_bil.sbrnr          as bilkod,
      v_var_bil.nbf          as nbf,
      takst.beh_tid          as beh_tid,
      takst.status          as status,
      dbms_lob.substr(takst.takst_kommentar,4000,1)  as takst_kommentar,
      blobs_takst.ant      as ant,
      case when blobs_takst.ant is not null   then '<span style="background-color:yellow;font-weight:bold;">'||blobs_takst.ant||'</span>'
            --when sal between 1000 and 2000   then 'purple'
            --when sal > 2000       then 'green'
      end             as status_color,
      enhet.ant_deler      as ant_deler,
      case when enhet.ant_deler is not null   then '<span style="background-color:black;font-weight:bold;"><font color="#FFFFFF">'||enhet.ant_deler||'</font></span>'
            --when sal between 1000 and 2000   then 'purple'
            --when sal > 2000       then 'green'
      end             as status_color_deler
    from    ola.takst    takst,
      ola.takst_usr    takst_usr,
      ola.takst_usr    takst_selskap,
      ola.takst_usr    takst_kunde,
      (select   takst_seq_no  as takst_seq_no,
           count(*)  as ant
      from blobs.blobs_takst
      group by takst_seq_no) blobs_takst,
      (select   takst_seq_no  as takst_seq_no,
           count(*)  as ant_deler
      from ola.enhet
      where takst_seq_no is not null
      group by takst_seq_no) enhet,
      ola.v_var_bil         v_var_bil,  
        --   vegdir.v_vognkort      v_vognkort
       v_vognkort      v_vognkort
    where   takst.takst_usr_seq_no    = takst_usr.takst_usr_seq_no 
    and   takst.takst_selskap_seq_no  = takst_selskap.takst_usr_seq_no (+)
    and   takst.takst_kunde_seq_no  = takst_kunde.takst_usr_seq_no    (+)
    and  takst.takst_seq_no    = blobs_takst.takst_seq_no    (+)
    and  takst.takst_seq_no    = enhet.takst_seq_no      (+)
    and  takst.kjennemerke    = v_vognkort.kjennemerke      (+)
    and     takst.var_bil_seq_no    = v_var_bil.var_bil_seq_no    (+)
    order by takst_usr.usr_desc, takst.oppdrag_id
    /       
    grant all on v_takst to public;
    
    select count(*) from v_takst;
     --#45  --#130 2012_03_28  --90 2012_05_17
     --#360 2020-01-10
    
    
    create or replace view v_takst_selskap_verksted as
    select
    /*
    ==========       
    2012_03_28 laget
    */          
      selskap,
      to_char(date_in,'yyyy-mm')  as aar_mnd,
      verksted,
      count(*) as ant_takster
    from v_takst
    group by selskap,to_char(date_in,'yyyy-mm'),verksted
    order by selskap,to_char(date_in,'yyyy-mm'),verksted;
    
    create or replace view v_takst_selskap as
    select
    /*
    ==========       
    2012_03_28 laget
    */          
      selskap,
      to_char(date_in,'yyyy-mm')  as aar_mnd,
      count(*) as ant_takster
    from v_takst
    group by selskap,to_char(date_in,'yyyy-mm')
    order by selskap,to_char(date_in,'yyyy-mm');
    
    
----------------------------------------------------------- v_plukk_ecu_master ------------------------------------------------------------------------------------------
    create or replace view v_plukk_ecu_master as
        select distinct
        /*      APEX master page 620 og 205(hvis plukk velges)
                Forutsetter:   
        Dato    Endring
        ===       =======        
        2010_08_09 laget
        2010_09_18 lagt in antal plukk
        2011_11_25 byttet navn fra v_plukke_liste_master til v_plukk_ecu_master
        2011_11_27 lagt inn vare_gruppe_seq_no
        2011_12_15  modifisert slik at sikrer oss gult også dersom vi kun har registrert info om vraket i enhet_ecu
        2013_09_07 lagt inn or-statement slik at plukket deler på vrak som mangler lagerplass komme opp
        */                 
        v_enhet_vis.enhet_seq_no           as enhet_seq_no,
        v_enhet_vis.prev_enhet_seq_no      as prev_enhet_seq_no,
        v_enhet_vis.vare_gruppe_id         as vare_gruppe_id,
        v_enhet_vis.vare_gruppe_seq_no     as vare_gruppe_seq_no,
        v_enhet_vis.loc_id                 as loc_id,
        v_enhet_vis.serie_no               as serie_no,
        v_enhet_vis.enhet_besk             as enhet_besk,
        v_enhet_vis.temp                   as temp,
        v_enhet_vis.var_bil_seq_no         as var_bil_seq_no,
        paa_bil_faktisk.status             as status,
        case when paa_bil_faktisk.status is not null then '<span style="background-color:yellow;font-weight:bold;">'||rpad(substr(paa_bil_faktisk.status,1,4),4)||'</span>'
           --when sal between 1000 and 2000 then 'purple'
           --when sal > 2000 then 'green'
        end                                as status_color,
        --sikrer oss gult også dersom vi kun har registrert info om vraket i enhet_ecu
        ------------------------------------------------------------------------------
        case when nvl(ecu_faktisk.ecu_ant,enhet_ecu.enhet_ecu_seq_no) is not null then '<span style="background-color:yellow;font-weight:bold;">'||nvl(rpad(substr(ecu_faktisk.ecu_ant,1,4),4),'X')||'</span>'
           --when sal between 1000 and 2000 then 'purple'
           --when sal > 2000 then 'green'
        end                                as ant,
        enhet_ecu.enhet_ecu_seq_no         as enhet_ecu_seq_no,
        v_enhet_vis.fab_navn               as fab_navn,
        v_enhet_vis.type_id                as type_id,
        to_char(v_enhet_vis.aar,'yyyy')    as aar,
        v_enhet_vis.betegnelse             as betegnelse,
        v_map_bil.nbf_sbrnr                as nbf_sbrnr,
        v_map_bil.nbf_namn                 as nbf_namn,
        v_vognkort.modellbetegnelse||' '||
        v_vognkort.typebetegnelse          as vegdir_modell_type,
        v_enhet_vis.motor_type_id          as motor_type_id,
        v_enhet_vis.motor_vol_id           as motor_vol_id,
        v_enhet_vis.gear_type              as gear_type,
        v_enhet_vis.dorer_id               as dorer_id,
        v_enhet_vis.k_grp_id               as k_grp_id,
        v_enhet_vis.km                     as km,
        v_enhet_vis.reg_no                 as reg_no,
        v_enhet_vis.chassis_no             as chassis_no,
        v_enhet_vis.farge_kode             as farge_kode,
        v_enhet_vis.paa_bil                as paa_bil,
        v_enhet_vis.servo                  as servo,
        v_enhet_vis.dato_inn               as dato_inn,
        v_enhet_vis.dato_ut                as dato_ut
        from ola.v_enhet_vis    v_enhet_vis,
           (select
              prev_enhet_seq_no  as prev_enhet_seq_no,
              count(*)           as status
            from enhet
            where paa_bil='J'
            group by  prev_enhet_seq_no                
           ) paa_bil_faktisk,
           (select distinct
              bil.enhet_seq_no     as enhet_seq_no,
              nvl(del.paa_bil,'N') as paa_bil
            from enhet bil,
                 enhet del
            where bil.enhet_seq_no = del.prev_enhet_seq_no (+)
           ) driver_bil,  
           (select 
              blobs_ecu.enhet_seq_no, 
              count(*)     as ecu_ant
            from enhet_ecu,
                 blobs.blobs_ecu
            where enhet_ecu.enhet_seq_no = blobs_ecu.enhet_seq_no
            group by blobs_ecu.enhet_seq_no
           ) ecu_faktisk,enhet_ecu,ola.v_map_bil    v_map_bil,  
           --vegdir.v_vognkort  v_vognkort
           v_vognkort  v_vognkort
        where 1=1
          and  v_enhet_vis.enhet_seq_no     = driver_bil.enhet_seq_no
          and  v_enhet_vis.var_bil_seq_no   = v_map_bil.obv_var_bil_seq_no       (+)
          and  v_enhet_vis.reg_no    = v_vognkort.kjennemerke                    (+)
          and  v_enhet_vis.vare_gruppe_id  ='VRAK'
          --alle vrak med deler må også vises
          and (  v_enhet_vis.loc_id    is not null or driver_bil.paa_bil ='J')
          and  v_enhet_vis.enhet_seq_no  = paa_bil_faktisk.prev_enhet_seq_no   (+)
          and  v_enhet_vis.enhet_seq_no  = ecu_faktisk.enhet_seq_no            (+)
          and  v_enhet_vis.enhet_seq_no  = enhet_ecu.enhet_seq_no              (+)
    /
    grant select on v_plukk_ecu_master to public
    /
    select count(*) from v_plukk_ecu_master;
    --2013_09_07_07   425 før alle plukke deler er med
    --                431 alle plukke vrak med
    --                429 med distinct (ref V19785 , enhets_seq_no=203520 hadde 2 rekker mest sans. pga 2 deler på 1 varegruppe (caliper-hb
     update "OLA"."V_PLUKKE_LISTE_DETAIL" set 
     "SEQ_NO" = :b1, 
     "ENHET_SEQ_NO" = :b2, 
     "PRIS" = :b3, "
     BESK" = :b4, 
     "MERK" = :b5 
     where "SEQ_NO" = :p_pk_col and "ENHET_SEQ_NO" = :p_pk_col2
    
----------------------------------------------------------- v_plukke_liste_detail_view ------------------------------------------------------------------------------------------
    create or replace view v_plukke_liste_detail_view as
    select   
    /* 
    Dato    Endring
    ===       =======        
    2010_08_09 laget
    2010_08_29 lagt til pris, og temp kolonnen etter at APEX ble ordnet til å vise 256 rows
    2010_09_09 tatt vekk Vrak og Hold i varegruppen
    2010_09_18 oppslag mot faktisk data på enhet_seq_no
    2011_02_14 legger inn nbf info
    2011_02_18 lager view og upd av samme view for bruk i APEX
    2012_02_28 eksluderer dummy, ref ramlet inn igjen etter ombygging av v_vare_gruppe
    2012_03_01 bytter ut ekster.v_obas_nbf_priser med v_nbf_priser_obas
    2013_xxx   byttet ut med v_plukke i plukkelisten
    2014_xxx   v_plukk  byttet ut med v_plukke2 i plukkelisten
    */                 
      driver.seq_no                                                                 as seq_no,
      driver.enhet_seq_no                                                           as enhet_seq_no,
      driver.var_bil_seq_no                                                         as var_bil_seq_no,
      driver.vare_gruppe_seq_no                                                     as vare_gruppe_seq_no,
      driver.vare_gruppe                                                            as vare_gruppe_id,
      paa_bil_faktisk.status                                                        as status,
      case when paa_bil_faktisk.status is not null then 'yellow'
         --when sal between 1000 and 2000 then 'purple'
         --when sal > 2000 then 'green'
      end                                                                           as status_color,
      cast (decode('0','0',null) as number(8))                                      as pris,
      cast (decode('0','0',null) as varchar2(1024))                                 as besk,
      cast (decode('0','0',null) as varchar2(2048))                                 as merk,
      decode(vare_gruppe_faktisk.paa_lager,0,null  ,vare_gruppe_faktisk.paa_lager ) as inne,
      decode(vare_gruppe_faktisk.solgt    ,0,null  ,vare_gruppe_faktisk.solgt     ) as solgt,
      decode(vare_gruppe_faktisk.totalt   ,0,null  ,vare_gruppe_faktisk.totalt    ) as tot,
      decode(vare_gruppe_faktisk.max      ,0,null  ,vare_gruppe_faktisk.max       ) as max,
      decode(vare_gruppe_faktisk.min      ,0,null  ,vare_gruppe_faktisk.min       ) as min,
      decode(vare_gruppe_faktisk.max_solgt,0,null  ,vare_gruppe_faktisk.max_solgt ) as max_ut,
      decode(vare_gruppe_faktisk.min_solgt,0,null  ,vare_gruppe_faktisk.min_solgt ) as min_ut,
      v_nbf_priser_obas.nbf_ant                                                     as nbf_ant,
      v_nbf_priser_obas.nbf_max                                                     as nbf_max,
      v_nbf_priser_obas.nbf_min                                                     as nbf_min    
    from
        (select 
           --Trix for å gi pk til APEX
           --NB kan ikke bruke rownum -->table scann ann mass
           --18 736 872  v_vare_gruppe=264, enhet 70973   264 x 70973 = 18 736 872
           -- vare_gruppe_seq_no 0 Holde og 1 Vrak utelates --> 262 kombinasjoener av deler...
           enhet.enhet_seq_no||'_'||v_vare_gruppe.vare_gruppe_seq_no as seq_no,
           enhet.enhet_seq_no                                        as enhet_seq_no,
           enhet.var_bil_seq_no                                      as var_bil_seq_no,
           v_vare_gruppe.vare_gruppe_seq_no                          as vare_gruppe_seq_no,
           v_vare_gruppe.vare_gruppe                                 as vare_gruppe  
         from v_vare_gruppe,
              enhet
         where 1=1
           --ekskluderer Vrak og Hold
           and   v_vare_gruppe.vare_gruppe_seq_no not in (1,0)            
           --ekskluderer dummy (vrak og hold er ikke dummy)
           and   nvl(v_vare_gruppe.dummy,'x') <> 'Y'              
        )driver,
        (select
           enhet_seq_no                                             as enhet_seq_no,
           prev_enhet_seq_no                                        as prev_enhet_seq_no,
           vare_gruppe_seq_no                                       as vare_gruppe_seq_no,
           decode(paa_bil,'J','Plukk '||pris_inkl_mva||'kr',null)   as status
          from enhet                          
        )paa_bil_faktisk,                            
        (select 
           enhet.enhet_seq_no                                       as enhet_seq_no,
             v_vare_gruppe.vare_gruppe_seq_no                       as vare_gruppe_seq_no,
             v_vare_gruppe.vare_gruppe                              as vare_gruppe,
             count(prev_enhet.location_seq_no)                      as paa_lager,
             count(*)-                                       
             count(prev_enhet.location_seq_no)                      as solgt,
             count(*)                as totalt,
             max(nvl(prev_enhet.pris_inkl_mva,0))                   as max,
             min(nvl(prev_enhet.pris_inkl_mva,0))                   as min,
             max(nvl(prev_enhet.pris_solgt_inkl_mva,0))             as max_solgt,
             min(nvl(prev_enhet.pris_solgt_inkl_mva,0))             as min_solgt
           from ola.v_map_bil      v_map_bil,     -- henter 1 bilmerke
                ola.v_map_bil      v_map_bil_2,   -- henter mange NBF bilmerker til 1 bilmerke over
                ola.enhet          enhet,         -- bilen
                ola.enhet          enhet_2,       -- alle bilene som treffer på NBF rangen av bilmerker
                ola.enhet          prev_enhet,    -- alle delene som treffer på NBF rangen av bilmerker
                ola.v_vare_gruppe  v_vare_gruppe  -- navnet på delene
           where  enhet.var_bil_seq_no           = v_map_bil.obv_var_bil_seq_no      --NBF bilmerkene       1:mange
             and  v_map_bil.nbf_sbrnr            = v_map_bil_2.nbf_sbrnr             --mange : mange
             and  v_map_bil_2.obv_var_bil_seq_no = enhet_2.var_bil_seq_no            --OBAS bilmerkene mange : mange
             and  enhet_2.enhet_seq_no           = prev_enhet.prev_enhet_seq_no      --Alle delee
             and  prev_enhet.vare_gruppe_seq_no  = v_vare_gruppe.vare_gruppe_seq_no  --navnene
           group by enhet.enhet_seq_no,v_vare_gruppe.vare_gruppe_seq_no,v_map_bil.obv_var_bil_seq_no,v_map_bil.nbf_sbrnr, v_map_bil.nbf_namn, v_vare_gruppe.vare_gruppe
          )  vare_gruppe_faktisk,
         ekstern.v_nbf_priser_obas  v_nbf_priser_obas
    where 1=1 
      and  driver.enhet_seq_no       = vare_gruppe_faktisk.enhet_seq_no       (+)
      and  driver.vare_gruppe_seq_no = vare_gruppe_faktisk.vare_gruppe_seq_no (+)
      and  driver.enhet_seq_no       = paa_bil_faktisk.prev_enhet_seq_no      (+)
      and  driver.vare_gruppe_seq_no = paa_bil_faktisk.vare_gruppe_seq_no     (+)
      and  driver.var_bil_seq_no     = v_nbf_priser_obas.var_bil_seq_no       (+)
      and  driver.vare_gruppe_seq_no = v_nbf_priser_obas.vare_gruppe_seq_no   (+)
      -- må brukes dersom APEX skal knytte master detail 1.ste gang 
      -- ellers blir det fullt kartesisk produkt
      --and   driver.enhet_Seq_no     = 202241
    order by driver.vare_gruppe
    /
    grant select on v_plukke_liste_detail_view to public;
    
    
    
    
    
----------------------------------------------------------- v_plukke_liste ------------------------------------------------------------------------------------------
    create or replace view v_plukke_liste as
    select
    /*      APEX master page 622
            Forutsetter:   tr_instd_v_plukke_liste og  v_plukke_liste
            1) Viewet lages med select på enhet_seq_no slik at ikke APEX tar full kartesisk produkt nå alt lages
               DVS:   and driver.enhet_seq_no=202241
            2) a) tabular form lages i APEK. primary-key1=SEQ_NO
                                             primary-key2=enhet_seq_no
                                            where where enhet_seq_no = :P622_ENHET_SEQ_NO order by vare_gruppe_id
               b) -1  velg alle kolonnene
                  -2  velg Update og delete
                  -3  velg Managed by Primary key : SEQ_NO  (samme hva vi velger egentlig)
                  -4  velg Existings triggers
                  -5  velg updatable columns (:new.enhet_seq_no, :new.vare_gruppe_seq_no, :new.merk, :new.besk , :new.pris )  fra instad triggers                           
                  -6  velg side, ikke tab etc
                  -7  etter at siden laget
                      7.a ta vekk alle Validations
                      7.b lag item Pxxx_ENHET_SEQ_NO
                      7.c sett inn where enhet_seq_no=:P623_ENHET_SEQ_NO
                      7.d recreate view (--and driver.enhet_seq_no=202241) 
                                og TRIGGER
                      7.e fiks kallet fra page 620
                  -8  Fix rapport
                      8.a Sett text edit felt på (pris merk, besk) De eri ikke editerbare av en eller annen grunn...     
                      8.b skjul phø  
                                              Select row  [row selector]
                            Column Attributes Display As  SEQ_NO           Hidden   Tabular Form Attributes Primary Key Source Type: Existing Trigger
                                                          ENHET_SEQ_NO...  Display as Text (escape special characters, does not save state)
                                                          PRIS             LOV C_TAB_PRISER 
                                                          BESK, MERK       Text Field
                                                          STATUS           <span style="background-color:#STATUS_COLOR#;font-weight:bold;">#STATUS#</span>
                            
                      8.c ta vekk alle sort kolonnene --> bruke default pr varegruppe 3 nivå fra view
                  -9  Print 
                      9.a Prespons Header: Print Server
                        b Output pdf
                        c Report Layout V_PLUKKE_LISTE_DETAIL_RAPP
                        d Pring URL f?p=&APP_ID.:622:&SESSION.:FLOW_XMLP_OUTPUT_R7669701051171674
            3)Viewet resettes where på enhet_seq_no tas bort
            4)Alle APEX valideringer SLETTES ellers så blir det bare gnål på nøkkelreserverte tabeller
            5) ApplyMRU på  V_PLUKKE_LISTE_DETAIL_VIEW hvor pk1,2=SEQ_NO,ENHET_SEQ_NO condition SUBMIT
               ApplyMRD på  V_PLUKKE_LISTE_DETAIL_VIEW hvor pk1,2=SEQ_NO,ENHET_SEQ_NO condition Request=Expression 1 = MULTI_ROW_DELETE         
            -------------------------------------------------------------------------------------------------
            ORA-01445 :   http://www.apex-at-work.com/2012/12/apex-41-tabular-form-ora-01445-cannot.html
            failed to parse SQL query: ORA-01445: kan ikke velge ROWID fra, eller bruke utdrag av, et sammenføyingsutsnitt uten en nøkkelpreservert tabell
            ORA-01779: kan ikke endre kolonne som tilordner til en ikke nøkkelbasert tabell (Row 1)
            ORA-01733: virtuell kolonne er ikke tillatt her
            Triks endre view med  driver.enhet_Seq_no     = 200643
            lagre rapport sql i APEX og kjør,  sett etterpå tilbake 
            Logg inn/ut slik at alt resettes
            -------------------------------------------------------------------------------------------------
            ------------NB APEX bruker update/delete på v_plukke_liste_detail med instead trigger -----------
            -------------------------------------------------------------------------------------------------        
            Forutsetter:   
            likt ant i enhet, v_enhet, v_enhet_vis  ok pr 2010_08_09
           --2010_08_20   #808 471 på hele viwet
           #808 454 på v_gruppe_faktisk
            84311  SAAB 9-5 2000
            84308  SAAB 9000 1992
    Dato    Endring
    ===       =======        
    2010_08_09 laget
    2010_08_29 lagt til pris, og temp kolonnen etter at APEX ble ordnet til å vise 256 rows
    2010_09_09 tatt vekk Vrak og Hold i varegruppen
    2010_09_18 oppslag mot faktisk data på enhet_seq_no
    2011_02_14 legger inn nbf info
    2011_02_18 lager view og upd av samme view for bruk i APEX
    2012_02_28 eksluderer dummy, ref ramlet inn igjen etter ombygging av v_vare_gruppe
    2012_03_01 bytter ut ekster.v_obas_nbf_priser med v_nbf_priser_obas
    2012_09_02 byttet ut p622 mev v_plukke_liste_detail_view --> denne v_plukke_liste
    */                 
      driver.enhet_vare_gruppe_seq_no                                                as seq_no,                                                
      driver.enhet_seq_no                                                            as enhet_seq_no,                                          
      driver.var_bil_seq_no                                                          as var_bil_seq_no,                                        
      driver.vare_gruppe_seq_no                                                      as vare_gruppe_seq_no,                                   
      driver.vare_gruppe                                                             as vare_gruppe_id,                                        
      paa_bil_faktisk.status                                                         as status,                                                
      case when paa_bil_faktisk.status is not null then 'yellow'                                                                               
         --when sal between 1000 and 2000 then 'purple'                                                                                        
         --when sal > 2000 then 'green'                                             
      end                                                                            as status_color,
      --plassholder                                                                  
      cast (decode('0','0',null) as number(8))                                       as pris,
      cast (decode('0','0',null) as varchar2(1024))                                  as besk,
      cast (decode('0','0',null) as varchar2(2048))                                  as merk,
      driver.fab_type_vare_gruppe_seq_no                                             as fab_type_vare_gruppe_seq_no,
      ant_tot.ant_tot                                                                as ant_tot, 
      ant_solgt.ant_solgt                                                            as ant_solgt,
      ant_p_lager.ant_p_lager                                                        as ant_p_lager,
      ant_plukk.ant_plukk                                                            as ant_plukk,
      max_min.max                                                                    as max,
      max_min.min                                                                    as min,
      max_min.max_solgt                                                              as max_solgt,
      max_min.min_solgt                                                              as min_solgt,
      v_nbf_priser_obas.nbf_ant                                                      as nbf_ant,
      v_nbf_priser_obas.nbf_max                                                      as nbf_max,
      v_nbf_priser_obas.nbf_min                                                      as nbf_min    
    from 
         /*==========================================*/
         /*paa_bil_faktisk*/
         /*==========================================*/ 
          --2013_09_01    338
          --Merk at det kan feks være 2 like varegrupper per prev_enhet_seq_no (overordnet vrak)
          --                                 vare_gruppe_seq_no   vrak_nr   prev_enhet_seq_no
          --  eks, Felg alminium, Felg stål  36590/1
          --       Vinduspussermotor foran   1700
          --       Calipter HB, VB           909/10
          --       Airbag sensor             1504
          --       Innredning                29041                V19785    203520 Avensis 2012
        (select
           prev_enhet_seq_no||'_'||vare_gruppe_seq_no               as prev_enhet_vare_gruppe_seq_no,
           enhet_seq_no                                             as enhet_seq_no,
           prev_enhet_seq_no                                        as prev_enhet_seq_no,
           vare_gruppe_seq_no                                       as vare_gruppe_seq_no,
           enhet_besk                                               as enhet_besk,
           temp                                                     as temp,
           decode(paa_bil,'J','Plukk '||pris_inkl_mva||'kr',null)   as status
         from enhet
         where 1=1
           and paa_bil='J'
        )paa_bil_faktisk,
        ekstern.v_nbf_priser_obas      v_nbf_priser_obas,
        /*==========================================*/
        /*Materialized products*/
        /*==========================================*/    
       --kartesisk produkt
         mv_enhet_vare_g_driver     driver,
       --------------------------------------------------------------------------------------------------------------------------------------------
       --AGGREGERTE VERDIER (kan være litt upresise)
       --key: fab_seq_no
       --     type_seq_no
       --     vare_gruppe_seq_no 
       --as fab_type_vare_gruppe_seq_no
       --------------------------------------------------------------------------------------------------------------------------------------------
        mv_fab_type_vare_g_ant_tot     ant_tot,
        mv_fab_type_vare_g_ant_solgt   ant_solgt,
        mv_fab_type_vare_g_ant_p_lager ant_p_lager,
        mv_fab_type_vare_g_ant_plukk   ant_plukk,
        mv_fab_type_vare_g_max_min     max_min
    where 1=1
      and driver.enhet_vare_gruppe_seq_no    = paa_bil_faktisk.prev_enhet_vare_gruppe_seq_no      (+)
      and driver.fab_type_vare_gruppe_seq_no =     ant_tot.fab_type_vare_gruppe_seq_no            (+)
      and driver.fab_type_vare_gruppe_seq_no =   ant_solgt.fab_type_vare_gruppe_seq_no            (+) 
      and driver.fab_type_vare_gruppe_seq_no = ant_p_lager.fab_type_vare_gruppe_seq_no            (+) 
      and driver.fab_type_vare_gruppe_seq_no =   ant_plukk.fab_type_vare_gruppe_seq_no            (+) 
      and driver.fab_type_vare_gruppe_seq_no =     max_min.fab_type_vare_gruppe_seq_no            (+) 
      and driver.var_bil_seq_no     = v_nbf_priser_obas.var_bil_seq_no       (+)
      and driver.vare_gruppe_seq_no = v_nbf_priser_obas.vare_gruppe_seq_no   (+)
      -- må brukes dersom APEX skal knytte master detail 1.ste gang 
      -- ellers blir det fullt kartesisk produkt
      --Avensis 2012 203520 V19785    
      --Polo         202241 V19519
      --bærearm nede 3 fra før på lager.. før vistes ingen fre det er ikke 05 modeller
      --and driver.enhet_seq_no=202241
    order by driver.vare_gruppe
    /
    grant select on v_plukke_liste to public;
    select count(*) from v_plukke_liste;
    
    
----------------------------------------------------------- v_plukke ------------------------------------------------------------------------------------------
    create or replace view v_plukke as
    select
    /*      APEX master page 622
            Forutsetter:   tr_instd_v_plukke_liste og  v_plukke_liste
            1) UTGÅR apex klikker ikke
               Viewet lages med select på enhet_seq_no slik at ikke APEX tar full kartesisk produkt nå alt lages
               DVS:   and driver.enhet_seq_no=202241             
            1) Flytt alt fra Registrering region f.eks til logikk, slett region og lag en ny FORM, TABULAR form   
            2) a) tabular form lages i APEK. primary-key1=SEQ_NO
                                             primary-key2=enhet_seq_no  (ref select/update på v_plukke med bare seq_no tar over 10s)
                                            where where enhet_seq_no = :P622_ENHET_SEQ_NO order by vare_gruppe_id
                    --resultat fra debugger
                    --bare seq_no >10s                                        
                    update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1,                       "PRIS" = :b2, "BESK" = :b3, "MERK" = :b4 where "SEQ_NO" = :p_pk_col                 
                    --både seq_no og enhet_seq_no <1s
                    update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "ENHET_SEQ_NO" = :b2, "PRIS" = :b3, "BESK" = :b4, "MERK" = :b5 where "SEQ_NO" = :p_pk_col and "ENHET_SEQ_NO" = :p_pk_col2                       
               b) -1  velg alle kolonnene
                  -2  velg Update og delete
                  -3  velg Managed by Primary key : SEQ_NO  (samme hva vi velger egentlig)
                  -4  velg Existings triggers
                    --NBNB for å unngå bad request må 
                    det for pk2 velges eksisting pl/sql.  ingenting legges inn og det krysses av for evaluate on runtime only
                  -5  velg updatable columns NEEEEI --> bad request (:new.enhet_seq_no, :new.vare_gruppe_seq_no, :new.merk, :new.besk , :new.pris )  fra instad triggers                           
                                             Edit i Report Attributes : [row selector], seq_no, pris, besk, merk  --> Unngår bad request     
                    ---------------------------------------------------------------------
                    --Konklusjon etter 1 ukes arbeid                                   --
                    -- tabular form må har pk som updateable trigger                   --
                    -- 1)alle feltene i pk må være EDITABLE dvs Display as TEXTFIELD   --
                    -- 2)pk må inngå i MRU, MRD altså seq_no og enhet_seq_no           --
                    --               (ref duplikater på en varegruppe                  --                                                                        
                    ---------------------------------------------------------------------
                  -6  velg side, ikke tab etc
                  -7  etter at siden laget
                      7.a ta vekk alle Validations
                      7.b lag item Pxxx_ENHET_SEQ_NO
                      7.c sett inn where enhet_seq_no=:P622_ENHET_SEQ_NO
                      7.d UTGÅR ref pkt 1) over
                          recreate view (--and driver.enhet_seq_no=202241) 
                                og TRIGGER
                      7.e fiks kallet fra page 620
                  -8  Fix rapport
                      8.a Sett text edit felt på (pris merk, besk) De eri ikke editerbare av en eller annen grunn... (pass på alt som er hot er HØYRE kolonne)    
                      8.b skjul phø  
                                              Select row  [row selector]
                            Column Attributes Display As  SEQ_NO           Hidden   Tabular Form Attributes Primary Key Source Type: Existing Trigger
                                                          ENHET_SEQ_NO...  Display as Text (escape special characters, does not save state)
                                                          PRIS             LOV C_TAB_PRISER with 6, eller alt default
                                                          BESK, MERK       Text Field
                                                          STATUS           Display as text HTML ekpress <span style="background-color:#STATUS_COLOR#;font-weight:bold;">#STATUS#</span>
                            Report template: standard 12 PPR
                            Show null as  : blank                             
                            Template  Region without title
                      8.c ta vekk alle sort kolonnene --> bruke default pr varegruppe 3 nivå fra view
                  -9  Print 
                      9.a  Button submit, name Print
                        b  Branches to URL On Submit Before Computation, page 0, request PRINT_REPORT=V_PLUKKE_LISTE_DETAIL_RAPP 
                        c  Report Print attributes Respons Header: Print Server
                                                   Report Layout : V_PLUKKE_LISTE_DETAIL_RAPP  (husk å endre shared compinets hvis du bytter side)
            3)Viewet resettes where på enhet_seq_no tas bort
            4)Alle APEX valideringer SLETTES ellers så blir det bare gnål på nøkkelreserverte tabeller
            5) ApplyMRU på  V_PLUKKE_LISTE_DETAIL_VIEW hvor pk1,2=SEQ_NO,ENHET_SEQ_NO condition SUBMIT
               ApplyMRD på  V_PLUKKE_LISTE_DETAIL_VIEW hvor pk1,2=SEQ_NO,ENHET_SEQ_NO condition Request=Expression 1 = MULTI_ROW_DELETE         
            -------------------------------------------------------------------------------------------------
            ORA-01445 :   http://www.apex-at-work.com/2012/12/apex-41-tabular-form-ora-01445-cannot.html
            failed to parse SQL query: ORA-01445: kan ikke velge ROWID fra, eller bruke utdrag av, et sammenføyingsutsnitt uten en nøkkelpreservert tabell
            ORA-01779: kan ikke endre kolonne som tilordner til en ikke nøkkelbasert tabell (Row 1)
            ORA-01733: virtuell kolonne er ikke tillatt her
            Triks endre view med  driver.enhet_Seq_no     = 200643
            lagre rapport sql i APEX og kjør,  sett etterpå tilbake 
            Logg inn/ut slik at alt resettes
            -------------------------------------------------------------------------------------------------
            ------------NB APEX bruker update/delete på v_plukke_liste_detail med instead trigger -----------
            -------------------------------------------------------------------------------------------------        
            Forutsetter:   
            likt ant i enhet, v_enhet, v_enhet_vis  ok pr 2010_08_09
           --2010_08_20   #808 471 på hele viwet
           #808 454 på v_gruppe_faktisk
            84311  SAAB 9-5 2000
            84308  SAAB 9000 1992
    Dato    Endring
    ===       =======        
    2010_08_09 laget
    2010_08_29 lagt til pris, og temp kolonnen etter at APEX ble ordnet til å vise 256 rows
    2010_09_09 tatt vekk Vrak og Hold i varegruppen
    2010_09_18 oppslag mot faktisk data på enhet_seq_no
    2011_02_14 legger inn nbf info
    2011_02_18 lager view og upd av samme view for bruk i APEX
    2012_02_28 eksluderer dummy, ref ramlet inn igjen etter ombygging av v_vare_gruppe
    2012_03_01 bytter ut ekster.v_obas_nbf_priser med v_nbf_priser_obas
    2012_09_02 byttet ut p622 mev v_plukke_liste_detail_view --> denne v_plukke_liste
    2012_09_04 erstatter v_plukke_liste i p622
    2013_09_06 ny side p623 ref for mye tull med bad request p622 kasseres
    */                 
      driver.enhet_vare_gruppe_seq_no  ||'_'||
      nvl(paa_bil_faktisk.enhet_seq_no,driver.enhet_seq_no )                         as seq_no,                         --pk ref kan være flere innredninger på samme varegruppe
      driver.fab_type_vare_gruppe_seq_no                                             as fab_type_vare_gruppe_seq_no,    --seq_no konkatinert                                           
      nvl(paa_bil_faktisk.enhet_seq_no,driver.enhet_seq_no )                         as del_seq_no,                     --del 
      driver.enhet_seq_no                                                            as enhet_seq_no,                   --bil      pk2                 
      driver.var_bil_seq_no                                                          as var_bil_seq_no,                                        
      driver.vare_gruppe_seq_no                                                      as vare_gruppe_seq_no,                                   
      driver.fab_seq_no                                                              as fab_seq_no,
      driver.type_seq_no                                                             as type_seq_no,                                         
      case when paa_bil_faktisk.status is not null then 'yellow'                                                                               
         --when sal between 1000 and 2000 then 'purple'                                                                                        
         --when sal > 2000 then 'green'                                             
      end                                                                            as status_color,
      driver.vare_gruppe                                                             as vare_gruppe_id, 
      paa_bil_faktisk.status                                                         as status,                                                
      paa_bil_faktisk.pris                                                           as pris,
      paa_bil_faktisk.besk                                                           as besk,
      paa_bil_faktisk.merk                                                           as merk,   
      v_nbf_priser_obas.nbf_ant                                                      as nbf_ant,
      ant_solgt.ant_solgt                                                            as ant_solgt,
      ant_p_lager.ant_p_lager                                                        as ant_p_lager,
      ant_plukk.ant_plukk                                                            as ant_plukk,
      max_min.max                                                                    as max,
      max_min.min                                                                    as min,
      max_min.max_solgt                                                              as max_solgt,
      max_min.min_solgt                                                              as min_solgt,
      v_nbf_priser_obas.nbf_max                                                      as nbf_max,
      v_nbf_priser_obas.nbf_min                                                      as nbf_min,
      ant_tot.ant_tot                                                                as ant_tot
    from 
       (--------------------------------------------------------------------------------------------------------------------------------------------
        ---------------------------------------------drive kartesisk-produkt------------------------------------------------------------------------
        --key: enhet_seq_no
        --     vare_gruppe_seq_no
        --select count(*) from mv_enhet_vare_g_driver
        --                    alle vrak       kun paa lager
        --      2013_02_28    4 937 056        92 584
        --      2013_09_01    5 323 580       116 156
        --      2013_09_01    5 320 740 (V_ekstern borte)
        --      2013_09_02    5 325 852      ant nye vrak x ant varegrupper mv ikke oppdatert med disse
        --      2013_09_03    5 320 740       mv
        --      2013_09_03    5 328 408       sql direkte nye vrak , sikker ikke ny varegruppe hvis Ulft ikke har vært hyperaktiv
        --      2013_09_04    5 332 392  
        --                    5 351 168     v_nbf_priser_obas (før mv og distinct)
        --                    5 332 392     koplett pakke med aggregerte verdier
        --      2013_09_05    5 430 031     før og etter del_seq_no innført i pk
        --      2013_09_06    5 432 921
        select 
          --Gir samme resultat med/uten DISTINCT
          --Trix for å gi pk til APEX
          --NB kan ikke bruke rownum -->table scann ann mass
          --18 736 872  v_vare_gruppe=264, enhet 70973   264 x 70973 = 18 736 872
          -- vare_gruppe_seq_no 0 Holde og 1 Vrak utelates --> 262 kombinasjoener av deler...
                                    enhet.enhet_seq_no||'_'||v_vare_gruppe.vare_gruppe_seq_no  as enhet_vare_gruppe_seq_no,
          var_bil.fab_seq_no||'_'||var_bil.type_seq_no||'_'||v_vare_gruppe.vare_gruppe_seq_no  as fab_type_vare_gruppe_seq_no,
          enhet.enhet_seq_no                                                                   as enhet_seq_no,                     --pk
          v_vare_gruppe.vare_gruppe_seq_no                                                     as vare_gruppe_seq_no,               --pk
          v_vare_gruppe.vare_gruppe                                                            as vare_gruppe,
          enhet.var_bil_seq_no                                                                 as var_bil_seq_no,
          var_bil.fab_seq_no                                                                   as fab_seq_no,
          var_bil.type_seq_no                                                                  as type_seq_no
        from  v_vare_gruppe,
              var_bil,          
              enhet
        where 1=1
          --henter fab_type  (utelater automatisk alle V_EKSTERN somm ikke har var_bil_seq_no)
          and enhet.var_bil_seq_no = var_bil.var_bil_seq_no
          --kun vrak
          and enhet.vare_gruppe_seq_no=1
            --ekskluderer Vrak og Hold 
          and v_vare_gruppe.vare_gruppe_seq_no not in (1,0)            
          --ekskluderer dummy (vrak og hold er ikke dummy)
          and     nvl(v_vare_gruppe.dummy,'x') <> 'Y'              
       ) driver,
       (--------------------------------------------------------------------------------------------------------------------------------------------
        ---------------------------------------------på bil faktisk------------------------------------------------------------------------
        --kan ikke bruke sub-select her fordi det kan plukkes flere intriør, felger abs enheter etc ref ikke 1:1 mellom varegruppe og deletype
         /*==========================================*/
         /*paa_bil_faktisk*/
         /*==========================================*/ 
          --2013_09_01    338
          --Merk at det kan feks være 2 like varegrupper per prev_enhet_seq_no (overordnet vrak)
          --                                 vare_gruppe_seq_no   vrak_nr   prev_enhet_seq_no
          --select prev_enhet_seq_no,vare_gruppe_seq_no,count(*) from enhet where 1=1 and paa_bil='J' having count(*)>1 group by prev_enhet_seq_no,vare_gruppe_seq_no;
          --  eks, Felg alminium, Felg stål  36590/1
          --       Vinduspussermotor foran   1700
          --       Calipter HB, VB           909/10
          --       Airbag sensor             1504
          --       Innredning                29041                V19785    203520 Avensis 2012
        select
          prev_enhet_seq_no||'_'||vare_gruppe_seq_no               as prev_enhet_vare_gruppe_seq_no,
          enhet_seq_no                                             as enhet_seq_no,                 --pk   dele nr.
          prev_enhet_seq_no                                        as prev_enhet_seq_no,            --pk   vrak nr.
          vare_gruppe_seq_no                                       as vare_gruppe_seq_no,           --pk
          decode(paa_bil,'J','Plukk '||pris_inkl_mva||'kr',null)   as status,
          pris_inkl_mva                                            as pris,
          enhet_besk                                               as besk,
          temp                                                     as merk
        from enhet
        where 1=1
          and paa_bil='J'
        )paa_bil_faktisk,
        --------------------------------------------------------------------------------------------------------------------------------------------
        --AGGREGERTE VERDIER (kan være litt upresise)
        --key: fab_seq_no
        --     type_seq_no
        --     vare_gruppe_seq_no 
        --as fab_type_vare_gruppe_seq_no
        --------------------------------------------------------------------------------------------------------------------------------------------
        mv_fab_type_vare_g_ant_tot     ant_tot,
        mv_fab_type_vare_g_ant_solgt   ant_solgt,
        mv_fab_type_vare_g_ant_p_lager ant_p_lager,
        mv_fab_type_vare_g_ant_plukk   ant_plukk,
        mv_fab_type_vare_g_max_min     max_min,
        mv_nbf_priser_obas             v_nbf_priser_obas
    where 1=1
      -- NB joiner ikke på enhet_seq_no ref denne kan vi ha flere av (eks 2 Innredninger)
      --vi har heller ikke noen delenr i driveren
      and  driver.enhet_seq_no                 = paa_bil_faktisk.prev_enhet_seq_no         (+)
      and  driver.vare_gruppe_seq_no           = paa_bil_faktisk.vare_gruppe_seq_no        (+)
      --and driver.fab_type_vare_gruppe_seq_no =   ant_tot.fab_type_vare_gruppe_seq_no     (+)
      and  driver.fab_seq_no                   = ant_tot.fab_seq_no                        (+)
      and  driver.type_seq_no                  = ant_tot.type_seq_no                       (+)
      and  driver.vare_gruppe_seq_no           = ant_tot.vare_gruppe_seq_no                (+)  
      --and driver.fab_type_vare_gruppe_seq_no =   ant_solgt.fab_type_vare_gruppe_seq_no   (+)
      and  driver.fab_seq_no                   = ant_solgt.fab_seq_no                      (+)
      and  driver.type_seq_no                  = ant_solgt.type_seq_no                     (+)
      and  driver.vare_gruppe_seq_no           = ant_solgt.vare_gruppe_seq_no              (+)
      --and driver.fab_type_vare_gruppe_seq_no =   ant_p_lager.fab_type_vare_gruppe_seq_no (+) 
      and  driver.fab_seq_no                   = ant_p_lager.fab_seq_no                    (+)
      and  driver.type_seq_no                  = ant_p_lager.type_seq_no                   (+)
      and  driver.vare_gruppe_seq_no           = ant_p_lager.vare_gruppe_seq_no            (+)
      --and driver.fab_type_vare_gruppe_seq_no =   ant_plukk.fab_type_vare_gruppe_seq_no   (+)
      and  driver.fab_seq_no                   = ant_plukk.fab_seq_no                      (+)
      and  driver.type_seq_no                  = ant_plukk.type_seq_no                     (+)
      and  driver.vare_gruppe_seq_no           = ant_plukk.vare_gruppe_seq_no              (+)
      --and driver.fab_type_vare_gruppe_seq_no =   max_min.fab_type_vare_gruppe_seq_no     (+) 
      and  driver.fab_seq_no                   = max_min.fab_seq_no                        (+)
      and  driver.type_seq_no                  = max_min.type_seq_no                       (+)
      and  driver.vare_gruppe_seq_no           = max_min.vare_gruppe_seq_no                (+)
      and driver.var_bil_seq_no                = v_nbf_priser_obas.var_bil_seq_no          (+)
      and driver.vare_gruppe_seq_no            = v_nbf_priser_obas.vare_gruppe_seq_no      (+)
      -- må brukes dersom APEX skal knytte master detail 1.ste gang 
      -- ellers blir det fullt kartesisk produkt
      --Avensis 2012 203520 V19785    
      --Polo         202241 V19519
      --bærearm nede 3 fra før på lager.. før vistes ingen fre det er ikke 05 modeller
      --and driver.enhet_seq_no=202241
    order by driver.vare_gruppe
    /
    grant select on v_plukke to public;
    select count(*) from v_plukke;
    select count(*) from v_plukke where enhet_seq_no =202241;    
    select * from v_plukke where "SEQ_NO" = '202241_900_202241';                            --10s
    select * from v_plukke where "SEQ_NO" = '202241_900_202241' and enhet_seq_no=202241;    --1s
    
    Konk bruk IKKE row id via key-preserved table som APEX p6xxx lages mot for så å bytte til et view av denne tabellen (med samme navn)
    create table v_plukke_liste as (select * from v_plukke where enhet_seq_no =203520);  
    --drop  table v_plukke_liste;
    --drop view v_plukke_liste;
    p623 kun  SEQ_NO
    p624 både seq_no og enhet_seq_no   create sequence v_plukke_seq_no increment by 1;
    p625 via tabell og ROWID  VIRKER ikke
    
    update "OLA"."V_PLUKKE" set "SEQ_NO" = '202241_906202241', "PRIS" = 1, "BESK" = null, "MERK" = null where "SEQ_NO" = '202241_906202241';
    8.27800  40.15400  ......Row 3: 
    update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "PRIS" = :b2, "BESK" = :b3, "MERK" = :b4 where "SEQ_NO" = :p_pk_col and (enhet_seq_no =:P623_ENHET_SEQ_NO)
    update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "PRIS" = :b2, "BESK" = :b3, "MERK" = :b4 where "SEQ_NO" = :p_pk_col and (enhet_seq_no =:P623_ENHET_SEQ_NO)
    update "OLA"."V_PLUKKE" set "SEQ_NO" = '202241_906202241', "PRIS" = 1, "BESK" = null, "MERK" = null where "SEQ_NO" = '202241_906202241' and (enhet_seq_no =202241);
    delete from &quot;OLA&quot;.&quot;V_PLUKKE&quot; where &quot;SEQ_NO&quot; = :p_pk_col and (enhet_seq_no=:P623_ENHET_SEQ_NO)
    
    ......Row 1: 
    update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "ENHET_SEQ_NO" = :b2, "PRIS" = :b3, "BESK" = :b4, "MERK" = :b5 where "SEQ_NO" = :p_pk_col and "ENHET_SEQ_NO" = :p_pk_col2 and (enhet_seq_no = :P624_ENHET_SEQ_NO)
    update "OLA"."V_PLUKKE" set "SEQ_NO" = '203520_902_203520', "PRIS" = 1, "BESK" = null, "MERK" = null where "SEQ_NO" = '203520_902_203520' and (enhet_seq_no =203520);
    
    Insert på V19578 ABS enhet -> 2 records
    
    7.99200  7.55200  ......Row 1:   203520_902_203520
     update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "PRIS" = :b2, "BESK" = :b3, "MERK" = :b4 where "SEQ_NO" = :p_pk_col and (enhet_seq_no=:P623_ENHET_SEQ_NO)  
    
    
    15.54400  0.22900  ......Row 185:203520_802_203581  (har dato ut)
     update "OLA"."V_PLUKKE" set "SEQ_NO" = :b1, "PRIS" = :b2, "BESK" = :b3, "MERK" = :b4 where "SEQ_NO" = :p_pk_col and (enhet_seq_no=:P623_ENHET_SEQ_NO)  
    
    Delete av abs enhet -> 2 records
    0.02000  0.18900  MRU: 
    delete from &quot;OLA&quot;.&quot;V_PLUKKE&quot; where &quot;SEQ_NO&quot; = :p_pk_col and (enhet_seq_no=:P623_ENHET_SEQ_NO)  
    
    TODO
    fikse knapper annen plass en Registrering
    sjekke Print
    oppdater kokebok over
    finne metode for flere innredninger......
    
    
----------------------------------------------------------- v_plukke2 p 627 -----------------------------------------------------------------------------------
    create or replace view v_plukke2 as
    --create or replace view ttt as 
        /*      APEX master page 627
            2014_01_13 kopiert v_plukke til v_plukke2
            2014_02_02 bytter ut Materilaized view med eget view
            2014_02_18 innført LBK data
            2018_05_05 innfører with
        */ 
        with  
            driver as (
                ---------------------------------------------drive kartesisk-produkt------------------------------------------------------------------------ 
                --kobler alle bilene med alle varegruppene,  men når det kommer til select trekker vi kun ut en bil
                --key: enhet_seq_no, vare_gruppe_seq_no
                    select distinct
                        enhet.enhet_seq_no                   as enhet_seq_no,                     --alle plukke bilene
                        var_bil.var_bil_seq_no               as var_bil_seq_no,                   --bil fab-type-år                  
                        var_bil.var_bil_scope_seq_no         as var_bil_scope_seq_no,             --bil scope
                        vare_gruppe.vare_gruppe_seq_no       as vare_gruppe_seq_no                --kartesisk produkt mot vare_gruppe
                    from  vare_gruppe,
                         var_bil,          
                         enhet
                    where 1=1
                        --BIL
                          and enhet.var_bil_seq_no = var_bil.var_bil_seq_no      --henter fab_type  (utelater automatisk alle V_EKSTERN somm ikke har var_bil_seq_no)            
                          and enhet.vare_gruppe_seq_no=1                         --kun vrak dvs henter IKKE opp deler fom ikke har overordnet vrak
                        --VARE_GRUPPE
                          and vare_gruppe.vare_gruppe_seq_no not in (1,0)        --ekskluderer Vrak og Hold 
                          and nvl(vare_gruppe.dummy,'x') <> 'Y'                  --ekskluderer dummy (vrak og hold er ikke dummy)
                                                                                 --joiner ikke mot varegruppen --> går alle varegruppene på den    
            ), paa_bil_faktisk as (  
                ---------------------------------------------på bil faktisk------------------------------------------------------------------------
                --kan ikke bruke sub-select her fordi det kan plukkes flere intriør, felger abs enheter etc ref ikke 1:1 mellom varegruppe og deletype
                    --2013_09_01    338
                    --Merk at det kan feks være 2 like varegrupper per prev_enhet_seq_no (overordnet vrak)
                    --                                 vare_gruppe_seq_no   vrak_nr   prev_enhet_seq_no
                    --select prev_enhet_seq_no,vare_gruppe_seq_no,count(*) from enhet where 1=1 and paa_bil='J' having count(*)>1 group by prev_enhet_seq_no,vare_gruppe_seq_no
                    --  eks, Felg alminium, Felg stål  36590/1
                    --       Vinduspussermotor foran   1700
                    --       Calipter HB, VB           909/10
                    --       Airbag sensor             1504
                    --       Innredning                29041                V19785    203520 Avensis 2012
                    select
                        enhet_seq_no                                             as enhet_seq_no,                 --pk   dele nr.
                        prev_enhet_seq_no                                        as prev_enhet_seq_no,            --pk   vrak nr.
                        vare_gruppe_seq_no                                       as vare_gruppe_seq_no,           --pk
                        decode(paa_bil,'J','Plukk '||pris_inkl_mva||'kr',null)   as status,
                        pris_inkl_mva                                            as pris,
                        enhet_besk                                               as besk,
                        temp                                                     as merk
                    from enhet
                    where 1=1
                        and paa_bil='J'
            )
        select            
            nvl(paa_bil_faktisk.enhet_seq_no,driver.enhet_seq_no )                          as del_seq_no,                     --del 
            driver.enhet_seq_no                                                             as enhet_seq_no,                   --bil
            driver.var_bil_seq_no                                                           as var_bil_seq_no,                                        
            driver.vare_gruppe_seq_no                                                       as vare_gruppe_seq_no,  
            null                                                                            as to_do,   
            (select vare_gruppe 
            from v_vare_gruppe 
            where v_vare_gruppe.vare_gruppe_seq_no=driver.vare_gruppe_seq_no)               as vare_gruppe_id, 
            paa_bil_faktisk.pris                                                            as pris,
            paa_bil_faktisk.besk                                                            as besk,
            paa_bil_faktisk.merk                                                            as merk,   
            case when paa_bil_faktisk.status is not null then 'yellow'
               --when sal between 1000 and 2000 then 'purple'
               --when sal > 2000 then 'green'                                             
            end                                                                             as status_color,
            paa_bil_faktisk.status                                                          as status,
            mv_scope_bil_vare_ant_p_lager.ant_p_lager                                       as ant_p_lager, 
            mv_scope_bil_vare_ant_solgt.ant_solgt                                           as ant_solgt,   
            mv_scope_bil_vare_ant_plukk.ant_plukk                                           as ant_plukk,   
            mv_scope_bil_vare_max_min.ant_tot                                               as ant_tot,
            mv_scope_bil_vare_max_min.max                                                   as max,
            mv_scope_bil_vare_max_min.min                                                   as min,
            mv_scope_bil_vare_max_min.max_solgt                                             as max_solgt,
            mv_scope_bil_vare_max_min.min_solgt                                             as min_solgt,
            mv_scope_bil_vare_nbf_pris.nbf_ant                                              as nbf_ant,
            mv_scope_bil_vare_nbf_pris.nbf_max                                              as nbf_max,
            mv_scope_bil_vare_nbf_pris.nbf_min                                              as nbf_min,
            mv_scope_bil_vare_lbk_pris.lbk_ant                                              as lbk_ant,
            mv_scope_bil_vare_lbk_pris.lbk_max                                              as lbk_max,
            mv_scope_bil_vare_lbk_pris.lbk_min                                              as lbk_min
        from
             driver
            ,paa_bil_faktisk                                                                                        --                              05.05.18
            /*  select sum(ant_p_lager) from mv_scope_bil_vare_ant_p_lager                                               81161                      102268
                select sum(ant_solgt)   from mv_scope_bil_vare_ant_solgt                                                287049                      473919
                select sum(ant_plukk)   from mv_scope_bil_vare_ant_plukk                                                   927                         812
                select sum(ant_tot),max(max),min(min),max(max_solgt),min(min_solgt)  from mv_scope_bil_vare_max_min     368249   990   1  9750  1   102268   65000  50 3000 100
                select sum(nbf_ant), max(nbf_max), min(nbf_min) from mv_scope_bil_vare_nbf_pris                       18964373   999   1           6931402  130000   1  
            */
            ,mv_scope_bil_vare_ant_p_lager
            ,mv_scope_bil_vare_ant_solgt
            ,mv_scope_bil_vare_ant_plukk
            ,mv_scope_bil_vare_max_min
            ,mv_scope_bil_vare_nbf_pris
            ,mv_scope_bil_vare_lbk_pris  
        where 1=1
            -- NB joiner ikke på enhet_seq_no ref denne kan vi ha flere av (eks 2 Innredninger)
            --vi har heller ikke noen delenr i driveren
            --and  driver.enhet_seq_no                 = paa_bil_faktisk.prev_enhet_seq_no         (+)
            --and  driver.vare_gruppe_seq_no           = paa_bil_faktisk.vare_gruppe_seq_no        (+)
              and  driver.enhet_seq_no||driver.vare_gruppe_seq_no = paa_bil_faktisk.prev_enhet_seq_no(+)||paa_bil_faktisk.vare_gruppe_seq_no(+) --Trix ungår full table access
            --Materialized views (trenger ikke joine på scope fordi det er 1-1 mot var_bil)
            --------------------  
            and driver.var_bil_seq_no      = mv_scope_bil_vare_ant_p_lager.var_bil_seq_no     (+)         --bilen
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_ant_p_lager.vare_gruppe_seq_no (+)        --men KUN denne varegruppen
            and driver.var_bil_seq_no      = mv_scope_bil_vare_ant_solgt.var_bil_seq_no       (+)      
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_ant_solgt.vare_gruppe_seq_no   (+)     
            and driver.var_bil_seq_no      = mv_scope_bil_vare_ant_plukk.var_bil_seq_no       (+)      
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_ant_plukk.vare_gruppe_seq_no   (+)     
            and driver.var_bil_seq_no      = mv_scope_bil_vare_max_min.var_bil_seq_no         (+)      
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_max_min.vare_gruppe_seq_no     (+)     
            and driver.var_bil_seq_no      = mv_scope_bil_vare_nbf_pris.var_bil_seq_no         (+)      
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_nbf_pris.vare_gruppe_seq_no     (+)     
            and driver.var_bil_seq_no      = mv_scope_bil_vare_lbk_pris.var_bil_seq_no         (+)      
            and driver.vare_gruppe_seq_no  = mv_scope_bil_vare_lbk_pris.vare_gruppe_seq_no     (+)     
            --test
            --V20743 , 208271  BMW 500
            --V20932 , 280032  Renault Laguna
            --and driver.enhet_seq_no=280032
        order by vare_gruppe_id
    /

    grant select on v_plukke2 to public;
    
        --dill
            select count(*) from v_plukke2;
            6 006 482

            TOTOTOTOTO DO  fikse v_nbf_priser_obas slik at fab, type og scope brukes istede for var_bil_seq_no
                           dette fordi mange obas_var_bil_seq_no mappes mot en nbf_varegruppe
                           evnt bruke årstall i tillegg


            --sjekk antall
                        SELECT 
                        --key bil
                         VAR_BIL.VAR_BIL_SEQ_NO,           VAR_BIL.SBRNR, VAR_BIL.LBKNR, 
                         --key del
                         V_VARE_GRUPPE.VARE_GRUPPE_SEQ_NO, MAP_DEL.SBRNR, MAP_DEL.LBKNR,
                       --bil info fra var_bil.var_bil_seq_no
                        V_VAR_BIL.FAB_NAVN, V_VAR_BIL.TYPE_ID, V_VAR_BIL.AAR_4, V_VAR_BIL.SCOPE, 
                        --
                        V_VARE_GRUPPE.VARE_GRUPPE, ENHET_1.PAA_BIL, ENHET_1.LOCATION_SEQ_NO
                        FROM OLA.ENHET ENHET, OLA.ENHET ENHET_1, OLA.MAP_DEL MAP_DEL, OLA.V_VAR_BIL V_VAR_BIL, OLA.V_VARE_GRUPPE V_VARE_GRUPPE, OLA.VAR_BIL VAR_BIL
                        WHERE V_VAR_BIL.VAR_BIL_SEQ_NO = ENHET.VAR_BIL_SEQ_NO 
                        AND VAR_BIL.VAR_BIL_SCOPE_SEQ_NO = V_VAR_BIL.VAR_BIL_SCOPE_SEQ_NO 
                        AND VAR_BIL.FAB_SEQ_NO = V_VAR_BIL.FAB_SEQ_NO 
                        AND VAR_BIL.TYPE_SEQ_NO = V_VAR_BIL.TYPE_SEQ_NO 
                        AND ENHET.ENHET_SEQ_NO = ENHET_1.PREV_ENHET_SEQ_NO 
                        AND ENHET_1.VARE_GRUPPE_SEQ_NO = V_VARE_GRUPPE.VARE_GRUPPE_SEQ_NO 
                        AND V_VARE_GRUPPE.VARE_GRUPPE_SEQ_NO = MAP_DEL.VARE_GRUPPE_SEQ_NO 
                        --driver
                        AND ((VAR_BIL.VAR_BIL_SEQ_NO=102007))




            --truncate table plan_table;
            explain plan set statement_id='733' into plan_table for
            select * from v_plukke2;
            commit;

            --truncate table plan_table;
            explain plan set statement_id='733a' into plan_table for
            select * from ttt;
            commit;


            --truncate table plan_table;
            explain plan set statement_id='733b' into plan_table for
            select * from v_plukke2 where enhet_seq_no=208271;
            commit;

            -- 
            create table test5 as select * from var_bil;
            update test5 set var_bil_scope_seq_no=-var_bil_seq_no where var_bil_scope_seq_no is null;
            alter table test5 modify var_bil_scope_seq_no not null;
            create index  test5_i3 on  test5 (var_bil_scope_seq_no);
            alter table test5 add constraint  test5_pk1 primary key (var_bil_seq_no)
            --truncate table plan_table;
            explain plan set statement_id='733' into plan_table for
            select count(*)
                 from ola.var_bil   var_bil,
                      ola.var_bil   var_bil_alle,
                      ola.enhet     enhet_prev,
                      ola.enhet     enhet
                 where 1=1
                 and 102007            = var_bil.var_bil_seq_no                                 --bilen
                 --and var_bil.var_bil_seq_no =         var_bil_alle.var_bil_seq_no        --scope til bilen
                 and var_bil.var_bil_scope_seq_no=var_bil_alle.var_bil_seq_no
                 --and nvl(var_bil.var_bil_scope_seq_no     ,-var_bil.var_bil_seq_no) =
                 --    nvl(var_bil_alle.var_bil_scope_seq_no,-var_bil_alle.var_bil_seq_no)        --scope til bilen
                 and var_bil_alle.var_bil_seq_no      =enhet_prev.var_bil_seq_no                --alle bilene på scopet
                 and enhet.prev_enhet_seq_no          = enhet_prev.enhet_seq_no                 --med alle delene
                 and enhet.vare_gruppe_seq_no         = 902               --men KUN denne varegruppen
                 --på lager
                 and enhet.location_seq_no is null
                 --ikke i plukke listen
                 and nvl(enhet.paa_bil,'x') <> 'J';
            commit;

            --truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select var_bil_seq_no,
                              nvl(var_bil_scope_seq_no,-var_bil_seq_no) ,
                              obas,
                              type_klasse,
                              scope 
                        from ola.v_var_bil v_var_bil
                        where var_bil_seq_no=102007
            ;
            commit;
            --truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select var_bil.var_bil_seq_no
                        from ola.var_bil       var_bil,
                             ola.var_bil_scope var_bil_scope
                        where var_bil.var_bil_scope_seq_no = var_bil_scope.var_bil_scope_seq_no (+)    
                        and var_bil.var_bil_seq_no=102007
            ;
            commit;

            --truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select distinct
                  enhet.enhet_seq_no                                                           as enhet_seq_no,                     --alle plukke bilene
                  var_bil.var_bil_seq_no                                                       as var_bil_seq_no,                   --bil fab-type-år                  
                  var_bil.var_bil_scope_seq_no                                                 as var_bil_scope_seq_no,             --bil scope                        
                  vare_gruppe.vare_gruppe_seq_no                                               as vare_gruppe_seq_no                --vare_gruppe
                from  vare_gruppe,
                      var_bil,          
                      enhet
                where 1=1
                  --BIL
                  and enhet.var_bil_seq_no = var_bil.var_bil_seq_no    --henter fab_type  (utelater automatisk alle V_EKSTERN somm ikke har var_bil_seq_no)            
                  and enhet.vare_gruppe_seq_no=1                       --kun vrak dvs henter IKKE opp deler fom ikke har overordnet vrak
                  --VARE_GRUPPE
                  and vare_gruppe.vare_gruppe_seq_no not in (1,0)      --ekskluderer Vrak og Hold 
                  and nvl(vare_gruppe.dummy,'x') <> 'Y'               --ekskluderer dummy (vrak og hold er ikke dummy)
                                                                       --joiner ikke mot varegruppen --> går alle varegruppene på den 
                  and enhet.enhet_seq_no=208271;
            commit;

            select 
                                            enhet.enhet_seq_no||'_'||v_vare_gruppe.vare_gruppe_seq_no  as enhet_vare_gruppe_seq_no,
                  var_bil.fab_seq_no||'_'||var_bil.type_seq_no||'_'||v_vare_gruppe.vare_gruppe_seq_no  as fab_type_vare_gruppe_seq_no,
                  enhet.enhet_seq_no                                                                   as enhet_seq_no,                     --pk
                  v_vare_gruppe.vare_gruppe_seq_no                                                     as vare_gruppe_seq_no,               --pk
                  v_vare_gruppe.vare_gruppe                                                            as vare_gruppe,
                  enhet.var_bil_seq_no                                                                 as var_bil_seq_no,
                  var_bil.fab_seq_no                                                                   as fab_seq_no,
                  var_bil.type_seq_no                                                                  as type_seq_no
                from  v_vare_gruppe,
                      var_bil,          
                      enhet
                where 1=1
                  --henter fab_type  (utelater automatisk alle V_EKSTERN somm ikke har var_bil_seq_no)
                  and enhet.var_bil_seq_no = var_bil.var_bil_seq_no
                  --kun vrak
                  and enhet.vare_gruppe_seq_no=1
                    --ekskluderer Vrak og Hold 
                  and v_vare_gruppe.vare_gruppe_seq_no not in (1,0)            
                  --ekskluderer dummy (vrak og hold er ikke dummy)
                  and     nvl(v_vare_gruppe.dummy,'x') <> 'Y' 
                   and enhet.enhet_seq_no=208271;

            truncate table plan_table;
            explain plan set statement_id='733' into plan_table for 
            select count(*)
                 from ola.enhet   enhet_prev,
                      ola.enhet   enhet
                 where 1=1
                 and 102007           = enhet_prev.var_bil_seq_no  --alle bilene
                 and enhet.prev_enhet_seq_no         = enhet_prev.enhet_seq_no    --med alle delene
                 and enhet.vare_gruppe_seq_no        = 1303
                 --på lager
                 and enhet.location_seq_no is not null
                 --ikke i plukke listen
                 and nvl(enhet.paa_bil,'x') <> 'J'  ;
            commit;  
        
----------------------------------------------------------- v_plukke2_stat ------------------------------------------------------------------------------------
    create or replace view v_plukke2_stat as
    --------------------------------------------------------------------------------------------------------------------------------------------
    -----------------------------------------AGGREGERTE VERDIER (kan være litt upresise)--------------------------------------------------------
    --key: fab_seq_no
    --     type_seq_no
    --     vare_gruppe_seq_no
    --------------------------------------------------------------------------------------------------------------------------------------------
    --create materialized view ola.mv_fab_type_vare_g_ant_p_lager
    --select count(*) from mv_fab_type_vare_g_ant_p_lager
    --    2013_09_01     11 233
    --    2014_02_01     11 187 (har ikke oppfrisket view på leeeenge
    --NB forenkler og ser kun på deler som ligger på vrak (ikke deler som ikke har overordnet vrak)
     select
       var_bil.fab_seq_no||'_'||var_bil.type_seq_no||'_'||enhet.vare_gruppe_seq_no as fab_type_vare_gruppe_seq_no,
       var_bil.fab_seq_no                                                          as fab_seq_no,
       var_bil.type_seq_no                                                         as type_seq_no,
       enhet.vare_gruppe_seq_no                                                    as vare_gruppe_seq_no,
       count(*)                                                                    as ant_p_lager
     from ola.enhet enhet_prev,
          ola.var_bil,
          ola.enhet enhet 
     where 1=1
       and enhet.prev_enhet_seq_no   = enhet_prev.enhet_seq_no
       and enhet_prev.var_bil_seq_no = var_bil.var_bil_seq_no
       --på lager
       and enhet.location_seq_no is not null
       and nvl(enhet.paa_bil,'x') <> 'J'
    group by var_bil.fab_seq_no,var_bil.type_seq_no,enhet.vare_gruppe_seq_no
    /
    
    
----------------------------------------------------------- v_plukke_liste_xml_rapp ------------------------------------------------------------------------------------------
    set pages 0
    set linesize 150
    set long 9999999
    set head off
    
    --create or replace view v_plukke_liste_xml_rapp as
    select dbms_xmlgen.getxml('
    select   
    /*
    Dato     Endring
    ===        =======        
    2010_09_26 laget
    */        
    v_plukke_liste_master.enhet_seq_no           as enhet_seq_no,
    v_plukke_liste_master.prev_enhet_seq_no      as prev_enhet_seq_no,
    v_plukke_liste_master.reg_no                     as reg_no,
    v_plukke_liste_master.fab_navn               as fab_navn,
    v_plukke_liste_master.type_id                as type_id,
    v_plukke_liste_master.aar         as aar,
    v_plukke_liste_master.betegnelse             as betegnelse,
    v_plukke_liste_master.nbf_sbrnr               as nbf_sbrnr,
    v_plukke_liste_master.nbf_namn               as nbf_namn,
    v_plukke_liste_master.vegdir_modell_type    as vegdir_modell_type,
    v_plukke_liste_master.vare_gruppe_id         as p_vare_gruppe_id,
    v_plukke_liste_master.loc_id                 as p_loc_id,
    v_plukke_liste_master.serie_no               as p_serie_no,
    v_plukke_liste_master.status        as p_status,
    v_plukke_liste_master.enhet_besk             as p_enhet_besk,
    v_plukke_liste_master.temp               as p_temp,
    cursor( select   v_enhet_vis.vare_gruppe_id       as vare_gruppe_id,
        v_enhet_vis.loc_id               as loc_id,
        v_enhet_vis.serie_no             as serie_no,
        v_enhet_vis.paa_bil             as status,
        v_enhet_vis.enhet_besk           as besk,
        v_enhet_vis.temp           as merk,
        v_enhet_vis.pris_inkl_mva      as pris
        from v_enhet_vis
        where v_plukke_liste_master.enhet_seq_no =     v_enhet_vis.prev_enhet_seq_no
        and  v_enhet_vis.paa_bil = chr(74)
        and  v_enhet_vis.loc_id is null) detail_row
    from v_plukke_liste_master,
         v_enhet_vis
    where v_plukke_liste_master.enhet_seq_no = v_enhet_vis.prev_enhet_seq_no
    and   v_enhet_vis.paa_bil      = chr(74)
    and   v_enhet_vis.loc_id      is null
    order by v_plukke_liste_master.fab_navn, v_plukke_liste_master.type_id, v_plukke_liste_master.aar, v_plukke_liste_master.reg_no
    ') 
    from dual
    /
    grant select on v_plukke_liste_xml_rapp to public
    /
    desc v_plukke_liste_xml_rapp;
    select dbms_xmlgen.getxml(    'select   d.deptno, 
              d.dname,
              cursor(  select empno, ename, job, sal
            from scott.emp e
            where e.deptno(+) = d.deptno) emp_row
            from scott.dept d')
    from dual;
    ------------------------------------------------------- v_plukke_liste_detail_rapp ------------------------------------------------------------------------------------------
        create or replace view v_plukke_liste_detail_rapp as
              select   
                    /*      APEX Shared Components Report Query
                            select * from v_plukke_liste_detail_rapp where enhet_seq_no=98659
                    Dato     Endring
                    ===        =======        
                    2010_09_26 laget
                    2011_05_21 lagt til hierakistisk varegruppe fra v_vare_gruppe
                    2011_11_28 byttet ut v_plukk_ecu_master med v_plukk_ecu_master
                    2012_02_28 eksluderer dummy, ref ramlet inn igjen etter ombygging av v_vare_gruppe
                    2018_01_01 decode for å matche fop/QR utskrift
                    */        
                    v_enhet_vis.enhet_seq_no                                                                    as enhet_seq_no,
                    v_enhet_vis.prev_enhet_seq_no                                                               as prev_enhet_seq_no,
                    nvl(v_plukk_ecu_master.reg_no,chr(160))                                                     as reg_no,
                    v_plukk_ecu_master.fab_navn                                                                 as fab_navn,
                    v_plukk_ecu_master.type_id                                                                  as type_id,
                    v_plukk_ecu_master.aar                                                                      as aar,
                    v_plukk_ecu_master.fab_navn||' '||v_plukk_ecu_master.type_id||' '||v_plukk_ecu_master.aar   as var_bil,
                    nvl(v_plukk_ecu_master.betegnelse,chr(160))                                                 as betegnelse,
                    v_plukk_ecu_master.nbf_sbrnr                                                                as nbf_sbrnr,
                    nvl(v_plukk_ecu_master.nbf_namn,chr(160))                                                   as nbf_namn,
                    nvl(v_plukk_ecu_master.vegdir_modell_type,chr(160))                                         as vegdir_modell_type,
                    v_plukk_ecu_master.vare_gruppe_id                                                           as p_vare_gruppe_id,
                    v_plukk_ecu_master.loc_id                                                                   as p_loc_id,
                    substr(v_plukk_ecu_master.serie_no,1,10)                                                    as p_serie_no,
                    v_plukk_ecu_master.status                                                                   as p_status,
                    decode(1,nvl(v_plukk_ecu_master.enhet_besk,chr(160))  ,90)                                  as p_enhet_besk,        --trix for å ikke få linjeskift i Plukkeliste
                    decode(1,nvl(v_plukk_ecu_master.temp,chr(160))        ,90)                                  as p_temp,              --trix for å ikke få linjeskift i Plukkeliste
                    v_enhet_vis.vare_gruppe_id                                                                  as vare_gruppe_id,
                    v_vare_gruppe.vare_gruppe                                                                   as vare_gruppe,
                    v_enhet_vis.loc_id                                                                          as loc_id,
                    v_enhet_vis.serie_no                                                                        as serie_no,
                    v_enhet_vis.paa_bil                                                                         as status,
                    --Sikre Space i XML fil ref problem with ampesand og nbsp i XML filer
                    --ampersand hash xA0  (160Desc)
                    nvl(v_enhet_vis.enhet_besk,chr(160))                                                        as besk,
                    nvl(v_enhet_vis.temp      ,chr(160))                                                        as merk,
                    --Må ha to_char ellers får vi invalid number feil
                    nvl(to_char(v_enhet_vis.pris_inkl_mva),chr(160))                                            as pris,
                    nvl(to_char(v_enhet_vis.org_pris_inkl_mva),chr(160))                                        as org_pris,
                    v_enhet_vis.pris_inkl_mva ||' --> ' ||v_enhet_vis.org_pris_inkl_mva                         as pris_fra_til
              from v_vare_gruppe,
                   v_plukk_ecu_master,
                   v_enhet_vis
              where 1=1
                    and v_plukk_ecu_master.enhet_seq_no = v_enhet_vis.prev_enhet_seq_no
                    and v_enhet_vis.vare_gruppe_id      = v_vare_gruppe.nivaa_3   
                    --ekskluderer Vrak og Hold
                    and v_vare_gruppe.vare_gruppe_seq_no not in (1,0)            
                    --ekskluderer dummy (vrak og hold er ikke dummy)
                    and nvl(v_vare_gruppe.dummy,'x') <> 'Y'            
                    and v_enhet_vis.paa_bil          = 'J'
                    and v_enhet_vis.loc_id           is null
              order by v_plukk_ecu_master.fab_navn, v_plukk_ecu_master.type_id, v_plukk_ecu_master.aar, v_plukk_ecu_master.reg_no,v_vare_gruppe.vare_gruppe 
        /
                grant select on v_plukke_liste_detail_rapp to public
                /
                desc v_plukke_liste_detail_rapp;
    
                select count(*) from v_plukke_liste_detail_rapp;
                #170
                #140 01.01.2018
                #209 19.02.2018
----------------------------------------------------------- v_plukke_kompis ---------------------------------------------------------------------------
    sqlplus ola/ola@192.168.1.5:1521/pdbobas.bildeler.net
    --Lure ting

        a)  Finne gjennomsnitts pris
            select AVG(pris) from t_enhet3 where enhet_seq_no=334976;

        b)  OBAS scope er bygget på var_bil_seq_no (unikt nr for modell/type/scope kombinasjon)

        c)  1=  Finne enhet_seq_no på fra en de
            2=  Finne var_bil_seq_no
            3=  Sjekke konsistens i forhold til resten av like modell/type/år




    --Logikk
        
        a)  Bygge sql kode for å liste ut alle deler som eksistrerer fra en unik modell/type/år (var_bil_seq_no)
        
        Nissan Navara D40 
        --2 var_bil_seq_no ???
            104564 --var_bil_seq_no
                Vrak        V33623 / 336512
                Fabrikant   Nissan
                Type        Navara D40
                År          2008
                Betegnelse  SINGLECAB SE        --kødder denne med var_bil_seq_no ???
                Motor type  D
                Volum       2,5
                Servo       J
                Gear-type   6 trinn
                Dører       4
                Kjøretøy    PICKUP
            104565
                Fabrikant   Nissan
                Type        Navara D40
                År          2007
                Betegnelse  Null
                Motor type  D
                Volum       2,5
                Servo       J
                Gear-type   6 trinn
                Dører       4
                Kjøretøy    PICKUP
            104566
                Vrak        V32571 / 331215          
                Fabrikant   Nissan
                Type        Navara D40
                År          2007
                Betegnelse  DOUBLECAB SE                
                Motor type  D
                Volum       2,5
                Servo       J
                Gear-type   Automat
                Dører       4
                Kjøretøy    PICKUP

        B)      bruke v_var_bil view (ola/nei)

                bygge sql med joininger fra v_var_bil ut i fra t_enhet3


                create or replace view tt as 
                    with 
                        bil_scope as (
                            --virtuell tabell med navn bil_scop (ligger i minnet)
                            --#8434
                            --#1699 
                            --#1749 m/scope
                            --select count(*) from (
                            select  distinct
                                    fab_seq_no
                                   ,type_seq_no
                                   ,var_bil_scope_seq_no
                                   ,scope
                                   --,obas||' '||scope  as bil
                            from  v_var_bil  
                            where 1=1 ),
                        del_scope as (
                            --select count(*) from t_enhet
                            select   bil_scope.fab_seq_no
                                    ,bil_scope.type_seq_no
                                    ,bil_scope.var_bil_scope_seq_no
                                    ,bil_scope.bil
                                    ,count(      del.enhet_seq_no               )  as deler
                                    ,sum  (decode(del.location_seq_no,null,0,1) )  as deler_inne
                                    ,sum  (decode(del.location_seq_no,null,1)   )  as deler_solgt 
                            from t_enhet3   del
                                ,bil_scope  bil_scope
                            where 1=1
                                and del.vare_gruppe_seq_no <>1
                                and del.fab_seq_no              = bil_scope.fab_seq_no
                                and del.type_seq_no             = bil_scope.type_seq_no
                                and del.var_bil_scope_seq_no    = bil_scope.var_bil_scope_seq_no 
                            group by bil_scope.fab_seq_no
                                    ,bil_scope.type_seq_no
                                    ,bil_scope.var_bil_scope_seq_no
                                    ,bil_scope.bil)
                    select  count(*)
                    from del_scope
                /

                " må legge inn var_bil_scope_seq_no, fab_seq_no, type_seq_no i t_enhet3 "

                



                create or replace view t as 
                    with bil_scope as (
                        --virtuell tabell med navn bil_scop (ligger i minnet)
                        --#60488 2020-07-03
                        select  t1.var_bil_seq_no       as p_var_bil_seq_no
                               ,t2.var_bil_seq_no       as c_var_bil_seq_no
                               ,t1.obas||' '||t1.scope  as bil
                        from  v_var_bil  t1
                             ,v_var_bil  t2
                        where 1=1
                        --den ene delen
                        --and t1.var_bil_seq_no =21551
                        --alle i samme scope
                        and t1.fab_seq_no           = t2.fab_seq_no             --18
                        and t1.type_seq_no          = t2.type_seq_no            --4
                        and t1.var_bil_scope_seq_no = t2.var_bil_scope_seq_no   --135
                    )
                    select distinct
                         vrak.enhet_seq_no              as enhet_seq_no_vrak
                        ,vrak.var_bil_seq_no            as var_bil_seq_no_vrak
                        --,bil_scope.c_var_bil_seq_no     as var_bil_seq_no_deler
                        ,bil_scope.bil
                        ,deler.enhet_seq_no
                        ,deler.serie_seq_no
                        ,deler.location_seq_no
                        ,deler.vare_gruppe_seq_no
                        ,deler.vare_gruppe_id
                    from  enhet         vrak
                         ,bil_scope     bil_scope
                         ,t_enhet3      deler
                    where 1=1
                        --and vrak.enhet_seq_no           = 336512     --test 1stk vrakfra Tommy
                        and vrak.vare_gruppe_seq_no     = 1
                        and deler.vare_gruppe_seq_no    <>1
                        and vrak.var_bil_seq_no         = bil_scope.p_var_bil_seq_no
                        and bil_scope.c_var_bil_seq_no  = deler.var_bil_seq_no
                    order by bil_scope.bil, deler.vare_gruppe_id
                /
                    --sjekk
                        select count(*) from enhet;
                            --159 849
                        select count(*) from t;
                            --19 546 893
                            --11 861 462

                       select count(*) from enhet where vare_gruppe_seq_no=1 and var_bil_seq_no is null;
                       --135 
                       
                       select count(*) from enhet where vare_gruppe_seq_no<> 1 and var_bil_seq_no is not null;
                       4254


                --solgt
                    select 
                        bil
                        ,vare_gruppe_id 
                        ,sum(decode(location_seq_no,null,0,1))  as deler_inne
                        ,sum(decode(location_seq_no,null,1))    as deler_solgt 
                    from t 
                    where 1=1
                        and vare_gruppe_seq_no <>1
                    group by bil, vare_gruppe_id
                    order by bil, vare_gruppe_id
                /

                --på lager
                    select 
                        bil
                        ,vare_gruppe_id 
                        ,count(*)
                    from t
                    where location_seq_no is not null
                        and vare_gruppe_seq_no >1
                    group by bil, vare_gruppe_id
                    order by bil, vare_gruppe_id

                --alt
                create or replace view v_plukk_alt as
                    select 
                        bil
                        ,vare_gruppe_id 
                        ,count(*)
                    from t
                    where 1=1
                        and vare_gruppe_seq_no >1
                    group by bil, vare_gruppe_id
                    order by bil, vare_gruppe_id      

                --slå samme solgt og på lager
                create or replace view t_plukk_driver
                    select *

                    from  v_plukk_alt       ---absolutt alle 
                          t_plukk_solgt
                          v_plukk_paa_lager
                    where 1=1
                    and v_plukk_alt.var_bil_seq_no = t_plukk_solgt.var_bil_seq_no    (+)

    --NBNB dette er utrekk fra gamle ora ola/nei i msqery
        select 
             enhet_seq_no
            ,p_enhet_seq_no
            ,p_serie_seq_no
            ,var_bil_seq_no
            ,vare_gruppe_seq_no
            ,vare_gruppe_id
            ,vrak
            ,scope
            ,fab_navn
            ,type_id
            ,pris_inkl_mva
            ,pris_solgt_inkl_mva
        from ola.t_enhet3 t_enhet3
        where (t_enhet3.fab_navn='nissan') and (t_enhet3.type_id='navara d40') 
        and (t_enhet3.vare_gruppe_seq_no>1)     --for å skille ut deler og vrak (vare_gruppe_seq_no =1  er vrak, alt over er deler)

        SELECT T_ENHET3.P_ENHET_SEQ_NO, T_ENHET3.ENHET_SEQ_NO, T_ENHET3.P_SERIE_SEQ_NO, T_ENHET3.VAR_BIL_SEQ_NO, T_ENHET3.P_SERIE_NO, T_ENHET3.LOCATION_SEQ_NO, T_ENHET3.P_VAR_BIL_SEQ_NO, T_ENHET3.VARE_GRUPPE_SEQ_NO, T_ENHET3.VARE_GRUPPE_ID, T_ENHET3.VRAK, T_ENHET3.SCOPE, T_ENHET3.FAB_NAVN, T_ENHET3.TYPE_ID, T_ENHET3.PRIS_INKL_MVA, T_ENHET3.PRIS_SOLGT_INKL_MVA
        FROM OLA.T_ENHET3 T_ENHET3
        WHERE (T_ENHET3.VAR_BIL_SEQ_NO='104565') AND (T_ENHET3.VARE_GRUPPE_SEQ_NO>1) OR (T_ENHET3.VAR_BIL_SEQ_NO='104564') OR (T_ENHET3.VAR_BIL_SEQ_NO='104565') AND (T_ENHET3.VARE_GRUPPE_SEQ_NO>1) OR (T_ENHET3.VAR_BIL_SEQ_NO='104564') AND (T_ENHET3.VARE_GRUPPE_SEQ_NO>1) OR (T_ENHET3.VAR_BIL_SEQ_NO='104566') AND (T_ENHET3.VARE_GRUPPE_SEQ_NO>1)

    1)  Finne alle der fra 1 bil:
            select
                enhet_seq_no
                ,p_enhet_seq_no         --deler på huggelapp
                ,p_serie_seq_no
                ,var_bil_seq_no         --Modell/Type/År kombinasjon (Unikt)
                ,vare_gruppe_seq_no
                ,vare_gruppe_id
                ,vrak_nr
                ,bil_obas
                ,scope
                ,fab_navn
                ,modell
                ,km
                ,karosseriform
                ,motor
                ,pris
            from t_enhet3
            where 1=1
            and p_enhet_seq_no=350503
        order by vare_gruppe_id

    2)  Gamle koden fra App 8 (P627: Plukke_ver2)
        select
            NULL              del_link,
            NULL              new_link,
            seq_id,                                         --Text Field, Select List eller Hidden altå etiterbare
            seq_id            seq_id_display,
            -----------------------------------------
                        c001           spacer,              --NB ikke edit på denne
            to_number(c002)          del_seq_no,            --Text Field, Select List eller Hidden altå etiterbare
            to_number(c003)          enhet_seq_no,          --Text Field, Select List eller Hidden altå etiterbare
            to_number(c004)          vare_gruppe_seq_no,
                        c005           to_do,               --Text Field, Select List eller Hidden altå etiterbare
            to_number(c006)          pris,                  --Text Field, Select List eller Hidden altå etiterbare
                        c007           besk,                --Text Field, Select List eller Hidden altå etiterbare
                        c008           merk,                --Text Field, Select List eller Hidden altå etiterbare
            --------------slutt collection som gjøres noe med --------------
            -- ant_på lager to_number(c013)
        case when nvl(to_number(c013),0) >0 and to_number(c009) is not null and to_number(c004) is not null  then
                            ' <a href="f?p='||:APP_ID||':703:'||:APP_SESSION||':UPD:NO::'
                                || 'P703_VAR_BIL_SEQ_NO,P703_VARE_GRUPPE_SEQ_NO,P703_PK_INFO'||':'
                                ||  to_number(c009)||','||to_number(c004)||','||c010||'">'||
                                '<i class="fa fa-usd" aria-hidden="true" title="Prise" style="color:green"></i>'||
                            '</a>'
        end as prise,
            to_number(c009)     var_bil_seq_no,
                        c010    vare_gruppe_id,
                        c011    status_color,
                        c012    status,
            to_number(c013)     ant_p_lager,
            to_number(c014)     ant_solgt,
            to_number(c015)     ant_plukk,
            to_number(c016)     ant_tot,
                        c017    max,
                        c018    min,
                        c019    max_solgt,
                        c020    min_solgt,
            to_number(c021)     nbf_ant,
                        c022    nbf_max,
                        c023    nbf_min,
            to_number(c024)     lbk_ant,
                        c025    lbk_max,
                        c026    lbk_min
        from apex_collections
        where collection_name = 'P627_PLUKK_COLL'




----------------------------------------------------------- v_pris_org ------------------------------------------------------------------------------------------
    --drop view v_pris_org;
    create or replace view v_pris_org as
    select 
    /*      Brukes APEX 
    Dato      Endring
    ===         =======        
    2010_05_09  laget
    */   
    round(sysdate - org_dato_inn,0)  as ant_dager,
        (select decode(round(sysdate - org_dato_inn,0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual) as faktor,
               org_pris_inkl_mva,
         org_pris_inkl_mva*
        (select decode(round(sysdate - org_dato_inn,0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual) as calc_pris_inkl_mva,
         enhet.pris_inkl_mva as virk_pris_inkl_mva,
         org_pris_inkl_mva*
        (select decode(round(sysdate - org_dato_inn,0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual)- enhet.pris_inkl_mva as diff,
      vare_gruppe_id  as vare_gruppe_id,
      serie_no  as serie_no,       
      loc_id    as loc_id,
      fab_navn||' '||type_id||' '||to_char(aar,'yyyy') as bil
    from   enhet, 
      v_enhet_vis
    where enhet.enhet_seq_no = v_enhet_vis.enhet_seq_no  
    and  org_dato_inn >= to_date('2010_04_30','yyyy_mm_dd') 
    and    org_dato_inn is not null and org_pris_inkl_mva is not null
    order by 1
    /
    grant select on v_pris_org to public
    /
    
    --drop view v_pris_avvik;
    create or replace view v_pris_avvik as
    select distinct
    /*      Brukes APEX 
    Dato      Endring
    ===         =======        
    2010_05_09  laget
    */   
    enhet.enhet_seq_no,
    enhet.org_dato_inn,
    enhet.dato_inn,
    round(sysdate - nvl(enhet.dato_inn,sysdate),0)  as ant_dager,
        (select decode(round(sysdate - nvl(enhet.dato_inn,sysdate),0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual) as faktor,
               org_pris_inkl_mva,
         org_pris_inkl_mva*
        (select decode(round(sysdate - nvl(enhet.dato_inn,sysdate),0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual) as calc_pris_inkl_mva,
         enhet.pris_inkl_mva as virk_pris_inkl_mva,
         org_pris_inkl_mva*
        (select decode(round(sysdate - nvl(enhet.dato_inn,sysdate),0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
                           8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
                          15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
                          1)
               from dual)- enhet.pris_inkl_mva as diff,
      vare_gruppe_id  as vare_gruppe_id,
      v_enhet_vis.old_serie_no,
      serie_no  as serie_no,       
      loc_id    as loc_id,
      fab_navn||' '||type_id||' '||to_char(aar,'yyyy') as bil
    from   enhet, 
      v_enhet_vis
    where enhet.enhet_seq_no = v_enhet_vis.enhet_seq_no  
    and  org_dato_inn >= to_date('2010_04_30','yyyy_mm_dd') 
    and org_pris_inkl_mva is not null
    --and    org_dato_inn is not null 
    --and       org_pris_inkl_mva*
    --    (select decode(round(sysdate - nvl(enhet.dato_inn,sysdate),0),0,1.3,  1,1.3,  2,1.3,  3,1.3,  4,1.3,  5,1.3,  6,1.3,  7,1.3,
    --                       8,1.2,  9,1.2, 10,1.2, 11,1.2, 12,1.2, 13,1.2, 14,1.2, 
    --                      15,1.1, 16,1.1, 17,1.1, 18,1.1, 19,1.1, 20,1.1, 21,1.1,
    --                      1)
    --           from dual)- enhet.pris_inkl_mva <>0 
    -- diff
    order by 4,org_dato_inn desc
    /
    grant select on v_pris_avvik to public
    /
    
    --drop view v_pris;
    create or replace view v_pris as
    select 
    /*      Brukes APEX 
    Dato      Endring
    ===         =======        
    2010_04_09  laget
    */   
    vare_gruppe_seq_no      as vare_gruppe_seq_no,
    var_bil_seq_no        as var_bil_seq_no,
     VARE_GRUPPE_ID        as VARE_GRUPPE_ID,
     FAB_NAVN                         as FAB_NAVN,
     TYPE_ID                          as TYPE_ID,
     aar          as aar,
    max (pris_inkl_mva)      as max_pris,
    min (pris_inkl_mva)      as min_pris,
    count(*)        as totalt_antall
    from   v_enhet_pris_full   
    where pris_inkl_mva is not null         
    group by vare_gruppe_seq_no,var_bil_seq_no, VARE_GRUPPE_ID,FAB_NAVN,TYPE_ID,aar
    order by                                    VARE_GRUPPE_ID,FAB_NAVN,TYPE_ID,aar
    /
    grant select on v_pris to public
    /
    
    
    --drop view v_pris_vare_gruppe;
    create or replace view v_pris_vare_gruppe as
    select 
    /*      Brukes APEX 
    Dato      Endring
    ===         =======        
    2010_04_09  laget
    */   
    vare_gruppe_seq_no      as vare_gruppe_seq_no,
     VARE_GRUPPE_ID        as VARE_GRUPPE_ID,
    max (pris_inkl_mva)      as max_pris,
    min (pris_inkl_mva)      as min_pris,
    count(*)        as totalt_antall
    from   v_enhet_pris_full   
    where pris_inkl_mva is not null         
    group by vare_gruppe_seq_no,VARE_GRUPPE_ID
    order by                    VARE_GRUPPE_ID
    /
    grant select on v_pris_vare_gruppe to public
    /
    
    1  Deler  56950  21256  35694
    2  Vrak  11739  329  11410
    3  Bilder totalt  33110  15022  18088
    4  Bilder av deler på lager  14564    
    5  Bilder av vrak  4489  458  4031
    6  Priset  1737  1646  91
    
    
    
    
    
    create or replace view v_statistikk as
    select 
    /*      Brukes APEX 
    Dato      Endring
    ===         =======        
    2010_04_09  laget
    */   
      driver.seq_no                        as seq_no,
      decode(driver.seq_no,1,'Deler',
                           2,'Vrak',
                           3,'Bilder totalt',
                           4,'Bilder av deler på lager',
                           5,'Bilder av vrak',
                           6,'Priset deler',
                           7,'SMS',
                           8,'Varsling til kunde'
                           )                  as type,  
      t1_deler.c1||t1_vrak.c1||t1_bilder.c1||t1_bilder_dpa.c1||t1_bilder_v.c1||t1_pris.c1||t1_sms.c1||t1_varsling.c1  as total,
      t2_deler.c2||t2_vrak.c2||t2_bilder.c2                  ||t2_bilder_v.c2||t2_pris.c2||t2_sms.c2||t2_varsling.c2  as paa_lager,
      t3_deler.c3||t3_vrak.c3||t3_bilder.c3                  ||t3_bilder_v.c3||t3_pris.c3        as solgt
    from   
      (select rownum as seq_no
      from enhet
      where rownum <9)  driver,
      ----------------------DELER----------------------------------------
      (select 1      as seq_no, 
             count(*)      as c1
       from enhet
       where vare_gruppe_seq_no !=1)       t1_deler,
      (select 1      as seq_no, 
             count(*)      as c2
       from enhet
       where vare_gruppe_seq_no !=1
       and location_seq_no is not null)     t2_deler,
      (select 1      as seq_no, 
             count(*)      as c3
       from enhet
       where vare_gruppe_seq_no !=1
       and location_seq_no is  null)         t3_deler,
      ----------------------VRAK----------------------------------------
      (select 2      as seq_no, 
             count(*)      as c1
       from enhet
       where vare_gruppe_seq_no =1)       t1_vrak,
      (select 2      as seq_no, 
             count(*)      as c2
       from enhet
       where vare_gruppe_seq_no =1
       and location_seq_no is not null)     t2_vrak,
      (select 2      as seq_no, 
             count(*)      as c3
       from enhet
       where vare_gruppe_seq_no =1
       and location_seq_no is  null)         t3_vrak,
      ----------------------BILDER----------------------------------------
      (select 3      as seq_no, 
             count(*)      as c1
       from enhet,
            enhet_blobs  
      where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no)  t1_bilder,
      (select 3      as seq_no, 
             count(*)      as c2
       from enhet,
            enhet_blobs
       where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
       and location_seq_no is not null)       t2_bilder,
      (select 3      as seq_no, 
             count(*)      as c3
       from enhet,
            enhet_blobs
       where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
       and location_seq_no is  null)           t3_bilder,
      ----------------------BILDER AV DELER PÅ LAGER--------------------------------
      (select 4      as seq_no, 
             count(*)      as c1
       from enhet,
            enhet_blobs  
      where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
      and vare_gruppe_seq_no !=1
       and location_seq_no is not null)      t1_bilder_dpa,
      ----------------------BILDER AV VRAK------------------------------------------
      (select 5      as seq_no, 
             count(*)      as c1
       from enhet,
            enhet_blobs  
      where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
      and vare_gruppe_seq_no =1)        t1_bilder_v,
      (select 5      as seq_no, 
             count(*)      as c2
       from enhet,
            enhet_blobs
       where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
       and vare_gruppe_seq_no =1
       and location_seq_no is not null)       t2_bilder_v,
      (select 5      as seq_no, 
             count(*)      as c3
       from enhet,
            enhet_blobs
       where enhet.enhet_seq_no = enhet_blobs.enhet_seq_no
       and vare_gruppe_seq_no =1
       and location_seq_no is  null)           t3_bilder_v,
      ----------------------PRIS----------------------------------------
      (select 6      as seq_no, 
             count(*)      as c1
       from enhet
       where pris_inkl_mva is not null)     t1_pris,
      (select 6      as seq_no, 
             count(*)      as c2
       from enhet
       where pris_inkl_mva is not null
       and location_seq_no is not null)     t2_pris,
      (select 6      as seq_no, 
             count(*)      as c3
       from enhet
       where pris_inkl_mva is not null
       and location_seq_no is  null)         t3_pris,
      ----------------------SMS----------------------------------------
      (select 7      as seq_no, 
             count(*)||' sendte'    as c1
       from query
       where dest='SMS'
       and return_value='OK')           t1_sms,
      (select 7      as seq_no, 
             count(*)||' feil'    as c2
       from query
       where dest='SMS'
       and return_value='FAIL')         t2_sms,
      ----------------------SMS----------------------------------------
      (select 8      as seq_no, 
             count(*)||' registrerte'  as c1
       from query
       where dest='SMS'
       and vare_gruppe_seq_no is not null)       t1_varsling,
      (select 8      as seq_no, 
             count(*)||' bekreftet på lager'as c2
       from query
       where dest='SMS'
       and vare_gruppe_seq_no is not null
       and date_out is not null)         t2_varsling
    ----------------------DELER------------------------------------------
    where driver.seq_no = t1_deler.seq_no   (+)
    and   driver.seq_no = t2_deler.seq_no   (+)  
    and   driver.seq_no = t3_deler.seq_no   (+)  
    ----------------------VRAK--------------------------------------------
    and   driver.seq_no = t1_vrak.seq_no   (+)
    and   driver.seq_no = t2_vrak.seq_no   (+)  
    and   driver.seq_no = t3_vrak.seq_no   (+)  
    ----------------------BILDER------------------------------------------
    and   driver.seq_no = t1_bilder.seq_no   (+)
    and   driver.seq_no = t2_bilder.seq_no   (+)  
    and   driver.seq_no = t3_bilder.seq_no   (+)  
    ----------------------BILDER AV DELER PÅ LAGER------------------------
    and   driver.seq_no = t1_bilder_dpa.seq_no   (+)
    ----------------------BILDER AV VRAK-----------------------------------
    and   driver.seq_no = t1_bilder_v.seq_no   (+)
    and   driver.seq_no = t2_bilder_v.seq_no   (+)  
    and   driver.seq_no = t3_bilder_v.seq_no   (+)  
    ----------------------PRIS--------------------------------------------
    and   driver.seq_no = t1_pris.seq_no   (+)
    and   driver.seq_no = t2_pris.seq_no   (+)  
    and   driver.seq_no = t3_pris.seq_no   (+)  
    ----------------------SMS--------------------------------------------
    and   driver.seq_no = t1_sms.seq_no   (+)
    and   driver.seq_no = t2_sms.seq_no   (+)  
    ----------------------VARSLING--------------------------------------------
    and   driver.seq_no = t1_varsling.seq_no   (+)
    and   driver.seq_no = t2_varsling.seq_no   (+)  
    /
    
    
    
    
    --drop view v_sms_receive;
    create or replace view v_sms_receive as
    select 
    /*      Brukes av PB og APEX som dropdown /LOV
    Dato      Endring
    ===         =======        
    2010_04_04  laget
    */   
    SMS_RECEIVE_SEQ_NO  as SMS_RECEIVE_SEQ_NO,       
    COMPANY             as COMPANY,
    NAME                as NAME,
    MOBIL_NO            as MOBIL_NO,
    REMARK              as REMARK,
    SMS_RECEIVE_DATE    as SMS_RECEIVE_DATE,
    company||' > '||name  as receiver
    from   util.sms_receive
    where company in ('OBAS','VARSLING')
    order by name
    /
    grant select on v_sms_receive to public
    /
    
----------------------------------------------------------- v_querry ------------------------------------------------------------------------------------------
    create or replace view v_query as
    select 
    /*      Brukes av PB og APEX som dropdown /LOV
    Dato        Endring
    ===         =======        
    2010_04_04  laget
    2012_03_01  bytter ut srbilno med ekstern.v_nbf_bildel
    */   
    query_seq_no                          as query_seq_no,       
    query.date_in                         as date_in,
    date_out                              as date_out,
    keep_days                             as keep_days,
    message                               as message,
    query.mobile_no                       as mobile_no,
    v_sms_receive.receiver                as receiver,
    return_value                          as return_value,
    query.vare_gruppe_seq_no              as vare_gruppe_seq_no,
    vare_gruppe.vare_gruppe_id            as vare_gruppe_id,
    query.sbrnr                           as sbrnr,
    nbf_bilkod.bilkodnamnnorge            as nbf_namn,
    dest                                  AS dest
    from  query,       
          vare_gruppe,
          v_nbf_bilkod  nbf_bilkod,
          v_sms_receive
    where query.vare_gruppe_seq_no   = vare_gruppe.vare_gruppe_seq_no   (+)
    and   query.sbrnr                = nbf_bilkod.bilkod                (+)
    and   query.mobile_no            = v_sms_receive.mobil_no           (+)
    order by date_in desc
    /
    grant select on v_query to public
    /
    
    select count(*) from v_query;
    #5216 2012_03_01 før
    #9343 2015_11_23
    
    --Ulf ville ha vekk 2020-10-25
        update query set keep_days=1 where query_seq_no=113404;

    
----------------------------------------------------------- v_enhet_ekstern ------------------------------------------------------------------------------------------
    --GRANT CREATE ANY VIEW     TO OLA;
    --drop view v_enhet_ekstern;
    create or replace view v_enhet_ekstern as
        select /*+ ordered   */
            /*      Brukes av PB i datavindu: dw_master hvor aktuelle datavindu settes i menylinjen
                    datavinduobjekt: d_bil_m_enhet
                    v_fx: mapping OBV LBK
              Merk at vi hardkoder inn at loc_id is not null
              Dato    Endring
              ===       =======        
              2009-01-04  Laget på bakgrunn av v_enhet_master
              2010-05-02  lagt inn reg_no
              2016-07-21  lagt inn loc_id og chassiss_no vegdir via regno ifbm innføring av vraknr på hentebiler
              2020-07-01  lagt inn location_Seq_no
              2021-01-25  byttet ut til v_enhet_master -> v_enhet_master_lynet
            */                 
          enhet_ekstern.enhet_ekstern_seq_no                                            as enhet_ekstern_seq_no,
          enhet_ekstern.enhet_seq_no                                                    as enhet_seq_no,
          t2.loc_id                                                                     as loc_id,   
          t2.location_seq_no                                                            as location_seq_no,   
          t2.chassis_no_vegdir                                                          as chassis_no_vegdir,
          enhet_ekstern.vegdir_info                                                     as vegdir_info,
          /*
          decode(t2.vare_gruppe_id,'VRAK','',t2.vare_gruppe_id||' ')||
          decode (enhet_ekstern.enhet_seq_no,null,null,
                  decode(t2.loc_id,'V_EKSTERN','',null,'hogget'||' ',t2.loc_id||' ')
                 ) 
          ||nvl(t2.serie_no,'Vrak ikke registrert enda')      
          ||' '||var_bil||' '||t2.betegnelse||' '||t2.reg_no                            as enhet_lookup,
          */
              t2.serie_no                                                               as enhet_lookup,
              enhet_ekstern.reg_no                                                      as reg_no,
              enhet_ekstern.merknad                                                     as merknad,
              enhet_ekstern.kunde                                                       as kunde,
              enhet_ekstern.bil_merke                                                   as bil_merke,
              enhet_ekstern.bet_kr                                                      as bet_kr,
              enhet_ekstern.staar_hos_adr                                               as staar_hos_adr,
              enhet_ekstern.tlf_nr                                                      as tlf_nr,
              enhet_ekstern.mottatt_av                                                  as mottatt_av,
              enhet_ekstern.planlagt_hentet                                             as planlagt_hentet,
              enhet_ekstern.hentet_dato                                                 as hentet_dato,
              enhet_ekstern.papirer_ok                                                  as papirer_ok,
              enhet_ekstern.trillbar                                                    as trillbar,
              enhet_ekstern.date_in                                                     as date_in   
        from   enhet_ekstern     enhet_ekstern,
               v_enhet_master_lynet    t2
        where  enhet_ekstern.enhet_seq_no = t2.enhet_seq_no  (+)
        /
        
    grant select on v_enhet_ekstern to public;
    /

        select count(*) from v_enhet_ekstern where loc_id='V_EKSTERN';
        --13
        --20    2020-09-07

    create or replace view v_enhet_driver as
    select 
      /*
          --//driver tabell NIVÅ 2
          ------------------------
          --#55418  stemmer med select count(*) from enhet # 55418
    */
            enhet_pakket.enhet_seq_no       as enhet_seq_no,
            enhet_pakket.vare_gruppe_seq_no       as vare_gruppe_seq_no,
            enhet_pakket.var_bil_seq_no       as var_bil_seq_no,
            enhet_pakket.location_seq_no        as location_seq_no,
            enhet_pakket.dato_inn         as dato_inn,
            enhet_pakket.dato_ut          as dato_ut,
            vare_gruppe.vare_gruppe_id        as vare_gruppe_id,
            fabrikant.fab_navn          as fab_navn,
            type.type_id            as type_id,
            xbnavn.type           as lbk_type
          from  (
            --//driver tabell NIVÅ 1
            ------------------------
            select  chl.enhet_seq_no        as enhet_seq_no,
              chl.vare_gruppe_seq_no        as vare_gruppe_seq_no,
              nvl(chl.var_bil_seq_no,par.var_bil_seq_no)  as var_bil_seq_no,
              chl.location_seq_no       as location_seq_no,
              chl.dato_inn          as dato_inn,
              chl.dato_ut         as dato_ut
            from  enhet par,
              enhet chl
            where chl.prev_enhet_seq_no = par.enhet_seq_no    (+)
            ) enhet_pakket,
            vare_gruppe vare_gruppe,
            var_bil   var_bil,
            fabrikant   fabrikant,
            type    type,
            v_map_bil   map_bil,
            --23.11.2016 grant all on lbk_xbnavn to public
            ekstern.lbk_xbnavn xbnavn
          where enhet_pakket.var_bil_seq_no = var_bil.var_bil_seq_no        (+)
          and   enhet_pakket.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no(+)
          and   var_bil.fab_seq_no    = fabrikant.fab_seq_no    (+)
          and   var_bil.type_seq_no   = type.type_seq_no    (+)
          and   var_bil.var_bil_seq_no    = map_bil.var_bil_seq_no  (+)  --ikke alle deler har biltype på seg
          and   map_bil.lbknr     = xbnavn.lbknr      (+) 
    /     
    
    drop table enhet_driver;
    create table enhet_driver(
    ENHET_SEQ_NO                                   NUMBER(8) NOT NULL ,
    VARE_GRUPPE_SEQ_NO                                 NUMBER(8),
    VAR_BIL_SEQ_NO                                     NUMBER,
    LOCATION_SEQ_NO                                    NUMBER(8),
    DATO_INN                                           DATE,
    DATO_UT                                            DATE,
    VARE_GRUPPE_ID                                     VARCHAR2(30),
    FAB_NAVN                                           VARCHAR2(30),
    TYPE_ID                                            VARCHAR2(30),
    LBK_TYPE                                           VARCHAR2(22),
        constraint enhet_driver_p1 primary key (enhet_SEQ_NO)
    );
    
    select enhet_seq_no,count(*) from v_enhet_driver group by enhet_seq_no having count(*)>1;
    truncate table enhet_driver;
    insert into enhet_driver select * from v_enhet_driver where enhet_seq_no not in (78705,78507,78698,78704,78702,86632);
    
    før 2010_09_10 57974
    etter 71169
    
    
    
    
    --slettet  ,  var borte vekk i basen 2012_03_10 i hvertfall
    --drop view v_enhet_ant;
    --rekrert 2016-01-21 før Ullensvang julebord
    create or replace view v_enhet_ant as
        with driver as 
          (select distinct  swb_seq_no,  
    select  -- utdrag
      tot.vare_gruppe_id                as vare_gruppe_id,
      tot.fab_navn                      as fab_navn,
      tot.type_id                       as type_id,
      tot.lbk_type                      as lbk_type,
      tot.ant_tot                       as ant_tot,
      solgt.ant_solgt                   as ant_solgt,
      tot.ant_tot-solgt.ant_solgt       as ant_paa_lager,
      dg_90.ant_0_90dg                  as ant_0_90dg,
      dg_365.ant_91_365dg               as ant_91_365dg,
      dg_365_.ant_365dg_                as ant_365dg_
    from   (select
        enhet_driver.vare_gruppe_id   as vare_gruppe_id,
        enhet_driver.fab_navn         as fab_navn,
        enhet_driver.type_id          as type_id,
        enhet_driver.lbk_type         as lbk_type,
        count(*)                      as ant_tot
       from enhet_driver
       group by enhet_driver.vare_gruppe_id,enhet_driver.fab_navn,enhet_driver.type_id,enhet_driver.lbk_type
      )  tot,
      (select
        enhet_driver.vare_gruppe_id   as vare_gruppe_id,
        enhet_driver.fab_navn         as fab_navn,
        enhet_driver.type_id          as type_id,
        enhet_driver.lbk_type         as lbk_type,
        count(*)                      as ant_solgt
       from enhet_driver
       where location_seq_no is null  
       group by enhet_driver.vare_gruppe_id,enhet_driver.fab_navn,enhet_driver.type_id,enhet_driver.lbk_type
      )  solgt,
      (select
        enhet_driver.vare_gruppe_id   as vare_gruppe_id,
        enhet_driver.fab_navn         as fab_navn,
        enhet_driver.type_id          as type_id,
        enhet_driver.lbk_type         as lbk_type,
        count(*)                      as ant_0_90dg
       from enhet_driver
       where location_seq_no is not null  
       --http://www.adp-gmbh.ch/ora/sql/round.html
       and sysdate-dato_inn <91
       group by enhet_driver.vare_gruppe_id,enhet_driver.fab_navn,enhet_driver.type_id,enhet_driver.lbk_type
      )  dg_90,
      (select
        enhet_driver.vare_gruppe_id   as vare_gruppe_id,
        enhet_driver.fab_navn         as fab_navn,
        enhet_driver.type_id          as type_id,
        enhet_driver.lbk_type         as lbk_type,
        count(*)                      as ant_91_365dg
       from enhet_driver
       where location_seq_no is not null  
       --http://www.adp-gmbh.ch/ora/sql/round.html
       and sysdate-dato_inn <366
       and sysdate-dato_inn >90
       group by enhet_driver.vare_gruppe_id,enhet_driver.fab_navn,enhet_driver.type_id,enhet_driver.lbk_type
      )  dg_365,
      (select
        enhet_driver.vare_gruppe_id   as vare_gruppe_id,
        enhet_driver.fab_navn         as fab_navn,
        enhet_driver.type_id          as type_id,
        enhet_driver.lbk_type         as lbk_type,
        count(*)                      as ant_365dg_
       from enhet_driver
       where location_seq_no is not null  
       --http://www.adp-gmbh.ch/ora/sql/round.html
       and sysdate-dato_inn >365
       group by enhet_driver.vare_gruppe_id,enhet_driver.fab_navn,enhet_driver.type_id,enhet_driver.lbk_type
      )  dg_365_
    where 
    --solgte  INNER join driter i de 6 delne som ikke har bil info på seg seg
      tot.vare_gruppe_id  = solgt.vare_gruppe_id    (+)      
    and  tot.fab_navn    = solgt.fab_navn           (+)
    and  tot.type_id    = solgt.type_id             (+)
    and  nvl(tot.lbk_type,'x')  = nvl(solgt.lbk_type(+),'x')    -- ref kan være tom
    --90dg
    and  tot.vare_gruppe_id  = dg_90.vare_gruppe_id (+)
    and  tot.fab_navn    = dg_90.fab_navn           (+)
    and  tot.type_id    = dg_90.type_id             (+)
    and  nvl(tot.lbk_type,'x')  = nvl(dg_90.lbk_type(+),'x')   -- ref kan være tom
    --365dg
    and  tot.vare_gruppe_id  = dg_365.vare_gruppe_id  (+)
    and  tot.fab_navn    = dg_365.fab_navn            (+)
    and  tot.type_id    = dg_365.type_id              (+)
    and  nvl(tot.lbk_type,'x')  = nvl(dg_365.lbk_type (+),'x')   -- ref kan være tom
    --365dg og opp
    and  tot.vare_gruppe_id  = dg_365_.vare_gruppe_id   (+)
    and  tot.fab_navn    = dg_365_.fab_navn             (+)
    and  tot.type_id    = dg_365_.type_id               (+)
    and  nvl(tot.lbk_type,'x')  = nvl(dg_365_.lbk_type  (+),'x') -- ref kan være tom
    order by tot.vare_gruppe_id, tot.fab_navn, tot.type_id, tot.lbk_type
  /
    
    --APEX utdrag 
    select   v_enhet_ant.vare_gruppe_id,
       v_enhet_ant.fab_navn,
       v_enhet_ant.type_id,
       v_enhet_ant.lbk_type,
       v_enhet_ant.ant_tot,
       v_enhet_ant.ant_solgt,
       v_enhet_ant.ant_paa_lager,
       v_enhet_ant.ant_0_90dg,
       v_enhet_ant.ant_91_365dg,
       v_enhet_ant.ant_365dg_
    from ola.v_enhet_ant v_enhet_ant
    where (v_enhet_ant.vare_gruppe_id<>'VRAK')
    order by nvl(v_enhet_ant.ant_solgt,0) desc, v_enhet_ant.vare_gruppe_id,v_enhet_ant.lbk_type
    
    
----------------------------------------------------------- v_vare_gruppe_var_bil ------------------------------------------------------------------------------------------
    2012_03_03 slettet,, men ble brukt i StockOnNet ---> eksporten gikk i dass helt til 19.3.2012
    --drop view v_vare_gruppe_var_bil;
    create or replace view v_vare_gruppe_var_bil as
    select
    /*
      flytter hele driten til t_enhet_full
      før 10148  obas 6.9.08  10148
      nå 
      nå  
      Dato          Endring
      ===        =======
      2008_03_3 laget 
      */
    DISTINCT
      fab_navn    as fab_navn,          
      type_id      as type_id,             
      vare_gruppe_id    as vare_gruppe_id,   
         to_char(count(*))   as ant                  
    FROM   ola.t_enhet_full
    --pga BAKLYKT, V HOLD SPEIL, V  ikke har noen fab_navn, type_id
    where   fab_navn is not null 
    and   type_id is not null 
    and   vare_gruppe_id is not null
    and loc_id is not null
    GROUP BY fab_navn, type_id,vare_gruppe_id                                                                                                
    order BY fab_navn, type_id,vare_gruppe_id                                                                                                
    /
    select count(*) from v_vare_gruppe_var_bil;
    
    select fab_navn,type_id, vare_gruppe_id from v_test
    minus
    select fab_navn,type_id, vare_gruppe_id from v_vare_gruppe_var_bil;
    
    obas  13962  10234
    alt  13826  10143 (kun på lager
    37500   11480  feil
    36500  11341  feil
    36000  11223  feil
    35800  11187  feil
    35700  11179  feil
    35675  11178  feil
    35660  11175  feil
    35659  11174  feil
    35658  11173  ok
    35657  11173  ok
    35655  11173  ok
    35650  11172  ok
    35600   11165  ok
    35500  11155  ok
    
----------------------------------------------------------- v_enhet_pris_full + årene 2014 - >> ------------------------------------------------------------------------------------------
        --drop view v_enhet_pris_full;
        --dummy view i APEX
        -------------------
    create or replace view v_enhet_pris_full as
        select   enhet_seq_no as enhet_seq_no,
          dato_inn     as dato_inn,
          dato_ut      as dato_ut,
                2       as calc_pris_netto 
        from enhet
        /
    
        ================ APEX problemer med LF i beskrivelse feltene
        select count(*)
        from enhet
        --hex 0A, desc 10 er LF
        where instr(enhet_besk,chr(10))>0
        /
        #6563
    
        select count(*)
        from enhet
        --hex 09, desc p er HT (tab)
        where instr(enhet_besk,chr(9))>0
        /
        #0    
        set linesize 3000
        select enhet_seq_no, translate (enhet_besk,chr(10), ' ')
        from enhet
        --hex 0A, desc 10 er LF
        where instr(enhet_besk,chr(10))>0
        and rownum <10
        /
    
        translate (string, search-characters, replace-characters)
    
    create or replace view v_enhet_pris_full as
        select 
          /*  sjekk på logikk
          truncate table t_enhet_full
          insert into t_enhet_full select * from v_enhet_full
          2012_01_30 #81 648
          select '31_12_2007',*
          from    ola.v_enhet_pris_full     t1
          where    t1.dato_inn             <  to_date('01_01_2008','dd_mm_yyyy')
          and    nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))   >  to_date('01_01_2008','dd_mm_yyyy')
          and  calc_pris_netto >0
          order by prev_enhet_seq_no,serie_no
          1 586 336 inkl 1500
          1 067 881 exkl 1500
          Dato          Endring
          ===        =======
          2008_03_03 laget 
          2010_01_26 fikset til og fra uttrekk
          2010_02_02 tatt vekk Carriage Return 0Dhex 13des og LineFeed  0Ahex 10 desci beskrivelse feltene
          2012_01_30 lagt inn på nytt
          2013_01_12 byttet t_enhet_full ut med v_enhet2
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no
        from   v_enhet_pris  t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        /
        grant select on ola.v_enhet_pris_full to public
        /
    
        select count(*) from v_enhet_pris_full;
        89897    --2013_01_13 med t_enhet_full
    
        select count(*) from t_enhet_full;
        select count(*) from v_enhet2;
    
    
    create or replace view v_enhet_pris_full2 as
        select 
          /*  
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris2 t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        union
        select 
          /*  
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'j'                                                               as karroseribyttebil              
        from   v_enhet_pris2_k_bytte t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        /
        grant select on ola.v_enhet_pris_full2 to public
        /
    
    create or replace view v_enhet_pris_full_2014 as
        select 
          /*  
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          2015_01_14 vrakpant 3000
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris_2014 t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        union
        select 
          /*  
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'j'                                                               as karroseribyttebil              
        from   v_enhet_pris_k_bytte_2014 t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        /
        grant select on ola.v_enhet_pris_full_2014 to public
        /
    
    create or replace view v_enhet_pris_full_2015 as
        select 
          /*  
          2015_01_06 kopi v_enhet_pris_full_2014
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris_2015 t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        union
        select 
          /*  
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no                    as enhet_seq_no,
          t1.prev_enhet_seq_no              as prev_enhet_seq_no,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  translate (
          translate (
                  translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
          t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
          t2.vare_gruppe_id                as vare_gruppe_id,
          t1.location_seq_no               as location_seq_no,
          t2.loc_id                        as loc_id,
          decode(t2.loc_id,null,'0',1)     as loc_id_01,
          t1.serie_seq_no                  as serie_seq_no,
          t2.serie_no                      as serie_no,
          t1.dato_inn                      as dato_inn,
          t1.dato_ut                       as dato_ut,
          t1.pris_inkl_mva                 as pris_inkl_mva,
          t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
          t1.pris_4021                     as pris_4021,
          t1.pris_netto                    as pris_netto,
          t1.a_pris_4021_vrak              as a_pris_4021_vrak,
          t1.a_pris_netto_vrak             as a_pris_netto_vrak,
          t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
          t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
          t1.b_pris_4021_vrak              as b_pris_4021_vrak,
          t1.b_pris_netto_vrak             as b_pris_netto_vrak,
          t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
          t1.wof                           as wof,
          t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
          t1.calc_pris_netto               as calc_pris_netto,
          --resten av kolonnene fra t_enhet_full
          --------------------------------------
          t2.enhet_kval_seq_no             as enhet_kval_seq_no,
          t2.kval_id                       as kval_id,
          t2.hold_on                       as hold_on,
          t2.var_bil_seq_no                as var_bil_seq_no,
          t2.fab_navn                      as fab_navn,
          t2.type_id                       as type_id,
          t2.aar                           as aar,
          t2.motor_type_id                 as motor_type_id,
          t2.motor_type_besk               as motor_type_besk,
          t2.motor_vol_id                  as motor_vol_id,
          t2.dorer_id                      as dorer_id,
          t2.k_grp_id                      as k_grp_id,
          t2.km                            as km,
          t2.reg_no                        as reg_no,
          t2.chassis_no                    as chassis_no,
          t2.farge_kode                    as farge_kode,
          t2.betegnelse                    as betegnelse,
          t2.gear_type                     as gear_type,
          t2.miljo_klarert_id              as miljo_klarert_id,
          t2.servo                         as servo,
          decode(t2.temp,null,null,'X')    as temp_merknad,
          -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
           ----------------------------------------------------  
          translate (
                  translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
          translate (
                  translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
          'j'                                                               as karroseribyttebil              
        from   v_enhet_pris_k_bytte_2015 t1,
               v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
        /
        grant select on ola.v_enhet_pris_full_2015 to public
        /
    
    create or replace view v_enhet_pris_full_2016 as
        select 
        /*  
        2016_01_06 kopi v_enhet_pris_full_2015
        */
        t1.enhet_seq_no                    as enhet_seq_no,
        t1.prev_enhet_seq_no              as prev_enhet_seq_no,
        -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
         ----------------------------------------------------  translate (
        translate (
                translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
        t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
        t2.vare_gruppe_id                as vare_gruppe_id,
        t1.location_seq_no               as location_seq_no,
        t2.loc_id                        as loc_id,
        decode(t2.loc_id,null,'0',1)     as loc_id_01,
        t1.serie_seq_no                  as serie_seq_no,
        t2.serie_no                      as serie_no,                   <--FOM TIL logikk
        t1.dato_inn                      as dato_inn,                   <--dato_inn < to_date('01_01_2017','dd_mm_yyyy') AND dato_inn >=  to_date('01_01_2015','dd_mm_yyyy')
        t1.dato_ut                       as dato_ut,
        t1.pris_inkl_mva                 as pris_inkl_mva,
        t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
        t1.pris_4021                     as pris_4021,
        t1.pris_netto                    as pris_netto,
        t1.a_pris_4021_vrak              as a_pris_4021_vrak,
        t1.a_pris_netto_vrak             as a_pris_netto_vrak,
        t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
        t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
        t1.b_pris_4021_vrak              as b_pris_4021_vrak,
        t1.b_pris_netto_vrak             as b_pris_netto_vrak,
        t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
        t1.wof                           as wof,
        t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
        t1.calc_pris_netto               as calc_pris_netto,              <-- brukes i page 721 til å vise verdi
        --resten av kolonnene fra t_enhet_full
        --------------------------------------
        t2.enhet_kval_seq_no             as enhet_kval_seq_no,
        t2.kval_id                       as kval_id,
        t2.hold_on                       as hold_on,
        t2.var_bil_seq_no                as var_bil_seq_no,
        t2.fab_navn                      as fab_navn,
        t2.type_id                       as type_id,
        t2.aar                           as aar,
        t2.motor_type_id                 as motor_type_id,
        t2.motor_type_besk               as motor_type_besk,
        t2.motor_vol_id                  as motor_vol_id,
        t2.dorer_id                      as dorer_id,
        t2.k_grp_id                      as k_grp_id,
        t2.km                            as km,
        t2.reg_no                        as reg_no,
        t2.chassis_no                    as chassis_no,
        t2.farge_kode                    as farge_kode,
        t2.betegnelse                    as betegnelse,
        t2.gear_type                     as gear_type,
        t2.miljo_klarert_id              as miljo_klarert_id,
        t2.servo                         as servo,
        decode(t2.temp,null,null,'X')    as temp_merknad,
        -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
         ----------------------------------------------------  
        translate (
                translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
        translate (
                translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
        'n'                                                               as karroseribyttebil                        
          from   v_enhet_pris_2017 t1,
                 v_enhet2      t2
          where   t1.enhet_seq_no  = t2.enhet_seq_no
          /
          grant select on ola.v_enhet_pris_full_2016 to public
          /

          select  *
          from    ola.v_enhet_pris_full_2016    t1
          where   t1.dato_inn             < to_date('01_01_2017','dd_mm_yyyy')
          and     t1.dato_inn             >=  to_date('01_01_2015','dd_mm_yyyy')
          and   nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))  > to_date('01_01_2017','dd_mm_yyyy')
          order by chassis_no,vare_gruppe_id

          select TO_CHAR(sum(calc_pris_netto),'9g999g999')
            from    ola.v_enhet_pris_full_2016    t1
            where   t1.dato_inn             < to_date('01_01_2017','dd_mm_yyyy')
                  and     t1.dato_inn             >=  to_date('01_01_2015','dd_mm_yyyy')
            and   nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))  > to_date('01_01_2017','dd_mm_yyyy')
          975 804 
          865 843 2001.2018

    create or replace view v_enhet_pris_full_2017 as
        select 
        /*  
        2018_01_20 kopi v_enhet_pris_full_2016
        */
        t1.enhet_seq_no                    as enhet_seq_no,
        t1.prev_enhet_seq_no              as prev_enhet_seq_no,
        -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
         ----------------------------------------------------  translate (
        translate (
                translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
        t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
        t2.vare_gruppe_id                as vare_gruppe_id,
        t1.location_seq_no               as location_seq_no,
        t2.loc_id                        as loc_id,
        decode(t2.loc_id,null,'0',1)     as loc_id_01,
        t1.serie_seq_no                  as serie_seq_no,
        t2.serie_no                      as serie_no,                   --FOM TIL logikk
        t1.dato_inn                      as dato_inn,                   --dato_inn < to_date('01_01_2017','dd_mm_yyyy') AND dato_inn >=  to_date('01_01_2015','dd_mm_yyyy')
        t1.dato_ut                       as dato_ut,
        t1.pris_inkl_mva                 as pris_inkl_mva,
        t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
        t1.pris_4021                     as pris_4021,
        t1.pris_netto                    as pris_netto,
        t1.a_pris_4021_vrak              as a_pris_4021_vrak,
        t1.a_pris_netto_vrak             as a_pris_netto_vrak,
        t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
        t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
        t1.b_pris_4021_vrak              as b_pris_4021_vrak,
        t1.b_pris_netto_vrak             as b_pris_netto_vrak,
        t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
        t1.wof                           as wof,
        t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
        t1.calc_pris_netto               as calc_pris_netto,              -- brukes i page 721 til å vise verdi
        --resten av kolonnene fra t_enhet_full
        --------------------------------------
        t2.enhet_kval_seq_no             as enhet_kval_seq_no,
        t2.kval_id                       as kval_id,
        t2.hold_on                       as hold_on,
        t2.var_bil_seq_no                as var_bil_seq_no,
        t2.fab_navn                      as fab_navn,
        t2.type_id                       as type_id,
        t2.aar                           as aar,
        t2.motor_type_id                 as motor_type_id,
        t2.motor_type_besk               as motor_type_besk,
        t2.motor_vol_id                  as motor_vol_id,
        t2.dorer_id                      as dorer_id,
        t2.k_grp_id                      as k_grp_id,
        t2.km                            as km,
        t2.reg_no                        as reg_no,
        t2.chassis_no                    as chassis_no,
        t2.farge_kode                    as farge_kode,
        t2.betegnelse                    as betegnelse,
        t2.gear_type                     as gear_type,
        t2.miljo_klarert_id              as miljo_klarert_id,
        t2.servo                         as servo,
        decode(t2.temp,null,null,'X')    as temp_merknad,
        -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
         ----------------------------------------------------  
        translate (
                translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
        translate (
                translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
        'n'                                                               as karroseribyttebil                        
          from   v_enhet_pris_2017 t1,
                 v_enhet2      t2
          where   t1.enhet_seq_no  = t2.enhet_seq_no
      /
        grant select on ola.v_enhet_pris_full_2017 to public
        /

          select  *
          from    ola.v_enhet_pris_full_2017    t1
          where   t1.dato_inn             < to_date('01_01_2018','dd_mm_yyyy')
          and     t1.dato_inn             >=  to_date('01_01_2016','dd_mm_yyyy')
          and   nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))  > to_date('01_01_2018','dd_mm_yyyy')
          order by chassis_no,vare_gruppe_id

          select TO_CHAR(sum(calc_pris_netto),'9g999g999')
            from    ola.v_enhet_pris_full_2017    t1
            where   t1.dato_inn             < to_date('01_01_2018','dd_mm_yyyy')
                  and     t1.dato_inn             >=  to_date('01_01_2016','dd_mm_yyyy')
            and   nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))  > to_date('01_01_2018','dd_mm_yyyy')
          975 804

    create or replace view v_enhet_pris_full_2018 as
        select 
            /*  
            2016_01_06 kopi v_enhet_pris_full_2017
            */
            t1.enhet_seq_no                    as enhet_seq_no,
            t1.prev_enhet_seq_no              as prev_enhet_seq_no,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ---------------------------------------------------  translate (
            translate (
                    translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
            t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
            t2.vare_gruppe_id                as vare_gruppe_id,
            t1.location_seq_no               as location_seq_no,
            t2.loc_id                        as loc_id,
            decode(t2.loc_id,null,'0',1)     as loc_id_01,
            t1.serie_seq_no                  as serie_seq_no,
            t2.serie_no                      as serie_no,                   --FOM TIL logikk
            t1.dato_inn                      as dato_inn,                   --dato_inn < to_date('01_01_2017','dd_mm_yyyy') AND dato_inn >=  to_date('01_01_2015','dd_mm_yyyy')
            t1.dato_ut                       as dato_ut,
            t1.pris_inkl_mva                 as pris_inkl_mva,
            t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
            t1.pris_4021                     as pris_4021,
            t1.pris_netto                    as pris_netto,
            t1.a_pris_4021_vrak              as a_pris_4021_vrak,
            t1.a_pris_netto_vrak             as a_pris_netto_vrak,
            t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
            t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
            t1.b_pris_4021_vrak              as b_pris_4021_vrak,
            t1.b_pris_netto_vrak             as b_pris_netto_vrak,
            t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
            t1.wof                           as wof,
            t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
            t1.calc_pris_netto               as calc_pris_netto,              -- brukes i page 721 til å vise verdi
            --resten av kolonnene fra t_enhet_full
            --------------------------------------
            t2.enhet_kval_seq_no             as enhet_kval_seq_no,
            t2.kval_id                       as kval_id,
            t2.hold_on                       as hold_on,
            t2.var_bil_seq_no                as var_bil_seq_no,
            t2.fab_navn                      as fab_navn,
            t2.type_id                       as type_id,
            t2.aar                           as aar,
            t2.motor_type_id                 as motor_type_id,
            t2.motor_type_besk               as motor_type_besk,
            t2.motor_vol_id                  as motor_vol_id,
            t2.dorer_id                      as dorer_id,
            t2.k_grp_id                      as k_grp_id,
            t2.km                            as km,
            t2.reg_no                        as reg_no,
            t2.chassis_no                    as chassis_no,
            t2.farge_kode                    as farge_kode,
            t2.betegnelse                    as betegnelse,
            t2.gear_type                     as gear_type,
            t2.miljo_klarert_id              as miljo_klarert_id,
            t2.servo                         as servo,
            decode(t2.temp,null,null,'X')    as temp_merknad,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ----------------------------------------------------  
            translate (
                    translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
            translate (
                    translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
            'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris_2018 t1,
                 v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
      /
        grant select on ola.v_enhet_pris_full_2018 to public
        /
        --drop table enhet_pris_full_2018 ;
        create table enhet_pris_full_2018 as
            select  *
            from  	ola.v_enhet_pris_full_2018 		t1
            where  	t1.dato_inn 						<	to_date('01_01_2019','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2017','dd_mm_yyyy')
            and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2019','dd_mm_yyyy')
            order by chassis_no,vare_gruppe_id
        /

        select TO_CHAR(sum(calc_pris_netto),'9g999g999')
            from    ola.t_enhet_pris_full_2018    t1
        1 014 222

    create or replace view v_enhet_pris_full_2019 as
        select 
            /*  
            2016_01_06 kopi v_enhet_pris_full_2017
            */
            t1.enhet_seq_no                    as enhet_seq_no,
            t1.prev_enhet_seq_no              as prev_enhet_seq_no,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ---------------------------------------------------  translate (
            translate (
                    translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
            t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
            t2.vare_gruppe_id                as vare_gruppe_id,
            t1.location_seq_no               as location_seq_no,
            t2.loc_id                        as loc_id,
            decode(t2.loc_id,null,'0',1)     as loc_id_01,
            t1.serie_seq_no                  as serie_seq_no,
            t2.serie_no                      as serie_no,                   --FOM TIL logikk
            t1.dato_inn                      as dato_inn,                   --dato_inn < to_date('01_01_2017','dd_mm_yyyy') AND dato_inn >=  to_date('01_01_2015','dd_mm_yyyy')
            t1.dato_ut                       as dato_ut,
            t1.pris_inkl_mva                 as pris_inkl_mva,
            t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
            t1.pris_4021                     as pris_4021,
            t1.pris_netto                    as pris_netto,
            t1.a_pris_4021_vrak              as a_pris_4021_vrak,
            t1.a_pris_netto_vrak             as a_pris_netto_vrak,
            t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
            t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
            t1.b_pris_4021_vrak              as b_pris_4021_vrak,
            t1.b_pris_netto_vrak             as b_pris_netto_vrak,
            t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
            t1.wof                           as wof,
            t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
            t1.calc_pris_netto               as calc_pris_netto,              -- brukes i page 721 til å vise verdi
            --resten av kolonnene fra t_enhet_full
            --------------------------------------
            t2.enhet_kval_seq_no             as enhet_kval_seq_no,
            t2.kval_id                       as kval_id,
            t2.hold_on                       as hold_on,
            t2.prev_serie_no                 as prev_serie_no,    
            t2.var_bil_seq_no                as var_bil_seq_no,
            t2.fab_navn                      as fab_navn,
            t2.type_id                       as type_id,
            t2.aar                           as aar,
            t2.motor_type_id                 as motor_type_id,
            t2.motor_type_besk               as motor_type_besk,
            t2.motor_vol_id                  as motor_vol_id,
            t2.dorer_id                      as dorer_id,
            t2.k_grp_id                      as k_grp_id,
            t2.km                            as km,
            t2.reg_no                        as reg_no,
            t2.chassis_no                    as chassis_no,
            t2.farge_kode                    as farge_kode,
            t2.betegnelse                    as betegnelse,
            t2.gear_type                     as gear_type,
            t2.miljo_klarert_id              as miljo_klarert_id,
            t2.servo                         as servo,
            decode(t2.temp,null,null,'X')    as temp_merknad,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ----------------------------------------------------  
            translate (
                    translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
            translate (
                    translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
            'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris_2019 t1,
                 v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
      /
        grant select on ola.v_enhet_pris_full_2019 to public
        /

    create or replace view v_enhet_pris_full_2020 as
        select 
            /*  
            2016_01_06 kopi v_enhet_pris_full_2017
            2021_01_16 kopi v_enhet_pris_full_2019
            */
            t1.enhet_seq_no                    as enhet_seq_no,
            t1.prev_enhet_seq_no              as prev_enhet_seq_no,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ---------------------------------------------------  translate (
            translate (
                    translate (t2.enhet_besk,chr(10), ' '),chr(13),' ')    as enhet_besk,
            t1.vare_gruppe_seq_no            as vare_gruppe_seq_no,
            t2.vare_gruppe_id                as vare_gruppe_id,
            t1.location_seq_no               as location_seq_no,
            t2.loc_id                        as loc_id,
            decode(t2.loc_id,null,'0',1)     as loc_id_01,
            t1.serie_seq_no                  as serie_seq_no,
            t2.serie_no                      as serie_no,                   --FOM TIL logikk
            t1.dato_inn                      as dato_inn,                   --dato_inn < to_date('01_01_2017','dd_mm_yyyy') AND dato_inn >=  to_date('01_01_2015','dd_mm_yyyy')
            t1.dato_ut                       as dato_ut,
            t1.pris_inkl_mva                 as pris_inkl_mva,
            t1.pris_solgt_inkl_mva           as pris_solgt_inkl_mva,
            t1.pris_4021                     as pris_4021,
            t1.pris_netto                    as pris_netto,
            t1.a_pris_4021_vrak              as a_pris_4021_vrak,
            t1.a_pris_netto_vrak             as a_pris_netto_vrak,
            t1.a_tot_antall_deler_paa_vrak   as a_tot_antall_deler_paa_vrak,
            t1.a_calc_pris_netto_del         as a_calc_pris_netto_del,
            t1.b_pris_4021_vrak              as b_pris_4021_vrak,
            t1.b_pris_netto_vrak             as b_pris_netto_vrak,
            t1.b_tot_antall_deler_paa_vrak   as b_tot_antall_deler_paa_vrak,
            t1.wof                           as wof,
            t1.b_calc_pris_netto_vrak        as b_calc_pris_netto_vrak,
            t1.calc_pris_netto               as calc_pris_netto,              -- brukes i page 721 til å vise verdi
            --resten av kolonnene fra t_enhet_full
            --------------------------------------
            t2.enhet_kval_seq_no             as enhet_kval_seq_no,
            t2.kval_id                       as kval_id,
            t2.hold_on                       as hold_on,
            t2.prev_serie_no                 as prev_serie_no,    
            t2.var_bil_seq_no                as var_bil_seq_no,
            t2.fab_navn                      as fab_navn,
            t2.type_id                       as type_id,
            t2.aar                           as aar,
            t2.motor_type_id                 as motor_type_id,
            t2.motor_type_besk               as motor_type_besk,
            t2.motor_vol_id                  as motor_vol_id,
            t2.dorer_id                      as dorer_id,
            t2.k_grp_id                      as k_grp_id,
            t2.km                            as km,
            t2.reg_no                        as reg_no,
            t2.chassis_no                    as chassis_no,
            t2.farge_kode                    as farge_kode,
            t2.betegnelse                    as betegnelse,
            t2.gear_type                     as gear_type,
            t2.miljo_klarert_id              as miljo_klarert_id,
            t2.servo                         as servo,
            decode(t2.temp,null,null,'X')    as temp_merknad,
            -- bytter ut CR ogLF med  2 mellomrom (ett ikke nok)
             ----------------------------------------------------  
            translate (
                    translate (t2.prod_nr       ,chr(10), ' '),chr(13),' ')   as prod_nr,
            translate (
                    translate (t2.vendor_data_no,chr(10), ' '),chr(13),' ')   as vendor_data_no,
            'n'                                                               as karroseribyttebil                        
        from   v_enhet_pris_2020 t1,
                 v_enhet2      t2
        where   t1.enhet_seq_no  = t2.enhet_seq_no
      /
        grant select on ola.v_enhet_pris_full_2020 to public
        /

----------------------------------------------------------- v_enhet_pris      + årene 2014 - >> ------------------------------------------------------------------------------------------
    --drop view v_enhet_pris;
    create or replace view v_enhet_pris as
        select
          /*
          Vrak uten del --> hele verdien ligger på vraket
            enhet_seq_no=29965  Audi A8 95 mange deler og bil på lager
            enhet_seq_no=19529  Fiat ducato ingen deler og bil på lager
            enhet_seq_no=4478  Del uten overordnet del MEN med pris
            enhet_seq_no=3274  Del uten overordnet del MEN UTEN pris    
                  NB NB trigger MÅ hindre at vi kan legge pris på deler med overordnet vrak 
                    test hva som skjer dersom dette aslltikevel skjer !!!
            select * from v_enhet_pris
            where enhet_seq_no in (68068,3274,29965,19529,4478) or prev_enhet_seq_no in (68068,3274,29965,19529,4478)
            order by 2 desc
            --sjekk på logikk
            select * from v_enhet_pris where calc_pris_4021_netto is null
          select '31_12_2007',
          sum (t1.calc_pris_netto)
          from    v_enhet_pris     t1
          where    
            t1.dato_inn             <=  to_date('01_01_2008','dd_mm_yyyy')
          and    nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))   >  to_date('01_01_2008','dd_mm_yyyy')
          1 586 336 inkl 1500
          1 067 881 exkl 1500
        --  Vrak til 10 000kr 2 deler
        --      Motor solgt for 12 000
        --      Dørhåndtak på lager verdt 5 000
        --  Deler uten overordnet vrak, og ikke priset settes til verdi = 1
          Dato          Endring
          ===        =======
          2008_02_21 laget Valldal
          2010_04_09 lagt inn pris på deler
          */
          t1.enhet_seq_no                as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   s dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
             t1.pris_4021 -1500 >0 then t1.pris_4021 -1500
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
             t1.pris_4021 -1500 >0 then t1.pris_4021 -1500
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 t1.pris_4021 -1500 >0 then t1.pris_4021 -1500
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when 
                     t1.pris_4021 -1500 >0 then t1.pris_4021 -1500
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto    
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 pris_4021 -1500 >0 then pris_4021 -1500
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        /
        grant select on ola.v_enhet_pris to public
        /

        select  to_char(date_4021,'yyyy'),count(*) as antal, to_char(sum(pris_4021),'9g999g999') as tot_pris
        from enhet
        group by to_char(date_4021,'yyyy')
        order by to_char(date_4021,'yyyy');


    create or replace view v_enhet_pris2 as
        select
          /*
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
             t1.pris_4021 -2500 >0 then t1.pris_4021 -2500
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
             t1.pris_4021 -2500 >0 then t1.pris_4021 -2500
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 t1.pris_4021 -2500 >0 then t1.pris_4021 -2500
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when 
                     t1.pris_4021 -2500 >0 then t1.pris_4021 -2500
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 pris_4021 -2500 >0 then pris_4021 -2500
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
           )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
        /
        grant select on ola.v_enhet_pris2 to public
        /
    
    create or replace view v_enhet_pris_2014 as
        select
          /*
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          2015_01_14 legger både 2014 og 2013 til 3000 kr i vrak pant
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when 
                     t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 pris_4021 -3000 >0 then pris_4021 -3000
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
           )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
        /
        grant select on ola.v_enhet_pris_2014 to public
        /
    
    create or replace view v_enhet_pris_2015 as
        select
          /*
          2015_01_06 kopi v_enhet_pris_2014
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when 
                     t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 pris_4021 -3000 >0 then pris_4021 -3000
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
           )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
        /
        grant select on ola.v_enhet_pris_2015 to public
        /
    
    create or replace view v_enhet_pris_2016 as
        select
          /*
          2016_01_06 kopi v_enhet_pris_2015
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
             t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when 
                     t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 pris_4021 -3000 >0 then pris_4021 -3000
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
           )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
        /
        grant select on ola.v_enhet_pris_2016 to public
        /
    create or replace view v_enhet_pris_2017 as
        select
            /*
            2017_01_20 kopi v_enhet_pris_2016
            */
            t1.enhet_seq_no               as enhet_seq_no,
            t1.prev_enhet_seq_no          as prev_enhet_seq_no,
            t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
            t1.location_seq_no            as location_seq_no,
            t1.serie_seq_no               as serie_seq_no,
            t1.dato_inn                   as dato_inn,
            t1.dato_ut                    as dato_ut,
            t1.pris_inkl_mva              as pris_inkl_mva,
            t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
            t1.pris_4021                  as pris_4021,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                            as pris_netto, 
            --A. deler MED overordnet vrak
            ------------------------------
            pris.pris_4021                                            as A_pris_4021_vrak,
            pris.pris_netto                                           as A_pris_netto_vrak,
            antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
              round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
            --B. vrak UTEN deler og deler UTEN vrak    
            ---------------------------------------
            t1.pris_4021                                              as B_pris_4021_vrak,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                                                       as B_pris_netto_vrak,
              --Trix  antall under kun hvis vrak har blitt brukt som
              --overordnet del
            antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
              --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
              -- null x 0 gir null
            antall2.ant_deler*0                                       as wof,
            nvl(  antall2.ant_deler*0,
                case when 
                   t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
              end
                )                                                     as B_calc_pris_netto_vrak,
            --C. calc_pris_4021_netto
            -------------------------
            --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
            --              og ikke har pris til 0 (i dette tilfellet)
            round(
              nvl(
                  nvl(
              nvl(antall2.ant_deler*0,
                  case when 
                       t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                  end
                 ),
              pris.pris_netto/nvl(antall_deler.ant_deler,1)
                  )
                ,0)    
            ,0)                                                        as calc_pris_netto
        from
            enhet                                                t1,
            (
            select   enhet_seq_no          as enhet_seq_no,
              nvl(pris_4021,0)        as pris_4021,
              case when 
                   pris_4021 -3000 >0 then pris_4021 -3000
                   else 0  
              end            as pris_netto
            from enhet
            where nvl(pris_4021,0) >=1
            )                                                   pris,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall_deler,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall2,
            ( --uttrekk karroseribyttebile og deler
             select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
             union
             select del.enhet_seq_no 
             from enhet del,
                  enhet vrak
             where del.prev_enhet_seq_no = vrak.enhet_seq_no
             and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
             )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
    /
        grant select on ola.v_enhet_pris_2017 to public
        /

    create or replace view v_enhet_pris_2018 as
        select
            /*
            2018_01_06 kopi v_enhet_pris_2017
            */
            t1.enhet_seq_no               as enhet_seq_no,
            t1.prev_enhet_seq_no          as prev_enhet_seq_no,
            t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
            t1.location_seq_no            as location_seq_no,
            t1.serie_seq_no               as serie_seq_no,
            t1.dato_inn                   as dato_inn,
            t1.dato_ut                    as dato_ut,
            t1.pris_inkl_mva              as pris_inkl_mva,
            t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
            t1.pris_4021                  as pris_4021,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                            as pris_netto, 
            --A. deler MED overordnet vrak
            ------------------------------
            pris.pris_4021                                            as A_pris_4021_vrak,
            pris.pris_netto                                           as A_pris_netto_vrak,
            antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
              round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
            --B. vrak UTEN deler og deler UTEN vrak    
            ---------------------------------------
            t1.pris_4021                                              as B_pris_4021_vrak,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                                                       as B_pris_netto_vrak,
              --Trix  antall under kun hvis vrak har blitt brukt som
              --overordnet del
            antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
              --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
              -- null x 0 gir null
            antall2.ant_deler*0                                       as wof,
            nvl(  antall2.ant_deler*0,
                case when 
                   t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
              end
                )                                                     as B_calc_pris_netto_vrak,
            --C. calc_pris_4021_netto
            -------------------------
            --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
            --              og ikke har pris til 0 (i dette tilfellet)
            round(
              nvl(
                  nvl(
              nvl(antall2.ant_deler*0,
                  case when 
                       t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                  end
                 ),
              pris.pris_netto/nvl(antall_deler.ant_deler,1)
                  )
                ,0)    
            ,0)                                                        as calc_pris_netto
        from
            enhet                                                t1,
            (
            select   enhet_seq_no          as enhet_seq_no,
              nvl(pris_4021,0)        as pris_4021,
              case when 
                   pris_4021 -3000 >0 then pris_4021 -3000
                   else 0  
              end            as pris_netto
            from enhet
            where nvl(pris_4021,0) >=1
            )                                                   pris,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall_deler,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall2,
            ( --uttrekk karroseribyttebile og deler
             select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
             union
             select del.enhet_seq_no 
             from enhet del,
                  enhet vrak
             where del.prev_enhet_seq_no = vrak.enhet_seq_no
             and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
             )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
    /
        grant select on ola.v_enhet_pris_2018 to public
        /

    create or replace view v_enhet_pris_2019 as
        select
            /*
            2018_01_06 kopi v_enhet_pris_2017
            2019_01_11 kopi v_enhet_pris_2018
            */
            t1.enhet_seq_no               as enhet_seq_no,
            t1.prev_enhet_seq_no          as prev_enhet_seq_no,
            t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
            t1.location_seq_no            as location_seq_no,
            t1.serie_seq_no               as serie_seq_no,
            t1.dato_inn                   as dato_inn,
            t1.dato_ut                    as dato_ut,
            t1.pris_inkl_mva              as pris_inkl_mva,
            t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
            t1.pris_4021                  as pris_4021,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                            as pris_netto, 
            --A. deler MED overordnet vrak
            ------------------------------
            pris.pris_4021                                            as A_pris_4021_vrak,
            pris.pris_netto                                           as A_pris_netto_vrak,
            antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
              round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
            --B. vrak UTEN deler og deler UTEN vrak    
            ---------------------------------------
            t1.pris_4021                                              as B_pris_4021_vrak,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                                                       as B_pris_netto_vrak,
              --Trix  antall under kun hvis vrak har blitt brukt som
              --overordnet del
            antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
              --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
              -- null x 0 gir null
            antall2.ant_deler*0                                       as wof,
            nvl(  antall2.ant_deler*0,
                case when 
                   t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
              end
                )                                                     as B_calc_pris_netto_vrak,
            --C. calc_pris_4021_netto
            -------------------------
            --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
            --              og ikke har pris til 0 (i dette tilfellet)
            round(
              nvl(
                  nvl(
              nvl(antall2.ant_deler*0,
                  case when 
                       t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                  end
                 ),
              pris.pris_netto/nvl(antall_deler.ant_deler,1)
                  )
                ,0)    
            ,0)                                                        as calc_pris_netto
        from
            enhet                                                t1,
            (
            select   enhet_seq_no          as enhet_seq_no,
              nvl(pris_4021,0)        as pris_4021,
              case when 
                   pris_4021 -3000 >0 then pris_4021 -3000
                   else 0  
              end            as pris_netto
            from enhet
            where nvl(pris_4021,0) >=1
            )                                                   pris,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall_deler,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall2,
            ( --uttrekk karroseribyttebile og deler
             select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
             union
             select del.enhet_seq_no 
             from enhet del,
                  enhet vrak
             where del.prev_enhet_seq_no = vrak.enhet_seq_no
             and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
             )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
    /
        grant select on ola.v_enhet_pris_2019 to public
        /

    create or replace view v_enhet_pris_2020 as
        select
            /*
            2018_01_06 kopi v_enhet_pris_2017
            2019_01_11 kopi v_enhet_pris_2018
            2020_01_16 kopi v_enhet_pris_2019
            */
            t1.enhet_seq_no               as enhet_seq_no,
            t1.prev_enhet_seq_no          as prev_enhet_seq_no,
            t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
            t1.location_seq_no            as location_seq_no,
            t1.serie_seq_no               as serie_seq_no,
            t1.dato_inn                   as dato_inn,
            t1.dato_ut                    as dato_ut,
            t1.pris_inkl_mva              as pris_inkl_mva,
            t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
            t1.pris_4021                  as pris_4021,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                            as pris_netto, 
            --A. deler MED overordnet vrak
            ------------------------------
            pris.pris_4021                                            as A_pris_4021_vrak,
            pris.pris_netto                                           as A_pris_netto_vrak,
            antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
              round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
            --B. vrak UTEN deler og deler UTEN vrak    
            ---------------------------------------
            t1.pris_4021                                              as B_pris_4021_vrak,
            case when 
               t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
            end                                                       as B_pris_netto_vrak,
              --Trix  antall under kun hvis vrak har blitt brukt som
              --overordnet del
            antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
              --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
              -- null x 0 gir null
            antall2.ant_deler*0                                       as wof,
            nvl(  antall2.ant_deler*0,
                case when 
                   t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
              end
                )                                                     as B_calc_pris_netto_vrak,
            --C. calc_pris_4021_netto
            -------------------------
            --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
            --              og ikke har pris til 0 (i dette tilfellet)
            round(
              nvl(
                  nvl(
              nvl(antall2.ant_deler*0,
                  case when 
                       t1.pris_4021 -3000 >0 then t1.pris_4021 -3000
                  end
                 ),
              pris.pris_netto/nvl(antall_deler.ant_deler,1)
                  )
                ,0)    
            ,0)                                                        as calc_pris_netto
        from
            enhet                                                t1,
            (
            select   enhet_seq_no          as enhet_seq_no,
              nvl(pris_4021,0)        as pris_4021,
              case when 
                   pris_4021 -3000 >0 then pris_4021 -3000
                   else 0  
              end            as pris_netto
            from enhet
            where nvl(pris_4021,0) >=1
            )                                                   pris,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall_deler,
            (
            select prev_enhet_seq_no  as enhet_seq_no,
                     count(*)    as ant_deler
            from enhet
            where prev_enhet_seq_no is not null
            having count(*) >0
            group  by prev_enhet_seq_no  
            )                                                   antall2,
            ( --uttrekk karroseribyttebile og deler
             select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'n' 
             union
             select del.enhet_seq_no 
             from enhet del,
                  enhet vrak
             where del.prev_enhet_seq_no = vrak.enhet_seq_no
             and nvl2(vrak.karroseribyttebiler,'j','n') = 'n' 
             )                                                  k_bytte 
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
    /
        grant select on ola.v_enhet_pris_2020 to public
        /


    create or replace view v_enhet_pris2_k_bytte as
        select
          /*
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler     
                 t1.pris_4021  >0 then t1.pris_4021 
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when
                     -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                     t1.pris_4021  >0 then t1.pris_4021 
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                 pris_4021 >0 then pris_4021 
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'j' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'j' 
           )                                                  k_bytte
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no         
        /
        grant select on ola.v_enhet_pris2_k_bytte to public
        /

        --sjekk at det ikke er duplikater
        select enhet_seq_no from v_enhet_pris2
        intersect
        select enhet_seq_no from v_enhet_pris2_k_bytte;


    create or replace view v_enhet_pris_k_bytte_2014 as
        select
          /*
          2014_01_02 vrakpant 2500 
          2014_01_06 karroseribyttebiler Etne Auto inn
          2015_01_14 avgrenset til 2013 og 2014 med to_char(dato_inn,'yyyy') in ('2013','2014')
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler     
                 t1.pris_4021  >0 then t1.pris_4021 
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when
                     -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                     t1.pris_4021  >0 then t1.pris_4021 
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                 pris_4021 >0 then pris_4021 
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'j' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'j'
           --avgrenser til 2 årig scope
           and to_char(vrak.dato_inn,'yyyy') in ('2013','2014')  
           )                                                  k_bytte
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no       
        /
        grant select on ola.v_enhet_pris_k_bytte_2014 to public
        /
    create or replace view v_enhet_pris_k_bytte_2015 as
        select
          /*
          2015_01_06 kopi v_enhet_pris_k_bytte_2014 
          */
          t1.enhet_seq_no               as enhet_seq_no,
          t1.prev_enhet_seq_no          as prev_enhet_seq_no,
          t1.vare_gruppe_seq_no         as vare_gruppe_seq_no,
          t1.location_seq_no            as location_seq_no,
          t1.serie_seq_no               as serie_seq_no,
          t1.dato_inn                   as dato_inn,
          t1.dato_ut                    as dato_ut,
          t1.pris_inkl_mva              as pris_inkl_mva,
          t1.pris_solgt_inkl_mva        as pris_solgt_inkl_mva,
          t1.pris_4021                  as pris_4021,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                            as pris_netto, 
          --A. deler MED overordnet vrak
          ------------------------------
          pris.pris_4021                                            as A_pris_4021_vrak,
          pris.pris_netto                                           as A_pris_netto_vrak,
          antall_deler.ant_deler                                    as A_tot_antall_deler_paa_vrak,
            round(pris.pris_netto/nvl(antall_deler.ant_deler,1),0)  as A_calc_pris_netto_del,
          --B. vrak UTEN deler og deler UTEN vrak    
          ---------------------------------------
          t1.pris_4021                                              as B_pris_4021_vrak,
          case when 
            -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
             t1.pris_4021  >0 then t1.pris_4021 
          end                                                       as B_pris_netto_vrak,
            --Trix  antall under kun hvis vrak har blitt brukt som
            --overordnet del
          antall2.ant_deler                                          as B_tot_antall_deler_paa_vrak,  
            --Trix antall *0 gir tallet 0 KUN dersom vi ganger med et tall
            -- null x 0 gir null
          antall2.ant_deler*0                                       as wof,
          nvl(  antall2.ant_deler*0,
              case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler     
                 t1.pris_4021  >0 then t1.pris_4021 
            end
              )                                                     as B_calc_pris_netto_vrak,
          --C. calc_pris_4021_netto
          -------------------------
          --ytterste nvl sørger for at vi priser de delene som ikke har overordnet del
          --              og ikke har pris til 0 (i dette tilfellet)
          round(
            nvl(
                nvl(
            nvl(antall2.ant_deler*0,
                case when
                     -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                     t1.pris_4021  >0 then t1.pris_4021 
                end
               ),
            pris.pris_netto/nvl(antall_deler.ant_deler,1)
                )
              ,0)    
          ,0)                                                        as calc_pris_netto
        from
          enhet                                                t1,
          (
          select   enhet_seq_no          as enhet_seq_no,
            nvl(pris_4021,0)        as pris_4021,
            case when 
                 -- trekker ikke fra vrakpant ref skal aldri vrake karroseribyttebiler
                 pris_4021 >0 then pris_4021 
                 else 0  
            end            as pris_netto
          from enhet
          where nvl(pris_4021,0) >=1
          )                                                   pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall_deler,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          )                                                   antall2,
          ( --uttrekk karroseribyttebile og deler
           select enhet_seq_no from enhet where vare_gruppe_seq_no=1 and nvl2(karroseribyttebiler,'j','n') = 'j' 
           union
           select del.enhet_seq_no 
           from enhet del,
                enhet vrak
           where del.prev_enhet_seq_no = vrak.enhet_seq_no
           and nvl2(vrak.karroseribyttebiler,'j','n') = 'j'
           --avgrenser til 2 årig scope
           and to_char(vrak.dato_inn,'yyyy') in ('2014','2015')  
           )                                                  k_bytte
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no            (+)
        and     t1.prev_enhet_seq_no = antall_deler.enhet_seq_no    (+)
        and     t1.enhet_seq_no      = antall2.enhet_seq_no         (+)
        and     t1.enhet_seq_no      = k_bytte.enhet_seq_no       
        /
        grant select on ola.v_enhet_pris_k_bytte_2015 to public
        /

        ------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        --tullball med crg -ret i rapport
         instr(upper("FASE")  ,upper(nvl(:P8_REPORT_SEARCH,"FASE")))   > 0   or
        chr(39)

        select enhet_besk
        from ola.enhet
        where enhet_seq_no = 70690




        alter table enhet add (pris_4021 number);

        --3.0 alle vrak koster 1500kr
        -----------------------------
        alter table enhet disable all triggers;
        update enhet set pris_4021=1500 where vare_gruppe_seq_no=1;
        --#7765
        alter table enhet enable all triggers;

        --3.A Alle vrak og deler m pris
        ----------------------
        select   enhet_seq_no    as enhet_seq_no,
          nvl(pris_4021,0)  as pris_4021
        from enhet
        where nvl(pris_4021,0) >=1;
        #566

                                   select vare_gruppe_seq_no,count(*)
                                   from enhet
                                   where nvl(pris_4021,0) >=1
                                   group by vare_gruppe_seq_no;

                                   VARE_GRUPPE_SEQ_NO   COUNT(*)
                                   ------------------ ----------
                                                    1       7765
                                                  901          1
                                                 1300          1
                                                 1700          1
                                                 2824          1

        --3.B Vrak som det er plukket x antall deler av
        -----------------------------------------------
        select prev_enhet_seq_no  as enhet_seq_no,
               count(*)      as ant_deler
        from enhet
        where prev_enhet_seq_no is not null
        having count(*) >0
        group  by prev_enhet_seq_no;


        --3.C Pris pr del(eller vrak) = pris vrak /#deler + 1 (hvis kun vrak på lager og ikke deler til det )
        ------------------------------------------------------------------
        --  Vrak uten del --> hele verdien ligger på vraket
        --  Vrak til 10 000kr 2 deler
        --      Motor solgt for 12 000
        --      Dørhåndtak på lager verdt 5 000
        --  Deler uten overordnet vrak verdi = 0 eller registrert kost pris      

        select   t1.enhet_seq_no,
          nvl(pris.pris_4021,t1.pris_4021),
          nvl(antall.ant_deler,1),
            round(
                  nvl(pris.pris_4021/nvl(antall.ant_deler,1),
                      t1.pris_4021)
                  ,0)
        from enhet  t1,
          (
          select   enhet_seq_no    as enhet_seq_no,
            nvl(pris_4021,0)  as pris_4021
          from enhet
          where nvl(pris_4021,0) >=1
          ) pris,
          (
          select prev_enhet_seq_no  as enhet_seq_no,
                   count(*)    as ant_deler
          from enhet
          where prev_enhet_seq_no is not null
          having count(*) >0
          group  by prev_enhet_seq_no  
          ) antall
        where   t1.prev_enhet_seq_no = pris.enhet_seq_no    (+)
        and   t1.prev_enhet_seq_no = antall.enhet_seq_no    (+)
        --and   t1.prev_enhet_seq_no in (43659,29122,62163) 
        and    t1.enhet_seq_no in (4478,25426,43149,2720)

        Pris 1500 alle biler
        PREV_ENHET_SEQ_NO  COUNT(*)
        43659      108
        29122      100
        62163      96


        --alle deler uten overordnet vrak (på lager NÅ)
        select * from v_enhet_full
        where vare_gruppe_seq_no !=1
        and pre_enhet_seq_no is  null
        and loc_id  is not null;
        --#850
        --legger pris på deler
        update enhet set pris_4021=800 
        where enhet_seq_no in (4478,25426,43149,2720);

        select enhet_seq_no, pris_4021
        from enhet
        where enhet_seq_no in (4478,25426,43149,2720)






----------------------------------------------------------- v_enhet_pris_full >> APEX p 741, 742 report sql------------------------------------------------------------------------------------------
    p 741
        select  *
        from  	ola.v_enhet_pris_full_2019 		t1
        where  	t1.dato_inn 						<	to_date('01_01_2020','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2018','dd_mm_yyyy')
        and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2020','dd_mm_yyyy')
        order by chassis_no,vare_gruppe_id

    p 742
        select  *
        --select count(*)
        from  	ola.v_enhet_pris_full_2020 		t1
        where  	t1.dato_inn 						<	to_date('01_01_2021','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2019','dd_mm_yyyy')
        and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2021','dd_mm_yyyy')
        order by chassis_no,vare_gruppe_id

        select count(*) from ola.v_enhet_pris_full_2020;
            159053 alt 
             11529 2021


----------------------------------------------------------- v_enhet_pris      >> APEX p 721 report sql------------------------------------------------------------------------------------------
    select 
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2006','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2004','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2006','dd_mm_yyyy')
    ) as "2005",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2007','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2005','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2007','dd_mm_yyyy')
    ) as "2006",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2008','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2006','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2008','dd_mm_yyyy')
    ) as "2007",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2009','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2007','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2009','dd_mm_yyyy')
    ) as "2008",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2010','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2008','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2010','dd_mm_yyyy')
    ) as "2009",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2011','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2009','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2011','dd_mm_yyyy')
    ) as "2010",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2012','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2010','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2012','dd_mm_yyyy')
    ) as "2011",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2013','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2011','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2013','dd_mm_yyyy')
    ) as "2012",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full2 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2014','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2012','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2014','dd_mm_yyyy')
    ) as "2013",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2014 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2015','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2013','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2015','dd_mm_yyyy')
    ) as "2014",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2015 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2016','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2014','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2016','dd_mm_yyyy')
    ) as "2015",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2016 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2017','dd_mm_yyyy')
        and     t1.dato_inn 						>=	to_date('01_01_2015','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2017','dd_mm_yyyy')
    ) as "2016",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2017 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2018','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2016','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2018','dd_mm_yyyy')
    ) as "2017",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2018 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2019','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2017','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2019','dd_mm_yyyy')
    ) as "2018",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2019 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2020','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2018','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2020','dd_mm_yyyy')
    ) as "2019",
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
    	from  	ola.v_enhet_pris_full_2020 		t1
    	where  	t1.dato_inn 						<	to_date('01_01_2021','dd_mm_yyyy')
            and     t1.dato_inn 						>=	to_date('01_01_2019','dd_mm_yyyy')
    	and  	nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy')) 	>	to_date('01_01_2021','dd_mm_yyyy')
    ) as "2020"
    from dual

----------------------------------------------------------- slutt pris ------------------------------------------------------------------------------------------
    --liste problem deler
    select * 
    from v_enhet_vis t1,
    (select enhet_seq_no from enhet
    where vare_gruppe_seq_no <>1
    and prev_enhet_seq_no is null
    and location_seq_no is not null) t2
    where t1.enhet_seq_no = t2.enhet_seq_no
    #962
    
    select serie_no
    from v_enhet_full
    where enhet_seq_no =  59923;
    D23370
    
    --drop view v_enhet_sub;
    create or replace view v_enhet_sub as
    select
      /*
      Sørger for at enhet_sub info på vrak også blir vist på deler som har overordnet vrak på seg
      eks
         -----------------------------------------------------------------------------
        --dele.nr  enhet_seq_no  pre_enhet_seq_no  ras (i PB)  nvl (nr som brukes for å hente info i dette viewet)
      --V4827    29393    null      29393    29393
      --D14350  38173    29393      38173    29393
      --D23370        59923           null                    59923           59923
      ------------------------------------------------------------------------------
    
      Dato          Endring
      ===        =======
      2007_06_23 laget
      2011_04_17 lagt inn esp
      */
      enhet_seq_no              as     enhet_seq_no,
    --   t2.sub_enhet_seq_no   as sub_enhet_seq_no,
      null                   as sub_enhet_seq_no,
    --   enhet_sub_seq_no       as enhet_sub_seq_no,
      null                   as enhet_sub_seq_no,
      abs_yn                 as abs_yn,
      sentral_laas_yn        as sentral_laas_yn,
      skinn_yn               as skinn_yn,
      tilhengerfeste_yn      as tilhengerfeste_yn,
      metallic_yn            as metallic_yn,
      cruise_cont_yn         as cruise_cont_yn,
      kjore_comp_yn          as kjore_comp_yn,
      setevarmere_yn         as setevarmere_yn,
      xenon_yn               as xenon_yn,
      org_audio_yn           as org_audio_yn,
      brukt_imp_yn           as brukt_imp_yn,
      el_speil_yn            as el_speil_yn,
      el_speil_ant           as el_speil_ant,
      aircon                 as aircon,
      soltak                 as soltak,
      lys                    as lys,
      farge_int              as farge_int,
      motor_kode             as motor_kode,
      gear_kode              as gear_kode,
      hk                     as hk,
      in_date                as in_date,
      motor_test             as motor_test,
      gear_test              as gear_test,
      el_heis_yn             as el_heis_yn,
      drift                  as drift,
      airbag_ant             as airbag_ant,
      airbag_def             as airbag_def,
      esp       as esp
    from enhet 
    where vare_gruppe_seq_no=1   
    / 
        --   --henter riktig nr for sub-info
        --  (select
        --   enhet_seq_no        as enhet_seq_no, 
        --     -----------------------------------------------------------------------------
        --    --dele.nr  enhet_seq_no  pre_enhet_seq_no  ras    nvl
        --  --V4827    29393    null      29393    29393
        --  --D14350  38173    29393      38173    29393
        --  ------------------------------------------------------------------------------
        --   nvl(prev_enhet_seq_no,enhet_seq_no)   as sub_enhet_seq_no
        --   from enhet 
        --   )  t2,
        --   enhet_sub sub
        --where  t1.enhet_seq_no   = t2.enhet_seq_no  
        --  and  t2.sub_enhet_seq_no  = sub.enhet_seq_no
        ----and  t1.enhet_seq_no  in (38173,29393,59923)
    /
    grant select on v_enhet_sub to public
    /
    
    
    /////////////////////////////////////////////////////////////////////////////////////////////
    --lager telling
    select to_char(dato_ut,'yyyy') as aar_ut,   
    to_char(dato_inn,'yyyy') as aar_inn,   
           count(*)
    from enhet
    group by to_char(dato_inn,'yyyy'),to_char(dato_ut,'yyyy') 
    order by 1,2
    
    på lager pr 31.12.06
    
    
    
    
    /*Omløpshastighetsalgs historikk*/
    SELECT v_enhet_vis.VARE_GRUPPE_ID, v_enhet_vis.FAB_NAVN, v_enhet_vis.TYPE_ID, v_enhet_vis.AAR, v_enhet_vis.DATO_INN, v_enhet_vis.DATO_UT, v_enhet_vis.omlops_hastighet
    FROM OLA.v_enhet_vis v_enhet_vis
    WHERE (to_char(dato_ut,'yyyy')='2006') AND (v_enhet_vis.VARE_GRUPPE_ID<>'VRAK')
    ORDER BY v_enhet_vis.omlops_hastighet
    
----------------------------------------------------------- v_stat_lager_full ------------------------------------------------------------------------------------------
    create or replace view v_stat_lager_inn_ut as
    select
    /*      APEX master page xxx
            ide fra enhet_xxx.sql
    Dato    Endring
    ===       =======        
    2013_09_21 laget
    */                 
           decode(vare_gruppe_seq_no,1,'Vrak','Del')                                                                        as vare,
           to_char(dato_inn,'yyyy')                                                                                         as aar_inn,
           to_char(dato_inn,'mm')                                                                                          as mnd_inn,
           to_char(dato_inn,'iw')                                                                                           as w_inn,
           to_char(dato_ut,'yyyy')                                                                                          as aar_ut,
           to_char(dato_ut,'mm')                                                                                           as mnd_ut,
           to_char(dato_ut,'iw')                                                                                            as w_ut,
           --LOCATION_SEQ_NO  LOC_ID  LOC_BESK  EXPORT_YN
           --3220              V_UTE2_EKSPORT  Vrak for plukking ti  N
           --3300              V_EKSTERN  vrak for henting, har ikke vrak.nr før fullstendig registrering  N
           --null spesial     vare_gruppe_seq_no=1 HOLD og dato_inn (evnt dato_ut etter at Toralv har ryddet opp
           decode (location_seq_no,null, decode(vare_gruppe_seq_no,0, 'HOLD (historiske feil reg. ferdig behandlet)',
                                                                      decode(paa_bil||dato_ut,'J','plukkeliste','solgt')
                                               ),
                                  3220, 'eksport',
                                  3300, 'ekstern',
                                  0   , 'HOLD (p'||chr(229)||' vei mot lager hylle)',  
                                        decode(vare_gruppe_seq_no,0,'HOLD (historiske feil reg. IKKE ferdig behandlet)',
                                                                   'p'||chr(229)||' lager')                                     
                  )                                                                                                         as status,
           count(*)                                                                                                         as ant
    from enhet
    group by decode(vare_gruppe_seq_no,1,'Vrak','Del'),
             to_char(dato_inn,'yyyy'),to_char(dato_inn,'mm'),to_char(dato_inn,'iw'),to_char(dato_ut,'yyyy'),to_char(dato_ut,'mm'),to_char(dato_ut,'iw'),  
             decode (location_seq_no,null, decode(vare_gruppe_seq_no,0, 'HOLD (historiske feil reg. ferdig behandlet)', decode(paa_bil||dato_ut,'J','plukkeliste','solgt')  ), 3220, 'eksport', 3300, 'ekstern', 0 , 'HOLD (p'||chr(229)||' vei mot lager hylle)', decode(vare_gruppe_seq_no,0,'HOLD (historiske feil reg. IKKE ferdig behandlet)',  'p'||chr(229)||' lager')  )
    order by 3,2,1
    /
    select * from v_stat_lager_inn_uy;
    
    create or replace view v_stat_lager_inn_ut_kun as
    select
    /*      APEX master page xxx
            ide fra enhet_xxx.sql
    Dato    Endring
    ===       =======        
    2013_09_21 laget
    */                 
    driver.status,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where t1.status=driver.status and t1.vare='Vrak') as ant_vrak,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where t1.status=driver.status and t1.vare='Del')  as ant_deler,
    sum(ant)                                                                                          as ant_tot
    from v_stat_lager_inn_ut driver
    group by  driver.status
    order by driver.status
    /
    grant select on v_stat_lager_inn_ut_kun to public;
    
    create or replace view v_stat_lager_inn_ut_aar as
    select
    /*      APEX master page xxx
            ide fra enhet_xxx.sql
    Dato    Endring
    ===       =======        
    2013_09_21 laget
    */                 
    driver.aar_inn,
    driver.aar_ut,
    driver.status,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where t1.aar_inn=driver.aar_inn 
                                                    and   t1.aar_ut=driver.aar_ut
                                                    and   t1.status=driver.status and t1.vare='Vrak') as ant_vrak,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where t1.aar_inn=driver.aar_inn 
                                                    and   t1.aar_ut=driver.aar_ut
                                                    and   t1.status=driver.status and t1.vare='Del')  as ant_deler,
    sum(ant)                                                                                          as ant_tot
    from v_stat_lager_inn_ut driver
    group by  driver.aar_inn,driver.aar_ut,driver.status
    order by driver.status,driver.aar_ut,driver.aar_inn
    /
    
    create or replace view v_stat_lager_inn_ut_aar2 as
    select
    /*      APEX master page xxx
            ide fra enhet_xxx.sql
    Dato    Endring
    ===       =======        
    2013_09_21 laget
    2016-01-21 Ullensvang tatt ut aar_inn
    */                 
    --driver.aar_inn,
    driver.aar_ut,
    driver.status,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where 1=1 --t1.aar_inn=driver.aar_inn 
                                                    and   t1.aar_ut=driver.aar_ut
                                                    and   t1.status=driver.status and t1.vare='Vrak') as ant_vrak,
    (select sum(t1.ant) from v_stat_lager_inn_ut t1 where 1=1 --t1.aar_inn=driver.aar_inn 
                                                    and   t1.aar_ut=driver.aar_ut
                                                    and   t1.status=driver.status and t1.vare='Del')  as ant_deler,
    sum(ant)                                                                                          as ant_tot
    from v_stat_lager_inn_ut driver
    --group by  driver.aar_inn,driver.aar_ut,driver.status
    --order by driver.status,driver.aar_ut,driver.aar_inn
    group by  driver.aar_ut,driver.status
    order by driver.status,driver.aar_ut
    
    create or replace view v_stat_lager_inn_ut_aar2 as
    /*
    Dato       Endring
    ===        =======        
    2016-01-21 laget på 30min til Ullensvang julebord
    */
    select driver.aar                                                                                                                                   as aar,
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no=1                                           ) as vrak_inn,
          (select count(*) from enhet where to_char(dato_ut  ,'yyyy') = driver.aar and vare_gruppe_seq_no=1                                           ) as vrak_presset,      
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no=1  and location_seq_no=3300                 ) as vrak_ekstern,  
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no=1  and location_seq_no=695                  ) as vrak_ute1,                  
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no=1  and location_seq_no=3220                 ) as vrak_eksport,                  
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1                                          ) as deler_produsert,      
          (select count(*) from enhet where to_char(dato_ut  ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1 and nvl(salg_via,0)!=22 and vare_gruppe_seq_no!=2829 ) as deler_solgt,      
          (select count(*) from enhet where to_char(dato_ut  ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1 and nvl(salg_via,0) =22 and vare_gruppe_seq_no!=2829 ) as deler_kassert, 
          (select count(*) from enhet where to_char(dato_ut  ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1 and                         vare_gruppe_seq_no =2829 ) as katalysatorer_ut, 
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1 and location_seq_no=0                    ) as deler_hold,      
          (select count(*) from enhet where to_char(dato_inn ,'yyyy') = driver.aar and vare_gruppe_seq_no!=1 and paa_bil='J' and serie_seq_no is Null )  as deler_plukkeliste      
    from (
      --http://blog.jooq.org/2013/07/24/how-to-generate-date-ranges-in-oracle-sql/
      SELECT
      to_char(add_months(input, (level - 1) * 12) ,'yyyy') aar
      FROM (
        -- Set the input date here
        SELECT DATE '1990-01-01' input
        FROM DUAL
      )
      CONNECT BY
        add_months(input, (level - 1) * 12) < sysdate
    ) driver
    order by driver.aar desc
    /
    
----------------------------------------------------------- v_stat_bildeler_via ------------------------------------------------------------------------------------------
    create or replace view v_stat_bildeler_via as
    select
    /*
    2012_06_16 laget
    2012_06_17 lagt inn omløpshastighet
    */
    to_char(dato_ut,'yyyy-mm')                        as yyyy_mm, 
                 via.modus||' '||   via.id            as id,
              funnet.modus||' '||funnet.id            as modus,
              sum(nvl(pris_solgt_inkl_mva,0))         as kr, 
              max_dager_pa_lager.max_omlops_hastighet as maks_dager_pa_lager, 
              min_dager_pa_lager.min_omlops_hastighet as min_dager_pa_lager, 
              count(*) as ant
    from enhet,
         (
         select to_char(dato_ut,'yyyy-mm')         as yyyy_mm,
                 nvl(salg_funnet,-1)              as salg_funnet,
                 nvl(salg_via,-1)                 as salg_via,
                 --tom dato_ut erstattes med dato_inn-1 --> neg svar dersom vi ikke har fått den ut
                max(
                (to_date(to_char(nvl(enhet.dato_ut,enhet.dato_inn-1),'dd.mm.yyyy'),'dd.mm.yyyy') - 
                 to_date(to_char(enhet.dato_inn,   'dd.mm.yyyy'),'dd.mm.yyyy') )   
                 )  as max_omlops_hastighet
          from enhet
          where 1=1
          and   enhet.location_seq_no is null
          and   enhet.vare_gruppe_seq_no <>1
          group by to_char(dato_ut,'yyyy-mm'), salg_funnet,salg_via      
         ) 
         max_dager_pa_lager,
         (
         select to_char(dato_ut,'yyyy-mm')         as yyyy_mm,
                 nvl(salg_funnet,-1)              as salg_funnet,
                 nvl(salg_via,-1)                 as salg_via,
                 --tom dato_ut erstattes med dato_inn-1 --> neg svar dersom vi ikke har fått den ut
                min(
                (to_date(to_char(nvl(enhet.dato_ut,enhet.dato_inn-1),'dd.mm.yyyy'),'dd.mm.yyyy') - 
                 to_date(to_char(enhet.dato_inn,   'dd.mm.yyyy'),'dd.mm.yyyy') )   
                 )  as min_omlops_hastighet
          from enhet
          where 1=1
          and   enhet.location_seq_no is null
          and   enhet.vare_gruppe_seq_no <>1
          group by to_char(dato_ut,'yyyy-mm'), salg_funnet,salg_via      
         ) 
         min_dager_pa_lager,
         enhet_salg funnet,
         enhet_salg via     
    where 1=1
    and   enhet.dato_ut is not null
    --WHERE (ENHET.DATO_UT Is Not Null) AND (ENHET.SALG_FUNNET Is Null) AND (ENHET.SALG_VIA Is Null) AND (ENHET.VARE_GRUPPE_SEQ_NO<>1) AND (ENHET.LOCATION_SEQ_NO Is Null)
    --ORDER BY ENHET.DATO_UT DESC
    --108924, 108924
    --select count(*) from enhet where dato_ut is not null and location_seq_no is not null
    --#602
    --select count(*) from enhet where dato_ut is     null and location_seq_no is     null
    --#340 --på bil
    --kan evnt være solgt å ført tilbake  derfor er ikke dato_ut nok
    and   enhet.location_seq_no is null
    and   enhet.vare_gruppe_seq_no <>1
    and   enhet.salg_funnet = funnet.enhet_salg_seq_no (+)
    and   enhet.salg_via    =    via.enhet_salg_seq_no (+) 
    ---------
    and   to_char(enhet.dato_ut,'yyyy-mm') = max_dager_pa_lager.yyyy_mm (+)
    and   nvl(enhet.salg_funnet,-1)        = max_dager_pa_lager.salg_funnet(+)
    and   nvl(enhet.salg_via,-1)           = max_dager_pa_lager.salg_via (+)    
    ---------
    and   to_char(enhet.dato_ut,'yyyy-mm') = min_dager_pa_lager.yyyy_mm (+)
    and   nvl(enhet.salg_funnet,-1)        = min_dager_pa_lager.salg_funnet(+)
    and   nvl(enhet.salg_via,-1)           = min_dager_pa_lager.salg_via (+)    
    group by to_char(dato_ut,'yyyy-mm'),funnet.modus||' '||funnet.id,via.modus||' '||via.id,max_dager_pa_lager.max_omlops_hastighet,min_dager_pa_lager.min_omlops_hastighet
    order by 1 desc,2,3;
    
    select count(*) from v_stat_bildeler_via;
    #342
    
------------------------------------------------------------v_vendor_data----------------------------------------------------------------------------------------------------------------------------------
    select   t1.vendor_data_seq_no  as vendor_data_seq_no,
      t1.vendor    as vendor,
      t2.vare_gruppe_id   as vare_gruppe_id,
      t1.vendor_data_no  as vendor_data_no,
      substr(t1.vendor,1,9)||'  '||t1.vendor_data_no as id
    from ola.vendor_data t1,
         ola.vare_gruppe t2
    where t1.vare_gruppe_seq_no = t2.vare_gruppe_seq_no
    order by 5;
    
    
    --drop view v_vendor_data;
    create or replace view v_vendor_data as
        select
            /*
            Dato          Endring
            ===        =======
            2006_01_18 legger index på enhet(vare_gruppe_seq_no,vendor_data_seq_no)
            2006_01_19 decodet quota_wanted ->0 og byttet ut intersect med union
            2016_06_04 drygt tregt på 12c
            */
            (select t2.vendor_seq_no
              from vendor t2,
                   vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.vendor_seq_no        = t2.vendor_seq_no)             as vendor_seq_no,
            (select t2.vendor
              from vendor t2,
                   vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.vendor_seq_no        = t2.vendor_seq_no)             as vendor,
              driver.vendor_data_seq_no                                        as vendor_data_seq_no,
            (select t1.vendor_data_no
              from vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no)    as vendor_data_no,
            (select t1.vare_gruppe_seq_no
              from vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no)    as vare_gruppe_seq_no,
            (select t2.vare_gruppe_id
              from vare_gruppe t2,
                   vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.vare_gruppe_seq_no   = t2.vare_gruppe_seq_no)        as vare_gruppe_id,
              --antall som ønskes på lager
              -- NB må konvertere null --> 0 ellers blir sorteringen sprø
             (select decode(t1.quota,null,0,t1.quota)
              from vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no)    as quota_wanted,
             (select count(*)
              from enhet t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.location_seq_no      is not null)                    as quota_on_stock,
              --manko= grense - på lager = 1 - 0 = 1 bestilles
              --       quota  - count    = 3 - 1 = 2 bestilles
              --ønsker bare positive tall sign gir enten -1,0, eller 1 eller null 
            decode(sign(
             (select decode(t1.quota,null,0,t1.quota)
              from vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no) -
              (select count(*)
              from enhet t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.location_seq_no      is not null)  
                        )
            ,1,              
             (select decode(t1.quota,null,0,t1.quota)
              from vendor_data t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no) -
              (select count(*)
              from enhet t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.location_seq_no      is not null)  
            ,0)                       as request,
             (select count(*)
              from enhet t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.location_seq_no      is null)                        as quota_sold,
             (select count(*)
              from enhet t1
              where t1.vendor_data_seq_no      = driver.vendor_data_seq_no
              and      t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
              and      t1.location_seq_no      is null
              and      to_char(dato_ut,'yyyy') =2006)                          as quota_sold_2006
        from       vendor_data driver
        where vendor_data_seq_no=3  --kun spes dekk 2018_10_14
        order by 4,5
    /
      
------------------------------------------------------------v_vendor-----------------------------------------------------------------------------------------------------------------------------------
        create or replace view v_vendor as
        select
        /*
        Dato          Endring
        ===        =======
        2014_03_04 laget til apex ny versjon bildeleprogram
        */
          -- vendor.vendor, vendor_data.vare_gruppe_seq_no, vendor_data.pris_umva, vendor_data.pant, vendor_data.quota, vendor_data.notes, 
          vendor_data.vendor_data_seq_no                  as vendor_data_seq_no,
          vendor_data.vare_gruppe_seq_no                  as vare_gruppe_seq_no,
          vendor.vendor                                   as vendor,
          vare_gruppe_id                                  as vare_gruppe_id,
          nvl2(vendor_data_no  ,                                                   vendor_data_no                 , null ) ||
          nvl2(pris_inkl_mva   ,nvl2(vendor_data_no                 , '  ' ,null)||round(pris_inkl_mva,0)||'iMVA' , null ) ||
          nvl2(pant            ,nvl2(vendor_data_no||pris_inkl_mva  , ' +' ,null)||round(pant,0)||'pant'          , null ) ||' '||vare_gruppe_id||' '||vendor.vendor as vendor_data_c
        from ola.vendor vendor, 
             ola.vendor_data vendor_data,
             ola.vare_gruppe
        where vendor_data.vendor_seq_no = vendor.vendor_seq_no
        and   vendor_data.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no
        order by vendor_data.vendor_data_no


        truncate table plan_table;
        explain plan              
        set statement_id='732'    
        into plan_table for                       
        select * from v_vendor;
        commit;                   

        select (select count(*)
          from enhet t1
          where t1.vendor_data_seq_no  = driver.vendor_data_seq_no
          and   t1.vare_gruppe_seq_no   = driver.vare_gruppe_seq_no
          and  t1.location_seq_no  is null
          and   to_char(dato_ut,'yyyy') =2006)        as quota_sold_2006
        from  --drivende utvalg
          (select vendor_data_seq_no as vendor_data_seq_no, vare_gruppe_seq_no as vare_gruppe_seq_no from enhet
           intersect
           select vendor_data_seq_no, vare_gruppe_seq_no from vendor_data )driver
        ;
            commit;

        eller
        set linesize 3500        
        set pagesize 9999                         
        set array 1                               
        set ti on
        set wra off
        set autotrace trace exp stat              
    
--  T_DATO_DRV  kopi lso rapport 733 t_MISSING_DATO_DRV  -
    -----------------------------------------------------------------
    create table T_DATO_DRV (
       SEQ_NO               NUMBER(8)                       not null,
       constraint PK_T_DATO_DRV primary key (SEQ_NO)
    )
    /
    
    --truncate table t_dato_drv;
    
    --bygge opp ONLINE  (uten io erstattes &ant_aar med 20 (2000, 2001,2002)
    ------------------ 
    declare
    i      number(8) :=0 ;
    siste_rec   number(8) :=0;
    begin 
      siste_rec := (&ant_aar * 365 )+ 10;
    
      for i in 0 .. siste_rec loop
        insert into t_dato_drv values( i);
        --dbms_output.put_line('Feil '||i);
      end loop;
     commit;
        
    end;
    /
    
    
    -----------------------------------------------------------------
      V_DATO_DRV    kopi lso rapport 733 Missing  -
    -----------------------------------------------------------------
    create or replace view v_dato_drv as
    select  
    /* ***********************************************************************
    ** Application  : ALBATROSS/SO 
    ** Object       : v_dato_drv
    ** File         : obv_v_xx.sql
    ** Purpose      : 
    ** Programmer   : TML
    ** Dependency   : T_DATO_DRV
    ** Object used in             : statistic
    ** Source used as template in : 
    ** Source inheritated from    : 
              inheritance override: 
    ** Changed by:  Date:      Description:
    ** 25-10-2003 table ford_periode f_p.fom substituted with to_date('28.04.2003','dd.mm.yyyy') 
    ** select min(dato_inn) from enhet; -->28.04.2003
    ** select min(dato_inn) from enhet; -->30.04.2003
    ** 
    ** 28-10-2003 starter 18.01.1998 i enhet to_char(dato_inn,'ww') --> uke 22 --> må starte 17.01.1992
    ** **********************************************************************/
      to_date('17.01.1992','dd.mm.yyyy') + rownum -1        as dato,
      to_number(to_char(to_date('17.01.1992','dd.mm.yyyy') + rownum -1,'iyyy'))  as iso_aar, 
      to_number(to_char(to_date('17.01.1992','dd.mm.yyyy') + rownum -1,'yyyy'))  as aar, 
      to_number(to_char(to_date('17.01.1992','dd.mm.yyyy') + rownum -1,'iw'))    as iso_ukenr, 
      to_number(to_char(to_date('17.01.1992','dd.mm.yyyy') + rownum -1,'ww'))    as ukenr, 
      to_number(to_char(to_date('17.01.1992','dd.mm.yyyy') + rownum -1,'d'))  as dag, 
      rownum -1    as nr,
      to_date('17.01.1992','dd.mm.yyyy')      as fom
    from   t_dato_drv   dummy  --tabell som har drygt med forekomster
    --Aktiv tidsperiode for saldooppgjøret
    --where   f_p.hist_dato is null
    --Datoer frem til dagens dato
    --Kriteriet her flyttes helt til slutten av kjeden da Oracle gir oss samme eksekveringsplan
    --kjeden blir dermed mer generell 
    --and  f_p.fom + rownum -1 <= to_date(' ampersand dato','yyyy.mm.dd')
    where  to_date('17.01.1992','dd.mm.yyyy') + rownum -1 <=sysdate
    /
    
    --Teste iso 
    select   to_char(to_date('2 1 2000','dd mmyyyy'),'yyyy') aar,
      to_char(to_date('2 1 2000','dd mmyyyy'),'iyyy') aar_iso,
      to_char(to_date('2 1 2000','dd mmyyyy'),'ww') ukenr,
      to_char(to_date('2 1 2000','dd mmyyyy'),'iw') ukenr_iso
    from dual;
    
    set ti on
    select count(*) from v_missing_dato_drv;
    
    -------------------------
    -  V_OMSETNING_PR_UKE   -
    -------------------------
    --NB IKKE iso år / uke
    
    create or replace view v_omsetning_pr_uke as
    select   drv.aar    as aar,
      drv.ukenr  as ukenr,
      inn_vrak.ant_inn_vrak    as ant_inn_vrak,
      ut_vrak.ant_ut_vrak    as ant_ut_vrak,
      inn_del.ant_inn_del    as ant_inn_del,
      ut_del.ant_ut_del    as ant_ut_del
    from (   select   aar   as aar, 
        ukenr  as ukenr
      from v_dato_drv
      group by aar, ukenr  ) drv,
         ( select  to_char(dato_inn,'yyyy') as aar,
              to_char(dato_inn,'ww')   as ukenr,
              count(dato_inn)     as ant_inn_vrak
           from enhet
           --Vrak 
           where vare_gruppe_seq_no = 1  --er not null
           group by to_char(dato_inn,'yyyy'), to_char(dato_inn,'ww') )inn_vrak,
         ( select  to_char(dato_ut,'yyyy') as aar,
              to_char(dato_ut,'ww')   as ukenr,
              count(dato_ut)    as ant_ut_vrak
           from enhet
           --Vrak 
           where vare_gruppe_seq_no = 1  --er not null
           group by to_char(dato_ut,'yyyy'), to_char(dato_ut,'ww') )ut_vrak,
         ( select  to_char(dato_inn,'yyyy') as aar,
              to_char(dato_inn,'ww')   as ukenr,
              count(dato_inn)     as ant_inn_del
           from enhet
           --Del
           where vare_gruppe_seq_no != 1  --er not null
           group by to_char(dato_inn,'yyyy'), to_char(dato_inn,'ww') )inn_del,
         ( select  to_char(dato_ut,'yyyy') as aar,
              to_char(dato_ut,'ww')   as ukenr,
              count(dato_ut)    as ant_ut_del
           from enhet
           --del
           where vare_gruppe_seq_no != 1  --er not null
           group by to_char(dato_ut,'yyyy'), to_char(dato_ut,'ww') )ut_del
    where   drv.aar    = inn_vrak.aar  (+)
    and  drv.ukenr  = inn_vrak.ukenr(+)
    and  drv.aar    = ut_vrak.aar   (+)
    and  drv.ukenr  = ut_vrak.ukenr (+)
    and   drv.aar    = inn_del.aar   (+)
    and  drv.ukenr  = inn_del.ukenr (+)
    and  drv.aar    = ut_del.aar    (+)
    and  drv.ukenr  = ut_del.ukenr  (+)
    /
    
    order by drv.aar, drv.ukenr
    
    -------------------------
    -  V_OMSETNING_PR_AAR   -
    -------------------------
    --NB IKKE iso år / uke
    
    
    create or replace view v_omsetning_pr_aar as
    select  drv.aar        as aar,    
          inn_vrak.inn_vrak          as     inn_vrak,
      akk_inn_vrak.akk_inn_vrak  as akk_inn_vrak,
          inn_del.inn_del    as     inn_del,
      akk_inn_del.akk_inn_del    as akk_inn_del,
          ut_del.ut_del    as     ut_del,
      akk_ut_del.akk_ut_del    as akk_ut_del
    from   (select aar  as aar                                     
       from v_dato_drv                                           
       group by aar    )             drv,               
      (
      select  to_char(dato_inn,'yyyy') as aar,                  
                count(dato_inn)     as inn_vrak
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no = 1  --er not null             
               group by to_char(dato_inn,'yyyy') 
       )                  inn_vrak,                              
            ( 
      select  drv.aar        as aar,        
        sum(inn_vrak.inn_vrak)    as akk_inn_vrak
      from   (select aar  as aar                                    
         from v_dato_drv                                          
         group by aar    ) drv,                            
             ( select  to_char(dato_inn,'yyyy') as aar,                  
                count(dato_inn)     as inn_vrak
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no = 1  --er not null             
               group by to_char(dato_inn,'yyyy') )inn_vrak               
      where  drv.aar  >= inn_vrak.aar(+)   --akkumuler hittil løpende
      group by drv.aar                                                  
      )                   akk_inn_vrak,
      (
      select  to_char(dato_inn,'yyyy') as aar,                  
                count(dato_inn)     as inn_del               
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no != 1  --er not null             
               group by to_char(dato_inn,'yyyy')
       )                  inn_del,               
            ( 
      select  drv.aar        as aar,        
        sum(inn_del.inn_del)    as akk_inn_del            
      from   (select aar  as aar                                    
         from v_dato_drv                                          
         group by aar    ) drv,                            
             ( select  to_char(dato_inn,'yyyy') as aar,                  
                count(dato_inn)     as inn_del               
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no != 1  --er not null             
               group by to_char(dato_inn,'yyyy') )inn_del               
      where  drv.aar  >= inn_del.aar(+)   --akkumuler hittil løpende
      group by drv.aar                                                  
      )                   akk_inn_del,
      (
      select  to_char(dato_ut,'yyyy')  as aar,                  
            count(dato_ut)     as ut_del                
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no != 1  --er not null             
               group by to_char(dato_ut,'yyyy') 
      )                  ut_del,                 
      (
      select  drv.aar        as aar,                   
        sum(ut_del.ut_del)    as akk_ut_del             
      from   (select aar  as aar                                    
         from v_dato_drv                                          
         group by aar    ) drv,                            
             ( select  to_char(dato_ut,'yyyy')  as aar,                  
            count(dato_ut)     as ut_del                
               from enhet                                               
               --Del                                                    
               where vare_gruppe_seq_no != 1  --er not null             
               group by to_char(dato_ut,'yyyy') )ut_del                 
      where  drv.aar  >= ut_del.aar(+)   --akkumuler hittil løpende
      group by drv.aar                                                  
      )                   akk_ut_del
    where  drv.aar  =     inn_vrak.aar(+)   
    and  drv.aar  = akk_inn_vrak.aar(+)   
    and   drv.aar  =     inn_del.aar(+)   
    and   drv.aar  = akk_inn_del.aar(+)   
    and   drv.aar  =     ut_del.aar(+)   
    and   drv.aar  = akk_ut_del.aar(+)   
    /
    order by 1
    
    --samme eksekveringsplan som distinvt aar from enhet
    
    select  drv.aar        as aar,        select  drv.aar        as aar,                   
      sum(inn_del.inn_del)    as akk_inn_del                    sum(ut_del.ut_del)    as akk_ut_del            
    from   (select aar  as aar                                          from   (select aar  as aar                                    
       from v_dato_drv                                                   from v_dato_drv                                          
       group by aar    ) drv,                                     group by aar    ) drv,                            
           ( select  to_char(dato_inn,'yyyy') as aar,                               ( select  to_char(dato_ut,'yyyy')  as aar,                  
              count(dato_inn)     as inn_del                           count(dato_ut)     as ut_del           
             from enhet                                                              from enhet                                               
             --Del                                                                   --Del                                                    
             where vare_gruppe_seq_no != 1  --er not null                            where vare_gruppe_seq_no != 1  --er not null             
             group by to_char(dato_inn,'yyyy') )inn_del                              group by to_char(dato_ut,'yyyy') )ut_del               
    where  drv.aar  >= inn_del.aar(+)   --akkumuler hittil løpende      where  drv.aar  >= ut_del.aar(+)   --akkumuler hittil løpende
    group by drv.aar                                                        group by drv.aar                                                  
    ;                  ;
    
    
            
    
    
    
    -------------------------
    -  LEGGE på DATOER -
    -------------------------
    
    select lbk.omsetning.fil, min(lbk.omsetning.seq_no),max(lbk.omsetning.seq_no),count(lbk.omsetning.seq_no) from lbk.omsetning group by lbk.omsetning.fil;
    FIL         MIN  max  ant 
    inn_1999  1,  1064,  844,
    inn_2000  1,  5819,  3793,
    inn_2001  1,  10257,  6721,
    inn_2002  1,  15237,  9359,
    inn_2003  1,  18597,  11760,
    
    --drop table t_omsetning ;
    create table t_omsetning (
       SEQ_NO               NUMBER(8)                       not null,
       vare      varchar2(8),
       inne_ute    varchar2(8),
       fil      varchar2(32),
       constraint PK_t_omsetning primary key (SEQ_NO)
    )
    /
    --drop table tt_omsetning ;
    create table tt_omsetning (
       SEQ_NO               NUMBER(8)                       not null,
       vare      varchar2(8),
       inne_ute    varchar2(8),
       fil      varchar2(32),
       constraint PK_tt_omsetning primary key (SEQ_NO)
    )
    /
    
    --drop table omsetning_gogo ;
    create table omsetning_gogo (
       SEQ_NO               NUMBER(8)                       not null,
       vare      varchar2(8),
       inne_ute    varchar2(8),
       fil_inn      varchar2(32),
       dato_inn date,
       fil_ut      varchar2(32),
       dato_ut date,
       constraint PK_omsetning_gogo primary key (SEQ_NO)
    )
    /
    
    
    --1999                --2000                                                      --2001                                                      --2002                                                     --2003                                                      
    ------                                                          ------                                                          ------                                                          ------                                                          ------                                                    
      DEL INNE                                                  DEL INNE                                                  DEL INNE                                                  DEL INNE                                                  DEL INNE                                          
      -------                                                   -------                                                   -------                                                   -------                                                   -------                                           
    truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                               
    insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                   
    select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                    
    from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                            
    where vare='del'                                                where vare='del'                                                where vare='del'                                                where vare='del'                                                where vare='del'                                          
    and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                    
    group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                            
    having min(fil)='inn_1999';      --<<---         having min(fil)='inn_2000';      --<<---         having min(fil)='inn_2001';      --<<---         having min(fil)='inn_2002';      --<<---         having min(fil)='inn_2003';      --<<---   
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                   
    --#173  --> dato_inn = 1.1.1999      --<<---         --#2355  --> dato_inn = 1.1.2000      --<<---         --#2302  --> dato_inn = 1.1.2001      --<<---         --#1940  --> dato_inn = 1.1.2002      --<<---         --#1637  --> dato_inn = 1.1.2003      --<<---   
                                                                                                                                                                                                                                                                                                                              
    overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                       
    -------------------                                             -------------------                                             -------------------                                             -------------------                                             -------------------                                       
    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                              
    insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                  
    -->>>sjekk denne manuelt først order by  min(b.fil)             -->>>sjekk denne manuelt først  order by  min(b.fil)            -->>>sjekk denne manuelt først  order by  min(b.fil)            -->>>sjekk denne manuelt først  order by  min(b.fil)            -->>>sjekk denne manuelt først  order by  min(b.fil)        
    select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                  
    from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                      
    where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                    
    and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)        
    group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                     
    --#98                                                          --#923                                                          --#629                                                          --#328                                                          --#0                                                    
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                   
                                                                                                                                                                                                                                                                                                                              
    --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                    
    ------                                                          ------                                                          ------                                                          ------                                                          ------                                                    
    insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                
    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                              
    fil,to_date('01.01.1999','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2000','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2001','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2002','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2003','dd.mm.yyyy'),null,null--<<---   
    from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                         
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                   
    --#173                                                          --#2355                                                         --#2302                                                         --#1940                                                         --#1940                                                   
                                                                                                                                                                                                                                                                                                                              
    update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                
    set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                      
    decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),
          'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),
          'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),
          'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))
    from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                      
    where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                             
    where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                
    and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                
          where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                  
    #98                                                          #923                                                      #629                                                          #629                                                          #0                                                    
    
    
    TRØBBEL
    3250  vrak  ute  inn_2000
    5406  vrak  ute  inn_2000
    5419  vrak  ute  inn_2000
    5425  vrak  ute  inn_2000
    5429  vrak  ute  inn_2000
    5433  vrak  ute  inn_2000
    
    --1999                --2000                --2001                --2002                --2003                  
    ------                                                          ------                                                          ------                                                          ------                                                          ------                                                          
      VRAK INNE                                                 VRAK INNE                                                 VRAK INNE                                                 VRAK INNE                                                 VRAK INNE                                               
      --------                                                  --------                                                  --------                                                  --------                                                  --------                                                
    truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     
    insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         
    select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          
    from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                                  
    where vare='vrak'                                               where vare='vrak'                                               where vare='vrak'                                               where vare='vrak'                                               where vare='vrak'                                               
    and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                          and   inne_ute='inne'                                          
    group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  
    having min(fil)='inn_1999';      --<<---         having min(fil)='inn_2000';      --<<---         having min(fil)='inn_2001';      --<<---         having min(fil)='inn_2002';      --<<---         having min(fil)='inn_2003';      --<<---         
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                         
    --#175  --> dato_inn = 1.1.1999      --<<---         --#106  --> dato_inn = 1.1.2000      --<<---         --#234  --> dato_inn = 1.1.2001      --<<---         --#227  --> dato_inn = 1.1.2002      --<<---         --#  --> dato_inn = 1.1.2003      --<<---         
                                                                                                                                                                                                                                                                                                                                    
    overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             
    -------------------                                             -------------------                                             -------------------                                             -------------------                                             -------------------                                             
    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    
    insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        
    -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)              -->>>sjekk denne manuelt først order by  min(b.fil)             -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)                       
    select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        
    from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            
    where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          
    and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              
    group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           
    --#173                                                          --#105                                                          --#225                                                          --#173                                                          --#0                                                          
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                         
                                                                                                                                                                                                                                                                                                                                    
    --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                          
    ------                                                          ------                                                          ------                                                          ------                                                          ------                                                          
    insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      
    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    
    fil,to_date('01.01.1999','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2000','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2001','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2002','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.01.2003','dd.mm.yyyy'),null,null--<<---         
    from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                         
    --#175                                                          --#105                                                          --#234                                                          --#175                                                          --#                                                          
                                                                                                                                                                                                                                                                                                                                    
    update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      
    set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            
    decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      decode(fil, 'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      
          'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),      
          'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),      
          'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))      
    from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            
    where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   
    where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      
    and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      
          where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                        
    #173                                                          #105                                                          #225                                                          #173                                                          #                                                          
    
    Kontroll vi mangler dato på de som går inn/ut i løpet av samme år
    =================================================================
    select distinct seq_no from lbk.omsetning;
    #11764
    
    select count(*) from lbk.omsetning_gogo;
    #9352
    
    select distinct seq_no from lbk.omsetning
    minus
    select seq_no from lbk.omsetning_gogo;
    # 11764 - 9352 = 2412 stemmer med listing
    
    select fil 
    from omsetning
    where seq_no in(
      select distinct seq_no from lbk.omsetning
      minus
      select seq_no from lbk.omsetning_gogo)
    order by 1,2,3  ;
    
    --1999 VRAK DEL              --2000 VRAK DEL              --2001 VRAK DEL              --2001 VRAK DEL              --2002 VRAK DEL                --2003 VRAK DEL                    
    ---------------                                                 ---------------                                                 ---------------                                                 ---------------                                                 ---------------                                                         ---------------                                                      
      INNE                                                      INNE                                                      INNE                                                      INNE                                                      INNE                                                              INNE                                                    
      -----                                                     -----                                                     -----                                                     -----                                                     -----                                                             -----                                                   
    truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                     truncate table t_omsetning;                                             truncate table t_omsetning;                                     
    insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                         insert into t_omsetning                                                 insert into t_omsetning                                         
    select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                          select seq_no,vare, inne_ute, min(fil)                                  select seq_no,vare, inne_ute, min(fil)                          
    from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                                  from omsetning                                                          from omsetning                                                  
    where seq_no in(                                                where seq_no in(                                                where seq_no in(                                                where seq_no in(                                                where seq_no in(                                                        where seq_no in(                                                
      select distinct seq_no from lbk.omsetning                 select distinct seq_no from lbk.omsetning                 select distinct seq_no from lbk.omsetning                 select distinct seq_no from lbk.omsetning                 select distinct seq_no from lbk.omsetning                         select distinct seq_no from lbk.omsetning               
      minus                                                     minus                                                     minus                                                     minus                                                     minus                                                             minus                                                   
      select seq_no from lbk.omsetning_gogo)                    select seq_no from lbk.omsetning_gogo)                    select seq_no from lbk.omsetning_gogo)                    select seq_no from lbk.omsetning_gogo)                    select seq_no from lbk.omsetning_gogo)                            select seq_no from lbk.omsetning_gogo)                  
    group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                  group by seq_no,vare, inne_ute                                          group by seq_no,vare, inne_ute                                  
    having min(fil)='inn_1999';         --<<---   having min(fil)='inn_2000';        --<<---  having min(fil)='inn_2001';        --<<---  having min(fil)='inn_2001';        --<<---  having min(fil)='inn_2002';        --<<---          having min(fil)='inn_2003';        --<<---         
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                                 commit;                                                         
    --#496  --> dato_inn = 1.6.1998         --<<---      --#490  --> dato_inn = 1.6.1999        --<<--- --#393  --> dato_inn = 1.6.2000        --<<--- --#393  --> dato_inn = 1.6.2000        --<<--- --#471  --> dato_inn = 1.6.2001        --<<---         --#562  --> dato_inn = 1.6.2002        --<<---         
                                                                                                                                                                                                                                                                                                                                                                                                            
    overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                             overnevnte deler UT                                                     overnevnte deler UT                                             
    -------------------                                             -------------------                                             -------------------                                             -------------------                                             -------------------                                                     -------------------                                             
    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                    truncate table tt_omsetning;                                            truncate table tt_omsetning;                                    
    insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                        insert into tt_omsetning                                                insert into tt_omsetning                                        
    -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)     -->>>sjekk denne manuelt først order by  min(b.fil)             -->>>sjekk denne manuelt først order by  min(b.fil)     
    select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                        select seq_no, vare,inne_ute, min(b.fil)                                select seq_no, vare,inne_ute, min(b.fil)                        
    from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                            from lbk.omsetning b                                                    from lbk.omsetning b                                            
    where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                          where b.inne_ute='ute'                                                  where b.inne_ute='ute'                                          
    and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)              and seq_no in (select seq_no from lbk.t_omsetning)                      and seq_no in (select seq_no from lbk.t_omsetning)              
    group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                           group by b.seq_no,b.vare, b.inne_ute;                                   group by b.seq_no,b.vare, b.inne_ute;                           
    --#496                                                          --#490                                                          --#393                                                          --#393                                                          --#471                                                                  --#562                                                          
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                                 commit;                                                         
                                                                                                                                                                                                                                                                                                                                                                                                            
    --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                          --gogo                                                                  --gogo                                                          
    ------                                                          ------                                                          ------                                                          ------                                                          ------                                                                  ------                                                          
    NBNB sjekk at alt er UTE i tt og t omsetninng                   NBNB sjekk at alt er UTE i tt og t omsetninng                   NBNB sjekk at alt er UTE i tt og t omsetninng                   NBNB sjekk at alt er UTE i tt og t omsetninng                   NBNB sjekk at alt er UTE i tt og t omsetninng                           NBNB sjekk at alt er UTE i tt og t omsetninng                                                   
    insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                      insert into omsetning_gogo                                              insert into omsetning_gogo                                      
    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                    select seq_no,vare,inne_ute,                                            select seq_no,vare,inne_ute,                                    
    fil,to_date('01.06.1998','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.06.1999','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.06.2000','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.06.2000','dd.mm.yyyy'),null,null--<<---         fil,to_date('01.06.2001','dd.mm.yyyy'),null,null--<<---                 fil,to_date('01.06.2002','dd.mm.yyyy'),null,null--<<---         
    from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                               from t_omsetning;                                                       from t_omsetning;                                               
    commit;                                                         commit;                                                         commit;                                                         commit;                                                         commit;                                                                 commit;                                                         
    --#496                                                         --#490                                                           -#393                                                           -#393                                                           -#471                                                                   -#562                                                           
                                                                                                                                                                                                                                                                                                                                                                                                            
    update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                      update omsetning_gogo gogo                                              update omsetning_gogo gogo                                      
    set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                            set (fil_ut, dato_ut) = (select fil,                                    set (fil_ut, dato_ut) = (select fil,                            
    decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),      decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),      decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),      decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),      decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),              decode(fil, 'inn_1999',to_date('31.12.1998','dd.mm.yyyy'),      
          'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),            'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),            'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),            'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),            'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),                    'inn_2000',to_date('31.12.1999','dd.mm.yyyy'),      
          'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),            'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),                    'inn_2001',to_date('31.12.2000','dd.mm.yyyy'),      
          'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),            'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),                    'inn_2002',to_date('31.12.2001','dd.mm.yyyy'),      
          'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))            'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))                    'inn_2003',to_date('31.12.2002','dd.mm.yyyy'))      
    from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                            from tt_omsetning tt                                                    from tt_omsetning tt                                            
    where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                   where tt.seq_no =gogo.seq_no)                                           where tt.seq_no =gogo.seq_no)                                   
    where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                      where gogo.dato_ut is null                                              where gogo.dato_ut is null                                      
    and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                      and exists (select 'x' from tt_omsetning t                              and exists (select 'x' from tt_omsetning t                      
          where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                              where t.seq_no=gogo.seq_no);                                      where t.seq_no=gogo.seq_no);                        
    #496                                                          #490                                                          #393                                                          #393                                                          #471                                                                  #562                                                          
                                                                                                                                    
                                                                                                                                    
    
    select min(dato_inn), max(dato_inn)    select min(dato_inn), max(dato_inn)     
    from enhet                                      from enhet                              
    where to_char(dato_inn,'hh24') = '00'           where to_char(dato_inn,'hh24') != '00'   
    order by min(dato_inn), max(dato_inn);          order by min(dato_inn), max(dato_inn);      
    01.06.1998 28.02.2003                     28.04.2003 27.10.2003                                                                                                                                                                                                                                             
    
    select min(dato_ut), max(dato_ut)    select min(dato_ut), max(dato_ut)     
    from enhet                                      from enhet                              
    where to_char(dato_ut,'hh24') = '00'            where to_char(dato_ut,'hh24') != '00'   
    order by min(dato_ut), max(dato_ut);            order by min(dato_ut), max(dato_ut);      
    31.12.1998 31.12.2002        30.04.2003 28.10.2003
    
    --sletter alt mindre enn 1.3.2003
    select count(*)            select count(*)                                      
    from enhet                                              from enhet                                           
    where dato_inn < to_date('01.03.2003','dd.mm.yyyy');    where dato_ut < to_date('01.03.2003','dd.mm.yyyy'); 
    12624 resten 1806 28.10.03        5084 resten 1266 28.10.03
    
    --Fire Fire
    
    alter table enhet disable all triggers;
    alter table enhet enable all triggers;
    
    update enhet set dato_inn=null        update enhet set dato_ut= null
    where dato_inn < to_date('01.03.2003','dd.mm.yyyy');    where dato_ut < to_date('01.03.2003','dd.mm.yyyy'); 
    #12624              #5084
    
    
    --ut TARGA3-LBK
    exp73 system/manager@targa3 tables=lbk.omsetning_gogo file=omsetning_go_go
    --inn TARGA3-OLA
    imp73   system/manager@targa3  fromuser=lbk  touser=ola   ignore=Y   file=omsetning_go_go.dmp   commit=Y      log=omsetning_go_go.imp_log
    imp73   system/manager@compaq1  fromuser=lbk  touser=ola   ignore=Y   file=omsetning_go_go.dmp   commit=Y      log=omsetning_go_go.imp_log
    sjekke avikene
    select t2.seq_no,t2.dato_inn                     select t2.seq_no,t2.dato_ut                 
    from   omsetning_gogo t2,                                              from   omsetning_gogo t2,               
      enhet t1                                                          enhet t1                         
    where   t2.dato_inn is not null                                         where   t2.dato_ut is not null          
    and  t2.seq_no = t1.enhet_seq_no (+)                                 and  t2.seq_no = t1.enhet_seq_no (+)  
    and  t1.dato_inn  is not null                                        and  t1.dato_ut  is not null         
    #0                  #1      170 31.12.1998
    select seq_no from omsetning_gogo where dato_inn is not null    select seq_no from omsetning_gogo where dato_ut is not null
    minus                                                                   minus                                                       
    select enhet_seq_no from enhet;                                         select enhet_seq_no from enhet;                             
          595                881
          881
         5324
         7489
         
    update enhet t1 set dato_inn = (        update enhet t1 set dato_ut = (                         
        select t2.dato_inn                                  select t2.dato_ut                       
        from   omsetning_gogo t2                           from   omsetning_gogo t2                
        where   t2.dato_inn is not null                     where   t2.dato_ut is not null          
        and   t2.seq_no = t1.enhet_seq_no )               and   t2.seq_no = t1.enhet_seq_no )    
        --gir 11764                                         --gir 5079                              
    where t1.dato_inn is null                                       where t1.dato_ut is null                                
    and exists (  select 'x'                                      and exists (  select 'x'                               
        from   omsetning_gogo t2                           from   omsetning_gogo t2                
        where   t2.dato_inn is not null                     where   t2.dato_ut is not null          
        and   t2.seq_no = t1.enhet_seq_no);               and   t2.seq_no = t1.enhet_seq_no);    
    #11760 ref 4 er forsvunner helt i enhet på disse årene    #5077
    
    --NB 1 mangler inn
    ------
    Alle de med tom dato må være kommet inn etter 1.1.2003
    update enhet set dato_inn = to_date('28.2.2003','dd.mm.yyyy')
    where dato_inn is null;
    
    -- NB 2 mangler ut NBNB dette er er kun de som er kommet inn og gått ut i 20003
    -------
    hvilke ser solgt i løpet av 2003 frem til 30.4.2003
    select max(seq_no) from omsetning_gogo;
    18567
    
    select enhet_seq_no from enhet
    where dato_ut is null
    and location_seq_no is null
    and enhet_seq_no > 18567;
    #84 selges 28.2.2003
    
    update enhet set dato_ut = to_date('28.2.2003','dd.mm.yyyy')
    where dato_ut is null
    and location_seq_no is null
    and enhet_seq_no > 18567;
    
    --Må slettes før eller siden
    --drop table enhet_2003_10_27;
    --drop table ola.omsetning_gogo;
    
    
    --NB 3 MEN hva med de som faller gjennom NB 2 de som er kommet på lager i tidligere år
    -------
    select count(*)
    from enhet
    where dato_ut is null
    and location_seq_no is null
    and enhet_seq_no <= 18567;
    #436
    
    SELECT ENHET.DATO_UT, ENHET.LOCATION_SEQ_NO, ENHET.ENHET_SEQ_NO, ENHET.DATO_INN, OMSETNING.FIL, OMSETNING.INNE_UTE
    FROM OLA.ENHET ENHET, LBK.OMSETNING OMSETNING
    WHERE OMSETNING.SEQ_NO = ENHET.ENHET_SEQ_NO AND ((ENHET.DATO_UT Is Null) AND (ENHET.LOCATION_SEQ_NO Is Null) AND (ENHET.ENHET_SEQ_NO<=18676))
    ORDER BY ENHET.ENHET_SEQ_NO, ENHET.DATO_INN, OMSETNING.FIL
    
    alter table enhet disable all triggers;
    
    update enhet set dato_ut = to_date('28.2.2003','dd.mm.yyyy')
    where dato_ut is null
    and location_seq_no is null
    and dato_ut is null
    and enhet_seq_no <= 18567;
    
    alter table enhet enable all triggers;
    
    NB4 gamle vrak fra skraphandlerbok 30.11.2003
    ---
       1992    93  94  95  96  97  98  99  00  01  02   03
    fra   1    63  121  228  319  386  517  600  1846  2097  2548  3107
    til   62    120  227  318  385  516  599  1845  2096  2547  3106
    dato_inn 18.01.92  01.01.93            xxxxxxxxxxxxxxxxxxxx
    dato_ut  31.12.92  31.12.93          xxxxxxxxxxxxxxxxxxxxxxxxxxxx  
    
    status i dag
    select  to_char(dato_inn,'yyyy'), to_char(dato_ut,'yyyy'),
      min(serie_no),max(serie_no), count(*)          1998  2628,  491,  skal være 599                                                                        
    from   enhet e,                                                     1999  1812,  242,     ''  1845                                                                  
      serie s                                                     2000  2038,  111,    ''  2096                                                                
    where vare_gruppe_seq_no=1                                           2001  2406,  459,  ''  2547                                                                  
    and e.serie_seq_no = s.serie_seq_no (+)                              2002  3014,  580,  ''  3107                                                                  
    --and serie_no <1600                                                 2003  3737,  836,  ''                                                                            
    group by to_char(dato_inn,'yyyy'),to_char(dato_ut,'yyyy')                
    order by 1,2                             
    
    alter table enhet disable all triggers;
    --1992              --1993                                             --1994                                             --1995                    --1996                                             --1997                                                  
    update enhet e set                                     update enhet e set                                      update enhet e set                                      update enhet e set                                      update enhet e set                                      update enhet e set                                  
    e.dato_inn = to_date('18.01.1992','dd.mm.yyyy'),        e.dato_inn = to_date('01.01.1993','dd.mm.yyyy'),        e.dato_inn = to_date('01.01.1994','dd.mm.yyyy'),        e.dato_inn = to_date('01.01.1995','dd.mm.yyyy'),        e.dato_inn = to_date('01.01.1996','dd.mm.yyyy'),        e.dato_inn = to_date('01.01.1997','dd.mm.yyyy'),    
    e.dato_ut  = to_date('31.12.1992','dd.mm.yyyy')         e.dato_ut  = to_date('31.12.1993','dd.mm.yyyy')         e.dato_ut  = to_date('31.12.1994','dd.mm.yyyy')         e.dato_ut  = to_date('31.12.1995','dd.mm.yyyy')         e.dato_ut  = to_date('31.12.1996','dd.mm.yyyy')         e.dato_ut  = to_date('31.12.1997','dd.mm.yyyy')     
    where exists (                                          where exists (                                          where exists (                                          where exists (                                          where exists (                                          where exists (                                      
    select 'x'                                              select 'x'                                              select 'x'                                              select 'x'                                              select 'x'                                              select 'x'                                          
    from serie s                                            from serie s                                            from serie s                                            from serie s                                            from serie s                                            from serie s                                        
    where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                        
    and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)             
    and s.serie_no between 1001 and 1062);                  and s.serie_no between 1063 and 1120);                  and s.serie_no between 1121 and 1227);                  and s.serie_no between 1228 and 1318);                  and s.serie_no between 1319 and 1385);                  and s.serie_no between 1386 and 1516);              
    #61 nr 1 mangler                                        #58                                               #107                                               #91                                                     #67                                                     #131                                                                             
    
    --1998 NBNB rører ikke UT_DATO        --1999                                             --2000                                             --2001                                            --2002                          --2003                                                                   
    update enhet e set                                      update enhet e set                                      update enhet e set                                      update enhet e set                                      update enhet e set                                      
    e.dato_inn = to_date('01.01.1998','dd.mm.yyyy')         e.dato_inn = to_date('01.01.1999','dd.mm.yyyy')         e.dato_inn = to_date('01.01.2000','dd.mm.yyyy')         e.dato_inn = to_date('01.01.2001','dd.mm.yyyy')         e.dato_inn = to_date('01.01.2002','dd.mm.yyyy')         
    where exists (                                          where exists (                                          where exists (                                          where exists (                                          where exists (                                          
    select 'x'                                              select 'x'                                              select 'x'                                              select 'x'                                              select 'x'                                              
    from serie s                                            from serie s                                            from serie s                                            from serie s                                            from serie s                                            
    where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            where e.vare_gruppe_seq_no=1                            
    and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 and e.serie_seq_no = s.serie_seq_no (+)                 
    and s.serie_no between 1517 and 1599);                  and s.serie_no between 1600 and 1845);                  and s.serie_no between 1846 and 2096);                  and s.serie_no between 2097 and 2547);                  and s.serie_no between 2548 and 3106);                  and s.serie_no between 3107 and 9999);          
    #83                                                     #246                                                    #251                                               #445              #558                                                    #558                                            
    
    --Tull ut året FØR denne er INNE
    TO_CHAR(DATO_INN,'YYYY')  TO_CHAR(DATO_UT,'YYYY')  MIN(SERIE_NO)  MAX(SERIE_NO)  COUNT(*)
    1999        1998      1644,    1644,    1,
    update enhet e set                                
    e.dato_ut = to_date('31.12.1999','dd.mm.yyyy')   
    where exists (                                    
    select 'x'                                        
    from serie s                                      
    where e.vare_gruppe_seq_no=1                      
    and e.serie_seq_no = s.serie_seq_no (+)           
    and s.serie_no between 1644 and 1644);            
    
    
    alter table enhet enable all triggers;
    
    
    select enhet_seq_no,serie_no, dato_inn, dato_ut, s.serie_anv_seq_no
    from   enhet e,
      serie s
    where vare_gruppe_seq_no=1
    and e.serie_seq_no = s.serie_seq_no (+)
    --and serie_no <1600
    and s.serie_no between 1517 and 1599
    order by 3,4
    
    NB 5  Serie no sjekk på deler ref permer
    ----
    status i dag
    select  to_char(dato_inn,'yyyy'),
      min(serie_no),max(serie_no), count(*)    DATO_INN  MIN(SERIE_NO)  MAX(SERIE_NO)  COUNT(*)      1998  2628,  491,  skal være 599                                                                        
    from   enhet e,                                        1998            4,                                                           1999  1812,  242,     ''  1845                                                                  
      serie s                                         1999    2,  183,  595,                                                        2000  2038,  111,    ''  2096                                                                
    where vare_gruppe_seq_no !=1                            2000    1,  2605,  2742,                                                          2001  2406,  459,  ''  2547                                                                  
    and e.serie_seq_no = s.serie_seq_no (+)                 2001    30,  4459,  2547,                                                        2002  3014,  580,  ''  3107                                                                  
    --and serie_no <1600                                    2002    11,  5780,  2149,                                                        2003  3737,  836,  ''                                                                            
    group by to_char(dato_inn,'yyyy')                       2003    5,  7537,  3745,                                                                                                                   
    order by 1,2                             
    
    NB går ikke fordi vi SLETTER serie_no ref gjenbruk --> bedre å sette de historisk
    
    sjekk mot lbk.omsetninig
    select  to_char(e.dato_inn,'yyyy'),               
      min(serie_no),max(serie_no), count(*)  
    from   enhet e,
      lbk.omsetning l,                                
      serie s                                 
    where vare_gruppe_seq_no !=1                    
    and e.serie_seq_no = s.serie_seq_no (+)         
    and l.seq_no = e.enhet_seq_no
    --and serie_no <1600                            
    group by to_char(e.dato_inn,'yyyy')                      
    order by 1,2;                                   
    
    NB 6) Opptelling
    ----------------
    Konistens dato
    select count(*) from enhet where dato_ut is not null;    select enhet_seq_no from enhet where dato_ut is not null     select enhet_seq_no from enhet where location_seq_no is null
    #6886                                                           minus                                            MINUS
    select count(*) from enhet where location_seq_no is null;       select enhet_seq_no from enhet where location_seq_no is null;  select enhet_seq_no from enhet where dato_ut is not null;
    #6880                  580                #0
                                                                    16614
                                                                    16684
                                                                    16922
                                                                    19485
                                                                    22087
    
    
    Fikser triggeren +
    alter table enhet disable all triggers;
    update enhet set dato_ut=null
    where enhet_seq_no in(580,16614,16684,16922,19485,22087);
    commit;
    alter table enhet enable all triggers;
    
    select decode(nvl(to_char(location_seq_no),'x'),'x',null,'loc'),count(*)  DEC  COUNT(*)
    from enhet                                                                      --- ---------
    group by decode(nvl(to_char(location_seq_no),'x'),'x',null,'loc')               loc      7621
    ;                                                                                        6880
    
    select decode(nvl(to_char(dato_ut),'x'),'x',null,'dato_ut'),count(*)    dato_ut      6880
    from enhet                                                                                   7621
    group by decode(nvl(to_char(dato_ut),'x'),'x',null,'dato_ut')
    ;
    
    select decode(nvl(to_char(dato_inn),'x'),'x',null,'dato_inn'),count(*)    dato_inn     14501
    from enhet
    group by decode(nvl(to_char(dato_inn),'x'),'x',null,'dato_inn')
    ;
    
    
     ///////////////////////////////////////// slutt /////////////////////////////////////////////
                                                                                                                                                                                                                                                                    
                          
    Statistikk tabell LBK
    ---------------------
    --drop table omsetning;
    create table omsetning (
     FIL                                      VARCHAR2(32),
     SEQ_NO                                    number(8),
     VARE                                     VARCHAR2(8),
     INNE_UTE          varchar2(8),
        constraint PK_omsetning primary key (fil,SEQ_NO));
    grant select on omsetning   to public;
    grant insert on omsetning   to public;
    
    alter table omsetning add(dato_inn date , dato_ut date);
    
    
    Problem hva er kriteriet for solgt /presset ?    i)   at loc er borte
    ---------------------------------------------  ii)  at salg_id er satt 
                iii) at serie_no er på plass 
                
    select   decode(vare_gruppe_seq_no,1,'vrak','del')  as enhet,
      decode(serie_seq_no,null,'tomt','serie')  as serie, 
      salg_kjop_id,
      decode(location_seq_no,null,'tomt','loc')  as loc,   
      count(*)
    from enhet,
         salg_kjop
    where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)       
    group by decode(vare_gruppe_seq_no,1,'vrak','del'),decode(serie_seq_no,null,'tomt','serie'),salg_kjop_id,decode(location_seq_no,null,'tomt','loc')
    order by decode(vare_gruppe_seq_no,1,'vrak','del'),decode(serie_seq_no,null,'tomt','serie'),salg_kjop_id,decode(location_seq_no,null,'tomt','loc');
    
      --inn_1999
      SERIE LOC  ENHE S  COUNT(*)
      ----- ---- ---- - ---------
      serie loc  del  K       164  inne
      serie loc  del  S         1    ute
      serie loc  del           12    ute
      serie tomt vrak K       175  inne
      serie tomt vrak S       491    ute
      tomt  tomt vrak S         1    ute
      
      --del inne                --vrak inne                                                              
      insert into lbk.omsetning                                         insert into lbk.omsetning                                                
      select distinct 'inn_1999',                                       select distinct 'inn_1999',                                              
      enhet.enhet_seq_no,                                               enhet.enhet_seq_no,                                                      
      decode(vare_gruppe_seq_no,1,'vrak','del'),                        decode(vare_gruppe_seq_no,1,'vrak','del'),                               
      'inne'                                                            'inne'                                                                   
      from enhet,salg_kjop                                              from enhet,salg_kjop                                                     
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)         where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)            
      and vare_gruppe_seq_no !=1                                        and vare_gruppe_seq_no =1                                              
      and salg_kjop_id ='K';                                            and salg_kjop_id ='K';                                                   
      #164                                                              #175                                                            
                                                                                                                                        
      --del ute                --vrak ute                                           
      insert into lbk.omsetning            insert into lbk.omsetning                              
      select distinct 'inn_1999',                                             select distinct 'inn_1999',                           
      enhet.enhet_seq_no,                                                     enhet.enhet_seq_no,                                   
      decode(vare_gruppe_seq_no,1,'vrak','del'),                              decode(vare_gruppe_seq_no,1,'vrak','del'),            
      'ute'                                                                   'ute'                                                 
      from enhet,salg_kjop                                                    from enhet,salg_kjop                                  
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)               where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      and vare_gruppe_seq_no !=1                                              and vare_gruppe_seq_no =1                             
      and (salg_kjop_id ='S' or salg_kjop_id is null);                        and (salg_kjop_id ='S' or salg_kjop_id is null);     
      #13                                                                     #492 
    
      --sjekk
      select count(*) from enhet;
      select count(*) from lbk.omsetning where fil ='inn_1999';
      
      
      inn_2000
      --------
      SERIE LOC  ENHE S  COUNT(*)
      del  serie K loc        137  inne
      del  serie   loc       2306  inne
      del  serie   tomt        57  inne  -->2500 
      del  tomt  K loc         19    ute
      del  tomt  K tomt         1    ute
      del  tomt  S loc        427    ute
      del  tomt  S tomt         8    ute   -->455  men 1 del både kjøpt og solg men serieseq_ tomt --> solgt
      vrak serie K tomt       151    ref *** ingen felles --> inne
      vrak serie S tomt       668    ute
      vrak serie   tomt        20    --> alle ute ref §§§
    
    
      --del inne                --vrak inne                                                              
      insert into lbk.omsetning                                         se nedenfor   ***               
      select distinct 'inn_2000',                                               og    §§§          
      enhet.enhet_seq_no,                                                                 
      decode(vare_gruppe_seq_no,1,'vrak','del'),                                          
      'inne'                                                                              
      from enhet,salg_kjop                                                                
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   
      and vare_gruppe_seq_no !=1                                                        
      and serie_seq_no is not null;                                                              
      #2500                                                                       
                                                                                                                                        
      --del ute                --vrak ute                                           
      insert into lbk.omsetning                                    insert into lbk.omsetning                              
      select distinct 'inn_2000',                                             select distinct 'inn_2000',                           
      enhet.enhet_seq_no,                                                     enhet.enhet_seq_no,                                   
      decode(vare_gruppe_seq_no,1,'vrak','del'),                              decode(vare_gruppe_seq_no,1,'vrak','del'),            
      'ute'                                                                   'ute'                                                 
      from enhet,salg_kjop                                                    from enhet,salg_kjop                                  
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)               where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      and vare_gruppe_seq_no !=1                                              and vare_gruppe_seq_no =1                             
      and serie_seq_no is null;                                               and salg_kjop_id ='S' ;     
      #454                                                                    #668 
    
      ---***
      vrak serie K tomt       151
      vrak serie S tomt       668  er noen av disse felles
                        --vrak inne 
      select  enhet.enhet_seq_no                                       insert into lbk.omsetning                             
      from enhet,salg_kjop                                                    select distinct 'inn_2000',                           
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   enhet.enhet_seq_no,                                   
      and vare_gruppe_seq_no =1                                               decode(vare_gruppe_seq_no,1,'vrak','del'),            
      and salg_kjop_id ='K'                                                   'inne'                                                 
      intersect                                                               from enhet,salg_kjop                                  
      select  enhet.enhet_seq_no                                              where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      from enhet,salg_kjop                                                    and vare_gruppe_seq_no =1                             
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   and salg_kjop_id ='K' ;                               
      and vare_gruppe_seq_no =1                                    #151
      and salg_kjop_id ='S';
      #0  
    
      --§§§
      vrak serie   tomt        20  hadde vi noen av disse i inn_1999
    
      select  enhet.enhet_seq_no                                   
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no                       
      intersect                                                               
      select seq_no from lbk.omsetning where fil='inn_1999';                  
      #--> kun 816                                                            
                                                                              
      select * from lbk.omsetning where fil='inn_1999' and seq_no=816;
      inn_1999                               816 vrak     inne
      
      KONKLUSJON legger allt ut
    
      --vrak ute                                           
      insert into lbk.omsetning                            
      select distinct 'inn_2000',                          
      seq,                                  
      'vrak',
      'ute'                                                
      from 
      (select  enhet.enhet_seq_no as seq                                  
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no       )                ;
      #20  
    
      --sjekk
      select count(*) from enhet;
      select count(*) from lbk.omsetning where fil ='inn_2000';
      ok
    
    
    
      inn_2001
      --------
      del  serie K loc        119  inne
      del  serie S loc          1  inne
      del  serie   loc       4111  inne
      del  serie   tomt        85  inne    --> 4316   
      del  tomt  K loc         47
      del  tomt  K tomt         1
      del  tomt  S loc       1260
      del  tomt  S tomt        20  ute -->1328 men pga distinct -->1327 ref serie tomt må være solgt
      vrak serie K tomt       386
      vrak serie S tomt       690
      vrak serie   tomt         2  antar inne
    
      --del inne                --vrak inne                                                              
      insert into lbk.omsetning                                         se nedenfor   ***               
      select distinct 'inn_2001',                                               og    §§§          
      enhet.enhet_seq_no,                                                                 
      decode(vare_gruppe_seq_no,1,'vrak','del'),                                          
      'inne'                                                                              
      from enhet,salg_kjop                                                                
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   
      and vare_gruppe_seq_no !=1                                                        
      and serie_seq_no is not null;                                                              
      #4316                                                                       
                                                                                                                                        
      --del ute                --vrak ute                                           
      insert into lbk.omsetning                                    insert into lbk.omsetning                              
      select distinct 'inn_2001',                                             select distinct 'inn_2001',                           
      enhet.enhet_seq_no,                                                     enhet.enhet_seq_no,                                   
      decode(vare_gruppe_seq_no,1,'vrak','del'),                              decode(vare_gruppe_seq_no,1,'vrak','del'),            
      'ute'                                                                   'ute'                                                 
      from enhet,salg_kjop                                                    from enhet,salg_kjop                                  
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)               where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      and vare_gruppe_seq_no !=1                                              and vare_gruppe_seq_no =1                             
      and serie_seq_no is null;                                               and salg_kjop_id ='S' ;     
      #1327                                                                   #690
      
      ---***
      vrak serie K tomt       386
      vrak serie S tomt       690  er noen av disse felles
                        --vrak inne 
      select  enhet.enhet_seq_no                                       insert into lbk.omsetning                             
      from enhet,salg_kjop                                                    select distinct 'inn_2001',                           
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   enhet.enhet_seq_no,                                   
      and vare_gruppe_seq_no =1                                               decode(vare_gruppe_seq_no,1,'vrak','del'),            
      and salg_kjop_id ='K'                                                   'inne'                                                 
      intersect                                                               from enhet,salg_kjop                                  
      select  enhet.enhet_seq_no                                              where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      from enhet,salg_kjop                                                    and vare_gruppe_seq_no =1                             
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   and salg_kjop_id ='K' ;                               
      and vare_gruppe_seq_no =1                                    #386
      and salg_kjop_id ='S';
      #0  
    
      --§§§
      vrak serie   tomt         2      hadde vi noen av disse i inn_2000
    
      select  enhet.enhet_seq_no                                   
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no                       
      intersect                                                               
      select seq_no from lbk.omsetning where fil='inn_2000';                  
      #0                                                            
                                                                              
      
      KONKLUSJON legger alle inne
    
      --vrak ute                                           
      insert into lbk.omsetning                            
      select distinct 'inn_2001',                          
      seq,                                  
      'vrak',
      'inne'                                                
      from 
      (select  enhet.enhet_seq_no as seq                                  
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no       )                ;
      #  7341
        9378  
    
      --sjekk
      select count(*) from enhet;
      select count(*) from lbk.omsetning where fil ='inn_2001';
      begge 6721
      
      inn_2002
      --------
      del  serie K loc         89
      del  serie   loc       5517  inne 5606
      del  tomt  K loc          3
      del  tomt  K tomt        59
      del  tomt  S tomt      2098
      del  tomt    loc         30
      del  tomt    tomt        35  ute 2225 --- 2223 pga serie er tomt
      vrak serie K loc        223
      vrak serie S tomt      1263
      vrak serie   loc         44   
    
      --del inne                --vrak inne                                                              
      insert into lbk.omsetning                                         se nedenfor   ***               
      select distinct 'inn_2002',                                               og    §§§          
      enhet.enhet_seq_no,                                                                 
      decode(vare_gruppe_seq_no,1,'vrak','del'),                                          
      'inne'                                                                              
      from enhet,salg_kjop                                                                
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   
      and vare_gruppe_seq_no !=1                                                        
      and serie_seq_no is not null;                                                              
      #5606                                                                       
                                                                                                                                        
      --del ute                --vrak ute                                           
      insert into lbk.omsetning                                    insert into lbk.omsetning                              
      select distinct 'inn_2002',                                             select distinct 'inn_2002',                           
      enhet.enhet_seq_no,                                                     enhet.enhet_seq_no,                                   
      decode(vare_gruppe_seq_no,1,'vrak','del'),                              decode(vare_gruppe_seq_no,1,'vrak','del'),            
      'ute'                                                                   'ute'                                                 
      from enhet,salg_kjop                                                    from enhet,salg_kjop                                  
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)               where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      and vare_gruppe_seq_no !=1                                              and vare_gruppe_seq_no =1                             
      and serie_seq_no is null;                                               and salg_kjop_id ='S' ;     
      #2223                                                                   #1263
      
      ---***
      vrak serie K loc        223      
      vrak serie S tomt      1263      er noen av disse felles
                        --vrak inne 
      select  enhet.enhet_seq_no                                       insert into lbk.omsetning                             
      from enhet,salg_kjop                                                    select distinct 'inn_2002',                           
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   enhet.enhet_seq_no,                                   
      and vare_gruppe_seq_no =1                                               decode(vare_gruppe_seq_no,1,'vrak','del'),            
      and salg_kjop_id ='K'                                                   'inne'                                                 
      intersect                                                               from enhet,salg_kjop                                  
      select  enhet.enhet_seq_no                                              where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+) 
      from enhet,salg_kjop                                                    and vare_gruppe_seq_no =1                             
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)                   and salg_kjop_id ='K' ;                               
      and vare_gruppe_seq_no =1                                    #223
      and salg_kjop_id ='S';
      #0  
    
      --§§§
      vrak serie   loc         44      hadde vi noen av disse i inn_2000
    
      select  enhet.enhet_seq_no                                   
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no                       
      intersect                                                               
      select seq_no from lbk.omsetning where fil='inn_2001';                  
      #0                                                            
                                                                              
      
      KONKLUSJON legger alle inne
    
      --vrak ute                                           
      insert into lbk.omsetning                            
      select distinct 'inn_2002',                          
      seq,                                  
      'vrak',
      'inne'                                                
      from 
      (select  enhet.enhet_seq_no as seq                                  
      from enhet                                                              
      where vare_gruppe_seq_no =1                                             
      minus                                                                   
      select  enhet.enhet_seq_no                                              
      from enhet,salg_kjop                                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no       )                ;
      #44 stk
        
    
      --sjekk
      select count(*) from enhet;
      select count(*) from lbk.omsetning where fil ='inn_2002';
      begge 9359
    
      inn_2003
      --------
      del  serie K loc         70
      del  serie   loc       6357  inne 6427
      del  tomt  K tomt        81
      del  tomt  S tomt      2098
      del  tomt    tomt      1070    ute 3249
      vrak serie K loc         45 inne
      vrak serie   loc        210 inn 255
      vrak serie K tomt       178    ute
      vrak serie S tomt      1263  ute
      vrak serie   tomt       390       ute  --> 1831
    
      --del inne                --vrak inne                                                              
      insert into lbk.omsetning                                         insert into lbk.omsetning                              
      select distinct 'inn_2003',                                       select distinct 'inn_2003',                       
      enhet.enhet_seq_no,                                               enhet.enhet_seq_no,                           
      decode(vare_gruppe_seq_no,1,'vrak','del'),                        decode(vare_gruppe_seq_no,1,'vrak','del'),    
      'inne'                                                            'inne'                                         
      from enhet,salg_kjop                                              from enhet                                    
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)         where location_seq_no is not null                 
      and vare_gruppe_seq_no !=1                                        and vare_gruppe_seq_no =1                     
      and serie_seq_no is not null;                                            #255                                         
      #6427                                                                       
                                                                                                                                        
      --del ute                --vrak ute                                           
      insert into lbk.omsetning                                    insert into lbk.omsetning                              
      select distinct 'inn_2003',                                             select distinct 'inn_2003',                           
      enhet.enhet_seq_no,                                                     enhet.enhet_seq_no,                                   
      decode(vare_gruppe_seq_no,1,'vrak','del'),                              decode(vare_gruppe_seq_no,1,'vrak','del'),            
      'ute'                                                                   'ute'                                                 
      from enhet,salg_kjop                                                    from enhet
      where enhet.enhet_seq_no = salg_kjop.enhet_seq_no (+)               where location_seq_no is null
      and vare_gruppe_seq_no !=1                                              and vare_gruppe_seq_no =1                             
      and serie_seq_no is null;                                               #1831
      #3427                                                                   
    
      --sjekk
      select count(*) from enhet;
      select count(*) from lbk.omsetning where fil ='inn_2003';
      begge 9359
      11760
       
    
      --velge 1999 - 2003
      -------------------
    siste dag i året er satt i ora.ini alter session set NLS_TERRITORY=NORWAY ;   
    select to_char(to_date('31.12.1998','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 1998-53-4
    select to_char(to_date('31.12.1999','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 1999-52-5
    select to_char(to_date('31.12.2000','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 2000-52-7
    select to_char(to_date('31.12.2001','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 2002-01-1
    select to_char(to_date('31.12.2002','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 2003-53-2
    select to_char(to_date('31.12.2003','dd.mm.yyyy'),'yyyy-ww-d') from dual;  --> 2003-53-3  
         ute (forrige år    inne (på lager ved starten av året)  solgte i løpet av året
    inn_1999  31.12.1998    1.1.1999        1.6.1999
    inn_2000  31.12.1999    1.1.2000        osv
    inn_2001  31.12.2000    1.1.2001
    inn_2002  31.12.2001    1.1.2002
    inn_2003  31.12.2002    1.1.2003
    
        ute men er kommet inni 2000
    inn_2000  31.12.1999    1.1.2000        
    
    FIL    VARE  Antall av SEQ_NO  FIL    VARE  INNE_UTE  DATO_INN  DATO_UT  Antall av SEQ_NO
    inn_1999  del  177,                    inn_1999  del  inne    1999-01-01       164,    
    inn_1999  vrak  667,                    inn_1999  del  ute        1998-12-31  13,     
    inn_2000  del  2954,                   inn_2000  del  inne    2000-01-01       2364,   
    inn_2000  vrak  839,                    inn_2000  del  inne            136,                    
                                                    inn_2000  del  ute      1999-12-31     450,    
                                                    inn_2000  del  ute            4,                      
    
    select enhet_seq_no from enhet
    minus 
    select seq_no from lbk.omsetning;
    begynner på 18601 ok
                                                    
    select seq_no from lbk.omsetning
    minus
    select enhet_seq_no from enhet;
       SEQ_NO
    ---------
          595
          881
         5324
         7489
         
    der disse slettet i enhet !
    select enhet_seq_no from enhet
    where enhet_seq_no in(595,881,5324,7489);
    #0 ja     
         
    fix fix
    alter table enhet disable all triggers;
    alter table enhet enable all triggers;
    
    
    SELECT Count(OMSETNING.SEQ_NO) 'Antall av SEQ_NO', OMSETNING.VARE, OMSETNING.INNE_UTE, ENHET.DATO_INN, OMSETNING.DATO_INN, Min(ENHET.LOCATION_SEQ_NO) 'Min av LOCATION_SEQ_NO', ENHET.DATO_UT, OMSETNING.DATO_UT
    FROM OLA.ENHET ENHET, LBK.OMSETNING OMSETNING
    WHERE ENHET.ENHET_SEQ_NO = OMSETNING.SEQ_NO AND ((OMSETNING.FIL='inn_2000'))
    GROUP BY OMSETNING.VARE, OMSETNING.INNE_UTE, ENHET.DATO_INN, OMSETNING.DATO_INN, ENHET.DATO_UT, OMSETNING.DATO_UT
    ORDER BY OMSETNING.VARE, OMSETNING.INNE_UTE, ENHET.DATO_INN, ENHET.DATO_UT
    1)
    --
    9,  del  inne  2000-01-01 00:00:00  1999-01-01 00:00:00  106,  1998-12-31 00:00:00  
    select enhet_seq_no from enhet
    where to_char(dato_inn,'yyyy-mm-dd')='2000-01-01'
    and   to_char(dato_ut ,'yyyy-mm-dd')='1998-12-31';
    #9
      update enhet set dato_inn = to_date('1999-01-1','yyyy-mm-dd'),dato_ut=null
      where to_char(dato_inn,'yyyy-mm-dd')='2000-01-01'
      and   to_char(dato_ut ,'yyyy-mm-dd')='1998-12-31';
    
    2)
    --
    1,  vrak  ute  1998-06-01 00:00:00      2003-05-14 09:29:02  1998-12-31 00:00:00
    select enhet_seq_no from enhet
    where to_char(dato_inn,'yyyy-mm-dd')='1998-06-01'
    and   to_char(dato_ut ,'yyyy-mm-dd')='2003-05-14';
      170
      update enhet set dato_inn = to_date('1998-06-1','yyyy-mm-dd'),dato_ut=to_date('1998-12-31','yyyy-mm-dd')
      where to_char(dato_inn,'yyyy-mm-dd')='1998-06-01'
      and   to_char(dato_ut ,'yyyy-mm-dd')='2003-05-14';
    
    3)
    --
    1,  vrak  inne  1999-01-01 00:00:00  1999-01-01 00:00:00  695,    
    sjekk
    select enhet_seq_no from enhet
    where to_char(dato_inn,'yyyy-mm-dd')='1999-01-01'
    and vare_gruppe_seq_no=1
    and   dato_ut is null;
    580
    
    
    --fil inn_2000
    
    4)
    --
    2,  del  inne  1999-01-01 00:00:00        2000-06-01 00:00:00
    select enhet_seq_no from enhet, lbk.omsetning
    where to_char(enhet.dato_inn,'yyyy-mm-dd')='1999-01-01'
    and enhet.enhet_seq_no=lbk.omsetning.seq_no
    and lbk.omsetning.fil='inn_2000'
    and to_char(lbk.omsetning.dato_ut ,'yyyy-mm-dd')='2000-06-01';
            1041
            1063
      update enhet set dato_ut = to_date('2000-06-01','yyyy-mm-dd')
      where enhet_seq_no in(1041,1063);
    
    5)
    6,  vrak  ute  2001-01-01 00:00:00      1999-12-31 00:00:00  1999-12-31 00:00:00
    select enhet_seq_no from enhet,lbk.omsetning
    where to_char(enhet.dato_inn,'yyyy-mm-dd')='2001-01-01'
    and   to_char(enhet.dato_ut ,'yyyy-mm-dd')='1999-12-31'
    and enhet.enhet_seq_no=lbk.omsetning.seq_no
    and lbk.omsetning.fil='inn_2000'
    and to_char(lbk.omsetning.dato_ut ,'yyyy-mm-dd')='1999-12-31'
    and lbk.omsetning.dato_inn is null
    and enhet.vare_gruppe_seq_no=1
            3250
            5406
            5419
            5425
            5429
            5433
            
         
    ///////////////slutt fix ///////////////////////////////////////////
    
    
    //////////////rapporter ////////////////7777
    alder på vrak innenfor portene
    loc is not null    varegruppe vrak    grupper pr år INN og ANTALL  eks seq_no 580 Toyota Hiac fra 1999
    
    
    //////////////slutt rapporter ////////////////7777
                                                    
      select seq_no, max(inne_ute),min(fil)      SELECT OMSETNING.SEQ_NO, OMSETNING.INNE_UTE, OMSETNING.FIL
      from omsetning                                          FROM LBK.OMSETNING OMSETNING                              
      group by seq_no;                                        WHERE (OMSETNING.SEQ_NO=90) OR (OMSETNING.SEQ_NO=91)      
                                                              ORDER BY OMSETNING.SEQ_NO, OMSETNING.INNE_UTE, OMSETNING.FIL
      --første gang inn        --første gang ute                          
      select seq_no, min(fil)                   select seq_no, min(fil)                    
      from lbk.omsetning                            from omsetning                             
      where inne_ute='inne'                     where inne_ute='ute'                         
      group by seq_no;                          group by seq_no;                           
      #9352            #5086                
       5086
      14438                                                        
           - 2674
            11764     4  for mye 
             
      --felles
      select seq_no      select seq_no        
      from lbk.omsetning              from lbk.omsetning   
      where inne_ute='inne'           where inne_ute='ute'
      intersect                       intersect            
      select seq_no                   select seq_no        
      from lbk.omsetning              from lbk.omsetning   
      where inne_ute='ute';           where inne_ute='inne'; 
      #2674        2674
      
      --for mye
      select seq_no,inne_ute, count(*)
      from omsetning
      group by seq_no,inne_ute 
      having count(*) > 4;
    --INN  
      --1999
      update omsetning set dato_inn = to_date('1.1.1999','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='inne'
                       having min(fil)='inn_1999'   
                                   group by seq_no )  --339
      and dato_inn is null ;                          --339            
      --2000
      update omsetning set dato_inn = to_date('1.1.2000','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='inne'
                       having min(fil)='inn_2000'   
                                   group by seq_no )  --2464
      and dato_inn is null ;                          --2464           
      --2001
      update omsetning set dato_inn = to_date('1.1.2001','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='inne'
                       having min(fil)='inn_2001'   
                                   group by seq_no )  --2542
      and dato_inn is null ;                          --2542
      --2002                               
      update omsetning set dato_inn = to_date('1.1.2002','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='inne'
                       having min(fil)='inn_2002'   
                                   group by seq_no )  --2167
      and dato_inn is null ;                          --2167
      --2003                               
      update omsetning set dato_inn = to_date('1.1.2003','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='inne'
                       having min(fil)='inn_2003'   
                                   group by seq_no )  --1840
      and dato_inn is null ;                          --1840
    --UT
      --1999
      update omsetning set dato_ut = to_date('31.12.1998','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='ute'
                       having min(fil)='inn_1999'   
                                   group by seq_no )  --505
      and dato_ut is null ;                          --505           
      --2000
      update omsetning set dato_ut = to_date('31.12.1999','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='ute'
                       having min(fil)='inn_2000'   
                                   group by seq_no )  --647
      and dato_ut is null ;                          --647
      --2001
      update omsetning set dato_ut = to_date('31.12.2000','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='ute'
                       having min(fil)='inn_2001'   
                                   group by seq_no )  --879
      and dato_ut is null ;                          --879
      --2002                               
      update omsetning set dato_ut = to_date('31.12.2001','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='ute'
                       having min(fil)='inn_2002'   
                                   group by seq_no )  --1463
      and dato_ut is null ;                          --1463
      --2003                               
      update omsetning set dato_ut = to_date('31.12.2002','dd.mm.yyyy')
      where (seq_no,fil) in( select seq_no, min(fil) 
                 from lbk.omsetning      
                       where inne_ute='ute'
                       having min(fil)='inn_2003'   
                                   group by seq_no )  --1592
      and dato_ut is null ;                          --1592
      
    --Kontroll har vi 2 datoer hhv inn/ ut på noen av seq_no
    select seq_no,count(dato_inn)      select seq_no,count(dato_ut)
    from omsetning                                  from omsetning               
    having count(dato_inn) >1                       having count(dato_ut) >1    
    group by seq_no;                                group by seq_no;             
    
                                   
    
    --drop table omsetning_klar;
    create table omsetning_klar (
     SEQ_NO                                    number(8),
     dato_inn                                   date,
     dato_ut          DATE,
         constraint PK_omsetning_KLAR primary key (SEQ_NO));
    grant select on omsetning_KLAR   to public;
    grant insert on omsetning_KLAR   to public;
    
    Altså
    --TRUNCATE table omsetning_klar;
    INSERT INTO OMSETNING_KLAR
    select seq_no, max(dato_inn), max(dato_ut) 
    from omsetning 
    group by seq_no;
    #11764
    
    Har noen ikke ut_dato men inn_ dato tom da er de kommet til i løpet av året etter 1.1
    select seq_no, dato_inn, dato_ut
    from omsetning_klar
    where dato_inn is null 
    and   dato_ut is not null;
    #2412
    496
    490
    393
    471
    562
    0    -->2412
    
    select to_char(dato_inn,'yyyy-hh24'), count(*) from enhet
    where to_char(dato_inn,'mm-hh24')= '06-00'
    and dato_ut is null
    --utelater de i år 2003
    group by to_char(dato_inn,'yyyy-hh24');
    
    1998 495
    1999 490
    2000 393
    2001 471
    2002 562
    2003 318
    
    select to_char(dato_inn,'yyyy-hh24'), count(*) from enhet
    where to_char(dato_inn,'yyyy-mm-hh24')= '1999-06-00'
    and dato_ut is null
    --utelater de i år 2003
    group by to_char(dato_inn,'yyyy-hh24');
    
    
    select enhet_seq_no from enhet
    where to_char(dato_inn,'mm-hh24')= '06-00'
    
    select enhet_seq_no,dato_inn, dato_ut from enhet
    where to_char(dato_inn,'yyyy-mm-hh24')= '1999-06-00'
    
    = to_date('1.6.1998','dd.mm.yyyy')
    
      --1998
      update omsetning_klar set dato_inn = to_date('1.6.1998','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.1998','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
      --1999
      update omsetning_klar set dato_inn = to_date('1.6.1999','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.1999','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
      --2000
      update omsetning_klar set dato_inn = to_date('1.6.2000','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.2000','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
      --2001
      update omsetning_klar set dato_inn = to_date('1.6.2001','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.2001','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
      --2002
      update omsetning_klar set dato_inn = to_date('1.6.2002','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.2002','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
      --2003
      update omsetning_klar set dato_inn = to_date('1.6.2003','dd.mm.yyyy')
      where (seq_no) in( select seq_no
                 from lbk.omsetning_klar      
                       where dato_ut =to_date('31.12.2003','dd.mm.yyyy')
                       and   dato_inn is null )  --496              
      and dato_inn is null ;            
    
    --FRA OBV på fil innn_2003
    
    select enhet_seq_no from enhet
    minus
    select seq_no from lbk.omsetning_klar;
    #0
                                
    --andre veien
    select seq_no from lbk.omsetning_klar
    minus
    select enhet_seq_no from enhet;
          595
          881
         5324
         7489  dette er jo de 4 jeg hadde til overs
         
    27-10-2003                              
    select count(*) from enhet;
    #14430    
    
    
    --på/av
    ------
    alter table enhet disable all triggers;
    alter table enhet enable all triggers;
    
    
    update enhet set dato_inn=
      (select lbk.omsetning_klar.dato_inn
       from lbk.omsetning_klar
       where lbk.omsetning_klar.dato_inn is not null  --11764  minus de 4 som er sletter
       and lbk.omsetning_klar.seq_no = enhet_seq_no
       and enhet.dato_inn is null)
    where enhet.dato_inn is null
    and enhet_seq_no in (select seq_no from lbk.omsetning_klar where lbk.omsetning_klar.dato_inn is not null ) ;
    #11760                       
    
    update enhet set dato_ut=
      (select lbk.omsetning_klar.dato_ut
       from lbk.omsetning_klar
       where lbk.omsetning_klar.dato_ut is not null  --11764  minus de 4 som er sletter
       and lbk.omsetning_klar.seq_no = enhet_seq_no
       and enhet.dato_ut is null)
    where enhet.dato_ut is null
    and enhet_seq_no in (select seq_no from lbk.omsetning_klar where lbk.omsetning_klar.dato_ut is not null ) ;
    #5084
    
    update enhet set dato_inn = to_date('28.2.2003','dd.mm.yyyy')
    where dato_inn is null;
    
    
    -- legger alt inni en hjelpetabell
    --drop table enhet_2003_10_27;
    create table enhet_2003_10_27 (
     SEQ_NO                                    number(8),
     for_dato_inn                                   date,
     for_dato_ut            DATE,
     etter_dato_inn                                   date,
     etter_dato_ut            DATE,
          constraint PK_enhet__2003_10_27 primary key (SEQ_NO));
    
    --legger alt inn hjemme konvertert enhet
    insert into enhet_2003_10_27
    select enhet_seq_no,null,null,
      dato_inn, dato_ut
    from enhet;
    #14450
    
    
    eksporterer tabellen til visnes og legger inn for verdiene
    exp73 system/manager@targa3 tables=ola.enhet_2003_10_27 file=enhet_2003_10_27
    --like fil
    imp73   system/manager@targa3  fromuser=ola  touser=ola   ignore=Y   file=enhet_2003_10_27.dmp   commit=Y      log=enhet_2003_10_27.imp
    imp73   system/manager@compaq1  fromuser=ola  touser=ola   ignore=Y   file=enhet_2003_10_27.dmp   commit=Y      log=enhet_2003_10_27.imp
    
    update enhet_2003_10_27 a
    set (a.for_dato_inn,a.for_dato_ut) =
      (select b.dato_inn, b.dato_ut from enhet b
       where b.enhet_seq_no = a.seq_no
       and (b.dato_inn is not null or b.dato_ut is not null));
    #
    sjekk konsistens
    select enhet_seq_no, dato_inn, dato_ut from enhet
    minus
    select       seq_no, for_dato_inn, for_dato_ut from enhet_2003_10_27
    minus  
    select enhet_seq_no, dato_inn, dato_ut from enhet
    
    exp73 system/manager@targa3 tables=ola.enhet_2003_10_27 file=enhet_2003_10_27_full
    imp73   system/manager@compaq1  fromuser=ola  touser=ola   ignore=Y   file=enhet_2003_10_27_full.dmp   commit=Y      log=enhet_2003_10_27.imp
    
    NBNB skru av alle triggerne på OBV prod
    alter table enhet disable all triggers;
    
    update enhet a set (a.dato_inn) =
      (select b.etter_dato_inn
       from enhet_2003_10_27 b
       where b.seq_no = a.enhet_seq_no
       and a.dato_inn is null)
    where a.dato_inn is null   
    and a.enhet_seq_no in (select seq_no from enhet_2003_10_27 where enhet_2003_10_27.etter_dato_inn is not null ) ;
    # 12624 
    
    alter table enhet disable all triggers;
    update enhet a set (a.dato_ut) =
      (select b.etter_dato_ut
       from enhet_2003_10_27 b
       where b.seq_no = a.enhet_seq_no
       and a.dato_ut is null)
    where a.dato_ut is null   
    and a.enhet_seq_no in (select seq_no from enhet_2003_10_27 where enhet_2003_10_27.etter_dato_ut is not null ) ;
    
    alter table enhet enable all triggers;
    
    sjekk konsistens
    select enhet_seq_no, dato_inn, dato_ut from enhet
    minus
    select       seq_no, etter_dato_inn, etter_dato_ut from enhet_2003_10_27
    minus  
    select enhet_seq_no, dato_inn, dato_ut from enhet
    
    
       SEQ_NO ETTER_DATO ETTER_DATO
    --------- ---------- ----------
         6342 01.01.2001 2003-10-28 14:09:43  men det er jo dagens så alt ok
         
         
    /////////////////////////////////////////////////////////////////////////////////////////////////////////
    
    --Hvor mange nivå har vi !!!!
    --  current    prev
      1
      2    1  --Nivå 2
      3    2  --Nivå 3
    
    select n3.enhet_seq_no
    from  enhet  n1,
      enhet  n2,
      enhet  n3
    where   n2.prev_enhet_seq_no  = n1.enhet_seq_no  
    and  n3.prev_enhet_seq_no  = n2.enhet_seq_no  
    --Konklusjon typisk bensin pumper som er ok
    --eks enhet_seq_no 8994 bensinpumpe med overordnet del = grill
            7489
            8994
    Slette overføldige view
    --OBV
    --drop view v_m_enhet;
    --drop view v_m_enhet_app;
    
    index (enhet SYS_C003030) index(vare_gruppe VAREGRUPPE_I1)
    
    
    
              Parent ONLY      Rekursiv      DropDown
    ENHET_SEQ_NO               x
    PREV_ENHET_SEQ_NO          x
    ENHET_BESK                 x
    VARE_GRUPPE_SEQ_NO         x        x inner
    SERIE_SEQ_NO               x        x outer
    LOCATION_SEQ_NO            x        x outer
    ENHET_KVAL_SEQ_NO          x        x outer
    -----------------------------------------------------------------------
    VAR_BIL_SEQ_NO                 x    x outer
    VAR_MOTOR_TYPE_SEQ_NO          x    x outer  
    VAR_MOTOR_VOLUM_SEQ_NO         x    x outer
    VAR_KJORE_GRP_SEQ_NO           x    x outer
    VAR_DORER_SEQ_NO               x    x outer
    -----------------------------------------------------------------------
    KM                             x
    REG_NO                         x
    CHASSIS_NO                     x
    FARGE_KODE                     x
    BETEGNELSE                     x
    GEAR_TYPE                      x
    MILJO_KLARERT_ID               x
    SERVO                          x
    
    ----------------------------------------------------------- v_enhet ------------------------------------------------------------------------------------------
    create or replace view v_enhet as
    select /*+ ordered  first_rows */
    /*
    Dato       Endring
    ===       =======   
    14-02-04   lagt inn temp
    27-08-07   lagt inn dato_inn
    14-05-06   lagt inn prod_nr
    27-11-06   lagt inn vendor_data_no skal brukes i v_enhet_full sa t_enhet_full sa v_map_obas_nbf
    07-07-07   legger ut hold_on slik at kun records forskjellig fra J legges ut
               select hold_on,count(*) from enhet group by hold_on
    20-02-08   Vinterferie Valldall  lagt inn dato_ut
    30-06-08   sommerferie Hovden legger inn bilder numerisk 0 eller 1
    2010_03_29 Lagt inn pris_inkl_mva
    2010_03_30 Lagt inn pris_solgt_inkl_mva
    2010_08_04 Lagt inn paa_bil
    2011_02_02 lagt inn old_serie_seq_no
    2012_01_06 legger inn pre_serie_seq_no  dvs slik at V15899 kan brukes til å søke opp alle deler på det vraket
    */
    --1)Info som ALLTID skal ligge på item
    -------------------
      enhet.enhet_seq_no          as      enhet_seq_no,
      enhet.prev_enhet_seq_no     as prev_enhet_seq_no,
      enhet.enhet_besk            as enhet_besk, 
      enhet.vare_gruppe_seq_no    as vare_gruppe_seq_no,
      enhet.serie_seq_no          as serie_seq_no,
      enhet.location_seq_no       as location_seq_no,
      enhet.enhet_kval_seq_no     as enhet_kval_seq_no,
      enhet.hold_on               as hold_on,        
      enhet.pris_inkl_mva         as pris_inkl_mva,
      enhet.pris_solgt_inkl_mva   as pris_solgt_inkl_mva,
      nvl(enhet.paa_bil,'N')      as paa_bil,
      enhet.old_serie_seq_no      as old_serie_seq_no,
    --2 Info som ALLTID hentes fra vrak, eller annet overordnet del. NBNB kun to nivåer 
    -------------------
                               enhet_2.serie_seq_no                     as pre_serie_seq_no,
      nvl(enhet.var_bil_seq_no,enhet_2.var_bil_seq_no)                  as var_bil_seq_no, 
      nvl(enhet.var_motor_type_seq_no,enhet_2.var_motor_type_seq_no)    as var_motor_type_seq_no, 
      nvl(enhet.var_motor_volum_seq_no,enhet_2.var_motor_volum_seq_no)  as var_motor_volum_seq_no, 
      nvl(enhet.var_kjore_grp_seq_no,enhet_2.var_kjore_grp_seq_no)      as var_kjore_grp_seq_no, 
      nvl(enhet.var_dorer_seq_no,enhet_2.var_dorer_seq_no)              as var_dorer_seq_no,   
      --direkte  
      nvl(enhet.km,enhet_2.km)                                          as km,
      nvl(enhet.reg_no,enhet_2.reg_no)                                  as reg_no,
      nvl(enhet.chassis_no,enhet_2.chassis_no)                          as chassis_no, 
      nvl(enhet.farge_kode,enhet_2.farge_kode)                          as farge_kode, 
      nvl(enhet.betegnelse,enhet_2.betegnelse)                          as betegnelse, 
      nvl(enhet.gear_type,enhet_2.gear_type)                            as gear_type, 
      nvl(enhet.miljo_klarert_id,enhet_2.miljo_klarert_id)              as miljo_klarert_id,
      nvl(enhet.servo,enhet_2.servo)                                    as servo, 
      enhet.temp                                                        as temp,
      enhet.dato_inn                                                    as dato_inn,
      enhet.dato_ut                                                     as dato_ut,
      enhet.prod_nr                                                     as prod_nr,
      vendor_data.vendor_data_no                                        as vendor_data_no,
      --LBK bilder 1 ingen 0
      decode (nvl(enhet_blobs.enhet_seq_no,0),0,0,1)                    as bilder
    from  enhet    enhet,    
          enhet    enhet_2,
          -- for å få distincte
         (select distinct enhet_seq_no as enhet_seq_no
          from enhet_blobs)  enhet_blobs,
          vendor_data        vendor_data
    where 1=1  
    and  enhet.prev_enhet_seq_no  = enhet_2.enhet_seq_no            (+) 
    and  enhet.enhet_seq_no       = enhet_blobs.enhet_seq_no        (+) 
    and  enhet.vendor_data_seq_no = vendor_data.vendor_data_seq_no  (+)
    /
    grant select, insert,update,delete on v_enhet to public
    /
    
    select bilder,count(*) from v_enhet group by bilder;
        BILDER   COUNT(*)
    ---------- ----------     3.3.12
             0      42433     44902
             1       8619      37848
    connect system/manager@targa1;
    grant analyze any to ola;
    grant analyze any to lbk;
    grant insert any table to ola;
    grant insert any table to lbk;
    grant update any table to ola;
    grant update any table to lbk;
    grant select, insert,update,delete on plan_table to public
    /
    
    select count(*) from enhet;
    select count(*) from v_enhet;
    select count(*) from v_enhet_full;
    
    alter table var_motor_type add (motor_type_besk varchar2(20));
    update var_motor_type set motor_type_besk='Forgasser' where motor_type_id='F';
    update var_motor_type set motor_type_besk='Injection' where motor_type_id='I';
    update var_motor_type set motor_type_besk='Diesel' where motor_type_id='D';
    
    
    
    
    
    
    
    
    ----------------------------------------------------------- v_del_bil_blobs ------------------------------------------------------------------------------------------
    create or replace view v_del_bil_blobs as
    select 
    /*
    Henter 4 felt for del_blob_seq_no og 4 felt for bil_blobs_seq_no for et gitt enghet-seq_no
    Ford dynamoer
    dele_nr    seq_no  # bilder  overordnet vrak  seq_no  # bilder
    D25042    68798  2    V8912    68664    4
    D25100    68859  1    V8884    68588    1 ( 1 slettet i testøyemed)
      
    Dato    Endring
    ===       =======   
    */
      driver.enhet_seq_no            as enhet_seq_no,
    --DEL
    ------
      (select max(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = del.enhet_seq_no
      )                as del_1,
            decode (
        (select min(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = del.enhet_seq_no
        ),  
        (select max(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = del.enhet_seq_no
        ),null,
        (select min(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = del.enhet_seq_no
        )
             )               as del_2,
    --BIL
    ------
      (select max(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = bil.enhet_seq_no
      )                as bil_1,
            decode (
        (select min(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = bil.enhet_seq_no
        ),  
        (select max(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = bil.enhet_seq_no
        ),null,
        (select min(t1.blobs_seq_no) 
        from enhet_blobs t1
        where t1.enhet_seq_no = bil.enhet_seq_no
        )
             )               as bil_2               
    from   (   --HOTTE enhet.enhet_seq_no som har bilde på del ELLER på overordnet del 9346
        select  distinct
          enhet.enhet_seq_no  as enhet_seq_no,
          enhet.prev_enhet_seq_no  as prev_enhet_seq_no
        from   enhet     enhet,
        enhet_blobs  enhet_blobs,
        enhet_blobs  prev_enhet_blobs
        where  enhet.enhet_seq_no  =      enhet_blobs.enhet_seq_no (+)
        and  enhet.prev_enhet_seq_no  =      prev_enhet_blobs.enhet_seq_no (+)
        -- vrak kan ha bilde og del mangle etc 
        and  (enhet_blobs.blobs_seq_no is not null or prev_enhet_blobs.blobs_seq_no is not null)
      )   driver,
      enhet  del,
      enhet  bil
    where  ----liste ut alle enhet_seq_no KUN på del
      driver.enhet_seq_no   = del.enhet_seq_no    (+)
      ----liste ut alle enhet_seq_no KUN på bil
    and  driver.prev_enhet_seq_no = bil.enhet_seq_no    (+)
    /
    grant select on v_del_bil_blobs to public
    /
    
    ----------------------------------------------------------- from t_4021 to enhet ------------------------------------------------------------------------------------------
    --avvik
    -------
    select vrak_nr from t_4021
    minus
    select serie_no from v_enhet_master;
    
    --update
    --------
    alter table enhet disable all triggers;
    update enhet set (date_4021,pris_4021) =
    (select 
           --t2.enhet_seq_no,
           --vrak_nr                     as serie_no,
           to_date(dato,'dd.mm.yyyy')  as date_4021,
           to_number(bet_kr)           as pris4021
    from t_4021,
         v_enhet_master t2
    where t_4021.vrak_nr= t2.serie_no
    and   t2.enhet_seq_no = enhet.enhet_seq_no
    and                     enhet.pris_4021 is null)
    where exists (select 'x'             
    from t_4021,
         v_enhet_master t2
    where t_4021.vrak_nr= t2.serie_no
    and   t2.enhet_seq_no = enhet.enhet_seq_no
    and                     enhet.pris_4021 is null)
    /
    alter table enhet enable all triggers;
    
    ----------------------------------------------------------- v_enhet_full ------------------------------------------------------------------------------------------
    create or replace view v_enhet_full as
    select 
    /*
    Dato    Endring
    ===       =======   
    02-11-03  pipet på d på dorer_id
    14-02-04  lagt inn temp_marknad og loc_id_01 ref skal brukes som dw_master med utvidete søke muligheter
        samt decode(location.loc_id,null,'0',1) as loc_id_01,
    04-08-04  legger inn dato_inn ut    
    03-12-07  legger ut k_grp_id og tatt vekk d på dører som er tomme
    14-05-05  legger inn prod_nr slik at den kan flyttes til t_enhet_full
    27-11-06  legger ut vendor_data_no skal brukes i t_enhet_full og v_map_obas_nbf
    07-07-07  legger ut hold_on slik at kun records forskjellig fra J legges ut
              select hold_on,count(*) from enhet group by hold_on
    20-02-08  Vinterferie Valldall  lagt inn dato_ut, serie_seq_no, location_seq_no                    
        HUSK alltid endre t_enhet_fulll når v_enhet_full endres ref 
        bruker inserr into t_enehet_full select * from v_enhet_full f.eks i OBAStoLBK
    30-06-08 sommerferie Hovden legger inn bilder numerisk 0 eller 1
    05-09-08 legger inn 4 felt for del_blob_seq_no og 4 felt for bil_blobs_seq_no
       view v_del_bil_blobs
       FØR  select count(*) from v_enhet_full 51065
       ETTER  51065
    12-09-08   Siri at Humminbridge, Chesnut  rettet rekkefølege dato ut, in  
    6-09-08    Etter betty aå med 4 tall aar_4
    2010_03_29 lagt inn pris_inkl_mva
    2010_03_30 lagt inn pris_solgt_inkl_mva
    2010_08_04 tar vekk deler paa_bil slik at de ikke havner på internett. Ref skal brukes til plukke liste
    2011_02_02 lagt inn old_serie_no fra serie og scope fra v_var_bil som erstatter v_bil som ble brukt tidligere
    2011_10_18 tar vekk prisene
    2012_01_0  legger inn pre_serie_no  ( dvs vrak nr)
    2012_03_03 legger inn paa_bil
    2012_03_06 lagt inn export_yn fra location
    */
    --1)Info som ALLTID skal ligge på item
    -------------------
      v_enhet.enhet_seq_no                                                          as     enhet_seq_no,
      v_enhet.prev_enhet_seq_no                                                     as pre_enhet_seq_no,
      v_enhet.enhet_besk                                                            as enhet_besk, 
      v_enhet.vare_gruppe_seq_no                                                    as vare_gruppe_seq_no,
      vare_gruppe.vare_gruppe_id                                                    as vare_gruppe_id,
      v_enhet.location_seq_no                                                       as location_seq_no,
      location.loc_id                                                               as loc_id, 
      decode(location.loc_id,null,'0',1)                                            as loc_id_01,
      location.export_yn                                                            as export_yn,
      v_enhet.serie_seq_no                                                          as serie_seq_no,
      decode(serie.serie_no,null,null,
      decode(vare_gruppe.vare_gruppe_id,'VRAK',  'V'||serie.serie_no,
                'D'||serie.serie_no)  )                                             as serie_no,
        v_enhet.enhet_kval_seq_no                                                   as enhet_kval_seq_no,
        enhet_kvalitet.kval_id                                                      as kval_id,
        v_enhet.hold_on                                                             as hold_on,        
    --2 Info som ALLTID hentes fra vrak, eller annet overordnet del. NBNB kun to nivåer 
    -------------------
      --Antar alltid 2 nivåer og at øverste alltid vrak
      decode(pre_serie.serie_no,null,null,'V'||pre_serie.serie_no)                   as pre_serie_no,
      v_bil.var_bil_seq_no                                                           as var_bil_seq_no, 
      v_bil.fab_navn                                                                 as fab_navn,       
      v_bil.type_id                                                                  as type_id,        
      v_bil.aar                                                                      as aar,            
      v_bil.aar_4                                                                    as aar_4,
      var_motor_type.motor_type_id                                                   as motor_type_id,
      var_motor_type.motor_type_besk                                                 as motor_type_besk,
      var_motor_volum.motor_vol_id                                                   as motor_vol_id,
      --NB onsker ikke d pipet på tomme forekomster
      decode(var_dorer.dorer_id,null,null,var_dorer.dorer_id||'d')                   as dorer_id,
      var_kjore_grp.k_grp_id                                                         as k_grp_id,
      --direkte  
      km                                                                             as km,
      reg_no                                                                         as reg_no,
      chassis_no                                                                     as chassis_no, 
      farge_kode                                                                     as farge_kode, 
      betegnelse                                                                     as betegnelse, 
      gear_type                                                                      as gear_type, 
      miljo_klarert_id                                                               as miljo_klarert_id,
      servo                                                                          as servo ,
      decode(v_enhet.temp,null,null,'X')                                             as temp_merknad,
      dato_ut                                                                        as dato_ut,
      dato_inn                                                                       as dato_inn,
      paa_bil                                                                        as paa_bil,
      prod_nr                                                                        as prod_nr,  
      decode(old_serie.serie_no,null,null,
      decode(vare_gruppe.vare_gruppe_id,'VRAK','V'||old_serie.serie_no,
                 'D'||old_serie.serie_no)  )                                         as old_serie_no,
      vendor_data_no                                                                 as vendor_data_no,
      v_enhet.pris_inkl_mva                                                          as pris_inkl_mva,  
      v_enhet.pris_solgt_inkl_mva                                                    as pris_solgt_inkl_mva,
      v_bil.scope                                                                    as scope,
      v_enhet.bilder                                                                 as bilder,
      --sørger for at det bli number format i alle kolonnene hvor blobs_seq_no plasseres
      v_del_bil_blobs.del_1                                                          as del_1,
      to_number(v_del_bil_blobs.del_2)                                               as del_2,
      to_number('')                                                                  as del_3,
      to_number('')                                                                  as del_4,
      v_del_bil_blobs.bil_1                                                          as bil_1,
      to_number(v_del_bil_blobs.bil_2)                                               as bil_2,
      to_number('')                                                                  as bil_3,
      to_number('')                                                                  as bil_4 
    from   
      v_enhet              v_enhet,    
      vare_gruppe          vare_gruppe,  
      enhet_kvalitet       enhet_kvalitet, 
      location             location,      
      serie                serie,    
      serie                old_serie,
      serie                pre_serie,
      v_var_bil            v_bil,    
      var_motor_type       var_motor_type, 
      var_motor_volum      var_motor_volum,
      var_kjore_grp        var_kjore_grp,  
      var_dorer            var_dorer,
      --x-tabbulere bildene
      ---------------------
      v_del_bil_blobs      v_del_bil_blobs
    --1)Info som ALLTID skal ligge på item
    -------------------
    where  v_enhet.vare_gruppe_seq_no   = vare_gruppe.vare_gruppe_seq_no
    and  v_enhet.enhet_kval_seq_no      = enhet_kvalitet.enhet_kval_seq_no      (+)  
    and  v_enhet.location_seq_no        = location.location_seq_no              (+)  
    and  v_enhet.serie_seq_no           = serie.serie_seq_no                    (+)
    and  v_enhet.old_serie_seq_no       = old_serie.serie_seq_no                (+)
    --2 Info som ALLTID hentes fra vrak, eller annet overordnet del (hvis det velå merke ikke er overordnet del). NBNB kun to nivåer 
    -------------------
    and  v_enhet.pre_serie_seq_no       = pre_serie.serie_seq_no                (+)
    and  v_enhet.var_bil_seq_no         = v_bil.var_bil_seq_no                  (+)
    and  v_enhet.var_motor_type_seq_no  = var_motor_type.var_motor_type_seq_no  (+)
    and  v_enhet.var_motor_volum_seq_no = var_motor_volum.var_motor_volum_seq_no(+)
    and  v_enhet.var_kjore_grp_seq_no   = var_kjore_grp.var_kjore_grp_seq_no    (+)
    and  v_enhet.var_dorer_seq_no       = var_dorer.var_dorer_seq_no            (+)
    --bildene
    and  v_enhet.enhet_seq_no           = v_del_bil_blobs.enhet_seq_no          (+)
    ----------------------------------------------------------------------------------------
    -----------------------------UUUUUUUTTTTTTTTTTTTTTTTTTTTTTTTTTT-------------------------
    -- sensurer hold on items som er null, N og J
    --and     nvl(v_enhet.hold_on,'x')   <> 'J'
    -- tar vekk paa_bil (er enten N, J fra v_enhet
    --and     nvl(v_enhet.paa_bil,'N')   <> 'J'
    /
    grant select on v_enhet_full to public
    /
    
    --truncate table t_enhet_full;
    insert into t_enhet_full select * from v_enhet_full;
    commit;
              
    select count(*) from v_enhet_full;
    #19253 03.12.2004
    #51022 30.06.2008
    #73718 02.02.2011
    #78857 18.10.2011
    #82332 03.03.2012
    #82286 03.03.2012 etter opprydding i enhet
    #82750 03.03.2012 etter opprydding i enhet og utelating av kriteriene
    #83736 15.04.2012 
    #94950 28.08.2013
    #95816 05.10.2013    
    select * from v_enhet_full where enhet_seq_no=45452;  
    
    select count(*) from enhet;
    select count(*) from t_enhet_full;
    #94950 05.10.2013    
    
----------------------------------------------------------- v_enhet_master2 -----------------------------------------------------------------------------------------
    create or replace view v_enhet_master2 as
        --create or replace view tr as
        /* 
          Brukes av APEX i classic report
          Dato          Endring
          ===           =======        
          2020-01-06    laget for å få in faceter
          */
        with 
             nr as ( -- alternativ til v_serie_no
                    select 
                         serie_seq_no                                          serie_seq_no
                        ,decode(serie_anv_seq_no,0,null,1,'V','D')|| serie_no  serie_no
                    from serie 
                ) 
            ,merke as (
                select 
                     var_bil.var_bil_seq_no as var_bil_seq_no 
                    ,fabrikant.fab_navn     as merke
                from fabrikant
                    ,var_bil
                where 1=1     
                    and  var_bil.fab_seq_no    = fabrikant.fab_seq_no   )
            ,modell as (
                select 
                     var_bil.var_bil_seq_no as var_bil_seq_no 
                    ,type.type_id           as modell
                from type
                    ,var_bil
                where 1=1     
                    and  var_bil.type_seq_no    = type.type_seq_no      )
            ,enhet_vrak as (
                select 
                     enhet_seq_no
                    ,serie_no   as nr_vrak 
                    ,enhet.var_bil_seq_no
                    ,merke
                    ,modell
                    ,betegnelse
                    ,reg_no
                    ,chassis_no
                    ,chassis_no_vegdir
                    ,tecdoc_id
                    ,tecdoc_besk
                    ,km
                from enhet
                    ,nr 
                    ,merke
                    ,modell
                where 1=1
                    and enhet.serie_seq_no      = nr.serie_seq_no    --vrak kan aldri miste vraknr
                    and enhet.var_bil_seq_no    = merke.var_bil_seq_no (+)
                    and enhet.var_bil_seq_no    = modell.var_bil_seq_no  (+)
            )
        select
                --seq
                     enhet_del.enhet_seq_no                                                                                                         as enhet_seq_no
                    ,enhet_del.vare_gruppe_seq_no                                                                                                   as vare_gruppe_seq_no
                    ,enhet_del.vare_gruppe_seq_no                                                                                                   as vare_gruppe_seq_no_2
                    ,location_seq_no                                                                                                                as location_seq_no
                    ,nr_del.serie_no                                                                                                                as nr_del
                    ,nr_del_old.serie_no                                                                                                            as nr_del_old
                    ,enhet_vrak.nr_vrak                                                                                                             as nr_bil
                --utility
                    --,f_prosess( 'id', enhet_del.vare_gruppe_seq_no, enhet_del.serie_seq_no, enhet_del.location_seq_no, enhet_del.paa_bil)           as prosess
                    ,stamp_prosess_current                                                                                                          as stamp_prosess_current
                    ,dato_inn                                                                                                                       as dato_inn                
                    ,dato_ut                                                                                                                        as dato_ut               
                --part
                    ,part_oem_main      ||decode(part_oem_main,null,null,', ')||
                     part_oem_secondary ||decode(part_oem_main,null,null,', ')||
                     prod_nr                                                                                                                        as oem_nr
                    ,part_oem_main                                                                                                                  as part_oem_main
                    ,part_oem_secondary                                                                                                             as part_oem_secondary
                    ,prod_nr                                                                                                                        as prod_nr
                    ,part_brand                                                                                                                     as part_brand
                    ,part_eqv_main
                    ,part_eqv_secondary
                --deler
                    ,enhet_besk                                                                                                                     as enhet_besk
                    ,pris_inkl_mva                                                                                                                  as pris_inkl_mva
                    ,temp                                                                                                                           as temp
                --vrak
                    ,nvl(merke_del.var_bil_seq_no       ,enhet_vrak.var_bil_seq_no      )   as var_bil_seq_no   
                    ,nvl(merke_del.merke                ,enhet_vrak.merke               )   as merke            --fabrikant
                    ,nvl(modell_del.modell              ,enhet_vrak.modell              )   as modell           --type_id
                    ,nvl(enhet_del.betegnelse           ,enhet_vrak.betegnelse          )   as betegnelse
                    ,nvl(enhet_del.reg_no               ,enhet_vrak.reg_no              )   as reg_no
                    ,nvl(enhet_del.tecdoc_id            ,enhet_vrak.tecdoc_id           )   as tecdoc_id           
                    ,nvl(enhet_del.tecdoc_besk          ,enhet_vrak.tecdoc_besk         )   as tecdoc_besk
                    ,nvl(enhet_del.chassis_no           ,enhet_vrak.chassis_no          )   as chassis_no
                    ,nvl(enhet_del.chassis_no_vegdir    ,enhet_vrak.chassis_no_vegdir   )   as chassis_no_vegdir
                    ,nvl(enhet_del.km                   ,enhet_vrak.km                  )   as km
                    ,farge_kode                                                                                                                     as farge_kode             
                    ,gear_type                                                                                                                      as gear_type               
                    ,miljo_klarert_id                                                                                                               as miljo_klarert_id     
                    ,servo                                                                                                                          as servo                     
                --dekk og felg
                    ,felg_type_seq_no                                                                                                               as felg_type_seq_no  
                    ,actor_seq_no                                                                                                                   as actor_seq_no   
                    ,dekk_type_seq_no                                                                                                               as dekk_type_seq_no    
                    ,dekk_antall                                                                                                                    as dekk_antall
                    ,dekk_monster_dybde_1                                                                                                           as dekk_monster_dybde_1 
                    ,dekk_monster_dybde_2                                                                                                           as dekk_monster_dybde_2     
                    ,dekk_produsert_aar_1                                                                                                           as dekk_produsert_aar_1    
                    ,dekk_produsert_aar_2                                                                                                           as dekk_produsert_aar_2   
                    ,dekk_load_index_1                                                                                                              as dekk_load_index_1    
                    ,dekk_load_index_2                                                                                                              as dekk_load_index_2    
            from 
                 nr             nr_del
                ,nr             nr_del_old
                ,merke          merke_del
                ,modell         modell_del
                ,enhet          enhet_del
                ,enhet_vrak     enhet_vrak
            where 1=1
                and enhet_del.old_serie_seq_no  = nr_del_old.serie_seq_no       (+) 
                and enhet_del.serie_seq_no      = nr_del.serie_seq_no           (+) --del kan miste vraknr
                and enhet_del.var_bil_seq_no    = merke_del.var_bil_seq_no      (+)
                and enhet_del.var_bil_seq_no    = modell_del.var_bil_seq_no     (+)
                ---vrak
                and enhet_del.prev_enhet_seq_no = enhet_vrak.enhet_seq_no       (+)
    /

            select count(*) from v_enhet_master2;   select count(*) from enhet;
                21045   2021-01-06
                21045   2021-01-06  --innjoin på merke OK
                164746  2021-01-06  --kun enhet  stemmer med select count(*) from enhet;
                163941  2020-01-08                  165008
                165008  2020-01-08
                165010  2020-01-09                  165010

            select enhet_seq_no1,count(*) from tt group by enhet_seq_no1 having count(*)>1;


            --select * from enhet where location_seq_no is not null

            select decode(nr_del_old,null,null,'x') , count(*) from v_enhet_master2 group by decode(nr_del_old,null,null,'x');


        enhet felter som må bobles opp mot bildelene:
            var_motor_type_seq_no                                                                                                       
            var_motor_volum_seq_no                                                                                                         
            var_betegn_seq_no                                                                                                             
            var_kjore_grp_seq_no                                                                                                        
            var_dorer_seq_no                                                                                                             
            farge_kode                                                                                                      
            betegnelse                                                                                                      
            gear_type                                                                                                            
            miljo_klarert_id                                                                                            
            servo                                                                                                                          
            farge_kode              
            betegnelse             
                gear_type                
            miljo_klarert_id       
            servo                     
            dato_inn                
            dato_ut                
                tecdoc_id             
                chassis_no_vegdir      
            prosess 

            Så har vi dei som ikke er i enhet
                motor_kode
            motor_test
                moto_hk
                gear_kode
            gear_test
            aar4
            scope /slå sammen med "modell" --eks saab 900 95-97
            Drivstoff type
            karosseriform

----------------------------------------------------------- v_enhet_master "lynet"------------------------------------------------------------------------------------
    -- create or replace view v_enhet_master as
    create or replace view v_enhet_master_lynet as
        --create or replace view t as
        /* 
          Brukes av PB i datavindu: d_bil_m_enhet hvor aktuelle datavindu settes i menylinjen
                         datavinduobjekt: d_bil_m_enhet
                                    v_fx: mapping OBV LBK
                Merk at vi hardkoder inn at loc_id is not null
          Dato    Endring
          ===       =======        
          01-04-2002  Legger inn kolonner fra v_m_enhet
          21-10-2002  Legge decodet flagg for loc_id, samt tar vekk harkoding av loc_is is null
          25-10-2002  Ferdig med tuningen first_rows ut pga order går da fortere
          27-04-2003  Lagt inn temp felt
          15-04-2004  lagt in reg_no
          16-02-2004  lagt inn prev_serie_no
          26-04-2004  lagt inn konvertering av serie_nr ihht paa_bil og miljøklarertid, paa_bil, db_katalog
          2005_04_11  lagt inn dato_inn,dato_ut
          01-11-2005  Lagt inn merke og prod nr 
          02-11-2005  Lagt inn old_serie_no
          23-12-2005  Lagt inn tecdoc_id
          29-12-2005  Lagt inn tecdoc_besk
          15-12-2006  legger inn vendor_data.vendor_data_no
          07-04-2006  lagt inn fab type år kallr var_bil
          16-04-2006  korrigerer var bil år til yy
          03_02_2007  flag på at bilde finnes
          22_06_2007  hold_on lagt inn
          19-02-2011  takst_seq_no
          10-05-2011  enhet_sub . motor_kode, gear_kode
          23-03-2014  lagt tValldal  lagt inn pris_inkl_mva og pris_org refil scope og type klasse slik at v_enhet_master kan brikes med samme kolonnene som v_bildeler_apex (side 205=
          16-04-2014  Påske Valldal  lagt inn pris_inkl_mva og pris_org ref Ulf sykemeldt og holder på med prising
          01-05-2014  henter inn scope inline kode hentet fra v_bildeler
          18-11-2014  legger ut temp i egen kolonne til bruk i v_enhet_master_apex
          24-02-2015  henter prod_nr, morot_kode, gear kode fra motor, dynamo, etc til alle andre deler
          30-08-2015  lagt inn scoope_range som i v_var_bil slik at den blir søkbart i v_enhet_master_apex
          23-07-2015  lagt inn chassis_no_vegdir
          30-07-2020  lagt in å fra f_utf('aa')
          22-01-2021  byttet navn til v_enhet_master_lynet
        */                 
        select /*+ ordered   */
          enhet.enhet_seq_no                                                                                          as enhet_seq_no,
          enhet.serie_seq_no                                                                                          as serie_seq_no,
          enhet.location_seq_no                                                                                       as location_seq_no,    
          enhet_2.enhet_seq_no                                                                                        as prev_enhet_seq_no,
          vare_gruppe.vare_gruppe_seq_no                                                                              as vare_gruppe_seq_no,
          vare_gruppe.vare_gruppe_id                                                                                  as vare_gruppe_id,
          --Nivå 1a                                                                                                     --Nivå 1a
            location.loc_id                                                                                             as loc_id, 
            decode(location.loc_id,null,'0',1)                                                                          as loc_id_01,
            decode(serie.serie_no,null,decode(enhet.paa_bil,'J','P'||f_utf('aa')||' bil',null)
                                            ,decode(vare_gruppe.vare_gruppe_id,'VRAK','V'||serie.serie_no,
                                            'D'||serie.serie_no)
                                                     )                                                                  as serie_no,  
            decode(serie_old.serie_no,null,decode(enhet.paa_bil,'J','P'||f_utf('aa')||' bil',null)
                                            ,decode(vare_gruppe.vare_gruppe_id,'VRAK','V'||serie_old.serie_no,
                                            'D'||serie_old.serie_no)
                                                     )                                                                  as old_serie_no,  
            --Prev med lure decode så slipper vi å hoste opp varegruppe tabellen
            decode(serie_2.serie_no,null,null,
            decode(enhet_2.vare_gruppe_seq_no,'1',          'V'||serie_2.serie_no,
                        'D'||serie_2.serie_no)  )                                                                       as prev_serie_no,  
            enhet.enhet_kval_seq_no                                                                                     as kval_id,
            enhet.enhet_besk                                                                                            as enhet_besk,
            enhet.temp                                                                                                  as temp,
            enhet_blobs.ant                                                                                             as ant_foto,
            enhet.hold_on                                                                                               as hold_on,
            enhet.pris_inkl_mva                                                                                         as pris_inkl_mva,
            enhet.org_pris_inkl_mva                                                                                     as org_pris_inkl_mva,
            enhet.org_dato_inn                                                                                          as org_dato_inn,
            enhet.takst_seq_no                                                                                          as takst_seq_no,
            enhet.pris_solgt_inkl_mva                                                                                   as pris_solgt_inkl_mva,
            enhet.salg_via                                                                                              as salg_via,
            enhet.salg_funnet                                                                                           as salg_funnet,
          --Nivå 2                                                                                                      --Nivå 2
            nvl(enhet.var_bil_seq_no,enhet_2.var_bil_seq_no)                                                            as var_bil_seq_no,
            nvl(fabrikant.fab_navn,fabrikant_2.fab_navn)                                                                as fab_navn,
            nvl(type.type_id,type_2.type_id)                                                                            as type_id,
            nvl(aar_model.aar,aar_model_2.aar)                                                                          as aar,
            nvl(fabrikant.fab_navn,fabrikant_2.fab_navn)||' '||
                        nvl(type.type_id,type_2.type_id)||' '||
               to_char(nvl(aar_model.aar,aar_model_2.aar),'yy')                                                         as var_bil,
            nvl(enhet.betegnelse,enhet_2.betegnelse)                                                                    as betegnelse,    
            nvl(enhet.reg_no,enhet_2.reg_no)                                                                            as reg_no,
            nvl(enhet.chassis_no,enhet_2.chassis_no)                                                                   as chassis_no,
            nvl(enhet.chassis_no_vegdir,enhet_2.chassis_no_vegdir)                                                      as chassis_no_vegdir,
            nvl(enhet.tecdoc_id,enhet_2.tecdoc_id)                                                                      as tecdoc_id,
            nvl(enhet.tecdoc_besk,enhet_2.tecdoc_besk)                                                                  as tecdoc_besk,
            enhet.miljo_klarert_id                                                                                      as miljo_klarert_id,
            enhet.paa_bil                                                                                               as paa_bil,
            enhet.db_katalog                                                                                            as db_katalog,
            decode(enhet.temp,null,null,'X')                                                                            as temp_merknad,
            enhet.dato_inn                                                                                              as dato_inn,
            enhet.dato_ut                                                                                               as dato_ut,
            enhet.merke_nr                                                                                              as merke_nr,
            enhet.prod_nr                                                                                               as prod_nr,              --<< hentes fra tilstøtend del
            vendor_data.vendor_data_no                                                                                  as vendor_data_no,
            nvl(enhet.motor_kode,enhet_2.motor_kode)                                                                    as motor_kode,           --<< hentes fra tilstøtend del
            nvl(enhet.gear_kode,enhet_2.gear_kode)                                                                      as gear_kode,            --<< hentes fra tilstøtend del
            null                                                                                                        as type_klasse,
          --V_BILDELER    2013_08_25 må bruker outer join på scope får å få frem default aar dersom scope mangler                                       
            nvl2(enhet.var_bil_seq_no,                                                                                                      
                (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                            to_char(aar_model.aar,'yyyy'))                                                                                  
                                                   from var_bil_scope,aar_model,var_bil                                                     
                                                   where 1=1                                                                                
                                                   and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no                              
                                                   and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                   and var_bil.aar_seq_no              =aar_model.aar_seq_no),                              
                (select nvl(f_scope ('SCOPE',var_bil_scope.scope_start,var_bil_scope.scope_stop),                                           
                            to_char(aar_model.aar,'yyyy'))                                                                                  
                                                   from var_bil_scope,aar_model,var_bil,enhet prev_enhet                                    
                                                   where 1=1                                                                                
                                                   and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                   and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no                              
                                                   and var_bil.var_bil_scope_seq_no    =var_bil_scope.var_bil_scope_seq_no (+)              
                                                   and var_bil.aar_seq_no              =aar_model.aar_seq_no))                              as scope,
            nvl2(enhet.var_bil_seq_no,                                                                                                      
                (select var_bil.var_bil_scope_seq_no
                                                   from var_bil                                                     
                                                   where 1=1                                                                                
                                                   and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no),
                (select var_bil.var_bil_scope_seq_no
                                                   from var_bil,enhet prev_enhet                                    
                                                   where 1=1                                                                                
                                                   and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                   and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no))                            as var_bil_scope_seq_no,
            --kopi fra v_var_bil
            --Hvis var_bil_seq_no finnes
            --1) range fom, tom       1991 1992 1993 osv
            --2) range fom            +50år
            --3) range      tom       -50år
            --4) range          null  1991  år bli laget inn fra var_bil  ref under
            --                                  nvl(aar_model.aar,aar_model_2.aar) as aar,
            --nvl2(var_bil.var_bil_seq_no,nvl(f_scope_sok(var_bil.var_bil_scope_seq_no,'RANGE'),
            --                                (select to_char(aar_model.aar,'yyyy')
            --                                  from aar_model
            --                                  where 1=1     
            --                                  and   var_bil.aar_seq_no  = aar_model.aar_seq_no
            --                                )
            --                            ),null)                                                                                       scope_range,    
            nvl2(
            --kopi av var_bil_seq_no over
            nvl(enhet.var_bil_seq_no,enhet_2.var_bil_seq_no)
            --slutt kopi  
            ,nvl(f_scope_sok(
            --kopi av over var_bil_scope_seq_no  
            nvl2(enhet.var_bil_seq_no,                                                                                                      
                (select var_bil.var_bil_scope_seq_no
                                                   from var_bil                                                     
                                                   where 1=1                                                                                
                                                   and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no),
                (select var_bil.var_bil_scope_seq_no
                                                   from var_bil,enhet prev_enhet                                    
                                                   where 1=1                                                                                
                                                   and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                   and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no))       
            --slutt kopi
            ,'RANGE'),
            (to_char(nvl(aar_model.aar,aar_model_2.aar),'yyyy'))
            ),null)                                                                                                                         as scope_range,
            nvl2(enhet.var_bil_seq_no,                                                                                                      
                (select var_bil.type_seq_no
                                                   from var_bil                                                     
                                                   where 1=1                                                                                
                                                   and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no),
                (select var_bil.type_seq_no
                                                   from var_bil,enhet prev_enhet                                    
                                                   where 1=1                                                                                
                                                   and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                   and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no))                            as type_seq_no,
            nvl2(enhet.var_bil_seq_no,                                                                                                      
                (select var_bil.fab_seq_no
                                                   from var_bil                                                     
                                                   where 1=1                                                                                
                                                   and enhet.var_bil_seq_no            =var_bil.var_bil_seq_no),
                (select var_bil.fab_seq_no
                                                   from var_bil,enhet prev_enhet                                    
                                                   where 1=1                                                                                
                                                   and enhet.prev_enhet_seq_no         =prev_enhet.enhet_seq_no                             
                                                   and prev_enhet.var_bil_seq_no       =var_bil.var_bil_seq_no))                            as fab_seq_no                                         
        from 
            vare_gruppe                             vare_gruppe, 
            vendor_data                             vendor_data,
            enhet                                   enhet,  
            --Niva 1a
              location                                location,      
              serie                                   serie,
              serie                                   serie_old,
              (select enhet_seq_no as enhet_seq_no,
                     count(*)     as ant
              from enhet_blobs
              group by enhet_seq_no )                 enhet_blobs,
            --Nivå 1b
              var_bil                                 var_bil,  
              fabrikant                               fabrikant,
              type                                    type,
              aar_model                               aar_model,
            --Nivå 2
              enhet                                   enhet_2,
              serie                                   serie_2,
              var_bil                                 var_bil_2,
              fabrikant                               fabrikant_2,
              type                                    type_2,
              aar_model                               aar_model_2
        where  1=1
          --Nivå 1a  hente kun direkte fra enhet
            and  enhet.vare_gruppe_seq_no = vare_gruppe.vare_gruppe_seq_no   
            and  enhet.vendor_data_seq_no = vendor_data.vendor_data_seq_no (+)
            and  enhet.location_seq_no    = location.location_seq_no       (+)  
            and  enhet.serie_seq_no       = serie.serie_seq_no             (+)
            and  enhet.old_serie_seq_no   = serie_old.serie_seq_no         (+)
            and  enhet.enhet_seq_no       = enhet_blobs.enhet_seq_no       (+)
          --Nivå 1b                       
            and  enhet.var_bil_seq_no     = var_bil.var_bil_seq_no         (+) 
            and  var_bil.fab_seq_no       = fabrikant.fab_seq_no           (+)  
            and  var_bil.type_seq_no      = type.type_seq_no               (+)  
            and  var_bil.aar_seq_no       = aar_model.aar_seq_no           (+)          
          --Nivå 2 koble                                                   
            and  enhet.prev_enhet_seq_no  = enhet_2.enhet_seq_no           (+)
          --Nivå 2 hente                  
            and  enhet_2.var_bil_seq_no   = var_bil_2.var_bil_seq_no       (+) 
            and  enhet_2.serie_seq_no     = serie_2.serie_seq_no           (+)
            and  var_bil_2.fab_seq_no     = fabrikant_2.fab_seq_no         (+)  
            and  var_bil_2.type_seq_no    = type_2.type_seq_no             (+)  
            and  var_bil_2.aar_seq_no     = aar_model_2.aar_seq_no         (+)          
    /
        grant select on v_enhet_master to public
    /
    
    --dill
          test før:
          --------
            saab motor bensin 2003  --> D38637 2003 scope 2003-2007
                                        D21107 2004 scope 2003-2007
            saab motor bensin 2005  --> 0 treff
    
          test etter:
          -----------
    
    
    
          select
          (select count(*) from   enhet                                         ) tot_enhet,
          (select count(*) from v_enhet2                                        ) tot_v_enhet2,
          --gamle v_enhet_full
          (select count(*) from v_enhet_full                                    ) tot_v_enhet_full,
          (select count(*) from v_enhet2 where html_ok='ja'                     ) html_ok,
          (select count(*) from v_enhet_master                                  ) master
          from dual;
           TOT_ENHET TOT_V_ENHET2 TOT_V_ENHET_FULL    HTML_OK     MASTER
          ---------- ------------ ---------------- ----------     ------
               86233        86233            86233      22240
               88310        88310            88310      22229
               
               88310        88310            88310      22228            <--fils 2012_11_11
               88578        88578            88578      22256            <-2012_11_18 FØR v_map_status koblet inn d.v.s html_ok='Y'  
               88578        88578            88578      21804            <-- v_obas_417.sql flyttet logikk til c_map_status + 
               90152        90152            90152      21739      90152     
              100976       100976           100976      20757     100976 <--2014_04_17 påske Valldal         
              103332       103332           103332      20596     103332 <--2014_08_21
              105846       105846           105846      20855     105846 <--2014_11_18
                                                                  105929 <--2014_11_19
              108383       108383           108383      21151     108383 <--2015_02_24        
              112316       112316           112316      20746     112316 <--2015_08_30 før /etter scope_range      
                                                                  160015 <--2020_07_30 
              165316       165316                                        <--2021-01-23
                                                                   
                                                                  
          --sjekk tempo
          --------bruker v_enhet2
          -----------------------------------------------
          truncate table plan_table;        
          explain plan set statement_id='v_enhet_master' into plan_table for                               
                                    select *  from v_enhet_master where vare_gruppe_id= 'ABS ENHET';
          commit; 
          truncate table plan_table;        
          explain plan set statement_id='v_enhet2' into plan_table for                               
                                   select *  from v_enhet2      where vare_gruppe_id= 'ABS ENHET';
          commit;
          truncate table plan_table;        
          explain plan set statement_id='v_enhet' into plan_table for                               
                                   select *  from v_enhet_master      where vare_gruppe_id= 'ABS ENHET';
          commit;
    
----------------------------------------------------------- v_enhet_salg_y_m_w_v_grp ------------------------------------------------------------------------------------------
    create or replace view v_enhet_salg_y_m_w_v_grp as
    select
        --laget 2013_02_01 bassert på opprinnelig v_enhet_salg som nå heller aggregeres fra dette viewet (mye ryddigere)  
        /*Salg Oktober 2012 =613758,-
          Statistikk
          Antall vrak mottatt
          Antall vrak miljøsanert
          Antall deler lagt på lager
          Veiledende pris på deler lagt på lager
          Antall deler solgt
          Salg kr,-
          Salg Brukte deler for mnd (graf)
        */
           to_char(dato_ut,'yyyy')                                                                                as aar_ut,
           to_char(dato_ut,'mm')                                                                                  as mnd_ut,
           to_char(dato_ut,'iw')                                                                                  as uke_ut,
           decode(vare_gruppe.vare_gruppe_id,'VRAK','Vrak','Deler')                                               as vare_gruppe,
           --LOCATION_SEQ_NO  LOC_ID  LOC_BESK  EXPORT_YN
           --3220              V_UTE2_EKSPORT  Vrak for plukking ti  N
           --3300              V_EKSTERN  vrak for henting, har ikke vrak.nr før fullstendig registrering  N
           --0                HOLD (har serie_nr men er ikke i hyllen enda
           --null             solgt eller paa_bil 
           case when nvl(location_seq_no,-1) = -1   and nvl(paa_bil,'N')='J' then 'paa lager pr '        ||to_char(sysdate,'yyyy-mm-iw') 
                when nvl(location_seq_no,-1) = -1   and nvl(paa_bil,'N')='N' then 'solgt/presset' 
                when nvl(location_seq_no,-1) = 3220                          then 'klar for eksport pr ' ||to_char(sysdate,'yyyy-mm-iw')
                when nvl(location_seq_no,-1) = 3300                          then 'hentebiler pr '       ||to_char(sysdate,'yyyy-mm-iw')
                when nvl(location_seq_no,-1) not in (-1,3220,3300)           then 'paa lager pr '        ||to_char(sysdate,'yyyy-mm-iw') 
           else 'hmm...'                
          end                                                                                                     as status,                                                                                                             
           vare_gruppe.vare_gruppe_id                                                                             as vare_gruppe_id,       
           nvl(count(*),0)                                                                                        as antall,
           nvl(count(*)*nvl(vekt_vrak.vekt,vekt_del.vekt),0)                                                      as vekt                                               
    from vare_gruppe,
         enhet,
         (select 1  as vare_gruppe_seq_no, 1000 vekt from dual) vekt_vrak,
         (select -1 as vare_gruppe_seq_no, 5    vekt from dual) vekt_del
    where enhet.vare_gruppe_seq_no                = vare_gruppe.vare_gruppe_seq_no 
    and   enhet.vare_gruppe_seq_no                = vekt_vrak.vare_gruppe_seq_no(+)         
    and   decode(enhet.vare_gruppe_seq_no,1,1,-1) =  vekt_del.vare_gruppe_seq_no(+)         
    group by to_char(dato_ut,'yyyy'), to_char(dato_ut,'mm'),to_char(dato_ut,'iw'),
             vare_gruppe.vare_gruppe_id,
             nvl(location_seq_no,-1),nvl(paa_bil,'N'),
             vekt_vrak.vekt,vekt_del.vekt
    order by nvl(to_char(dato_ut,'yyyy'),'1'), nvl(to_char(dato_ut,'mm'),'1'),nvl(to_char(dato_ut,'iw'),'1'),status,vare_gruppe_id;                                
    grant select on v_enhet_salg_y_m_w_v_grp to public
    /
    
    ----------------------------------------------------------- v_enhet_salg_y_v_grp ------------------------------------------------------------------------------------------
    create or replace view v_enhet_salg_y_v_grp as
    select 
      aar_ut           as ut_stamp,
      vare_gruppe,
      vare_gruppe_id,
      status,
      sum(antall)      as antall,
      sum(vekt)        as vekt
    from v_enhet_salg_y_m_w_v_grp
    group by aar_ut         , vare_gruppe,vare_gruppe_id,status
    order by nvl(aar_ut,'1'), vare_gruppe,status,vare_gruppe_id;                                
    grant select on v_enhet_salg_y_v_grp to public
    /
    ----------------------------------------------------------- v_enhet_salg_y_m_v_grp ------------------------------------------------------------------------------------------
    create or replace view v_enhet_salg_y_m_v_grp as
    select 
      aar_ut||decode(aar_ut,null,null,'-')||mnd_ut           as ut_stamp,
      vare_gruppe,
      vare_gruppe_id,
      status,
      sum(antall)      as antall,
      sum(vekt)        as vekt
    from v_enhet_salg_y_m_w_v_grp
    group by aar_ut||decode(aar_ut,null,null,'-')||mnd_ut         , vare_gruppe,vare_gruppe_id,status
    order by nvl(aar_ut||decode(aar_ut,null,null,'-')||mnd_ut,'1'), vare_gruppe,status,vare_gruppe_id;                                
    grant select on v_enhet_salg_y_m_v_grp to public
    /
    ----------------------------------------------------------- v_enhet_salg_y ------------------------------------------------------------------------------------------
    create or replace view v_enhet_salg_y as
    --sjekk konsistens sjekk av enhet i ..\TAB_TRG_SEQ_SYN_SCRIP\enhet_xxx.sql
    select 
      aar_ut           as ut_stamp,
      vare_gruppe,
      null             as vare_gruppe_id,
      status,
      sum(antall)      as antall,
      sum(vekt)        as vekt
    from v_enhet_salg_y_m_w_v_grp
    group by aar_ut         , vare_gruppe,status
    order by vare_gruppe,nvl(aar_ut,'1'), status;                                
    grant select on v_enhet_salg_y to public
    /
    
    
    
    --incremental år
    SELECT EXTRACT(YEAR FROM SYSDATE)+1-LEVEL AS YEARS
    FROM DUAL
    CONNECT BY LEVEL <= 4
    ORDER BY YEARS;
    
    SELECT level,          
                 extract(year from add_months(sysdate,-level)) as aar,
                 extract(month from add_months(sysdate,-level)) as maaned
    FROM DUAL
    CONNECT BY LEVEL <= 16
    ORDER BY YEARS;
    
    
    
    
    
    select
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
      from    ola.v_enhet_pris_full     t1
      where    t1.dato_inn             <  to_date('01_01_2012','dd_mm_yyyy')
            and     t1.dato_inn             >=  to_date('01_01_2010','dd_mm_yyyy')
      and    nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))   >  to_date('01_01_2012','dd_mm_yyyy')
    ) as "2010-2011"
    from dual  
    
    (select TO_CHAR(sum(calc_pris_netto),'9g999g999')
      from    ola.v_enhet_pris_full     t1
      where    t1.dato_inn             <  to_date('01_01_2012','dd_mm_yyyy')
            and     t1.dato_inn             >=  to_date('01_01_2010','dd_mm_yyyy')
      and    nvl(t1.dato_ut,to_date('31_12_9999','dd_mm_yyyy'))   >  to_date('01_01_2012','dd_mm_yyyy')
    ) as "2010-2011"
    from dual  
    
    
    
    
    
    sjekk før/etter
      select enhet_seq_no from v_enhet_master where var_bil like '%SAA%' and vare_gruppe_seq_no=1;
      #191
      #914
    select sysdate , to_date('2003-04-27','yyyy-mm-dd') ,
    sysdate-to_date('2003-04-30','yyyy-mm-dd')
    from dual;
    
    analyze table AAR_MODEL   estimate statistics;
    analyze table ENHET    estimate statistics;
    analyze table ENHET_KVALITET  estimate statistics;
    analyze table FABRIKANT    estimate statistics;
    analyze table LOCATION    estimate statistics;  
    analyze table SERIE    estimate statistics;
    analyze table SERIE_ANVENDELSE  estimate statistics;
    analyze table TYPE    estimate statistics;
    analyze table VARE_GRUPPE  estimate statistics;
    analyze table VAR_BIL    estimate statistics;
    analyze table VAR_DORER    estimate statistics;
    analyze table VAR_KJORE_GRP  estimate statistics;
    analyze table VAR_MOTOR_TYPE  estimate statistics;
    analyze table VAR_MOTOR_VOLUM  estimate statistics;
    
    
    
    
    
    --INDEX (enhet SYS_C003030)
    sort_area_size = 10485760
    --drop index enhet_i1;
    --drop index enhet_i2;
    --drop index enhet_i3;
    --drop index enhet_i4;
    create index enhet_i1 on enhet(vare_gruppe_seq_no);
    create index enhet_i2 on enhet(location_seq_no);
    --create index enhet_i3 on enhet(serie_seq_no);
    create index enhet_i4 on enhet(var_bil_seq_no);
    
    select * from v_enhet_master
    where vare_gruppe_id like 'DØR%'
    order by vare_gruppe_id,  fab_navn,  type_id, aar;
    
    create index vare_gruppe_i1 on vare_gruppe(vare_gruppe_id);
    create index 
    
    
    set autotrace trace exp
    
    truncate table plan_table;        
    commit;                           
    explain plan                      
    set statement_id='v_enhet_master'            
    into plan_table                   
    for                               
    select * from v_enhet_master
    where vare_gruppe_id like 'VRAK' ;                 
    commit;                           
    
    
    
    
    truncate table plan_table;        
    commit;                           
    explain plan                      
    set statement_id='v_enhet_master'            
    into plan_table                   
    for                               
    select /*+ ordered   */
    /*      Brukes av PB i datavindu: dw_master hvor aktuelle datavindu settes i menylinjen
                     datavinduobjekt: d_bil_m_enhet
                                v_fx: mapping OBV LBK
            Merk at vi hardkoder inn at loc_id is not null
    Dato    Endring
    ===       =======        
    01-04-2002  Legger inn kolonner fra v_m_enhet
    21-10-2002  Legge decodet flagg for loc_id, samt tar vekk harkoding av loc_is is null
    25-10-2002  Ferdig med tuningen first_rows ut pga order går da fortere
    */                 
      enhet.enhet_seq_no                as enhet_seq_no,
      vare_gruppe.vare_gruppe_seq_no              as vare_gruppe_seq_no,
      vare_gruppe.vare_gruppe_id              as vare_gruppe_id,
    --Nivå 1a
      location.loc_id                  as loc_id, 
      decode(location.loc_id,null,'0',1)            as loc_id_01,
      decode(serie.serie_no,null,null,
      decode(vare_gruppe.vare_gruppe_id,'VRAK',  'V'||serie.serie_no,
                  'D'||serie.serie_no)  )  as serie_no,  
      enhet.enhet_kval_seq_no                as kval_id,
      enhet.enhet_besk                as enhet_besk,
    --Nivå 2
      nvl(enhet.var_bil_seq_no,enhet_2.var_bil_seq_no)      as var_bil_seq_no,
      nvl(fabrikant.fab_navn,fabrikant_2.fab_navn)        as fab_navn,
      nvl(type.type_id,type_2.type_id)          as type_id,
      nvl(aar_model.aar,aar_model_2.aar)          as aar,
      nvl(enhet.betegnelse,enhet_2.betegnelse)        as betegnelse 
    from   vare_gruppe     vare_gruppe, 
      enhet      enhet,
    --Niva 1a
      location    location,      
      serie      serie,
    --Nivå 1b
      var_bil        var_bil,  
      fabrikant      fabrikant,
      type        type,
      aar_model      aar_model,
    --Nivå 2
      enhet        enhet_2,
      var_bil        var_bil_2,
      fabrikant      fabrikant_2,
      type        type_2,
      aar_model      aar_model_2
    --Nivå 1a  hente kun direkte fra enhet
    where  enhet.vare_gruppe_seq_no  = vare_gruppe.vare_gruppe_seq_no   
    and  enhet.location_seq_no      = location.location_seq_no   (+)  
    and  enhet.serie_seq_no    = serie.serie_seq_no     (+)
    --Nivå 1b
    and  enhet.var_bil_seq_no    = var_bil.var_bil_seq_no   (+) 
    and  var_bil.fab_seq_no    = fabrikant.fab_seq_no     (+)  
    and  var_bil.type_seq_no    = type.type_seq_no     (+)  
    and  var_bil.aar_seq_no    = aar_model.aar_seq_no     (+)          
    --Nivå 2 koble
    and  enhet.prev_enhet_seq_no    = enhet_2.enhet_seq_no     (+) 
    --Nivå 2 hente
    and  enhet_2.var_bil_seq_no    = var_bil_2.var_bil_seq_no   (+) 
    and  var_bil_2.fab_seq_no    = fabrikant_2.fab_seq_no   (+)  
    and  var_bil_2.type_seq_no    = type_2.type_seq_no     (+)  
    and  var_bil_2.aar_seq_no    = aar_model_2.aar_seq_no  (+)          
    
    and  vare_gruppe.vare_gruppe_id  like   'DØR%'
    order by vare_gruppe.vare_gruppe_id
    
    location_seq_no,serie_seq_no,var_bil_seq_no
    
    
    create or replace view v_enhet_sub_vis as
    select 
    /*      Brukes av PB i datavindu: d_bil_d_tabpage_3 , Dele-historikk tabpage
                     datavinduobjekt: d_bil_d_tabpage_3
    Dato     Endring
    ===        =======    
    2006_06_20 Laget
    */
    enhet_sub.enhet_sub_seq_no          as enhet_sub_seq_no  ,
    enhet.enhet_seq_no             as enhet_seq_no    ,
    enhet.prev_enhet_seq_no            as prev_enhet_seq_no    ,
    --Har ikke vi overordnet enhet (dvs vi er på et vrak) bruker vi prev_enhet
    nvl(enhet.prev_enhet_seq_no,enhet.enhet_seq_no)      as hot_enhet_seq_no  ,
    enhet_sub.abs_yn     as abs_yn    ,      
    enhet_sub.sentral_laas_yn   as sentral_laas_yn  ,
    enhet_sub.skinn_yn     as skinn_yn    ,
    enhet_sub.tilhengerfeste_yn   as tilhengerfeste_yn  ,
    enhet_sub.metallic_yn     as metallic_yn          ,
    enhet_sub.cruise_cont_yn   as cruise_cont_yn  ,
    enhet_sub.kjore_comp_yn   as kjore_comp_yn  ,
    enhet_sub.setevarmere_yn   as setevarmere_yn  ,
    enhet_sub.xenon_yn              as xenon_yn             ,
    enhet_sub.org_audio_yn          as org_audio_yn         ,
    enhet_sub.brukt_imp_yn          as brukt_imp_yn         ,
    enhet_sub.el_speil_yn           as el_speil_yn          ,
    enhet_sub.el_heis_yn            as el_heis_yn           ,
    enhet_sub.el_speil_ant          as el_speil_ant         ,
    enhet_sub.aircon           as aircon          ,
    enhet_sub.soltak           as soltak          ,
    enhet_sub.lys       as lys            ,
    enhet_sub.farge_int     as farge_int    ,
    enhet_sub.motor_kode     as motor_kode    ,
    enhet_sub.motor_test            as motor_test           ,
    enhet_sub.gear_kode     as gear_kode    ,
    enhet_sub.gear_test             as gear_test    ,
    enhet_sub.hk       as hk      ,
    enhet_sub.in_date               as in_date     
    from     
      enhet_sub        enhet_sub,
      enhet          enhet
    where
         nvl(enhet.prev_enhet_seq_no,enhet.enhet_seq_no)  = enhet_sub.enhet_seq_no  
    /
    
    select 
    enhet_sub.enhet_sub_seq_no          as enhet_sub_seq_no  ,
    enhet.enhet_seq_no             as enhet_seq_no    ,
    enhet.prev_enhet_seq_no            as prev_enhet_seq_no    ,
    --Har ikke vi overordnet enhet (dvs vi er på et vrak) bruker vi prev_enhet
    nvl(enhet.prev_enhet_seq_no,enhet.enhet_seq_no)      as hot_enhet_seq_no
    from     
      enhet_sub        enhet_sub,
      enhet          enhet
    where
         nvl(enhet.prev_enhet_seq_no,enhet.enhet_seq_no)  = enhet_sub.enhet_seq_no  
    
    and  enhet.enhet_seq_no in (51747,51749,51761)
    
    ENHET_SEQ_NO  VARE_GRUPPE_ID  LOC_ID  SERIE_NO  PREV_SERIE_NO  FAB_NAVN  TYPE_ID
    51747  VRAK  HOLD  V6703    SAAB  99
    51749  ABS SENSOR, HF  HOLD  D19998  V6703  SAAB  99
    51761  ABS ENHET  HOLD  D19996  V6703  SAAB  99
    
----------------------------------------------------------- v_enhet_vis_takst ------------------------------------------------------------------------------------------
    create or replace view v_enhet_vis_takst as
    select 
    /*      Brukes av APEX 3005 visning av deler ihht nbf bilkod
    Dato     Endring
    ===        =======    
    2011_02_20 Laget
    2011_02_24 fikset opp i joining til v_enhet_bil bruker delkod ikke var_bil_seq_no
    
    */                 
      takst.takst_seq_no      as takst_seq_no,
      v_enhet_vis.enhet_seq_no    as enhet_seq_no,   
      var_bil.sbrnr        as bilkod,
      v_enhet_vis.prev_enhet_seq_no           as prev_enhet_seq_no,  
               nvl(to_char(v_enhet_vis.takst_seq_no),' ')            as status,        
      case when nvl(to_char(v_enhet_vis.takst_seq_no),' ') <> ' ' then 'yellow'
                --when sal between 1000 and 2000 then 'purple'
          --when sal > 2000 then 'green'
           end                   as status_color, 
           --setter av 3 pos til INS, DEL,UPD
           '   '          as plukk,
      v_enhet_vis.vare_gruppe_id              as vare_gruppe_id,     
      v_enhet_vis.loc_id                      as loc_id,             
      v_enhet_vis.serie_no                    as serie_no,           
      v_enhet_vis.old_serie_no                as old_serie_no,       
      nvl(to_char(v_enhet_vis.kval_id),' ')       as kval_id,            
      nvl(to_char(v_enhet_vis.enhet_besk),' ')    as enhet_besk,         
      nvl(to_char(v_enhet_vis.hold_on),' ')      as hold_on,         
      nvl(to_char(v_enhet_vis.pris_inkl_mva),' ')    as pris_inkl_mva,         
      nvl(to_char(v_enhet_vis.pris_solgt_inkl_mva),' ')  as pris_solgt_inkl_mva,         
      v_enhet_vis.prev_serie_no               as prev_serie_no,      
      v_enhet_vis.var_bil_seq_no              as var_bil_seq_no,     
      v_enhet_vis.fab_navn                    as fab_navn,           
      v_enhet_vis.type_id                     as type_id,            
      v_enhet_vis.aar                         as aar,                
      v_enhet_vis.betegnelse                  as betegnelse,         
      v_enhet_vis.motor_type_id               as motor_type_id,      
      v_enhet_vis.motor_vol_id                as motor_vol_id,       
      v_enhet_vis.gear_type                   as gear_type,          
      v_enhet_vis.dorer_id                    as dorer_id,           
      v_enhet_vis.k_grp_id                    as k_grp_id,           
      v_enhet_vis.km                          as km,                 
      v_enhet_vis.reg_no                      as reg_no,             
      v_enhet_vis.tecdoc_id                   as tecdoc_id,          
      v_enhet_vis.tecdoc_besk                 as tecdoc_besk,        
      v_enhet_vis.chassis_no                  as chassis_no,         
      v_enhet_vis.farge_kode                  as farge_kode,         
      v_enhet_vis.miljo_klarert_id            as miljo_klarert_id,   
      v_enhet_vis.db_katalog                  as db_katalog,         
      nvl(to_char(v_enhet_vis.paa_bil),' ')      as paa_bil,         
      v_enhet_vis.servo                       as servo,              
      nvl(to_char(v_enhet_vis.temp),' ')      as temp,         
      v_enhet_vis.dato_inn                    as dato_inn,           
      v_enhet_vis.dato_ut                     as dato_ut,            
      v_enhet_vis.omlops_hastighet            as omlops_hastighet,   
      v_enhet_vis.merke_nr                    as merke_nr,           
      v_enhet_vis.prod_nr                     as prod_nr,            
      v_enhet_vis.id                          as id,                 
      v_enhet_vis.old_serie_seq_no            as old_serie_seq_no   
    from   ola.takst  takst,
      ola.var_bil    var_bil,
      ola.v_enhet_vis v_enhet_vis
    where   takst.var_bil_seq_no  = var_bil.var_bil_seq_no   
    and     var_bil.sbrnr      = v_enhet_vis.bilkod
    --på lager
    and  v_enhet_vis.loc_id    is not null  
    -- ikke brukt i takst allerede
    -- legger heller dem ut med farge
    --and   v_enhet_vis.takst_seq_no is null
    --Saab 900 1995
    --and  var_bil.sbrnr = 4034  
    order by v_enhet_vis.vare_gruppe_id
    /
    grant all on v_enhet_vis_takst to public;
    
    select count(*) from v_enhet_vis_takst;
    --har vi vrak
    select count(*) from v_enhet_vis where vare_gruppe_id = 'VRAK' and loc_id    is not null  
    -*-409 2011_02_20
----------------------------------------------------------- v_enhet_vis_takst_rapp ------------------------------------------------------------------------------------------
    create or replace view v_enhet_vis_takst_rapp as
    select 
    /*      Brukes av APEX 3005 visning av deler ihht nbf bilkod
            NB joiner ikke vra var_bil  i tilfelle noen bytter biltypen ETTER man ha startet plukking av deler
    Dato     Endring
    ===        =======    
    2011_02_20 Laget
    */                 
      v_enhet_vis.takst_seq_no    as takst_seq_no,
      v_enhet_vis.enhet_seq_no    as enhet_seq_no,   
      ''          as bilkod,
      v_enhet_vis.prev_enhet_seq_no           as prev_enhet_seq_no,  
               nvl(to_char(v_enhet_vis.takst_seq_no),' ')            as status,        
      case when nvl(to_char(v_enhet_vis.takst_seq_no),' ') <> ' ' then 'yellow'
                --when sal between 1000 and 2000 then 'purple'
          --when sal > 2000 then 'green'
           end                   as status_color, 
           --setter av 3 pos til INS, DEL,UPD
           '   '          as plukk,
      v_enhet_vis.vare_gruppe_id              as vare_gruppe_id,     
      v_enhet_vis.loc_id                      as loc_id,             
      v_enhet_vis.serie_no                    as serie_no,           
      v_enhet_vis.old_serie_no                as old_serie_no,       
      nvl(to_char(v_enhet_vis.kval_id),' ')       as kval_id,            
      nvl(to_char(v_enhet_vis.enhet_besk),' ')    as enhet_besk,         
      nvl(to_char(v_enhet_vis.hold_on),' ')      as hold_on,         
      nvl(to_char(v_enhet_vis.pris_inkl_mva),' ')    as pris_inkl_mva,         
      nvl(to_char(v_enhet_vis.pris_solgt_inkl_mva),' ')  as pris_solgt_inkl_mva,         
      v_enhet_vis.prev_serie_no               as prev_serie_no,      
      v_enhet_vis.var_bil_seq_no              as var_bil_seq_no,     
      v_enhet_vis.fab_navn                    as fab_navn,           
      v_enhet_vis.type_id                     as type_id,            
      v_enhet_vis.aar                         as aar,                
      v_enhet_vis.betegnelse                  as betegnelse,         
      v_enhet_vis.motor_type_id               as motor_type_id,      
      v_enhet_vis.motor_vol_id                as motor_vol_id,       
      v_enhet_vis.gear_type                   as gear_type,          
      v_enhet_vis.dorer_id                    as dorer_id,           
      v_enhet_vis.k_grp_id                    as k_grp_id,           
      v_enhet_vis.km                          as km,                 
      v_enhet_vis.reg_no                      as reg_no,             
      v_enhet_vis.tecdoc_id                   as tecdoc_id,          
      v_enhet_vis.tecdoc_besk                 as tecdoc_besk,        
      v_enhet_vis.chassis_no                  as chassis_no,         
      v_enhet_vis.farge_kode                  as farge_kode,         
      v_enhet_vis.miljo_klarert_id            as miljo_klarert_id,   
      v_enhet_vis.db_katalog                  as db_katalog,         
      nvl(to_char(v_enhet_vis.paa_bil),' ')      as paa_bil,         
      v_enhet_vis.servo                       as servo,              
      nvl(to_char(v_enhet_vis.temp),' ')      as temp,         
      v_enhet_vis.dato_inn                    as dato_inn,           
      v_enhet_vis.dato_ut                     as dato_ut,            
      v_enhet_vis.omlops_hastighet            as omlops_hastighet,   
      v_enhet_vis.merke_nr                    as merke_nr,           
      v_enhet_vis.prod_nr                     as prod_nr,            
      v_enhet_vis.id                          as id,                 
      v_enhet_vis.old_serie_seq_no            as old_serie_seq_no   
    from   ola.takst  takst,
      ola.v_enhet_vis v_enhet_vis
    where   takst.takst_seq_no  = v_enhet_vis.takst_seq_no
    order by v_enhet_vis.vare_gruppe_id
    /
    grant all on v_enhet_vis_takst_rapp to public;
    
    select count(*) from v_enhet_vis_takst;
----------------------------------------------------------- v_enhet_vis ------------------------------------------------------------------------------------------
    create or replace view v_enhet_vis as
    select 
    /*      Brukes av PB i datavindu: d_bil_enhet_vis , Dele-historikk tabpage
                     datavinduobjekt: d_bil_enhet_vis
            Merk at INGEN hardkoding av loc_id is not null --> mer generelt
    Dato  Endring
    ===     =======    
    27-04-2003  Lagt inn temp felt
    29-02-2004  Lagt inn dato inn-ut    
    28-04-2004  Lagt inn db_katalog og paa_bil og dekoding av serienr
    01-11-2005  Lagt inn merke og prod nr 
    02-11-2005  Lagt inn old_serie_seq_no
    23-12-2005  Lagt inn tecdoc_id
    29-12-2005  Lagt inn tecdoc_besk
    15-01-2006  Lagt inn vendor_data_no
    08-03-2006  Lagt inn omlops_hastighet
    22_06_2007  hold_on lagt inn
    29_03_2010  lagt inn pris_inkl_mva
    09_08_2010  lagt in prev_enhet_seq_no
    19_02_2011  lagt inn takst_seq_no
    24_02_2011  legger in bilkod slik at v_enhet_vis_takst finner alle delene (denne ligger klar i var_bil.sbrnr )
    21_05_2011  lagt inn org_pris_inkl_mva
    2011_07_05 lagt til salg_via, salg_funnet
    2011_11_27 lagt ut vare_gruppe_seq_no
    2013_04_06 legger ut type_klasse
    */                 
      enhet.enhet_seq_no                as enhet_seq_no,
      enhet.prev_enhet_seq_no                as prev_enhet_seq_no,
      vare_gruppe.vare_gruppe_seq_no              as vare_gruppe_seq_no,
      vare_gruppe.vare_gruppe_id              as vare_gruppe_id,
      location.loc_id                  as loc_id, 
      --Hvis 1)tomt serienr 1)paa_bil null --> null
      --            2)ellers       --> På bil
      --     2) D eller V      
      --Trigger må påse at: i)   paa_bil er tomt dersom serienr fylles ut
            --                    ii)  overordnet del kun VRAK
            --          iii) kun deler får ID en
            --          iv)  loc er tom                                   
      decode(serie.serie_no,null,decode(enhet.paa_bil,'J','På bil',null)
                                      ,decode(vare_gruppe.vare_gruppe_id,'VRAK','V'||serie.serie_no,
                                      'D'||serie.serie_no)
                                               )as serie_no,  
      decode(serie_old.serie_no,null,decode(enhet.paa_bil,'J','På bil',null)
                                      ,decode(vare_gruppe.vare_gruppe_id,'VRAK','V'||serie_old.serie_no,
                                      'D'||serie_old.serie_no)
                                               )as old_serie_no,  
      enhet.enhet_kval_seq_no                as kval_id,
      enhet.enhet_besk                as enhet_besk,
      enhet.hold_on                  as hold_on,
      enhet.org_pris_inkl_mva                as org_pris_inkl_mva,
      enhet.pris_inkl_mva                as pris_inkl_mva,
      enhet.pris_solgt_inkl_mva              as pris_solgt_inkl_mva,
      --som oftes vrak
      decode(nvl(serie_2.serie_no,serie_2.serie_no),null,null,
      'V'||nvl(serie_2.serie_no,serie_2.serie_no)      )    as prev_serie_no,
      nvl(var_bil.sbrnr,nvl(var_bil_2.sbrnr,var_bil_3.sbrnr))        as bilkod,  
      nvl(enhet.var_bil_seq_no,nvl(enhet_2.var_bil_seq_no,enhet_3.var_bil_seq_no))  as var_bil_seq_no,
      nvl(fabrikant.fab_navn,nvl(fabrikant_2.fab_navn,fabrikant_3.fab_navn))    as fab_navn,
      nvl(type.type_id,nvl(type_2.type_id,type_3.type_id))                    as type_id,
      nvl(type.type_klasse,nvl(type_2.type_klasse,type_3.type_klasse))        as type_klasse,
      nvl(aar_model.aar,nvl(aar_model_2.aar,aar_model_3.aar))        as aar,
      nvl(enhet.betegnelse,nvl(enhet_2.betegnelse,enhet_3.betegnelse))    as betegnelse,
      nvl(m_t.motor_type_id,nvl(m_t_2.motor_type_id,m_t_3.motor_type_id))    as motor_type_id,  
      nvl(m_v.motor_vol_id,nvl(m_v_2.motor_vol_id,m_v_3.motor_vol_id))    as motor_vol_id,
      nvl(enhet.gear_type,nvl(enhet_2.gear_type,enhet_3.gear_type))      as gear_type,
      nvl(d.dorer_id,nvl(d_2.dorer_id,d_3.dorer_id))          as dorer_id,
      nvl(k.k_grp_id,nvl(k_2.k_grp_id,k_3.k_grp_id))          as k_grp_id,
      nvl(enhet.km,nvl(enhet_2.km,enhet_3.km))          as km,
      nvl(enhet.reg_no,nvl(enhet_2.reg_no,enhet_3.reg_no))        as reg_no,
      nvl(enhet.tecdoc_id,nvl(enhet_2.tecdoc_id,enhet_3.tecdoc_id))      as tecdoc_id,
      nvl(enhet.tecdoc_besk,nvl(enhet_2.tecdoc_besk,enhet_3.tecdoc_besk))    as tecdoc_besk,
      nvl(enhet.chassis_no,nvl(enhet_2.chassis_no,enhet_3.chassis_no))    as chassis_no,
      nvl(enhet.farge_kode,nvl(enhet_2.farge_kode,enhet_3.farge_kode))    as farge_kode,  
      nvl(enhet.miljo_klarert_id,nvl(enhet_2.miljo_klarert_id,enhet_3.miljo_klarert_id)) as miljo_klarert_id,
      nvl(enhet.db_katalog,nvl(enhet_2.db_katalog,enhet_3.db_katalog))     as db_katalog,
      nvl(enhet.paa_bil,nvl(enhet_2.paa_bil,enhet_3.paa_bil))       as paa_bil,
      nvl(enhet.servo,nvl(enhet_2.servo,enhet_3.servo))         as servo,
      enhet.temp                  as temp,
      enhet.dato_inn                  as dato_inn,
      enhet.dato_ut                  as dato_ut,
      --tom dato_ut erstattes med dato_inn-1 --> neg svar dersom vi ikke har fått den ut
      (to_date(to_char(nvl(enhet.dato_ut,enhet.dato_inn-1),'dd.mm.yyyy'),'dd.mm.yyyy') - 
       to_date(to_char(enhet.dato_inn,   'dd.mm.yyyy'),'dd.mm.yyyy') )     as omlops_hastighet,
      enhet.merke_nr                   as merke_nr,
      enhet.prod_nr                  as prod_nr,
      pb_dddw_vendor_data.id                as id,
      enhet.old_serie_seq_no                as old_serie_seq_no,
      enhet.takst_seq_no                as takst_seq_no,
      enhet.salg_via                  as salg_via,
      enhet.salg_funnet                as salg_funnet
    from   enhet      enhet ,
      vare_gruppe     vare_gruppe, 
      location    location,
      pb_dddw_vendor_data  pb_dddw_vendor_data,      
    --Nivå 1
      serie      serie,
      serie      serie_old,
      var_bil        var_bil,  
      fabrikant      fabrikant,
      type        type,
      aar_model      aar_model,
      var_motor_type      m_t,
      var_motor_volum      m_v,
      var_dorer      d,
      var_kjore_grp      k,      
    --Nivå 2
      enhet        enhet_2,
      serie        serie_2,  
      var_bil        var_bil_2,
      fabrikant      fabrikant_2,
      type        type_2,
      aar_model      aar_model_2,
      var_motor_type      m_t_2,
      var_motor_volum      m_v_2,  
      var_dorer      d_2,
      var_kjore_grp      k_2,      
    --Nivå 3  
      enhet        enhet_3 ,
      serie        serie_3,
      var_bil        var_bil_3, 
      fabrikant      fabrikant_3,
      type        type_3,
      aar_model      aar_model_3,
      var_motor_type      m_t_3,
      var_motor_volum      m_v_3,
      var_dorer      d_3,
      var_kjore_grp      k_3          
    --Nivå 1 hente kun nivå 1
    where  enhet.vare_gruppe_seq_no  = vare_gruppe.vare_gruppe_seq_no   
    and  enhet.vendor_data_seq_no  = pb_dddw_vendor_data.vendor_data_seq_no (+)
    and  enhet.location_seq_no      = location.location_seq_no   (+)  
    --Nivå 1 hente
    and  enhet.serie_seq_no    = serie.serie_seq_no     (+)
    and  enhet.old_serie_seq_no    = serie_old.serie_seq_no   (+)
    and  enhet.var_bil_seq_no    = var_bil.var_bil_seq_no   (+) 
    and  var_bil.fab_seq_no    = fabrikant.fab_seq_no     (+)  
    and  var_bil.type_seq_no    = type.type_seq_no     (+)  
    and  var_bil.aar_seq_no    = aar_model.aar_seq_no     (+)          
    and  enhet.var_motor_type_seq_no  = m_t.var_motor_type_seq_no  (+)
    and  enhet.var_motor_volum_seq_no  = m_v.var_motor_volum_seq_no  (+)
    and  enhet.var_dorer_seq_no    = d.var_dorer_seq_no    (+)
    and  enhet.var_kjore_grp_seq_no  = k.var_kjore_grp_seq_no  (+)
    --Nivå 2 koble
    and  enhet.prev_enhet_seq_no    = enhet_2.enhet_seq_no     (+) 
    --Nivå 2 hente
    and  enhet_2.serie_seq_no    = serie_2.serie_seq_no     (+)
    and  enhet_2.var_bil_seq_no    = var_bil_2.var_bil_seq_no   (+) 
    and  var_bil_2.fab_seq_no    = fabrikant_2.fab_seq_no   (+)  
    and  var_bil_2.type_seq_no    = type_2.type_seq_no     (+)  
    and  var_bil_2.aar_seq_no    = aar_model_2.aar_seq_no  (+)          
    and  enhet_2.var_motor_type_seq_no  = m_t_2.var_motor_type_seq_no  (+)
    and  enhet_2.var_motor_volum_seq_no  = m_v_2.var_motor_volum_seq_no  (+)
    and  enhet_2.var_dorer_seq_no  = d_2.var_dorer_seq_no    (+)
    and  enhet_2.var_kjore_grp_seq_no  = k_2.var_kjore_grp_seq_no  (+)
    --Nivå 3 koble
    and  enhet_2.prev_enhet_seq_no  = enhet_3.enhet_seq_no     (+) 
    --Nivå 3 hente
    and  enhet_3.serie_seq_no    = serie_3.serie_seq_no     (+)
    and  enhet_3.var_bil_seq_no    = var_bil_3.var_bil_seq_no   (+) 
    and  var_bil_3.fab_seq_no    = fabrikant_3.fab_seq_no   (+)  
    and  var_bil_3.type_seq_no    = type_3.type_seq_no     (+)  
    and  var_bil_3.aar_seq_no    = aar_model_3.aar_seq_no   (+)          
    and  enhet_3.var_motor_type_seq_no  = m_t_3.var_motor_type_seq_no  (+)
    and  enhet_3.var_motor_volum_seq_no  = m_v_3.var_motor_volum_seq_no  (+)
    and  enhet_3.var_dorer_seq_no  = d_3.var_dorer_seq_no    (+)
    and  enhet_3.var_kjore_grp_seq_no  = k_3.var_kjore_grp_seq_no  (+)
    -- NB ingen selektering på lokasjon her --> mer generelt
    /
    grant select on v_enhet_vis to public
    /
    
    --select count(*) from v_enhet_vis;
    --74725 før var_bil.sbrnr også etter ---> alt ok ref 1:1  mellom var_bil og nbf.sbr_nr
    
    
    
    
    